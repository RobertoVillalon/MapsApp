var zN=Object.create;var Dw=Object.defineProperty,BN=Object.defineProperties,VN=Object.getOwnPropertyDescriptor,jN=Object.getOwnPropertyDescriptors,UN=Object.getOwnPropertyNames,Nv=Object.getOwnPropertySymbols,HN=Object.getPrototypeOf,Cw=Object.prototype.hasOwnProperty,aA=Object.prototype.propertyIsEnumerable;var sA=(a,c,d)=>c in a?Dw(a,c,{enumerable:!0,configurable:!0,writable:!0,value:d}):a[c]=d,Wt=(a,c)=>{for(var d in c||={})Cw.call(c,d)&&sA(a,d,c[d]);if(Nv)for(var d of Nv(c))aA.call(c,d)&&sA(a,d,c[d]);return a},Oi=(a,c)=>BN(a,jN(c));var Mw=(a,c)=>{var d={};for(var g in a)Cw.call(a,g)&&c.indexOf(g)<0&&(d[g]=a[g]);if(a!=null&&Nv)for(var g of Nv(a))c.indexOf(g)<0&&aA.call(a,g)&&(d[g]=a[g]);return d};var $N=(a,c)=>()=>(c||a((c={exports:{}}).exports,c),c.exports);var GN=(a,c,d,g)=>{if(c&&typeof c=="object"||typeof c=="function")for(let w of UN(c))!Cw.call(a,w)&&w!==d&&Dw(a,w,{get:()=>c[w],enumerable:!(g=VN(c,w))||g.enumerable});return a};var Aw=(a,c,d)=>(d=a!=null?zN(HN(a)):{},GN(c||!a||!a.__esModule?Dw(d,"default",{value:a,enumerable:!0}):d,a));var Va=(a,c,d)=>new Promise((g,w)=>{var i=H=>{try{N(d.next(H))}catch(ce){w(ce)}},A=H=>{try{N(d.throw(H))}catch(ce){w(ce)}},N=H=>H.done?g(H.value):Promise.resolve(H.value).then(i,A);N((d=d.apply(a,c)).next())});var yb=$N((cS,uS)=>{"use strict";(function(a,c){typeof cS=="object"&&typeof uS<"u"?uS.exports=c():typeof define=="function"&&define.amd?define(c):(a=typeof globalThis<"u"?globalThis:a||self,a.mapboxgl=c())})(cS,function(){"use strict";var a,c,d;function g(i,A){if(!a)a=A;else if(!c)c=A;else{var N="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+a+")(sharedChunk); ("+c+")(sharedChunk); self.onerror = null;",H={};a(H),d=A(H),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(d.workerUrl=window.URL.createObjectURL(new Blob([N],{type:"text/javascript"})))}}g(["exports"],function(i){var A=1e-6,N=typeof Float32Array<"u"?Float32Array:Array;function H(r,e){var n=e[0],s=e[1],l=e[2],f=e[3],p=n*f-l*s;return p?(r[0]=f*(p=1/p),r[1]=-s*p,r[2]=-l*p,r[3]=n*p,r):null}function ce(){var r=new N(9);return N!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}function be(r,e){var n=e[0],s=e[1],l=e[2],f=e[3],p=e[4],y=e[5],x=e[6],b=e[7],I=e[8];return r[0]=p*I-y*b,r[1]=l*b-s*I,r[2]=s*y-l*p,r[3]=y*x-f*I,r[4]=n*I-l*x,r[5]=l*f-n*y,r[6]=f*b-p*x,r[7]=s*x-n*b,r[8]=n*p-s*f,r}function Pe(r,e,n){var s=e[0],l=e[1],f=e[2],p=e[3],y=e[4],x=e[5],b=e[6],I=e[7],S=e[8],D=n[0],R=n[1],L=n[2],F=n[3],V=n[4],$=n[5],Y=n[6],K=n[7],z=n[8];return r[0]=D*s+R*p+L*b,r[1]=D*l+R*y+L*I,r[2]=D*f+R*x+L*S,r[3]=F*s+V*p+$*b,r[4]=F*l+V*y+$*I,r[5]=F*f+V*x+$*S,r[6]=Y*s+K*p+z*b,r[7]=Y*l+K*y+z*I,r[8]=Y*f+K*x+z*S,r}function st(){var r=new N(16);return N!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function Se(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function It(r,e){var n=e[0],s=e[1],l=e[2],f=e[3],p=e[4],y=e[5],x=e[6],b=e[7],I=e[8],S=e[9],D=e[10],R=e[11],L=e[12],F=e[13],V=e[14],$=e[15],Y=n*y-s*p,K=n*x-l*p,z=n*b-f*p,W=s*x-l*y,J=s*b-f*y,te=l*b-f*x,me=I*F-S*L,de=I*V-D*L,ge=I*$-R*L,xe=S*V-D*F,ke=S*$-R*F,Xe=D*$-R*V,He=Y*Xe-K*ke+z*xe+W*ge-J*de+te*me;return He?(r[0]=(y*Xe-x*ke+b*xe)*(He=1/He),r[1]=(l*ke-s*Xe-f*xe)*He,r[2]=(F*te-V*J+$*W)*He,r[3]=(D*J-S*te-R*W)*He,r[4]=(x*ge-p*Xe-b*de)*He,r[5]=(n*Xe-l*ge+f*de)*He,r[6]=(V*z-L*te-$*K)*He,r[7]=(I*te-D*z+R*K)*He,r[8]=(p*ke-y*ge+b*me)*He,r[9]=(s*ge-n*ke-f*me)*He,r[10]=(L*J-F*z+$*Y)*He,r[11]=(S*z-I*J-R*Y)*He,r[12]=(y*de-p*xe-x*me)*He,r[13]=(n*xe-s*de+l*me)*He,r[14]=(F*K-L*W-V*Y)*He,r[15]=(I*W-S*K+D*Y)*He,r):null}function Lt(r,e,n){var s=e[0],l=e[1],f=e[2],p=e[3],y=e[4],x=e[5],b=e[6],I=e[7],S=e[8],D=e[9],R=e[10],L=e[11],F=e[12],V=e[13],$=e[14],Y=e[15],K=n[0],z=n[1],W=n[2],J=n[3];return r[0]=K*s+z*y+W*S+J*F,r[1]=K*l+z*x+W*D+J*V,r[2]=K*f+z*b+W*R+J*$,r[3]=K*p+z*I+W*L+J*Y,r[4]=(K=n[4])*s+(z=n[5])*y+(W=n[6])*S+(J=n[7])*F,r[5]=K*l+z*x+W*D+J*V,r[6]=K*f+z*b+W*R+J*$,r[7]=K*p+z*I+W*L+J*Y,r[8]=(K=n[8])*s+(z=n[9])*y+(W=n[10])*S+(J=n[11])*F,r[9]=K*l+z*x+W*D+J*V,r[10]=K*f+z*b+W*R+J*$,r[11]=K*p+z*I+W*L+J*Y,r[12]=(K=n[12])*s+(z=n[13])*y+(W=n[14])*S+(J=n[15])*F,r[13]=K*l+z*x+W*D+J*V,r[14]=K*f+z*b+W*R+J*$,r[15]=K*p+z*I+W*L+J*Y,r}function hn(r,e,n){var s,l,f,p,y,x,b,I,S,D,R,L,F=n[0],V=n[1],$=n[2];return e===r?(r[12]=e[0]*F+e[4]*V+e[8]*$+e[12],r[13]=e[1]*F+e[5]*V+e[9]*$+e[13],r[14]=e[2]*F+e[6]*V+e[10]*$+e[14],r[15]=e[3]*F+e[7]*V+e[11]*$+e[15]):(l=e[1],f=e[2],p=e[3],y=e[4],x=e[5],b=e[6],I=e[7],S=e[8],D=e[9],R=e[10],L=e[11],r[0]=s=e[0],r[1]=l,r[2]=f,r[3]=p,r[4]=y,r[5]=x,r[6]=b,r[7]=I,r[8]=S,r[9]=D,r[10]=R,r[11]=L,r[12]=s*F+y*V+S*$+e[12],r[13]=l*F+x*V+D*$+e[13],r[14]=f*F+b*V+R*$+e[14],r[15]=p*F+I*V+L*$+e[15]),r}function sn(r,e,n){var s=n[0],l=n[1],f=n[2];return r[0]=e[0]*s,r[1]=e[1]*s,r[2]=e[2]*s,r[3]=e[3]*s,r[4]=e[4]*l,r[5]=e[5]*l,r[6]=e[6]*l,r[7]=e[7]*l,r[8]=e[8]*f,r[9]=e[9]*f,r[10]=e[10]*f,r[11]=e[11]*f,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r}function Yi(r,e,n){var s=Math.sin(n),l=Math.cos(n),f=e[4],p=e[5],y=e[6],x=e[7],b=e[8],I=e[9],S=e[10],D=e[11];return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[4]=f*l+b*s,r[5]=p*l+I*s,r[6]=y*l+S*s,r[7]=x*l+D*s,r[8]=b*l-f*s,r[9]=I*l-p*s,r[10]=S*l-y*s,r[11]=D*l-x*s,r}function fr(r,e,n){var s=Math.sin(n),l=Math.cos(n),f=e[0],p=e[1],y=e[2],x=e[3],b=e[8],I=e[9],S=e[10],D=e[11];return e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=f*l-b*s,r[1]=p*l-I*s,r[2]=y*l-S*s,r[3]=x*l-D*s,r[8]=f*s+b*l,r[9]=p*s+I*l,r[10]=y*s+S*l,r[11]=x*s+D*l,r}function _o(r,e,n){var s=Math.sin(n),l=Math.cos(n),f=e[0],p=e[1],y=e[2],x=e[3],b=e[4],I=e[5],S=e[6],D=e[7];return e!==r&&(r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=f*l+b*s,r[1]=p*l+I*s,r[2]=y*l+S*s,r[3]=x*l+D*s,r[4]=b*l-f*s,r[5]=I*l-p*s,r[6]=S*l-y*s,r[7]=D*l-x*s,r}function Cs(r,e){return r[0]=e[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=e[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=e[2],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function la(r,e,n){var s,l,f,p=n[0],y=n[1],x=n[2],b=Math.hypot(p,y,x);return b<A?null:(p*=b=1/b,y*=b,x*=b,s=Math.sin(e),l=Math.cos(e),r[0]=p*p*(f=1-l)+l,r[1]=y*p*f+x*s,r[2]=x*p*f-y*s,r[3]=0,r[4]=p*y*f-x*s,r[5]=y*y*f+l,r[6]=x*y*f+p*s,r[7]=0,r[8]=p*x*f+y*s,r[9]=y*x*f-p*s,r[10]=x*x*f+l,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r)}function ds(r,e){var n=e[0],s=e[1],l=e[2],f=e[3],p=n+n,y=s+s,x=l+l,b=n*p,I=s*p,S=s*y,D=l*p,R=l*y,L=l*x,F=f*p,V=f*y,$=f*x;return r[0]=1-S-L,r[1]=I+$,r[2]=D-V,r[3]=0,r[4]=I-$,r[5]=1-b-L,r[6]=R+F,r[7]=0,r[8]=D+V,r[9]=R-F,r[10]=1-b-S,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}Math.hypot||(Math.hypot=function(){for(var r=0,e=arguments.length;e--;)r+=arguments[e]*arguments[e];return Math.sqrt(r)});var id=Lt;function ji(){var r=new N(3);return N!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function Qa(r){var e=new N(3);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e}function Pr(r){return Math.hypot(r[0],r[1],r[2])}function qn(r,e,n){var s=new N(3);return s[0]=r,s[1]=e,s[2]=n,s}function Ui(r,e,n){return r[0]=e[0]+n[0],r[1]=e[1]+n[1],r[2]=e[2]+n[2],r}function Qi(r,e,n){return r[0]=e[0]-n[0],r[1]=e[1]-n[1],r[2]=e[2]-n[2],r}function Ms(r,e,n){return r[0]=e[0]*n[0],r[1]=e[1]*n[1],r[2]=e[2]*n[2],r}function As(r,e,n){return r[0]=Math.min(e[0],n[0]),r[1]=Math.min(e[1],n[1]),r[2]=Math.min(e[2],n[2]),r}function Go(r,e,n){return r[0]=Math.max(e[0],n[0]),r[1]=Math.max(e[1],n[1]),r[2]=Math.max(e[2],n[2]),r}function pi(r,e,n){return r[0]=e[0]*n,r[1]=e[1]*n,r[2]=e[2]*n,r}function yo(r,e,n,s){return r[0]=e[0]+n[0]*s,r[1]=e[1]+n[1]*s,r[2]=e[2]+n[2]*s,r}function qo(r,e){var n=e[0]-r[0],s=e[1]-r[1],l=e[2]-r[2];return n*n+s*s+l*l}function ql(r){var e=r[0],n=r[1],s=r[2];return e*e+n*n+s*s}function Wl(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r}function bi(r,e){var n=e[0],s=e[1],l=e[2],f=n*n+s*s+l*l;return f>0&&(f=1/Math.sqrt(f)),r[0]=e[0]*f,r[1]=e[1]*f,r[2]=e[2]*f,r}function Bi(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]}function er(r,e,n){var s=e[0],l=e[1],f=e[2],p=n[0],y=n[1],x=n[2];return r[0]=l*x-f*y,r[1]=f*p-s*x,r[2]=s*y-l*p,r}function Po(r,e,n,s){var l=e[0],f=e[1],p=e[2];return r[0]=l+s*(n[0]-l),r[1]=f+s*(n[1]-f),r[2]=p+s*(n[2]-p),r}function ai(r,e,n){var s=e[0],l=e[1],f=e[2],p=n[3]*s+n[7]*l+n[11]*f+n[15];return r[0]=(n[0]*s+n[4]*l+n[8]*f+n[12])/(p=p||1),r[1]=(n[1]*s+n[5]*l+n[9]*f+n[13])/p,r[2]=(n[2]*s+n[6]*l+n[10]*f+n[14])/p,r}function Zl(r,e,n){var s=e[0],l=e[1],f=e[2];return r[0]=s*n[0]+l*n[3]+f*n[6],r[1]=s*n[1]+l*n[4]+f*n[7],r[2]=s*n[2]+l*n[5]+f*n[8],r}function Rs(r,e,n){var s=n[0],l=n[1],f=n[2],p=e[0],y=e[1],x=e[2],b=l*x-f*y,I=f*p-s*x,S=s*y-l*p,D=l*S-f*I,R=f*b-s*S,L=s*I-l*b,F=2*n[3];return I*=F,S*=F,R*=2,L*=2,r[0]=p+(b*=F)+(D*=2),r[1]=y+I+R,r[2]=x+S+L,r}function Wo(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]}var Vi=Qi,Xl=Ms,ca=Pr;function Lr(){var r=new N(4);return N!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function el(r,e,n){return r[0]=e[0]*n,r[1]=e[1]*n,r[2]=e[2]*n,r[3]=e[3]*n,r}function _u(r,e){var n=e[0],s=e[1],l=e[2],f=e[3],p=n*n+s*s+l*l+f*f;return p>0&&(p=1/Math.sqrt(p)),r[0]=n*p,r[1]=s*p,r[2]=l*p,r[3]=f*p,r}function Or(r,e,n){var s=e[0],l=e[1],f=e[2],p=e[3];return r[0]=n[0]*s+n[4]*l+n[8]*f+n[12]*p,r[1]=n[1]*s+n[5]*l+n[9]*f+n[13]*p,r[2]=n[2]*s+n[6]*l+n[10]*f+n[14]*p,r[3]=n[3]*s+n[7]*l+n[11]*f+n[15]*p,r}function io(){var r=new N(4);return N!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r[3]=1,r}function ua(r){return r[0]=0,r[1]=0,r[2]=0,r[3]=1,r}function ha(r,e,n){n*=.5;var s=e[0],l=e[1],f=e[2],p=e[3],y=Math.sin(n),x=Math.cos(n);return r[0]=s*x+p*y,r[1]=l*x+f*y,r[2]=f*x-l*y,r[3]=p*x-s*y,r}function da(r,e,n){n*=.5;var s=e[0],l=e[1],f=e[2],p=e[3],y=Math.sin(n),x=Math.cos(n);return r[0]=s*x-f*y,r[1]=l*x+p*y,r[2]=f*x+s*y,r[3]=p*x-l*y,r}ji(),Lr();var kr,Yl,Kl,ro,yu,Ps=_u,Jl=(kr=ji(),Yl=qn(1,0,0),Kl=qn(0,1,0),function(r,e,n){var s=Bi(e,n);return s<-.999999?(er(kr,Yl,e),ca(kr)<1e-6&&er(kr,Kl,e),bi(kr,kr),function(l,f,p){p*=.5;var y=Math.sin(p);l[0]=y*f[0],l[1]=y*f[1],l[2]=y*f[2],l[3]=Math.cos(p)}(r,kr,Math.PI),r):s>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(er(kr,e,n),r[0]=kr[0],r[1]=kr[1],r[2]=kr[2],r[3]=1+s,Ps(r,r))});function br(){var r=new N(2);return N!=Float32Array&&(r[0]=0,r[1]=0),r}function Lo(r,e){var n=new N(2);return n[0]=r,n[1]=e,n}function tl(r,e,n){return r[0]=e[0]+n[0],r[1]=e[1]+n[1],r}function fa(r,e,n){return r[0]=e[0]-n[0],r[1]=e[1]-n[1],r}function nl(r,e,n){return r[0]=e[0]*n,r[1]=e[1]*n,r}function pa(r){return Math.hypot(r[0],r[1])}function Ql(r,e){var n=e[0],s=e[1],l=n*n+s*s;return l>0&&(l=1/Math.sqrt(l)),r[0]=e[0]*l,r[1]=e[1]*l,r}function mi(r,e){return r[0]*e[0]+r[1]*e[1]}function ma(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}io(),io(),ce(),br();var ec,oo,Pp=function(){if(yu)return ro;function r(e,n,s,l){this.cx=3*e,this.bx=3*(s-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*n,this.by=3*(l-n)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=n,this.p2x=s,this.p2y=l}return yu=1,ro=r,r.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,n){if(n===void 0&&(n=1e-6),e<0)return 0;if(e>1)return 1;for(var s=e,l=0;l<8;l++){var f=this.sampleCurveX(s)-e;if(Math.abs(f)<n)return s;var p=this.sampleCurveDerivativeX(s);if(Math.abs(p)<1e-6)break;s-=f/p}var y=0,x=1;for(s=e,l=0;l<20&&(f=this.sampleCurveX(s),!(Math.abs(f-e)<n));l++)e>f?y=s:x=s,s=.5*(x-y)+y;return s},solve:function(e,n){return this.sampleCurveY(this.solveCurveX(e,n))}},ro}(),rd=ma(Pp);function il(){if(oo)return ec;function r(e,n){this.x=e,this.y=n}return oo=1,ec=r,r.prototype={clone:function(){return new r(this.x,this.y)},add:function(e){return this.clone()._add(e)},sub:function(e){return this.clone()._sub(e)},multByPoint:function(e){return this.clone()._multByPoint(e)},divByPoint:function(e){return this.clone()._divByPoint(e)},mult:function(e){return this.clone()._mult(e)},div:function(e){return this.clone()._div(e)},rotate:function(e){return this.clone()._rotate(e)},rotateAround:function(e,n){return this.clone()._rotateAround(e,n)},matMult:function(e){return this.clone()._matMult(e)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(e){return this.x===e.x&&this.y===e.y},dist:function(e){return Math.sqrt(this.distSqr(e))},distSqr:function(e){var n=e.x-this.x,s=e.y-this.y;return n*n+s*s},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith:function(e){return this.angleWithSep(e.x,e.y)},angleWithSep:function(e,n){return Math.atan2(this.x*n-this.y*e,this.x*e+this.y*n)},_matMult:function(e){var n=e[2]*this.x+e[3]*this.y;return this.x=e[0]*this.x+e[1]*this.y,this.y=n,this},_add:function(e){return this.x+=e.x,this.y+=e.y,this},_sub:function(e){return this.x-=e.x,this.y-=e.y,this},_mult:function(e){return this.x*=e,this.y*=e,this},_div:function(e){return this.x/=e,this.y/=e,this},_multByPoint:function(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint:function(e){return this.x/=e.x,this.y/=e.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var e=this.y;return this.y=this.x,this.x=-e,this},_rotate:function(e){var n=Math.cos(e),s=Math.sin(e),l=s*this.x+n*this.y;return this.x=n*this.x-s*this.y,this.y=l,this},_rotateAround:function(e,n){var s=Math.cos(e),l=Math.sin(e),f=n.y+l*(this.x-n.x)+s*(this.y-n.y);return this.x=n.x+s*(this.x-n.x)-l*(this.y-n.y),this.y=f,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},r.convert=function(e){return e instanceof r?e:Array.isArray(e)?new r(e[0],e[1]):e},ec}var ot=ma(il());function Ls(r,e){if(Array.isArray(r)){if(!Array.isArray(e)||r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(!Ls(r[n],e[n]))return!1;return!0}if(typeof r=="object"&&r!==null&&e!==null){if(typeof e!="object"||Object.keys(r).length!==Object.keys(e).length)return!1;for(let n in r)if(!Ls(r[n],e[n]))return!1;return!0}return r===e}let Lp=Math.PI/180,vu=180/Math.PI;function gn(r){return r*Lp}function Ae(r){return r*vu}let G=[[0,0],[1,0],[1,1],[0,1]];function X(r){if(r<=0)return 0;if(r>=1)return 1;let e=r*r,n=e*r;return 4*(r<.5?n:3*(r-e)+n-.75)}function ie(r,e,n,s){let l=new rd(r,e,n,s);return function(f){return l.solve(f)}}let pe=ie(.25,.1,.25,1);function ae(r,e,n){return Math.min(n,Math.max(e,r))}function ye(r,e,n){return(n=ae((n-r)/(e-r),0,1))*n*(3-2*n)}function De(r,e,n){let s=n-e,l=((r-e)%s+s)%s+e;return l===e?n:l}function ve(r,e,n){if(!r.length)return n(null,[]);let s=r.length,l=new Array(r.length),f=null;r.forEach((p,y)=>{e(p,(x,b)=>{x&&(f=x),l[y]=b,--s==0&&n(f,l)})})}function Ce(r,...e){for(let n of e)for(let s in n)r[s]=n[s];return r}let $e=1;function Re(){return $e++}function rt(r){return r<=1?1:Math.pow(2,Math.ceil(Math.log(r)/Math.LN2))}function xt(r,e){r.forEach(n=>{e[n]&&(e[n]=e[n].bind(e))})}function wt(r,e,n){let s={};for(let l in r)s[l]=e.call(this,r[l],l,r);return s}function zt(r,e,n){let s={};for(let l in r)e.call(this,r[l],l,r)&&(s[l]=r[l]);return s}function Vt(r){return Array.isArray(r)?r.map(Vt):typeof r=="object"&&r?wt(r,Vt):r}function Ut(r,e){for(let n=0;n<r.length;n++)if(e.indexOf(r[n])>=0)return!0;return!1}let rn={};function qt(r){rn[r]||(typeof console<"u"&&console.warn(r),rn[r]=!0)}function Hn(r,e,n){return(n.y-r.y)*(e.x-r.x)>(e.y-r.y)*(n.x-r.x)}function li(r){let e=0;for(let n,s,l=0,f=r.length,p=f-1;l<f;p=l++)n=r[l],s=r[p],e+=(s.x-n.x)*(n.y+s.y);return e}function ci([r,e,n]){let s=gn(e+90),l=gn(n);return{x:r*Math.cos(s)*Math.sin(l),y:r*Math.sin(s)*Math.sin(l),z:r*Math.cos(l),azimuthal:e,polar:n}}function An(r){return(typeof self<"u"||r!==void 0)&&typeof WorkerGlobalScope<"u"&&(r!==void 0?r:self)instanceof WorkerGlobalScope}function yn(r){let e={};if(r.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(n,s,l,f)=>{let p=l||f;return e[s]=!p||p.toLowerCase(),""}),e["max-age"]){let n=parseInt(e["max-age"],10);isNaN(n)?delete e["max-age"]:e["max-age"]=n}return e}let Ri=null;function wi(r,e){return[r[4*e],r[4*e+1],r[4*e+2],r[4*e+3]]}function _i(r,e,n,s){for(;e<n;){let l=e+n>>1;r[l]<s?e=l+1:n=l}return e}function rr(r,e,n,s){for(;e<n;){let l=e+n>>1;r[l]<=s?e=l+1:n=l}return e}function Zr(r){return r>0?1/(1.001-r):1+r}function wr(r){return r>0?1-1/(1.001-r):-r}function xu(r,e,n){return(r-e.min)*(n.max-n.min)/(e.max-e.min)+n.min}let ar={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!ar.API_URL)return null;try{let r=new URL(ar.API_URL);return r.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":r.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v0.3.0.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function ga(r){return ar.API_URL_REGEX.test(r)}function od(r){return ar.API_SPRITE_REGEX.test(r)}let bu,wu,sd,ad,rl,Eu;function ld(){return bu==null&&(bu=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),bu}let Zo={now:()=>ad!==void 0?ad:performance.now(),setNow(r){ad=r},restoreNow(){ad=void 0},frame(r){let e=requestAnimationFrame(r);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(r,e=0){let{width:n,height:s}=r;rl||(rl=document.createElement("canvas"));let l=rl.getContext("2d",{willReadFrequently:!0});if(!l)throw new Error("failed to create canvas 2d context");return(n>rl.width||s>rl.height)&&(rl.width=n,rl.height=s),l.clearRect(-e,-e,n+2*e,s+2*e),l.drawImage(r,0,0,n,s),l.getImageData(-e,-e,n+2*e,s+2*e)},resolveURL:r=>(wu||(wu=document.createElement("a")),wu.href=r,wu.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(sd==null&&(sd=window.matchMedia("(prefers-reduced-motion: reduce)")),sd.matches)},hasCanvasFingerprintNoise(){if(Eu!==void 0)return Eu;if(!ld())return Eu=!1,!1;let r=new OffscreenCanvas(85,1),e=r.getContext("2d",{willReadFrequently:!0}),n=0;for(let l=0;l<r.width;++l)e.fillStyle=`rgba(${n++},${n++},${n++}, 255)`,e.fillRect(l,0,1,1);let s=e.getImageData(0,0,r.width,r.height);n=0;for(let l=0;l<s.data.length;++l)if(l%4!=3&&n++!==s.data[l])return Eu=!0,!0;return Eu=!1,!1}};function vo(r,e){let n=r.indexOf("?");if(n<0)return`${r}?${new URLSearchParams(e).toString()}`;let s=new URLSearchParams(r.slice(n));for(let l in e)s.set(l,e[l]);return`${r.slice(0,n)}?${s.toString()}`}function Oo(r,e={persistentParams:[]}){let n=r.indexOf("?");if(n<0)return r;let s=new URLSearchParams,l=new URLSearchParams(r.slice(n));for(let p of e.persistentParams){let y=l.get(p);y&&s.set(p,y)}let f=s.toString();return`${r.slice(0,n)}${f.length>0?`?${f}`:""}`}let Os="mapbox-tiles",Xo=500,ks=50,Tu=["language","worldview","jobid"],fs,Iu;function ol(){try{return caches}catch{}}function tc(){let r=ol();r&&fs==null&&(fs=r.open(Os))}let Op=1/0,kp={supported:!1,testSupport:function(r){!Su&&sl&&(nc?j_(r):Xr=r)}},Xr,sl,Su=!1,nc=!1,V_=typeof self<"u"?self:{};function j_(r){let e=r.createTexture();r.bindTexture(r.TEXTURE_2D,e);try{if(r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,sl),r.isContextLost())return;kp.supported=!0}catch{}r.deleteTexture(e),Su=!0}V_.document&&(sl=V_.document.createElement("img"),sl.onload=function(){Xr&&j_(Xr),Xr=null,nc=!0},sl.onerror=function(){Su=!0,Xr=null},sl.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");let Du={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(Du);class pn extends Error{constructor(e,n,s){n===401&&ga(s)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=n,this.url=s}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}let cd=An()?()=>self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,ic=function(r,e){if(!(/^file:/.test(n=r.url)||/^file:/.test(cd())&&!/^\w+:/.test(n))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(s,l){let f=new AbortController,p=new Request(s.url,{method:s.method||"GET",body:s.body,credentials:s.credentials,headers:s.headers,referrer:cd(),referrerPolicy:s.referrerPolicy,signal:f.signal}),y=!1,x=!1,b=(I=p.url).indexOf("sku=")>0&&ga(I);var I;s.type==="json"&&p.headers.set("Accept","application/json");let S=(R,L,F)=>{if(x)return;if(R&&R.message!=="SecurityError"&&qt(R.toString()),L&&F)return D(L);let V=Date.now();fetch(p).then($=>{if($.ok){let Y=b?$.clone():null;return D($,Y,V)}return l(new pn($.statusText,$.status,s.url))}).catch($=>{$.name!=="AbortError"&&l(new Error(`${$.message} ${s.url}`))})},D=(R,L,F)=>{(s.type==="arrayBuffer"?R.arrayBuffer():s.type==="json"?R.json():R.text()).then(V=>{x||(L&&F&&function($,Y,K){if(tc(),fs==null)return;let z=yn(Y.headers.get("Cache-Control")||"");if(z["no-store"])return;let W={status:Y.status,statusText:Y.statusText,headers:new Headers};Y.headers.forEach((me,de)=>W.headers.set(de,me)),z["max-age"]&&W.headers.set("Expires",new Date(K+1e3*z["max-age"]).toUTCString());let J=W.headers.get("Expires");if(!J||new Date(J).getTime()-K<42e4)return;let te=Oo($.url,{persistentParams:Tu});if(Y.status===206){let me=$.headers.get("Range");if(!me)return;W.status=200,te=vo(te,{range:me})}(function(me,de){if(Iu===void 0)try{new Response(new ReadableStream),Iu=!0}catch{Iu=!1}Iu?de(me.body):me.blob().then(de).catch(ge=>qt(ge.message))})(Y,me=>{let de=new Response((ge=Y.status)!==200&&ge!==404&&[101,103,204,205,304].includes(ge)?null:me,W);var ge;tc(),fs?.then(xe=>xe.put(te,de)).catch(xe=>qt(xe.message))})}(p,L,F),y=!0,l(null,V,R.headers.get("Cache-Control"),R.headers.get("Expires")))}).catch(V=>{x||l(new Error(V.message))})};return b?function(R,L){if(tc(),fs==null)return L(null);fs.then(F=>{let V=Oo(R.url,{persistentParams:Tu}),$=R.headers.get("Range");$&&(V=vo(V,{range:$})),F.match(V).then(Y=>{let K=function(z){if(!z)return!1;let W=new Date(z.headers.get("Expires")||0),J=yn(z.headers.get("Cache-Control")||"");return Number(W)>Date.now()&&!J["no-cache"]}(Y);F.delete(V).catch(L),K&&F.put(V,Y.clone()).catch(L),L(null,Y,K)}).catch(L)}).catch(L)}(p,S):S(null,null),{cancel:()=>{x=!0,y||f.abort()}}}(r,e);if(An(self)&&self.worker.actor)return self.worker.actor.send("getResource",r,e,void 0,!0)}var n;return function(s,l){let f=new XMLHttpRequest;f.open(s.method||"GET",s.url,!0),s.type==="arrayBuffer"&&(f.responseType="arraybuffer");for(let p in s.headers)f.setRequestHeader(p,s.headers[p]);return s.type==="json"&&(f.responseType="text",f.setRequestHeader("Accept","application/json")),f.withCredentials=s.credentials==="include",f.onerror=()=>{l(new Error(f.statusText))},f.onload=()=>{if((f.status>=200&&f.status<300||f.status===0)&&f.response!==null){let p=f.response;if(s.type==="json")try{p=JSON.parse(f.response)}catch(y){return l(y)}l(null,p,f.getResponseHeader("Cache-Control"),f.getResponseHeader("Expires"))}else l(new pn(f.statusText,f.status,s.url))},f.send(s.body),{cancel:()=>f.abort()}}(r,e)},Cu=function(r,e){return ic(Ce(r,{type:"arrayBuffer"}),e)};function Db(r){let e=document.createElement("a");return e.href=r,e.protocol===location.protocol&&e.host===location.host}let Mu="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=",al,_a;al=[],_a=0;let Fp=function(r,e){if(kp.supported&&(r.headers||(r.headers={}),r.headers.accept="image/webp,*/*"),_a>=ar.MAX_PARALLEL_IMAGE_REQUESTS){let f={requestParameters:r,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return al.push(f),f}_a++;let n=!1,s=()=>{if(!n)for(n=!0,_a--;al.length&&_a<ar.MAX_PARALLEL_IMAGE_REQUESTS;){let f=al.shift(),{requestParameters:p,callback:y,cancelled:x}=f;x||(f.cancel=Fp(p,y).cancel)}},l=Cu(r,(f,p,y,x)=>{s(),f?e(f):p&&(self.createImageBitmap?function(b,I){let S=new Blob([new Uint8Array(b)],{type:"image/png"});createImageBitmap(S).then(D=>{I(null,D)}).catch(D=>{I(new Error(`Could not load image because of ${D.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(p,(b,I)=>e(b,I,y,x)):function(b,I){let S=new Image;S.onload=()=>{I(null,S),URL.revokeObjectURL(S.src),S.onload=null,requestAnimationFrame(()=>{S.src=Mu})},S.onerror=()=>I(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));let D=new Blob([new Uint8Array(b)],{type:"image/png"});S.src=b.byteLength?URL.createObjectURL(D):Mu}(p,(b,I)=>e(b,I,y,x)))});return{cancel:()=>{l.cancel(),s()}}};var Np,ll,U_,Fs={exports:{}},ud={exports:{}},hd={exports:{}},Yo=function(){if(U_)return Fs.exports;U_=1;var r=(Np||(Np=1,ud.exports=function(n,s){var l,f,p,y,x,b,I,S;for(f=n.length-(l=3&n.length),p=s,x=3432918353,b=461845907,S=0;S<f;)I=255&n.charCodeAt(S)|(255&n.charCodeAt(++S))<<8|(255&n.charCodeAt(++S))<<16|(255&n.charCodeAt(++S))<<24,++S,p=27492+(65535&(y=5*(65535&(p=(p^=I=(65535&(I=(I=(65535&I)*x+(((I>>>16)*x&65535)<<16)&4294967295)<<15|I>>>17))*b+(((I>>>16)*b&65535)<<16)&4294967295)<<13|p>>>19))+((5*(p>>>16)&65535)<<16)&4294967295))+((58964+(y>>>16)&65535)<<16);switch(I=0,l){case 3:I^=(255&n.charCodeAt(S+2))<<16;case 2:I^=(255&n.charCodeAt(S+1))<<8;case 1:p^=I=(65535&(I=(I=(65535&(I^=255&n.charCodeAt(S)))*x+(((I>>>16)*x&65535)<<16)&4294967295)<<15|I>>>17))*b+(((I>>>16)*b&65535)<<16)&4294967295}return p^=n.length,p=2246822507*(65535&(p^=p>>>16))+((2246822507*(p>>>16)&65535)<<16)&4294967295,p=3266489909*(65535&(p^=p>>>13))+((3266489909*(p>>>16)&65535)<<16)&4294967295,(p^=p>>>16)>>>0}),ud.exports),e=(ll||(ll=1,hd.exports=function(n,s){for(var l,f=n.length,p=s^f,y=0;f>=4;)l=1540483477*(65535&(l=255&n.charCodeAt(y)|(255&n.charCodeAt(++y))<<8|(255&n.charCodeAt(++y))<<16|(255&n.charCodeAt(++y))<<24))+((1540483477*(l>>>16)&65535)<<16),p=1540483477*(65535&p)+((1540483477*(p>>>16)&65535)<<16)^(l=1540483477*(65535&(l^=l>>>24))+((1540483477*(l>>>16)&65535)<<16)),f-=4,++y;switch(f){case 3:p^=(255&n.charCodeAt(y+2))<<16;case 2:p^=(255&n.charCodeAt(y+1))<<8;case 1:p=1540483477*(65535&(p^=255&n.charCodeAt(y)))+((1540483477*(p>>>16)&65535)<<16)}return p=1540483477*(65535&(p^=p>>>13))+((1540483477*(p>>>16)&65535)<<16),(p^=p>>>15)>>>0}),hd.exports);return Fs.exports=r,Fs.exports.murmur3=r,Fs.exports.murmur2=e,Fs.exports}(),Au=ma(Yo);class cl{constructor(e,...n){Ce(this,n[0]||{}),this.type=e}}class dd extends cl{constructor(e,n={}){super("error",Ce({error:e},n))}}function zp(r,e,n){n[r]&&n[r].indexOf(e)!==-1||(n[r]=n[r]||[],n[r].push(e))}function fd(r,e,n){if(n&&n[r]){let s=n[r].indexOf(e);s!==-1&&n[r].splice(s,1)}}class ul{on(e,n){return this._listeners=this._listeners||{},zp(e,n,this._listeners),this}off(e,n){return fd(e,n,this._listeners),fd(e,n,this._oneTimeListeners),this}once(e,n){return n?(this._oneTimeListeners=this._oneTimeListeners||{},zp(e,n,this._oneTimeListeners),this):new Promise(s=>{this.once(e,s)})}fire(e,n){let s=typeof e=="string"?new cl(e,n):e,l=s.type;if(this.listens(l)){s.target=this;let f=this._listeners&&this._listeners[l]?this._listeners[l].slice():[];for(let x of f)x.call(this,s);let p=this._oneTimeListeners&&this._oneTimeListeners[l]?this._oneTimeListeners[l].slice():[];for(let x of p)fd(l,x,this._oneTimeListeners),x.call(this,s);let y=this._eventedParent;y&&(Ce(s,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),y.fire(s))}else s instanceof dd&&console.error(s.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,n){return this._eventedParent=e,this._eventedParentData=n,this}}class so{constructor(e){typeof e=="string"?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new so(e)}static toString(e){return e.iconsetId?`${e.name}${e.iconsetId}`:e.name}static parse(e){let[n,s]=e.split("");return new so({name:n,iconsetId:s})}static isEqual(e,n){return e.name===n.name&&e.iconsetId===n.iconsetId}toString(){return so.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var Bp,rc={},hl=function(){if(Bp)return rc;Bp=1;var r={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(f){return(f=Math.round(f))<0?0:f>255?255:f}function n(f){return e(f[f.length-1]==="%"?parseFloat(f)/100*255:parseInt(f))}function s(f){return(p=f[f.length-1]==="%"?parseFloat(f)/100:parseFloat(f))<0?0:p>1?1:p;var p}function l(f,p,y){return y<0?y+=1:y>1&&(y-=1),6*y<1?f+(p-f)*y*6:2*y<1?p:3*y<2?f+(p-f)*(2/3-y)*6:f}try{rc.parseCSSColor=function(f){var p,y=f.replace(/ /g,"").toLowerCase();if(y in r)return r[y].slice();if(y[0]==="#")return y.length===4?(p=parseInt(y.substr(1),16))>=0&&p<=4095?[(3840&p)>>4|(3840&p)>>8,240&p|(240&p)>>4,15&p|(15&p)<<4,1]:null:y.length===7&&(p=parseInt(y.substr(1),16))>=0&&p<=16777215?[(16711680&p)>>16,(65280&p)>>8,255&p,1]:null;var x=y.indexOf("("),b=y.indexOf(")");if(x!==-1&&b+1===y.length){var I=y.substr(0,x),S=y.substr(x+1,b-(x+1)).split(","),D=1;switch(I){case"rgba":if(S.length!==4)return null;D=s(S.pop());case"rgb":return S.length!==3?null:[n(S[0]),n(S[1]),n(S[2]),D];case"hsla":if(S.length!==4)return null;D=s(S.pop());case"hsl":if(S.length!==3)return null;var R=(parseFloat(S[0])%360+360)%360/360,L=s(S[1]),F=s(S[2]),V=F<=.5?F*(L+1):F+L-F*L,$=2*F-V;return[e(255*l($,V,R+1/3)),e(255*l($,V,R)),e(255*l($,V,R-1/3)),D];default:return null}}return null}}catch{}return rc}();class In{constructor(e,n,s,l=1){this.r=e,this.g=n,this.b=s,this.a=l}static parse(e){if(!e)return;if(e instanceof In)return e;if(typeof e!="string")return;let n=hl.parseCSSColor(e);return n?new In(n[0]/255,n[1]/255,n[2]/255,n[3]):void 0}toString(){let[e,n,s,l]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*n)},${Math.round(255*s)},${l})`}toNonPremultipliedRenderColor(e){let{r:n,g:s,b:l,a:f}=this;return new Cb(e,n,s,l,f)}toPremultipliedRenderColor(e){let{r:n,g:s,b:l,a:f}=this;return new Vp(e,n*f,s*f,l*f,f)}clone(){return new In(this.r,this.g,this.b,this.a)}}class Ko{constructor(e,n,s,l,f,p=!1){if(this.premultiplied=!1,this.premultiplied=p,e){let y=e.image.height,x=y*y;this.premultiplied?(n=f===0?0:n/f*(y-1),s=f===0?0:s/f*(y-1),l=f===0?0:l/f*(y-1)):(n*=y-1,s*=y-1,l*=y-1);let b=Math.floor(n),I=Math.floor(s),S=Math.floor(l),D=Math.ceil(n),R=Math.ceil(s),L=Math.ceil(l),F=n-b,V=s-I,$=l-S,Y=e.image.data,K=4*(b+I*x+S*y),z=4*(b+I*x+L*y),W=4*(b+R*x+S*y),J=4*(b+R*x+L*y),te=4*(D+I*x+S*y),me=4*(D+I*x+L*y),de=4*(D+R*x+S*y),ge=4*(D+R*x+L*y);if(K<0||ge>=Y.length)throw new Error("out of range");this.r=kt(kt(kt(Y[K],Y[z],$),kt(Y[W],Y[J],$),V),kt(kt(Y[te],Y[me],$),kt(Y[de],Y[ge],$),V),F)/255*(this.premultiplied?f:1),this.g=kt(kt(kt(Y[K+1],Y[z+1],$),kt(Y[W+1],Y[J+1],$),V),kt(kt(Y[te+1],Y[me+1],$),kt(Y[de+1],Y[ge+1],$),V),F)/255*(this.premultiplied?f:1),this.b=kt(kt(kt(Y[K+2],Y[z+2],$),kt(Y[W+2],Y[J+2],$),V),kt(kt(Y[te+2],Y[me+2],$),kt(Y[de+2],Y[ge+2],$),V),F)/255*(this.premultiplied?f:1),this.a=f}else this.r=n,this.g=s,this.b=l,this.a=f}toArray(){let{r:e,g:n,b:s,a:l}=this;return[255*e,255*n,255*s,l]}toHslaArray(){let{r:e,g:n,b:s,a:l}=this;if(this.premultiplied){if(l===0)return[0,0,0,0];e/=l,n/=l,s/=l}let f=Math.min(Math.max(e,0),1),p=Math.min(Math.max(n,0),1),y=Math.min(Math.max(s,0),1),x=Math.min(f,p,y),b=Math.max(f,p,y),I=(x+b)/2;if(x===b)return[0,0,100*I,l];let S=b-x,D=I>.5?S/(2-b-x):S/(b+x),R=0;return b===f?R=(p-y)/S+(p<y?6:0):b===p?R=(y-f)/S+2:b===y&&(R=(f-p)/S+4),R*=60,[Math.min(Math.max(R,0),360),Math.min(Math.max(100*D,0),100),Math.min(Math.max(100*I,0),100),l]}toArray01(){let{r:e,g:n,b:s,a:l}=this;return[e,n,s,l]}toArray01Scaled(e){let{r:n,g:s,b:l}=this;return[n*e,s*e,l*e]}toArray01Linear(){let{r:e,g:n,b:s,a:l}=this;return[Math.pow(e,2.2),Math.pow(n,2.2),Math.pow(s,2.2),l]}}class Cb extends Ko{constructor(e,n,s,l,f){super(e,n,s,l,f,!1)}}class Vp extends Ko{constructor(e,n,s,l,f){super(e,n,s,l,f,!0)}}function kt(r,e,n){return r*(1-n)+e*n}function pd(r,e,n){return r.map((s,l)=>kt(s,e[l],n))}In.black=new In(0,0,0,1),In.white=new In(1,1,1,1),In.transparent=new In(0,0,0,0),In.red=new In(1,0,0,1),In.blue=new In(0,0,1,1);var Ru=Object.freeze({__proto__:null,array:pd,color:function(r,e,n){return new In(kt(r.r,e.r,n),kt(r.g,e.g,n),kt(r.b,e.b,n),kt(r.a,e.a,n))},number:kt});function dl(r,...e){for(let n of e)for(let s in n)r[s]=n[s];return r}class xo extends Error{constructor(e,n){super(n),this.message=n,this.key=e}}class jp{constructor(e,n=[]){this.parent=e,this.bindings={};for(let[s,l]of n)this.bindings[s]=l}concat(e){return new jp(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}let oc={kind:"null"},Tt={kind:"number"},On={kind:"string"},bn={kind:"boolean"},ao={kind:"color"},Ns={kind:"object"},Sn={kind:"value"},md={kind:"collator"},Pu={kind:"formatted"},Lu={kind:"resolvedImage"};function Fr(r,e){return{kind:"array",itemType:r,N:e}}function Wi(r){if(r.kind==="array"){let e=Wi(r.itemType);return typeof r.N=="number"?`array<${e}, ${r.N}>`:r.itemType.kind==="value"?"array":`array<${e}>`}return r.kind}let Mb=[oc,Tt,On,bn,ao,Pu,Ns,Fr(Sn),Lu];function sc(r,e){if(e.kind==="error")return null;if(r.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!sc(r.itemType,e.itemType))&&(typeof r.N!="number"||r.N===e.N))return null}else{if(r.kind===e.kind)return null;if(r.kind==="value"){for(let n of Mb)if(!sc(n,e))return null}}return`Expected ${Wi(r)} but found ${Wi(e)} instead.`}function ya(r,e){return e.some(n=>n.kind===r.kind)}function Ou(r,e){return e.some(n=>n==="null"?r===null:n==="array"?Array.isArray(r):n==="object"?r&&!Array.isArray(r)&&typeof r=="object":n===typeof r)}function gd(r,e){return r.kind==="array"&&e.kind==="array"?r.N===e.N&&gd(r.itemType,e.itemType):r.kind===e.kind}class ku{constructor(e,n,s){this.sensitivity=e?n?"variant":"case":n?"accent":"base",this.locale=s,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,n){return this.collator.compare(e,n)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class _d{constructor(e,n,s,l,f){this.text=e.normalize?e.normalize():e,this.image=n,this.scale=s,this.fontStack=l,this.textColor=f}}class Nr{constructor(e){this.sections=e}static fromString(e){return new Nr([new _d(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||!!e.image&&e.image.hasPrimary())}static factory(e){return e instanceof Nr?e:Nr.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){let e=["format"];for(let n of this.sections){if(n.image){let l=n.image.getPrimary().id.toString();e.push(["image",l]);continue}e.push(n.text);let s={};n.fontStack&&(s["text-font"]=["literal",n.fontStack.split(",")]),n.scale&&(s["font-scale"]=n.scale),n.textColor&&(s["text-color"]=["rgba"].concat(n.textColor.toNonPremultipliedRenderColor(null).toArray())),e.push(s)}return e}}class zs{constructor(e,n={}){if(this.id=so.from(e),this.options=Object.assign({},n),n.transform){let{a:s,b:l,c:f,d:p,e:y,f:x}=n.transform;this.options.transform=new DOMMatrix([s,l,f,p,y,x])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){let{a:e,b:n,c:s,d:l,e:f,f:p}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:e,b:n,c:s,d:l,e:f,f:p}})}static parse(e){let n,s,l,f;try{({name:n,iconsetId:s,params:l,transform:f}=JSON.parse(e)||{})}catch{return null}if(!n)return null;let{a:p,b:y,c:x,d:b,e:I,f:S}=f||{};return new zs({name:n,iconsetId:s},{params:l,transform:new DOMMatrix([p,y,x,b,I,S])})}scaleSelf(e,n){return this.options.transform.scaleSelf(e,n),this}}class Yr{constructor(e,n,s,l,f=!1){this.primaryId=so.from(e),this.primaryOptions=n,s&&(this.secondaryId=so.from(s)),this.secondaryOptions=l,this.available=f}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new zs(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new zs(this.secondaryId,this.secondaryOptions):null}static from(e){return typeof e=="string"?Yr.build({name:e}):e}static build(e,n,s,l){return!e||typeof e=="object"&&!("name"in e)?null:new Yr(e,s,n,l)}}function fl(r,e,n,s){return typeof r=="number"&&r>=0&&r<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof n=="number"&&n>=0&&n<=255?s===void 0||typeof s=="number"&&s>=0&&s<=1?null:`Invalid rgba value [${[r,e,n,s].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof s=="number"?[r,e,n,s]:[r,e,n]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function en(r){if(r===null||typeof r=="string"||typeof r=="boolean"||typeof r=="number"||r instanceof In||r instanceof ku||r instanceof Nr||r instanceof Yr)return!0;if(Array.isArray(r)){for(let e of r)if(!en(e))return!1;return!0}if(typeof r=="object"){for(let e in r)if(!en(r[e]))return!1;return!0}return!1}function ft(r){if(r===null)return oc;if(typeof r=="string")return On;if(typeof r=="boolean")return bn;if(typeof r=="number")return Tt;if(r instanceof In)return ao;if(r instanceof ku)return md;if(r instanceof Nr)return Pu;if(r instanceof Yr)return Lu;if(Array.isArray(r)){let e=r.length,n;for(let s of r){let l=ft(s);if(n){if(n===l)continue;n=Sn;break}n=l}return Fr(n||Sn,e)}return Ns}function ko(r){let e=typeof r;return r===null?"":e==="string"||e==="number"||e==="boolean"?String(r):r instanceof Nr||r instanceof Yr||r instanceof In?r.toString():JSON.stringify(r)}class Bt{constructor(e,n){this.type=e,this.value=n}static parse(e,n){if(e.length!==2)return n.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!en(e[1]))return n.error("invalid value");let s=e[1],l=ft(s),f=n.expectedType;return l.kind!=="array"||l.N!==0||!f||f.kind!=="array"||typeof f.N=="number"&&f.N!==0||(l=f),new Bt(l,s)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof In?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof Nr?this.value.serialize():this.value}}class Hi{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}let Fu={string:On,number:Tt,boolean:bn,object:Ns};class Pt{constructor(e,n){this.type=e,this.args=n}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");let s,l=1,f=e[0];if(f==="array"){let y,x;if(e.length>2){let b=e[1];if(typeof b!="string"||!(b in Fu)||b==="object")return n.error('The item type argument of "array" must be one of string, number, boolean',1);y=Fu[b],l++}else y=Sn;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return n.error('The length argument to "array" must be a positive integer literal',2);x=e[2],l++}s=Fr(y,x)}else s=Fu[f];let p=[];for(;l<e.length;l++){let y=n.parse(e[l],l,Sn);if(!y)return null;p.push(y)}return new Pt(s,p)}evaluate(e){for(let n=0;n<this.args.length;n++){let s=this.args[n].evaluate(e);if(!sc(this.type,ft(s)))return s;if(n===this.args.length-1)throw new Hi(`The expression ${JSON.stringify(this.args[n].serialize())} evaluated to ${Wi(ft(s))} but was expected to be of type ${Wi(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){let e=this.type,n=[e.kind];if(e.kind==="array"){let s=e.itemType;if(s.kind==="string"||s.kind==="number"||s.kind==="boolean"){n.push(s.kind);let l=e.N;(typeof l=="number"||this.args.length>1)&&n.push(l)}}return n.concat(this.args.map(s=>s.serialize()))}}class ac{constructor(e){this.type=Pu,this.sections=e}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");let s=e[1];if(!Array.isArray(s)&&typeof s=="object")return n.error("First argument must be an image or text section.");let l=[],f=!1;for(let p=1;p<=e.length-1;++p){let y=e[p];if(f&&typeof y=="object"&&!Array.isArray(y)){f=!1;let x=null;if(y["font-scale"]&&(x=n.parseObjectValue(y["font-scale"],p,"font-scale",Tt),!x))return null;let b=null;if(y["text-font"]&&(b=n.parseObjectValue(y["text-font"],p,"text-font",Fr(On)),!b))return null;let I=null;if(y["text-color"]&&(I=n.parseObjectValue(y["text-color"],p,"text-color",ao),!I))return null;let S=l[l.length-1];S.scale=x,S.font=b,S.textColor=I}else{let x=n.parse(e[p],p,Sn);if(!x)return null;let b=x.type.kind;if(b!=="string"&&b!=="value"&&b!=="null"&&b!=="resolvedImage")return n.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");f=!0,l.push({content:x,scale:null,font:null,textColor:null})}}return new ac(l)}evaluate(e){return new Nr(this.sections.map(n=>{let s=n.content.evaluate(e);return gd(ft(s),Lu)?new _d("",s,null,null,null):new _d(ko(s),null,n.scale?n.scale.evaluate(e):null,n.font?n.font.evaluate(e).join(","):null,n.textColor?n.textColor.evaluate(e):null)}))}eachChild(e){for(let n of this.sections)e(n.content),n.scale&&e(n.scale),n.font&&e(n.font),n.textColor&&e(n.textColor)}outputDefined(){return!1}serialize(){let e=["format"];for(let n of this.sections){e.push(n.content.serialize());let s={};n.scale&&(s["font-scale"]=n.scale.serialize()),n.font&&(s["text-font"]=n.font.serialize()),n.textColor&&(s["text-color"]=n.textColor.serialize()),e.push(s)}return e}}class lc{constructor(e,n,s,l){this._imageWarnHistory={},this.type=Lu,this.namePrimary=e,this.nameSecondary=n,s&&(this.paramsPrimary=s.params,this.iconsetIdPrimary=s.iconset?s.iconset.id:void 0),l&&(this.paramsSecondary=l.params,this.iconsetIdSecondary=l.iconset?l.iconset.id:void 0)}static parse(e,n){if(e.length<2)return n.error("Expected two or more arguments.");let s=1,l=[];function f(){if(s<e.length){let y=n.parse(e[s],s++,On);return y?(l.push({image:y,options:{}}),!0):(n.error(l.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function p(){if(s<e.length){let x=e[s];if((y=x)===null||typeof y!="object"||Array.isArray(y))return!0;let b=x.params,I=x.iconset,S=n.concat(s);if(!b&&!I)return s++,!0;if(b){if(typeof b!="object"||b.constructor!==Object)return S.error('Image options "params" should be an object'),!1;let D={},R=S.concat(void 0,"params");for(let L in b){if(!L)return R.error("Image parameter name should be non-empty"),!1;let F=R.concat(void 0,L).parse(b[L],void 0,ao,void 0,{typeAnnotation:"coerce"});if(!F)return!1;D[L]=F}l[l.length-1].options.params=D}if(I){if(typeof I!="object"||I.constructor!==Object)return S.error('Image options "iconset" should be an object'),!1;if(!I.id)return S.error('Image options "iconset" should have an "id" property'),!1;l[l.length-1].options.iconset=I}return s++,!0}var y;return!0}for(let y=0;y<2;y++)if(!f()||!p())return;return new lc(l[0].image,l[1]?l[1].image:void 0,l[0].options,l[1]?l[1].options:void 0)}evaluateParams(e,n){let s={};if(n){for(let l in n)if(n[l])try{s[l]=n[l].evaluate(e)}catch{continue}if(Object.keys(s).length!==0)return{params:s}}}evaluate(e){let n={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},s=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,l=Yr.build(n,s,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(l&&e.availableImages){let f=l.getPrimary().id;if(l.available=e.availableImages.some(p=>so.isEqual(p,f)),l.available){let p=l.getSecondary()?l.getSecondary().id:null;p&&(l.available=e.availableImages.some(y=>so.isEqual(y,p)))}}return l}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(let n in this.paramsPrimary)this.paramsPrimary[n]&&e(this.paramsPrimary[n]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(let n in this.paramsSecondary)this.paramsSecondary[n]&&e(this.paramsSecondary[n])}outputDefined(){return!1}serializeOptions(e,n){let s={};if(n&&(s.iconset={id:n}),e){s.params={};for(let l in e)e[l]&&(s.params[l]=e[l].serialize())}return Object.keys(s).length>0?s:void 0}serialize(){let e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){let n=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);n&&e.push(n)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){let n=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);n&&e.push(n)}return e}}function va(r){return r instanceof Number?"number":r instanceof String?"string":r instanceof Boolean?"boolean":Array.isArray(r)?"array":r===null?"null":typeof r}let H_={"to-boolean":bn,"to-color":ao,"to-number":Tt,"to-string":On};class Fo{constructor(e,n){this.type=e,this.args=n}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");let s=e[0],l=[],f=oc;if(s==="to-array"){if(!Array.isArray(e[1]))return null;let p=e[1].length;if(n.expectedType){if(n.expectedType.kind!=="array")return n.error(`Expected ${n.expectedType.kind} but found array.`);f=Fr(n.expectedType.itemType,p)}else{if(!(p>0&&en(e[1][0])))return null;f=Fr(ft(e[1][0]),p)}for(let y=0;y<p;y++){let x=e[1][y],b;if(va(x)==="array")b=n.parse(x,void 0,f.itemType);else{let I=va(x);if(I!==f.itemType.kind)return n.error(`Expected ${f.itemType.kind} but found ${I}.`);b=n.registry.literal.parse(["literal",x===void 0?null:x],n)}if(!b)return null;l.push(b)}}else{if((s==="to-boolean"||s==="to-string")&&e.length!==2)return n.error("Expected one argument.");f=H_[s];for(let p=1;p<e.length;p++){let y=n.parse(e[p],p,Sn);if(!y)return null;l.push(y)}}return new Fo(f,l)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let n,s;for(let l of this.args){if(n=l.evaluate(e),s=null,n instanceof In)return n;if(typeof n=="string"){let f=e.parseColor(n);if(f)return f}else if(Array.isArray(n)&&(s=n.length<3||n.length>4?`Invalid rbga value ${JSON.stringify(n)}: expected an array containing either three or four numeric values.`:fl(n[0],n[1],n[2],n[3]),!s))return new In(n[0]/255,n[1]/255,n[2]/255,n[3])}throw new Hi(s||`Could not parse color from value '${typeof n=="string"?n:String(JSON.stringify(n))}'`)}if(this.type.kind==="number"){let n=null;for(let s of this.args){if(n=s.evaluate(e),n===null)return 0;let l=Number(n);if(!isNaN(l))return l}throw new Hi(`Could not convert ${JSON.stringify(n)} to number.`)}return this.type.kind==="formatted"?Nr.fromString(ko(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?Yr.build(ko(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map(n=>n.evaluate(e)):ko(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new ac([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new lc(this.args[0]).serialize();let e=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(n=>{e.push(n.serialize())}),e}}let zr=["Unknown","Point","LineString","Polygon"];class Nu{constructor(e,n){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=n}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?zr[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){let e=this.featureDistanceData.center,n=this.featureDistanceData.scale,{x:s,y:l}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(s*n-e[0])+this.featureDistanceData.bearing[1]*(l*n-e[1])}return 0}parseColor(e){let n=this._parseColorCache[e];return n||(n=this._parseColorCache[e]=In.parse(e)),n}getConfig(e){return this.options?this.options.get(e):null}}class or{constructor(e,n,s,l,f){this.name=e,this.type=n,this._evaluate=s,this.args=l,this._overloadIndex=f}evaluate(e){if(!this._evaluate){let n=or.definitions[this.name];this._evaluate=Array.isArray(n)?n[2]:n.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,n){let s=e[0],l=or.definitions[s];if(!l)return n.error(`Unknown expression "${s}". If you wanted a literal array, use ["literal", [...]].`,0);let f=Array.isArray(l)?l[0]:l.type,p=Array.isArray(l)?[[l[1],l[2]]]:l.overloads,y=[],x=null,b=-1;for(let[I,S]of p){if(Array.isArray(I)&&I.length!==e.length-1)continue;y.push(I),b++,x=new Md(n.registry,n.path,null,n.scope,void 0,n._scope,n.options);let D=[],R=!1;for(let L=1;L<e.length;L++){let F=e[L],V=Array.isArray(I)?I[L-1]:I.type,$=x.parse(F,1+D.length,V);if(!$){R=!0;break}D.push($)}if(!R)if(Array.isArray(I)&&I.length!==D.length)x.error(`Expected ${I.length} arguments, but found ${D.length} instead.`);else{for(let L=0;L<D.length;L++){let F=Array.isArray(I)?I[L]:I.type,V=D[L];x.concat(L+1).checkSubtype(F,V.type)}if(x.errors.length===0)return new or(s,f,S,D,b)}}if(y.length===1)n.errors.push(...x.errors);else{let I=(y.length?y:p.map(([D])=>D)).map(Up).join(" | "),S=[];for(let D=1;D<e.length;D++){let R=n.parse(e[D],1+S.length);if(!R)return null;S.push(Wi(R.type))}n.error(`Expected arguments of type ${I}, but found (${S.join(", ")}) instead.`)}return null}static register(e,n){or.definitions=n;for(let s in n)e[s]=or}}function Up(r){return Array.isArray(r)?`(${r.map(Wi).join(", ")})`:`(${Wi(r.type)}...)`}class ps{constructor(e,n,s){this.type=md,this.locale=s,this.caseSensitive=e,this.diacriticSensitive=n}static parse(e,n){if(e.length!==2)return n.error("Expected one argument.");let s=e[1];if(typeof s!="object"||Array.isArray(s))return n.error("Collator options argument must be an object.");let l=s["case-sensitive"]===void 0?n.parse(!1,1,bn):n.parseObjectValue(s["case-sensitive"],1,"case-sensitive",bn);if(!l)return null;let f=s["diacritic-sensitive"]===void 0?n.parse(!1,1,bn):n.parseObjectValue(s["diacritic-sensitive"],1,"diacritic-sensitive",bn);if(!f)return null;let p=null;return s.locale&&(p=n.parseObjectValue(s.locale,1,"locale",On),!p)?null:new ps(l,f,p)}evaluate(e){return new ku(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){let e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function Er(r,e,n=0,s=r.length-1,l=Ab){for(;s>n;){if(s-n>600){let x=s-n+1,b=e-n+1,I=Math.log(x),S=.5*Math.exp(2*I/3),D=.5*Math.sqrt(I*S*(x-S)/x)*(b-x/2<0?-1:1);Er(r,e,Math.max(n,Math.floor(e-b*S/x+D)),Math.min(s,Math.floor(e+(x-b)*S/x+D)),l)}let f=r[e],p=n,y=s;for(zu(r,n,e),l(r[s],f)>0&&zu(r,n,s);p<y;){for(zu(r,p,y),p++,y--;l(r[p],f)<0;)p++;for(;l(r[y],f)>0;)y--}l(r[n],f)===0?zu(r,n,y):(y++,zu(r,y,s)),y<=e&&(n=y+1),e<=y&&(s=y-1)}}function zu(r,e,n){let s=r[e];r[e]=r[n],r[n]=s}function Ab(r,e){return r<e?-1:r>e?1:0}function Rb(r){let e=0;for(let n,s,l=0,f=r.length,p=f-1;l<f;p=l++)n=r[l],s=r[p],e+=(s.x-n.x)*(n.y+s.y);return e}function xa(r,e){r[0]=Math.min(r[0],e[0]),r[1]=Math.min(r[1],e[1]),r[2]=Math.max(r[2],e[0]),r[3]=Math.max(r[3],e[1])}function cc(r,e){return!(r[0]<=e[0]||r[2]>=e[2]||r[1]<=e[1]||r[3]>=e[3])}function pl(r,e,n){let s=r[0]-e[0],l=r[1]-e[1],f=r[0]-n[0],p=r[1]-n[1];return s*p-f*l==0&&s*f<=0&&l*p<=0}function uc(r,e,n=!1){let s=!1;for(let y=0,x=e.length;y<x;y++){let b=e[y];for(let I=0,S=b.length,D=S-1;I<S;D=I++){let R=b[D],L=b[I];if(pl(r,R,L))return n;(f=R)[1]>(l=r)[1]!=(p=L)[1]>l[1]&&l[0]<(p[0]-f[0])*(l[1]-f[1])/(p[1]-f[1])+f[0]&&(s=!s)}}var l,f,p;return s}function $_(r,e,n,s){let l=s[0]-n[0],f=s[1]-n[1],p=(r[0]-n[0])*f-l*(r[1]-n[1]),y=(e[0]-n[0])*f-l*(e[1]-n[1]);return p>0&&y<0||p<0&&y>0}function yd(r,e,n,s){return(l=[s[0]-n[0],s[1]-n[1]])[0]*(f=[e[0]-r[0],e[1]-r[1]])[1]-l[1]*f[0]!=0&&!(!$_(r,e,n,s)||!$_(n,s,r,e));var l,f}function Hp(r){let e=new ot(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),n=new ot(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let s of r[0])e.x>s.x&&(e.x=s.x),e.y>s.y&&(e.y=s.y),n.x<s.x&&(n.x=s.x),n.y<s.y&&(n.y=s.y);return{min:e,max:n}}let Bs=8192;function Pb(r,e){let n=(180+r[0])/360,s=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r[1]*Math.PI/360)))/360,l=Math.pow(2,e.z);return[Math.round(n*l*Bs),Math.round(s*l*Bs)]}function Lb(r,e){for(let n=0;n<e.length;n++)if(uc(r,e[n]))return!0;return!1}function G_(r,e,n){for(let s of n)for(let l=0,f=s.length,p=f-1;l<f;p=l++)if(yd(r,e,s[p],s[l]))return!0;return!1}function q_(r,e){for(let n=0;n<r.length;++n)if(!uc(r[n],e))return!1;for(let n=0;n<r.length-1;++n)if(G_(r[n],r[n+1],e))return!1;return!0}function ml(r,e){for(let n=0;n<e.length;n++)if(q_(r,e[n]))return!0;return!1}function $p(r,e,n){let s=[];for(let l=0;l<r.length;l++){let f=[];for(let p=0;p<r[l].length;p++){let y=Pb(r[l][p],n);xa(e,y),f.push(y)}s.push(f)}return s}function W_(r,e,n){let s=[];for(let l=0;l<r.length;l++){let f=$p(r[l],e,n);s.push(f)}return s}function vd(r,e,n,s){if(r[0]<n[0]||r[0]>n[2]){let l=.5*s,f=r[0]-n[0]>l?-s:n[0]-r[0]>l?s:0;f===0&&(f=r[0]-n[2]>l?-s:n[2]-r[0]>l?s:0),r[0]+=f}xa(e,r)}function Gp(r,e,n,s){let l=Math.pow(2,s.z)*Bs,f=[s.x*Bs,s.y*Bs],p=[];if(!r)return p;for(let y of r)for(let x of y){let b=[x.x+f[0],x.y+f[1]];vd(b,e,n,l),p.push(b)}return p}function qp(r,e,n,s){let l=Math.pow(2,s.z)*Bs,f=[s.x*Bs,s.y*Bs],p=[];if(!r)return p;for(let x of r){let b=[];for(let I of x){let S=[I.x+f[0],I.y+f[1]];xa(e,S),b.push(S)}p.push(b)}if(e[2]-e[0]<=l/2){(y=e)[0]=y[1]=1/0,y[2]=y[3]=-1/0;for(let x of p)for(let b of x)vd(b,e,n,l)}var y;return p}class Tr{constructor(e,n){this.type=bn,this.geojson=e,this.geometries=n}static parse(e,n){if(e.length!==2)return n.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(en(e[1])){let s=e[1];if(s.type==="FeatureCollection")for(let l=0;l<s.features.length;++l){let f=s.features[l].geometry.type;if(f==="Polygon"||f==="MultiPolygon")return new Tr(s,s.features[l].geometry)}else if(s.type==="Feature"){let l=s.geometry.type;if(l==="Polygon"||l==="MultiPolygon")return new Tr(s,s.geometry)}else if(s.type==="Polygon"||s.type==="MultiPolygon")return new Tr(s,s)}return n.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(n,s){let l=[1/0,1/0,-1/0,-1/0],f=[1/0,1/0,-1/0,-1/0],p=n.canonicalID();if(!p)return!1;if(s.type==="Polygon"){let y=$p(s.coordinates,f,p),x=Gp(n.geometry(),l,f,p);if(!cc(l,f))return!1;for(let b of x)if(!uc(b,y))return!1}if(s.type==="MultiPolygon"){let y=W_(s.coordinates,f,p),x=Gp(n.geometry(),l,f,p);if(!cc(l,f))return!1;for(let b of x)if(!Lb(b,y))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(n,s){let l=[1/0,1/0,-1/0,-1/0],f=[1/0,1/0,-1/0,-1/0],p=n.canonicalID();if(!p)return!1;if(s.type==="Polygon"){let y=$p(s.coordinates,f,p),x=qp(n.geometry(),l,f,p);if(!cc(l,f))return!1;for(let b of x)if(!q_(b,y))return!1}if(s.type==="MultiPolygon"){let y=W_(s.coordinates,f,p),x=qp(n.geometry(),l,f,p);if(!cc(l,f))return!1;for(let b of x)if(!ml(b,y))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}let Bu={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},Wp=1/298.257223563,Zp=Wp*(2-Wp),hc=Math.PI/180;class dc{static fromTile(e,n,s){let l=Math.PI*(1-2*(e+.5)/Math.pow(2,n)),f=Math.atan(.5*(Math.exp(l)-Math.exp(-l)))/hc;return new dc(f,s)}static get units(){return Bu}constructor(e,n){if(e===void 0)throw new Error("No latitude given.");if(n&&!Bu[n])throw new Error(`Unknown unit ${n}. Use one of: ${Object.keys(Bu).join(", ")}`);let s=6378.137*hc*(n?Bu[n]:1),l=Math.cos(e*hc),f=1/(1-Zp*(1-l*l)),p=Math.sqrt(f);this.kx=s*p*l,this.ky=s*p*f*(1-Zp)}distance(e,n){let s=bo(e[0]-n[0])*this.kx,l=(e[1]-n[1])*this.ky;return Math.sqrt(s*s+l*l)}bearing(e,n){let s=bo(n[0]-e[0])*this.kx;return Math.atan2(s,(n[1]-e[1])*this.ky)/hc}destination(e,n,s){let l=s*hc;return this.offset(e,Math.sin(l)*n,Math.cos(l)*n)}offset(e,n,s){return[e[0]+n/this.kx,e[1]+s/this.ky]}lineDistance(e){let n=0;for(let s=0;s<e.length-1;s++)n+=this.distance(e[s],e[s+1]);return n}area(e){let n=0;for(let s=0;s<e.length;s++){let l=e[s];for(let f=0,p=l.length,y=p-1;f<p;y=f++)n+=bo(l[f][0]-l[y][0])*(l[f][1]+l[y][1])*(s?-1:1)}return Math.abs(n)/2*this.kx*this.ky}along(e,n){let s=0;if(n<=0)return e[0];for(let l=0;l<e.length-1;l++){let f=e[l],p=e[l+1],y=this.distance(f,p);if(s+=y,s>n)return xd(f,p,(n-(s-y))/y)}return e[e.length-1]}pointToSegmentDistance(e,n,s){let[l,f]=n,p=bo(s[0]-l)*this.kx,y=(s[1]-f)*this.ky;if(p!==0||y!==0){let x=(bo(e[0]-l)*this.kx*p+(e[1]-f)*this.ky*y)/(p*p+y*y);x>1?(l=s[0],f=s[1]):x>0&&(l+=p/this.kx*x,f+=y/this.ky*x)}return p=bo(e[0]-l)*this.kx,y=(e[1]-f)*this.ky,Math.sqrt(p*p+y*y)}pointOnLine(e,n){let s=1/0,l=e[0][0],f=e[0][1],p=0,y=0;for(let x=0;x<e.length-1;x++){let b=e[x][0],I=e[x][1],S=bo(e[x+1][0]-b)*this.kx,D=(e[x+1][1]-I)*this.ky,R=0;S===0&&D===0||(R=(bo(n[0]-b)*this.kx*S+(n[1]-I)*this.ky*D)/(S*S+D*D),R>1?(b=e[x+1][0],I=e[x+1][1]):R>0&&(b+=S/this.kx*R,I+=D/this.ky*R)),S=bo(n[0]-b)*this.kx,D=(n[1]-I)*this.ky;let L=S*S+D*D;L<s&&(s=L,l=b,f=I,p=x,y=R)}return{point:[l,f],index:p,t:Math.max(0,Math.min(1,y))}}lineSlice(e,n,s){let l=this.pointOnLine(s,e),f=this.pointOnLine(s,n);if(l.index>f.index||l.index===f.index&&l.t>f.t){let b=l;l=f,f=b}let p=[l.point],y=l.index+1,x=f.index;!Xp(s[y],p[0])&&y<=x&&p.push(s[y]);for(let b=y+1;b<=x;b++)p.push(s[b]);return Xp(s[x],f.point)||p.push(f.point),p}lineSliceAlong(e,n,s){let l=0,f=[];for(let p=0;p<s.length-1;p++){let y=s[p],x=s[p+1],b=this.distance(y,x);if(l+=b,l>e&&f.length===0&&f.push(xd(y,x,(e-(l-b))/b)),l>=n)return f.push(xd(y,x,(n-(l-b))/b)),f;l>e&&f.push(x)}return f}bufferPoint(e,n){let s=n/this.ky,l=n/this.kx;return[e[0]-l,e[1]-s,e[0]+l,e[1]+s]}bufferBBox(e,n){let s=n/this.ky,l=n/this.kx;return[e[0]-l,e[1]-s,e[2]+l,e[3]+s]}insideBBox(e,n){return bo(e[0]-n[0])>=0&&bo(e[0]-n[2])<=0&&e[1]>=n[1]&&e[1]<=n[3]}}function Xp(r,e){return r[0]===e[0]&&r[1]===e[1]}function xd(r,e,n){let s=bo(e[0]-r[0]);return[r[0]+s*n,r[1]+(e[1]-r[1])*n]}function bo(r){for(;r<-180;)r+=360;for(;r>180;)r-=360;return r}class bd{constructor(e=[],n=(s,l)=>s<l?-1:s>l?1:0){if(this.data=e,this.length=this.data.length,this.compare=n,this.length>0)for(let s=(this.length>>1)-1;s>=0;s--)this._down(s)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;let e=this.data[0],n=this.data.pop();return--this.length>0&&(this.data[0]=n,this._down(0)),e}peek(){return this.data[0]}_up(e){let{data:n,compare:s}=this,l=n[e];for(;e>0;){let f=e-1>>1,p=n[f];if(s(l,p)>=0)break;n[e]=p,e=f}n[e]=l}_down(e){let{data:n,compare:s}=this,l=this.length>>1,f=n[e];for(;e<l;){let p=1+(e<<1),y=p+1;if(y<this.length&&s(n[y],n[p])<0&&(p=y),s(n[p],f)>=0)break;n[e]=n[p],e=p}n[e]=f}}var at=8192;function Yp(r,e){return e.dist-r.dist}let fc=100,pc=50;function Vu(r){let e=[1/0,1/0,-1/0,-1/0];if(e.length!==r.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==r[n])return!1;return!0}function ju(r){return r[1]-r[0]+1}function ms(r,e){let n=r[1]>=r[0]&&r[1]<e;return n||console.warn("Distance Expression: Index is out of range"),n}function wd(r,e){if(r[0]>r[1])return[null,null];let n=ju(r);if(e){if(n===2)return[r,null];let s=Math.floor(n/2);return[[r[0],r[0]+s],[r[0]+s,r[1]]]}{if(n===1)return[r,null];let s=Math.floor(n/2)-1;return[[r[0],r[0]+s],[r[0]+s+1,r[1]]]}}function No(r,e){let n=[1/0,1/0,-1/0,-1/0];if(!ms(e,r.length))return n;for(let s=e[0];s<=e[1];++s)xa(n,r[s]);return n}function un(r){let e=[1/0,1/0,-1/0,-1/0];for(let n=0;n<r.length;++n)for(let s=0;s<r[n].length;++s)xa(e,r[n][s]);return e}function mc(r,e,n){if(Vu(r)||Vu(e))return NaN;let s=0,l=0;return r[2]<e[0]&&(s=e[0]-r[2]),r[0]>e[2]&&(s=r[0]-e[2]),r[1]>e[3]&&(l=r[1]-e[3]),r[3]<e[1]&&(l=e[1]-r[3]),n.distance([0,0],[s,l])}function Ob(r){return 360*r-180}function kb(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function Ed(r,e){let n=Math.pow(2,e.z),s=(r.y/at+e.y)/n;return[Ob((r.x/at+e.x)/n),kb(s)]}function Fb(r,e){let n=[];for(let s=0;s<r.length;++s)n.push(Ed(r[s],e));return n}function yi(r,e,n){let s=n.pointOnLine(e,r).point;return n.distance(r,s)}function Z_(r,e,n,s,l){let f=n.slice(s[0],s[1]+1),p=1/0;for(let y=e[0];y<=e[1];++y)if((p=Math.min(p,yi(r[y],f,l)))===0)return 0;return p}function Kp(r,e,n,s,l){let f=Math.min(l.pointToSegmentDistance(r,n,s),l.pointToSegmentDistance(e,n,s)),p=Math.min(l.pointToSegmentDistance(n,r,e),l.pointToSegmentDistance(s,r,e));return Math.min(f,p)}function Nb(r,e,n,s,l){if(!ms(e,r.length)||!ms(s,n.length))return NaN;let f=1/0;for(let p=e[0];p<e[1];++p)for(let y=s[0];y<s[1];++y){if(yd(r[p],r[p+1],n[y],n[y+1]))return 0;f=Math.min(f,Kp(r[p],r[p+1],n[y],n[y+1],l))}return f}function zb(r,e,n,s,l){if(!ms(e,r.length)||!ms(s,n.length))return NaN;let f=1/0;for(let p=e[0];p<=e[1];++p)for(let y=s[0];y<=s[1];++y)if((f=Math.min(f,l.distance(r[p],n[y])))===0)return f;return f}function Bb(r,e,n){if(uc(r,e,!0))return 0;let s=1/0;for(let l of e){let f=l.length;if(f<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(l[0]!==l[f-1]&&(s=Math.min(s,n.pointToSegmentDistance(r,l[f-1],l[0])))===0||(s=Math.min(s,yi(r,l,n)))===0)return s}return s}function Vb(r,e,n,s){if(!ms(e,r.length))return NaN;for(let f=e[0];f<=e[1];++f)if(uc(r[f],n,!0))return 0;let l=1/0;for(let f=e[0];f<e[1];++f)for(let p of n)for(let y=0,x=p.length,b=x-1;y<x;b=y++){if(yd(r[f],r[f+1],p[b],p[y]))return 0;l=Math.min(l,Kp(r[f],r[f+1],p[b],p[y],s))}return l}function X_(r,e){for(let n of r)for(let s=0;s<=n.length-1;++s)if(uc(n[s],e,!0))return!0;return!1}function jb(r,e,n,s=1/0){let l=un(r),f=un(e);if(s!==1/0&&mc(l,f,n)>=s)return s;if(cc(l,f)){if(X_(r,e))return 0}else if(X_(e,r))return 0;let p=s;for(let y of r)for(let x=0,b=y.length,I=b-1;x<b;I=x++)for(let S of e)for(let D=0,R=S.length,L=R-1;D<R;L=D++){if(yd(y[I],y[x],S[L],S[D]))return 0;p=Math.min(p,Kp(y[I],y[x],S[L],S[D],n))}return p}function Td(r,e,n,s,l,f,p){if(f===null||p===null)return;let y=mc(No(s,f),No(l,p),n);y<e&&r.push({dist:y,range1:f,range2:p})}function Ub(r,e,n,s,l=1/0){let f=Math.min(s.distance(r[0],n[0][0]),l);if(f===0)return f;let p=new bd([{dist:0,range1:[0,r.length-1],range2:[0,0]}],Yp),y=e?pc:fc,x=un(n);for(;p.length;){let b=p.pop();if(b.dist>=f)continue;let I=b.range1;if(ju(I)<=y){if(!ms(I,r.length))return NaN;if(e){let S=Vb(r,I,n,s);if((f=Math.min(f,S))===0)return f}else for(let S=I[0];S<=I[1];++S){let D=Bb(r[S],n,s);if((f=Math.min(f,D))===0)return f}}else{let S=wd(I,e);if(S[0]!==null){let D=mc(No(r,S[0]),x,s);D<f&&p.push({dist:D,range1:S[0],range2:[0,0]})}if(S[1]!==null){let D=mc(No(r,S[1]),x,s);D<f&&p.push({dist:D,range1:S[1],range2:[0,0]})}}}return f}function Y_(r,e,n,s,l,f=1/0){let p=Math.min(f,l.distance(r[0],n[0]));if(p===0)return p;let y=new bd([{dist:0,range1:[0,r.length-1],range2:[0,n.length-1]}],Yp),x=e?pc:fc,b=s?pc:fc;for(;y.length;){let I=y.pop();if(I.dist>=p)continue;let S=I.range1,D=I.range2;if(ju(S)<=x&&ju(D)<=b){if(!ms(S,r.length)||!ms(D,n.length))return NaN;if(e&&s?p=Math.min(p,Nb(r,S,n,D,l)):e||s?e&&!s?p=Math.min(p,Z_(n,D,r,S,l)):!e&&s&&(p=Math.min(p,Z_(r,S,n,D,l))):p=Math.min(p,zb(r,S,n,D,l)),p===0)return p}else{let R=wd(S,e),L=wd(D,s);Td(y,p,l,r,n,R[0],L[0]),Td(y,p,l,r,n,R[0],L[1]),Td(y,p,l,r,n,R[1],L[0]),Td(y,p,l,r,n,R[1],L[1])}}return p}function Jp(r,e,n,s,l=1/0){let f=l,p=No(r,[0,r.length-1]);for(let y of n)if(!(f!==1/0&&mc(p,No(y,[0,y.length-1]),s)>=f)&&(f=Math.min(f,Y_(r,e,y,!0,s,f)),f===0))return f;return f}function Id(r,e,n,s,l=1/0){let f=l,p=No(r,[0,r.length-1]);for(let y of n){if(f!==1/0&&mc(p,un(y),s)>=f)continue;let x=Ub(r,e,y,s,f);if(isNaN(x))return x;if((f=Math.min(f,x))===0)return f}return f}function Qp(r){return r==="Point"||r==="MultiPoint"||r==="LineString"||r==="MultiLineString"||r==="Polygon"||r==="MultiPolygon"}class gl{constructor(e,n){this.type=Tt,this.geojson=e,this.geometries=n}static parse(e,n){if(e.length!==2)return n.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(en(e[1])){let s=e[1];if(s.type==="FeatureCollection"){for(let l=0;l<s.features.length;++l)if(Qp(s.features[l].geometry.type))return new gl(s,s.features[l].geometry)}else if(s.type==="Feature"){if(Qp(s.geometry.type))return new gl(s,s.geometry)}else if(Qp(s.type))return new gl(s,s)}return n.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){let n=e.geometry(),s=e.canonicalID();if(n!=null&&s!=null){if(e.geometryType()==="Point")return function(l,f,p){let y=[];for(let b of l)for(let I of b)y.push(Ed(I,f));let x=new dc(y[0][1],"meters");return p.type==="Point"||p.type==="MultiPoint"||p.type==="LineString"?Y_(y,!1,p.type==="Point"?[p.coordinates]:p.coordinates,p.type==="LineString",x):p.type==="MultiLineString"?Jp(y,!1,p.coordinates,x):p.type==="Polygon"||p.type==="MultiPolygon"?Id(y,!1,p.type==="Polygon"?[p.coordinates]:p.coordinates,x):null}(n,s,this.geometries);if(e.geometryType()==="LineString")return function(l,f,p){let y=[];for(let b of l){let I=[];for(let S of b)I.push(Ed(S,f));y.push(I)}let x=new dc(y[0][0][1],"meters");if(p.type==="Point"||p.type==="MultiPoint"||p.type==="LineString")return Jp(p.type==="Point"?[p.coordinates]:p.coordinates,p.type==="LineString",y,x);if(p.type==="MultiLineString"){let b=1/0;for(let I=0;I<p.coordinates.length;I++){let S=Jp(p.coordinates[I],!0,y,x,b);if(isNaN(S))return S;if((b=Math.min(b,S))===0)return b}return b}if(p.type==="Polygon"||p.type==="MultiPolygon"){let b=1/0;for(let I=0;I<y.length;I++){let S=Id(y[I],!0,p.type==="Polygon"?[p.coordinates]:p.coordinates,x,b);if(isNaN(S))return S;if((b=Math.min(b,S))===0)return b}return b}return null}(n,s,this.geometries);if(e.geometryType()==="Polygon")return function(l,f,p){let y=[];for(let b of function(I,S){let D=I.length;if(D<=1)return[I];let R=[],L,F;for(let V=0;V<D;V++){let $=Rb(I[V]);$!==0&&(I[V].area=Math.abs($),F===void 0&&(F=$<0),F===$<0?(L&&R.push(L),L=[I[V]]):L.push(I[V]))}return L&&R.push(L),R}(l)){let I=[];for(let S=0;S<b.length;++S)I.push(Fb(b[S],f));y.push(I)}let x=new dc(y[0][0][0][1],"meters");if(p.type==="Point"||p.type==="MultiPoint"||p.type==="LineString")return Id(p.type==="Point"?[p.coordinates]:p.coordinates,p.type==="LineString",y,x);if(p.type==="MultiLineString"){let b=1/0;for(let I=0;I<p.coordinates.length;I++){let S=Id(p.coordinates[I],!0,y,x,b);if(isNaN(S))return S;if((b=Math.min(b,S))===0)return b}return b}return p.type==="Polygon"||p.type==="MultiPolygon"?function(b,I,S){let D=1/0;for(let R of b)for(let L of I){let F=jb(R,L,S,D);if(isNaN(F))return F;if((D=Math.min(D,F))===0)return D}return D}(p.type==="Polygon"?[p.coordinates]:p.coordinates,y,x):null}(n,s,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function gc(r){if(r instanceof or&&(r.name==="get"&&r.args.length===1||r.name==="feature-state"||r.name==="has"&&r.args.length===1||r.name==="properties"||r.name==="geometry-type"||r.name==="id"||/^filter-/.test(r.name))||r instanceof Tr||r instanceof gl)return!1;if(r instanceof yc)return r.featureConstant;let e=!0;return r.eachChild(n=>{e&&!gc(n)&&(e=!1)}),e}function Sd(r){if(r instanceof or&&r.name==="feature-state")return!1;let e=!0;return r.eachChild(n=>{e&&!Sd(n)&&(e=!1)}),e}function Dd(r){if(r instanceof yc)return new Set([r.key]);let e=new Set;return r.eachChild(n=>{e=new Set([...e,...Dd(n)])}),e}function _c(r,e){if(r instanceof or&&e.indexOf(r.name)>=0)return!1;let n=!0;return r.eachChild(s=>{n&&!_c(s,e)&&(n=!1)}),n}function K_(r,e,n){return[r,e,n].filter(Boolean).join("")}function em(r,e){switch(r){case"string":return ko(e);case"number":return+e;case"boolean":return!!e;case"color":return In.parse(e);case"formatted":return Nr.fromString(ko(e));case"resolvedImage":return Yr.build(ko(e))}return e}function J_(r,e,n,s){return s!==void 0&&(r=s*Math.round(r/s)),e!==void 0&&r<e&&(r=e),n!==void 0&&r>n&&(r=n),r}class yc{constructor(e,n,s,l=!1){this.type=e,this.key=n,this.scope=s,this.featureConstant=l}static parse(e,n){let s=n.expectedType;if(s==null&&(s=Sn),e.length<2||e.length>3)return n.error("Invalid number of arguments for 'config' expression.");let l=n.parse(e[1],1);if(!(l instanceof Bt))return n.error("Key name of 'config' expression must be a string literal.");let f,p=!0,y=ko(l.value);if(e.length>=3){let x=n.parse(e[2],2);if(!(x instanceof Bt))return n.error("Scope of 'config' expression must be a string literal.");f=ko(x.value)}if(n.options){let x=K_(y,f,n._scope),b=n.options.get(x);b&&(p=gc(b.value||b.default))}return new yc(s,y,f,p)}evaluate(e){let n=K_(this.key,this.scope,e.scope),s=e.getConfig(n);if(!s)return null;let{type:l,value:f,values:p,minValue:y,maxValue:x,stepValue:b}=s,I=s.default.evaluate(e),S=I;if(f){let D=e.scope;e.scope=(D||"").split("").slice(1).join(""),S=f.evaluate(e),e.scope=D}return l&&(S=em(l,S)),S===void 0||y===void 0&&x===void 0&&b===void 0||(typeof S=="number"?S=J_(S,y,x,b):Array.isArray(S)&&(S=S.map(D=>typeof D=="number"?J_(D,y,x,b):D))),f!==void 0&&S!==void 0&&p&&!p.includes(S)&&(S=I,l&&(S=em(l,S))),(l&&l!==this.type||S!==void 0&&!gd(ft(S),this.type))&&(S=em(this.type.kind,S)),S}eachChild(){}outputDefined(){return!1}serialize(){let e=["config",this.key];return this.scope&&e.concat(this.scope),e}}class Cd{constructor(e,n){this.type=n.type,this.name=e,this.boundExpression=n}static parse(e,n){if(e.length!==2||typeof e[1]!="string")return n.error("'var' expression requires exactly one string literal argument.");let s=e[1];return n.scope.has(s)?new Cd(s,n.scope.get(s)):n.error(`Unknown variable "${s}". Make sure "${s}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Md{constructor(e,n=[],s,l=new jp,f=[],p,y){this.registry=e,this.path=n,this.key=n.map(x=>typeof x=="string"?`['${x}']`:`[${x}]`).join(""),this.scope=l,this.errors=f,this.expectedType=s,this._scope=p,this.options=y}parse(e,n,s,l,f={}){return n||s?this.concat(n,null,s,l)._parse(e,f):this._parse(e,f)}parseObjectValue(e,n,s,l,f,p={}){return this.concat(n,s,l,f)._parse(e,p)}_parse(e,n){function s(l,f,p){return p==="assert"?new Pt(f,[l]):p==="coerce"?new Fo(f,[l]):l}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');let l=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(l){let f=l.parse(e,this);if(!f)return null;if(this.expectedType){let p=this.expectedType,y=f.type;if(p.kind!=="string"&&p.kind!=="number"&&p.kind!=="boolean"&&p.kind!=="object"&&p.kind!=="array"||y.kind!=="value")if(p.kind!=="color"&&p.kind!=="formatted"&&p.kind!=="resolvedImage"||y.kind!=="value"&&y.kind!=="string"){if(this.checkSubtype(p,y))return null}else f=s(f,p,n.typeAnnotation||"coerce");else f=s(f,p,n.typeAnnotation||"assert")}if(!(f instanceof Bt)&&f.type.kind!=="resolvedImage"&&tm(f)){let p=new Nu(this._scope,this.options);try{f=new Bt(f.type,f.evaluate(p))}catch(y){return this.error(y.message),null}}return f}return Fo.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,n,s,l){let f=typeof e=="number"?this.path.concat(e):this.path;f=typeof n=="string"?f.concat(n):f;let p=l?this.scope.concat(l):this.scope;return new Md(this.registry,f,s||null,p,this.errors,this._scope,this.options)}error(e,...n){let s=`${this.key}${n.map(l=>`[${l}]`).join("")}`;this.errors.push(new xo(s,e))}checkSubtype(e,n){let s=sc(e,n);return s&&this.error(s),s}}function tm(r){if(r instanceof Cd)return tm(r.boundExpression);if(r instanceof or&&r.name==="error"||r instanceof ps||r instanceof Tr||r instanceof gl||r instanceof yc)return!1;let e=r instanceof Fo||r instanceof Pt,n=!0;return r.eachChild(s=>{n=e?n&&tm(s):n&&s instanceof Bt}),!!n&&gc(r)&&_c(r,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Ad(r,e){let n=r.length-1,s,l,f=0,p=n,y=0;for(;f<=p;)if(y=Math.floor((f+p)/2),s=r[y],l=r[y+1],s<=e){if(y===n||e<l)return y;f=y+1}else{if(!(s>e))throw new Hi("Input is not a number.");p=y-1}return 0}class Uu{constructor(e,n,s){this.type=e,this.input=n,this.labels=[],this.outputs=[];for(let[l,f]of s)this.labels.push(l),this.outputs.push(f)}static parse(e,n){if(e.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return n.error("Expected an even number of arguments.");let s=n.parse(e[1],1,Tt);if(!s)return null;let l=[],f=null;n.expectedType&&n.expectedType.kind!=="value"&&(f=n.expectedType);for(let p=1;p<e.length;p+=2){let y=p===1?-1/0:e[p],x=e[p+1],b=p,I=p+1;if(typeof y!="number")return n.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',b);if(l.length&&l[l.length-1][0]>=y)return n.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',b);let S=n.parse(x,I,f);if(!S)return null;f=f||S.type,l.push([y,S])}return new Uu(f,s,l)}evaluate(e){let n=this.labels,s=this.outputs;if(n.length===1)return s[0].evaluate(e);let l=this.input.evaluate(e);if(l<=n[0])return s[0].evaluate(e);let f=n.length;return l>=n[f-1]?s[f-1].evaluate(e):s[Ad(n,l)].evaluate(e)}eachChild(e){e(this.input);for(let n of this.outputs)e(n)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e=["step",this.input.serialize()];for(let n=0;n<this.labels.length;n++)n>0&&e.push(this.labels[n]),e.push(this.outputs[n].serialize());return e}}let Q_=.95047,ey=1.08883,ty=4/29,ba=6/29,ny=3*ba*ba,iy=ba*ba*ba,Hb=Math.PI/180,$b=180/Math.PI;function nm(r){return r>iy?Math.pow(r,1/3):r/ny+ty}function Rd(r){return r>ba?r*r*r:ny*(r-ty)}function Pd(r){return 255*(r<=.0031308?12.92*r:1.055*Math.pow(r,1/2.4)-.055)}function wa(r){return(r/=255)<=.04045?r/12.92:Math.pow((r+.055)/1.055,2.4)}function im(r){let e=wa(r.r),n=wa(r.g),s=wa(r.b),l=nm((.4124564*e+.3575761*n+.1804375*s)/Q_),f=nm((.2126729*e+.7151522*n+.072175*s)/1);return{l:116*f-16,a:500*(l-f),b:200*(f-nm((.0193339*e+.119192*n+.9503041*s)/ey)),alpha:r.a}}function rm(r){let e=(r.l+16)/116,n=isNaN(r.a)?e:e+r.a/500,s=isNaN(r.b)?e:e-r.b/200;return e=1*Rd(e),n=Q_*Rd(n),s=ey*Rd(s),new In(Pd(3.2404542*n-1.5371385*e-.4985314*s),Pd(-.969266*n+1.8760108*e+.041556*s),Pd(.0556434*n-.2040259*e+1.0572252*s),r.alpha)}function Gb(r,e,n){let s=e-r;return r+n*(s>180||s<-180?s-360*Math.round(s/360):s)}let _l={forward:im,reverse:rm,interpolate:function(r,e,n){return{l:kt(r.l,e.l,n),a:kt(r.a,e.a,n),b:kt(r.b,e.b,n),alpha:kt(r.alpha,e.alpha,n)}}},yl={forward:function(r){let{l:e,a:n,b:s}=im(r),l=Math.atan2(s,n)*$b;return{h:l<0?l+360:l,c:Math.sqrt(n*n+s*s),l:e,alpha:r.a}},reverse:function(r){let e=r.h*Hb,n=r.c;return rm({l:r.l,a:Math.cos(e)*n,b:Math.sin(e)*n,alpha:r.alpha})},interpolate:function(r,e,n){return{h:Gb(r.h,e.h,n),c:kt(r.c,e.c,n),l:kt(r.l,e.l,n),alpha:kt(r.alpha,e.alpha,n)}}};var ry=Object.freeze({__proto__:null,hcl:yl,lab:_l});class wo{constructor(e,n,s,l,f){this.type=e,this.operator=n,this.interpolation=s,this.input=l,this.labels=[],this.outputs=[];for(let[p,y]of f)this.labels.push(p),this.outputs.push(y)}static interpolationFactor(e,n,s,l){let f=0;if(e.name==="exponential")f=Ld(n,e.base,s,l);else if(e.name==="linear")f=Ld(n,1,s,l);else if(e.name==="cubic-bezier"){let p=e.controlPoints;f=new rd(p[0],p[1],p[2],p[3]).solve(Ld(n,1,s,l))}return f}static parse(e,n){let[s,l,f,...p]=e;if(!Array.isArray(l)||l.length===0)return n.error("Expected an interpolation type expression.",1);if(l[0]==="linear")l={name:"linear"};else if(l[0]==="exponential"){let b=l[1];if(typeof b!="number")return n.error("Exponential interpolation requires a numeric base.",1,1);l={name:"exponential",base:b}}else{if(l[0]!=="cubic-bezier")return n.error(`Unknown interpolation type ${String(l[0])}`,1,0);{let b=l.slice(1);if(b.length!==4||b.some(I=>typeof I!="number"||I<0||I>1))return n.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);l={name:"cubic-bezier",controlPoints:b}}}if(e.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return n.error("Expected an even number of arguments.");if(f=n.parse(f,2,Tt),!f)return null;let y=[],x=null;s==="interpolate-hcl"||s==="interpolate-lab"?x=ao:n.expectedType&&n.expectedType.kind!=="value"&&(x=n.expectedType);for(let b=0;b<p.length;b+=2){let I=p[b],S=p[b+1],D=b+3,R=b+4;if(typeof I!="number")return n.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',D);if(y.length&&y[y.length-1][0]>=I)return n.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',D);let L=n.parse(S,R,x);if(!L)return null;x=x||L.type,y.push([I,L])}return x.kind==="number"||x.kind==="color"||x.kind==="array"&&x.itemType.kind==="number"&&typeof x.N=="number"?new wo(x,s,l,f,y):n.error(`Type ${Wi(x)} is not interpolatable.`)}evaluate(e){let n=this.labels,s=this.outputs;if(n.length===1)return s[0].evaluate(e);let l=this.input.evaluate(e);if(l<=n[0])return s[0].evaluate(e);let f=n.length;if(l>=n[f-1])return s[f-1].evaluate(e);let p=Ad(n,l),y=wo.interpolationFactor(this.interpolation,l,n[p],n[p+1]),x=s[p].evaluate(e),b=s[p+1].evaluate(e);return this.operator==="interpolate"?Ru[this.type.kind.toLowerCase()](x,b,y):this.operator==="interpolate-hcl"?yl.reverse(yl.interpolate(yl.forward(x),yl.forward(b),y)):_l.reverse(_l.interpolate(_l.forward(x),_l.forward(b),y))}eachChild(e){e(this.input);for(let n of this.outputs)e(n)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];let n=[this.operator,e,this.input.serialize()];for(let s=0;s<this.labels.length;s++)n.push(this.labels[s],this.outputs[s].serialize());return n}}function Ld(r,e,n,s){let l=s-n,f=r-n;return l===0?0:e===1?f/l:(Math.pow(e,f)-1)/(Math.pow(e,l)-1)}class Hu{constructor(e,n){this.type=e,this.args=n}static parse(e,n){if(e.length<2)return n.error("Expectected at least one argument.");let s=null,l=n.expectedType;l&&l.kind!=="value"&&(s=l);let f=[];for(let y of e.slice(1)){let x=n.parse(y,1+f.length,s,void 0,{typeAnnotation:"omit"});if(!x)return null;s=s||x.type,f.push(x)}let p=l&&f.some(y=>sc(l,y.type));return new Hu(p?Sn:s,f)}evaluate(e){let n,s=null,l=0;for(let f of this.args){if(l++,s=f.evaluate(e),s&&s instanceof Yr&&!s.available&&(n||(n=s),s=null,l===this.args.length))return n;if(s!==null)break}return s}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){let e=["coalesce"];return this.eachChild(n=>{e.push(n.serialize())}),e}}class Od{constructor(e,n){this.type=n.type,this.bindings=[].concat(e),this.result=n}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(let n of this.bindings)e(n[1]);e(this.result)}static parse(e,n){if(e.length<4)return n.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);let s=[];for(let f=1;f<e.length-1;f+=2){let p=e[f];if(typeof p!="string")return n.error(`Expected string, but found ${typeof p} instead.`,f);if(/[^a-zA-Z0-9_]/.test(p))return n.error("Variable names must contain only alphanumeric characters or '_'.",f);let y=n.parse(e[f+1],f+1);if(!y)return null;s.push([p,y])}let l=n.parse(e[e.length-1],e.length-1,n.expectedType,s);return l?new Od(s,l):null}outputDefined(){return this.result.outputDefined()}serialize(){let e=["let"];for(let[n,s]of this.bindings)e.push(n,s.serialize());return e.push(this.result.serialize()),e}}class om{constructor(e,n,s){this.type=e,this.index=n,this.input=s}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=n.parse(e[1],1,Tt),l=n.parse(e[2],2,Fr(n.expectedType||Sn));return s&&l?new om(l.type.itemType,s,l):null}evaluate(e){let n=this.index.evaluate(e),s=this.input.evaluate(e);if(n<0)throw new Hi(`Array index out of bounds: ${n} < 0.`);if(n>=s.length)throw new Hi(`Array index out of bounds: ${n} > ${s.length-1}.`);if(n!==Math.floor(n))throw new Hi(`Array index must be an integer, but found ${n} instead. Use at-interpolated to retrieve interpolated result with a fractional index.`);return s[n]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class sm{constructor(e,n,s){this.type=e,this.index=n,this.input=s}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=n.parse(e[1],1,Tt),l=n.parse(e[2],2,Fr(n.expectedType||Sn));return s&&l?new sm(l.type.itemType,s,l):null}evaluate(e){let n=this.index.evaluate(e),s=this.input.evaluate(e);if(n<0)throw new Hi(`Array index out of bounds: ${n} < 0.`);if(n>s.length-1)throw new Hi(`Array index out of bounds: ${n} > ${s.length-1}.`);if(n===Math.floor(n))return s[n];let l=Math.floor(n),f=Math.ceil(n),p=s[l],y=s[f];if(typeof p!="number"||typeof y!="number")throw new Hi(`Cannot interpolate between non-number values at index ${n}.`);let x=n-l;return p*(1-x)+y*x}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class kd{constructor(e,n){this.type=bn,this.needle=e,this.haystack=n}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=n.parse(e[1],1,Sn),l=n.parse(e[2],2,Sn);return s&&l?ya(s.type,[bn,On,Tt,oc,Sn])?new kd(s,l):n.error(`Expected first argument to be of type boolean, string, number or null, but found ${Wi(s.type)} instead`):null}evaluate(e){let n=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(s==null)return!1;if(!Ou(n,["boolean","string","number","null"]))throw new Hi(`Expected first argument to be of type boolean, string, number or null, but found ${Wi(ft(n))} instead.`);if(!Ou(s,["string","array"]))throw new Hi(`Expected second argument to be of type array or string, but found ${Wi(ft(s))} instead.`);return s.indexOf(n)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class $u{constructor(e,n,s){this.type=Tt,this.needle=e,this.haystack=n,this.fromIndex=s}static parse(e,n){if(e.length<=2||e.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);let s=n.parse(e[1],1,Sn),l=n.parse(e[2],2,Sn);if(!s||!l)return null;if(!ya(s.type,[bn,On,Tt,oc,Sn]))return n.error(`Expected first argument to be of type boolean, string, number or null, but found ${Wi(s.type)} instead`);if(e.length===4){let f=n.parse(e[3],3,Tt);return f?new $u(s,l,f):null}return new $u(s,l)}evaluate(e){let n=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(!Ou(n,["boolean","string","number","null"]))throw new Hi(`Expected first argument to be of type boolean, string, number or null, but found ${Wi(ft(n))} instead.`);if(!Ou(s,["string","array"]))throw new Hi(`Expected second argument to be of type array or string, but found ${Wi(ft(s))} instead.`);if(this.fromIndex){let l=this.fromIndex.evaluate(e);return s.indexOf(n,l)}return s.indexOf(n)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){let e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class vc{constructor(e,n,s,l,f,p){this.inputType=e,this.type=n,this.input=s,this.cases=l,this.outputs=f,this.otherwise=p}static parse(e,n){if(e.length<5)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return n.error("Expected an even number of arguments.");let s,l;n.expectedType&&n.expectedType.kind!=="value"&&(l=n.expectedType);let f={},p=[];for(let b=2;b<e.length-1;b+=2){let I=e[b],S=e[b+1];Array.isArray(I)||(I=[I]);let D=n.concat(b);if(I.length===0)return D.error("Expected at least one branch label.");for(let L of I){if(typeof L!="number"&&typeof L!="string")return D.error("Branch labels must be numbers or strings.");if(typeof L=="number"&&Math.abs(L)>Number.MAX_SAFE_INTEGER)return D.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof L=="number"&&Math.floor(L)!==L)return D.error("Numeric branch labels must be integer values.");if(s){if(D.checkSubtype(s,ft(L)))return null}else s=ft(L);if(f[String(L)]!==void 0)return D.error("Branch labels must be unique.");f[String(L)]=p.length}let R=n.parse(S,b,l);if(!R)return null;l=l||R.type,p.push(R)}let y=n.parse(e[1],1,Sn);if(!y)return null;let x=n.parse(e[e.length-1],e.length-1,l);return x?y.type.kind!=="value"&&n.concat(1).checkSubtype(s,y.type)?null:new vc(s,l,y,f,p,x):null}evaluate(e){let n=this.input.evaluate(e);return(gd(ft(n),this.inputType)&&this.outputs[this.cases[n]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){let e=["match",this.input.serialize()],n=Object.keys(this.cases).sort(),s=[],l={};for(let p of n){let y=l[this.cases[p]];y===void 0?(l[this.cases[p]]=s.length,s.push([this.cases[p],[p]])):s[y][1].push(p)}let f=p=>this.inputType.kind==="number"?Number(p):p;for(let[p,y]of s)e.push(y.length===1?f(y[0]):y.map(f)),e.push(this.outputs[p].serialize());return e.push(this.otherwise.serialize()),e}}class am{constructor(e,n,s){this.type=e,this.branches=n,this.otherwise=s}static parse(e,n){if(e.length<4)return n.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return n.error("Expected an odd number of arguments.");let s;n.expectedType&&n.expectedType.kind!=="value"&&(s=n.expectedType);let l=[];for(let p=1;p<e.length-1;p+=2){let y=n.parse(e[p],p,bn);if(!y)return null;let x=n.parse(e[p+1],p+1,s);if(!x)return null;l.push([y,x]),s=s||x.type}let f=n.parse(e[e.length-1],e.length-1,s);return f?new am(s,l,f):null}evaluate(e){for(let[n,s]of this.branches)if(n.evaluate(e))return s.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(let[n,s]of this.branches)e(n),e(s);e(this.otherwise)}outputDefined(){return this.branches.every(([e,n])=>n.outputDefined())&&this.otherwise.outputDefined()}serialize(){let e=["case"];return this.eachChild(n=>{e.push(n.serialize())}),e}}class Gu{constructor(e,n,s,l){this.type=e,this.input=n,this.beginIndex=s,this.endIndex=l}static parse(e,n){if(e.length<=2||e.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);let s=n.parse(e[1],1,Sn),l=n.parse(e[2],2,Tt);if(!s||!l)return null;if(!ya(s.type,[Fr(Sn),On,Sn]))return n.error(`Expected first argument to be of type array or string, but found ${Wi(s.type)} instead`);if(e.length===4){let f=n.parse(e[3],3,Tt);return f?new Gu(s.type,s,l,f):null}return new Gu(s.type,s,l)}evaluate(e){let n=this.input.evaluate(e),s=this.beginIndex.evaluate(e);if(!Ou(n,["string","array"]))throw new Hi(`Expected first argument to be of type array or string, but found ${Wi(ft(n))} instead.`);if(this.endIndex){let l=this.endIndex.evaluate(e);return n.slice(s,l)}return n.slice(s)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){let e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function oy(r,e){return r==="=="||r==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function sy(r,e,n,s){return s.compare(e,n)===0}function vl(r,e,n){let s=r!=="=="&&r!=="!=";return class yO{constructor(f,p,y){this.type=bn,this.lhs=f,this.rhs=p,this.collator=y,this.hasUntypedArgument=f.type.kind==="value"||p.type.kind==="value"}static parse(f,p){if(f.length!==3&&f.length!==4)return p.error("Expected two or three arguments.");let y=f[0],x=p.parse(f[1],1,Sn);if(!x)return null;if(!oy(y,x.type))return p.concat(1).error(`"${y}" comparisons are not supported for type '${Wi(x.type)}'.`);let b=p.parse(f[2],2,Sn);if(!b)return null;if(!oy(y,b.type))return p.concat(2).error(`"${y}" comparisons are not supported for type '${Wi(b.type)}'.`);if(x.type.kind!==b.type.kind&&x.type.kind!=="value"&&b.type.kind!=="value")return p.error(`Cannot compare types '${Wi(x.type)}' and '${Wi(b.type)}'.`);s&&(x.type.kind==="value"&&b.type.kind!=="value"?x=new Pt(b.type,[x]):x.type.kind!=="value"&&b.type.kind==="value"&&(b=new Pt(x.type,[b])));let I=null;if(f.length===4){if(x.type.kind!=="string"&&b.type.kind!=="string"&&x.type.kind!=="value"&&b.type.kind!=="value")return p.error("Cannot use collator to compare non-string types.");if(I=p.parse(f[3],3,md),!I)return null}return new yO(x,b,I)}evaluate(f){let p=this.lhs.evaluate(f),y=this.rhs.evaluate(f);if(s&&this.hasUntypedArgument){let x=ft(p),b=ft(y);if(x.kind!==b.kind||x.kind!=="string"&&x.kind!=="number")throw new Hi(`Expected arguments for "${r}" to be (string, string) or (number, number), but found (${x.kind}, ${b.kind}) instead.`)}if(this.collator&&!s&&this.hasUntypedArgument){let x=ft(p),b=ft(y);if(x.kind!=="string"||b.kind!=="string")return e(f,p,y)}return this.collator?n(f,p,y,this.collator.evaluate(f)):e(f,p,y)}eachChild(f){f(this.lhs),f(this.rhs),this.collator&&f(this.collator)}outputDefined(){return!0}serialize(){let f=[r];return this.eachChild(p=>{f.push(p.serialize())}),f}}}let ay=vl("==",function(r,e,n){return e===n},sy),qb=vl("!=",function(r,e,n){return e!==n},function(r,e,n,s){return!sy(0,e,n,s)}),Wb=vl("<",function(r,e,n){return e<n},function(r,e,n,s){return s.compare(e,n)<0}),Zb=vl(">",function(r,e,n){return e>n},function(r,e,n,s){return s.compare(e,n)>0}),Fd=vl("<=",function(r,e,n){return e<=n},function(r,e,n,s){return s.compare(e,n)<=0}),Xb=vl(">=",function(r,e,n){return e>=n},function(r,e,n,s){return s.compare(e,n)>=0});class Nd{constructor(e,n,s,l,f,p){this.type=On,this.number=e,this.locale=n,this.currency=s,this.unit=l,this.minFractionDigits=f,this.maxFractionDigits=p}static parse(e,n){if(e.length!==3)return n.error("Expected two arguments.");let s=n.parse(e[1],1,Tt);if(!s)return null;let l=e[2];if(typeof l!="object"||Array.isArray(l))return n.error("NumberFormat options argument must be an object.");let f=null;if(l.locale&&(f=n.parseObjectValue(l.locale,2,"locale",On),!f))return null;let p=null;if(l.currency&&(p=n.parseObjectValue(l.currency,2,"currency",On),!p))return null;let y=null;if(l.unit&&(y=n.parseObjectValue(l.unit,2,"unit",On),!y))return null;let x=null;if(l["min-fraction-digits"]&&(x=n.parseObjectValue(l["min-fraction-digits"],2,"min-fraction-digits",Tt),!x))return null;let b=null;return l["max-fraction-digits"]&&(b=n.parseObjectValue(l["max-fraction-digits"],2,"max-fraction-digits",Tt),!b)?null:new Nd(s,f,p,y,x,b)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){let e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class lm{constructor(e){this.type=Tt,this.input=e}static parse(e,n){if(e.length!==2)return n.error(`Expected 1 argument, but found ${e.length-1} instead.`);let s=n.parse(e[1],1);return s?s.type.kind!=="array"&&s.type.kind!=="string"&&s.type.kind!=="value"?n.error(`Expected argument of type string or array, but found ${Wi(s.type)} instead.`):new lm(s):null}evaluate(e){let n=this.input.evaluate(e);if(typeof n=="string"||Array.isArray(n))return n.length;throw new Hi(`Expected value to be of type string or array, but found ${Wi(ft(n))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){let e=["length"];return this.eachChild(n=>{e.push(n.serialize())}),e}}function ly(r){return function(){r=1831565813+(r|=0)|0;let e=Math.imul(r^r>>>15,1|r);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}let xl={"==":ay,"!=":qb,">":Zb,"<":Wb,">=":Xb,"<=":Fd,array:Pt,at:om,"at-interpolated":sm,boolean:Pt,case:am,coalesce:Hu,collator:ps,format:ac,image:lc,in:kd,"index-of":$u,interpolate:wo,"interpolate-hcl":wo,"interpolate-lab":wo,length:lm,let:Od,literal:Bt,match:vc,number:Pt,"number-format":Nd,object:Pt,slice:Gu,step:Uu,string:Pt,"to-boolean":Fo,"to-color":Fo,"to-number":Fo,"to-string":Fo,var:Cd,within:Tr,distance:gl,config:yc};function cm(r,[e,n,s,l]){e=e.evaluate(r),n=n.evaluate(r),s=s.evaluate(r);let f=l?l.evaluate(r):1,p=fl(e,n,s,f);if(p)throw new Hi(p);return new In(e/255,n/255,s/255,f)}function um(r,[e,n,s,l]){e=e.evaluate(r),n=n.evaluate(r),s=s.evaluate(r);let f=l?l.evaluate(r):1,p=function(b,I,S,D){return typeof b=="number"&&b>=0&&b<=360?typeof I=="number"&&I>=0&&I<=100&&typeof S=="number"&&S>=0&&S<=100?D===void 0||typeof D=="number"&&D>=0&&D<=1?null:`Invalid hsla value [${[b,I,S,D].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof D=="number"?[b,I,S,D]:[b,I,S]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof D=="number"?[b,I,S,D]:[b,I,S]).join(", ")}]: 'h' must be between 0 and 360.`}(e,n,s,f);if(p)throw new Hi(p);let y=`hsla(${e}, ${n}%, ${s}%, ${f})`,x=In.parse(y);if(!x)throw new Hi(`Failed to parse HSLA color: ${y}`);return x}function cy(r,e){return r in e}function Ea(r,e){let n=e[r];return n===void 0?null:n}function bl(r){return{type:r}}function uy(r){return{result:"success",value:r}}function Ta(r){return{result:"error",value:r}}function zd(r,e){return!!r&&!!r.parameters&&r.parameters.indexOf(e)>-1}function qu(r){return r["property-type"]==="data-driven"}function hm(r){return zd(r.expression,"measure-light")}function dm(r){return zd(r.expression,"zoom")}function Wu(r){return!!r.expression&&r.expression.interpolated}function Zu(r){return typeof r=="object"&&r!==null&&!Array.isArray(r)}function hy(r){return r}function dy(r,e){let n=e.type==="color",s=r.stops&&typeof r.stops[0][0]=="object",l=s||!(s||r.property!==void 0),f=r.type||(Wu(e)?"exponential":"interval");if(n&&((r=dl({},r)).stops&&(r.stops=r.stops.map(b=>[b[0],In.parse(b[1])])),r.default=In.parse(r.default?r.default:e.default)),r.colorSpace&&r.colorSpace!=="rgb"&&!ry[r.colorSpace])throw new Error(`Unknown color space: ${r.colorSpace}`);let p,y,x;if(f==="exponential")p=fm;else if(f==="interval")p=Kb;else if(f==="categorical"){p=Yb,y=Object.create(null);for(let b of r.stops)y[b[0]]=b[1];x=typeof r.stops[0][0]}else{if(f!=="identity")throw new Error(`Unknown function type "${f}"`);p=Jb}if(s){let b={},I=[];for(let R=0;R<r.stops.length;R++){let L=r.stops[R],F=L[0].zoom;b[F]===void 0&&(b[F]={zoom:F,type:r.type,property:r.property,default:r.default,stops:[]},I.push(F)),b[F].stops.push([L[0].value,L[1]])}let S=[];for(let R of I)S.push([b[R].zoom,dy(b[R],e)]);let D={name:"linear"};return{kind:"composite",interpolationType:D,interpolationFactor:wo.interpolationFactor.bind(void 0,D),zoomStops:S.map(R=>R[0]),evaluate:({zoom:R},L)=>fm({stops:S,base:r.base},e,R).evaluate(R,L)}}if(l){let b=f==="exponential"?{name:"exponential",base:r.base!==void 0?r.base:1}:null;return{kind:"camera",interpolationType:b,interpolationFactor:wo.interpolationFactor.bind(void 0,b),zoomStops:r.stops.map(I=>I[0]),evaluate:({zoom:I})=>p(r,e,I,y,x)}}return{kind:"source",evaluate(b,I){let S=I&&I.properties?I.properties[r.property]:void 0;return S===void 0?xc(r.default,e.default):p(r,e,S,y,x)}}}function xc(r,e,n){return r!==void 0?r:e!==void 0?e:n!==void 0?n:void 0}function Yb(r,e,n,s,l){return xc(typeof n===l?s[n]:void 0,r.default,e.default)}function Kb(r,e,n){if(va(n)!=="number")return xc(r.default,e.default);let s=r.stops.length;if(s===1||n<=r.stops[0][0])return r.stops[0][1];if(n>=r.stops[s-1][0])return r.stops[s-1][1];let l=Ad(r.stops.map(f=>f[0]),n);return r.stops[l][1]}function fm(r,e,n){let s=r.base!==void 0?r.base:1;if(va(n)!=="number")return xc(r.default,e.default);let l=r.stops.length;if(l===1||n<=r.stops[0][0])return r.stops[0][1];if(n>=r.stops[l-1][0])return r.stops[l-1][1];let f=Ad(r.stops.map(I=>I[0]),n),p=function(I,S,D,R){let L=R-D,F=I-D;return L===0?0:S===1?F/L:(Math.pow(S,F)-1)/(Math.pow(S,L)-1)}(n,s,r.stops[f][0],r.stops[f+1][0]),y=r.stops[f][1],x=r.stops[f+1][1],b=Ru[e.type]||hy;if(r.colorSpace&&r.colorSpace!=="rgb"){let I=ry[r.colorSpace];b=(S,D)=>I.reverse(I.interpolate(I.forward(S),I.forward(D),p))}return typeof y.evaluate=="function"?{evaluate(...I){let S=y.evaluate.apply(void 0,I),D=x.evaluate.apply(void 0,I);if(S!==void 0&&D!==void 0)return b(S,D,p)}}:b(y,x,p)}function Jb(r,e,n){return e.type==="color"?n=In.parse(n):e.type==="formatted"?n=Nr.fromString(n.toString()):e.type==="resolvedImage"?n=Yr.build(n.toString()):va(n)===e.type||e.type==="enum"&&e.values[n]||(n=void 0),xc(n,r.default,e.default)}or.register(xl,{error:[{kind:"error"},[On],(r,[e])=>{throw new Hi(e.evaluate(r))}],typeof:[On,[Sn],(r,[e])=>Wi(ft(e.evaluate(r)))],"to-rgba":[Fr(Tt,4),[ao],(r,[e])=>e.evaluate(r).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[Fr(Tt,4),[ao],(r,[e])=>e.evaluate(r).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[ao,[Tt,Tt,Tt],cm],rgba:[ao,[Tt,Tt,Tt,Tt],cm],hsl:[ao,[Tt,Tt,Tt],um],hsla:[ao,[Tt,Tt,Tt,Tt],um],has:{type:bn,overloads:[[[On],(r,[e])=>cy(e.evaluate(r),r.properties())],[[On,Ns],(r,[e,n])=>cy(e.evaluate(r),n.evaluate(r))]]},get:{type:Sn,overloads:[[[On],(r,[e])=>Ea(e.evaluate(r),r.properties())],[[On,Ns],(r,[e,n])=>Ea(e.evaluate(r),n.evaluate(r))]]},"feature-state":[Sn,[On],(r,[e])=>Ea(e.evaluate(r),r.featureState||{})],properties:[Ns,[],r=>r.properties()],"geometry-type":[On,[],r=>r.geometryType()],worldview:[On,[],r=>r.globals.worldview||""],id:[Sn,[],r=>r.id()],zoom:[Tt,[],r=>r.globals.zoom],pitch:[Tt,[],r=>r.globals.pitch||0],"distance-from-center":[Tt,[],r=>r.distanceFromCenter()],"measure-light":[Tt,[On],(r,[e])=>r.measureLight(e.evaluate(r))],"heatmap-density":[Tt,[],r=>r.globals.heatmapDensity||0],"line-progress":[Tt,[],r=>r.globals.lineProgress||0],"raster-value":[Tt,[],r=>r.globals.rasterValue||0],"raster-particle-speed":[Tt,[],r=>r.globals.rasterParticleSpeed||0],"sky-radial-progress":[Tt,[],r=>r.globals.skyRadialProgress||0],accumulated:[Sn,[],r=>r.globals.accumulated===void 0?null:r.globals.accumulated],"+":[Tt,bl(Tt),(r,e)=>{let n=0;for(let s of e)n+=s.evaluate(r);return n}],"*":[Tt,bl(Tt),(r,e)=>{let n=1;for(let s of e)n*=s.evaluate(r);return n}],"-":{type:Tt,overloads:[[[Tt,Tt],(r,[e,n])=>e.evaluate(r)-n.evaluate(r)],[[Tt],(r,[e])=>-e.evaluate(r)]]},"/":[Tt,[Tt,Tt],(r,[e,n])=>e.evaluate(r)/n.evaluate(r)],"%":[Tt,[Tt,Tt],(r,[e,n])=>e.evaluate(r)%n.evaluate(r)],ln2:[Tt,[],()=>Math.LN2],pi:[Tt,[],()=>Math.PI],e:[Tt,[],()=>Math.E],"^":[Tt,[Tt,Tt],(r,[e,n])=>Math.pow(e.evaluate(r),n.evaluate(r))],sqrt:[Tt,[Tt],(r,[e])=>Math.sqrt(e.evaluate(r))],log10:[Tt,[Tt],(r,[e])=>Math.log(e.evaluate(r))/Math.LN10],ln:[Tt,[Tt],(r,[e])=>Math.log(e.evaluate(r))],log2:[Tt,[Tt],(r,[e])=>Math.log(e.evaluate(r))/Math.LN2],sin:[Tt,[Tt],(r,[e])=>Math.sin(e.evaluate(r))],cos:[Tt,[Tt],(r,[e])=>Math.cos(e.evaluate(r))],tan:[Tt,[Tt],(r,[e])=>Math.tan(e.evaluate(r))],asin:[Tt,[Tt],(r,[e])=>Math.asin(e.evaluate(r))],acos:[Tt,[Tt],(r,[e])=>Math.acos(e.evaluate(r))],atan:[Tt,[Tt],(r,[e])=>Math.atan(e.evaluate(r))],min:[Tt,bl(Tt),(r,e)=>Math.min(...e.map(n=>n.evaluate(r)))],max:[Tt,bl(Tt),(r,e)=>Math.max(...e.map(n=>n.evaluate(r)))],abs:[Tt,[Tt],(r,[e])=>Math.abs(e.evaluate(r))],round:[Tt,[Tt],(r,[e])=>{let n=e.evaluate(r);return n<0?-Math.round(-n):Math.round(n)}],floor:[Tt,[Tt],(r,[e])=>Math.floor(e.evaluate(r))],ceil:[Tt,[Tt],(r,[e])=>Math.ceil(e.evaluate(r))],"filter-==":[bn,[On,Sn],(r,[e,n])=>r.properties()[e.value]===n.value],"filter-id-==":[bn,[Sn],(r,[e])=>r.id()===e.value],"filter-type-==":[bn,[On],(r,[e])=>r.geometryType()===e.value],"filter-<":[bn,[On,Sn],(r,[e,n])=>{let s=r.properties()[e.value],l=n.value;return typeof s==typeof l&&s<l}],"filter-id-<":[bn,[Sn],(r,[e])=>{let n=r.id(),s=e.value;return typeof n==typeof s&&n<s}],"filter->":[bn,[On,Sn],(r,[e,n])=>{let s=r.properties()[e.value],l=n.value;return typeof s==typeof l&&s>l}],"filter-id->":[bn,[Sn],(r,[e])=>{let n=r.id(),s=e.value;return typeof n==typeof s&&n>s}],"filter-<=":[bn,[On,Sn],(r,[e,n])=>{let s=r.properties()[e.value],l=n.value;return typeof s==typeof l&&s<=l}],"filter-id-<=":[bn,[Sn],(r,[e])=>{let n=r.id(),s=e.value;return typeof n==typeof s&&n<=s}],"filter->=":[bn,[On,Sn],(r,[e,n])=>{let s=r.properties()[e.value],l=n.value;return typeof s==typeof l&&s>=l}],"filter-id->=":[bn,[Sn],(r,[e])=>{let n=r.id(),s=e.value;return typeof n==typeof s&&n>=s}],"filter-has":[bn,[Sn],(r,[e])=>e.value in r.properties()],"filter-has-id":[bn,[],r=>r.id()!==null&&r.id()!==void 0],"filter-type-in":[bn,[Fr(On)],(r,[e])=>e.value.indexOf(r.geometryType())>=0],"filter-id-in":[bn,[Fr(Sn)],(r,[e])=>e.value.indexOf(r.id())>=0],"filter-in-small":[bn,[On,Fr(Sn)],(r,[e,n])=>n.value.indexOf(r.properties()[e.value])>=0],"filter-in-large":[bn,[On,Fr(Sn)],(r,[e,n])=>function(s,l,f,p){for(;f<=p;){let y=f+p>>1;if(l[y]===s)return!0;l[y]>s?p=y-1:f=y+1}return!1}(r.properties()[e.value],n.value,0,n.value.length-1)],all:{type:bn,overloads:[[[bn,bn],(r,[e,n])=>e.evaluate(r)&&n.evaluate(r)],[bl(bn),(r,e)=>{for(let n of e)if(!n.evaluate(r))return!1;return!0}]]},any:{type:bn,overloads:[[[bn,bn],(r,[e,n])=>e.evaluate(r)||n.evaluate(r)],[bl(bn),(r,e)=>{for(let n of e)if(n.evaluate(r))return!0;return!1}]]},"!":[bn,[bn],(r,[e])=>!e.evaluate(r)],"is-supported-script":[bn,[On],(r,[e])=>{let n=r.globals&&r.globals.isSupportedScript;return!n||n(e.evaluate(r))}],upcase:[On,[On],(r,[e])=>e.evaluate(r).toUpperCase()],downcase:[On,[On],(r,[e])=>e.evaluate(r).toLowerCase()],concat:[On,bl(Sn),(r,e)=>e.map(n=>ko(n.evaluate(r))).join("")],"resolved-locale":[On,[md],(r,[e])=>e.evaluate(r).resolvedLocale()],random:[Tt,[Tt,Tt,Sn],(r,e)=>{let[n,s,l]=e.map(p=>p.evaluate(r));if(n>s||n===s)return n;let f;if(typeof l=="string")f=function(p){let y=0;if(p.length===0)return y;for(let x=0;x<p.length;x++)y=(y<<5)-y+p.charCodeAt(x),y|=0;return y}(l);else{if(typeof l!="number")throw new Hi(`Invalid seed input: ${l}`);f=l}return n+ly(f)()*(s-n)}]});class bc{constructor(e,n,s,l){this.expression=e,this._warningHistory={},this._evaluator=new Nu(s,l),this._defaultValue=n?function(f){return f.type==="color"&&(Zu(f.default)||Array.isArray(f.default))?new In(0,0,0,0):f.type==="color"?In.parse(f.default)||null:f.default===void 0?null:f.default}(n):null,this._enumValues=n&&n.type==="enum"?n.values:null,this.configDependencies=Dd(e)}evaluateWithoutErrorHandling(e,n,s,l,f,p,y,x){return this._evaluator.globals=e,this._evaluator.feature=n,this._evaluator.featureState=s,this._evaluator.canonical=l||null,this._evaluator.availableImages=f||null,this._evaluator.formattedSection=p,this._evaluator.featureTileCoord=y||null,this._evaluator.featureDistanceData=x||null,this.expression.evaluate(this._evaluator)}evaluate(e,n,s,l,f,p,y,x){this._evaluator.globals=e,this._evaluator.feature=n||null,this._evaluator.featureState=s||null,this._evaluator.canonical=l||null,this._evaluator.availableImages=f||null,this._evaluator.formattedSection=p||null,this._evaluator.featureTileCoord=y||null,this._evaluator.featureDistanceData=x||null;try{let b=this.expression.evaluate(this._evaluator);if(b==null||typeof b=="number"&&b!=b)return this._defaultValue;if(this._enumValues&&!(b in this._enumValues))throw new Hi(`Expected value to be one of ${Object.keys(this._enumValues).map(I=>JSON.stringify(I)).join(", ")}, but found ${JSON.stringify(b)} instead.`);return b}catch(b){return this._warningHistory[b.message]||(this._warningHistory[b.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${b.message}`)),this._defaultValue}}}function Bd(r){return Array.isArray(r)&&r.length>0&&typeof r[0]=="string"&&r[0]in xl}function Vs(r,e,n,s){let l=new Md(xl,[],e?function(p){let y={color:ao,string:On,number:Tt,enum:On,boolean:bn,formatted:Pu,resolvedImage:Lu};return p.type==="array"?Fr(y[p.value]||Sn,p.length):y[p.type]}(e):void 0,void 0,void 0,n,s),f=l.parse(r,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return f?uy(new bc(f,e,n,s)):Ta(l.errors)}class Xu{constructor(e,n,s,l){this.kind=e,this._styleExpression=n,this.isLightConstant=s,this.isLineProgressConstant=l,this.isStateDependent=e!=="constant"&&!Sd(n.expression),this.configDependencies=Dd(n.expression)}evaluateWithoutErrorHandling(e,n,s,l,f,p){return this._styleExpression.evaluateWithoutErrorHandling(e,n,s,l,f,p)}evaluate(e,n,s,l,f,p){return this._styleExpression.evaluate(e,n,s,l,f,p)}}class Yu{constructor(e,n,s,l,f,p){this.kind=e,this.zoomStops=s,this._styleExpression=n,this.isStateDependent=e!=="camera"&&!Sd(n.expression),this.isLightConstant=f,this.isLineProgressConstant=p,this.configDependencies=Dd(n.expression),this.interpolationType=l}evaluateWithoutErrorHandling(e,n,s,l,f,p){return this._styleExpression.evaluateWithoutErrorHandling(e,n,s,l,f,p)}evaluate(e,n,s,l,f,p){return this._styleExpression.evaluate(e,n,s,l,f,p)}interpolationFactor(e,n,s){return this.interpolationType?wo.interpolationFactor(this.interpolationType,e,n,s):0}}function fy(r,e,n,s){if((r=Vs(r,e,n,s)).result==="error")return r;let l=r.value.expression,f=gc(l);if(!f&&!qu(e))return Ta([new xo("","data expressions not supported")]);let p=_c(l,["zoom","pitch","distance-from-center"]);if(!p&&!dm(e))return Ta([new xo("","zoom expressions not supported")]);let y=_c(l,["measure-light"]);if(!y&&!hm(e))return Ta([new xo("","measure-light expression not supported")]);let x=_c(l,["line-progress"]);if(!x&&!function(S){return zd(S.expression,"line-progress")}(e))return Ta([new xo("","line-progress expression not supported")]);let b=e.expression&&e.expression.relaxZoomRestriction,I=Ec(l);return I||p||b?I instanceof xo?Ta([I]):I instanceof wo&&!Wu(e)?Ta([new xo("",'"interpolate" expressions cannot be used with this property')]):uy(I?new Yu(f&&x?"camera":"composite",r.value,I.labels,I instanceof wo?I.interpolation:void 0,y,x):new Xu(f&&x?"constant":"source",r.value,y,x)):Ta([new xo("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class wc{constructor(e,n){this._parameters=e,this._specification=n,dl(this,dy(this._parameters,this._specification))}static deserialize(e){return new wc(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Ec(r){let e=null;if(r instanceof Od)e=Ec(r.result);else if(r instanceof Hu){for(let n of r.args)if(e=Ec(n),e)break}else(r instanceof Uu||r instanceof wo)&&r.input instanceof or&&r.input.name==="zoom"&&(e=r);return e instanceof xo||r.eachChild(n=>{let s=Ec(n);s instanceof xo?e=s:e&&s&&e!==s&&(e=new xo("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}var Vd,pm,mm=function(){if(pm)return Vd;pm=1,Vd=e;var r=3;function e(n,s,l){var f=this.cells=[];if(n instanceof ArrayBuffer){this.arrayBuffer=n;var p=new Int32Array(this.arrayBuffer);n=p[0],this.d=(s=p[1])+2*(l=p[2]);for(var y=0;y<this.d*this.d;y++){var x=p[r+y],b=p[r+y+1];f.push(x===b?null:p.subarray(x,b))}var I=p[r+f.length+1];this.keys=p.subarray(p[r+f.length],I),this.bboxes=p.subarray(I),this.insert=this._insertReadonly}else{this.d=s+2*l;for(var S=0;S<this.d*this.d;S++)f.push([]);this.keys=[],this.bboxes=[]}this.n=s,this.extent=n,this.padding=l,this.scale=s/n,this.uid=0;var D=l/s*n;this.min=-D,this.max=n+D}return e.prototype.insert=function(n,s,l,f,p){this._forEachCell(s,l,f,p,this._insertCell,this.uid++),this.keys.push(n),this.bboxes.push(s),this.bboxes.push(l),this.bboxes.push(f),this.bboxes.push(p)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(n,s,l,f,p,y){this.cells[p].push(y)},e.prototype.query=function(n,s,l,f,p){var y=this.min,x=this.max;if(n<=y&&s<=y&&x<=l&&x<=f&&!p)return Array.prototype.slice.call(this.keys);var b=[];return this._forEachCell(n,s,l,f,this._queryCell,b,{},p),b},e.prototype._queryCell=function(n,s,l,f,p,y,x,b){var I=this.cells[p];if(I!==null)for(var S=this.keys,D=this.bboxes,R=0;R<I.length;R++){var L=I[R];if(x[L]===void 0){var F=4*L;(b?b(D[F+0],D[F+1],D[F+2],D[F+3]):n<=D[F+2]&&s<=D[F+3]&&l>=D[F+0]&&f>=D[F+1])?(x[L]=!0,y.push(S[L])):x[L]=!1}}},e.prototype._forEachCell=function(n,s,l,f,p,y,x,b){for(var I=this._convertToCellCoord(n),S=this._convertToCellCoord(s),D=this._convertToCellCoord(l),R=this._convertToCellCoord(f),L=I;L<=D;L++)for(var F=S;F<=R;F++){var V=this.d*F+L;if((!b||b(this._convertFromCellCoord(L),this._convertFromCellCoord(F),this._convertFromCellCoord(L+1),this._convertFromCellCoord(F+1)))&&p.call(this,n,s,l,f,V,y,x,b))return}},e.prototype._convertFromCellCoord=function(n){return(n-this.padding)/this.scale},e.prototype._convertToCellCoord=function(n){return Math.max(0,Math.min(this.d-1,Math.floor(n*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var n=this.cells,s=r+this.cells.length+1+1,l=0,f=0;f<this.cells.length;f++)l+=this.cells[f].length;var p=new Int32Array(s+l+this.keys.length+this.bboxes.length);p[0]=this.extent,p[1]=this.n,p[2]=this.padding;for(var y=s,x=0;x<n.length;x++){var b=n[x];p[r+x]=y,p.set(b,y),y+=b.length}return p[r+n.length]=y,p.set(this.keys,y),p[r+n.length+1]=y+=this.keys.length,p.set(this.bboxes,y),y+=this.bboxes.length,p.buffer},Vd}(),js=ma(mm);let Us={};function pt(r,e,n={}){Object.defineProperty(r,"_classRegistryKey",{value:e,writable:!1}),Us[e]={klass:r,omit:n.omit||[]}}pt(Object,"Object"),js.serialize=function(r,e){let n=r.toArrayBuffer();return e&&e.add(n),{buffer:n}},js.deserialize=function(r){return new js(r.buffer)},Object.defineProperty(js,"name",{value:"Grid"}),pt(js,"Grid"),typeof DOMMatrix<"u"&&pt(DOMMatrix,"DOMMatrix"),pt(In,"Color"),pt(Error,"Error"),pt(Nr,"Formatted"),pt(_d,"FormattedSection"),pt(pn,"AJAXError"),pt(Yr,"ResolvedImage"),pt(wc,"StylePropertyFunction"),pt(bc,"StyleExpression",{omit:["_evaluator"]}),pt(so,"ImageId"),pt(zs,"ImageVariant"),pt(Yu,"ZoomDependentExpression"),pt(Xu,"ZoomConstantExpression"),pt(or,"CompoundExpression",{omit:["_evaluate"]});for(let r in xl)Us[xl[r]._classRegistryKey]||pt(xl[r],`Expression${r}`);function py(r){return r&&typeof ArrayBuffer<"u"&&(r instanceof ArrayBuffer||r.constructor&&r.constructor.name==="ArrayBuffer")}function my(r){return self.ImageBitmap&&r instanceof ImageBitmap}function Ia(r,e){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp)return r;if(py(r)||my(r))return e&&e.add(r),r;if(ArrayBuffer.isView(r))return e&&e.add(r.buffer),r;if(r instanceof ImageData)return e&&e.add(r.data.buffer),r;if(Array.isArray(r)){let n=[];for(let s of r)n.push(Ia(s,e));return n}if(r instanceof Map){let n={$name:"Map",entries:[]};for(let[s,l]of r.entries())n.entries.push(Ia(s),Ia(l,e));return n}if(r instanceof Set){let n={$name:"Set"},s=0;for(let l of r.values())n[++s]=Ia(l);return n}if(r instanceof DOMMatrix){let n={$name:"DOMMatrix"},s=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(let l of s)n[l]=r[l];return n}if(typeof r=="bigint")return{$name:"BigInt",value:r.toString()};if(typeof r=="object"){let n=r.constructor,s=n._classRegistryKey;if(!s)throw new Error(`Can't serialize object of unregistered class "${n.name}".`);let l=n.serialize?n.serialize(r,e):{};if(!n.serialize){for(let f in r)r.hasOwnProperty(f)&&(Us[s].omit.indexOf(f)>=0||(l[f]=Ia(r[f],e)));r instanceof Error&&(l.message=r.message)}if(l.$name)throw new Error("$name property is reserved for worker serialization logic.");return s!=="Object"&&(l.$name=s),l}throw new Error("can't serialize object of type "+typeof r)}function Sa(r){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp||py(r)||my(r)||ArrayBuffer.isView(r)||r instanceof ImageData)return r;if(Array.isArray(r))return r.map(Sa);if(typeof r=="object"){let e=r.$name||"Object";if(e==="Map"){let l=r.entries||[],f=new Map;for(let p=0;p<l.length;p+=2)f.set(Sa(l[p]),Sa(l[p+1]));return f}if(e==="Set"){let l=new Set;for(let f of Object.keys(r))f!=="$name"&&l.add(Sa(r[f]));return l}if(e==="DOMMatrix"){let l;return l=r.is2D?[r.a,r.b,r.c,r.d,r.e,r.f]:[r.m11,r.m12,r.m13,r.m14,r.m21,r.m22,r.m23,r.m24,r.m31,r.m32,r.m33,r.m34,r.m41,r.m42,r.m43,r.m44],new DOMMatrix(l)}if(e==="BigInt")return BigInt(r.value);let{klass:n}=Us[e];if(!n)throw new Error(`Can't deserialize unregistered class "${e}".`);if(n.deserialize)return n.deserialize(r);let s=Object.create(n.prototype);for(let l of Object.keys(r))l!=="$name"&&(s[l]=Sa(r[l]));return s}throw new Error("can't deserialize object of type "+typeof r)}let Mt={"Latin-1 Supplement":r=>r>=128&&r<=255,Arabic:r=>r>=1536&&r<=1791,"Arabic Supplement":r=>r>=1872&&r<=1919,"Arabic Extended-A":r=>r>=2208&&r<=2303,"Hangul Jamo":r=>r>=4352&&r<=4607,"Unified Canadian Aboriginal Syllabics":r=>r>=5120&&r<=5759,Khmer:r=>r>=6016&&r<=6143,"Unified Canadian Aboriginal Syllabics Extended":r=>r>=6320&&r<=6399,"General Punctuation":r=>r>=8192&&r<=8303,"Letterlike Symbols":r=>r>=8448&&r<=8527,"Number Forms":r=>r>=8528&&r<=8591,"Miscellaneous Technical":r=>r>=8960&&r<=9215,"Control Pictures":r=>r>=9216&&r<=9279,"Optical Character Recognition":r=>r>=9280&&r<=9311,"Enclosed Alphanumerics":r=>r>=9312&&r<=9471,"Geometric Shapes":r=>r>=9632&&r<=9727,"Miscellaneous Symbols":r=>r>=9728&&r<=9983,"Miscellaneous Symbols and Arrows":r=>r>=11008&&r<=11263,"CJK Radicals Supplement":r=>r>=11904&&r<=12031,"Kangxi Radicals":r=>r>=12032&&r<=12255,"Ideographic Description Characters":r=>r>=12272&&r<=12287,"CJK Symbols and Punctuation":r=>r>=12288&&r<=12351,Hiragana:r=>r>=12352&&r<=12447,Katakana:r=>r>=12448&&r<=12543,Bopomofo:r=>r>=12544&&r<=12591,"Hangul Compatibility Jamo":r=>r>=12592&&r<=12687,Kanbun:r=>r>=12688&&r<=12703,"Bopomofo Extended":r=>r>=12704&&r<=12735,"CJK Strokes":r=>r>=12736&&r<=12783,"Katakana Phonetic Extensions":r=>r>=12784&&r<=12799,"Enclosed CJK Letters and Months":r=>r>=12800&&r<=13055,"CJK Compatibility":r=>r>=13056&&r<=13311,"CJK Unified Ideographs Extension A":r=>r>=13312&&r<=19903,"Yijing Hexagram Symbols":r=>r>=19904&&r<=19967,"CJK Unified Ideographs":r=>r>=19968&&r<=40959,"Yi Syllables":r=>r>=40960&&r<=42127,"Yi Radicals":r=>r>=42128&&r<=42191,"Hangul Jamo Extended-A":r=>r>=43360&&r<=43391,"Hangul Syllables":r=>r>=44032&&r<=55215,"Hangul Jamo Extended-B":r=>r>=55216&&r<=55295,"Private Use Area":r=>r>=57344&&r<=63743,"CJK Compatibility Ideographs":r=>r>=63744&&r<=64255,"Arabic Presentation Forms-A":r=>r>=64336&&r<=65023,"Vertical Forms":r=>r>=65040&&r<=65055,"CJK Compatibility Forms":r=>r>=65072&&r<=65103,"Small Form Variants":r=>r>=65104&&r<=65135,"Arabic Presentation Forms-B":r=>r>=65136&&r<=65279,"Halfwidth and Fullwidth Forms":r=>r>=65280&&r<=65519,Osage:r=>r>=66736&&r<=66815,"CJK Unified Ideographs Extension B":r=>r>=131072&&r<=173791};function Ku(r){for(let e of r)if(gm(e.charCodeAt(0)))return!0;return!1}function Qb(r){for(let e of r)if(!e1(e.charCodeAt(0)))return!1;return!0}function e1(r){return!(Mt.Arabic(r)||Mt["Arabic Supplement"](r)||Mt["Arabic Extended-A"](r)||Mt["Arabic Presentation Forms-A"](r)||Mt["Arabic Presentation Forms-B"](r))}function gm(r){return!(r!==746&&r!==747&&(r<4352||!(Mt["Bopomofo Extended"](r)||Mt.Bopomofo(r)||Mt["CJK Compatibility Forms"](r)&&!(r>=65097&&r<=65103)||Mt["CJK Compatibility Ideographs"](r)||Mt["CJK Compatibility"](r)||Mt["CJK Radicals Supplement"](r)||Mt["CJK Strokes"](r)||!(!Mt["CJK Symbols and Punctuation"](r)||r>=12296&&r<=12305||r>=12308&&r<=12319||r===12336)||Mt["CJK Unified Ideographs Extension A"](r)||Mt["CJK Unified Ideographs"](r)||Mt["Enclosed CJK Letters and Months"](r)||Mt["Hangul Compatibility Jamo"](r)||Mt["Hangul Jamo Extended-A"](r)||Mt["Hangul Jamo Extended-B"](r)||Mt["Hangul Jamo"](r)||Mt["Hangul Syllables"](r)||Mt.Hiragana(r)||Mt["Ideographic Description Characters"](r)||Mt.Kanbun(r)||Mt["Kangxi Radicals"](r)||Mt["Katakana Phonetic Extensions"](r)||Mt.Katakana(r)&&r!==12540||!(!Mt["Halfwidth and Fullwidth Forms"](r)||r===65288||r===65289||r===65293||r>=65306&&r<=65310||r===65339||r===65341||r===65343||r>=65371&&r<=65503||r===65507||r>=65512&&r<=65519)||!(!Mt["Small Form Variants"](r)||r>=65112&&r<=65118||r>=65123&&r<=65126)||Mt["Unified Canadian Aboriginal Syllabics"](r)||Mt["Unified Canadian Aboriginal Syllabics Extended"](r)||Mt["Vertical Forms"](r)||Mt["Yijing Hexagram Symbols"](r)||Mt["Yi Syllables"](r)||Mt["Yi Radicals"](r))))}function gy(r){return!(gm(r)||function(e){return!!(Mt["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||Mt["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||Mt["Letterlike Symbols"](e)||Mt["Number Forms"](e)||Mt["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||Mt["Control Pictures"](e)&&e!==9251||Mt["Optical Character Recognition"](e)||Mt["Enclosed Alphanumerics"](e)||Mt["Geometric Shapes"](e)||Mt["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Mt["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Mt["CJK Symbols and Punctuation"](e)||Mt.Katakana(e)||Mt["Private Use Area"](e)||Mt["CJK Compatibility Forms"](e)||Mt["Small Form Variants"](e)||Mt["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(r))}function t1(r){return Mt.Arabic(r)||Mt["Arabic Supplement"](r)||Mt["Arabic Extended-A"](r)||Mt["Arabic Presentation Forms-A"](r)||Mt["Arabic Presentation Forms-B"](r)}function _y(r){return r>=1424&&r<=2303||Mt["Arabic Presentation Forms-A"](r)||Mt["Arabic Presentation Forms-B"](r)}function n1(r,e){return!(!e&&_y(r)||r>=2304&&r<=3583||r>=3840&&r<=4255||Mt.Khmer(r))}function i1(r){for(let e of r)if(_y(e.charCodeAt(0)))return!0;return!1}let lo={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"},_m=null,Br=lo.unavailable,Hs=null,wl=function(r){r&&typeof r=="string"&&r.indexOf("NetworkError")>-1&&(Br=lo.error),_m&&_m(r)};function jd(){Ud.fire(new cl("pluginStateChange",{pluginStatus:Br,pluginURL:Hs}))}let Ud=new ul,Tc=function(){return Br},yy=function(){if(Br!==lo.deferred||!Hs)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Br=lo.loading,jd(),Hs&&Cu({url:Hs},r=>{r?wl(r):(Br=lo.loaded,jd())})},$s={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Br===lo.loaded||$s.applyArabicShaping!=null,isLoading:()=>Br===lo.loading,setState(r){Br=r.pluginStatus,Hs=r.pluginURL},isParsing:()=>Br===lo.parsing,isParsed:()=>Br===lo.parsed,getPluginURL:()=>Hs};class zn{constructor(e,n){this.zoom=e,n?(this.now=n.now,this.fadeDuration=n.fadeDuration,this.transition=n.transition,this.pitch=n.pitch,this.brightness=n.brightness,this.worldview=n.worldview):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(n,s){for(let l of n)if(!n1(l.charCodeAt(0),s))return!1;return!0}(e,$s.isLoaded())}}class Ju{constructor(e,n,s,l){this.property=e,this.value=n,this.expression=function(f,p,y,x){if(Zu(f))return new wc(f,p);if(Bd(f)||Array.isArray(f)&&f.length>0){let b=fy(f,p,y,x);if(b.result==="error")throw new Error(b.value.map(I=>`${I.key}: ${I.message}`).join(", "));return b.value}{let b=f;return typeof f=="string"&&p.type==="color"&&(b=In.parse(f)),{kind:"constant",configDependencies:new Set,evaluate:()=>b}}}(n===void 0?e.specification.default:n,e.specification,s,l)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,n,s){return this.property.possiblyEvaluate(this,e,n,s)}}class Da{constructor(e,n,s){this.property=e,this.value=new Ju(e,void 0,n,s)}transitioned(e,n){return new xy(this.property,this.value,n,Ce({},e.transition,this.transition),e.now)}untransitioned(){return new xy(this.property,this.value,null,{},0)}}class vy{constructor(e,n,s){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=n,this._options=s,this.configDependencies=new Set}getValue(e){return Vt(this._values[e].value.value)}setValue(e,n){this._values.hasOwnProperty(e)||(this._values[e]=new Da(this._values[e].property,this._scope,this._options)),this._values[e].value=new Ju(this._values[e].property,n===null?void 0:Vt(n),this._scope,this._options),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]))}setTransitionOrValue(e,n){n&&(this._options=n);let s=this._properties.properties;if(e)for(let l in e){let f=e[l];if(l.endsWith("-transition")){let p=l.slice(0,-11);s[p]&&this.setTransition(p,f)}else s.hasOwnProperty(l)&&this.setValue(l,f)}}getTransition(e){return Vt(this._values[e].transition)}setTransition(e,n){this._values.hasOwnProperty(e)||(this._values[e]=new Da(this._values[e].property)),this._values[e].transition=Vt(n)||void 0}serialize(){let e={};for(let n of Object.keys(this._values)){let s=this.getValue(n);s!==void 0&&(e[n]=s);let l=this.getTransition(n);l!==void 0&&(e[`${n}-transition`]=l)}return e}transitioned(e,n){let s=new by(this._properties);for(let l of Object.keys(this._values))s._values[l]=this._values[l].transitioned(e,n._values[l]);return s}untransitioned(){let e=new by(this._properties);for(let n of Object.keys(this._values))e._values[n]=this._values[n].untransitioned();return e}}class xy{constructor(e,n,s,l,f){let p=l.delay||0,y=l.duration||0;f=f||0,this.property=e,this.value=n,this.begin=f+p,this.end=this.begin+y,e.specification.transition&&(l.delay||l.duration)&&(this.prior=s)}possiblyEvaluate(e,n,s){let l=e.now||0,f=this.value.possiblyEvaluate(e,n,s),p=this.prior;if(p){if(l>this.end)return this.prior=null,f;if(this.value.isDataDriven())return this.prior=null,f;if(l<this.begin)return p.possiblyEvaluate(e,n,s);{let y=(l-this.begin)/(this.end-this.begin);return this.property.interpolate(p.possiblyEvaluate(e,n,s),f,X(y))}}return f}}class by{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,n,s){let l=new El(this._properties);for(let f of Object.keys(this._values))l._values[f]=this._values[f].possiblyEvaluate(e,n,s);return l}hasTransition(){for(let e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class r1{constructor(e,n,s){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=n,this._options=s,this.configDependencies=new Set}getValue(e){return Vt(this._values[e].value)}setValue(e,n){this._values[e]=new Ju(this._values[e].property,n===null?void 0:Vt(n),this._scope,this._options),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]))}serialize(){let e={};for(let n of Object.keys(this._values)){let s=this.getValue(n);s!==void 0&&(e[n]=s)}return e}possiblyEvaluate(e,n,s){let l=new El(this._properties);for(let f of Object.keys(this._values))l._values[f]=this._values[f].possiblyEvaluate(e,n,s);return l}}class Ic{constructor(e,n,s){this.property=e,this.value=n,this.parameters=s}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,n,s,l){return this.property.evaluate(this.value,this.parameters,e,n,s,l)}}class El{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class Ke{constructor(e){this.specification=e}possiblyEvaluate(e,n){return e.expression.evaluate(n)}interpolate(e,n,s){let l=Ru[this.specification.type];return l?l(e,n,s):e}}class ht{constructor(e,n){this.specification=e,this.overrides=n}possiblyEvaluate(e,n,s,l){return new Ic(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(n,null,{},s,l)}:e.expression,n)}interpolate(e,n,s){if(e.value.kind!=="constant"||n.value.kind!=="constant")return e;if(e.value.value===void 0||n.value.value===void 0)return new Ic(this,{kind:"constant",value:void 0},e.parameters);let l=Ru[this.specification.type];return l?new Ic(this,{kind:"constant",value:l(e.value.value,n.value.value,s)},e.parameters):e}evaluate(e,n,s,l,f,p){return e.kind==="constant"?e.value:e.evaluate(n,s,l,f,p)}}class Tl{constructor(e){this.specification=e}possiblyEvaluate(e,n,s,l){return!!e.expression.evaluate(n,null,{},s,l)}interpolate(){return!1}}class Ei{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];let n=new zn(0,{});for(let s in e){let l=e[s];l.specification.overridable&&this.overridableProperties.push(s);let f=this.defaultPropertyValues[s]=new Ju(l,void 0),p=this.defaultTransitionablePropertyValues[s]=new Da(l);this.defaultTransitioningPropertyValues[s]=p.untransitioned(),this.defaultPossiblyEvaluatedValues[s]=f.possiblyEvaluate(n)}}}pt(ht,"DataDrivenProperty"),pt(Ke,"DataConstantProperty"),pt(Tl,"ColorRampProperty");var Ee=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","expression":{}},"buildingFeaturesetId":{"type":"string","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-wall-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function Jo(r){return r instanceof Number||r instanceof String||r instanceof Boolean?r.valueOf():r}function Hd(r){if(Array.isArray(r))return r.map(Hd);if(r instanceof Object&&!(r instanceof Number||r instanceof String||r instanceof Boolean)){let e={};for(let n in r)e[n]=Hd(r[n]);return e}return Jo(r)}function $d(r){if(r===!0||r===!1)return!0;if(!Array.isArray(r)||r.length===0)return!1;switch(r[0]){case"has":return r.length>=2&&r[1]!=="$id"&&r[1]!=="$type";case"in":return r.length>=3&&(typeof r[1]!="string"||Array.isArray(r[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return r.length!==3||Array.isArray(r[1])||Array.isArray(r[2]);case"any":case"all":for(let e of r.slice(1))if(!$d(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function ym(r,e="",n=null,s="fill"){if(r==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};$d(r)||(r=Gd(r));let l=r,f=!0;try{f=function(I){if(!Sc(I))return I;let S=Hd(I);return Ey(S),S=wy(S),S}(l)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(l,null,2)}
        `)}let p=null,y=null;if(s!=="background"&&s!=="sky"&&s!=="slot"){y=Ee[`filter_${s}`];let I=Vs(f,y,e,n);if(I.result==="error")throw new Error(I.value.map(S=>`${S.key}: ${S.message}`).join(", "));p=(S,D,R)=>I.value.evaluate(S,D,{},R)}let x=null,b=null;if(f!==l){let I=Vs(l,y,e,n);if(I.result==="error")throw new Error(I.value.map(S=>`${S.key}: ${S.message}`).join(", "));x=(S,D,R,L,F)=>I.value.evaluate(S,D,{},R,void 0,void 0,L,F),b=!gc(I.value.expression)}return{filter:p,dynamicFilter:x||void 0,needGeometry:Ty(f),needFeature:!!b}}function wy(r){if(!Array.isArray(r))return r;let e=function(n){if(o1.has(n[0])){for(let s=1;s<n.length;s++)if(Sc(n[s]))return!0}return n}(r);return e===!0?e:e.map(n=>wy(n))}function Ey(r){let e=!1,n=[];if(r[0]==="case"){for(let s=1;s<r.length-1;s+=2)e=e||Sc(r[s]),n.push(r[s+1]);n.push(r[r.length-1])}else if(r[0]==="match"){e=e||Sc(r[1]);for(let s=2;s<r.length-1;s+=2)n.push(r[s+1]);n.push(r[r.length-1])}else if(r[0]==="step"){e=e||Sc(r[1]);for(let s=1;s<r.length-1;s+=2)n.push(r[s+1])}e&&(r.length=0,r.push("any",...n));for(let s=1;s<r.length;s++)Ey(r[s])}function Sc(r){if(!Array.isArray(r))return!1;if((e=r[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let n=1;n<r.length;n++)if(Sc(r[n]))return!0;return!1}let o1=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function s1(r,e){return r<e?-1:r>e?1:0}function Ty(r){if(!Array.isArray(r))return!1;if(r[0]==="within"||r[0]==="distance")return!0;for(let e=1;e<r.length;e++)if(Ty(r[e]))return!0;return!1}function Gd(r){if(!r)return!0;let e=r[0];return r.length<=1?e!=="any":e==="=="?vm(r[1],r[2],"=="):e==="!="?qd(vm(r[1],r[2],"==")):e==="<"||e===">"||e==="<="||e===">="?vm(r[1],r[2],e):e==="any"?(n=r.slice(1),["any"].concat(n.map(Gd))):e==="all"?["all"].concat(r.slice(1).map(Gd)):e==="none"?["all"].concat(r.slice(1).map(Gd).map(qd)):e==="in"?xm(r[1],r.slice(2)):e==="!in"?qd(xm(r[1],r.slice(2))):e==="has"?Iy(r[1]):e!=="!has"||qd(Iy(r[1]));var n}function vm(r,e,n){switch(r){case"$type":return[`filter-type-${n}`,e];case"$id":return[`filter-id-${n}`,e];default:return[`filter-${n}`,r,e]}}function xm(r,e){if(e.length===0)return!1;switch(r){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(n=>typeof n!=typeof e[0])?["filter-in-large",r,["literal",e.sort(s1)]]:["filter-in-small",r,["literal",e]]}}function Iy(r){switch(r){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",r]}}function qd(r){return["!",r]}let Qu="";function Il(r,e){return e?`${r}${Qu}${e}`:r}let bm="-transition",Ca=new Set(["fill","line","background","hillshade","raster"]);class Ir extends ul{constructor(e,n,s,l,f){if(super(),this.id=e.id,this.fqid=Il(this.id,s),this.type=e.type,this.scope=s,this.lut=l,this.options=f,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,e.type!=="custom"){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;let p=Vs(this.filter,Ee[`filter_${e.type}`]);p.result!=="error"&&(this.configDependencies=new Set([...this.configDependencies,...p.value.configDependencies]))}if(e.slot&&(this.slot=e.slot),n.layout&&(this._unevaluatedLayout=new r1(n.layout,this.scope,f),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),n.paint){this._transitionablePaint=new vy(n.paint,this.scope,f);for(let p in e.paint)this.setPaintProperty(p,e.paint[p]);for(let p in e.layout)this.setLayoutProperty(p,e.layout[p]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new El(n.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&Ca.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,n){if(this.type==="custom"&&e==="visibility")return void(this.visibility=n);let s=this._unevaluatedLayout;s._properties.properties[e]&&(s.setValue(e,n),this.configDependencies=new Set([...this.configDependencies,...s.configDependencies]),e==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith(bm)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,n){let s=this._transitionablePaint,l=s._properties.properties;if(e.endsWith(bm)){let S=e.slice(0,-11);return l[S]&&s.setTransition(S,n||void 0),!1}if(!l[e])return!1;let f=s._values[e],p=f.value.isDataDriven(),y=f.value;s.setValue(e,n),this.configDependencies=new Set([...this.configDependencies,...s.configDependencies]),this._handleSpecialPaintPropertyUpdate(e);let x=s._values[e].value,b=x.isDataDriven(),I=e.endsWith("pattern")||e==="line-dasharray";return b||p||I||this._handleOverridablePaintPropertyUpdate(e,y,x)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,n,s){return null}_handleOverridablePaintPropertyUpdate(e,n,s){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,n){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,n)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,n)}serialize(){return zt({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(e,n)=>!(e===void 0||n==="layout"&&!Object.keys(e).length||n==="paint"&&!Object.keys(e).length))}is3D(e){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(let e in this.paint._values){let n=this.paint.get(e);if(n instanceof Ic&&qu(n.property.specification)&&(n.value.kind==="source"||n.value.kind==="composite")&&n.value.isStateDependent)return!0}return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=ym(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(e){}queryIntersectsFeature(e,n,s,l,f,p,y,x,b){}}let a1={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class eh{constructor(e,n){this._structArray=e,this._pos1=n*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class ui{constructor(){this.capacity=-1,this.resize(0)}static serialize(e,n){return e._trim(),n&&n.add(e.arrayBuffer),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){let n=Object.create(this.prototype);return n.arrayBuffer=e.arrayBuffer,n.length=e.length,n.capacity=e.arrayBuffer.byteLength/n.bytesPerElement,n._refreshViews(),n}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);let n=this.uint8;this._refreshViews(),n&&this.uint8.set(n)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function mn(r,e=1){let n=0,s=0;return{members:r.map(l=>{let f=a1[l.type].BYTES_PER_ELEMENT,p=n=wm(n,Math.max(e,f)),y=l.components||1;return s=Math.max(s,f),n+=f*y,{name:l.name,type:l.type,components:y,offset:p}}),size:wm(n,Math.max(s,e)),alignment:e}}function wm(r,e){return Math.ceil(r/e)*e}class Gs extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n){let s=this.length;return this.resize(s+1),this.emplace(s,e,n)}emplace(e,n,s){let l=2*e;return this.int16[l+0]=n,this.int16[l+1]=s,e}}Gs.prototype.bytesPerElement=4,pt(Gs,"StructArrayLayout2i4");class th extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s){let l=this.length;return this.resize(l+1),this.emplace(l,e,n,s)}emplace(e,n,s,l){let f=3*e;return this.int16[f+0]=n,this.int16[f+1]=s,this.int16[f+2]=l,e}}th.prototype.bytesPerElement=6,pt(th,"StructArrayLayout3i6");class Dc extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s,l){let f=this.length;return this.resize(f+1),this.emplace(f,e,n,s,l)}emplace(e,n,s,l,f){let p=4*e;return this.int16[p+0]=n,this.int16[p+1]=s,this.int16[p+2]=l,this.int16[p+3]=f,e}}Dc.prototype.bytesPerElement=8,pt(Dc,"StructArrayLayout4i8");class Ma extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.float32[1*e+0]=n,e}}Ma.prototype.bytesPerElement=4,pt(Ma,"StructArrayLayout1f4");class Em extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s){let l=this.length;return this.resize(l+1),this.emplace(l,e,n,s)}emplace(e,n,s,l){let f=4*e,p=2*e;return this.int16[f+0]=n,this.int16[f+1]=s,this.float32[p+1]=l,e}}Em.prototype.bytesPerElement=8,pt(Em,"StructArrayLayout2i1f8");class Wd extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s){let l=this.length;return this.resize(l+1),this.emplace(l,e,n,s)}emplace(e,n,s,l){let f=4*e;return this.int16[f+0]=n,this.int16[f+1]=s,this.int16[f+2]=l,e}}Wd.prototype.bytesPerElement=8,pt(Wd,"StructArrayLayout3i8");class Cc extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f){let p=this.length;return this.resize(p+1),this.emplace(p,e,n,s,l,f)}emplace(e,n,s,l,f,p){let y=5*e;return this.int16[y+0]=n,this.int16[y+1]=s,this.int16[y+2]=l,this.int16[y+3]=f,this.int16[y+4]=p,e}}Cc.prototype.bytesPerElement=10,pt(Cc,"StructArrayLayout5i10");class Tm extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f,p,y){let x=this.length;return this.resize(x+1),this.emplace(x,e,n,s,l,f,p,y)}emplace(e,n,s,l,f,p,y,x){let b=6*e,I=12*e,S=3*e;return this.int16[b+0]=n,this.int16[b+1]=s,this.uint8[I+4]=l,this.uint8[I+5]=f,this.uint8[I+6]=p,this.uint8[I+7]=y,this.float32[S+2]=x,e}}Tm.prototype.bytesPerElement=12,pt(Tm,"StructArrayLayout2i4ub1f12");class gs extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s){let l=this.length;return this.resize(l+1),this.emplace(l,e,n,s)}emplace(e,n,s,l){let f=3*e;return this.float32[f+0]=n,this.float32[f+1]=s,this.float32[f+2]=l,e}}gs.prototype.bytesPerElement=12,pt(gs,"StructArrayLayout3f12");class Aa extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f){let p=this.length;return this.resize(p+1),this.emplace(p,e,n,s,l,f)}emplace(e,n,s,l,f,p){let y=6*e,x=3*e;return this.uint16[y+0]=n,this.uint16[y+1]=s,this.uint16[y+2]=l,this.uint16[y+3]=f,this.float32[x+2]=p,e}}Aa.prototype.bytesPerElement=12,pt(Aa,"StructArrayLayout4ui1f12");class nh extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,s,l){let f=this.length;return this.resize(f+1),this.emplace(f,e,n,s,l)}emplace(e,n,s,l,f){let p=4*e;return this.uint16[p+0]=n,this.uint16[p+1]=s,this.uint16[p+2]=l,this.uint16[p+3]=f,e}}nh.prototype.bytesPerElement=8,pt(nh,"StructArrayLayout4ui8");class Zd extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f,p){let y=this.length;return this.resize(y+1),this.emplace(y,e,n,s,l,f,p)}emplace(e,n,s,l,f,p,y){let x=6*e;return this.int16[x+0]=n,this.int16[x+1]=s,this.int16[x+2]=l,this.int16[x+3]=f,this.int16[x+4]=p,this.int16[x+5]=y,e}}Zd.prototype.bytesPerElement=12,pt(Zd,"StructArrayLayout6i12");class Mc extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f,p,y,x,b,I,S,D){let R=this.length;return this.resize(R+1),this.emplace(R,e,n,s,l,f,p,y,x,b,I,S,D)}emplace(e,n,s,l,f,p,y,x,b,I,S,D,R){let L=12*e;return this.int16[L+0]=n,this.int16[L+1]=s,this.int16[L+2]=l,this.int16[L+3]=f,this.uint16[L+4]=p,this.uint16[L+5]=y,this.uint16[L+6]=x,this.uint16[L+7]=b,this.int16[L+8]=I,this.int16[L+9]=S,this.int16[L+10]=D,this.int16[L+11]=R,e}}Mc.prototype.bytesPerElement=24,pt(Mc,"StructArrayLayout4i4ui4i24");class Ac extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f,p){let y=this.length;return this.resize(y+1),this.emplace(y,e,n,s,l,f,p)}emplace(e,n,s,l,f,p,y){let x=10*e,b=5*e;return this.int16[x+0]=n,this.int16[x+1]=s,this.int16[x+2]=l,this.float32[b+2]=f,this.float32[b+3]=p,this.float32[b+4]=y,e}}Ac.prototype.bytesPerElement=20,pt(Ac,"StructArrayLayout3i3f20");class lr extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,l){let f=this.length;return this.resize(f+1),this.emplace(f,e,n,s,l)}emplace(e,n,s,l,f){let p=4*e;return this.float32[p+0]=n,this.float32[p+1]=s,this.float32[p+2]=l,this.float32[p+3]=f,e}}lr.prototype.bytesPerElement=16,pt(lr,"StructArrayLayout4f16");class Rc extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.uint32[1*e+0]=n,e}}Rc.prototype.bytesPerElement=4,pt(Rc,"StructArrayLayout1ul4");class Ra extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n){let s=this.length;return this.resize(s+1),this.emplace(s,e,n)}emplace(e,n,s){let l=2*e;return this.uint16[l+0]=n,this.uint16[l+1]=s,e}}Ra.prototype.bytesPerElement=4,pt(Ra,"StructArrayLayout2ui4");class Im extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f,p,y,x,b,I,S,D,R){let L=this.length;return this.resize(L+1),this.emplace(L,e,n,s,l,f,p,y,x,b,I,S,D,R)}emplace(e,n,s,l,f,p,y,x,b,I,S,D,R,L){let F=20*e,V=10*e;return this.int16[F+0]=n,this.int16[F+1]=s,this.int16[F+2]=l,this.int16[F+3]=f,this.int16[F+4]=p,this.float32[V+3]=y,this.float32[V+4]=x,this.float32[V+5]=b,this.float32[V+6]=I,this.int16[F+14]=S,this.uint32[V+8]=D,this.uint16[F+18]=R,this.uint16[F+19]=L,e}}Im.prototype.bytesPerElement=40,pt(Im,"StructArrayLayout5i4f1i1ul2ui40");class Xd extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f,p,y){let x=this.length;return this.resize(x+1),this.emplace(x,e,n,s,l,f,p,y)}emplace(e,n,s,l,f,p,y,x){let b=8*e;return this.int16[b+0]=n,this.int16[b+1]=s,this.int16[b+2]=l,this.int16[b+4]=f,this.int16[b+5]=p,this.int16[b+6]=y,this.int16[b+7]=x,e}}Xd.prototype.bytesPerElement=16,pt(Xd,"StructArrayLayout3i2i2i16");class Sm extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f){let p=this.length;return this.resize(p+1),this.emplace(p,e,n,s,l,f)}emplace(e,n,s,l,f,p){let y=4*e,x=8*e;return this.float32[y+0]=n,this.float32[y+1]=s,this.float32[y+2]=l,this.int16[x+6]=f,this.int16[x+7]=p,e}}Sm.prototype.bytesPerElement=16,pt(Sm,"StructArrayLayout2f1f2i16");class ih extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f,p){let y=this.length;return this.resize(y+1),this.emplace(y,e,n,s,l,f,p)}emplace(e,n,s,l,f,p,y){let x=20*e,b=5*e;return this.uint8[x+0]=n,this.uint8[x+1]=s,this.float32[b+1]=l,this.float32[b+2]=f,this.float32[b+3]=p,this.float32[b+4]=y,e}}ih.prototype.bytesPerElement=20,pt(ih,"StructArrayLayout2ub4f20");class cr extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,s){let l=this.length;return this.resize(l+1),this.emplace(l,e,n,s)}emplace(e,n,s,l){let f=3*e;return this.uint16[f+0]=n,this.uint16[f+1]=s,this.uint16[f+2]=l,e}}cr.prototype.bytesPerElement=6,pt(cr,"StructArrayLayout3ui6");class rh extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f,p,y,x,b,I,S,D,R,L,F,V,$,Y,K,z,W){let J=this.length;return this.resize(J+1),this.emplace(J,e,n,s,l,f,p,y,x,b,I,S,D,R,L,F,V,$,Y,K,z,W)}emplace(e,n,s,l,f,p,y,x,b,I,S,D,R,L,F,V,$,Y,K,z,W,J){let te=30*e,me=15*e,de=60*e;return this.int16[te+0]=n,this.int16[te+1]=s,this.int16[te+2]=l,this.float32[me+2]=f,this.float32[me+3]=p,this.uint16[te+8]=y,this.uint16[te+9]=x,this.uint32[me+5]=b,this.uint32[me+6]=I,this.uint32[me+7]=S,this.uint16[te+16]=D,this.uint16[te+17]=R,this.uint16[te+18]=L,this.float32[me+10]=F,this.float32[me+11]=V,this.uint8[de+48]=$,this.uint8[de+49]=Y,this.uint8[de+50]=K,this.uint32[me+13]=z,this.int16[te+28]=W,this.uint8[de+58]=J,e}}rh.prototype.bytesPerElement=60,pt(rh,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class Dm extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f,p,y,x,b,I,S,D,R,L,F,V,$,Y,K,z,W,J,te,me,de,ge,xe,ke,Xe,He,Ze,Ye,Ne){let qe=this.length;return this.resize(qe+1),this.emplace(qe,e,n,s,l,f,p,y,x,b,I,S,D,R,L,F,V,$,Y,K,z,W,J,te,me,de,ge,xe,ke,Xe,He,Ze,Ye,Ne)}emplace(e,n,s,l,f,p,y,x,b,I,S,D,R,L,F,V,$,Y,K,z,W,J,te,me,de,ge,xe,ke,Xe,He,Ze,Ye,Ne,qe){let Le=20*e,Fe=40*e,Qe=80*e;return this.float32[Le+0]=n,this.float32[Le+1]=s,this.int16[Fe+4]=l,this.int16[Fe+5]=f,this.int16[Fe+6]=p,this.int16[Fe+7]=y,this.int16[Fe+8]=x,this.int16[Fe+9]=b,this.int16[Fe+10]=I,this.int16[Fe+11]=S,this.int16[Fe+12]=D,this.uint16[Fe+13]=R,this.uint16[Fe+14]=L,this.uint16[Fe+15]=F,this.uint16[Fe+16]=V,this.uint16[Fe+17]=$,this.uint16[Fe+18]=Y,this.uint16[Fe+19]=K,this.uint16[Fe+20]=z,this.uint16[Fe+21]=W,this.uint16[Fe+22]=J,this.uint16[Fe+23]=te,this.uint16[Fe+24]=me,this.uint16[Fe+25]=de,this.uint16[Fe+26]=ge,this.uint16[Fe+27]=xe,this.uint32[Le+14]=ke,this.float32[Le+15]=Xe,this.float32[Le+16]=He,this.float32[Le+17]=Ze,this.float32[Le+18]=Ye,this.uint8[Qe+76]=Ne,this.uint16[Fe+39]=qe,e}}Dm.prototype.bytesPerElement=80,pt(Dm,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class Cm extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f,p){let y=this.length;return this.resize(y+1),this.emplace(y,e,n,s,l,f,p)}emplace(e,n,s,l,f,p,y){let x=6*e;return this.float32[x+0]=n,this.float32[x+1]=s,this.float32[x+2]=l,this.float32[x+3]=f,this.float32[x+4]=p,this.float32[x+5]=y,e}}Cm.prototype.bytesPerElement=24,pt(Cm,"StructArrayLayout6f24");class Pa extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f){let p=this.length;return this.resize(p+1),this.emplace(p,e,n,s,l,f)}emplace(e,n,s,l,f,p){let y=5*e;return this.float32[y+0]=n,this.float32[y+1]=s,this.float32[y+2]=l,this.float32[y+3]=f,this.float32[y+4]=p,e}}Pa.prototype.bytesPerElement=20,pt(Pa,"StructArrayLayout5f20");class oh extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f,p,y){let x=this.length;return this.resize(x+1),this.emplace(x,e,n,s,l,f,p,y)}emplace(e,n,s,l,f,p,y,x){let b=7*e;return this.float32[b+0]=n,this.float32[b+1]=s,this.float32[b+2]=l,this.float32[b+3]=f,this.float32[b+4]=p,this.float32[b+5]=y,this.float32[b+6]=x,e}}oh.prototype.bytesPerElement=28,pt(oh,"StructArrayLayout7f28");class Mm extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f,p,y,x,b,I,S){let D=this.length;return this.resize(D+1),this.emplace(D,e,n,s,l,f,p,y,x,b,I,S)}emplace(e,n,s,l,f,p,y,x,b,I,S,D){let R=11*e;return this.float32[R+0]=n,this.float32[R+1]=s,this.float32[R+2]=l,this.float32[R+3]=f,this.float32[R+4]=p,this.float32[R+5]=y,this.float32[R+6]=x,this.float32[R+7]=b,this.float32[R+8]=I,this.float32[R+9]=S,this.float32[R+10]=D,e}}Mm.prototype.bytesPerElement=44,pt(Mm,"StructArrayLayout11f44");class Yd extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f,p,y,x,b){let I=this.length;return this.resize(I+1),this.emplace(I,e,n,s,l,f,p,y,x,b)}emplace(e,n,s,l,f,p,y,x,b,I){let S=9*e;return this.float32[S+0]=n,this.float32[S+1]=s,this.float32[S+2]=l,this.float32[S+3]=f,this.float32[S+4]=p,this.float32[S+5]=y,this.float32[S+6]=x,this.float32[S+7]=b,this.float32[S+8]=I,e}}Yd.prototype.bytesPerElement=36,pt(Yd,"StructArrayLayout9f36");class Sl extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n){let s=this.length;return this.resize(s+1),this.emplace(s,e,n)}emplace(e,n,s){let l=2*e;return this.float32[l+0]=n,this.float32[l+1]=s,e}}Sl.prototype.bytesPerElement=8,pt(Sl,"StructArrayLayout2f8");class Am extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,s,l){let f=this.length;return this.resize(f+1),this.emplace(f,e,n,s,l)}emplace(e,n,s,l,f){let p=6*e;return this.uint32[3*e+0]=n,this.uint16[p+2]=s,this.uint16[p+3]=l,this.uint16[p+4]=f,e}}Am.prototype.bytesPerElement=12,pt(Am,"StructArrayLayout1ul3ui12");class sh extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.uint16[1*e+0]=n,e}}sh.prototype.bytesPerElement=2,pt(sh,"StructArrayLayout1ui2");class Pc extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f,p,y,x,b,I,S,D,R,L,F,V){let $=this.length;return this.resize($+1),this.emplace($,e,n,s,l,f,p,y,x,b,I,S,D,R,L,F,V)}emplace(e,n,s,l,f,p,y,x,b,I,S,D,R,L,F,V,$){let Y=16*e;return this.float32[Y+0]=n,this.float32[Y+1]=s,this.float32[Y+2]=l,this.float32[Y+3]=f,this.float32[Y+4]=p,this.float32[Y+5]=y,this.float32[Y+6]=x,this.float32[Y+7]=b,this.float32[Y+8]=I,this.float32[Y+9]=S,this.float32[Y+10]=D,this.float32[Y+11]=R,this.float32[Y+12]=L,this.float32[Y+13]=F,this.float32[Y+14]=V,this.float32[Y+15]=$,e}}Pc.prototype.bytesPerElement=64,pt(Pc,"StructArrayLayout16f64");class ah extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,s,l,f,p,y){let x=this.length;return this.resize(x+1),this.emplace(x,e,n,s,l,f,p,y)}emplace(e,n,s,l,f,p,y,x){let b=10*e,I=5*e;return this.uint16[b+0]=n,this.uint16[b+1]=s,this.uint16[b+2]=l,this.uint16[b+3]=f,this.float32[I+2]=p,this.float32[I+3]=y,this.float32[I+4]=x,e}}ah.prototype.bytesPerElement=20,pt(ah,"StructArrayLayout4ui3f20");class Rm extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.int16[1*e+0]=n,e}}Rm.prototype.bytesPerElement=2,pt(Rm,"StructArrayLayout1i2");class Kd extends ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.uint8[1*e+0]=n,e}}Kd.prototype.bytesPerElement=1,pt(Kd,"StructArrayLayout1ub1");class Sy extends eh{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}Sy.prototype.size=40;class Jd extends Im{get(e){return new Sy(this,e)}}pt(Jd,"CollisionBoxArray");class Dy extends eh{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}Dy.prototype.size=60;class Cy extends rh{get(e){return new Dy(this,e)}}pt(Cy,"PlacedSymbolArray");class My extends eh{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}My.prototype.size=80;class Ay extends Dm{get(e){return new My(this,e)}}pt(Ay,"SymbolInstanceArray");class Pm extends Ma{getoffsetX(e){return this.float32[1*e+0]}}pt(Pm,"GlyphOffsetArray");class Ry extends Gs{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}pt(Ry,"SymbolLineVertexArray");class Py extends eh{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Py.prototype.size=12;class Ly extends Am{get(e){return new Py(this,e)}}pt(Ly,"FeatureIndexArray");class Oy extends Ra{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}pt(Oy,"FillExtrusionCentroidArray");class ky extends eh{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}ky.prototype.size=6;class Fy extends th{get(e){return new ky(this,e)}}pt(Fy,"FillExtrusionWallArray");let l1=mn([{name:"a_pos",components:2,type:"Int16"}],4),c1=mn([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),Qd=mn([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Di{constructor(e=[]){this.segments=e}_prepareSegment(e,n,s,l){let f=this.segments[this.segments.length-1];return e>Di.MAX_VERTEX_ARRAY_LENGTH&&qt(`Max vertices per segment is ${Di.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!f||f.vertexLength+e>Di.MAX_VERTEX_ARRAY_LENGTH||f.sortKey!==l)&&(f={vertexOffset:n,primitiveOffset:s,vertexLength:0,primitiveLength:0},l!==void 0&&(f.sortKey=l),this.segments.push(f)),f}prepareSegment(e,n,s,l){return this._prepareSegment(e,n.length,s.length,l)}get(){return this.segments}destroy(){for(let e of this.segments)for(let n in e.vaos)e.vaos[n].destroy()}static simpleSegment(e,n,s,l){return new Di([{vertexOffset:e,primitiveOffset:n,vertexLength:s,primitiveLength:l,vaos:{},sortKey:0}])}}function Ny(r,e){return 256*(r=ae(Math.floor(r),0,255))+ae(Math.floor(e),0,255)}Di.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,pt(Di,"SegmentVector");let ef=mn([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),Lm=mn([{name:"a_pattern_b",components:4,type:"Uint16"}]),zy=mn([{name:"a_dash",components:4,type:"Uint16"}]);class lh{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,n,s,l){this.ids.push(Om(e)),this.positions.push(n,s,l)}eachPosition(e,n){let s=Om(e),l=0,f=this.ids.length-1;for(;l<f;){let p=l+f>>1;this.ids[p]>=s?f=p:l=p+1}for(;this.ids[l]===s;)n(this.positions[3*l],this.positions[3*l+1],this.positions[3*l+2]),l++}static serialize(e,n){let s=new Float64Array(e.ids),l=new Uint32Array(e.positions);return tf(s,l,0,s.length-1),n&&(n.add(s.buffer),n.add(l.buffer)),{ids:s,positions:l}}static deserialize(e){let n=new lh,s;n.ids=e.ids,n.positions=e.positions;for(let l of n.ids)l!==s&&n.uniqueIds.push(l),s=l;return n.indexed=!0,n}}function Om(r){let e=+r;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:Au(String(r))}function tf(r,e,n,s){for(;n<s;){let l=r[n+s>>1],f=n-1,p=s+1;for(;;){do f++;while(r[f]<l);do p--;while(r[p]>l);if(f>=p)break;ch(r,f,p),ch(e,3*f,3*p),ch(e,3*f+1,3*p+1),ch(e,3*f+2,3*p+2)}p-n<s-p?(tf(r,e,n,p),n=p+1):(tf(r,e,p+1,s),s=p)}}function ch(r,e,n){let s=r[e];r[e]=r[n],r[n]=s}pt(lh,"FeaturePositionMap");class qs{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,n){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,n),this.initialized=!0),!!this.location}set(e,n,s){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class nf extends qs{constructor(e){super(e),this.current=0}set(e,n,s){this.fetchUniformLocation(e,n)&&this.current!==s&&(this.current=s,this.gl.uniform1i(this.location,s))}}class Ni extends qs{constructor(e){super(e),this.current=0}set(e,n,s){this.fetchUniformLocation(e,n)&&this.current!==s&&(this.current=s,this.gl.uniform1f(this.location,s))}}class _s extends qs{constructor(e){super(e),this.current=[0,0]}set(e,n,s){this.fetchUniformLocation(e,n)&&(s[0]===this.current[0]&&s[1]===this.current[1]||(this.current=s,this.gl.uniform2f(this.location,s[0],s[1])))}}class uh extends qs{constructor(e){super(e),this.current=[0,0,0]}set(e,n,s){this.fetchUniformLocation(e,n)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]||(this.current=s,this.gl.uniform3f(this.location,s[0],s[1],s[2])))}}class rf extends qs{constructor(e){super(e),this.current=[0,0,0,0]}set(e,n,s){this.fetchUniformLocation(e,n)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]&&s[3]===this.current[3]||(this.current=s,this.gl.uniform4f(this.location,s[0],s[1],s[2],s[3])))}}class By extends qs{constructor(e){super(e),this.current=In.transparent.toPremultipliedRenderColor(null)}set(e,n,s){this.fetchUniformLocation(e,n)&&(s.r===this.current.r&&s.g===this.current.g&&s.b===this.current.b&&s.a===this.current.a||(this.current=s,this.gl.uniform4f(this.location,s.r,s.g,s.b,s.a)))}}let u1=new Float32Array(16);class Lc extends qs{constructor(e){super(e),this.current=u1}set(e,n,s){if(this.fetchUniformLocation(e,n)){if(s[12]!==this.current[12]||s[0]!==this.current[0])return this.current=s,void this.gl.uniformMatrix4fv(this.location,!1,s);for(let l=1;l<16;l++)if(s[l]!==this.current[l]){this.current=s,this.gl.uniformMatrix4fv(this.location,!1,s);break}}}}let km=new Float32Array(9),ys=new Float32Array(4);class hh extends qs{constructor(e){super(e),this.current=ys}set(e,n,s){if(this.fetchUniformLocation(e,n)){for(let l=0;l<4;l++)if(s[l]!==this.current[l]){this.current=s,this.gl.uniformMatrix2fv(this.location,!1,s);break}}}}function Fm(r){return[Ny(255*r.r,255*r.g),Ny(255*r.b,255*r.a)]}class dh{constructor(e,n,s,l){this.value=e,this.uniformNames=n.map(f=>`u_${f}`),this.type=s,this.context=l}setUniform(e,n,s,l,f){let p=l.constantOr(this.value);n.set(e,f,p instanceof In?p.toPremultipliedRenderColor(this.lutExpression&&this.lutExpression.value==="none"?null:this.context.lut):p)}getBinding(e,n){return this.type==="color"?new By(e):new Ni(e)}}class Oc{constructor(e,n){this.uniformNames=n.map(s=>`u_${s}`),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(e,n){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br),this.patternTransition=n?n.tl.concat(n.br):this.pattern}setUniform(e,n,s,l,f){let p=null;f!=="u_pattern"&&f!=="u_dash"||(p=this.pattern),f==="u_pattern_b"&&(p=this.patternTransition),f==="u_pixel_ratio"&&(p=this.pixelRatio),p&&n.set(e,f,p)}getBinding(e,n){return n==="u_pattern"||n==="u_pattern_b"||n==="u_dash"?new rf(e):new Ni(e)}}class Ws{constructor(e,n,s,l){this.expression=e,this.type=s,this.maxValue=0,this.paintVertexAttributes=n.map(f=>({name:`a_${f}`,type:"Float32",components:s==="color"?2:1,offset:0})),this.paintVertexArray=new l}populatePaintArray(e,n,s,l,f,p,y,x){let b=this.paintVertexArray.length,I=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new zn(0,{brightness:p,worldview:x}),n,{},f,l,y):this.expression.kind==="constant"&&this.expression.value,S=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new zn(0,{brightness:p,worldview:x}),n,{},f,l,y):this.lutExpression.value)==="none";this.paintVertexArray.resize(e),this._setPaintValue(b,e,I,S?null:this.context.lut)}updatePaintArray(e,n,s,l,f,p,y,x){let b=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:y,worldview:x},s,l,void 0,f):this.expression.kind==="constant"&&this.expression.value,I=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new zn(0,{brightness:y,worldview:x}),s,l,void 0,f):this.lutExpression.value)==="none";this._setPaintValue(e,n,b,I?null:this.context.lut)}_setPaintValue(e,n,s,l){if(this.type==="color"){let f=Fm(s.toPremultipliedRenderColor(l));for(let p=e;p<n;p++)this.paintVertexArray.emplace(p,f[0],f[1])}else{for(let f=e;f<n;f++)this.paintVertexArray.emplace(f,s);this.maxValue=Math.max(this.maxValue,Math.abs(s))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Qo{constructor(e,n,s,l,f,p){this.expression=e,this.uniformNames=n.map(y=>`u_${y}_t`),this.type=s,this.useIntegerZoom=l,this.context=f,this.maxValue=0,this.paintVertexAttributes=n.map(y=>({name:`a_${y}`,type:"Float32",components:s==="color"?4:2,offset:0})),this.paintVertexArray=new p}populatePaintArray(e,n,s,l,f,p,y,x){let b=this.expression.evaluate(new zn(this.context.zoom,{brightness:p,worldview:x}),n,{},f,l,y),I=this.expression.evaluate(new zn(this.context.zoom+1,{brightness:p,worldview:x}),n,{},f,l,y),S=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new zn(0,{brightness:p,worldview:x}),n,{},f,l,y):this.lutExpression.value)==="none",D=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(D,e,b,I,S?null:this.context.lut)}updatePaintArray(e,n,s,l,f,p,y,x){let b=this.expression.evaluate({zoom:this.context.zoom,brightness:y,worldview:x},s,l,void 0,f),I=this.expression.evaluate({zoom:this.context.zoom+1,brightness:y,worldview:x},s,l,void 0,f),S=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new zn(0,{brightness:y,worldview:x}),s,l,void 0,f):this.lutExpression.value)==="none";this._setPaintValue(e,n,b,I,S?null:this.context.lut)}_setPaintValue(e,n,s,l,f){if(this.type==="color"){let p=Fm(s.toPremultipliedRenderColor(f)),y=Fm(s.toPremultipliedRenderColor(f));for(let x=e;x<n;x++)this.paintVertexArray.emplace(x,p[0],p[1],y[0],y[1])}else{for(let p=e;p<n;p++)this.paintVertexArray.emplace(p,s,l);this.maxValue=Math.max(this.maxValue,Math.abs(s),Math.abs(l))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,n,s,l,f){let p=this.useIntegerZoom?Math.floor(s.zoom):s.zoom,y=ae(this.expression.interpolationFactor(p,this.context.zoom,this.context.zoom+1),0,1);n.set(e,f,y)}getBinding(e,n){return new Ni(e)}}class zo{constructor(e,n,s,l,f){this.expression=e,this.layerId=f,this.paintVertexAttributes=(s==="array"?zy:ef).members;for(let p=0;p<n.length;++p);this.paintVertexArray=new l,this.paintTransitionVertexArray=new nh}populatePaintArray(e,n,s,l){let f=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(f,e,n.patterns&&n.patterns[this.layerId],s)}updatePaintArray(e,n,s,l,f,p,y){this._setPaintValues(e,n,s.patterns&&s.patterns[this.layerId],p)}_setPaintValues(e,n,s,l){if(!l||!s)return;let f=l[s[0]],p=l[s[1]];if(f){if(f){let{tl:y,br:x,pixelRatio:b}=f;for(let I=e;I<n;I++)this.paintVertexArray.emplace(I,y[0],y[1],x[0],x[1],b)}if(p){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);let{tl:y,br:x}=p;for(let b=e;b<n;b++)this.paintTransitionVertexArray.emplace(b,y[0],y[1],x[0],x[1])}}}upload(e){let n=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,n)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=e.createVertexBuffer(this.paintTransitionVertexArray,Lm.members,n))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class kc{constructor(e,n,s=()=>!0){this.binders={},this._buffers=[],this.context=n;let l=[];for(let f in e.paint._values){let p=e.paint.get(f);if(f.endsWith("-use-theme")||!s(f)||!(p instanceof Ic&&qu(p.property.specification)))continue;let y=o(f,e.type),x=p.value,b=p.property.specification.type,I=!!p.property.useIntegerZoom,S=f==="line-dasharray"||f.endsWith("pattern"),D=e.paint.get(`${f}-use-theme`),R=f==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant"||D&&D.value.kind!=="constant";if(x.kind!=="constant"||R)if(x.kind==="source"||R||S){let L=_(f,b,"source");this.binders[f]=S?new zo(x,y,b,L,e.id):new Ws(x,y,b,L),l.push(`/a_${f}`)}else{let L=_(f,b,"composite");this.binders[f]=new Qo(x,y,b,I,n,L),l.push(`/z_${f}`)}else this.binders[f]=S?new Oc(x.value,y):new dh(x.value,y,b,n),l.push(`/u_${f}`);D&&(this.binders[f].lutExpression=D.value)}this.cacheKey=l.sort().join("")}getMaxValue(e){let n=this.binders[e];return n instanceof Ws||n instanceof Qo?n.maxValue:0}populatePaintArrays(e,n,s,l,f,p,y,x){for(let b in this.binders){let I=this.binders[b];I.context=this.context,(I instanceof Ws||I instanceof Qo||I instanceof zo)&&I.populatePaintArray(e,n,s,l,f,p,y,x)}}setConstantPatternPositions(e,n){for(let s in this.binders){let l=this.binders[s];l instanceof Oc&&l.setConstantPatternPositions(e,n)}}getPatternTransitionVertexBuffer(e){let n=this.binders[e];return n instanceof zo?n.paintTransitionVertexBuffer:null}updatePaintArrays(e,n,s,l,f,p,y,x,b,I){let S=!1,D=Object.keys(e),R=D.length!==0&&!x,L=R?D:n.uniqueIds;this.context.lut=f.lut;for(let F in this.binders){let V=this.binders[F];if(V.context=this.context,(V instanceof Ws||V instanceof Qo||V instanceof zo)&&V.expression&&V.expression.kind&&V.expression.kind!=="constant"&&(V.expression.isStateDependent===!0||V.expression.isLightConstant===!1)){let $=f.paint.get(F);V.expression=$.value;for(let Y of L){let K=e[Y.toString()];n.eachPosition(Y,(z,W,J)=>{let te=l.feature(z);V.updatePaintArray(W,J,te,K,p,y,b,I)})}if(!R)for(let Y of s.uniqueIds){let K=e[Y.toString()];s.eachPosition(Y,(z,W,J)=>{let te=l.feature(z);V.updatePaintArray(W,J,te,K,p,y,b,I)})}S=!0}}return S}defines(){let e=[];for(let n in this.binders){let s=this.binders[n];(s instanceof dh||s instanceof Oc)&&e.push(...s.uniformNames.map(l=>`#define HAS_UNIFORM_${l}`))}return e}getBinderAttributes(){let e=[];for(let n in this.binders){let s=this.binders[n];if(s instanceof Ws||s instanceof Qo||s instanceof zo)for(let l=0;l<s.paintVertexAttributes.length;l++)e.push(s.paintVertexAttributes[l].name);if(s instanceof zo)for(let l=0;l<Lm.members.length;l++)e.push(Lm.members[l].name)}return e}getBinderUniforms(){let e=[];for(let n in this.binders){let s=this.binders[n];if(s instanceof dh||s instanceof Oc||s instanceof Qo)for(let l of s.uniformNames)e.push(l)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){let n=[];for(let s in this.binders){let l=this.binders[s];if(l instanceof dh||l instanceof Oc||l instanceof Qo)for(let f of l.uniformNames)n.push({name:f,property:s,binding:l.getBinding(e,f)})}return n}setUniforms(e,n,s,l,f){for(let{name:p,property:y,binding:x}of s)this.binders[y].setUniform(e,x,f,l.get(y),p)}updatePaintBuffers(){this._buffers=[];for(let e in this.binders){let n=this.binders[e];(n instanceof Ws||n instanceof Qo||n instanceof zo)&&n.paintVertexBuffer&&this._buffers.push(n.paintVertexBuffer),n instanceof zo&&n.paintTransitionVertexBuffer&&this._buffers.push(n.paintTransitionVertexBuffer)}}upload(e){for(let n in this.binders){let s=this.binders[n];(s instanceof Ws||s instanceof Qo||s instanceof zo)&&s.upload(e)}this.updatePaintBuffers()}destroy(){for(let e in this.binders){let n=this.binders[e];(n instanceof Ws||n instanceof Qo||n instanceof zo)&&n.destroy()}}}class u{constructor(e,n,s=()=>!0){this.programConfigurations={};for(let l of e)this.programConfigurations[l.id]=new kc(l,n,s);this.needsUpload=!1,this._featureMap=new lh,this._featureMapWithoutIds=new lh,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,n,s,l,f,p,y,x,b){for(let I in this.programConfigurations)this.programConfigurations[I].populatePaintArrays(e,n,l,f,p,y,x,b);n.id!==void 0?this._featureMap.add(n.id,s,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,s,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,n,s,l,f,p,y,x){for(let b of s)this.needsUpload=this.programConfigurations[b.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,n,b,l,f,p,y||0,x)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(let n in this.programConfigurations)this.programConfigurations[n].upload(e);this.needsUpload=!1}}destroy(){for(let e in this.programConfigurations)this.programConfigurations[e].destroy()}}let t={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function o(r,e){return t[r]||[r.replace(`${e}-`,"").replace(/-/g,"_")]}let h={"line-pattern":{source:Aa,composite:Aa},"fill-pattern":{source:Aa,composite:Aa},"fill-extrusion-pattern":{source:Aa,composite:Aa},"line-dasharray":{source:nh,composite:nh}},m={color:{source:Sl,composite:lr},number:{source:Ma,composite:Sl}};function _(r,e,n){let s=h[r];return s&&s[n]||m[e][n]}pt(dh,"ConstantBinder"),pt(Oc,"PatternConstantBinder"),pt(Ws,"SourceExpressionBinder"),pt(zo,"PatternCompositeBinder"),pt(Qo,"CompositeExpressionBinder"),pt(kc,"ProgramConfiguration",{omit:["_buffers"]}),pt(u,"ProgramConfigurationSet");let v=at/Math.PI/2,E=5,T=6,C=16383,M=64,O=[M,32,16],P=-v,k=v;function j(r,e,n,s=v){return n=gn(n),[r*Math.sin(n)*s,-e*s,r*Math.cos(n)*s]}function B(r,e,n){return j(Math.cos(gn(r)),Math.sin(gn(r)),e,n)}let U=63710088e-1,q=2*Math.PI*U;class Z{constructor(e,n){if(isNaN(e)||isNaN(n))throw new Error(`Invalid LngLat object: (${e}, ${n})`);if(this.lng=+e,this.lat=+n,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Z(De(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){let n=Math.PI/180,s=this.lat*n,l=e.lat*n,f=Math.sin(s)*Math.sin(l)+Math.cos(s)*Math.cos(l)*Math.cos((e.lng-this.lng)*n);return U*Math.acos(Math.min(f,1))}toBounds(e=0){let n=360*e/40075017,s=n/Math.cos(Math.PI/180*this.lat);return new ee({lng:this.lng-s,lat:this.lat-n},{lng:this.lng+s,lat:this.lat+n})}toEcef(e){return B(this.lat,this.lng,v+e*v/U)}static convert(e){if(e instanceof Z)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new Z(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new Z(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class ee{constructor(e,n){if(e)if(n)this.setSouthWest(e).setNorthEast(n);else if(e.length===4){let s=e;this.setSouthWest([s[0],s[1]]).setNorthEast([s[2],s[3]])}else{let s=e;this.setSouthWest(s[0]).setNorthEast(s[1])}}setNorthEast(e){return this._ne=e instanceof Z?new Z(e.lng,e.lat):Z.convert(e),this}setSouthWest(e){return this._sw=e instanceof Z?new Z(e.lng,e.lat):Z.convert(e),this}extend(e){let n=this._sw,s=this._ne,l,f;if(e instanceof Z)l=e,f=e;else{if(!(e instanceof ee))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(ee.convert(e)):this.extend(Z.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(Z.convert(e)):this;if(l=e._sw,f=e._ne,!l||!f)return this}return n||s?(n.lng=Math.min(l.lng,n.lng),n.lat=Math.min(l.lat,n.lat),s.lng=Math.max(f.lng,s.lng),s.lat=Math.max(f.lat,s.lat)):(this._sw=new Z(l.lng,l.lat),this._ne=new Z(f.lng,f.lat)),this}getCenter(){return new Z((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Z(this.getWest(),this.getNorth())}getSouthEast(){return new Z(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){let{lng:n,lat:s}=Z.convert(e),l=this._sw.lng<=n&&n<=this._ne.lng;return this._sw.lng>this._ne.lng&&(l=this._sw.lng>=n&&n>=this._ne.lng),this._sw.lat<=s&&s<=this._ne.lat&&l}static convert(e){if(e)return e instanceof ee?e:new ee(e)}}let re=0,ue=25.5;function le(r){return q*Math.cos(r*Math.PI/180)}function se(r){return(180+r)/360}function oe(r){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r*Math.PI/360)))/360}function he(r,e){return r/le(e)}function fe(r){return 360*r-180}function Te(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function Ie(r,e){return r*le(Te(e))}let Be=85.051129;function Ve(r){return Math.cos(gn(ae(r,-85.051129,Be)))}function We(r,e){let n=ae(e,re,ue),s=Math.pow(2,n);return Ve(r)*q/(512*s)}function we(r){return 1/Math.cos(r*Math.PI/180)}function Oe(r,e=0){let n=Math.exp(Math.PI*(1-(r.y+e/at)/(1<<r.z)*2));return 80150034*n/(n*n+1)/at/(1<<r.z)}class _e{constructor(e,n,s=0){this.x=+e,this.y=+n,this.z=+s}static fromLngLat(e,n=0){let s=Z.convert(e);return new _e(se(s.lng),oe(s.lat),he(n,s.lat))}toLngLat(){return new Z(fe(this.x),Te(this.y))}toAltitude(){return Ie(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/q*we(Te(this.y))}}function Ue(r,e,n,s,l,f,p,y,x){let b=(e+s)/2,I=(n+l)/2,S=new ot(b,I);y(S),function(D,R,L,F,V,$){let Y=L-V,K=F-$;return Math.abs((F-R)*Y-(L-D)*K)/Math.hypot(Y,K)}(S.x,S.y,f.x,f.y,p.x,p.y)>=x?(Ue(r,e,n,b,I,f,S,y,x),Ue(r,b,I,s,l,S,p,y,x)):r.push(p)}function Me(r,e,n){let s=r[0],l=s.x,f=s.y;e(s);let p=[s];for(let y=1;y<r.length;y++){let x=r[y],{x:b,y:I}=x;e(x),Ue(p,l,f,b,I,s,x,e,n),l=b,f=I,s=x}return p}function Ge(r,e,n,s){if(s(e,n)){let l=e.add(n)._mult(.5);Ge(r,e,l,s),Ge(r,l,n,s)}else r.push(n)}function nt(r,e){let n=r[0],s=[n];for(let l=1;l<r.length;l++){let f=r[l];Ge(s,n,f,e),n=f}return s}let je=Math.pow(2,14)-1,et=-je-1;function mt(r,e){let n=Math.round(r.x*e),s=Math.round(r.y*e);return r.x=ae(n,et,je),r.y=ae(s,et,je),(n<r.x||n>r.x+1||s<r.y||s>r.y+1)&&qt("Geometry exceeds allowed extent, reduce your vector tile buffer size"),r}function gt(r,e,n){let s=r.loadGeometry(),l=r.extent,f=at/l;if(e&&n&&n.projection.isReprojectedInTileSpace){let p=1<<e.z,{scale:y,x,y:b,projection:I}=n,S=D=>{let R=fe((e.x+D.x/l)/p),L=Te((e.y+D.y/l)/p),F=I.project(R,L);D.x=(F.x*y-x)*l,D.y=(F.y*y-b)*l};for(let D=0;D<s.length;D++)if(r.type!==1)s[D]=Me(s[D],S,1);else{let R=[];for(let L of s[D])L.x<0||L.x>=l||L.y<0||L.y>=l||(S(L),R.push(L));s[D]=R}}for(let p of s)for(let y of p)mt(y,f);return s}function dt(r,e){return{type:r.type,id:r.id,properties:r.properties,geometry:e?gt(r):[]}}var Et,St,Ct,Nt,Zt,Dn,Kn,Rn={};function kn(){if(St)return Et;St=1;var r=il();function e(l,f,p,y,x){this.properties={},this.extent=p,this.type=0,this._pbf=l,this._geometry=-1,this._keys=y,this._values=x,l.readFields(n,this,f)}function n(l,f,p){l==1?f.id=p.readVarint():l==2?function(y,x){for(var b=y.readVarint()+y.pos;y.pos<b;){var I=x._keys[y.readVarint()],S=x._values[y.readVarint()];x.properties[I]=S}}(p,f):l==3?f.type=p.readVarint():l==4&&(f._geometry=p.pos)}function s(l){for(var f,p,y=0,x=0,b=l.length,I=b-1;x<b;I=x++)y+=((p=l[I]).x-(f=l[x]).x)*(f.y+p.y);return y}return Et=e,e.types=["Unknown","Point","LineString","Polygon"],e.prototype.loadGeometry=function(){var l=this._pbf;l.pos=this._geometry;for(var f,p=l.readVarint()+l.pos,y=1,x=0,b=0,I=0,S=[];l.pos<p;){if(x<=0){var D=l.readVarint();y=7&D,x=D>>3}if(x--,y===1||y===2)b+=l.readSVarint(),I+=l.readSVarint(),y===1&&(f&&S.push(f),f=[]),f.push(new r(b,I));else{if(y!==7)throw new Error("unknown command "+y);f&&f.push(f[0].clone())}}return f&&S.push(f),S},e.prototype.bbox=function(){var l=this._pbf;l.pos=this._geometry;for(var f=l.readVarint()+l.pos,p=1,y=0,x=0,b=0,I=1/0,S=-1/0,D=1/0,R=-1/0;l.pos<f;){if(y<=0){var L=l.readVarint();p=7&L,y=L>>3}if(y--,p===1||p===2)(x+=l.readSVarint())<I&&(I=x),x>S&&(S=x),(b+=l.readSVarint())<D&&(D=b),b>R&&(R=b);else if(p!==7)throw new Error("unknown command "+p)}return[I,D,S,R]},e.prototype.toGeoJSON=function(l,f,p){var y,x,b=this.extent*Math.pow(2,p),I=this.extent*l,S=this.extent*f,D=this.loadGeometry(),R=e.types[this.type];function L($){for(var Y=0;Y<$.length;Y++){var K=$[Y];$[Y]=[360*(K.x+I)/b-180,360/Math.PI*Math.atan(Math.exp((180-360*(K.y+S)/b)*Math.PI/180))-90]}}switch(this.type){case 1:var F=[];for(y=0;y<D.length;y++)F[y]=D[y][0];L(D=F);break;case 2:for(y=0;y<D.length;y++)L(D[y]);break;case 3:for(D=function($){var Y=$.length;if(Y<=1)return[$];for(var K,z,W=[],J=0;J<Y;J++){var te=s($[J]);te!==0&&(z===void 0&&(z=te<0),z===te<0?(K&&W.push(K),K=[$[J]]):K.push($[J]))}return K&&W.push(K),W}(D),y=0;y<D.length;y++)for(x=0;x<D[y].length;x++)L(D[y][x])}D.length===1?D=D[0]:R="Multi"+R;var V={type:"Feature",geometry:{type:R,coordinates:D},properties:this.properties};return"id"in this&&(V.id=this.id),V},Et}function Pi(){if(Nt)return Ct;Nt=1;var r=kn();function e(s,l){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=s,this._keys=[],this._values=[],this._features=[],s.readFields(n,this,l),this.length=this._features.length}function n(s,l,f){s===15?l.version=f.readVarint():s===1?l.name=f.readString():s===5?l.extent=f.readVarint():s===2?l._features.push(f.pos):s===3?l._keys.push(f.readString()):s===4&&l._values.push(function(p){for(var y=null,x=p.readVarint()+p.pos;p.pos<x;){var b=p.readVarint()>>3;y=b===1?p.readString():b===2?p.readFloat():b===3?p.readDouble():b===4?p.readVarint64():b===5?p.readVarint():b===6?p.readSVarint():b===7?p.readBoolean():null}return y}(f))}return Ct=e,e.prototype.feature=function(s){if(s<0||s>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[s];var l=this._pbf.readVarint()+this._pbf.pos;return new r(this._pbf,l,this.extent,this._keys,this._values)},Ct}function Ht(){return Kn||(Kn=1,Rn.VectorTile=function(){if(Dn)return Zt;Dn=1;var r=Pi();function e(n,s,l){if(n===3){var f=new r(l,l.readVarint()+l.pos);f.length&&(s[f.name]=f)}}return Zt=function(n,s){this.layers=n.readFields(e,{},s)},Zt}(),Rn.VectorTileFeature=kn(),Rn.VectorTileLayer=Pi()),Rn}var Kt=Ht();let on="3d_elevation_id",ni="level";class $i{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(e,n){return this._valid&&e(n(this._geometry)),this}require(e,n,s){return this.get(e,!0,n,s)}optional(e,n,s){return this.get(e,!1,n,s)}success(){return this._valid}get(e,n,s,l){let f=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&f!==void 0&&!Number.isNaN(f)?s(l?l(f):f):n&&(this._valid=!1),this}}class Jn{constructor(e,n){this.featureFunc=e,this.vertexFunc=n}parseFeature(e,n,s){return this.featureFunc(e,n,s)}parseVertex(e,n,s){return this.vertexFunc(e,n,s)}}let vn=new Jn((r,e,n)=>r.reset(e).require(on,s=>{n.id=s}).optional("fixed_height_relative",s=>{n.constantHeight=s},dn.decodeRelativeHeight).geometry(s=>{n.bounds=s},Hp).success(),(r,e,n)=>r.reset(e).require(on,s=>{n.id=s}).require("elevation_idx",s=>{n.idx=s}).require("extent",s=>{n.extent=s}).require("height_relative",s=>{n.height=s},dn.decodeRelativeHeight).geometry(s=>{n.position=s},dn.getPoint).success()),Ti=new Jn((r,e,n)=>r.reset(e).require(on,s=>{n.id=s}).optional("fixed_height",s=>{n.constantHeight=s},dn.decodeMetricHeight).geometry(s=>{n.bounds=s},Hp).success(),(r,e,n)=>r.reset(e).require(on,s=>{n.id=s}).require("elevation_idx",s=>{n.idx=s}).require("extent",s=>{n.extent=s}).require("height",s=>{n.height=s},dn.decodeMetricHeight).geometry(s=>{n.position=s},dn.getPoint).success());class dn{static getPoint(e){return Lo(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static parse(e){let n=[],s=[],l=e.length,f=new $i;for(let y=0;y<l;y++){let x=e.feature(y),b=x.properties.hasOwnProperty("version")?String(x.properties.version):void 0,I=(p=b)?p==="1.0.1"?Ti:void 0:vn;if(I===void 0){qt(`Unknown elevation feature version number ${b||"(unknown)"}`);continue}let S=x.properties.hasOwnProperty("type")?x.properties.type:void 0;if(S){if(Kt.VectorTileFeature.types[x.type]==="Point"&&S==="curve_point"){let D={};I.parseVertex(f,x,D)&&n.push(D)}else if(Kt.VectorTileFeature.types[x.type]==="Polygon"&&S==="curve_meta"){let D={};I.parseFeature(f,x,D)&&s.push(D)}}}var p;return{vertices:n,features:s}}}class zi{constructor(e,n){this.pos=e,this.dir=n}intersectsPlane(e,n,s){let l=mi(n,this.dir);if(Math.abs(l)<1e-6)return!1;let f=((e[0]-this.pos[0])*n[0]+(e[1]-this.pos[1])*n[1])/l;return s[0]=this.pos[0]+this.dir[0]*f,s[1]=this.pos[1]+this.dir[1]*f,!0}}class ii{constructor(e,n){this.pos=e,this.dir=n}intersectsPlane(e,n,s){let l=Bi(n,this.dir);if(Math.abs(l)<1e-6)return!1;let f=((e[0]-this.pos[0])*n[0]+(e[1]-this.pos[1])*n[1]+(e[2]-this.pos[2])*n[2])/l;return s[0]=this.pos[0]+this.dir[0]*f,s[1]=this.pos[1]+this.dir[1]*f,s[2]=this.pos[2]+this.dir[2]*f,!0}closestPointOnSphere(e,n,s){if(function(R,L){var F=R[0],V=R[1],$=R[2],Y=L[0],K=L[1],z=L[2];return Math.abs(F-Y)<=A*Math.max(1,Math.abs(F),Math.abs(Y))&&Math.abs(V-K)<=A*Math.max(1,Math.abs(V),Math.abs(K))&&Math.abs($-z)<=A*Math.max(1,Math.abs($),Math.abs(z))}(this.pos,e)||n===0)return s[0]=s[1]=s[2]=0,!1;let[l,f,p]=this.dir,y=this.pos[0]-e[0],x=this.pos[1]-e[1],b=this.pos[2]-e[2],I=l*l+f*f+p*p,S=2*(y*l+x*f+b*p),D=S*S-4*I*(y*y+x*x+b*b-n*n);if(D<0){let R=Math.max(-S/2,0),L=y+l*R,F=x+f*R,V=b+p*R,$=Math.hypot(L,F,V);return s[0]=L*n/$,s[1]=F*n/$,s[2]=V*n/$,!1}{let R=(-S-Math.sqrt(D))/(2*I);if(R<0){let L=Math.hypot(y,x,b);return s[0]=y*n/L,s[1]=x*n/L,s[2]=b*n/L,!1}return s[0]=y+l*R,s[1]=x+f*R,s[2]=b+p*R,!0}}}class Wn{constructor(e,n,s,l,f){this.TL=e,this.TR=n,this.BR=s,this.BL=l,this.horizon=f}static fromInvProjectionMatrix(e,n,s){let l=[-1,1,1],f=[1,1,1],p=[1,-1,1],y=[-1,-1,1],x=ai(l,l,e),b=ai(f,f,e),I=ai(p,p,e),S=ai(y,y,e);return new Wn(x,b,I,S,n/s)}}function ri(r,e,n){let s=1/0,l=-1/0,f=[];for(let p of r){Vi(f,p,e);let y=Bi(f,n);s=Math.min(s,y),l=Math.max(l,y)}return[s,l]}function wn(r,e){let n=!0;for(let s=0;s<r.planes.length;s++){let l=r.planes[s],f=0;for(let p=0;p<e.length;p++)f+=Bi(l,e[p])+l[3]>=0;if(f===0)return 0;f!==e.length&&(n=!1)}return n?2:1}function Ci(r,e){for(let n of r.projections){let s=ri(e,r.points[0],n.axis);if(n.projection[1]<s[0]||n.projection[0]>s[1])return 0}return 1}function ur(r,e){let n=0,s=[0,0,0,0];for(let p=0;p<r.length;p++)s[0]=r[p][0],s[1]=r[p][1],s[2]=r[p][2],s[3]=1,(l=s)[0]*(f=e)[0]+l[1]*f[1]+l[2]*f[2]+l[3]*f[3]>=0&&n++;var l,f;return n}class hi{constructor(e,n){this.points=e||new Array(8).fill([0,0,0]),this.planes=n||new Array(6).fill([0,0,0,0]),this.bounds=_n.fromPoints(this.points),this.projections=[],this.frustumEdges=[Vi([],this.points[2],this.points[3]),Vi([],this.points[0],this.points[3]),Vi([],this.points[4],this.points[0]),Vi([],this.points[5],this.points[1]),Vi([],this.points[6],this.points[2]),Vi([],this.points[7],this.points[3])];for(let s of this.frustumEdges){let l=[0,-s[2],s[1]],f=[s[2],0,-s[0]];this.projections.push({axis:l,projection:ri(this.points,this.points[0],l)}),this.projections.push({axis:f,projection:ri(this.points,this.points[0],f)})}}static fromInvProjectionMatrix(e,n,s,l){let f=Math.pow(2,s),p=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(b=>{let I=Or([],b,e),S=1/I[3]/n*f;return(D=I)[0]=(R=I)[0]*(L=[S,S,l?1/I[3]:S,S])[0],D[1]=R[1]*L[1],D[2]=R[2]*L[2],D[3]=R[3]*L[3],D;var D,R,L}),y=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(b=>{let I=bi([],er([],Vi([],p[b[0]],p[b[1]]),Vi([],p[b[2]],p[b[1]]))),S=-Bi(I,p[b[1]]);return I.concat(S)}),x=[];for(let b=0;b<p.length;b++)x.push([p[b][0],p[b][1],p[b][2]]);return new hi(x,y)}intersectsPrecise(e,n,s){for(let l=0;l<n.length;l++)if(!ur(e,n[l]))return 0;for(let l=0;l<this.planes.length;l++)if(!ur(e,this.planes[l]))return 0;for(let l of s)for(let f of this.frustumEdges){let p=er([],l,f),y=Pr(p);if(y===0)continue;pi(p,p,1/y);let x=ri(this.points,this.points[0],p),b=ri(e,this.points[0],p);if(x[0]>b[1]||b[0]>x[1])return 0}return 1}containsPoint(e){for(let n of this.planes){let s=n[3];if(Bi([n[0],n[1],n[2]],e)+s<0)return!1}return!0}}class _n{static fromPoints(e){let n=[1/0,1/0,1/0],s=[-1/0,-1/0,-1/0];for(let l of e)As(n,n,l),Go(s,s,l);return new _n(n,s)}static fromTileIdAndHeight(e,n,s){let l=1<<e.canonical.z,f=e.canonical.x,p=e.canonical.y;return new _n([f/l,p/l,n],[(f+1)/l,(p+1)/l,s])}static applyTransform(e,n){let s=e.getCorners();for(let l=0;l<s.length;++l)ai(s[l],s[l],n);return _n.fromPoints(s)}static applyTransformFast(e,n){let s=[n[12],n[13],n[14]],l=[...s];for(let f=0;f<3;f++)for(let p=0;p<3;p++){let y=n[4*p+f],x=y*e.min[p],b=y*e.max[p];s[f]+=Math.min(x,b),l[f]+=Math.max(x,b)}return new _n(s,l)}static projectAabbCorners(e,n){let s=e.getCorners();for(let l=0;l<s.length;++l)ai(s[l],s[l],n);return s}constructor(e,n){this.min=e,this.max=n,this.center=pi([],Ui([],this.min,this.max),.5)}quadrant(e){let n=[e%2==0,e<2],s=Qa(this.min),l=Qa(this.max);for(let f=0;f<n.length;f++)s[f]=n[f]?this.min[f]:this.center[f],l[f]=n[f]?this.center[f]:this.max[f];return l[2]=this.max[2],new _n(s,l)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){let e=this.min,n=this.max;return[[e[0],e[1],e[2]],[n[0],e[1],e[2]],[n[0],n[1],e[2]],[e[0],n[1],e[2]],[e[0],e[1],n[2]],[n[0],e[1],n[2]],[n[0],n[1],n[2]],[e[0],n[1],n[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?wn(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?wn(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,n){return n||this.intersects(e)?Ci(e,this.getCorners()):0}intersectsPreciseFlat(e,n){return n||this.intersectsFlat(e)?Ci(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let n=0;n<3;++n)if(this.min[n]>e.max[n]||e.min[n]>this.max[n])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let n=0;n<3;n++)this.min[n]=Math.min(this.min[n],e.min[n]),this.max[n]=Math.max(this.max[n],e.max[n])}encapsulatePoint(e){for(let n=0;n<3;n++)this.min[n]=Math.min(this.min[n],e[n]),this.max[n]=Math.max(this.max[n],e[n])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}pt(_n,"Aabb");class co{constructor(e,n){this.feature=e,this.metersToTile=n,this.index=0}get(){let e=this.feature.vertices[this.index],n=this.feature.vertexProps[this.index].dir,s=n[1],l=-n[0],f=(e.extent+1)*this.metersToTile;return[new ot(Math.trunc(e.position[0]+s*f),Math.trunc(e.position[1]+l*f)),new ot(Math.trunc(e.position[0]-s*f),Math.trunc(e.position[1]-l*f))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class Kr{constructor(e,n,s,l,f,p){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this.id=e,this.heightRange={min:s,max:s},this.safeArea=n,this.constantHeight=s,this.constantHeight==null&&(this.constantHeight!=null||l.length!==0)){this.vertices=l,this.edges=f,this.edges=this.edges.filter(y=>{return y.a<this.vertices.length&&y.b<this.vertices.length&&!((x=this.vertices[y.a].position)[0]===(b=this.vertices[y.b].position)[0]&&x[1]===b[1]);var x,b}),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(let y of this.vertices)this.vertexProps.push({dir:Lo(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,y.height),this.heightRange.max=Math.max(this.heightRange.max,y.height);for(let y of this.edges){let x=this.vertices[y.a].position,b=this.vertices[y.b].position,I=fa(br(),b,x),S=pa(I),D=nl(br(),I,1/S);this.edgeProps.push({vec:I,dir:D,len:S});let R=this.vertexProps[y.a].dir,L=this.vertexProps[y.b].dir;tl(R,R,D),tl(L,L,D)}for(let y of this.vertexProps)y.dir[0]===0&&y.dir[1]===0||Ql(y.dir,y.dir);this.tessellate(p)}}pointElevation(e){if(this.constantHeight!=null)return this.constantHeight;let n=this.getClosestEdge(e);if(n==null)return 0;let[s,l]=n;return kt(this.vertices[this.edges[s].a].height,this.vertices[this.edges[s].b].height,l)}computeSlopeNormal(e,n){let s=this.getClosestEdge(e);if(!s)return qn(0,0,1);let l=s[0],f=this.edges[l],p=this.edgeProps[l].vec,y=qn(p[0],p[1],(this.vertices[f.b].height-this.vertices[f.a].height)*n),x=qn(y[1],-y[0],0);er(x,x,y);let b=Pr(x);return b>0?pi(x,x,1/b):qn(0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(this.edges.length===0)return;let n=0,s=Number.POSITIVE_INFINITY,l=0,f=Lo(e.x,e.y);for(let p=0;p<this.edges.length;p++){let y=this.edges[p],x=this.edgeProps[p].dir,b=new zi(f,this.edgeProps[p].dir),I=this.vertices[y.a].position,S=this.vertices[y.b].position,D=br(),R=br(),L=b.intersectsPlane(I,this.vertexProps[y.a].dir,D),F=b.intersectsPlane(S,this.vertexProps[y.b].dir,R);if(!L||!F)continue;let V=fa(br(),R,D),$=fa(br(),f,D),Y=mi(V,V),K=Y>0?mi($,V)/Y:0,z=ae(K,0,1),W=Math.abs((K-z)*this.edgeProps[p].len),J=fa(br(),f,I),te=W+Math.abs(mi(J,Lo(x[1],-x[0])));te<s&&(n=p,s=te,l=z)}return[n,l]}tessellate(e){for(let n=this.edges.length-1;n>=0;--n){let s=this.edges[n].a,l=this.edges[n].b,{position:f,height:p,extent:y}=this.vertices[s],{position:x,height:b,extent:I}=this.vertices[l],S=this.vertexProps[s].dir,D=this.vertexProps[l].dir,R=qn(f[0]/e,f[1]/e,p),L=qn(x[0]/e,x[1]/e,b),F=qn(S[1],-S[0],0);pi(F,F,y);let V=qn(D[1],-D[0],0);if(pi(V,V,I),this.distSqLines(qn(R[0]+.5*F[0],R[1]+.5*F[1],R[2]+.5*F[2]),qn(L[0]-.5*V[0],L[1]-.5*V[1],L[2]-.5*V[2]),qn(R[0]-.5*F[0],R[1]-.5*F[1],R[2]-.5*F[2]),qn(L[0]+.5*V[0],L[1]+.5*V[1],L[2]+.5*V[2]))<=.0025000000000000005)continue;let $=this.vertices.length,Y=tl(br(),f,x);this.vertices.push({position:nl(Y,Y,.5),height:.5*(p+b),extent:.5*(y+I)});let K=tl(br(),S,D);this.vertexProps.push({dir:Ql(K,K)}),this.edges.splice(n,1),this.edgeProps.splice(n,1),this.edges.push({a:s,b:$}),this.edges.push({a:$,b:l});let z=fa(br(),this.vertices[$].position,f),W=pa(z),J={vec:z,dir:nl(br(),z,1/W),len:W};this.edgeProps.push(J),this.edgeProps.push(J)}}distSqLines(e,n,s,l){let f=Qi(ji(),n,e),p=Qi(ji(),l,s),y=Qi(ji(),e,s),x=Bi(f,f),b=Bi(f,p),I=Bi(f,y),S=Bi(p,p),D=Bi(p,y),R=x*S-b*b;if(R===0){let V=Bi(y,p)/Bi(p,p);return qo(Po(ji(),s,l,V),e)}let L=(b*D-I*S)/R,F=(x*D-b*I)/R;return qo(Po(ji(),e,n,L),Po(ji(),s,l,F))}}class Eo{static parseFrom(e,n){let s=dn.parse(e);if(!s)return[];let{vertices:l,features:f}=s,p=1/Oe(n);f.sort((I,S)=>I.id-S.id),l.sort((I,S)=>I.id-S.id||I.idx-S.idx),l=l.filter((I,S,D)=>S===D.findIndex(R=>R.id===I.id&&R.idx===I.idx));let y=new Array,x=0,b=l.length;for(let I of f){if(I.constantHeight){y.push(new Kr(I.id,I.bounds,I.constantHeight));continue}for(;x!==b&&l[x].id<I.id;)x++;if(x===b||l[x].id!==I.id)continue;let S=new Array,D=new Array,R=x;for(;x!==b&&l[x].id===I.id;){let L=l[x];if(S.push({position:L.position,height:L.height,extent:L.extent}),x!==R&&l[x-1].idx===L.idx-1){let F=x-R;D.push({a:F-1,b:F})}x++}y.push(new Kr(I.id,I.bounds,void 0,S,D,p))}return y}static getElevationFeature(e,n){if(!n)return;let s=+e.properties[on];return Number.isNaN(s)?void 0:n.find(l=>l.id===s)}}class es{constructor(e,n){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(n)||(this.zScale=Math.pow(2,n.z-e.z),this.xOffset=(e.x*this.zScale-n.x)*at,this.yOffset=(e.y*this.zScale-n.y)*at)}constantElevation(e,n){if(e.constantHeight!=null)return this.computeBiasedHeight(e.constantHeight,n)}pointElevation(e,n,s){let l=this.constantElevation(n,s);return l??(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(n.pointElevation(e),s))}computeBiasedHeight(e,n){return n<=0?e:e+n*ye(0,n,e>=0?e:Math.abs(.5*e))}}pt(Kr,"ElevationFeature");class Bo{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new Gs,this.indexArray=new cr,this.segments=new Di,this.programConfigurations=new u(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,this.elevationMode!=="none"&&(this.elevatedLayoutVertexArray=new Ma),this.worldview=e.worldview}updateFootprints(e,n){}populate(e,n,s,l){let f=this.layers[0],p=[],y=null;f.type==="circle"&&(y=f.layout.get("circle-sort-key"));for(let{feature:b,id:I,index:S,sourceLayerIndex:D}of e){let R=this.layers[0]._featureFilter.needGeometry,L=dt(b,R);if(!this.layers[0]._featureFilter.filter(new zn(this.zoom,{worldview:this.worldview}),L,s))continue;let F=y?y.evaluate(L,{},s):void 0,V={id:I,properties:b.properties,type:b.type,sourceLayerIndex:D,index:S,geometry:R?L.geometry:gt(b,s,l),patterns:{},sortKey:F};p.push(V)}y&&p.sort((b,I)=>b.sortKey-I.sortKey);let x=null;l.projection.name==="globe"&&(this.globeExtVertexArray=new Zd,x=l.projection);for(let b of p){let{geometry:I,index:S,sourceLayerIndex:D}=b,R=e[S].feature;this.addFeature(b,I,S,n.availableImages,s,x,n.brightness,n.elevationFeatures),n.featureIndex.insert(R,I,S,D,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(e,n,s,l,f,p,y){this.programConfigurations.updatePaintArrays(e,n,f,s,l,p,y,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,l1.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,Qd.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,c1.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(e,n,s,l,f,p,y,x){let b;this.elevationMode!=="none"&&(b=Eo.getElevationFeature(e,x));for(let I of n)for(let S of I){let D=S.x,R=S.y;if(D<0||D>=at||R<0||R>=at)continue;if(p){let V=p.projectTilePoint(D,R,f),$=p.upVector(f,D,R);this.addGlobeExtVertex(V,$),this.addGlobeExtVertex(V,$),this.addGlobeExtVertex(V,$),this.addGlobeExtVertex(V,$)}let L=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),F=L.vertexLength;if(this.addCircleVertex(D,R,-1,-1),this.addCircleVertex(D,R,1,-1),this.addCircleVertex(D,R,1,1),this.addCircleVertex(D,R,-1,1),this.elevationMode!=="none"){let V=b?b.pointElevation(new ot(D,R)):0;this.hasElevation=this.hasElevation||V!==0;for(let $=0;$<4;$++)this.elevatedLayoutVertexArray.emplaceBack(V)}this.indexArray.emplaceBack(F,F+1,F+2),this.indexArray.emplaceBack(F,F+2,F+3),L.vertexLength+=4,L.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,{},l,f,y,void 0,this.worldview)}addCircleVertex(e,n,s,l){this.layoutVertexArray.emplaceBack(2*e+(s+1)/2,2*n+(l+1)/2)}addGlobeExtVertex(e,n){this.globeExtVertexArray.emplaceBack(e.x,e.y,e.z,n[0]*16384,n[1]*16384,n[2]*16384)}}function Jr(r,e){for(let n=0;n<r.length;n++)if(vs(e,r[n]))return!0;for(let n=0;n<e.length;n++)if(vs(r,e[n]))return!0;return!!fh(r,e)}function La(r,e,n){return!!vs(r,e)||!!ph(e,r,n)}function ts(r,e){if(r.length===1)return sf(e,r[0]);for(let n=0;n<e.length;n++){let s=e[n];for(let l=0;l<s.length;l++)if(vs(r,s[l]))return!0}for(let n=0;n<r.length;n++)if(sf(e,r[n]))return!0;for(let n=0;n<e.length;n++)if(fh(r,e[n]))return!0;return!1}function Oa(r,e,n){if(r.length>1){if(fh(r,e))return!0;for(let s=0;s<e.length;s++)if(ph(e[s],r,n))return!0}for(let s=0;s<r.length;s++)if(ph(r[s],e,n))return!0;return!1}function fh(r,e){if(r.length===0||e.length===0)return!1;for(let n=0;n<r.length-1;n++){let s=r[n],l=r[n+1];for(let f=0;f<e.length-1;f++)if(Nm(s,l,e[f],e[f+1]))return!0}return!1}function Nm(r,e,n,s){return Hn(r,n,s)!==Hn(e,n,s)&&Hn(r,e,n)!==Hn(r,e,s)}function Fc(r,e,n){return(r.x-n.x)*(e.y-n.y)-(r.y-n.y)*(e.x-n.x)}function zm(r,e,n,s){let l=Fc(r,e,s),f=Fc(r,e,n);if(Math.sign(l)===Math.sign(f))return;let p=Fc(n,s,r),y=p+f-l;return Math.sign(p)!==Math.sign(y)?[p/(p-y),f/(f-l)]:void 0}function ph(r,e,n){let s=n*n;if(e.length===1)return r.distSqr(e[0])<s;for(let l=1;l<e.length;l++)if(of(r,e[l-1],e[l])<s)return!0;return!1}function of(r,e,n){let s=e.distSqr(n);if(s===0)return r.distSqr(e);let l=((r.x-e.x)*(n.x-e.x)+(r.y-e.y)*(n.y-e.y))/s;return r.distSqr(l<0?e:l>1?n:n.sub(e)._mult(l)._add(e))}function sf(r,e){let n,s,l,f=!1;for(let p=0;p<r.length;p++){n=r[p];for(let y=0,x=n.length-1;y<n.length;x=y++)s=n[y],l=n[x],s.y>e.y!=l.y>e.y&&e.x<(l.x-s.x)*(e.y-s.y)/(l.y-s.y)+s.x&&(f=!f)}return f}function vs(r,e){let n=!1;for(let s=0,l=r.length-1;s<r.length;l=s++){let f=r[s],p=r[l];f.y>e.y!=p.y>e.y&&e.x<(p.x-f.x)*(e.y-f.y)/(p.y-f.y)+f.x&&(n=!n)}return n}function Nc(r,e,n,s,l){for(let p of r)if(e<=p.x&&n<=p.y&&s>=p.x&&l>=p.y)return!0;let f=[new ot(e,n),new ot(e,l),new ot(s,l),new ot(s,n)];if(r.length>2){for(let p of f)if(vs(r,p))return!0}for(let p=0;p<r.length-1;p++)if(Dl(r[p],r[p+1],f))return!0;return!1}function Dl(r,e,n){let s=n[0],l=n[2];if(r.x<s.x&&e.x<s.x||r.x>l.x&&e.x>l.x||r.y<s.y&&e.y<s.y||r.y>l.y&&e.y>l.y)return!1;let f=Hn(r,e,n[0]);return f!==Hn(r,e,n[1])||f!==Hn(r,e,n[2])||f!==Hn(r,e,n[3])}function ka(r,e,n,s,l,f){let p=e.y-r.y,y=r.x-e.x;if(f=f||0){let x=p*p+y*y;if(x===0)return!0;let b=Math.sqrt(x);p/=b,y/=b}return!((n.x-r.x)*p+(n.y-r.y)*y-f<0||(s.x-r.x)*p+(s.y-r.y)*y-f<0||(l.x-r.x)*p+(l.y-r.y)*y-f<0)}function h1(r,e,n,s,l,f,p){return!(ka(r,e,s,l,f,p)||ka(e,n,s,l,f,p)||ka(n,r,s,l,f,p)||ka(s,l,r,e,n,p)||ka(l,f,r,e,n,p)||ka(f,s,r,e,n,p))}function af(r,e,n){let s=e.paint.get(r).value;return s.kind==="constant"?s.value:n.programConfigurations.get(e.id).getMaxValue(r)}function Vy(r){return Math.sqrt(r[0]*r[0]+r[1]*r[1])}function pS(r,e,n,s,l){if(!e[0]&&!e[1])return r;let f=ot.convert(e)._mult(l);n==="viewport"&&f._rotate(-s);let p=[];for(let y=0;y<r.length;y++)p.push(r[y].sub(f));return p}function mS(r,e,n,s){let l=ot.convert(r)._mult(s);return e==="viewport"&&l._rotate(-n),l}let gS,_S;function yS(r,e,n){var s=2*Math.PI*6378137/256/Math.pow(2,n);return[r*s-2*Math.PI*6378137/2,e*s-2*Math.PI*6378137/2]}pt(Bo,"CircleBucket",{omit:["layers"]});class mh{constructor(e,n,s){this.z=e,this.x=n,this.y=s,this.key=lf(0,e,e,n,s)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,n){let s=function(f,p,y){var x=yS(256*f,256*(p=Math.pow(2,y)-p-1),y),b=yS(256*(f+1),256*(p+1),y);return x[0]+","+x[1]+","+b[0]+","+b[1]}(this.x,this.y,this.z),l=function(f,p,y){let x,b="";for(let I=f;I>0;I--)x=1<<I-1,b+=(p&x?1:0)+(y&x?2:0);return b}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(n==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",l).replace("{bbox-epsg-3857}",s)}toString(){return`${this.z}/${this.x}/${this.y}`}}class vS{constructor(e,n){this.wrap=e,this.canonical=n,this.key=lf(e,n.z,n.z,n.x,n.y)}}class Vr{constructor(e,n,s,l,f){this.overscaledZ=e,this.wrap=n,this.canonical=new mh(s,+l,+f),this.key=n===0&&e===s?this.canonical.key:lf(n,e,s,l,f)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){let n=this.canonical.z-e;return e>this.canonical.z?new Vr(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Vr(e,this.wrap,e,this.canonical.x>>n,this.canonical.y>>n)}calculateScaledKey(e,n=!0){if(this.overscaledZ===e&&n)return this.key;if(e>this.canonical.z)return lf(this.wrap*+n,e,this.canonical.z,this.canonical.x,this.canonical.y);{let s=this.canonical.z-e;return lf(this.wrap*+n,e,e,this.canonical.x>>s,this.canonical.y>>s)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;let n=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>n&&e.canonical.y===this.canonical.y>>n}children(e){if(this.overscaledZ>=e)return[new Vr(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];let n=this.canonical.z+1,s=2*this.canonical.x,l=2*this.canonical.y;return[new Vr(n,this.wrap,n,s,l),new Vr(n,this.wrap,n,s+1,l),new Vr(n,this.wrap,n,s,l+1),new Vr(n,this.wrap,n,s+1,l+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new Vr(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new Vr(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new vS(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function lf(r,e,n,s,l){let f=1<<Math.min(n,22),p=f*(l%f)+s%f;return r&&n<22&&(p+=f*f*((r<0?-2*r-1:2*r)%(1<<2*(22-n)))),16*(32*p+n)+(e-n)}let wO=[r=>{let e=r.canonical.x-1,n=r.wrap;return e<0&&(e=(1<<r.canonical.z)-1,n--),new Vr(r.overscaledZ,n,r.canonical.z,e,r.canonical.y)},r=>{let e=r.canonical.x+1,n=r.wrap;return e===1<<r.canonical.z&&(e=0,n++),new Vr(r.overscaledZ,n,r.canonical.z,e,r.canonical.y)},r=>new Vr(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,(r.canonical.y===0?1<<r.canonical.z:r.canonical.y)-1),r=>new Vr(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,r.canonical.y===(1<<r.canonical.z)-1?0:r.canonical.y+1)];pt(mh,"CanonicalTileID"),pt(Vr,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});let EO=mn([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:jy}=EO,TO=mn([{name:"a_pos_3",components:3,type:"Int16"}]);var xS=mn([{name:"a_pos",type:"Int16",components:2}]);function Uy(r){return r*v/U}let IO=[new _n([P,P,P],[k,k,k]),new _n([P,P,P],[0,0,k]),new _n([0,P,P],[k,0,k]),new _n([P,0,P],[0,k,k]),new _n([0,0,P],[k,k,k])];function bS(r,e,n,s=!0){let l=pi([],r._camera.position,r.worldSize),f=[e,n,1,1];Or(f,f,r.pixelMatrixInverse),el(f,f,1/f[3]);let p=bi([],Vi([],f,l)),y=r.globeMatrix,x=[y[12],y[13],y[14]],b=Vi([],x,l),I=Pr(b),S=bi([],b),D=r.worldSize/(2*Math.PI),R=Bi(S,p),L=Math.asin(D/I);if(L<Math.acos(R)){if(!s)return null;let ge=[],xe=[];pi(ge,p,I/R),bi(xe,Vi(xe,ge,b)),bi(p,Ui(p,b,pi(p,xe,Math.tan(L)*I)))}let F=[];new ii(l,p).closestPointOnSphere(x,D,F);let V=bi([],wi(y,0)),$=bi([],wi(y,1)),Y=bi([],wi(y,2)),K=Bi(V,F),z=Bi($,F),W=Bi(Y,F),J=Ae(Math.asin(-z/D)),te=Ae(Math.atan2(K,W));te=r.center.lng+function(ge,xe){let ke=(xe-ge+180)%360-180;return ke<-180?ke+360:ke}(r.center.lng,te);let me=se(te),de=ae(oe(J),0,1);return new _e(me,de)}class SO{constructor(e,n,s){this.a=Vi([],e,s),this.b=Vi([],n,s),this.center=s;let l=bi([],this.a),f=bi([],this.b);this.angle=Math.acos(Bi(l,f))}}function d1(r,e){if(r.angle===0)return null;let n;return n=r.a[e]===0?1/r.angle*.5*Math.PI:1/r.angle*Math.atan(r.b[e]/r.a[e]/Math.sin(r.angle)-1/Math.tan(r.angle)),n<0||n>1?null:function(s,l,f,p){let y=Math.sin(f);return s*(Math.sin((1-p)*f)/y)+l*(Math.sin(p*f)/y)}(r.a[e],r.b[e],r.angle,ae(n,0,1))+r.center[e]}function Fa(r){if(r.z<=1)return IO[r.z+2*r.y+r.x];let e=f1(Hy(r));return _n.fromPoints(e)}function Cl(r,e,n){return pi(r,r,1-n),yo(r,r,e,n)}function wS(r,e,n){for(let s of r)ai(s,s,e),pi(s,s,n)}function ES(r,e,n,s){let l=e/r.worldSize,f=r.globeMatrix;if(n.z<=1){let de=Fa(n).getCorners();return wS(de,f,l),_n.fromPoints(de)}let p=Hy(n,s),y=f1(p,v+Uy(r._tileCoverLift));wS(y,f,l);let x=Number.MAX_VALUE,b=[-x,-x,-x],I=[x,x,x];if(p.contains(r.center)){for(let xe of y)As(I,I,xe),Go(b,b,xe);b[2]=0;let de=r.point,ge=[de.x*l,de.y*l,0];return As(I,I,ge),Go(b,b,ge),new _n(I,b)}if(r._tileCoverLift>0){for(let de of y)As(I,I,de),Go(b,b,de);return new _n(I,b)}let S=[f[12]*l,f[13]*l,f[14]*l],D=p.getCenter(),R=ae(r.center.lat,-85.051129,Be),L=ae(D.lat,-85.051129,Be),F=se(r.center.lng),V=oe(R),$=F-se(D.lng),Y=V-oe(L);$>.5?$-=1:$<-.5&&($+=1);let K=0;Math.abs($)>Math.abs(Y)?K=$>=0?1:3:(K=Y>=0?0:2,yo(S,S,[f[4]*l,f[5]*l,f[6]*l],-Math.sin(gn(Y>=0?p.getSouth():p.getNorth()))*v));let z=y[K],W=y[(K+1)%4],J=new SO(z,W,S),te=[d1(J,0)||z[0],d1(J,1)||z[1],d1(J,2)||z[2]],me=zc(r.zoom);if(me>0){let de=function({x:xe,y:ke,z:Xe},He,Ze,Ye,Ne){let qe=1/(1<<Xe),Le=xe*qe,Fe=Le+qe,Qe=ke*qe,tt=Qe+qe,Dt=0,vt=(Le+Fe)/2-Ye;return vt>.5?Dt=-1:vt<-.5&&(Dt=1),Le=((Le+Dt)*He-(Ye*=He))*Ze+Ye,Fe=((Fe+Dt)*He-Ye)*Ze+Ye,Qe=(Qe*He-(Ne*=He))*Ze+Ne,tt=(tt*He-Ne)*Ze+Ne,[[Le,tt,0],[Fe,tt,0],[Fe,Qe,0],[Le,Qe,0]]}(n,e,r._pixelsPerMercatorPixel,F,V);for(let xe=0;xe<y.length;xe++)Cl(y[xe],de[xe],me);let ge=Ui([],de[K],de[(K+1)%4]);pi(ge,ge,.5),Cl(te,ge,me)}for(let de of y)As(I,I,de),Go(b,b,de);return I[2]=Math.min(z[2],W[2]),As(I,I,te),Go(b,b,te),new _n(I,b)}function Hy({x:r,y:e,z:n},s=!1){let l=1/(1<<n),f=new Z(fe(r*l),e===(1<<n)-1&&s?-90:Te((e+1)*l)),p=new Z(fe((r+1)*l),e===0&&s?90:Te(e*l));return new ee(f,p)}function f1(r,e=v){let n=gn(r.getNorth()),s=gn(r.getSouth()),l=Math.cos(n),f=Math.cos(s),p=Math.sin(n),y=Math.sin(s),x=r.getWest(),b=r.getEast();return[j(f,y,x,e),j(f,y,b,e),j(l,p,b,e),j(l,p,x,e)]}function Bm(r,e,n,s){let l=1<<n.z,f=(r/at+n.x)/l;return B(Te((e/at+n.y)/l),fe(f),s)}function $y({min:r,max:e}){return C/Math.max(e[0]-r[0],e[1]-r[1],e[2]-r[2])}let TS=new Float64Array(16);function Gy(r){let e=$y(r),n=Cs(TS,[e,e,e]);return hn(n,n,Wl([],r.min))}function p1(r){let e=(s=r.min,(n=TS)[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=s[0],n[13]=s[1],n[14]=s[2],n[15]=1,n);var n,s;let l=1/$y(r);return sn(e,e,[l,l,l])}function m1(r){let e=at/(2*Math.PI);return r/(2*Math.PI)/e}function IS(r,e){return at/(512*Math.pow(2,r))*$y(Fa(e))}function SS(r,e,n,s,l){let f=m1(n),p=[r,e,-n/(2*Math.PI)],y=Se(new Float64Array(16));return hn(y,y,p),sn(y,y,[f,f,f]),Yi(y,y,gn(-l)),fr(y,y,gn(-s)),y}function zc(r){return ye(E,T,r)}function DS(r,e){let n=B(e.lat,e.lng),s=function(L){let F=B(L._center.lat,L._center.lng),V=er([],qn(0,1,0),F),$=la([],-L.angle,F);V=ai(V,V,$),la($,-L._pitch,V);let Y=bi([],F);return pi(Y,Y,Uy(L.cameraToCenterDistance/L.pixelsPerMeter)),ai(Y,Y,$),Ui([],F,Y)}(r);return p=(l=Qi([],s,n))[0],y=l[1],x=l[2],b=(f=n)[0],I=f[1],S=f[2],R=(D=Math.sqrt(p*p+y*y+x*x)*Math.sqrt(b*b+I*I+S*S))&&Bi(l,f)/D,Math.acos(Math.min(Math.max(R,-1),1));var l,f,p,y,x,b,I,S,D,R}function g1(r,e){return DS(r,e)>Math.PI/2*1.01}let CS=gn(85),DO=Math.cos(CS),CO=Math.sin(CS),MO=st(),MS=r=>{let e=[];return r.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),r.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function AS(r,e,n,s,l,f,p,y,x){if(f&&r.queryGeometry.isAboveHorizon)return!1;f&&(x*=r.pixelToTileUnitsFactor);let b=r.tileID.canonical,I=n.projection.upVectorScale(b,n.center.lat,n.worldSize).metersToTile;for(let S of e)for(let D of S){let R=D.add(y),L=l&&n.elevation?n.elevation.exaggeration()*l.getElevationAt(R.x,R.y,!0):0,F=n.projection.projectTilePoint(R.x,R.y,b);if(L>0){let K=n.projection.upVector(b,R.x,R.y);F.x+=K[0]*I*L,F.y+=K[1]*I*L,F.z+=K[2]*I*L}let V=f?R:AO(F.x,F.y,F.z,s),$=f?r.tilespaceRays.map(K=>PO(K,L)):r.queryGeometry.screenGeometry,Y=Or([],[F.x,F.y,F.z,1],s);if(!p&&f?x*=Y[3]/n.cameraToCenterDistance:p&&!f&&(x*=n.cameraToCenterDistance/Y[3]),f){let K=Te((D.y/at+b.y)/(1<<b.z));x/=n.projection.pixelsPerMeter(K,1)/he(1,K)}if(La($,V,x))return!0}return!1}function AO(r,e,n,s){let l=Or([],[r,e,n,1],s);return new ot(l[0]/l[3],l[1]/l[3])}let RS=qn(0,0,0),RO=qn(0,0,1);function PO(r,e){let n=ji();return RS[2]=e,r.intersectsPlane(RS,RO,n),new ot(n[0],n[1])}class PS extends Bo{}let LS,OS,kS,FS;function NS(r,{width:e,height:n},s,l){if(l){if(l instanceof Uint8ClampedArray)l=new Uint8Array(l.buffer);else if(l.length!==e*n*s)throw new RangeError("mismatched image size")}else l=new Uint8Array(e*n*s);return r.width=e,r.height=n,r.data=l,r}function zS(r,e,n){let{width:s,height:l}=e;s===r.width&&l===r.height||(_1(r,e,{x:0,y:0},{x:0,y:0},{width:Math.min(r.width,s),height:Math.min(r.height,l)},n,null),r.width=s,r.height=l,r.data=e.data)}function _1(r,e,n,s,l,f,p,y){if(l.width===0||l.height===0)return e;if(l.width>r.width||l.height>r.height||n.x>r.width-l.width||n.y>r.height-l.height)throw new RangeError("out of range source coordinates for image copy");if(l.width>e.width||l.height>e.height||s.x>e.width-l.width||s.y>e.height-l.height)throw new RangeError("out of range destination coordinates for image copy");let x=r.data,b=e.data,I=f===4&&y;for(let S=0;S<l.height;S++){let D=((n.y+S)*r.width+n.x)*f,R=((s.y+S)*e.width+s.x)*f;if(I)for(let L=0;L<l.width;L++){let F=D+L*f+3,V=R+L*f;b[V+0]=255,b[V+1]=255,b[V+2]=255,b[V+3]=x[F]}else if(p)for(let L=0;L<l.width;L++){let F=D+L*f,V=R+L*f,$=new In(x[F+0]/255,x[F+1]/255,x[F+2]/255,x[F+3]).toNonPremultipliedRenderColor(p).toArray();b[V+0]=$[0],b[V+1]=$[1],b[V+2]=$[2],b[V+3]=$[3]}else for(let L=0;L<l.width*f;L++)b[R+L]=x[D+L]}return e}pt(PS,"HeatmapBucket",{omit:["layers"]});class Bc{constructor(e,n){NS(this,e,1,n)}resize(e){zS(this,new Bc(e),1)}clone(){return new Bc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,n,s,l,f){_1(e,n,s,l,f,1,null)}}class pr{constructor(e,n){NS(this,e,4,n)}resize(e){zS(this,new pr(e),4)}replace(e,n){n?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new pr({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,n,s,l,f,p,y){_1(e,n,s,l,f,4,p,y)}}class BS{constructor(e,n){this.width=e.width,this.height=e.height,this.data=n instanceof Uint8Array?new Float32Array(n.buffer):n}}function Vm(r){let e={},n=r.resolution||256,s=r.clips?r.clips.length:1,l=r.image||new pr({width:n,height:s}),f=(p,y,x)=>{e[r.evaluationKey]=x;let b=r.expression.evaluate(e),I=b?b.toNonPremultipliedRenderColor(null):null;I&&(l.data[p+y+0]=Math.floor(255*I.r),l.data[p+y+1]=Math.floor(255*I.g),l.data[p+y+2]=Math.floor(255*I.b),l.data[p+y+3]=Math.floor(255*I.a))};if(r.clips)for(let p=0,y=0;p<s;++p,y+=4*n)for(let x=0,b=0;x<n;x++,b+=4){let I=x/(n-1),{start:S,end:D}=r.clips[p];f(y,b,S*(1-I)+D*I)}else for(let p=0,y=0;p<n;p++,y+=4)f(0,y,p/(n-1));return l}pt(Bc,"AlphaImage"),pt(pr,"RGBAImage");let LO=mn([{name:"a_pos",components:2,type:"Int16"}],4),OO=mn([{name:"a_road_z_offset",components:1,type:"Float32"}],4),kO=mn([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),FO=mn([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function jm(r,e,n=2){let s=e&&e.length,l=s?e[0]*n:r.length,f=VS(r,0,l,n,!0),p=[];if(!f||f.next===f.prev)return p;let y,x,b;if(s&&(f=function(I,S,D,R){let L=[];for(let F=0,V=S.length;F<V;F++){let $=VS(I,S[F]*R,F<V-1?S[F+1]*R:I.length,R,!1);$===$.next&&($.steiner=!0),L.push($O($))}L.sort(jO);for(let F=0;F<L.length;F++)D=UO(L[F],D);return D}(r,e,f,n)),r.length>80*n){y=1/0,x=1/0;let I=-1/0,S=-1/0;for(let D=n;D<l;D+=n){let R=r[D],L=r[D+1];R<y&&(y=R),L<x&&(x=L),R>I&&(I=R),L>S&&(S=L)}b=Math.max(I-y,S-x),b=b!==0?32767/b:0}return Um(f,p,n,y,x,b,0),p}function VS(r,e,n,s,l){let f;if(l===function(p,y,x,b){let I=0;for(let S=y,D=x-b;S<x;S+=b)I+=(p[D]-p[S])*(p[S+1]+p[D+1]),D=S;return I}(r,e,n,s)>0)for(let p=e;p<n;p+=s)f=$S(p/s|0,r[p],r[p+1],f);else for(let p=n-s;p>=e;p-=s)f=$S(p/s|0,r[p],r[p+1],f);return f&&cf(f,f.next)&&(Gm(f),f=f.next),f}function gh(r,e){if(!r)return r;e||(e=r);let n,s=r;do if(n=!1,s.steiner||!cf(s,s.next)&&tr(s.prev,s,s.next)!==0)s=s.next;else{if(Gm(s),s=e=s.prev,s===s.next)break;n=!0}while(n||s!==e);return e}function Um(r,e,n,s,l,f,p){if(!r)return;!p&&f&&function(x,b,I,S){let D=x;do D.z===0&&(D.z=y1(D.x,D.y,b,I,S)),D.prevZ=D.prev,D.nextZ=D.next,D=D.next;while(D!==x);D.prevZ.nextZ=null,D.prevZ=null,function(R){let L,F=1;do{let V,$=R;R=null;let Y=null;for(L=0;$;){L++;let K=$,z=0;for(let J=0;J<F&&(z++,K=K.nextZ,K);J++);let W=F;for(;z>0||W>0&&K;)z!==0&&(W===0||!K||$.z<=K.z)?(V=$,$=$.nextZ,z--):(V=K,K=K.nextZ,W--),Y?Y.nextZ=V:R=V,V.prevZ=Y,Y=V;$=K}Y.nextZ=null,F*=2}while(L>1)}(D)}(r,s,l,f);let y=r;for(;r.prev!==r.next;){let x=r.prev,b=r.next;if(f?zO(r,s,l,f):NO(r))e.push(x.i,r.i,b.i),Gm(r),r=b.next,y=b.next;else if((r=b)===y){p?p===1?Um(r=BO(gh(r),e),e,n,s,l,f,2):p===2&&VO(r,e,n,s,l,f):Um(gh(r),e,n,s,l,f,1);break}}}function NO(r){let e=r.prev,n=r,s=r.next;if(tr(e,n,s)>=0)return!1;let l=e.x,f=n.x,p=s.x,y=e.y,x=n.y,b=s.y,I=Math.min(l,f,p),S=Math.min(y,x,b),D=Math.max(l,f,p),R=Math.max(y,x,b),L=s.next;for(;L!==e;){if(L.x>=I&&L.x<=D&&L.y>=S&&L.y<=R&&Hm(l,y,f,x,p,b,L.x,L.y)&&tr(L.prev,L,L.next)>=0)return!1;L=L.next}return!0}function zO(r,e,n,s){let l=r.prev,f=r,p=r.next;if(tr(l,f,p)>=0)return!1;let y=l.x,x=f.x,b=p.x,I=l.y,S=f.y,D=p.y,R=Math.min(y,x,b),L=Math.min(I,S,D),F=Math.max(y,x,b),V=Math.max(I,S,D),$=y1(R,L,e,n,s),Y=y1(F,V,e,n,s),K=r.prevZ,z=r.nextZ;for(;K&&K.z>=$&&z&&z.z<=Y;){if(K.x>=R&&K.x<=F&&K.y>=L&&K.y<=V&&K!==l&&K!==p&&Hm(y,I,x,S,b,D,K.x,K.y)&&tr(K.prev,K,K.next)>=0||(K=K.prevZ,z.x>=R&&z.x<=F&&z.y>=L&&z.y<=V&&z!==l&&z!==p&&Hm(y,I,x,S,b,D,z.x,z.y)&&tr(z.prev,z,z.next)>=0))return!1;z=z.nextZ}for(;K&&K.z>=$;){if(K.x>=R&&K.x<=F&&K.y>=L&&K.y<=V&&K!==l&&K!==p&&Hm(y,I,x,S,b,D,K.x,K.y)&&tr(K.prev,K,K.next)>=0)return!1;K=K.prevZ}for(;z&&z.z<=Y;){if(z.x>=R&&z.x<=F&&z.y>=L&&z.y<=V&&z!==l&&z!==p&&Hm(y,I,x,S,b,D,z.x,z.y)&&tr(z.prev,z,z.next)>=0)return!1;z=z.nextZ}return!0}function BO(r,e){let n=r;do{let s=n.prev,l=n.next.next;!cf(s,l)&&US(s,n,n.next,l)&&$m(s,l)&&$m(l,s)&&(e.push(s.i,n.i,l.i),Gm(n),Gm(n.next),n=r=l),n=n.next}while(n!==r);return gh(n)}function VO(r,e,n,s,l,f){let p=r;do{let y=p.next.next;for(;y!==p.prev;){if(p.i!==y.i&&GO(p,y)){let x=HS(p,y);return p=gh(p,p.next),x=gh(x,x.next),Um(p,e,n,s,l,f,0),void Um(x,e,n,s,l,f,0)}y=y.next}p=p.next}while(p!==r)}function jO(r,e){let n=r.x-e.x;return n===0&&(n=r.y-e.y,n===0)&&(n=(r.next.y-r.y)/(r.next.x-r.x)-(e.next.y-e.y)/(e.next.x-e.x)),n}function UO(r,e){let n=function(l,f){let p=f,y=l.x,x=l.y,b,I=-1/0;if(cf(l,p))return p;do{if(cf(l,p.next))return p.next;if(x<=p.y&&x>=p.next.y&&p.next.y!==p.y){let F=p.x+(x-p.y)*(p.next.x-p.x)/(p.next.y-p.y);if(F<=y&&F>I&&(I=F,b=p.x<p.next.x?p:p.next,F===y))return b}p=p.next}while(p!==f);if(!b)return null;let S=b,D=b.x,R=b.y,L=1/0;p=b;do{if(y>=p.x&&p.x>=D&&y!==p.x&&jS(x<R?y:I,x,D,R,x<R?I:y,x,p.x,p.y)){let F=Math.abs(x-p.y)/(y-p.x);$m(p,l)&&(F<L||F===L&&(p.x>b.x||p.x===b.x&&HO(b,p)))&&(b=p,L=F)}p=p.next}while(p!==S);return b}(r,e);if(!n)return e;let s=HS(n,r);return gh(s,s.next),gh(n,n.next)}function HO(r,e){return tr(r.prev,r,e.prev)<0&&tr(e.next,r,r.next)<0}function y1(r,e,n,s,l){return(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=(r-n)*l|0)|r<<8))|r<<4))|r<<2))|r<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-s)*l|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function $O(r){let e=r,n=r;do(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next;while(e!==r);return n}function jS(r,e,n,s,l,f,p,y){return(l-p)*(e-y)>=(r-p)*(f-y)&&(r-p)*(s-y)>=(n-p)*(e-y)&&(n-p)*(f-y)>=(l-p)*(s-y)}function Hm(r,e,n,s,l,f,p,y){return!(r===p&&e===y)&&jS(r,e,n,s,l,f,p,y)}function GO(r,e){return r.next.i!==e.i&&r.prev.i!==e.i&&!function(n,s){let l=n;do{if(l.i!==n.i&&l.next.i!==n.i&&l.i!==s.i&&l.next.i!==s.i&&US(l,l.next,n,s))return!0;l=l.next}while(l!==n);return!1}(r,e)&&($m(r,e)&&$m(e,r)&&function(n,s){let l=n,f=!1,p=(n.x+s.x)/2,y=(n.y+s.y)/2;do l.y>y!=l.next.y>y&&l.next.y!==l.y&&p<(l.next.x-l.x)*(y-l.y)/(l.next.y-l.y)+l.x&&(f=!f),l=l.next;while(l!==n);return f}(r,e)&&(tr(r.prev,r,e.prev)||tr(r,e.prev,e))||cf(r,e)&&tr(r.prev,r,r.next)>0&&tr(e.prev,e,e.next)>0)}function tr(r,e,n){return(e.y-r.y)*(n.x-e.x)-(e.x-r.x)*(n.y-e.y)}function cf(r,e){return r.x===e.x&&r.y===e.y}function US(r,e,n,s){let l=Wy(tr(r,e,n)),f=Wy(tr(r,e,s)),p=Wy(tr(n,s,r)),y=Wy(tr(n,s,e));return l!==f&&p!==y||!(l!==0||!qy(r,n,e))||!(f!==0||!qy(r,s,e))||!(p!==0||!qy(n,r,s))||!(y!==0||!qy(n,e,s))}function qy(r,e,n){return e.x<=Math.max(r.x,n.x)&&e.x>=Math.min(r.x,n.x)&&e.y<=Math.max(r.y,n.y)&&e.y>=Math.min(r.y,n.y)}function Wy(r){return r>0?1:r<0?-1:0}function $m(r,e){return tr(r.prev,r,r.next)<0?tr(r,e,r.next)>=0&&tr(r,r.prev,e)>=0:tr(r,e,r.prev)<0||tr(r,r.next,e)<0}function HS(r,e){let n=v1(r.i,r.x,r.y),s=v1(e.i,e.x,e.y),l=r.next,f=e.prev;return r.next=e,e.prev=r,n.next=l,l.prev=n,s.next=n,n.prev=s,f.next=s,s.prev=f,s}function $S(r,e,n,s){let l=v1(r,e,n);return s?(l.next=s.next,l.prev=s,s.next.prev=l,s.next=l):(l.prev=l,l.next=l),l}function Gm(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function v1(r,e,n){return{i:r,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Zy(r,e){let n=r.length;if(n<=1)return[r];let s=[],l,f;for(let p=0;p<n;p++){let y=li(r[p]);y!==0&&(r[p].area=Math.abs(y),f===void 0&&(f=y<0),f===y<0?(l&&s.push(l),l=[r[p]]):l.push(r[p]))}if(l&&s.push(l),e>1)for(let p=0;p<s.length;p++)s[p].length<=e||(Er(s[p],e,1,s[p].length-1,qO),s[p]=s[p].slice(0,e));return s}function qO(r,e){return e.area-r.area}function GS(r,e,n=1){if(!r)return null;let s=typeof r=="string"?Yr.from(r).getPrimary():r.getPrimary(),l=typeof r=="string"?null:r.getSecondary();for(let f of[s,l]){if(!f)continue;let p=f.id.toString();e.has(p)||e.set(p,[]),f.scaleSelf(n),e.get(p).push(f)}return{primary:s.toString(),secondary:l?l.toString():null}}function x1(r,e,n,s){let l=s.patternDependencies,f=!1;for(let p of e){let y=p.paint.get(`${r}-pattern`);y.isConstant()||(f=!0),GS(y.constantOr(null),l,n)&&(f=!0)}return f}function b1(r,e,n,s,l,f){let p=f.patternDependencies;for(let y of e){let x=y.paint.get(`${r}-pattern`).value;if(x.kind!=="constant"){let b=x.evaluate({zoom:s},n,{},f.availableImages);b=b&&b.name?b.name:b;let I=GS(b,p,l);if(!I)continue;let{primary:S,secondary:D}=I;S&&(n.patterns[y.id]=[S,D].filter(Boolean))}}return n}class qS{constructor(){this.polygons=new Map}add(e,...n){this.polygons.has(e)?this.polygons.get(e).push(...n):this.polygons.set(e,n)}merge(e){for(let[n,s]of e.polygons)this.add(n,...s)}}class _h{constructor(){this.portals=[]}static evaluate(e){if(e.length===0)return new _h;let n=[];for(let b of e)n.push(...b.portals);if(n.length===0)return new _h;let s=(b,I)=>b<=0&&I<=0||b>=at&&I>=at;for(let b of n){let I=b.va,S=b.vb;(s(I.x,S.x)||s(I.y,S.y))&&(b.type="border")}let l=n.filter(b=>b.type!=="unevaluated"),f=n.filter(b=>b.type==="unevaluated");if(f.length===0)return new _h;f.sort((b,I)=>b.hash===I.hash?b.isTunnel===I.isTunnel?0:b.isTunnel?-1:1:b.hash<I.hash?1:-1),n=l.concat(f);let p=l.length,y=p,x=p;do if(y++,y===n.length||n[p].hash!==n[y].hash){if(y-p==2){x<p&&(n[x]=n[p],n[p]=null);let b=n[x],I=n[y-1];b.type=b.isTunnel!==I.isTunnel?"tunnel":"polygon",b.connection={a:b.connection.a,b:I.connection.a},x++}p=y}while(p!==n.length);return n.splice(x),n.sort((b,I)=>b.hash<I.hash?1:-1),{portals:n}}}pt(_h,"ElevationPortalGraph"),pt(qS,"ElevationPolygons");class WO{constructor(e,n,s){this.outPositions=e,this.outNormals=n,this.outIndices=s,this.vertexLookup=new Map,this.buffer=new ArrayBuffer(4),this.view=new DataView(this.buffer)}addVertex(e,n,s){let l=e[2];s!=null&&(l*=s);let f=this.getVec3Bits(e)<<96n|this.getVec3Bits(n),p=this.vertexLookup.get(f);if(p!=null)return p;let y=this.outPositions.length;this.vertexLookup.set(f,y);let x=Math.trunc(16384*n[0]),b=Math.trunc(16384*n[1]),I=Math.trunc(16384*n[2]);return this.outPositions.emplaceBack(e[0],e[1],l),this.outNormals.emplaceBack(x,b,I),y}addVertices(e,n,...s){let l=[];for(let f of s){let p=this.addVertex(f,e,n);l.push(p)}return l}addTriangles(e,n,s){if(n&&s){let l=s.length===1,f=qn(0,0,0);for(let p=0;p<e.length;p+=3){let y=n[e[p+0]],x=n[e[p+1]],b=n[e[p+2]],I=l?s[0]:s[e[p+1]],S=l?s[0]:s[e[p+2]],D=this.addVertex(qn(y.x,y.y,l?s[0]:s[e[p+0]]),f),R=this.addVertex(qn(x.x,x.y,I),f),L=this.addVertex(qn(b.x,b.y,S),f);this.outIndices.emplaceBack(D,R,L)}}else for(let l=0;l<e.length;l+=3)this.outIndices.emplaceBack(e[l+0],e[l+1],e[l+2])}addQuad(e,n){let s=this.addVertices(n,void 0,...e.map(x=>qn(x.coord.x,x.coord.y,x.height))),[l,f,p,y]=s;this.addTriangles([l,f,p,p,y,l])}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}getBits(e){return this.view.setFloat32(0,e),BigInt(this.view.getUint32(0))}getVec3Bits(e){return this.getBits(e[0])<<64n|this.getBits(e[1])<<32n|this.getBits(e[2])}}class Vo{constructor(e,n,s,l){this.unevaluatedPortals=new _h,this.portalPolygons=new qS,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new Em,this.vertexNormals=new Wd,this.indexArray=new cr,this.tileToMeters=Oe(e),this.bridgeProgramConfigurations=new u(n,{zoom:s,lut:l},f=>f!=="fill-tunnel-structure-color"),this.tunnelProgramConfigurations=new u(n,{zoom:s,lut:l},f=>f!=="fill-bridge-guard-rail-color")}addVertices(e,n){let s=this.unevalVertices.length;for(let l=0;l<e.length;l++)this.unevalVertices.push(e[l]),this.unevalHeights.push(n[l]);return s}addTriangles(e,n,s){let l=s?this.unevalTunnelTriangles:this.unevalTriangles;for(let f of e)l.push(f+n)}addRenderableRing(e,n,s,l,f,p){let y=[new ot(f.min.x,f.min.y),new ot(f.max.x,f.min.y),new ot(f.max.x,f.max.y),new ot(f.min.x,f.max.y)];for(let x=0;x<s-1;x++){let b=n+x,I=b+1,S=this.unevalVertices[b],D=this.unevalVertices[I];if(!(S.x>=f.min.x&&S.x<=f.max.x&&S.y>=f.min.y&&S.y<=f.max.y||D.x>=f.min.x&&D.x<=f.max.x&&D.y>=f.min.y&&D.y<=f.max.y||Dl(S,D,y))||this.isOnBorder(S.x,D.x)||this.isOnBorder(S.y,D.y))continue;let R=Vo.computeEdgeHash(this.unevalVertices[b],this.unevalVertices[I]),L,F=this.vertexHashLookup.get(Vo.computePosHash(S));F!=null?L=F.next:(F=this.vertexHashLookup.get(Vo.computePosHash(D)),L=F!=null?F.prev:R),this.unevalEdges.push({polygonIdx:e,a:b,b:I,hash:R,portalHash:L,isTunnel:l,type:"unevaluated",featureInfo:p})}}addPortalCandidates(e,n,s,l,f){if(n.length===0)return;this.portalPolygons.add(e,{geometry:n,zLevel:f});let p=n[0];this.vertexHashLookup.clear();let y=Vo.computeEdgeHash(p[p.length-2],p[p.length-1]);for(let x=0;x<p.length-1;x++){let b=p[x+0],I=p[x+1],S=Lo(I.x-b.x,I.y-b.y),D=pa(S);if(D===0)continue;let R="unevaluated",L=l.pointElevation(b),F=l.pointElevation(I);Math.abs(L)<.01&&Math.abs(F)<.01?R="entrance":(this.isOnBorder(b.x,I.x)||this.isOnBorder(b.y,I.y))&&(R="border");let V=Vo.computeEdgeHash(b,I);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:b,vb:I,vab:S,length:D,hash:V,isTunnel:s,type:R});let $=Vo.computePosHash(b);this.vertexHashLookup.set($,{prev:y,next:V}),y=V}}construct(e){if(this.unevalVertices.length===0)return;let n=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),s=D=>{D.primitiveLength=this.indexArray.length-D.primitiveOffset},l=new WO(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);let f=n(),p=n(),y=n(),x=(D,R)=>{D.sort((F,V)=>F.type===R&&V.type!==R?-1:F.type!==R&&V.type===R?1:0);let L=D.findIndex(F=>F.type!==R);return L>=0?L:D.length},b=0;this.unevalEdges.length>0&&(b=x(this.unevalEdges,"none"),this.constructBridgeStructures(l,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:b},this.tileToMeters)),s(y);let I=n(),S=n();if(this.unevalEdges.length>0){let D=this.unevalEdges.splice(b),R=x(D,"tunnel")+b;this.unevalEdges.push(...D),this.constructTunnelStructures(l,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:b},{min:b,max:R})}s(I),l.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),s(S),l.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),s(p),l.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),s(f),this.maskSegments=Di.simpleSegment(0,S.primitiveOffset,0,S.primitiveLength),this.depthSegments=Di.simpleSegment(0,p.primitiveOffset,0,p.primitiveLength),this.renderableBridgeSegments=Di.simpleSegment(0,y.primitiveOffset,0,y.primitiveLength),this.renderableTunnelSegments=Di.simpleSegment(0,I.primitiveOffset,0,I.primitiveLength),this.shadowCasterSegments=Di.simpleSegment(0,f.primitiveOffset,0,f.primitiveLength)}update(e,n,s,l,f,p,y,x){this.bridgeProgramConfigurations.updatePaintArrays(e,n,f,s,l,p,y,x),this.tunnelProgramConfigurations.updatePaintArrays(e,n,f,s,l,p,y,x)}upload(e){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,kO.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,FO.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(e),this.tunnelProgramConfigurations.upload(e))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(e,n,s,l,f){let p=(y,x)=>{for(let b=0;b<x.length-1;b++){let I=x[b].featureIndex,S=x[b+1].vertexStart,D=e.feature(I);y.populatePaintArrays(S,D,I,{},s,n,l,void 0,f)}};p(this.bridgeProgramConfigurations,this.bridgeFeatureSections),p(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(e,n,s,l,f){let p=new Map;for(let y=l;y<f;y++){let x=s[y],b=x.a,I=x.b,S=Vo.computePosHash(e[b]),D=Vo.computePosHash(e[I]);p.has(S)||p.set(S,{}),p.has(D)||p.set(D,{});let R=p.get(S),L=p.get(D);n[b]<=0&&n[I]<=0||(R.to=I,L.from=b)}return p}constructBridgeStructures(e,n,s,l,f,p){e.clearVertexLookup();let y=this.computeVertexConnections(n,s,l,f.min,f.max),x=1/p,b=.5*x,I=R=>qn(n[R].x,n[R].y,s[R]*x),S=R=>{let L=y.get(Vo.computePosHash(n[R])),F=L.from,V=L.to;if(!F||!V)return;let $=I(F),Y=I(R),K=I(V),z=qn(0,0,0);if(!Wo($,Y)){let J=Vi(ji(),Y,$);Ui(z,z,bi(J,J))}if(!Wo(K,Y)){let J=Vi(ji(),K,Y);Ui(z,z,bi(J,J))}let W=ca(z);return W>0?pi(z,z,1/W):void 0},D=Number.POSITIVE_INFINITY;this.sortSubarray(l,f.min,f.max,(R,L)=>R.featureInfo.featureIndex-L.featureInfo.featureIndex);for(let R=f.min;R<f.max;R++){let L=l[R];if(!L.featureInfo.guardRailEnabled)continue;let F=this.prepareEdgePoints(n,s,L,(jt,yt)=>jt>yt);if(F==null)continue;let V=F[0],$=F[1],Y=qn(V.coord.x,V.coord.y,x*V.height),K=qn($.coord.x,$.coord.y,x*$.height);if(Wo(Y,K))continue;let z=Vi(ji(),K,Y);bi(z,z);let W=jt=>bi(jt,jt),J=S(L.a)||z,te=S(L.b)||z,me=W(qn(J[1],-J[0],0)),de=W(qn(te[1],-te[0],0)),ge=W(er(ji(),me,J)),xe=W(er(ji(),de,te)),ke=ji(),Xe=[Ui(ji(),Y,pi(ke,Vi(ke,me,ge),b)),Ui(ji(),Y,pi(ke,Ui(ke,me,ge),b)),Ui(ji(),Y,pi(ke,ge,b)),Y],He=[Ui(ji(),K,pi(ke,Vi(ke,de,xe),b)),Ui(ji(),K,pi(ke,Ui(ke,de,xe),b)),Ui(ji(),K,pi(ke,xe,b)),K];D=this.addFeatureSection(L.featureInfo.featureIndex,D,this.bridgeFeatureSections,e);let[Ze,Ye]=e.addVertices(me,p,Xe[0],Xe[1]),[Ne,qe]=e.addVertices(de,p,He[0],He[1]);e.addTriangles([Ze,Ye,Ne,Ye,qe,Ne]);let[Le,Fe]=e.addVertices(ge,p,Xe[1],Xe[2]),[Qe,tt]=e.addVertices(xe,p,He[1],He[2]);e.addTriangles([Le,Fe,Qe,Fe,tt,Qe]);let[Dt,vt]=e.addVertices(Wl(me,me),p,Xe[2],Xe[3]),[ct,Je]=e.addVertices(Wl(de,de),p,He[2],He[3]);e.addTriangles([Dt,vt,ct,vt,Je,ct])}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}constructTunnelStructures(e,n,s,l,f,p){e.clearVertexLookup();let y=Number.POSITIVE_INFINITY,x=(I,S)=>I.featureInfo.featureIndex-S.featureInfo.featureIndex;this.sortSubarray(l,f.min,f.max,x),this.sortSubarray(l,p.min,p.max,x);let b=I=>bi(I,I);for(let I=f.min;I<f.max;I++){let S=this.prepareEdgePoints(n,s,l[I],(F,V)=>F<V);if(S==null)continue;let[D,R]=S,L=b(qn(-(R.coord.y-D.coord.y),R.coord.x-D.coord.x,0));y=this.addFeatureSection(l[I].featureInfo.featureIndex,y,this.tunnelFeatureSections,e),e.addQuad([D,R,{coord:R.coord,height:l[I].isTunnel?-.1:0},{coord:D.coord,height:l[I].isTunnel?-.1:0}],L)}for(let I=p.min;I<p.max;I++){let S=l[I];S.isTunnel&&([S.a,S.b]=[S.b,S.a]);let D=n[S.a],R=n[S.b],L=b(qn(-(R.y-D.y),R.x-D.x,0));y=this.addFeatureSection(S.featureInfo.featureIndex,y,this.tunnelFeatureSections,e),e.addQuad([{coord:R,height:0},{coord:D,height:0},{coord:D,height:s[S.a]+4},{coord:R,height:s[S.b]+4}],L),e.addQuad([{coord:D,height:0},{coord:R,height:0},{coord:R,height:s[S.b]+4},{coord:D,height:s[S.a]+4}],L)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}prepareEdgePoints(e,n,s,l){let f=n[s.a],p=n[s.b],y=l(f,0),x=l(p,0);if(y&&x)return[{coord:e[s.a],height:f},{coord:e[s.b],height:p}];if(!y&&!x)return;let b=e[s.a].clone(),I=e[s.b].clone();if(y){if(!x){let S=p/(p-f);I.x=kt(I.x,b.x,S),I.y=kt(I.y,b.y,S),p=kt(p,f,S)}}else{let S=f/(f-p);b.x=kt(b.x,I.x,S),b.y=kt(b.y,I.y,S),f=kt(f,p,S)}return[{coord:b,height:f},{coord:I,height:p}]}prepareEdges(e,n){if(n.length===0)return;n.sort((y,x)=>y.hash===x.hash?x.polygonIdx-y.polygonIdx:x.hash>y.hash?1:-1);let s=0,l=0,f=0,p=n[s].polygonIdx;do l++,(l===n.length||n[s].hash!==n[l].hash)&&((l-s==1||n[l-1].polygonIdx!==p)&&(f<s&&(n[f]=n[s],n[s]=null),n[f].type="none",f++),s=l,s!==n.length&&(p=n[s].polygonIdx));while(s!==n.length);if(n.splice(f),n.length!==0&&e.length!==0){n.sort((b,I)=>b.portalHash<I.portalHash?1:-1);let y=0,x=0;for(;y!==n.length&&x!==e.length;){let b=n[y],I=e[x];b.portalHash>I.hash?y++:I.hash>b.portalHash?x++:(b.type=I.type,y++)}}}isOnBorder(e,n){return e<=0&&n<=0||e>=at&&n>=at}addFeatureSection(e,n,s,l){return e!==n&&(n=e,s.push({featureIndex:e,vertexStart:l.getVertexCount()}),l.clearVertexLookup()),n}sortSubarray(e,n,s,l){let f=e.slice(n,s);f.sort(l),e.splice(n,f.length,...f)}static computeEdgeHash(e,n){return(e.y===n.y&&e.x>n.x||e.y>n.y)&&([e,n]=[n,e]),BigInt(Vo.computePosHash(e))<<32n|BigInt(Vo.computePosHash(n))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}var WS,ZS={exports:{}},XS=(WS||(WS=1,function(r,e){(function(n){function s(Q,ne){return Q>ne?1:Q<ne?-1:0}var l=function(Q,ne){Q===void 0&&(Q=s),ne===void 0&&(ne=!1),this._compare=Q,this._root=null,this._size=0,this._noDuplicates=!!ne},f={size:{configurable:!0}};function p(Q,ne,ze,it,ut){var lt=ut-it;if(lt>0){var _t=it+Math.floor(lt/2),Ot={key:ne[_t],data:ze[_t],parent:Q};return Ot.left=p(Ot,ne,ze,it,_t),Ot.right=p(Ot,ne,ze,_t+1,ut),Ot}return null}function y(Q,ne,ze,it,ut){if(!(ze>=it)){for(var lt=Q[ze+it>>1],_t=ze-1,Ot=it+1;;){do _t++;while(ut(Q[_t],lt)<0);do Ot--;while(ut(Q[Ot],lt)>0);if(_t>=Ot)break;var an=Q[_t];Q[_t]=Q[Ot],Q[Ot]=an,an=ne[_t],ne[_t]=ne[Ot],ne[Ot]=an}y(Q,ne,ze,Ot,ut),y(Q,ne,Ot+1,it,ut)}}l.prototype.rotateLeft=function(Q){var ne=Q.right;ne&&(Q.right=ne.left,ne.left&&(ne.left.parent=Q),ne.parent=Q.parent),Q.parent?Q===Q.parent.left?Q.parent.left=ne:Q.parent.right=ne:this._root=ne,ne&&(ne.left=Q),Q.parent=ne},l.prototype.rotateRight=function(Q){var ne=Q.left;ne&&(Q.left=ne.right,ne.right&&(ne.right.parent=Q),ne.parent=Q.parent),Q.parent?Q===Q.parent.left?Q.parent.left=ne:Q.parent.right=ne:this._root=ne,ne&&(ne.right=Q),Q.parent=ne},l.prototype._splay=function(Q){for(;Q.parent;){var ne=Q.parent;ne.parent?ne.left===Q&&ne.parent.left===ne?(this.rotateRight(ne.parent),this.rotateRight(ne)):ne.right===Q&&ne.parent.right===ne?(this.rotateLeft(ne.parent),this.rotateLeft(ne)):ne.left===Q&&ne.parent.right===ne?(this.rotateRight(ne),this.rotateLeft(ne)):(this.rotateLeft(ne),this.rotateRight(ne)):ne.left===Q?this.rotateRight(ne):this.rotateLeft(ne)}},l.prototype.splay=function(Q){for(var ne,ze,it,ut,lt;Q.parent;)(ze=(ne=Q.parent).parent)&&ze.parent?((it=ze.parent).left===ze?it.left=Q:it.right=Q,Q.parent=it):(Q.parent=null,this._root=Q),ut=Q.left,lt=Q.right,Q===ne.left?(ze&&(ze.left===ne?(ne.right?(ze.left=ne.right,ze.left.parent=ze):ze.left=null,ne.right=ze,ze.parent=ne):(ut?(ze.right=ut,ut.parent=ze):ze.right=null,Q.left=ze,ze.parent=Q)),lt?(ne.left=lt,lt.parent=ne):ne.left=null,Q.right=ne,ne.parent=Q):(ze&&(ze.right===ne?(ne.left?(ze.right=ne.left,ze.right.parent=ze):ze.right=null,ne.left=ze,ze.parent=ne):(lt?(ze.left=lt,lt.parent=ze):ze.left=null,Q.right=ze,ze.parent=Q)),ut?(ne.right=ut,ut.parent=ne):ne.right=null,Q.left=ne,ne.parent=Q)},l.prototype.replace=function(Q,ne){Q.parent?Q===Q.parent.left?Q.parent.left=ne:Q.parent.right=ne:this._root=ne,ne&&(ne.parent=Q.parent)},l.prototype.minNode=function(Q){if(Q===void 0&&(Q=this._root),Q)for(;Q.left;)Q=Q.left;return Q},l.prototype.maxNode=function(Q){if(Q===void 0&&(Q=this._root),Q)for(;Q.right;)Q=Q.right;return Q},l.prototype.insert=function(Q,ne){var ze=this._root,it=null,ut=this._compare;if(this._noDuplicates)for(;ze;){if(it=ze,ut(ze.key,Q)===0)return;ze=ut(ze.key,Q)<0?ze.right:ze.left}else for(;ze;)it=ze,ze=ut(ze.key,Q)<0?ze.right:ze.left;return ze={key:Q,data:ne,left:null,right:null,parent:it},it?ut(it.key,ze.key)<0?it.right=ze:it.left=ze:this._root=ze,this.splay(ze),this._size++,ze},l.prototype.find=function(Q){for(var ne=this._root,ze=this._compare;ne;){var it=ze(ne.key,Q);if(it<0)ne=ne.right;else{if(!(it>0))return ne;ne=ne.left}}return null},l.prototype.contains=function(Q){for(var ne=this._root,ze=this._compare;ne;){var it=ze(Q,ne.key);if(it===0)return!0;ne=it<0?ne.left:ne.right}return!1},l.prototype.remove=function(Q){var ne=this.find(Q);if(!ne)return!1;if(this.splay(ne),ne.left)if(ne.right){var ze=this.minNode(ne.right);ze.parent!==ne&&(this.replace(ze,ze.right),ze.right=ne.right,ze.right.parent=ze),this.replace(ne,ze),ze.left=ne.left,ze.left.parent=ze}else this.replace(ne,ne.left);else this.replace(ne,ne.right);return this._size--,!0},l.prototype.removeNode=function(Q){if(!Q)return!1;if(this.splay(Q),Q.left)if(Q.right){var ne=this.minNode(Q.right);ne.parent!==Q&&(this.replace(ne,ne.right),ne.right=Q.right,ne.right.parent=ne),this.replace(Q,ne),ne.left=Q.left,ne.left.parent=ne}else this.replace(Q,Q.left);else this.replace(Q,Q.right);return this._size--,!0},l.prototype.erase=function(Q){var ne=this.find(Q);if(ne){this.splay(ne);var ze=ne.left,it=ne.right,ut=null;ze&&(ze.parent=null,ut=this.maxNode(ze),this.splay(ut),this._root=ut),it&&(ze?ut.right=it:this._root=it,it.parent=ut),this._size--}},l.prototype.pop=function(){var Q=this._root,ne=null;if(Q){for(;Q.left;)Q=Q.left;ne={key:Q.key,data:Q.data},this.remove(Q.key)}return ne},l.prototype.next=function(Q){var ne=Q;if(ne)if(ne.right)for(ne=ne.right;ne&&ne.left;)ne=ne.left;else for(ne=Q.parent;ne&&ne.right===Q;)Q=ne,ne=ne.parent;return ne},l.prototype.prev=function(Q){var ne=Q;if(ne)if(ne.left)for(ne=ne.left;ne&&ne.right;)ne=ne.right;else for(ne=Q.parent;ne&&ne.left===Q;)Q=ne,ne=ne.parent;return ne},l.prototype.forEach=function(Q){for(var ne=this._root,ze=[],it=!1,ut=0;!it;)ne?(ze.push(ne),ne=ne.left):ze.length>0?(Q(ne=ze.pop(),ut++),ne=ne.right):it=!0;return this},l.prototype.range=function(Q,ne,ze,it){for(var ut=[],lt=this._compare,_t=this._root;ut.length!==0||_t;)if(_t)ut.push(_t),_t=_t.left;else{if(lt((_t=ut.pop()).key,ne)>0)break;if(lt(_t.key,Q)>=0&&ze.call(it,_t))return this;_t=_t.right}return this},l.prototype.keys=function(){for(var Q=this._root,ne=[],ze=[],it=!1;!it;)Q?(ne.push(Q),Q=Q.left):ne.length>0?(Q=ne.pop(),ze.push(Q.key),Q=Q.right):it=!0;return ze},l.prototype.values=function(){for(var Q=this._root,ne=[],ze=[],it=!1;!it;)Q?(ne.push(Q),Q=Q.left):ne.length>0?(Q=ne.pop(),ze.push(Q.data),Q=Q.right):it=!0;return ze},l.prototype.at=function(Q){for(var ne=this._root,ze=[],it=!1,ut=0;!it;)if(ne)ze.push(ne),ne=ne.left;else if(ze.length>0){if(ne=ze.pop(),ut===Q)return ne;ut++,ne=ne.right}else it=!0;return null},l.prototype.load=function(Q,ne,ze){if(Q===void 0&&(Q=[]),ne===void 0&&(ne=[]),ze===void 0&&(ze=!1),this._size!==0)throw new Error("bulk-load: tree is not empty");var it=Q.length;return ze&&y(Q,ne,0,it-1,this._compare),this._root=p(null,Q,ne,0,it),this._size=it,this},l.prototype.min=function(){var Q=this.minNode(this._root);return Q?Q.key:null},l.prototype.max=function(){var Q=this.maxNode(this._root);return Q?Q.key:null},l.prototype.isEmpty=function(){return this._root===null},f.size.get=function(){return this._size},l.createTree=function(Q,ne,ze,it,ut){return new l(ze,ut).load(Q,ne,it)},Object.defineProperties(l.prototype,f);var x=0,b=1,I=2,S=3,D=0,R=1,L=2,F=3;function V(Q,ne,ze){ne===null?(Q.inOut=!1,Q.otherInOut=!0):(Q.isSubject===ne.isSubject?(Q.inOut=!ne.inOut,Q.otherInOut=ne.otherInOut):(Q.inOut=!ne.otherInOut,Q.otherInOut=ne.isVertical()?!ne.inOut:ne.inOut),ne&&(Q.prevInResult=!$(ne,ze)||ne.isVertical()?ne.prevInResult:ne));var it=$(Q,ze);Q.resultTransition=it?function(ut,lt){var _t,Ot=!ut.inOut,an=!ut.otherInOut;switch(lt){case D:_t=Ot&&an;break;case R:_t=Ot||an;break;case F:_t=Ot^an;break;case L:_t=ut.isSubject?Ot&&!an:an&&!Ot}return _t?1:-1}(Q,ze):0}function $(Q,ne){switch(Q.type){case x:switch(ne){case D:return!Q.otherInOut;case R:return Q.otherInOut;case L:return Q.isSubject&&Q.otherInOut||!Q.isSubject&&!Q.otherInOut;case F:return!0}break;case I:return ne===D||ne===R;case S:return ne===L;case b:return!1}return!1}var Y=function(Q,ne,ze,it,ut){this.left=ne,this.point=Q,this.otherEvent=ze,this.isSubject=it,this.type=ut||x,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},K={inResult:{configurable:!0}};function z(Q,ne){return Q[0]===ne[0]&&Q[1]===ne[1]}Y.prototype.isBelow=function(Q){var ne=this.point,ze=this.otherEvent.point;return this.left?(ne[0]-Q[0])*(ze[1]-Q[1])-(ze[0]-Q[0])*(ne[1]-Q[1])>0:(ze[0]-Q[0])*(ne[1]-Q[1])-(ne[0]-Q[0])*(ze[1]-Q[1])>0},Y.prototype.isAbove=function(Q){return!this.isBelow(Q)},Y.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},K.inResult.get=function(){return this.resultTransition!==0},Y.prototype.clone=function(){var Q=new Y(this.point,this.left,this.otherEvent,this.isSubject,this.type);return Q.contourId=this.contourId,Q.resultTransition=this.resultTransition,Q.prevInResult=this.prevInResult,Q.isExteriorRing=this.isExteriorRing,Q.inOut=this.inOut,Q.otherInOut=this.otherInOut,Q},Object.defineProperties(Y.prototype,K);var W=11102230246251565e-32,J=134217729,te=(3+8*W)*W;function me(Q,ne,ze,it,ut){var lt,_t,Ot,an,ln=ne[0],Yt=it[0],Pn=0,Zn=0;Yt>ln==Yt>-ln?(lt=ln,ln=ne[++Pn]):(lt=Yt,Yt=it[++Zn]);var cn=0;if(Pn<Q&&Zn<ze)for(Yt>ln==Yt>-ln?(Ot=lt-((_t=ln+lt)-ln),ln=ne[++Pn]):(Ot=lt-((_t=Yt+lt)-Yt),Yt=it[++Zn]),lt=_t,Ot!==0&&(ut[cn++]=Ot);Pn<Q&&Zn<ze;)Yt>ln==Yt>-ln?(Ot=lt-((_t=lt+ln)-(an=_t-lt))+(ln-an),ln=ne[++Pn]):(Ot=lt-((_t=lt+Yt)-(an=_t-lt))+(Yt-an),Yt=it[++Zn]),lt=_t,Ot!==0&&(ut[cn++]=Ot);for(;Pn<Q;)Ot=lt-((_t=lt+ln)-(an=_t-lt))+(ln-an),ln=ne[++Pn],lt=_t,Ot!==0&&(ut[cn++]=Ot);for(;Zn<ze;)Ot=lt-((_t=lt+Yt)-(an=_t-lt))+(Yt-an),Yt=it[++Zn],lt=_t,Ot!==0&&(ut[cn++]=Ot);return lt===0&&cn!==0||(ut[cn++]=lt),cn}function de(Q){return new Float64Array(Q)}var ge=33306690738754716e-32,xe=22204460492503146e-32,ke=11093356479670487e-47,Xe=de(4),He=de(8),Ze=de(12),Ye=de(16),Ne=de(4);function qe(Q,ne,ze){var it=function(ut,lt,_t,Ot,an,ln){var Yt=(lt-ln)*(_t-an),Pn=(ut-an)*(Ot-ln),Zn=Yt-Pn;if(Yt===0||Pn===0||Yt>0!=Pn>0)return Zn;var cn=Math.abs(Yt+Pn);return Math.abs(Zn)>=ge*cn?Zn:-function(vi,ei,Mn,Li,oi,Xn,ti){var Fn,Jt,Bn,xi,Rt,fn,si,Mi,di,Zi,jn,Gi,uo,mr,hr,ho,Ba,Xi,Ji=vi-oi,gr=Mn-oi,jr=ei-Xn,Sr=Li-Xn;Xe[0]=(hr=(Mi=Ji-(si=(fn=J*Ji)-(fn-Ji)))*(Zi=Sr-(di=(fn=J*Sr)-(fn-Sr)))-((mr=Ji*Sr)-si*di-Mi*di-si*Zi))-((jn=hr-(Ba=(Mi=jr-(si=(fn=J*jr)-(fn-jr)))*(Zi=gr-(di=(fn=J*gr)-(fn-gr)))-((ho=jr*gr)-si*di-Mi*di-si*Zi)))+(Rt=hr-jn))+(Rt-Ba),Xe[1]=(uo=mr-((Gi=mr+jn)-(Rt=Gi-mr))+(jn-Rt))-((jn=uo-ho)+(Rt=uo-jn))+(Rt-ho),Xe[2]=Gi-((Xi=Gi+jn)-(Rt=Xi-Gi))+(jn-Rt),Xe[3]=Xi;var Gc=function(e6,rA){for(var oA=rA[0],Sw=1;Sw<4;Sw++)oA+=rA[Sw];return oA}(0,Xe),vg=xe*ti;if(Gc>=vg||-Gc>=vg||(Fn=vi-(Ji+(Rt=vi-Ji))+(Rt-oi),Bn=Mn-(gr+(Rt=Mn-gr))+(Rt-oi),Jt=ei-(jr+(Rt=ei-jr))+(Rt-Xn),xi=Li-(Sr+(Rt=Li-Sr))+(Rt-Xn),Fn===0&&Jt===0&&Bn===0&&xi===0)||(vg=ke*ti+te*Math.abs(Gc),(Gc+=Ji*xi+Sr*Fn-(jr*Bn+gr*Jt))>=vg||-Gc>=vg))return Gc;Ne[0]=(hr=(Mi=Fn-(si=(fn=J*Fn)-(fn-Fn)))*(Zi=Sr-(di=(fn=J*Sr)-(fn-Sr)))-((mr=Fn*Sr)-si*di-Mi*di-si*Zi))-((jn=hr-(Ba=(Mi=Jt-(si=(fn=J*Jt)-(fn-Jt)))*(Zi=gr-(di=(fn=J*gr)-(fn-gr)))-((ho=Jt*gr)-si*di-Mi*di-si*Zi)))+(Rt=hr-jn))+(Rt-Ba),Ne[1]=(uo=mr-((Gi=mr+jn)-(Rt=Gi-mr))+(jn-Rt))-((jn=uo-ho)+(Rt=uo-jn))+(Rt-ho),Ne[2]=Gi-((Xi=Gi+jn)-(Rt=Xi-Gi))+(jn-Rt),Ne[3]=Xi;var kN=me(4,Xe,4,Ne,He);Ne[0]=(hr=(Mi=Ji-(si=(fn=J*Ji)-(fn-Ji)))*(Zi=xi-(di=(fn=J*xi)-(fn-xi)))-((mr=Ji*xi)-si*di-Mi*di-si*Zi))-((jn=hr-(Ba=(Mi=jr-(si=(fn=J*jr)-(fn-jr)))*(Zi=Bn-(di=(fn=J*Bn)-(fn-Bn)))-((ho=jr*Bn)-si*di-Mi*di-si*Zi)))+(Rt=hr-jn))+(Rt-Ba),Ne[1]=(uo=mr-((Gi=mr+jn)-(Rt=Gi-mr))+(jn-Rt))-((jn=uo-ho)+(Rt=uo-jn))+(Rt-ho),Ne[2]=Gi-((Xi=Gi+jn)-(Rt=Xi-Gi))+(jn-Rt),Ne[3]=Xi;var FN=me(kN,He,4,Ne,Ze);Ne[0]=(hr=(Mi=Fn-(si=(fn=J*Fn)-(fn-Fn)))*(Zi=xi-(di=(fn=J*xi)-(fn-xi)))-((mr=Fn*xi)-si*di-Mi*di-si*Zi))-((jn=hr-(Ba=(Mi=Jt-(si=(fn=J*Jt)-(fn-Jt)))*(Zi=Bn-(di=(fn=J*Bn)-(fn-Bn)))-((ho=Jt*Bn)-si*di-Mi*di-si*Zi)))+(Rt=hr-jn))+(Rt-Ba),Ne[1]=(uo=mr-((Gi=mr+jn)-(Rt=Gi-mr))+(jn-Rt))-((jn=uo-ho)+(Rt=uo-jn))+(Rt-ho),Ne[2]=Gi-((Xi=Gi+jn)-(Rt=Xi-Gi))+(jn-Rt),Ne[3]=Xi;var NN=me(FN,Ze,4,Ne,Ye);return Ye[NN-1]}(ut,lt,_t,Ot,an,ln,cn)}(Q[0],Q[1],ne[0],ne[1],ze[0],ze[1]);return it>0?-1:it<0?1:0}function Le(Q,ne){var ze=Q.point,it=ne.point;return ze[0]>it[0]?1:ze[0]<it[0]?-1:ze[1]!==it[1]?ze[1]>it[1]?1:-1:function(ut,lt,_t,Ot){return ut.left!==lt.left?ut.left?1:-1:qe(_t,ut.otherEvent.point,lt.otherEvent.point)!==0?ut.isBelow(lt.otherEvent.point)?-1:1:!ut.isSubject&&lt.isSubject?1:-1}(Q,ne,ze)}function Fe(Q,ne,ze){var it=new Y(ne,!1,Q,Q.isSubject),ut=new Y(ne,!0,Q.otherEvent,Q.isSubject);return z(Q.point,Q.otherEvent.point)&&console.warn("what is that, a collapsed segment?",Q),it.contourId=ut.contourId=Q.contourId,Le(ut,Q.otherEvent)>0&&(Q.otherEvent.left=!0,ut.left=!1),Q.otherEvent.otherEvent=ut,Q.otherEvent=it,ze.push(ut),ze.push(it),ze}function Qe(Q,ne){return Q[0]*ne[1]-Q[1]*ne[0]}function tt(Q,ne){return Q[0]*ne[0]+Q[1]*ne[1]}function Dt(Q,ne,ze){var it=function(an,ln,Yt,Pn,Zn){var cn=[ln[0]-an[0],ln[1]-an[1]],vi=[Pn[0]-Yt[0],Pn[1]-Yt[1]];function ei(fn,si,Mi){return[fn[0]+si*Mi[0],fn[1]+si*Mi[1]]}var Mn=[Yt[0]-an[0],Yt[1]-an[1]],Li=Qe(cn,vi),oi=Li*Li,Xn=tt(cn,cn);if(oi>0){var ti=Qe(Mn,vi)/Li;if(ti<0||ti>1)return null;var Fn=Qe(Mn,cn)/Li;return Fn<0||Fn>1?null:ti===0||ti===1?[ei(an,ti,cn)]:Fn===0||Fn===1?[ei(Yt,Fn,vi)]:[ei(an,ti,cn)]}if((oi=(Li=Qe(Mn,cn))*Li)>0)return null;var Jt=tt(cn,Mn)/Xn,Bn=Jt+tt(cn,vi)/Xn,xi=Math.min(Jt,Bn),Rt=Math.max(Jt,Bn);return xi<=1&&Rt>=0?xi===1?[ei(an,xi>0?xi:0,cn)]:Rt===0?[ei(an,Rt<1?Rt:1,cn)]:[ei(an,xi>0?xi:0,cn),ei(an,Rt<1?Rt:1,cn)]:null}(Q.point,Q.otherEvent.point,ne.point,ne.otherEvent.point),ut=it?it.length:0;if(ut===0||ut===1&&(z(Q.point,ne.point)||z(Q.otherEvent.point,ne.otherEvent.point))||ut===2&&Q.isSubject===ne.isSubject)return 0;if(ut===1)return z(Q.point,it[0])||z(Q.otherEvent.point,it[0])||Fe(Q,it[0],ze),z(ne.point,it[0])||z(ne.otherEvent.point,it[0])||Fe(ne,it[0],ze),1;var lt=[],_t=!1,Ot=!1;return z(Q.point,ne.point)?_t=!0:Le(Q,ne)===1?lt.push(ne,Q):lt.push(Q,ne),z(Q.otherEvent.point,ne.otherEvent.point)?Ot=!0:Le(Q.otherEvent,ne.otherEvent)===1?lt.push(ne.otherEvent,Q.otherEvent):lt.push(Q.otherEvent,ne.otherEvent),_t&&Ot||_t?(ne.type=b,Q.type=ne.inOut===Q.inOut?I:S,_t&&!Ot&&Fe(lt[1].otherEvent,lt[0].point,ze),2):Ot?(Fe(lt[0],lt[1].point,ze),3):lt[0]!==lt[3].otherEvent?(Fe(lt[0],lt[1].point,ze),Fe(lt[1],lt[2].point,ze),3):(Fe(lt[0],lt[1].point,ze),Fe(lt[3].otherEvent,lt[2].point,ze),3)}function vt(Q,ne){if(Q===ne)return 0;if(qe(Q.point,Q.otherEvent.point,ne.point)!==0||qe(Q.point,Q.otherEvent.point,ne.otherEvent.point)!==0)return z(Q.point,ne.point)?Q.isBelow(ne.otherEvent.point)?-1:1:Q.point[0]===ne.point[0]?Q.point[1]<ne.point[1]?-1:1:Le(Q,ne)===1?ne.isAbove(Q.point)?-1:1:Q.isBelow(ne.point)?-1:1;if(Q.isSubject!==ne.isSubject)return Q.isSubject?-1:1;var ze=Q.point,it=ne.point;return ze[0]===it[0]&&ze[1]===it[1]?(ze=Q.otherEvent.point)[0]===(it=ne.otherEvent.point)[0]&&ze[1]===it[1]?0:Q.contourId>ne.contourId?1:-1:Le(Q,ne)===1?1:-1}var ct=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function Je(Q,ne,ze,it){var ut,lt=Q+1,_t=ne[Q].point,Ot=ne.length;for(lt<Ot&&(ut=ne[lt].point);lt<Ot&&ut[0]===_t[0]&&ut[1]===_t[1];){if(!ze[lt])return lt;++lt<Ot&&(ut=ne[lt].point)}for(lt=Q-1;ze[lt]&&lt>it;)lt--;return lt}ct.prototype.isExterior=function(){return this.holeOf==null};var jt=bt,yt=bt;function bt(Q,ne){if(!(this instanceof bt))return new bt(Q,ne);if(this.data=Q||[],this.length=this.data.length,this.compare=ne||Ft,this.length>0)for(var ze=(this.length>>1)-1;ze>=0;ze--)this._down(ze)}function Ft(Q,ne){return Q<ne?-1:Q>ne?1:0}bt.prototype={push:function(Q){this.data.push(Q),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var Q=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),Q}},peek:function(){return this.data[0]},_up:function(Q){for(var ne=this.data,ze=this.compare,it=ne[Q];Q>0;){var ut=Q-1>>1,lt=ne[ut];if(ze(it,lt)>=0)break;ne[Q]=lt,Q=ut}ne[Q]=it},_down:function(Q){for(var ne=this.data,ze=this.compare,it=this.length>>1,ut=ne[Q];Q<it;){var lt=1+(Q<<1),_t=lt+1,Ot=ne[lt];if(_t<this.length&&ze(ne[_t],Ot)<0&&(lt=_t,Ot=ne[_t]),ze(Ot,ut)>=0)break;ne[Q]=Ot,Q=lt}ne[Q]=ut}},jt.default=yt;var Gt=Math.max,$t=Math.min,tn=0;function Xt(Q,ne,ze,it,ut,lt){var _t,Ot,an,ln,Yt,Pn;for(_t=0,Ot=Q.length-1;_t<Ot;_t++)if(ln=Q[_t+1],Yt=new Y(an=Q[_t],!1,void 0,ne),Pn=new Y(ln,!1,Yt,ne),Yt.otherEvent=Pn,an[0]!==ln[0]||an[1]!==ln[1]){Yt.contourId=Pn.contourId=ze,lt||(Yt.isExteriorRing=!1,Pn.isExteriorRing=!1),Le(Yt,Pn)>0?Pn.left=!0:Yt.left=!0;var Zn=an[0],cn=an[1];ut[0]=$t(ut[0],Zn),ut[1]=$t(ut[1],cn),ut[2]=Gt(ut[2],Zn),ut[3]=Gt(ut[3],cn),it.push(Yt),it.push(Pn)}}var nn=[];function Cn(Q,ne,ze){typeof Q[0][0][0]=="number"&&(Q=[Q]),typeof ne[0][0][0]=="number"&&(ne=[ne]);var it=function(cn,vi,ei){var Mn=null;return cn.length*vi.length==0&&(ei===D?Mn=nn:ei===L?Mn=cn:ei!==R&&ei!==F||(Mn=cn.length===0?vi:cn)),Mn}(Q,ne,ze);if(it)return it===nn?null:it;var ut=[1/0,1/0,-1/0,-1/0],lt=[1/0,1/0,-1/0,-1/0],_t=function(cn,vi,ei,Mn,Li){var oi,Xn,ti,Fn,Jt,Bn,xi=new jt(null,Le);for(ti=0,Fn=cn.length;ti<Fn;ti++)for(Jt=0,Bn=(oi=cn[ti]).length;Jt<Bn;Jt++)(Xn=Jt===0)&&tn++,Xt(oi[Jt],!0,tn,xi,ei,Xn);for(ti=0,Fn=vi.length;ti<Fn;ti++)for(Jt=0,Bn=(oi=vi[ti]).length;Jt<Bn;Jt++)Xn=Jt===0,Li===L&&(Xn=!1),Xn&&tn++,Xt(oi[Jt],!1,tn,xi,Mn,Xn);return xi}(Q,ne,ut,lt,ze);if(it=function(cn,vi,ei,Mn,Li){var oi=null;return(ei[0]>Mn[2]||Mn[0]>ei[2]||ei[1]>Mn[3]||Mn[1]>ei[3])&&(Li===D?oi=nn:Li===L?oi=cn:Li!==R&&Li!==F||(oi=cn.concat(vi))),oi}(Q,ne,ut,lt,ze))return it===nn?null:it;for(var Ot=function(cn){var vi,ei,Mn=function(ti){var Fn,Jt,Bn,xi,Rt=[];for(Jt=0,Bn=ti.length;Jt<Bn;Jt++)((Fn=ti[Jt]).left&&Fn.inResult||!Fn.left&&Fn.otherEvent.inResult)&&Rt.push(Fn);for(var fn=!1;!fn;)for(fn=!0,Jt=0,Bn=Rt.length;Jt<Bn;Jt++)Jt+1<Bn&&Le(Rt[Jt],Rt[Jt+1])===1&&(xi=Rt[Jt],Rt[Jt]=Rt[Jt+1],Rt[Jt+1]=xi,fn=!1);for(Jt=0,Bn=Rt.length;Jt<Bn;Jt++)(Fn=Rt[Jt]).otherPos=Jt;for(Jt=0,Bn=Rt.length;Jt<Bn;Jt++)(Fn=Rt[Jt]).left||(xi=Fn.otherPos,Fn.otherPos=Fn.otherEvent.otherPos,Fn.otherEvent.otherPos=xi);return Rt}(cn),Li={},oi=[],Xn=function(){if(!Li[vi]){var ti=oi.length,Fn=function(Rt,fn,si){var Mi=new ct;if(Rt.prevInResult!=null){var di=Rt.prevInResult,Zi=di.outputContourId;if(di.resultTransition>0){var jn=fn[Zi];if(jn.holeOf!=null){var Gi=jn.holeOf;fn[Gi].holeIds.push(si),Mi.holeOf=Gi,Mi.depth=fn[Zi].depth}else fn[Zi].holeIds.push(si),Mi.holeOf=Zi,Mi.depth=fn[Zi].depth+1}else Mi.holeOf=null,Mi.depth=fn[Zi].depth}else Mi.holeOf=null,Mi.depth=0;return Mi}(Mn[vi],oi,ti),Jt=function(Rt){Li[Rt]=!0,Rt<Mn.length&&Mn[Rt]&&(Mn[Rt].outputContourId=ti)},Bn=vi,xi=vi;for(Fn.points.push(Mn[vi].point);Jt(Bn),Jt(Bn=Mn[Bn].otherPos),Fn.points.push(Mn[Bn].point),!((Bn=Je(Bn,Mn,Li,xi))==xi||Bn>=Mn.length)&&Mn[Bn];);oi.push(Fn)}};for(vi=0,ei=Mn.length;vi<ei;vi++)Xn();return oi}(function(cn,vi,ei,Mn,Li,oi){for(var Xn,ti,Fn,Jt=new l(vt),Bn=[],xi=Math.min(Mn[2],Li[2]);cn.length!==0;){var Rt=cn.pop();if(Bn.push(Rt),oi===D&&Rt.point[0]>xi||oi===L&&Rt.point[0]>Mn[2])break;if(Rt.left){ti=Xn=Jt.insert(Rt),Xn=Xn!==(Fn=Jt.minNode())?Jt.prev(Xn):null,ti=Jt.next(ti);var fn=Xn?Xn.key:null;if(V(Rt,fn,oi),ti&&Dt(Rt,ti.key,cn)===2&&(V(Rt,fn,oi),V(ti.key,Rt,oi)),Xn&&Dt(Xn.key,Rt,cn)===2){var si=Xn;V(fn,(si=si!==Fn?Jt.prev(si):null)?si.key:null,oi),V(Rt,fn,oi)}}else ti=Xn=Jt.find(Rt=Rt.otherEvent),Xn&&ti&&(Xn=Xn!==Fn?Jt.prev(Xn):null,ti=Jt.next(ti),Jt.remove(Rt),ti&&Xn&&Dt(Xn.key,ti.key,cn))}return Bn}(_t,0,0,ut,lt,ze)),an=[],ln=0;ln<Ot.length;ln++){var Yt=Ot[ln];if(Yt.isExterior()){for(var Pn=[Yt.points],Zn=0;Zn<Yt.holeIds.length;Zn++)Pn.push(Ot[Yt.holeIds[Zn]].points);an.push(Pn)}}return an}var Qn={UNION:R,DIFFERENCE:L,INTERSECTION:D,XOR:F};n.diff=function(Q,ne){return Cn(Q,ne,L)},n.intersection=function(Q,ne){return Cn(Q,ne,D)},n.operations=Qn,n.union=function(Q,ne){return Cn(Q,ne,R)},n.xor=function(Q,ne){return Cn(Q,ne,F)},Object.defineProperty(n,"__esModule",{value:!0})})(e)}(0,ZS.exports)),ZS.exports);function Xy(r,e,n,s){let l=[],f=s===0?(p,y,x,b,I,S)=>{p.push(new ot(S,x+(S-y)/(b-y)*(I-x)))}:(p,y,x,b,I,S)=>{p.push(new ot(y+(S-x)/(I-x)*(b-y),S))};for(let p of r){let y=[];for(let x of p){if(x.length<=2)continue;let b=[];for(let D=0;D<x.length-1;D++){let R=x[D].x,L=x[D].y,F=x[D+1].x,V=x[D+1].y,$=s===0?R:L,Y=s===0?F:V;$<e?Y>e&&f(b,R,L,F,V,e):$>n?Y<n&&f(b,R,L,F,V,n):b.push(x[D]),Y<e&&$>=e&&f(b,R,L,F,V,e),Y>n&&$<=n&&f(b,R,L,F,V,n)}let I=x[x.length-1],S=s===0?I.x:I.y;S>=e&&S<=n&&b.push(I),b.length&&(I=b[b.length-1],b[0].x===I.x&&b[0].y===I.y||b.push(b[0]),y.push(b))}y.length&&l.push(y)}return l}function ZO(r,e){let n=w1(r),s=w1([e]),l=XS.intersection(n,s);return l==null?[]:YS(l)}function XO(r,e){let s=w1(r,65536);for(;e.valid();e.next()){let[l,f]=e.get(),p=l.x*65536,y=l.y*65536,x=f.x*65536,b=f.y*65536,I=x-p,S=b-y,D=Math.hypot(I,S),R=Math.trunc(S/D*3),L=-Math.trunc(I/D*3);s=XS.diff(s,[[[p,y],[x,b],[x+R,b+L],[p+R,y+L],[p,y]]])}return YS(s,1/65536)}function w1(r,e=1){return[r.map(n=>n.map(s=>[s.x*e,s.y*e]))]}function YS(r,e=1){return r.map(n=>n.map((s,l)=>{let f=s.map(p=>new ot(p[0]*e,p[1]*e).round());return l>0&&f.reverse(),f}))}class E1{constructor(e,n){this.layoutVertexArray=new Gs,this.indexArray=new cr,this.lineIndexArray=new Ra,this.triangleSegments=new Di,this.lineSegments=new Di,this.programConfigurations=new u(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,n&&(this.elevatedLayoutVertexArray=new Ma)}update(e,n,s,l,f,p,y,x){this.programConfigurations.updatePaintArrays(e,n,f,s,l,p,y,x)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,LO.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,OO.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,n,s,l,f,p,y){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,n,s,l,f,p,void 0,y)}}class T1{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=e.lut,this.bufferData=new E1(e,!1),this.elevationBufferData=new E1(e,!0),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=e.sourceLayerIndex,this.worldview=e.worldview}updateFootprints(e,n){}populate(e,n,s,l){this.hasPattern=x1("fill",this.layers,this.pixelRatio,n);let f=this.layers[0].layout.get("fill-sort-key"),p=[];for(let{feature:y,id:x,index:b,sourceLayerIndex:I}of e){let S=this.layers[0]._featureFilter.needGeometry,D=dt(y,S);if(!this.layers[0]._featureFilter.filter(new zn(this.zoom,{worldview:this.worldview}),D,s))continue;let R=f?f.evaluate(D,{},s,n.availableImages):void 0,L={id:x,properties:y.properties,type:y.type,sourceLayerIndex:I,index:b,geometry:S?D.geometry:gt(y,s,l),patterns:{},sortKey:R};p.push(L)}f&&p.sort((y,x)=>y.sortKey-x.sortKey);for(let y of p){let{geometry:x,index:b,sourceLayerIndex:I}=y;if(this.hasPattern){let S=b1("fill",this.layers,y,this.zoom,this.pixelRatio,n);this.patternFeatures.push(S)}else this.addFeature(y,x,b,s,{},n.availableImages,n.brightness,n.elevationFeatures);n.featureIndex.insert(e[b].feature,x,b,I,this.index)}}update(e,n,s,l,f,p,y){this.bufferData.update(e,n,s,l,f,p,y,this.worldview),this.elevationBufferData.update(e,n,s,l,f,p,y,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(e,n,s,l,f,p,y,this.worldview)}addFeatures(e,n,s,l,f,p){for(let y of this.patternFeatures)this.addFeature(y,y.geometry,y.index,n,s,l,p,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,n,s,l,f,p=[],y,x){let b=Zy(n,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(e,b,l,s,x):this.addGeometry(b,this.bufferData),this.bufferData.populatePaintArrays(e,s,f,p,l,y,this.worldview),this.elevationBufferData.populatePaintArrays(e,s,f,p,l,y,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(e,n,s,l,f){this.elevatedStructures&&(this.elevatedStructures.construct(e),this.elevatedStructures.populatePaintArrays(n,s,l,f,this.worldview))}addElevatedRoadFeature(e,n,s,l,f){let p=new Array,y=Eo.getElevationFeature(e,f);if(!y)return void this.addGeometry(n,this.bufferData);{let b=this.clipPolygonsToTile(n,1);b.length>0&&p.push({polygons:b,elevationFeature:y,elevationTileID:s})}let x={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(e,{},s),featureIndex:l};for(let b of p)if(b.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new Vo(b.elevationTileID,this.layers,this.zoom,this.lut));let S=b.elevationFeature.isTunnel(),D=0;e.properties.hasOwnProperty(ni)&&(D=+e.properties[ni]);for(let R of b.polygons)this.elevatedStructures.addPortalCandidates(b.elevationFeature.id,R,S,b.elevationFeature,D)}b.elevationFeature.constantHeight==null&&(b.polygons=this.prepareElevatedPolygons(b.polygons,b.elevationFeature,b.elevationTileID));let I=new es(s,b.elevationTileID);this.addElevatedGeometry(b.polygons,I,b.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,l,x)}}addElevatedGeometry(e,n,s,l,f,p){let y={elevation:s,elevationSampler:n,bias:l,index:f,featureInfo:p},[x,b]=this.addGeometry(e,this.elevationBufferData,y);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:x,max:b}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,x),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,b))}addGeometry(e,n,s){let l=Number.POSITIVE_INFINITY,f=Number.NEGATIVE_INFINITY,p=null;s&&(p=s.elevationSampler.constantElevation(s.elevation,s.bias),p!=null&&(l=p,f=p));let y=(x,b,I)=>{if(s!=null)if(b.push(x),p!=null)n.elevatedLayoutVertexArray.emplaceBack(p),I.push(p);else{let S=s.elevationSampler.pointElevation(x,s.elevation,s.bias);n.elevatedLayoutVertexArray.emplaceBack(S),I.push(S),l=Math.min(l,S),f=Math.max(f,S)}};for(let x of e){let b=0;for(let K of x)b+=K.length;let I=n.triangleSegments.prepareSegment(b,n.layoutVertexArray,n.indexArray),S=I.vertexLength,D=[],R=[],L=[],F=[],V=[],$=n.layoutVertexArray.length;for(let K of x){if(K.length===0)continue;K!==x[0]&&R.push(D.length/2);let z=n.lineSegments.prepareSegment(K.length,n.layoutVertexArray,n.lineIndexArray),W=z.vertexLength;s&&V.push(n.layoutVertexArray.length-$),y(K[0],L,F),n.layoutVertexArray.emplaceBack(K[0].x,K[0].y),n.lineIndexArray.emplaceBack(W+K.length-1,W),D.push(K[0].x),D.push(K[0].y);for(let J=1;J<K.length;J++)y(K[J],L,F),n.layoutVertexArray.emplaceBack(K[J].x,K[J].y),n.lineIndexArray.emplaceBack(W+J-1,W+J),D.push(K[J].x),D.push(K[J].y);z.vertexLength+=K.length,z.primitiveLength+=K.length}let Y=jm(D,R);for(let K=0;K<Y.length;K+=3)n.indexArray.emplaceBack(S+Y[K],S+Y[K+1],S+Y[K+2]);if(Y.length>0&&s&&this.elevationMode==="hd-road-base"){let K=s.elevation.isTunnel(),z=s.elevation.safeArea,W=this.elevatedStructures.addVertices(L,F);this.elevatedStructures.addTriangles(Y,W,K);let J=V.length;if(J>0){for(let te=0;te<J-1;te++)this.elevatedStructures.addRenderableRing(s.index,V[te]+W,V[te+1]-V[te],K,z,s.featureInfo);this.elevatedStructures.addRenderableRing(s.index,V[J-1]+W,L.length-V[J-1],K,z,s.featureInfo)}}I.vertexLength+=b,I.primitiveLength+=Y.length/3}return[l,f]}prepareElevatedPolygons(e,n,s){let l=1/Oe(s),f=[];for(let p of e){let y=XO(p,new co(n,l));f.push(...y)}return f}clipPolygonsToTile(e,n){let s=-n,l=-n,f=at+n,p=at+n,y=0,x=[],b=[];for(;y<e.length;y++){let D=e[y],R=Hp(D);(R.min.x>=s&&R.max.x<=f&&R.min.y>=l&&R.max.y<=p?x:b).push(D)}if(x.length===e.length)return e;let I=[new ot(s,l),new ot(f,l),new ot(f,p),new ot(s,p),new ot(s,l)],S=x;for(let D of b)S.push(...ZO(D,I));return S}}let KS,JS,QS,eD;pt(T1,"FillBucket",{omit:["layers","patternFeatures"]}),pt(E1,"FillBufferData"),pt(Vo,"ElevatedStructures");class I1{constructor(e,n,s,l){if(this.triangleCount=n.length/3,this.min=new ot(0,0),this.max=new ot(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;let[f,p]=[e[0].clone(),e[0].clone()];for(let S=1;S<e.length;++S){let D=e[S];f.x=Math.min(f.x,D.x),f.y=Math.min(f.y,D.y),p.x=Math.max(p.x,D.x),p.y=Math.max(p.y,D.y)}if(l){let S=Math.ceil(Math.max(p.x-f.x,p.y-f.y)/l);s=Math.max(s,S)}if(s===0)return;this.min=f,this.max=p;let y=this.max.sub(this.min);y.x=Math.max(y.x,1),y.y=Math.max(y.y,1);let x=Math.max(y.x,y.y)/s;this.cellsX=Math.max(1,Math.ceil(y.x/x)),this.cellsY=Math.max(1,Math.ceil(y.y/x)),this.xScale=1/x,this.yScale=1/x;let b=[];for(let S=0;S<this.triangleCount;S++){let D=e[n[3*S+0]].sub(this.min),R=e[n[3*S+1]].sub(this.min),L=e[n[3*S+2]].sub(this.min),F=Na(Math.floor(Math.min(D.x,R.x,L.x)),this.xScale,this.cellsX),V=Na(Math.floor(Math.max(D.x,R.x,L.x)),this.xScale,this.cellsX),$=Na(Math.floor(Math.min(D.y,R.y,L.y)),this.yScale,this.cellsY),Y=Na(Math.floor(Math.max(D.y,R.y,L.y)),this.yScale,this.cellsY),K=new ot(0,0),z=new ot(0,0),W=new ot(0,0),J=new ot(0,0);for(let te=$;te<=Y;++te){K.y=z.y=te*x,W.y=J.y=(te+1)*x;for(let me=F;me<=V;++me)K.x=W.x=me*x,z.x=J.x=(me+1)*x,(h1(D,R,L,K,z,J)||h1(D,R,L,K,J,W))&&b.push({cellIdx:te*this.cellsX+me,triIdx:S})}}if(b.length===0)return;b.sort((S,D)=>S.cellIdx-D.cellIdx||S.triIdx-D.triIdx);let I=0;for(;I<b.length;){let S=b[I].cellIdx,D={start:this.payload.length,len:0};for(;I<b.length&&b[I].cellIdx===S;)++D.len,this.payload.push(b[I++].triIdx);this.cells[S]=D}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,n){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;let s=Na(e.x-this.min.x,this.xScale,this.cellsX),l=Na(e.y-this.min.y,this.yScale,this.cellsY),f=this.cells[l*this.cellsX+s];if(f){this._lazyInitLookup();for(let p=0;p<f.len;p++){let y=this.payload[f.start+p],x=Math.floor(y/8),b=1<<y%8;if(!(this.lookup[x]&b)&&(this.lookup[x]|=b,n.push(y),n.length===this.triangleCount))return}}}query(e,n,s){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>n.x||e.y>this.max.y||this.min.y>n.y)return;this._lazyInitLookup();let l=Na(e.x-this.min.x,this.xScale,this.cellsX),f=Na(n.x-this.min.x,this.xScale,this.cellsX),p=Na(e.y-this.min.y,this.yScale,this.cellsY),y=Na(n.y-this.min.y,this.yScale,this.cellsY);for(let x=p;x<=y;x++)for(let b=l;b<=f;b++){let I=this.cells[x*this.cellsX+b];if(I)for(let S=0;S<I.len;S++){let D=this.payload[I.start+S],R=Math.floor(D/8),L=1<<D%8;if(!(this.lookup[R]&L)&&(this.lookup[R]|=L,s.push(D),s.length===this.triangleCount))return}}}}function Na(r,e,n){return Math.max(0,Math.min(n-1,Math.floor(r*e)))}pt(I1,"TriangleGridIndex");class tD{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.footprints=[],this.worldview=e.worldview}updateFootprints(e,n){for(let s of this.footprints)n.push({footprint:s,id:e})}populate(e,n,s,l){let f=[];for(let{feature:p,id:y,index:x,sourceLayerIndex:b}of e){let I=this.layers[0]._featureFilter.needGeometry,S=dt(p,I);if(!this.layers[0]._featureFilter.filter(new zn(this.zoom,{worldview:this.worldview}),S,s))continue;let D={id:y,properties:p.properties,type:p.type,sourceLayerIndex:b,index:x,geometry:I?S.geometry:gt(p,s,l),patterns:{}};f.push(D)}for(let p of f){let{geometry:y,index:x,sourceLayerIndex:b}=p;this.addFeature(p,y,x,s,{},n.availableImages,n.brightness),n.featureIndex.insert(e[x].feature,y,x,b,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(e){}update(e,n,s,l,f,p,y){}destroy(){}addFeature(e,n,s,l,f,p=[],y){for(let x of Zy(n,2)){let b=[],I=[],S=[],D=new ot(1/0,1/0),R=new ot(-1/0,-1/0);for(let V of x)if(V.length!==0){V!==x[0]&&S.push(I.length/2);for(let $=0;$<V.length;$++)I.push(V[$].x),I.push(V[$].y),b.push(V[$]),D.x=Math.min(D.x,V[$].x),D.y=Math.min(D.y,V[$].y),R.x=Math.max(R.x,V[$].x),R.y=Math.max(R.y,V[$].y)}let L=jm(I,S),F=new I1(b,L,8,256);this.footprints.push({vertices:b,indices:L,grid:F,min:D,max:R})}}}pt(tD,"ClipBucket",{omit:["layers"]});let YO=mn([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),KO=mn([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),JO=mn([{name:"a_centroid_pos",components:2,type:"Uint16"}]),QO=mn([{name:"a_join_normal_inside",components:3,type:"Int16"}]),ek=mn([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),tk=mn([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:nk}=YO,Yy=Number.MAX_SAFE_INTEGER;function nD(r,e,n,s){return r.order<e||r.order===Yy||!(r.clipMask&n)||function(l,f){return f.length!==0&&f.find(p=>p===l)===void 0}(s,r.clipScope)}function Ky(r,e){return r.x-e.x||r.y-e.y}function iD(r,e){return Ky(r.min,e.min)===0&&Ky(r.max,e.max)===0}function S1(r,e){return!(r.min.x>e.max.x||r.max.x<e.min.x||r.min.y>e.max.y||r.max.y<e.min.y)}function D1(r,e){if(r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(r[n].sourceId!==e[n].sourceId||!iD(r[n],e[n])||r[n].order!==e[n].order||r[n].clipMask!==e[n].clipMask||!Ls(r[n].clipScope,e[n].clipScope))return!1;return!0}function rD(r,e,n){let s=1/at,l=1/(1<<n.canonical.z),f=(e.x*s+n.canonical.x)*l+n.wrap,p=(e.y*s+n.canonical.y)*l;return{min:new ot((r.x*s+n.canonical.x)*l+n.wrap,(r.y*s+n.canonical.y)*l),max:new ot(f,p)}}function ik(r,e,n){let s=1<<n.canonical.z,l=((e.x-n.wrap)*s-n.canonical.x)*at,f=(e.y*s-n.canonical.y)*at;return{min:new ot(((r.x-n.wrap)*s-n.canonical.x)*at,(r.y*s-n.canonical.y)*at),max:new ot(l,f)}}function oD(r,e,n,s,l,f,p){let y=r.indices,x=r.vertices,b=[];for(let I=s;I<s+l;I+=3){let S=e[n[I+0]+f],D=e[n[I+1]+f],R=e[n[I+2]+f],L=Math.min(S.x,D.x,R.x),F=Math.max(S.x,D.x,R.x),V=Math.min(S.y,D.y,R.y),$=Math.max(S.y,D.y,R.y);b.length=0,r.grid.query(new ot(L,V),new ot(F,$),b);for(let Y=0;Y<b.length;Y++){let K=b[Y];if(h1(x[y[3*K+0]],x[y[3*K+1]],x[y[3*K+2]],S,D,R,p))return!0}}return!1}function sD(r,e,n,s){if(!r||!n)return!1;let l=r.vertices;if(!e.canonical.equals(s.canonical)||e.wrap!==s.wrap){if(n.vertices.length<r.vertices.length)return sD(n,s,r,e);let f=e.canonical,p=s.canonical,y=Math.pow(2,p.z-f.z);l=r.vertices.map(x=>new ot((x.x+f.x*at)*y-p.x*at,(x.y+f.y*at)*y-p.y*at))}return oD(n,l,r.indices,0,r.indices.length,0,0)}function aD(r,e,n,s){let l=Math.pow(2,s.z-n.z);return new ot((r+n.x*at)*l-s.x*at,(e+n.y*at)*l-s.y*at)}function lD(r,e){let n=[];e.grid.queryPoint(r,n);let s=e.indices,l=e.vertices;for(let f=0;f<n.length;f++){let p=n[f];if(vs([l[s[3*p+0]],l[s[3*p+1]],l[s[3*p+2]]],r))return!0}return!1}let C1=[new ot(0,0),new ot(at,0),new ot(at,at),new ot(0,at)];function cD(r,e){let n=[],s=[];if(!e||r.length<2)return[r];if(r.length===2)return Dl(r[0],r[1],C1)?[r]:[];for(let l=0;l<r.length+2;l++){let f=r[l%r.length],p=r[(l+1)%r.length],y=Dl(l===0?r[r.length-1]:r[(l-1)%r.length],f,C1),x=Dl(f,p,C1),b=y||x;b&&s.push(f),b&&x||s.length>0&&(s.length>1&&n.push(s),s=[])}return s.length>1&&n.push(s),n}let M1=Kt.VectorTileFeature.types,rk=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],ok=["fill-extrusion-flood-light-ground-radius"],sk=Math.pow(2,13),ak=Math.pow(2,15)-1,uD=new ot(0,1),Vc=2147483648;function qm(r,e,n,s,l,f,p,y){r.emplaceBack((e<<1)+p,(n<<1)+f,(Math.floor(s*sk)<<1)+l,Math.round(y))}function Wm(r,e,n){r.emplaceBack(e.x*at,e.y*at,n?1:0)}function Jy(r,e,n,s,l,f){r.emplaceBack(e.x,e.y,(n.x<<1)+s,(n.y<<1)+l,f)}function Zm(r,e,n){r.emplaceBack(e.x,e.y,e.z,n[0]*16384,n[1]*16384,n[2]*16384)}class hD{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class dD{constructor(){this.centroidXY=new ot(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new ot(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new ot(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new ot(this.max.x-this.min.x,this.max.y-this.min.y)}}class fD{constructor(){this.acc=new ot(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,n){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=n.x,e.min.y=e.max.y=n.y)}appendEdge(e,n,s){this.accCount++,this.acc._add(n);let l=!!this.borders;n.x<e.min.x?(e.min.x=n.x,l=!0):n.x>e.max.x&&(e.max.x=n.x,l=!0),n.y<e.min.y?(e.min.y=n.y,l=!0):n.y>e.max.y&&(e.max.y=n.y,l=!0),((n.x===0||n.x===at)&&n.x===s.x)!=((n.y===0||n.y===at)&&n.y===s.y)&&this.processBorderOverlap(n,s),l&&this.checkBorderIntersection(n,s)}checkBorderIntersection(e,n){n.x<0!=e.x<0&&this.addBorderIntersection(0,kt(n.y,e.y,(0-n.x)/(e.x-n.x))),n.x>at!=e.x>at&&this.addBorderIntersection(1,kt(n.y,e.y,(at-n.x)/(e.x-n.x))),n.y<0!=e.y<0&&this.addBorderIntersection(2,kt(n.x,e.x,(0-n.y)/(e.y-n.y))),n.y>at!=e.y>at&&this.addBorderIntersection(3,kt(n.x,e.x,(at-n.y)/(e.y-n.y)))}addBorderIntersection(e,n){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);let s=this.borders[e];n<s[0]&&(s[0]=n),n>s[1]&&(s[1]=n)}processBorderOverlap(e,n){if(e.x===n.x){if(e.y===n.y)return;let s=e.x===0?0:1;this.addBorderIntersection(s,n.y),this.addBorderIntersection(s,e.y)}else{let s=e.y===0?2:3;this.addBorderIntersection(s,n.x),this.addBorderIntersection(s,e.x)}}centroid(){return this.accCount===0?new ot(0,0):new ot(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((e,n)=>e+ +(n[0]!==Number.MAX_VALUE),0):0}}function pD(r,e){let n=r.add(e)._unit(),s=ae(r.x*n.x+r.y*n.y,-1,1);var l,f,p;return l=Math.acos(s),Math.min(4,Math.max(-4,Math.tan(l)))/4*ak*((f=r).x*(p=e).y-f.y*p.x<0?-1:1)}let lk=[r=>r.x<0,r=>r.x>at,r=>r.y<0,r=>r.y>at];function ck(r,e,n,s){let l=[4];if(s===0)return l;n._mult(s);let f=r.sub(n),p=e.sub(n),y=[r,e,f,p];for(let x=0;x<4;x++)for(let b of y)if(lk[x](b)){l.push(x);break}return l}class mD{constructor(e){this.vertexArray=new Cc,this.indexArray=new cr,this.programConfigurations=new u(e.layers,{zoom:e.zoom,lut:e.lut},n=>ok.includes(n)),this._segments=new Di,this.hiddenByLandmarkVertexArray=new Kd,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Di}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,n,s,l=!1){let f=e.length;if(f>2){let p=Math.max(0,this._segments.get().length-1),y=this._segments._prepareSegment(4*f,this.vertexArray.length,2*this._segmentToGroundQuads[p].length),x;p!==this._segments.get().length-1&&(p++,this._segmentToGroundQuads[p]=[],this._segmentToRegionTriCounts[p]=[0,0,0,0,0]);{let b=e[0],I=e[1];x=pD(b.sub(e[f-1])._perp()._unit(),I.sub(b)._perp()._unit())}for(let b=0;b<f;b++){let I=b===f-1?0:b+1,S=e[b],D=e[I],R=e[I===f-1?0:I+1],L=D.sub(S)._perp()._unit(),F=pD(L,R.sub(D)._perp()._unit()),V=x,$=F;if(A1(S,D,n)||l&&yD(S,n)&&yD(D,n)){x=F;continue}let Y=y.vertexLength;Jy(this.vertexArray,S,D,1,1,V),Jy(this.vertexArray,S,D,1,0,V),Jy(this.vertexArray,S,D,0,1,$),Jy(this.vertexArray,S,D,0,0,$),y.vertexLength+=4;let K=ck(S,D,L,s);for(let z of K)this._segmentToGroundQuads[p].push({id:Y,region:z}),this._segmentToRegionTriCounts[p][z]+=2,y.primitiveLength+=2;x=F}}}prepareBorderSegments(){if(!this.hasData())return;let e=this._segments.get(),n=e.length;for(let s=0;s<n;s++)this._segmentToGroundQuads[s].sort((l,f)=>l.region-f.region);for(let s=0;s<n;s++){let l=this._segmentToGroundQuads[s],f=e[s],p=this._segmentToRegionTriCounts[s];p.reduce((x,b)=>x+b,0);let y=0;for(let x=0;x<=4;x++){let b=p[x];if(b!==0){let I=this.regionSegments[x];I||(I=this.regionSegments[x]=new Di);let S={vertexOffset:f.vertexOffset,primitiveOffset:f.primitiveOffset+y,vertexLength:f.vertexLength,primitiveLength:b};I.get().push(S)}y+=b}for(let x=0;x<l.length;x++){let b=l[x].id;this.indexArray.emplaceBack(b,b+1,b+3),this.indexArray.emplaceBack(b,b+3,b+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,n,s,l,f,p,y){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,n,s,l,f,p,void 0,y)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,KO.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,n,s,l,f,p,y,x){this.hasData()&&this.programConfigurations.updatePaintArrays(e,n,s,l,f,p,y,x)}updateHiddenByLandmark(e){if(!this.hasData())return;let n=e.groundVertexCount+e.groundVertexArrayOffset;if(e.groundVertexCount===0)return;let s=e.flags&Vc?1:0;for(let l=e.groundVertexArrayOffset;l<n;++l)this.hiddenByLandmarkVertexArray.emplace(l,s);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,ek.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){let n=this.regionSegments[e];n&&n.destroy()}}}}class Qy{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new cr,this.footprintVertices=new Gs,this.footprintSegments=[],this.layoutVertexArray=new Dc,this.centroidVertexArray=new Oy,this.wallVertexArray=new Fy,this.indexArray=new cr,this.programConfigurations=new u(e.layers,{zoom:e.zoom,lut:e.lut},n=>rk.includes(n)),this.segments=new Di,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.groundEffect=new mD(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=e.worldview}updateFootprints(e,n){}populate(e,n,s,l){this.features=[],this.hasPattern=x1("fill-extrusion",this.layers,this.pixelRatio,n),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=Oe(s),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(let{feature:f,id:p,index:y,sourceLayerIndex:x}of e){let b=this.layers[0]._featureFilter.needGeometry,I=dt(f,b);if(!this.layers[0]._featureFilter.filter(new zn(this.zoom,{worldview:this.worldview}),I,s))continue;let S={id:p,sourceLayerIndex:x,index:y,geometry:b?I.geometry:gt(f,s,l),properties:f.properties,type:f.type,patterns:{}},D=this.layoutVertexArray.length,R=M1[S.type]==="Polygon";if(this.hasPattern)this.features.push(b1("fill-extrusion",this.layers,S,this.zoom,this.pixelRatio,n));else if(this.wallMode)for(let L of S.geometry)for(let F of cD(L,R))this.addFeature(S,[F],y,s,{},n.availableImages,l,n.brightness);else this.addFeature(S,S.geometry,y,s,{},n.availableImages,l,n.brightness);n.featureIndex.insert(f,S.geometry,y,x,this.index,D)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,n,s,l,f,p){for(let y of this.features){let x=M1[y.type]==="Polygon",{geometry:b}=y;if(this.wallMode)for(let I of b)for(let S of cD(I,x))this.addFeature(y,[S],y.index,n,s,l,f,p);else this.addFeature(y,b,y.index,n,s,l,f,p)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,n,s,l,f,p,y){this.programConfigurations.updatePaintArrays(e,n,f,s,l,p,y,this.worldview),this.groundEffect.update(e,n,f,s,l,p,y,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,nk),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,QO.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,tk.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,JO.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,n,s,l,f,p,y,x){let b=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(e,{})/this.tileToMeter,I=[new ot(0,0),new ot(at,at)],S=y.projection,D=S.name==="globe",R=this.wallMode||M1[e.type]==="Polygon",L=new fD;L.centroidDataIndex=this.centroidData.length;let F=new dD,V=this.layers[0].paint.get("fill-extrusion-base").evaluate(e,{},l)<=0,$=this.layers[0].paint.get("fill-extrusion-height").evaluate(e,{},l),Y;if(F.height=$,F.vertexArrayOffset=this.layoutVertexArray.length,F.groundVertexArrayOffset=this.groundEffect.vertexArray.length,D&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Zd),this.wallMode){if(D)return void qt("Non zero fill-extrusion-line-width is not yet supported on globe.");if(n.length!==1)return;Y=function(ge){let xe=ge[0].x===ge[ge.length-1].x&&ge[0].y===ge[ge.length-1].y;(function(ct){let Je=0,jt=ct.length;for(let yt=0;yt<jt;yt++)Je+=(ct[(yt+1)%jt].x-ct[yt].x)*(ct[(yt+1)%jt].y+ct[yt].y);return Je>=0})(ge)||(ge=ge.reverse());let Xe={geometry:[],joinNormals:[],indices:[]},He=[],Ze=[],Ye=[],Ne=ge.length;for(;Ne>=2&&ge[Ne-1].equals(ge[Ne-2]);)Ne--;if(Ne<(xe?3:2))return Xe;let qe,Le,Fe,Qe,tt,Dt=0;for(;Dt<Ne-1&&ge[Dt].equals(ge[Dt+1]);)Dt++;xe&&(qe=ge[Ne-2],tt=ge[Dt].sub(qe)._unit()._perp());for(let ct=Dt;ct<Ne;ct++){if(Fe=ct===Ne-1?xe?ge[Dt+1]:void 0:ge[ct+1],Fe&&ge[ct].equals(Fe))continue;tt&&(Qe=tt),qe&&(Le=qe),qe=ge[ct],tt=Fe?Fe.sub(qe)._unit()._perp():Qe,Qe=Qe||tt;let Je=Qe.add(tt);Je.x===0&&Je.y===0||Je._unit();let jt=Je.x*tt.x+Je.y*tt.y,yt=jt!==0?1/jt:1/0,bt=Qe.x*tt.y-Qe.y*tt.x>0,Ft="miter",Gt=2;Ft==="miter"&&yt>Gt&&(Ft="bevel"),Ft==="bevel"&&(yt>100&&(Ft="flipbevel"),yt<Gt&&(Ft="miter"));let $t=(tn,Xt,nn,Cn)=>{let Qn=new ot(tn.x,tn.y),Q=new ot(tn.x,tn.y);Qn.x+=Xt.x*Cn,Qn.y+=Xt.y*Cn,Q.x-=Xt.x*Math.max(nn,1),Q.y-=Xt.y*Math.max(nn,1),Ye.push(Xt),He.push(Qn),Ze.push(Q)};if(Ft==="miter")Je._mult(yt),$t(qe,Je,0,0);else if(Ft==="flipbevel")Je=tt.mult(-1),$t(qe,Je,0,0),$t(qe,Je.mult(-1),0,0);else{let tn=-Math.sqrt(yt*yt-1),Xt=bt?tn:0,nn=bt?0:tn;Le&&$t(qe,Qe,Xt,nn),Fe&&$t(qe,tt,Xt,nn)}}Xe.geometry=[...He,...Ze.reverse(),He[0]],Xe.joinNormals=[...Ye,...Ye.reverse(),Ye[Ye.length-1]];let vt=Xe.geometry.length-1;for(let ct=0;ct<vt/2;ct++)if(ct+1<vt/2){let Je=ct,jt=ct+1,yt=vt-1-ct,bt=vt-2-ct;Je=Je===0?vt-1:Je-1,jt=jt===0?vt-1:jt-1,yt=yt===0?vt-1:yt-1,bt=bt===0?vt-1:bt-1,Xe.indices.push(yt),Xe.indices.push(jt),Xe.indices.push(Je),Xe.indices.push(yt),Xe.indices.push(bt),Xe.indices.push(jt)}return Xe}(n[0]),n=[Y.geometry]}let K=(ge,xe)=>ge<(xe.length-1)/2||ge===xe.length-1,z=this.wallMode?[n]:Zy(n,500);for(let ge=z.length-1;ge>=0;ge--){let xe=z[ge];(xe.length===0||(W=xe[0]).every(ke=>ke.x<=0)||W.every(ke=>ke.x>=at)||W.every(ke=>ke.y<=0)||W.every(ke=>ke.y>=at))&&z.splice(ge,1)}var W;let J;if(D)J=wD(z,I,l);else{J=[];for(let ge of z)J.push({polygon:ge,bounds:I})}let te=R?this.edgeRadius:0,me=te>0&&this.zoom<17,de=(ge,xe)=>{if(ge.length===0)return!1;let ke=ge[ge.length-1];return xe.x===ke.x&&xe.y===ke.y};for(let{polygon:ge,bounds:xe}of J){let ke=0,Xe=0;for(let Ne of ge)R&&!Ne[0].equals(Ne[Ne.length-1])&&Ne.push(Ne[0]),Xe+=R?Ne.length-1:Ne.length;let He=this.segments.prepareSegment((R?5:4)*Xe,this.layoutVertexArray,this.indexArray);F.footprintSegIdx<0&&(F.footprintSegIdx=this.footprintSegments.length),F.polygonSegIdx<0&&(F.polygonSegIdx=this.polygonSegments.length);let Ze={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Ye=new hD;if(Ye.vertexOffset=this.footprintVertices.length,Ye.indexOffset=3*this.footprintIndices.length,Ye.ringIndices=[],R){let Ne=[],qe=[];ke=He.vertexLength;for(let Fe=0;Fe<ge.length;Fe++){let Qe=ge[Fe];Qe.length&&Fe!==0&&qe.push(Ne.length/2);let tt=[],Dt,vt;Dt=Qe[1].sub(Qe[0])._perp()._unit(),Ye.ringIndices.push(Qe.length-1);for(let ct=1;ct<Qe.length;ct++){let Je=Qe[ct],jt=Qe[ct===Qe.length-1?1:ct+1],yt=Je.clone();if(te){vt=jt.sub(Je)._perp()._unit();let bt=Dt.add(vt)._unit(),Ft=te*Math.min(4,1/(Dt.x*bt.x+Dt.y*bt.y));yt.x+=Ft*bt.x,yt.y+=Ft*bt.y,yt.x=Math.round(yt.x),yt.y=Math.round(yt.y),Dt=vt}if(!V||te!==0&&!me||de(tt,yt)||tt.push(yt),qm(this.layoutVertexArray,yt.x,yt.y,0,0,1,1,0),this.wallMode){let bt=K(ct,Qe);Wm(this.wallVertexArray,Y.joinNormals[ct],!bt)}He.vertexLength++,this.footprintVertices.emplaceBack(Je.x,Je.y),Ne.push(Je.x,Je.y),D&&Zm(this.layoutVertexExtArray,S.projectTilePoint(yt.x,yt.y,l),S.upVector(l,yt.x,yt.y))}V&&(te===0||me)&&(tt.length!==0&&de(tt,tt[0])&&tt.pop(),this.groundEffect.addData(tt,xe,b))}let Le=this.wallMode?Y.indices:jm(Ne,qe);for(let Fe=0;Fe<Le.length;Fe+=3)this.footprintIndices.emplaceBack(Ye.vertexOffset+Le[Fe+0],Ye.vertexOffset+Le[Fe+1],Ye.vertexOffset+Le[Fe+2]),this.indexArray.emplaceBack(ke+Le[Fe],ke+Le[Fe+2],ke+Le[Fe+1]),He.primitiveLength++;Ye.indexCount+=Le.length,Ye.vertexCount+=this.footprintVertices.length-Ye.vertexOffset}for(let Ne=0;Ne<ge.length;Ne++){let qe=ge[Ne];L.startRing(F,qe[0]);let Le=qe.length>4&&vD(qe[qe.length-2],qe[0],qe[1]),Fe=te?uk(qe[qe.length-2],qe[0],qe[1],te):0,Qe=[],tt,Dt,vt;Dt=qe[1].sub(qe[0])._perp()._unit();let ct=!0;for(let Je=1,jt=0;Je<qe.length;Je++){let yt=qe[Je-1],bt=qe[Je],Ft=qe[Je===qe.length-1?1:Je+1];if(L.appendEdge(F,bt,yt),A1(bt,yt,xe)){te&&(Dt=Ft.sub(bt)._perp()._unit(),ct=!ct);continue}let Gt=bt.sub(yt)._perp(),$t=Gt.x/(Math.abs(Gt.x)+Math.abs(Gt.y)),tn=Gt.y>0?1:0,Xt=yt.dist(bt);if(jt+Xt>32768&&(jt=0),te){vt=Ft.sub(bt)._perp()._unit();let Q=_D(yt,bt,Ft,gD(Dt,vt),te);isNaN(Q)&&(Q=0);let ne=bt.sub(yt)._unit();yt=yt.add(ne.mult(Fe))._round(),bt=bt.add(ne.mult(-Q))._round(),Fe=Q,Dt=vt,V&&this.zoom>=17&&(de(Qe,yt)||Qe.push(yt),de(Qe,bt)||Qe.push(bt))}let nn=He.vertexLength,Cn=qe.length>4&&vD(yt,bt,Ft),Qn=xD(jt,Le,ct);if(qm(this.layoutVertexArray,yt.x,yt.y,$t,tn,0,0,Qn),qm(this.layoutVertexArray,yt.x,yt.y,$t,tn,0,1,Qn),this.wallMode){let Q=K(Je-1,qe),ne=Y.joinNormals[Je-1];Wm(this.wallVertexArray,ne,Q),Wm(this.wallVertexArray,ne,Q)}if(jt+=Xt,Qn=xD(jt,Cn,!ct),Le=Cn,qm(this.layoutVertexArray,bt.x,bt.y,$t,tn,0,0,Qn),qm(this.layoutVertexArray,bt.x,bt.y,$t,tn,0,1,Qn),this.wallMode){let Q=K(Je,qe),ne=Y.joinNormals[Je];Wm(this.wallVertexArray,ne,Q),Wm(this.wallVertexArray,ne,Q)}if(He.vertexLength+=4,this.indexArray.emplaceBack(nn+0,nn+1,nn+2),this.indexArray.emplaceBack(nn+1,nn+3,nn+2),He.primitiveLength+=2,te){let Q=ke+(Je===1?qe.length-2:Je-2),ne=Je===1?ke:Q+1;if(this.indexArray.emplaceBack(nn+1,Q,nn+3),this.indexArray.emplaceBack(Q,ne,nn+3),He.primitiveLength+=2,tt===void 0&&(tt=nn),!A1(Ft,qe[Je],xe)){let ze=Je===qe.length-1?tt:He.vertexLength;this.indexArray.emplaceBack(nn+2,nn+3,ze),this.indexArray.emplaceBack(nn+3,ze+1,ze),this.indexArray.emplaceBack(nn+3,ne,ze+1),He.primitiveLength+=3}ct=!ct}if(D){let Q=this.layoutVertexExtArray,ne=S.projectTilePoint(yt.x,yt.y,l),ze=S.projectTilePoint(bt.x,bt.y,l),it=S.upVector(l,yt.x,yt.y),ut=S.upVector(l,bt.x,bt.y);Zm(Q,ne,it),Zm(Q,ne,it),Zm(Q,ze,ut),Zm(Q,ze,ut)}}R&&(ke+=qe.length-1),V&&te&&this.zoom>=17&&(Qe.length!==0&&de(Qe,Qe[0])&&Qe.pop(),this.groundEffect.addData(Qe,xe,b,te>0))}this.footprintSegments.push(Ye),Ze.triangleCount=this.indexArray.length-Ze.triangleArrayOffset,this.polygonSegments.push(Ze),++F.footprintSegLen,++F.polygonSegLen}if(F.vertexCount=this.layoutVertexArray.length-F.vertexArrayOffset,F.groundVertexCount=this.groundEffect.vertexArray.length-F.groundVertexArrayOffset,F.vertexCount!==0){if(F.centroidXY=L.borders?uD:this.encodeCentroid(L,F),this.centroidData.push(F),L.borders){this.featuresOnBorder.push(L);let ge=this.featuresOnBorder.length-1;for(let xe=0;xe<L.borders.length;xe++)L.borders[xe][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[xe].push(ge)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,f,p,l,x,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(e,s,f,p,l,x,this.worldview),this.maxHeight=Math.max(this.maxHeight,$)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort((n,s)=>this.featuresOnBorder[n].borders[e][0]-this.featuresOnBorder[s].borders[e][0])}splitToSubtiles(){let e=[];for(let y=0;y<this.centroidData.length;y++){let x=this.centroidData[y],b=+(x.min.y+x.max.y>at),I=2*b+(+(x.min.x+x.max.x>at)^b);for(let S=0;S<x.polygonSegLen;S++){let D=x.polygonSegIdx+S;e.push({centroidIdx:y,subtile:I,polygonSegmentIdx:D,triangleSegmentIdx:this.polygonSegments[D].triangleSegIdx})}}let n=new cr;e.sort((y,x)=>y.triangleSegmentIdx===x.triangleSegmentIdx?y.subtile-x.subtile:y.triangleSegmentIdx-x.triangleSegmentIdx);let s=0,l=0,f=0;for(let y of e){if(y.triangleSegmentIdx!==s)break;f++}let p=e.length;for(;l!==e.length;){s=e[l].triangleSegmentIdx;let y=0,x=l,b=l;for(let I=x;I<f&&e[I].subtile===y;I++)b++;for(;x!==f;){let I=e[x];y=I.subtile;let S=this.centroidData[I.centroidIdx].min.clone(),D=this.centroidData[I.centroidIdx].max.clone(),R={vertexOffset:this.segments.segments[s].vertexOffset,primitiveOffset:n.length,vertexLength:this.segments.segments[s].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let L=x;L<b;L++){let F=e[L],V=this.polygonSegments[F.polygonSegmentIdx],$=this.centroidData[F.centroidIdx].min,Y=this.centroidData[F.centroidIdx].max,K=this.indexArray.uint16;for(let z=V.triangleArrayOffset;z<V.triangleArrayOffset+V.triangleCount;z++)n.emplaceBack(K[3*z],K[3*z+1],K[3*z+2]);R.primitiveLength+=V.triangleCount,S.x=Math.min(S.x,$.x),S.y=Math.min(S.y,$.y),D.x=Math.max(D.x,Y.x),D.y=Math.max(D.y,Y.y)}R.primitiveLength>0&&this.triangleSubSegments.push({segment:R,min:S,max:D}),x=b;for(let L=x;L<f&&e[L].subtile===e[x].subtile;L++)b++}l=f;for(let I=l;I<p&&e[I].triangleSegmentIdx===e[l].triangleSegmentIdx;I++)f++}n._trim(),this.indexArray=n}getVisibleSegments(e,n,s){let l=new Di;if(this.wallMode){for(let F of this.triangleSubSegments)l.segments.push(F.segment);return l}let f=0,p=0,y=1<<e.canonical.z;if(n){let F=n.getMinMaxForTile(e);F&&(f=F.min,p=F.max)}p+=this.maxHeight;let x=e.toUnwrapped(),b,I=[x.canonical.x/y+x.wrap,x.canonical.y/y],S=[(x.canonical.x+1)/y+x.wrap,(x.canonical.y+1)/y],D=(F,V,$)=>[F[0]*(1-$[0])+V[0]*$[0],F[1]*(1-$[1])+V[1]*$[1]],R=[],L=[];for(let F of this.triangleSubSegments){R[0]=F.min.x/at,R[1]=F.min.y/at,L[0]=F.max.x/at,L[1]=F.max.y/at;let V=D(I,S,R),$=D(I,S,L);if(new _n([V[0],V[1],f],[$[0],$[1],p]).intersectsPrecise(s)===0){b&&(l.segments.push(b),b=void 0);continue}let Y=F.segment;b&&b.vertexOffset!==Y.vertexOffset&&(l.segments.push(b),b=void 0),b?(b.vertexLength+=Y.vertexLength,b.primitiveLength+=Y.primitiveLength):b={vertexOffset:Y.vertexOffset,primitiveLength:Y.primitiveLength,vertexLength:Y.vertexLength,primitiveOffset:Y.primitiveOffset,sortKey:void 0,vaos:{}}}return b&&l.segments.push(b),l}encodeCentroid(e,n){let s=e.centroid(),l=n.span(),f=Math.min(7,Math.round(l.x*this.tileToMeter/10)),p=Math.min(7,Math.round(l.y*this.tileToMeter/10));return new ot(ae(s.x,1,at-1)<<3|f,ae(s.y,1,at-1)<<3|p)}encodeBorderCentroid(e){if(!e.borders)return new ot(0,0);let n=e.borders,s=Number.MAX_VALUE;if(n[0][0]!==s||n[1][0]!==s){let l=n[0][0]!==s?0:1;return new ot(6|(n[0][0]!==s?0:65528),(n[l][0]+n[l][1])/2<<3|6)}{let l=n[2][0]!==s?2:3;return new ot((n[l][0]+n[l][1])/2<<3|6,6|(n[2][0]!==s?0:65528))}}showCentroid(e){let n=this.centroidData[e.centroidDataIndex];n.flags&=Vc,n.centroidXY.x=0,n.centroidXY.y=0,this.writeCentroidToBuffer(n)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);let n=e.vertexArrayOffset,s=e.vertexCount+e.vertexArrayOffset,l=e.flags&Vc?uD:e.centroidXY,f=this.centroidVertexArray.geta_centroid_pos0(n);if(this.centroidVertexArray.geta_centroid_pos1(n)!==l.y||f!==l.x){for(let p=n;p<s;++p)this.centroidVertexArray.emplace(p,l.x,l.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(let e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,n,s){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;let l=n.getReplacementRegionsForTile(e.toUnwrapped());if(D1(this.activeReplacements,l))return;if(this.activeReplacements=l,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(let p of this.centroidData)p.flags&=2147483647;let f=[];for(let p of this.activeReplacements){if(p.order<s)continue;let y=Math.max(1,Math.pow(2,p.footprintTileId.canonical.z-e.canonical.z));for(let x of this.centroidData)if(!(x.flags&Vc||p.min.x>x.max.x||x.min.x>p.max.x||p.min.y>x.max.y||x.min.y>p.max.y))for(let b=0;b<x.footprintSegLen;b++){let I=this.footprintSegments[x.footprintSegIdx+b];if(f.length=0,hk(this.footprintVertices,I.vertexOffset,I.vertexCount,p.footprintTileId.canonical,e.canonical,f),oD(p.footprint,f,this.footprintIndices.uint16,I.indexOffset,I.indexCount,-I.vertexOffset,-y)){x.flags|=Vc;break}}}for(let p of this.centroidData)this.writeCentroidToBuffer(p);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,n,s){let l=!1;for(let f=0;f<s.footprintSegLen;f++){let p=this.footprintSegments[s.footprintSegIdx+f],y=0;for(let x of p.ringIndices){for(let b=y,I=x+y-1;b<x+y;I=b++){let S=this.footprintVertices.int16[2*(b+p.vertexOffset)+0],D=this.footprintVertices.int16[2*(b+p.vertexOffset)+1],R=this.footprintVertices.int16[2*(I+p.vertexOffset)+1];D>n!=R>n&&e<(this.footprintVertices.int16[2*(I+p.vertexOffset)+0]-S)*(n-D)/(R-D)+S&&(l=!l)}y=x}}return l}getHeightAtTileCoord(e,n){let s=Number.NEGATIVE_INFINITY,l=!0,f=4*(e+at)*at+(n+at);if(this.partLookup.hasOwnProperty(f)){let p=this.partLookup[f];return p?{height:p.height,hidden:!!(p.flags&Vc)}:void 0}for(let p of this.centroidData)e>p.max.x||p.min.x>e||n>p.max.y||p.min.y>n||this.footprintContainsPoint(e,n,p)&&p&&p.height>s&&(s=p.height,this.partLookup[f]=p,l=!!(p.flags&Vc));if(s!==Number.NEGATIVE_INFINITY)return{height:s,hidden:l};this.partLookup[f]=void 0}}function gD(r,e){let n=r.add(e)._unit();return r.x*n.x+r.y*n.y}function uk(r,e,n,s){let l=e.sub(r)._perp()._unit(),f=n.sub(e)._perp()._unit();return _D(r,e,n,gD(l,f),s)}function _D(r,e,n,s,l){let f=Math.sqrt(1-s*s);return Math.min(r.dist(e)/3,e.dist(n)/3,l*f/s)}function A1(r,e,n){return r.x<n[0].x&&e.x<n[0].x||r.x>n[1].x&&e.x>n[1].x||r.y<n[0].y&&e.y<n[0].y||r.y>n[1].y&&e.y>n[1].y}function yD(r,e){return r.x<e[0].x||r.x>e[1].x||r.y<e[0].y||r.y>e[1].y}function vD(r,e,n){if(r.x<0||r.x>=at||e.x<0||e.x>=at||n.x<0||n.x>=at)return!1;let s=n.sub(e),l=s.perp(),f=r.sub(e);return(s.x*f.x+s.y*f.y)/Math.sqrt((s.x*s.x+s.y*s.y)*(f.x*f.x+f.y*f.y))>-.866&&l.x*f.x+l.y*f.y<0}function xD(r,e,n){let s=e?2|r:-3&r;return n?1|s:-2&s}function bD(){let r=Math.PI/32,e=Math.tan(r),n=U;return n*Math.sqrt(1+2*e*e)-n}function wD(r,e,n){let s=1<<n.z,l=fe(n.x/s),f=fe((n.x+1)/s),p=Te(n.y/s),y=Te((n.y+1)/s);return function(x,b,I,S,D=0,R){let L=[];if(!x.length||!I||!S)return L;let F=(J,te)=>{for(let me of J)L.push({polygon:me,bounds:te})},V=Math.ceil(Math.log2(I)),$=Math.ceil(Math.log2(S)),Y=V-$,K=[];for(let J=0;J<Math.abs(Y);J++)K.push(Y>0?0:1);for(let J=0;J<Math.min(V,$);J++)K.push(0),K.push(1);let z=x;if(z=Xy(z,b[0].y-D,b[1].y+D,1),z=Xy(z,b[0].x-D,b[1].x+D,0),!z.length)return L;let W=[];for(K.length?W.push({polygons:z,bounds:b,depth:0}):F(z,b);W.length;){let J=W.pop(),te=J.depth,me=K[te],de=J.bounds[0],ge=J.bounds[1],xe=me===0?de.x:de.y,ke=me===0?ge.x:ge.y,Xe=R?R(me,xe,ke):.5*(xe+ke),He=Xy(J.polygons,xe-D,Xe+D,me),Ze=Xy(J.polygons,Xe-D,ke+D,me);if(He.length){let Ye=[de,new ot(me===0?Xe:ge.x,me===1?Xe:ge.y)];K.length>te+1?W.push({polygons:He,bounds:Ye,depth:te+1}):F(He,Ye)}if(Ze.length){let Ye=[new ot(me===0?Xe:de.x,me===1?Xe:de.y),ge];K.length>te+1?W.push({polygons:Ze,bounds:Ye,depth:te+1}):F(Ze,Ye)}}return L}(r,e,Math.ceil((f-l)/11.25),Math.ceil((p-y)/11.25),1,(x,b,I)=>{if(x===0)return .5*(b+I);{let S=Te((n.y+b/at)/s);return(oe(.5*(Te((n.y+I/at)/s)+S))*s-n.y)*at}})}function hk(r,e,n,s,l,f){let p=Math.pow(2,s.z-l.z);for(let y=0;y<n;y++){let x=r.int16[2*(y+e)+0],b=r.int16[2*(y+e)+1];x=(x+l.x*at)*p-s.x*at,b=(b+l.y*at)*p-s.y*at,f.push(new ot(x,b))}}let ED,TD;pt(Qy,"FillExtrusionBucket",{omit:["layers","features"]}),pt(dD,"PartData"),pt(hD,"FootprintSegment"),pt(fD,"BorderCentroidData"),pt(mD,"GroundEffect");class yh extends ot{constructor(e,n,s){super(e,n),this.z=s}}class ID extends yh{constructor(e,n,s,l){super(e,n,s),this.w=l}}function SD(r,e,n,s){let l=n==="x"?"y":"x",f=(s-r[n])/(e[n]-r[n]);r[l]=Math.round(r[l]+(e[l]-r[l])*f),r[n]=s,r.hasOwnProperty("z")&&(r.z=kt(r.z,e.z,f)),r.hasOwnProperty("w")&&(r.w=kt(r.w,e.w,f))}function DD(r,e,n,s){let l=n,f=s;for(let p of["x","y"]){let y=r,x=e;y[p]>=x[p]&&(y=e,x=r),y[p]<l&&x[p]>l&&SD(y,x,p,l),y[p]<f&&x[p]>f&&SD(x,y,p,f)}}function ev(r,e,n,s,l,f){let p=[];for(let y=0;y<r.length;y++){let x=r[y],b,I=p.length,S=0;for(let D=0;D<x.length-1;D++){let R=x[D],L=x[D+1],F=0,V=S,$,Y;f&&(F=Math.hypot(L.x-R.x,L.y-R.y),S+=F,$=R,Y=L),R.x<e&&L.x<e||(R.x<e?R=new ot(e,R.y+(e-R.x)/(L.x-R.x)*(L.y-R.y))._round():L.x<e&&(L=new ot(e,R.y+(e-R.x)/(L.x-R.x)*(L.y-R.y))._round()),R.y<n&&L.y<n||(R.y<n?R=new ot(R.x+(n-R.y)/(L.y-R.y)*(L.x-R.x),n)._round():L.y<n&&(L=new ot(R.x+(n-R.y)/(L.y-R.y)*(L.x-R.x),n)._round()),R.x>=s&&L.x>=s||(R.x>=s?R=new ot(s,R.y+(s-R.x)/(L.x-R.x)*(L.y-R.y))._round():L.x>=s&&(L=new ot(s,R.y+(s-R.x)/(L.x-R.x)*(L.y-R.y))._round()),R.y>=l&&L.y>=l||(R.y>=l?R=new ot(R.x+(l-R.y)/(L.y-R.y)*(L.x-R.x),l)._round():L.y>=l&&(L=new ot(R.x+(l-R.y)/(L.y-R.y)*(L.x-R.x),l)._round()),b&&R.equals(b[b.length-1])||(b=[R],p.push(b),f&&f.push({progress:{min:V+CD($,Y,R)*F,max:1},parentIndex:y,prevPoint:$,nextPoint:Y})),b.push(L),f&&(f[f.length-1].progress.max=V+CD($,Y,L)*F,f[f.length-1].nextPoint=Y)))))}if(f&&S>0)for(let D=I;D<p.length;D++)f[D].progress.min/=S,f[D].progress.max/=S}return p}function dk(r,e,n,s,l){if(r.length<2)return void s.push(r);let f=[];for(;e.valid();){let[b,I]=e.get();for(let S=0;S<r.length-1;S++){let D=r[S],R=r[S+1],L=zm(D,R,b,I);if(L){let[F]=L,V=new ot(kt(D.x,R.x,F),kt(D.y,R.y,F));f.push({t:S+F,distance:0,point:V})}}e.next()}if(f.length===0)return void s.push(r);f.sort((b,I)=>b.t-I.t);let p=0,y=0,x=[];for(s.push(x);p!==r.length;){if(y===f.length){for(;p!==r.length;)x.length!==0&&x[x.length-1].equals(r[p])||x.push(r[p]),p++;break}f[y].t<=p?(x.length!==0&&x[x.length-1].equals(f[y].point)||x.push(f[y].point),Math.trunc(f[y].t),y++):(x.length!==0&&x[x.length-1].equals(r[p])||x.push(r[p]),p++)}}function CD(r,e,n){return r.x!==e.x?(n.x-r.x)/(e.x-r.x):r.y!==e.y?(n.y-r.y)/(e.y-r.y):0}function Xm(r,e){return r.x*e.x+r.y*e.y}function MD(r,e){if(r.length===1){let n=0,s=e[n++],l;for(;!l||s.equals(l);)if(l=e[n++],!l)return 1/0;for(;n<e.length;n++){let f=e[n],p=r[0],y=l.sub(s),x=f.sub(s),b=p.sub(s),I=Xm(y,y),S=Xm(y,x),D=Xm(x,x),R=Xm(b,y),L=Xm(b,x),F=I*D-S*S,V=(D*R-S*L)/F,$=(I*L-S*R)/F,Y=s.z*(1-V-$)+l.z*V+f.z*$;if(isFinite(Y))return Y}return 1/0}{let n=1/0;for(let s of e)n=Math.min(n,s.z);return n}}function AD(r,e,n,s,l,f,p,y){let x=p*l.getElevationAt(r,e,!0,!0),b=f[0]!==0,I=b?f[1]===0?p*(f[0]/7-450):p*function(S,D,R){let L=Math.floor(D[0]/8),F=Math.floor(D[1]/8),V=10*(D[0]-8*L),$=10*(D[1]-8*F),Y=S.getElevationAt(L,F,!0,!0),K=S.getMeterToDEM(R),z=Math.floor(.5*(V*K-1)),W=Math.floor(.5*($*K-1)),J=S.tileCoordToPixel(L,F),te=2*z+1,me=2*W+1,de=function(Ze,Ye,Ne,qe,Le){return[Ze.getElevationAtPixel(Ye,Ne,!0),Ze.getElevationAtPixel(Ye+Le,Ne,!0),Ze.getElevationAtPixel(Ye,Ne+Le,!0),Ze.getElevationAtPixel(Ye+qe,Ne+Le,!0)]}(S,J.x-z,J.y-W,te,me),ge=Math.abs(de[0]-de[1]),xe=Math.abs(de[2]-de[3]),ke=Math.abs(de[0]-de[2])+Math.abs(de[1]-de[3]),Xe=Math.min(.25,.5*K*(ge+xe)/te),He=Math.min(.25,.5*K*ke/me);return Y+Math.max(Xe*V,He*$)}(l,f,y):x;return{base:x+(n===0?-1:n),top:b?Math.max(I+s,x+n+2):x+s}}class fk{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class pk{constructor(){this.tasks={},this.taskQueue=[],xt(["process"],this),this.invoker=new fk(this.process),this.nextId=0}add(e,n){let s=this.nextId++,l=function({type:f,isSymbolTile:p,zoom:y}){return y=y||0,f==="message"?0:f!=="maybePrepare"||p?f!=="parseTile"||p?f==="parseTile"&&p?300-y:f==="maybePrepare"&&p?400-y:500:200-y:100-y}(n);if(l===0){try{e()}finally{}return null}return this.tasks[s]={fn:e,metadata:n,priority:l,id:s},this.taskQueue.push(s),this.invoker.trigger(),{cancel:()=>{delete this.tasks[s]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(s=>!!this.tasks[s]),!this.taskQueue.length)return;let e=this.pick();if(e===null)return;let n=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!n)return;n.fn()}finally{}}pick(){let e=null,n=1/0;for(let l=0;l<this.taskQueue.length;l++){let f=this.tasks[this.taskQueue[l]];f.priority<n&&(n=f.priority,e=l)}if(e===null)return null;let s=this.taskQueue[e];return this.taskQueue.splice(e,1),s}remove(){this.invoker.remove()}}class RD{constructor(e,n,s){this.target=e,this.parent=n,this.mapId=s,this.callbacks={},this.cancelCallbacks={},xt(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new pk}send(e,n,s,l,f=!1,p){let y=Math.round(1e18*Math.random()).toString(36).substring(0,10);s&&(s.metadata=p,this.callbacks[y]=s);let x=new Set;return this.target.postMessage({id:y,type:e,hasCallback:!!s,targetMapId:l,mustQueue:f,sourceMapId:this.mapId,data:Ia(n,x)},x),{cancel:()=>{s&&delete this.callbacks[y],this.target.postMessage({id:y,type:"<cancel>",targetMapId:l,sourceMapId:this.mapId})}}}receive(e){let n=e.data;if(!n)return;let s=n.id;if(s&&(!n.targetMapId||this.mapId===n.targetMapId))if(n.type==="<cancel>"){let l=this.cancelCallbacks[s];delete this.cancelCallbacks[s],l&&l.cancel()}else if(n.mustQueue||An(self)){let l=this.callbacks[s],f=this.scheduler.add(()=>this.processTask(s,n),l&&l.metadata||{type:"message"});f&&(this.cancelCallbacks[s]=f)}else this.processTask(s,n)}processTask(e,n){if(delete this.cancelCallbacks[e],n.type==="<response>"){let s=this.callbacks[e];delete this.callbacks[e],s&&(n.error?s(Sa(n.error)):s(null,Sa(n.data)))}else{let s=new Set,l=n.hasCallback?(p,y)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:p?Ia(p):null,data:Ia(y,s)},s)}:()=>{},f=Sa(n.data);if(this.parent[n.type])this.parent[n.type](n.sourceMapId,f,l);else if(this.parent.getWorkerSource){let p=n.type.split("."),{source:y,scope:x}=f;this.parent.getWorkerSource(n.sourceMapId,p[0],y,x)[p[1]](f,l)}else l(new Error(`Could not find function ${n.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var Ym={workerUrl:"",workerClass:null,workerParams:void 0};let R1="mapboxgl_preloaded_worker_pool",tv=(()=>{class r{constructor(){this.active={}}acquire(n,s=r.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<s;)this.workers.push(Ym.workerClass!=null?new Ym.workerClass:new self.Worker(Ym.workerUrl,Ym.workerParams));return this.active[n]=!0,this.workers.slice()}release(n){delete this.active[n],this.workers&&this.numActive()===0&&(this.workers.forEach(s=>{s.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[R1]}numActive(){return Object.keys(this.active).length}}return r.workerCount=2,r})();class uf{constructor(e,n,s="Worker",l=tv.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=Re();let f=this.workerPool.acquire(this.id,l);for(let p=0;p<f.length;p++){let y=new uf.Actor(f[p],n,this.id);y.name=`${s} ${p}`,this.actors.push(y)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,n,s){ve(this.actors,(l,f)=>{l.send(e,n,f)},s=s||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(e=>{e.remove()}),this.actors=[],this.workerPool.release(this.id)}}let Km,P1;function nv(){return Km||(Km=new tv),Km}uf.Actor=RD;class mk{constructor(e){this.module=e}createIntArray(e){let n=new Int32Array(e),s=this.module.malloc(n.length*n.BYTES_PER_ELEMENT);return this.module.heap32.set(n,s/n.BYTES_PER_ELEMENT),s}createFloatArray(e){let n=new Float32Array(e),s=this.module.malloc(n.length*n.BYTES_PER_ELEMENT);return this.module.heapF32.set(n,s/n.BYTES_PER_ELEMENT),s}createStringBuffer(e){let n=this.module.malloc(e.length+1);for(let s=0;s<e.length;++s)this.module.heapU8[n+s]=e.charCodeAt(s);return this.module.heapU8[n+e.length]=0,n}readStringBuffer(e){let n="";for(;this.module.heapU8[e]!==0;)n+=String.fromCharCode(this.module.heapU8[e]),++e;return n}setStyle(e){let n=e.entranceColorRgb,s=e.facadeGlazingColorRgb,l=e.roofColorRgb,f=e.wallColorRgb,p=e.normalScale;this.module.setStyle(n[0],n[1],n[2],s[0],s[1],s[2],l[0],l[1],l[2],f[0],f[1],f[2],p[0],p[1],p[2],e.tileToMeters)}setAOOptions(e,n){this.module.setAOOptions(e?1:0,n)}setMetricOptions(e,n){this.module.setMetricOptions(e?1:0,n)}setFacadeOptions(e,n,s){this.module.setFacadeOptions(e,n,s)}generateMesh(e,n){for(let y of e){let x=this.createStringBuffer(y.roofType),b=[0],I=[];for(let R of y.coordinates)if(Array.isArray(R)){for(let L of R)I.push(L.x),I.push(L.y);b.push(I.length)}let S=this.createIntArray(b),D=this.createFloatArray(I);this.module.addFeature(y.id,y.sourceId,y.minHeight,y.height,x,y.roofType.length,D,S,b.length-1),this.module.free(x),this.module.free(S),this.module.free(D)}for(let y of n){let x;x=y.entrances?JSON.parse(y.entrances):[];let b=this.createFloatArray(x),I=[];for(let D of y.coordinates)I.push(D.x),I.push(D.y);let S=this.createFloatArray(I);this.module.addFacade(y.sourceId,y.crossPerc,y.distanceToRoad,b,x.length,S,I.length),this.module.free(b),this.module.free(S)}if(!this.module.generateMesh()){let y=this.module.getLastError();return this.readStringBuffer(y)}let s=this.module.getMeshCount(),l=new Array(s);for(let y=0;y<s;y++){let x=this.module.getPositionsPtr(y),b=this.module.getPositionsLength(y),I=new Float32Array(this.module.heapF32.buffer,x,b),S=this.module.getNormalsPtr(y),D=this.module.getNormalsLength(y),R=new Float32Array(this.module.heapF32.buffer,S,D),L=this.module.getColorsPtr(y),F=this.module.getColorsLength(y),V=new Uint8Array(this.module.heapU8.buffer,L,F),$=this.module.getAOPtr(y),Y=this.module.getAOLength(y),K=new Float32Array(this.module.heapF32.buffer,$,Y),z=this.module.getIndicesPtr(y),W=this.module.getIndicesLength(y),J=new Int32Array(this.module.heap32.buffer,z,W),te=this.module.getBuildingPart(y),me=this.readStringBuffer(te);l[y]={positions:I,normals:R,colors:V,ao:K,indices:J,buildingPart:me}}let f=this.module.getRingCount(),p=[];for(let y=0;y<f;y++){let x=this.module.getRingPtr(y),b=this.module.getRingLength(y),I=new Float32Array(this.module.heapF32.buffer,x,b);p.push(I)}return{meshes:l,modifiedPolygonRings:p}}}let Jm,L1,Zs,hf,O1,df=null,ff=null,PD=null,k1=null;function LD(){return An(self)&&self.worker.dracoUrl?self.worker.dracoUrl:L1||ar.DRACO_URL}function OD(){if(An(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(hf)return hf;let r=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return hf=WebAssembly.validate(r)?ar.MESHOPT_SIMD_URL:ar.MESHOPT_URL,hf}let iv={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},gk={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},Qm={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function kD(r,e,n){let s=n.json.bufferViews.length,l=n.buffers.length;e.bufferView=s,n.json.bufferViews[s]={buffer:l,byteLength:r.byteLength},n.buffers[l]=r}let F1="KHR_draco_mesh_compression";function _k(r,e){let n=r.extensions&&r.extensions[F1];if(!n)return;let s=new Zs.Decoder,l=BD(e,n.bufferView),f=new Zs.Mesh;if(!s.DecodeArrayToMesh(l,l.byteLength,f))throw new Error("Failed to decode Draco mesh");let p=e.json.accessors[r.indices],y=iv[p.componentType],x=p.count*y.BYTES_PER_ELEMENT,b=Zs._malloc(x);y===Uint16Array?s.GetTrianglesUInt16Array(f,x,b):s.GetTrianglesUInt32Array(f,x,b),kD(Zs.memory.buffer.slice(b,b+x),p,e),Zs._free(b);for(let I of Object.keys(n.attributes)){let S=s.GetAttributeByUniqueId(f,n.attributes[I]),D=e.json.accessors[r.attributes[I]],R=gk[D.componentType],L=D.count*Qm[D.type]*iv[D.componentType].BYTES_PER_ELEMENT,F=Zs._malloc(L);s.GetAttributeDataArrayForAllPoints(f,S,Zs[R],L,F),kD(Zs.memory.buffer.slice(F,F+L),D,e),Zs._free(F)}s.destroy(),f.destroy(),delete r.extensions[F1]}let rv="EXT_meshopt_compression";function yk(r,e){if(!r.extensions||!r.extensions[rv])return;let n=r.extensions[rv],s=new Uint8Array(e.buffers[n.buffer],n.byteOffset||0,n.byteLength||0),l=new Uint8Array(n.count*n.byteStride);O1.decodeGltfBuffer(l,n.count,n.byteStride,s,n.mode,n.filter),r.buffer=e.buffers.length,r.byteOffset=0,e.buffers[r.buffer]=l.buffer,delete r.extensions[rv]}let FD=1179937895,ND=new TextDecoder("utf8");function zD(r,e){return new URL(r,e).href}function vk(r,e,n,s){return fetch(zD(r.uri,s)).then(l=>l.arrayBuffer()).then(l=>{e.buffers[n]=l})}function BD(r,e){let n=r.json.bufferViews[e];return new Uint8Array(r.buffers[n.buffer],n.byteOffset||0,n.byteLength)}function xk(r,e,n,s){if(r.uri){let l=zD(r.uri,s);return fetch(l).then(f=>f.blob()).then(f=>createImageBitmap(f)).then(f=>{e.images[n]=f})}if(r.bufferView!==void 0){let l=BD(e,r.bufferView),f=new Blob([l],{type:r.mimeType});return createImageBitmap(f).then(p=>{e.images[n]=p})}}function VD(r,e=0,n){let s={json:null,images:[],buffers:[]};if(new Uint32Array(r,e,1)[0]===FD){let I=new Uint32Array(r,e),S=2,D=(I[S++]>>2)-3,R=I[S++]>>2;if(S++,s.json=JSON.parse(ND.decode(I.subarray(S,S+R))),S+=R,S<D){let L=I[S++];S++;let F=e+(S<<2);s.buffers[0]=r.slice(F,F+L)}}else s.json=JSON.parse(ND.decode(new Uint8Array(r,e)));let{buffers:l,images:f,meshes:p,extensionsUsed:y,bufferViews:x}=s.json,b=Promise.resolve();if(l){let I=[];for(let S=0;S<l.length;S++){let D=l[S];D.uri?I.push(vk(D,s,S,n)):s.buffers[S]||(s.buffers[S]=null)}b=Promise.all(I)}return b.then(()=>{let I=[],S=y&&y.includes(F1),D=y&&y.includes(rv);if(S&&I.push(function(){if(!Zs)return Jm??(Jm=function(R){let L,F=null;function V(){L=new Uint8Array(F.buffer)}function $(){throw new Error("Unexpected Draco error.")}let Y={a:{a:$,d:function(K,z,W){return L.copyWithin(K,z,z+W)},c:function(K){let z=L.length,W=Math.max(K>>>0,Math.ceil(1.2*z)),J=Math.ceil((W-z)/65536);try{return F.grow(J),V(),!0}catch{return!1}},b:$}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(R,Y):R.then(K=>K.arrayBuffer()).then(K=>WebAssembly.instantiate(K,Y))).then(K=>{let{Rb:z,Qb:W,P:J,T:te,X:me,Ja:de,La:ge,Qa:xe,Va:ke,Wa:Xe,eb:He,jb:Ze,f:Ye,e:Ne,yb:qe,zb:Le,Ab:Fe,Bb:Qe,Db:tt,Gb:Dt}=K.instance.exports;F=Ne;let vt=(()=>{let ct=0,Je=0,jt=0,yt=0;return bt=>{jt&&(z(yt),z(ct),Je+=jt,jt=ct=0),ct||(Je+=128,ct=W(Je));let Ft=bt.length+7&-8,Gt=ct;Ft>=Je&&(jt=Ft,Gt=yt=W(Ft));for(let $t=0;$t<bt.length;$t++)L[Gt+$t]=bt[$t];return Gt}})();return V(),Ye(),{memory:Ne,_free:z,_malloc:W,Mesh:class{constructor(){this.ptr=J()}destroy(){te(this.ptr)}},Decoder:class{constructor(){this.ptr=de()}destroy(){Ze(this.ptr)}DecodeArrayToMesh(ct,Je,jt){let yt=vt(ct),bt=ge(this.ptr,yt,Je,jt.ptr);return!!me(bt)}GetAttributeByUniqueId(ct,Je){return{ptr:xe(this.ptr,ct.ptr,Je)}}GetTrianglesUInt16Array(ct,Je,jt){ke(this.ptr,ct.ptr,Je,jt)}GetTrianglesUInt32Array(ct,Je,jt){Xe(this.ptr,ct.ptr,Je,jt)}GetAttributeDataArrayForAllPoints(ct,Je,jt,yt,bt){He(this.ptr,ct.ptr,Je.ptr,jt,yt,bt)}},DT_INT8:qe(),DT_UINT8:Le(),DT_INT16:Fe(),DT_UINT16:Qe(),DT_UINT32:tt(),DT_FLOAT32:Dt()}})}(fetch(LD())),Jm.then(R=>{Zs=R,Jm=void 0}))}()),D&&I.push(function(){if(O1)return;let R=function(L){let F,V=WebAssembly.instantiateStreaming(L,{}).then(K=>{F=K.instance,F.exports.__wasm_call_ctors()}),$={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},Y={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:V,supported:!0,decodeGltfBuffer(K,z,W,J,te,me){(function(de,ge,xe,ke,Xe,He,Ze){let Ye=de.exports.sbrk,Ne=ke+3&-4,qe=Ye(Ne*Xe),Le=Ye(He.length),Fe=new Uint8Array(de.exports.memory.buffer);Fe.set(He,Le);let Qe=ge(qe,ke,Xe,Le,He.length);if(Qe===0&&Ze&&Ze(qe,Ne,Xe),xe.set(Fe.subarray(qe,qe+ke*Xe)),Ye(qe-Ye(0)),Qe!==0)throw new Error(`Malformed buffer data: ${Qe}`)})(F,F.exports[Y[te]],K,z,W,J,F.exports[$[me]])}}}(fetch(OD()));return R.ready.then(()=>{O1=R})}()),f)for(let R=0;R<f.length;R++)I.push(xk(f[R],s,R,n));return(I.length?Promise.all(I):Promise.resolve()).then(()=>{if(S&&p)for(let{primitives:R}of p)for(let L of R)_k(L,s);if(D&&p&&x)for(let R of x)yk(R,s);return s})})}class jD{constructor(e){this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.hasPattern=!1,this.worldview=e.worldview}updateFootprints(e,n){}prepare(){return function(){if(k1!=null||PD!=null)return null;if(ff!=null)return ff;let e=fetch(ar.BUILDING_GEN_URL);return ff=function(n){let s,l,f,p;function y(){s=new Uint8Array(p.buffer),l=new Int32Array(p.buffer),f=new Float32Array(p.buffer)}function x(){throw new Error("Unexpected BuildingGen error.")}let b=()=>{},I={a:{a:x,f:function(S){let D=s.length,R=Math.max(S>>>0,Math.ceil(1.2*D)),L=Math.ceil((R-D)/65536);try{return p.grow(L),y(),!0}catch{return!1}},g:x,b,c:b,d:b,e:b}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(n,I):n.then(S=>S.arrayBuffer()).then(S=>WebAssembly.instantiate(S,I))).then(S=>{let D=S.instance.exports;return(0,D.g)(),p=D.f,y(),new mk({setStyle:D.h,setAOOptions:D.i,setMetricOptions:D.j,setFacadeOptions:D.k,addFeature:D.l,addFacade:D.m,generateMesh:D.n,getLastError:D.o,getMeshCount:D.p,getPositionsPtr:D.q,getPositionsLength:D.r,getNormalsPtr:D.s,getNormalsLength:D.t,getColorsPtr:D.u,getColorsLength:D.v,getAOPtr:D.w,getAOLength:D.x,getIndicesPtr:D.y,getIndicesLength:D.z,getBuildingPart:D.A,getRingCount:D.B,getRingPtr:D.C,getRingLength:D.D,free:D.E,malloc:D.F,heapU8:s,heap32:l,heapF32:f})})}(e).then(n=>(ff=null,k1=n,k1)).catch(n=>{qt("Could not load building-gen"),ff=null,PD=n}),ff}()}populate(e,n,s,l){}update(e,n,s,l,f,p,y){}isEmpty(){return!1}uploadPending(){return!1}upload(e){}destroy(){}getHeightAtTileCoord(e,n){return{height:Number.NEGATIVE_INFINITY,hidden:!0}}}let UD,HD;pt(jD,"BuildingBucket",{omit:["layers"]});let bk=mn([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),wk=mn([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:Ek}=bk,Tk=mn([{name:"a_packed",components:3,type:"Float32"}]),{members:Ik}=Tk,Sk=mn([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:Dk}=Sk;class $D{constructor(e,n){this.width=e,this.height=n,this.nextRow=0,this.image=new Bc({width:e,height:n}),this.positions={},this.uploaded=!1}getDash(e,n){let s=this.getKey(e,n);return this.positions[s]}trim(){let e=this.width,n=this.height=rt(this.nextRow);this.image.resize({width:e,height:n})}getKey(e,n){return e.join(",")+n}getDashRanges(e,n,s){let l=[],f=e.length%2==1?-e[e.length-1]*s:0,p=e[0]*s,y=!0;l.push({left:f,right:p,isDash:y,zeroLength:e[0]===0});let x=e[0];for(let b=1;b<e.length;b++){y=!y;let I=e[b];f=x*s,x+=I,p=x*s,l.push({left:f,right:p,isDash:y,zeroLength:I===0})}return l}addRoundDash(e,n,s){let l=n/2;for(let f=-s;f<=s;f++){let p=this.width*(this.nextRow+s+f),y=0,x=e[y];for(let b=0;b<this.width;b++){b/x.right>1&&(x=e[++y]);let I=Math.abs(b-x.left),S=Math.abs(b-x.right),D=Math.min(I,S),R,L=f/s*(l+1);if(x.isDash){let F=l-Math.abs(L);R=Math.sqrt(D*D+F*F)}else R=l-Math.sqrt(D*D+L*L);this.image.data[p+b]=Math.max(0,Math.min(255,R+128))}}}addRegularDash(e,n){for(let x=e.length-1;x>=0;--x){let b=e[x],I=e[x+1];b.zeroLength?e.splice(x,1):I&&I.isDash===b.isDash&&(I.left=b.left,e.splice(x,1))}let s=e[0],l=e[e.length-1];s.isDash===l.isDash&&(s.left=l.left-this.width,l.right=s.right+this.width);let f=this.width*this.nextRow,p=0,y=e[p];for(let x=0;x<this.width;x++){x/y.right>1&&(y=e[++p]);let b=Math.abs(x-y.left),I=Math.abs(x-y.right),S=Math.min(b,I);this.image.data[f+x]=Math.max(0,Math.min(255,(y.isDash?S:-S)+n+128))}}addDash(e,n){let s=this.getKey(e,n);if(this.positions[s])return this.positions[s];let l=n==="round",f=l?7:0,p=2*f+1;if(this.nextRow+p>this.height)return qt("LineAtlas out of space"),null;e.length===0&&e.push(1);let y=0;for(let I=0;I<e.length;I++)e[I]<0&&(qt("Negative value is found in line dasharray, replacing values with 0"),e[I]=0),y+=e[I];if(y!==0){let I=this.width/y,S=this.getDashRanges(e,this.width,I);l?this.addRoundDash(S,I,f):this.addRegularDash(S,n==="square"?.5*I:0)}let x=this.nextRow+f;this.nextRow+=p;let b={tl:[x,f],br:[y,0]};return this.positions[s]=b,b}}pt($D,"LineAtlas");let Ck=Kt.VectorTileFeature.types,Mk=Math.cos(Math.PI/180*37.5),Ak=Math.cos(Math.PI/180*5);class N1{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(n=>{this.gradients[n.id]={}}),this.layoutVertexArray=new Tm,this.layoutVertexArray2=new gs,this.patternVertexArray=new gs,this.indexArray=new cr,this.programConfigurations=new u(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new Di,this.maxLineLength=0,this.zOffsetVertexArray=new gs,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.tessellationStep=e.tessellationStep?e.tessellationStep:at/64,this.worldview=e.worldview}updateFootprints(e,n){}populate(e,n,s,l){this.hasPattern=x1("line",this.layers,this.pixelRatio,n);let f=this.layers[0].layout.get("line-sort-key");this.tileToMeter=Oe(s);let p=this.layers[0].layout.get("line-elevation-reference");if(p==="hd-road-markup")this.elevationType="road";else{let D=this.layers[0].layout.get("line-z-offset"),R=D.isConstant()&&!D.constantOr(0);this.elevationType=p!=="sea"&&p!=="ground"&&R?"none":"offset",this.elevationType==="offset"&&p==="none"&&qt(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}let y=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.elevationType==="offset"&&y!==void 0;let x=[];for(let{feature:D,id:R,index:L,sourceLayerIndex:F}of e){let V=this.layers[0]._featureFilter.needGeometry,$=dt(D,V);if(!this.layers[0]._featureFilter.filter(new zn(this.zoom,{worldview:this.worldview}),$,s))continue;let Y=f?f.evaluate($,{},s):void 0,K={id:R,properties:D.properties,type:D.type,sourceLayerIndex:F,index:L,geometry:V?$.geometry:gt(D,s,l),patterns:{},sortKey:Y};x.push(K)}f&&x.sort((D,R)=>D.sortKey-R.sortKey);let{lineAtlas:b,featureIndex:I}=n,S=this.addConstantDashes(b);for(let D of x){let{geometry:R,index:L,sourceLayerIndex:F}=D;if(S&&this.addFeatureDashes(D,b),this.hasPattern){let V=b1("line",this.layers,D,this.zoom,this.pixelRatio,n);this.patternFeatures.push(V)}else this.addFeature(D,R,L,s,b.positions,n.availableImages,n.brightness,n.elevationFeatures);I.insert(e[L].feature,R,L,F,this.index)}}addConstantDashes(e){let n=!1;for(let s of this.layers){let l=s.paint.get("line-dasharray").value,f=s.layout.get("line-cap").value;if(l.kind!=="constant"||f.kind!=="constant")n=!0;else{let p=f.value,y=l.value;if(!y)continue;e.addDash(y,p)}}return n}addFeatureDashes(e,n){let s=this.zoom;for(let l of this.layers){let f=l.paint.get("line-dasharray").value,p=l.layout.get("line-cap").value;if(f.kind==="constant"&&p.kind==="constant")continue;let y,x;if(f.kind==="constant"){if(y=f.value,!y)continue}else y=f.evaluate({zoom:s},e);x=p.kind==="constant"?p.value:p.evaluate({zoom:s},e),n.addDash(y,x),e.patterns[l.id]=[n.getKey(y,x)]}}update(e,n,s,l,f,p,y,x){this.programConfigurations.updatePaintArrays(e,n,f,s,l,p,y,x)}addFeatures(e,n,s,l,f,p){for(let y of this.patternFeatures)this.addFeature(y,y.geometry,y.index,n,s,l,p)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,Ik)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,Dk)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,wk.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Ek),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,n,s,l,f,p,y,x){let b=this.layers[0].layout,I=b.get("line-join").evaluate(e,{}),S=b.get("line-cap").evaluate(e,{}),D=b.get("line-miter-limit"),R=b.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e,this.zOffsetValue=b.get("line-z-offset").value;let L=this.layers[0].paint.get("line-width").value;if(L.kind!=="constant"&&L.isLineProgressConstant===!1&&(this.variableWidthValue=L),this.elevationType==="road"){let F=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(e,n,l,x,I,S,D,R)){let[V,$]=this.clipRuntimeLinesToTile(n,1);for(let Y=0;Y<V.length;Y++){let K=V[Y],z=$[Y],W={progress:{min:z.progress.min,max:z.progress.max},nextDir:this.computeSegNextDir(z,K),prevDir:this.computeSegPrevDir(z,K)};this.addLine(K,e,l,I,S,D,R,W)}this.fillNonElevatedRoadSegment(F)}}else for(let F of n)this.addLine(F,e,l,I,S,D,R);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,f,p,l,y,void 0,this.worldview)}computeSegNextDir(e,n){return e.nextPoint.sub(n.at(-2)).unit()}computeSegPrevDir(e,n){return n[1].sub(e.prevPoint).unit()}clipLinesToTile(e,n){return ev(e,-n,-n,at+n,at+n)}clipRuntimeLinesToTile(e,n){let s=[];return[ev(e,-n,-n,at+n,at+n,s),s]}addElevatedRoadFeature(e,n,s,l,f,p,y,x){let b=[],I=Eo.getElevationFeature(e,l);if(I){let S=this.clipLinesToTile(n,1),D=this.prepareElevatedLines(S,I,s);for(let R of D)b.push({geometry:R,elevation:I,elevationTileID:s,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(b.length===0)return!1;for(let S of b){let D=this.layoutVertexArray.length;this.addLine(S.geometry,e,s,f,p,y,x);let R=new es(s,S.elevationTileID);if(S.elevation)for(let L=D;L<this.layoutVertexArray.length;L++){let F=new ot(this.layoutVertexArray.int16[6*L]>>1,this.layoutVertexArray.int16[6*L+1]>>1),V=R.pointElevation(F,S.elevation,.05);this.updateHeightRange(V),this.zOffsetVertexArray.emplaceBack(V,0,0)}else this.fillNonElevatedRoadSegment(D)}return!0}prepareElevatedLines(e,n,s){if(n.constantHeight!=null)return e;let l=[],f=1/Oe(s);for(let p of e)dk(p,new co(n,f),0,l);return l}fillNonElevatedRoadSegment(e){for(let n=e;n<this.layoutVertexArray.length;n++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(e){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,e),this.heightRange.max=Math.max(this.heightRange.max,e)):this.heightRange={min:e,max:e}}addLine(e,n,s,l,f,p,y,x){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;let b=l==="none";this.patternJoinNone=this.hasPattern&&b,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];let I=x&&x.progress.min>0,S=x&&x.progress.max<1;if(this.lineClips){let me={min:this.lineClips.start,max:this.lineClips.end},de=1;if(x){let ke=this.lineClips.end-this.lineClips.start;me=function(Xe,He,Ze){return{min:xu(Xe.min,He,Ze),max:xu(Xe.max,He,Ze)}}(x.progress,{min:0,max:1},me),ke>0&&(de=(me.max-me.min)/ke)}let ge=+n.properties.mapbox_clip_feature_len,xe=+n.properties.mapbox_clip_seg_len;if(Number.isNaN(ge)||Number.isNaN(xe)){for(let Xe=0;Xe<e.length-1;Xe++)this.totalDistance+=e[Xe].dist(e[Xe+1]);let ke=this.totalDistance/(me.max-me.min);this.totalFeatureLength=Number.isFinite(ke)?ke:0,this.lineClips.start=me.min,this.lineClips.end=me.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=ge,this.distance=xe*de,this.lineClips.start=me.min,this.lineClips.end=me.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}let D=Ck[n.type]==="Polygon",R=e.length;for(;R>=2&&e[R-1].equals(e[R-2]);)R--;let L=0;for(;L<R-1&&e[L].equals(e[L+1]);)L++;if(R<(D?3:2))return;l==="bevel"&&(p=1.05);let F=this.segments.prepareSegment(10*R,this.layoutVertexArray,this.indexArray),V,$,Y,K,z,W,J,te;x&&x.prevDir&&(W=x.prevDir.perp()),x&&x.nextDir&&(J=x.nextDir.perp()),this.e1=this.e2=-1,D&&(V=e[R-2],z=e[L].sub(V)._unit()._perp());for(let me=L;me<R;me++){if(Y=me===R-1?D?e[L+1]:void 0:e[me+1],Y&&e[me].equals(Y))continue;z&&(K=z),V&&($=V),V=e[me],te=this.evaluateLineProgressFeatures($?$.dist(V):0),z=Y?Y.sub(V)._unit()._perp():K,K=K||z;let de=$&&Y,ge=de?l:D||b?"butt":f,xe=K.x*z.x+K.y*z.y;if(b){let Le=function(Fe){if(Fe.patternJoinNone){let Qe=Fe.segmentPoints.length/2,tt=Fe.lineSoFar-Fe.segmentStart;for(let Dt=0;Dt<Qe;++Dt){let vt=Fe.segmentPoints[2*Dt+1],ct=Math.round(Fe.segmentPoints[2*Dt])+.5+.25*vt;Fe.patternVertexArray.emplaceBack(ct,tt,Fe.segmentStart),Fe.patternVertexArray.emplaceBack(ct,tt,Fe.segmentStart)}Fe.segmentPoints.length=0}Fe.e1=Fe.e2=-1};if(de&&xe<Ak){this.updateDistance($,V),this.addCurrentVertex(V,K,1,1,F,te),Le(this),this.addCurrentVertex(V,z,-1,-1,F,te);continue}if($){if(!Y){this.updateDistance($,V),this.addCurrentVertex(V,K,1,1,F,te),Le(this);continue}ge="miter"}}let ke=K.add(z);ke.x===0&&ke.y===0||ke._unit();let Xe=ke.x*z.x+ke.y*z.y,He=Xe!==0?1/Xe:1/0,Ze=2*Math.sqrt(2-2*Xe),Ye=Xe<Mk&&$&&Y,Ne=K.x*z.y-K.y*z.x>0,qe=this.overscaling<=16?15*at/(512*this.overscaling):0;if(de&&ge==="round"){if(He<y)ge="miter";else if(He<=2){let Le=z1(V,-10,at+10);ge=this.elevationType==="offset"&&(Le||this.hasCrossSlope)?"miter":"fakeround"}}if(ge==="miter"&&He>p&&(ge="bevel"),ge==="bevel"&&(He>2&&(ge="flipbevel"),He<p&&(ge="miter")),$&&!(ge==="miter"&&Ye)&&this.updateDistance($,V),ge==="miter")if(Ye){let Le=V.dist($);if(Le>2*qe){let Qe=V.sub(V.sub($)._mult(qe/Le)._round());this.updateDistance($,Qe),this.addCurrentVertex(Qe,K,0,0,F,te),$=Qe}this.updateDistance($,V),ke._mult(He),this.addCurrentVertex(V,ke,0,0,F,te);let Fe=V.dist(Y);if(Fe>2*qe){let Qe=V.add(Y.sub(V)._mult(qe/Fe)._round());this.updateDistance(V,Qe),this.addCurrentVertex(Qe,z,0,0,F,te),V=Qe}}else ke._mult(He),this.addCurrentVertex(V,ke,0,0,F,te);else if(ge==="flipbevel"){if(He>100)ke=z.mult(-1);else{let Le=He*K.add(z).mag()/K.sub(z).mag();ke._perp()._mult(Le*(Ne?-1:1))}this.addCurrentVertex(V,ke,0,0,F,te),this.addCurrentVertex(V,ke.mult(-1),0,0,F,te)}else if(ge==="bevel"||ge==="fakeround"){te!=null&&$&&this.addCurrentVertex(V,J||K,-1,-1,F,te);let Le=V.dist($)<=2*qe&&ge!=="bevel",Fe=ke.mult(Ne?1:-1);Fe._mult(He);let Qe=z.mult(Ne?-1:1),tt=K.mult(Ne?-1:1),Dt=this.evaluateLineProgressFeatures(this.distance);if(te==null&&(this.addHalfVertex(V,Fe.x,Fe.y,!1,!Ne,0,F,Dt),Le||this.addHalfVertex(V,Fe.x+2*tt.x,Fe.y+2*tt.y,!1,Ne,0,F,Dt)),ge==="fakeround"){let vt=Math.round(180*Ze/Math.PI/20);this.addHalfVertex(V,tt.x,tt.y,!1,Ne,0,F,Dt);for(let ct=0;ct<vt;ct++){let Je=ct/vt;if(Je!==.5){let yt=Je-.5;Je+=Je*yt*(Je-1)*((1.0904+xe*(xe*(3.55645-1.43519*xe)-3.2452))*yt*yt+(.848013+xe*(.215638*xe-1.06021)))}let jt=Qe.sub(tt)._mult(Je)._add(tt)._unit();this.addHalfVertex(V,jt.x,jt.y,!1,Ne,0,F,Dt)}this.addHalfVertex(V,Qe.x,Qe.y,!1,Ne,0,F,Dt)}Le||te!=null||this.addHalfVertex(V,Fe.x+2*Qe.x,Fe.y+2*Qe.y,!1,Ne,0,F,Dt),te!=null&&Y&&this.addCurrentVertex(V,W||z,1,1,F,te)}else if(ge==="butt")this.addCurrentVertex(V,ke,0,0,F,te);else if(ge==="square"){if(!$){let Le=I?0:-1;this.addCurrentVertex(V,ke,Le,Le,F,te)}if(this.addCurrentVertex(V,ke,0,0,F,te),$){let Le=S?0:1;this.addCurrentVertex(V,ke,Le,Le,F,te)}}else if(ge==="round"){if($){let Le=!de&&J?J:K;this.addCurrentVertex(V,Le,0,0,F,te),!de&&S||this.addCurrentVertex(V,Le,1,1,F,te,!0)}if(Y){let Le=!de&&W?W:z;!de&&I||this.addCurrentVertex(V,Le,-1,-1,F,te,!0),this.addCurrentVertex(V,Le,0,0,F,te)}}}}addVerticesTo(e,n,s,l,f,p,y,x,b,I){let S=(n.w-e.w)/this.tessellationStep|0,D=0,R=this.scaledDistance;if(S>1){this.lineSoFar=e.w;let F=(n.x-e.x)/S,V=(n.y-e.y)/S,$=(n.z-e.z)/S,Y=(n.w-e.w)/S;for(let K=1;K<S;++K){e.x+=F,e.y+=V,e.z+=$,this.lineSoFar+=Y,D+=Y;let z=this.evaluateLineProgressFeatures(this.prevDistance+D);this.scaledDistance=(this.prevDistance+D)/this.totalDistance,this.addHalfVertex(e,s,l,I,!1,y,b,z),this.addHalfVertex(e,f,p,I,!0,-x,b,z)}}this.lineSoFar=n.w,this.scaledDistance=R;let L=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(n,s,l,I,!1,y,b,L),this.addHalfVertex(n,f,p,I,!0,-x,b,L)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&this.elevationType!=="offset")return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):qt(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let n=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(n=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.elevationType!=="offset"?{zOffset:0,variableWidth:n}:this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:n}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:n}}addCurrentVertex(e,n,s,l,f,p,y=!1){let x=n.x+n.y*s,b=n.y-n.x*s,I=n.y*l-n.x,S=-n.y-n.x*l;if(p!=null){let D=this.elevationType==="offset",R=-10,L=at+10,F=p.zOffset,V=new ID(e.x,e.y,F,this.lineSoFar),$=!!D&&z1(e,R,L),Y=this.lineSoFar,K=this.distance;if(this.currentVertex)if($){let z=this.currentVertexIsOutside,W=this.currentVertex,J=new ID(e.x,e.y,F,this.lineSoFar);if(DD(W,J,R,L),!z1(J,R,L)){if(z){this.e1=this.e2=-1,this.distance-=W.dist(V),this.lineSoFar=W.w;let te=this.evaluateLineProgressFeatures(W.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(W,x,b,y,!1,s,f,te),this.addHalfVertex(W,I,S,y,!0,-l,f,te),this.prevDistance=this.distance}this.distance=this.prevDistance+W.dist(J),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(W,J,x,b,I,S,s,l,f,y),this.distance=K,this.scaledDistance=this.distance/this.totalDistance}}else{let z=this.currentVertex;if(this.currentVertexIsOutside){DD(z,V,R,L),this.e1=this.e2=-1,this.distance-=z.dist(V),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=z.w;let W=this.evaluateLineProgressFeatures(z.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(z,x,b,y,!1,s,f,W),this.addHalfVertex(z,I,S,y,!0,-l,f,W),this.prevDistance=this.distance,this.distance=K,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(z,V,x,b,I,S,s,l,f,y)}else $||(this.addHalfVertex(e,x,b,y,!1,s,f,p),this.addHalfVertex(e,I,S,y,!0,-l,f,p));this.currentVertex=V,this.currentVertexIsOutside=$,this.lineSoFar=Y}else this.addHalfVertex(e,x,b,y,!1,s,f,p),this.addHalfVertex(e,I,S,y,!0,-l,f,p)}addHalfVertex({x:e,y:n},s,l,f,p,y,x,b){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),p||this.segmentPoints.push(this.lineSoFar-this.segmentStart,y)),this.layoutVertexArray.emplaceBack((e<<1)+(f?1:0),(n<<1)+(p?1:0),Math.round(63*s)+128,Math.round(63*l)+128,1+(y===0?0:y<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){let S=kt(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,S)}let I=x.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,I),x.primitiveLength++),p?this.e2=I:this.e1=I,b!=null&&this.zOffsetVertexArray.emplaceBack(b.zOffset,b.variableWidth,b.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,n){this.prevDistance=this.distance,this.distance+=e.dist(n),this.updateScaledDistance()}}function z1(r,e,n){return r.x<e||r.x>n||r.y<e||r.y>n}let GD,qD;function WD(r,e,n){return e*(at/(r.tileSize*Math.pow(2,n-r.tileID.overscaledZ)))}pt(N1,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});let ZD=(r,e,n)=>(1-n)*r+n*e;function XD(r,e){return 1/WD(r,1,e.tileZoom)}function YD(r,e,n,s){return r.translatePosMatrix(s||e.tileID.projMatrix,e,n.paint.get("line-translate"),n.paint.get("line-translate-anchor"))}let KD=r=>{let e=[];JD(r)&&e.push("RENDER_LINE_DASH"),r.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");let n=r.paint.get("line-trim-offset");n[0]===0&&n[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),r.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");let s=r.layout.get("line-join").constantOr("miter")==="none",l=!!r.paint.get("line-pattern").constantOr(1);return s&&l&&e.push("LINE_JOIN_NONE"),e};function JD(r){let e=r.paint.get("line-dasharray").value;return e.value||e.kind!=="constant"}let B1,QD=()=>B1||(B1={layout:GD||(GD=new Ei({"line-cap":new ht(Ee.layout_line["line-cap"]),"line-join":new ht(Ee.layout_line["line-join"]),"line-miter-limit":new Ke(Ee.layout_line["line-miter-limit"]),"line-round-limit":new Ke(Ee.layout_line["line-round-limit"]),"line-sort-key":new ht(Ee.layout_line["line-sort-key"]),"line-z-offset":new ht(Ee.layout_line["line-z-offset"]),"line-elevation-reference":new Ke(Ee.layout_line["line-elevation-reference"]),"line-cross-slope":new Ke(Ee.layout_line["line-cross-slope"]),visibility:new Ke(Ee.layout_line.visibility),"line-width-unit":new Ke(Ee.layout_line["line-width-unit"])})),paint:qD||(qD=new Ei({"line-opacity":new ht(Ee.paint_line["line-opacity"]),"line-color":new ht(Ee.paint_line["line-color"]),"line-translate":new Ke(Ee.paint_line["line-translate"]),"line-translate-anchor":new Ke(Ee.paint_line["line-translate-anchor"]),"line-width":new ht(Ee.paint_line["line-width"]),"line-gap-width":new ht(Ee.paint_line["line-gap-width"]),"line-offset":new ht(Ee.paint_line["line-offset"]),"line-blur":new ht(Ee.paint_line["line-blur"]),"line-dasharray":new ht(Ee.paint_line["line-dasharray"]),"line-pattern":new ht(Ee.paint_line["line-pattern"]),"line-pattern-cross-fade":new Ke(Ee.paint_line["line-pattern-cross-fade"]),"line-gradient":new Tl(Ee.paint_line["line-gradient"]),"line-trim-offset":new Ke(Ee.paint_line["line-trim-offset"]),"line-trim-fade-range":new Ke(Ee.paint_line["line-trim-fade-range"]),"line-trim-color":new Ke(Ee.paint_line["line-trim-color"]),"line-emissive-strength":new Ke(Ee.paint_line["line-emissive-strength"]),"line-border-width":new ht(Ee.paint_line["line-border-width"]),"line-border-color":new ht(Ee.paint_line["line-border-color"]),"line-occlusion-opacity":new Ke(Ee.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"})}))},B1);class Rk extends ht{possiblyEvaluate(e,n){return n=new zn(Math.floor(n.zoom),{now:n.now,fadeDuration:n.fadeDuration,transition:n.transition,worldview:n.worldview}),super.possiblyEvaluate(e,n)}evaluate(e,n,s,l){return n=Ce({},n,{zoom:Math.floor(n.zoom)}),super.evaluate(e,n,s,l)}}let eg;function eC(r,e){return e>0?e+2*r:r}let Pk=mn([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Lk=mn([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),Ok=mn([{name:"a_projected_pos",components:4,type:"Float32"}],4);mn([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);let kk=mn([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),Fk=mn([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),Nk=mn([{name:"a_texb",components:2,type:"Uint16"}]),zk=mn([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),Bk=mn([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);mn([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);let tC=mn([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Vk=mn([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);mn([{name:"triangle",components:3,type:"Uint16"}]),mn([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),mn([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),mn([{type:"Float32",name:"offsetX"}]),mn([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var sr=24;function jk(r,e,n){return r.sections.forEach(s=>{s.text=function(l,f,p){let y=f.layout.get("text-transform").evaluate(p,{});return y==="uppercase"?l=l.toLocaleUpperCase():y==="lowercase"&&(l=l.toLocaleLowerCase()),$s.applyArabicShaping&&(l=$s.applyArabicShaping(l)),l}(s.text,e,n)}),r}let tg={"!":"\uFE15","#":"\uFF03",$:"\uFF04","%":"\uFF05","&":"\uFF06","(":"\uFE35",")":"\uFE36","*":"\uFF0A","+":"\uFF0B",",":"\uFE10","-":"\uFE32",".":"\u30FB","/":"\uFF0F",":":"\uFE13",";":"\uFE14","<":"\uFE3F","=":"\uFF1D",">":"\uFE40","?":"\uFE16","@":"\uFF20","[":"\uFE47","\\":"\uFF3C","]":"\uFE48","^":"\uFF3E",_:"\uFE33","`":"\uFF40","{":"\uFE37","|":"\u2015","}":"\uFE38","~":"\uFF5E","\xA2":"\uFFE0","\xA3":"\uFFE1","\xA5":"\uFFE5","\xA6":"\uFFE4","\xAC":"\uFFE2","\xAF":"\uFFE3","\u2013":"\uFE32","\u2014":"\uFE31","\u2018":"\uFE43","\u2019":"\uFE44","\u201C":"\uFE41","\u201D":"\uFE42","\u2026":"\uFE19","\u2027":"\u30FB","\u20A9":"\uFFE6","\u3001":"\uFE11","\u3002":"\uFE12","\u3008":"\uFE3F","\u3009":"\uFE40","\u300A":"\uFE3D","\u300B":"\uFE3E","\u300C":"\uFE41","\u300D":"\uFE42","\u300E":"\uFE43","\u300F":"\uFE44","\u3010":"\uFE3B","\u3011":"\uFE3C","\u3014":"\uFE39","\u3015":"\uFE3A","\u3016":"\uFE17","\u3017":"\uFE18","\uFF01":"\uFE15","\uFF08":"\uFE35","\uFF09":"\uFE36","\uFF0C":"\uFE10","\uFF0D":"\uFE32","\uFF0E":"\u30FB","\uFF1A":"\uFE13","\uFF1B":"\uFE14","\uFF1C":"\uFE3F","\uFF1E":"\uFE40","\uFF1F":"\uFE16","\uFF3B":"\uFE47","\uFF3D":"\uFE48","\uFF3F":"\uFE33","\uFF5B":"\uFE37","\uFF5C":"\u2015","\uFF5D":"\uFE38","\uFF5F":"\uFE35","\uFF60":"\uFE36","\uFF61":"\uFE12","\uFF62":"\uFE41","\uFF63":"\uFE42","\u2190":"\u2191","\u2192":"\u2193"};function Uk(r){return r==="\uFE36"||r==="\uFE48"||r==="\uFE38"||r==="\uFE44"||r==="\uFE42"||r==="\uFE3E"||r==="\uFE3C"||r==="\uFE3A"||r==="\uFE18"||r==="\uFE40"||r==="\uFE10"||r==="\uFE13"||r==="\uFE14"||r==="\uFF40"||r==="\uFFE3"||r==="\uFE11"||r==="\uFE12"}function Hk(r){return r==="\uFE35"||r==="\uFE47"||r==="\uFE37"||r==="\uFE43"||r==="\uFE41"||r==="\uFE3D"||r==="\uFE3B"||r==="\uFE39"||r==="\uFE17"||r==="\uFE3F"}var nC,V1,iC,j1={};function $k(){return nC||(nC=1,j1.read=function(r,e,n,s,l){var f,p,y=8*l-s-1,x=(1<<y)-1,b=x>>1,I=-7,S=n?l-1:0,D=n?-1:1,R=r[e+S];for(S+=D,f=R&(1<<-I)-1,R>>=-I,I+=y;I>0;f=256*f+r[e+S],S+=D,I-=8);for(p=f&(1<<-I)-1,f>>=-I,I+=s;I>0;p=256*p+r[e+S],S+=D,I-=8);if(f===0)f=1-b;else{if(f===x)return p?NaN:1/0*(R?-1:1);p+=Math.pow(2,s),f-=b}return(R?-1:1)*p*Math.pow(2,f-s)},j1.write=function(r,e,n,s,l,f){var p,y,x,b=8*f-l-1,I=(1<<b)-1,S=I>>1,D=l===23?Math.pow(2,-24)-Math.pow(2,-77):0,R=s?0:f-1,L=s?1:-1,F=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(y=isNaN(e)?1:0,p=I):(p=Math.floor(Math.log(e)/Math.LN2),e*(x=Math.pow(2,-p))<1&&(p--,x*=2),(e+=p+S>=1?D/x:D*Math.pow(2,1-S))*x>=2&&(p++,x/=2),p+S>=I?(y=0,p=I):p+S>=1?(y=(e*x-1)*Math.pow(2,l),p+=S):(y=e*Math.pow(2,S-1)*Math.pow(2,l),p=0));l>=8;r[n+R]=255&y,R+=L,y/=256,l-=8);for(p=p<<l|y,b+=l;b>0;r[n+R]=255&p,R+=L,p/=256,b-=8);r[n+R-L]|=128*F}),j1}function rC(){if(iC)return V1;iC=1,V1=e;var r=$k();function e(z){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(z)?z:new Uint8Array(z||0),this.pos=0,this.type=0,this.length=this.buf.length}e.Varint=0,e.Fixed64=1,e.Bytes=2,e.Fixed32=5;var n=4294967296,s=1/n,l=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function f(z){return z.type===e.Bytes?z.readVarint()+z.pos:z.pos+1}function p(z,W,J){return J?4294967296*W+(z>>>0):4294967296*(W>>>0)+(z>>>0)}function y(z,W,J){var te=W<=16383?1:W<=2097151?2:W<=268435455?3:Math.floor(Math.log(W)/(7*Math.LN2));J.realloc(te);for(var me=J.pos-1;me>=z;me--)J.buf[me+te]=J.buf[me]}function x(z,W){for(var J=0;J<z.length;J++)W.writeVarint(z[J])}function b(z,W){for(var J=0;J<z.length;J++)W.writeSVarint(z[J])}function I(z,W){for(var J=0;J<z.length;J++)W.writeFloat(z[J])}function S(z,W){for(var J=0;J<z.length;J++)W.writeDouble(z[J])}function D(z,W){for(var J=0;J<z.length;J++)W.writeBoolean(z[J])}function R(z,W){for(var J=0;J<z.length;J++)W.writeFixed32(z[J])}function L(z,W){for(var J=0;J<z.length;J++)W.writeSFixed32(z[J])}function F(z,W){for(var J=0;J<z.length;J++)W.writeFixed64(z[J])}function V(z,W){for(var J=0;J<z.length;J++)W.writeSFixed64(z[J])}function $(z,W){return(z[W]|z[W+1]<<8|z[W+2]<<16)+16777216*z[W+3]}function Y(z,W,J){z[J]=W,z[J+1]=W>>>8,z[J+2]=W>>>16,z[J+3]=W>>>24}function K(z,W){return(z[W]|z[W+1]<<8|z[W+2]<<16)+(z[W+3]<<24)}return e.prototype={destroy:function(){this.buf=null},readFields:function(z,W,J){for(J=J||this.length;this.pos<J;){var te=this.readVarint(),me=te>>3,de=this.pos;this.type=7&te,z(me,W,this),this.pos===de&&this.skip(te)}return W},readMessage:function(z,W){return this.readFields(z,W,this.readVarint()+this.pos)},readFixed32:function(){var z=$(this.buf,this.pos);return this.pos+=4,z},readSFixed32:function(){var z=K(this.buf,this.pos);return this.pos+=4,z},readFixed64:function(){var z=$(this.buf,this.pos)+$(this.buf,this.pos+4)*n;return this.pos+=8,z},readSFixed64:function(){var z=$(this.buf,this.pos)+K(this.buf,this.pos+4)*n;return this.pos+=8,z},readFloat:function(){var z=r.read(this.buf,this.pos,!0,23,4);return this.pos+=4,z},readDouble:function(){var z=r.read(this.buf,this.pos,!0,52,8);return this.pos+=8,z},readVarint:function(z){var W,J,te=this.buf;return W=127&(J=te[this.pos++]),J<128?W:(W|=(127&(J=te[this.pos++]))<<7,J<128?W:(W|=(127&(J=te[this.pos++]))<<14,J<128?W:(W|=(127&(J=te[this.pos++]))<<21,J<128?W:function(me,de,ge){var xe,ke,Xe=ge.buf;if(xe=(112&(ke=Xe[ge.pos++]))>>4,ke<128||(xe|=(127&(ke=Xe[ge.pos++]))<<3,ke<128)||(xe|=(127&(ke=Xe[ge.pos++]))<<10,ke<128)||(xe|=(127&(ke=Xe[ge.pos++]))<<17,ke<128)||(xe|=(127&(ke=Xe[ge.pos++]))<<24,ke<128)||(xe|=(1&(ke=Xe[ge.pos++]))<<31,ke<128))return p(me,xe,de);throw new Error("Expected varint not more than 10 bytes")}(W|=(15&(J=te[this.pos]))<<28,z,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var z=this.readVarint();return z%2==1?(z+1)/-2:z/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var z=this.readVarint()+this.pos,W=this.pos;return this.pos=z,z-W>=12&&l?function(J,te,me){return l.decode(J.subarray(te,me))}(this.buf,W,z):function(J,te,me){for(var de="",ge=te;ge<me;){var xe,ke,Xe,He=J[ge],Ze=null,Ye=He>239?4:He>223?3:He>191?2:1;if(ge+Ye>me)break;Ye===1?He<128&&(Ze=He):Ye===2?(192&(xe=J[ge+1]))==128&&(Ze=(31&He)<<6|63&xe)<=127&&(Ze=null):Ye===3?(ke=J[ge+2],(192&(xe=J[ge+1]))==128&&(192&ke)==128&&((Ze=(15&He)<<12|(63&xe)<<6|63&ke)<=2047||Ze>=55296&&Ze<=57343)&&(Ze=null)):Ye===4&&(ke=J[ge+2],Xe=J[ge+3],(192&(xe=J[ge+1]))==128&&(192&ke)==128&&(192&Xe)==128&&((Ze=(15&He)<<18|(63&xe)<<12|(63&ke)<<6|63&Xe)<=65535||Ze>=1114112)&&(Ze=null)),Ze===null?(Ze=65533,Ye=1):Ze>65535&&(Ze-=65536,de+=String.fromCharCode(Ze>>>10&1023|55296),Ze=56320|1023&Ze),de+=String.fromCharCode(Ze),ge+=Ye}return de}(this.buf,W,z)},readBytes:function(){var z=this.readVarint()+this.pos,W=this.buf.subarray(this.pos,z);return this.pos=z,W},readPackedVarint:function(z,W){if(this.type!==e.Bytes)return z.push(this.readVarint(W));var J=f(this);for(z=z||[];this.pos<J;)z.push(this.readVarint(W));return z},readPackedSVarint:function(z){if(this.type!==e.Bytes)return z.push(this.readSVarint());var W=f(this);for(z=z||[];this.pos<W;)z.push(this.readSVarint());return z},readPackedBoolean:function(z){if(this.type!==e.Bytes)return z.push(this.readBoolean());var W=f(this);for(z=z||[];this.pos<W;)z.push(this.readBoolean());return z},readPackedFloat:function(z){if(this.type!==e.Bytes)return z.push(this.readFloat());var W=f(this);for(z=z||[];this.pos<W;)z.push(this.readFloat());return z},readPackedDouble:function(z){if(this.type!==e.Bytes)return z.push(this.readDouble());var W=f(this);for(z=z||[];this.pos<W;)z.push(this.readDouble());return z},readPackedFixed32:function(z){if(this.type!==e.Bytes)return z.push(this.readFixed32());var W=f(this);for(z=z||[];this.pos<W;)z.push(this.readFixed32());return z},readPackedSFixed32:function(z){if(this.type!==e.Bytes)return z.push(this.readSFixed32());var W=f(this);for(z=z||[];this.pos<W;)z.push(this.readSFixed32());return z},readPackedFixed64:function(z){if(this.type!==e.Bytes)return z.push(this.readFixed64());var W=f(this);for(z=z||[];this.pos<W;)z.push(this.readFixed64());return z},readPackedSFixed64:function(z){if(this.type!==e.Bytes)return z.push(this.readSFixed64());var W=f(this);for(z=z||[];this.pos<W;)z.push(this.readSFixed64());return z},skip:function(z){var W=7&z;if(W===e.Varint)for(;this.buf[this.pos++]>127;);else if(W===e.Bytes)this.pos=this.readVarint()+this.pos;else if(W===e.Fixed32)this.pos+=4;else{if(W!==e.Fixed64)throw new Error("Unimplemented type: "+W);this.pos+=8}},writeTag:function(z,W){this.writeVarint(z<<3|W)},realloc:function(z){for(var W=this.length||16;W<this.pos+z;)W*=2;if(W!==this.length){var J=new Uint8Array(W);J.set(this.buf),this.buf=J,this.length=W}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(z){this.realloc(4),Y(this.buf,z,this.pos),this.pos+=4},writeSFixed32:function(z){this.realloc(4),Y(this.buf,z,this.pos),this.pos+=4},writeFixed64:function(z){this.realloc(8),Y(this.buf,-1&z,this.pos),Y(this.buf,Math.floor(z*s),this.pos+4),this.pos+=8},writeSFixed64:function(z){this.realloc(8),Y(this.buf,-1&z,this.pos),Y(this.buf,Math.floor(z*s),this.pos+4),this.pos+=8},writeVarint:function(z){(z=+z||0)>268435455||z<0?function(W,J){var te,me;if(W>=0?(te=W%4294967296|0,me=W/4294967296|0):(me=~(-W/4294967296),4294967295^(te=~(-W%4294967296))?te=te+1|0:(te=0,me=me+1|0)),W>=18446744073709552e3||W<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");J.realloc(10),function(de,ge,xe){xe.buf[xe.pos++]=127&de|128,de>>>=7,xe.buf[xe.pos++]=127&de|128,de>>>=7,xe.buf[xe.pos++]=127&de|128,de>>>=7,xe.buf[xe.pos++]=127&de|128,xe.buf[xe.pos]=127&(de>>>=7)}(te,0,J),function(de,ge){var xe=(7&de)<<4;ge.buf[ge.pos++]|=xe|((de>>>=3)?128:0),de&&(ge.buf[ge.pos++]=127&de|((de>>>=7)?128:0),de&&(ge.buf[ge.pos++]=127&de|((de>>>=7)?128:0),de&&(ge.buf[ge.pos++]=127&de|((de>>>=7)?128:0),de&&(ge.buf[ge.pos++]=127&de|((de>>>=7)?128:0),de&&(ge.buf[ge.pos++]=127&de)))))}(me,J)}(z,this):(this.realloc(4),this.buf[this.pos++]=127&z|(z>127?128:0),z<=127||(this.buf[this.pos++]=127&(z>>>=7)|(z>127?128:0),z<=127||(this.buf[this.pos++]=127&(z>>>=7)|(z>127?128:0),z<=127||(this.buf[this.pos++]=z>>>7&127))))},writeSVarint:function(z){this.writeVarint(z<0?2*-z-1:2*z)},writeBoolean:function(z){this.writeVarint(!!z)},writeString:function(z){z=String(z),this.realloc(4*z.length),this.pos++;var W=this.pos;this.pos=function(te,me,de){for(var ge,xe,ke=0;ke<me.length;ke++){if((ge=me.charCodeAt(ke))>55295&&ge<57344){if(!xe){ge>56319||ke+1===me.length?(te[de++]=239,te[de++]=191,te[de++]=189):xe=ge;continue}if(ge<56320){te[de++]=239,te[de++]=191,te[de++]=189,xe=ge;continue}ge=xe-55296<<10|ge-56320|65536,xe=null}else xe&&(te[de++]=239,te[de++]=191,te[de++]=189,xe=null);ge<128?te[de++]=ge:(ge<2048?te[de++]=ge>>6|192:(ge<65536?te[de++]=ge>>12|224:(te[de++]=ge>>18|240,te[de++]=ge>>12&63|128),te[de++]=ge>>6&63|128),te[de++]=63&ge|128)}return de}(this.buf,z,this.pos);var J=this.pos-W;J>=128&&y(W,J,this),this.pos=W-1,this.writeVarint(J),this.pos+=J},writeFloat:function(z){this.realloc(4),r.write(this.buf,z,this.pos,!0,23,4),this.pos+=4},writeDouble:function(z){this.realloc(8),r.write(this.buf,z,this.pos,!0,52,8),this.pos+=8},writeBytes:function(z){var W=z.length;this.writeVarint(W),this.realloc(W);for(var J=0;J<W;J++)this.buf[this.pos++]=z[J]},writeRawMessage:function(z,W){this.pos++;var J=this.pos;z(W,this);var te=this.pos-J;te>=128&&y(J,te,this),this.pos=J-1,this.writeVarint(te),this.pos+=te},writeMessage:function(z,W,J){this.writeTag(z,e.Bytes),this.writeRawMessage(W,J)},writePackedVarint:function(z,W){W.length&&this.writeMessage(z,x,W)},writePackedSVarint:function(z,W){W.length&&this.writeMessage(z,b,W)},writePackedBoolean:function(z,W){W.length&&this.writeMessage(z,D,W)},writePackedFloat:function(z,W){W.length&&this.writeMessage(z,I,W)},writePackedDouble:function(z,W){W.length&&this.writeMessage(z,S,W)},writePackedFixed32:function(z,W){W.length&&this.writeMessage(z,R,W)},writePackedSFixed32:function(z,W){W.length&&this.writeMessage(z,L,W)},writePackedFixed64:function(z,W){W.length&&this.writeMessage(z,F,W)},writePackedSFixed64:function(z,W){W.length&&this.writeMessage(z,V,W)},writeBytesField:function(z,W){this.writeTag(z,e.Bytes),this.writeBytes(W)},writeFixed32Field:function(z,W){this.writeTag(z,e.Fixed32),this.writeFixed32(W)},writeSFixed32Field:function(z,W){this.writeTag(z,e.Fixed32),this.writeSFixed32(W)},writeFixed64Field:function(z,W){this.writeTag(z,e.Fixed64),this.writeFixed64(W)},writeSFixed64Field:function(z,W){this.writeTag(z,e.Fixed64),this.writeSFixed64(W)},writeVarintField:function(z,W){this.writeTag(z,e.Varint),this.writeVarint(W)},writeSVarintField:function(z,W){this.writeTag(z,e.Varint),this.writeSVarint(W)},writeStringField:function(z,W){this.writeTag(z,e.Bytes),this.writeString(W)},writeFloatField:function(z,W){this.writeTag(z,e.Fixed32),this.writeFloat(W)},writeDoubleField:function(z,W){this.writeTag(z,e.Fixed64),this.writeDouble(W)},writeBooleanField:function(z,W){this.writeVarintField(z,!!W)}},V1}var ov=ma(rC());let U1=3;function Gk(r,e,n){e.glyphs=[],r===1&&n.readMessage(qk,e)}function qk(r,e,n){if(r===3){let{id:s,bitmap:l,width:f,height:p,left:y,top:x,advance:b}=n.readMessage(Wk,{});e.glyphs.push({id:s,bitmap:new Bc({width:f+2*U1,height:p+2*U1},l),metrics:{width:f,height:p,left:y,top:x,advance:b}})}else r===4?e.ascender=n.readSVarint():r===5&&(e.descender=n.readSVarint())}function Wk(r,e,n){r===1?e.id=n.readVarint():r===2?e.bitmap=n.readBytes():r===3?e.width=n.readVarint():r===4?e.height=n.readVarint():r===5?e.left=n.readSVarint():r===6?e.top=n.readSVarint():r===7&&(e.advance=n.readVarint())}let Zk=U1,To={horizontal:1,vertical:2,horizontalOnly:3};class ng{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,n){let s=new ng;return s.scale=e||1,s.fontStack=n,s}static forImage(e){let n=new ng;return n.image=e,n}}class pf{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,n,s){let l=new pf;for(let f=0;f<e.sections.length;f++){let p=e.sections[f];p.image?l.addImageSection(p,s):l.addTextSection(p,n)}return l}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(n,s){let l="";for(let f=0;f<n.length;f++){let p=n.charCodeAt(f+1)||null,y=n.charCodeAt(f-1)||null;l+=!s&&(p&&gy(p)&&!tg[n[f+1]]||y&&gy(y)&&!tg[n[f-1]])||!tg[n[f]]?n[f]:tg[n[f]]}return l}(this.text,e)}trim(){let e=0;for(let s=0;s<this.text.length&&sv[this.text.charCodeAt(s)];s++)e++;let n=this.text.length;for(let s=this.text.length-1;s>=0&&s>=e&&sv[this.text.charCodeAt(s)];s--)n--;this.text=this.text.substring(e,n),this.sectionIndex=this.sectionIndex.slice(e,n)}substring(e,n){let s=new pf;return s.text=this.text.substring(e,n),s.sectionIndex=this.sectionIndex.slice(e,n),s.sections=this.sections,s}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,n)=>Math.max(e,this.sections[n].scale),0)}addTextSection(e,n){this.text+=e.text,this.sections.push(ng.forText(e.scale,e.fontStack||n));let s=this.sections.length-1;for(let l=0;l<e.text.length;++l)this.sectionIndex.push(s)}addImageSection(e,n){let s=e.image?e.image.getPrimary():null;if(!s)return void qt("Can't add FormattedSection with an empty image.");s.scaleSelf(n);let l=this.getNextImageSectionCharCode();l?(this.text+=String.fromCodePoint(l),this.sections.push(ng.forImage(s)),this.sectionIndex.push(this.sections.length-1)):qt("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function H1(r,e,n,s,l,f,p,y,x,b,I,S,D,R,L,F=1){let V=pf.fromFeature(r,l,F);S===To.vertical&&V.verticalizePunctuation(D);let $=[],Y=function(te,me,de,ge,xe,ke){if(!te)return[];let Xe=[],He=function(qe,Le,Fe,Qe,tt,Dt){let vt=0;for(let ct=0;ct<qe.length();ct++){let Je=qe.getSection(ct);vt+=oC(qe.getCodePoint(ct),Je,Qe,tt,Le,Dt)}return vt/Math.max(1,Math.ceil(vt/Fe))}(te,me,de,ge,xe,ke),Ze=te.text.indexOf("\u200B")>=0,Ye=0;for(let qe=0;qe<te.length();qe++){let Le=te.getSection(qe),Fe=te.getCodePoint(qe);if(sv[Fe]||(Ye+=oC(Fe,Le,ge,xe,me,ke)),qe<te.length()-1){let Qe=!((Ne=Fe)<11904||!(Mt["Bopomofo Extended"](Ne)||Mt.Bopomofo(Ne)||Mt["CJK Compatibility Forms"](Ne)||Mt["CJK Compatibility Ideographs"](Ne)||Mt["CJK Compatibility"](Ne)||Mt["CJK Radicals Supplement"](Ne)||Mt["CJK Strokes"](Ne)||Mt["CJK Symbols and Punctuation"](Ne)||Mt["CJK Unified Ideographs Extension A"](Ne)||Mt["CJK Unified Ideographs"](Ne)||Mt["Enclosed CJK Letters and Months"](Ne)||Mt["Halfwidth and Fullwidth Forms"](Ne)||Mt.Hiragana(Ne)||Mt["Ideographic Description Characters"](Ne)||Mt["Kangxi Radicals"](Ne)||Mt["Katakana Phonetic Extensions"](Ne)||Mt.Katakana(Ne)||Mt["Vertical Forms"](Ne)||Mt["Yi Radicals"](Ne)||Mt["Yi Syllables"](Ne)));(Xk[Fe]||Qe||Le.image)&&Xe.push(aC(qe+1,Ye,He,Xe,Yk(Fe,te.getCodePoint(qe+1),Qe&&Ze),!1))}}var Ne;return lC(aC(te.length(),Ye,He,Xe,0,!0))}(V,b,f,e,s,R),{processBidirectionalText:K,processStyledBidirectionalText:z}=$s;if(K&&V.sections.length===1){let te=K(V.toString(),Y);for(let me of te){let de=new pf;de.text=me,de.sections=V.sections;for(let ge=0;ge<me.length;ge++)de.sectionIndex.push(0);$.push(de)}}else if(z){let te=z(V.text,V.sectionIndex,Y);for(let me of te){let de=new pf;de.text=me[0],de.sectionIndex=me[1],de.sections=V.sections,$.push(de)}}else $=function(te,me){let de=[],ge=te.text,xe=0;for(let ke of me)de.push(te.substring(xe,ke)),xe=ke;return xe<ge.length&&de.push(te.substring(xe,ge.length)),de}(V,Y);let W=[],J={positionedLines:W,text:V.toString(),top:I[1],bottom:I[1],left:I[0],right:I[0],writingMode:S,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(te,me,de,ge,xe,ke,Xe,He,Ze,Ye,Ne,qe){let Le=0,Fe=0,Qe=0,tt=He==="right"?1:He==="left"?0:.5,Dt=!1;for(let bt of xe){let Ft=bt.getSections();for(let Gt of Ft){if(Gt.image)continue;let $t=me[Gt.fontStack];if($t&&(Dt=$t.ascender!==void 0&&$t.descender!==void 0,!Dt))break}if(!Dt)break}let vt=0;for(let bt of xe){bt.trim();let Ft=bt.getMaxScale(),Gt=(Ft-1)*sr,$t={positionedGlyphs:[],lineOffset:0};te.positionedLines[vt]=$t;let tn=$t.positionedGlyphs,Xt=0;if(!bt.length()){Fe+=ke,++vt;continue}let nn=0,Cn=0;for(let Q=0;Q<bt.length();Q++){let ne=bt.getSection(Q),ze=bt.getSectionIndex(Q),it=bt.getCodePoint(Q),ut=ne.scale,lt=null,_t=null,Ot=null,an=sr,ln=0;Ze===To.vertical&&((ct=it)===12312||ct===12313||ct===12316||ct===12540||ct===12448)&&(Ze=To.horizontal);let Yt=!(Ze===To.horizontal||!Ne&&!gm(it)||Ne&&(sv[it]||t1(it)));if(ne.image){let Pn=ge.get(ne.image.toString());if(!Pn)continue;Ot=ne.image,te.iconsInText=te.iconsInText||!0,_t=Pn.paddedRect;let Zn=Pn.displaySize;ut=ut*sr/qe,lt={width:Zn[0],height:Zn[1],left:0,top:-3,advance:Yt?Zn[1]:Zn[0],localGlyph:!1},ln=Dt?-lt.height*ut:Ft*sr-17-Zn[1]*ut,an=lt.advance;let cn=(Yt?Zn[0]:Zn[1])*ut-sr*Ft;cn>0&&cn>Xt&&(Xt=cn)}else{let Pn=de[ne.fontStack];if(!Pn)continue;Pn[it]&&(_t=Pn[it]);let Zn=me[ne.fontStack];if(!Zn)continue;let cn=Zn.glyphs[it];if(!cn)continue;if(lt=cn.metrics,an=it!==8203?sr:0,Dt){let vi=Zn.ascender!==void 0?Math.abs(Zn.ascender):0,ei=Zn.descender!==void 0?Math.abs(Zn.descender):0,Mn=(vi+ei)*ut;nn<Mn&&(nn=Mn,Cn=(vi-ei)/2*ut),ln=-vi*ut}else ln=(Ft-ut)*sr-17}Yt?(te.verticalizable=!0,tn.push({glyph:it,image:Ot,x:Le,y:Fe+ln,vertical:Yt,scale:ut,localGlyph:lt.localGlyph,fontStack:ne.fontStack,sectionIndex:ze,metrics:lt,rect:_t}),Le+=an*ut+Ye):(tn.push({glyph:it,image:Ot,x:Le,y:Fe+ln,vertical:Yt,scale:ut,localGlyph:lt.localGlyph,fontStack:ne.fontStack,sectionIndex:ze,metrics:lt,rect:_t}),Le+=lt.advance*ut+Ye)}tn.length!==0&&(Qe=Math.max(Le-Ye,Qe),Dt?cC(tn,tt,Xt,Cn,ke*Ft/2):cC(tn,tt,Xt,0,ke/2)),Le=0;let Qn=ke*Ft+Xt;$t.lineOffset=Math.max(Xt,Gt),Fe+=Qn,++vt}var ct;let Je=Fe,{horizontalAlign:jt,verticalAlign:yt}=$1(Xe);(function(bt,Ft,Gt,$t,tn,Xt){let nn=(Ft-Gt)*tn,Cn=-Xt*$t;for(let Qn of bt)for(let Q of Qn.positionedGlyphs)Q.x+=nn,Q.y+=Cn})(te.positionedLines,tt,jt,yt,Qe,Je),te.top+=-yt*Je,te.bottom=te.top+Je,te.left+=-jt*Qe,te.right=te.left+Qe,te.hasBaseline=Dt}(J,e,n,s,$,p,y,x,S,b,D,L),!function(te){for(let me of te)if(me.positionedGlyphs.length!==0)return!1;return!0}(W))return J}let sv={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Xk={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function oC(r,e,n,s,l,f){if(e.image){let p=s.get(e.image.toString());return p?p.displaySize[0]*e.scale*sr/f+l:0}{let p=n[e.fontStack],y=p&&p.glyphs[r];return y?y.metrics.advance*e.scale+l:0}}function sC(r,e,n,s){let l=Math.pow(r-e,2);return s?r<e?l/2:2*l:l+Math.abs(n)*n}function Yk(r,e,n){let s=0;return r===10&&(s-=1e4),n&&(s+=150),r!==40&&r!==65288||(s+=50),e!==41&&e!==65289||(s+=50),s}function aC(r,e,n,s,l,f){let p=null,y=sC(e,n,l,f);for(let x of s){let b=sC(e-x.x,n,l,f)+x.badness;b<=y&&(p=x,y=b)}return{index:r,x:e,priorBreak:p,badness:y}}function lC(r){return r?lC(r.priorBreak).concat(r.index):[]}function $1(r){let e=.5,n=.5;switch(r){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(r){case"bottom":case"bottom-right":case"bottom-left":n=1;break;case"top":case"top-right":case"top-left":n=0}return{horizontalAlign:e,verticalAlign:n}}function cC(r,e,n,s,l){if(!(e||n||s||l))return;let f=r.length-1,p=r[f],y=(p.x+p.metrics.advance*p.scale)*e;for(let x=0;x<=f;x++)r[x].x-=y,r[x].y+=n+s+l}function uC(r){return r.imagePrimary!==void 0&&r.top!==void 0&&r.bottom!==void 0&&r.left!==void 0&&r.right!==void 0}function Kk(r,e,n,s){let{horizontalAlign:l,verticalAlign:f}=$1(s),p=n[0]-r.displaySize[0]*l,y=n[1]-r.displaySize[1]*f;return{imagePrimary:r,imageSecondary:e,top:y,bottom:y+r.displaySize[1],left:p,right:p+r.displaySize[0]}}function hC(r,e,n,s,l,f){let p=r.imagePrimary,y;if(p.content){let V=p.content,$=p.pixelRatio||1;y=[V[0]/$,V[1]/$,p.displaySize[0]-V[2]/$,p.displaySize[1]-V[3]/$]}let x=e.left*f,b=e.right*f,I,S,D,R;n==="width"||n==="both"?(R=l[0]+x-s[3],S=l[0]+b+s[1]):(R=l[0]+(x+b-p.displaySize[0])/2,S=R+p.displaySize[0]);let L=e.top*f,F=e.bottom*f;return n==="height"||n==="both"?(I=l[1]+L-s[0],D=l[1]+F+s[2]):(I=l[1]+(L+F-p.displaySize[1])/2,D=I+p.displaySize[1]),{imagePrimary:p,imageSecondary:void 0,top:I,right:S,bottom:D,left:R,collisionPadding:y}}function dC(r){return!r.imagePrimary.stretchX}function fC(r){return!r.imagePrimary.stretchY}function pC(r){return{width:r.right-r.left,height:r.bottom-r.top}}let za=128;function mC(r,e,n){let{expression:s}=e;if(s.kind==="constant")return{kind:"constant",layoutSize:s.evaluate(new zn(r+1,{worldview:n}))};if(s.kind==="source")return{kind:"source"};{let{zoomStops:l,interpolationType:f}=s,p=0;for(;p<l.length&&l[p]<=r;)p++;p=Math.max(0,p-1);let y=p;for(;y<l.length&&l[y]<r+1;)y++;y=Math.min(l.length-1,y);let x=l[p],b=l[y];return s.kind==="composite"?{kind:"composite",minZoom:x,maxZoom:b,interpolationType:f}:{kind:"camera",minZoom:x,maxZoom:b,minSize:s.evaluate(new zn(x,{worldview:n})),maxSize:s.evaluate(new zn(b,{worldview:n})),interpolationType:f}}}function G1(r,{uSize:e,uSizeT:n},{lowerSize:s,upperSize:l}){return r.kind==="source"?s/za:r.kind==="composite"?kt(s/za,l/za,n):e}function ig(r,e,n=1){let s=0,l=0;if(r.kind==="constant")l=r.layoutSize*n;else if(r.kind!=="source"){let{interpolationType:f,minZoom:p,maxZoom:y}=r,x=f?ae(wo.interpolationFactor(f,e,p,y),0,1):0;r.kind==="camera"?l=kt(r.minSize,r.maxSize,x)*n:s=x*n}return{uSizeT:s,uSize:l}}class Ml extends ot{constructor(e,n,s,l,f){super(e,n),this.angle=l,this.z=s,f!==void 0&&(this.segment=f)}clone(){return new Ml(this.x,this.y,this.z,this.angle,this.segment)}}function gC(r,e,n,s,l){if(e.segment===void 0)return!0;let f=e,p=e.segment+1,y=0;for(;y>-n/2;){if(p--,p<0)return!1;y-=r[p].dist(f),f=r[p]}y+=r[p].dist(r[p+1]),p++;let x=[],b=0;for(;y<n/2;){let I=r[p],S=r[p+1];if(!S)return!1;let D=r[p-1].angleTo(I)-I.angleTo(S);for(D=Math.abs((D+3*Math.PI)%(2*Math.PI)-Math.PI),x.push({distance:y,angleDelta:D}),b+=D;y-x[0].distance>s;)b-=x.shift().angleDelta;if(b>l)return!1;p++,y+=I.dist(S)}return!0}function _C(r){let e=0;for(let n=0;n<r.length-1;n++)e+=r[n].dist(r[n+1]);return e}function yC(r,e,n){return r?.6*e*n:0}function vC(r,e){return Math.max(r?r.right-r.left:0,e?e.right-e.left:0)}function Jk(r,e,n,s,l,f){let p=yC(n,l,f),y=vC(n,s)*f,x=0,b=_C(r)/2;for(let I=0;I<r.length-1;I++){let S=r[I],D=r[I+1],R=S.dist(D);if(x+R>b){let L=(b-x)/R,F=kt(S.x,D.x,L),V=kt(S.y,D.y,L),$=new Ml(F,V,0,D.angleTo(S),I);return!p||gC(r,$,y,p,e)?$:void 0}x+=R}}function Qk(r,e,n,s,l,f,p,y,x){let b=yC(s,f,p),I=vC(s,l),S=I*p,D=r[0].x===0||r[0].x===x||r[0].y===0||r[0].y===x;return e-S<e/4&&(e=S+e/4),xC(r,D?e/2*y%e:(I/2+2*f)*p*y%e,e,b,n,S,D,!1,x)}function xC(r,e,n,s,l,f,p,y,x){let b=f/2,I=_C(r),S=0,D=e-n,R=[];for(let L=0;L<r.length-1;L++){let F=r[L],V=r[L+1],$=F.dist(V),Y=V.angleTo(F);for(;D+n<S+$;){D+=n;let K=(D-S)/$,z=kt(F.x,V.x,K),W=kt(F.y,V.y,K);if(z>=0&&z<x&&W>=0&&W<x&&D-b>=0&&D+b<=I){let J=new Ml(z,W,0,Y,L);s&&!gC(r,J,f,s,l)||R.push(J)}}S+=$}return y||R.length||p||(R=xC(r,S/2,n,s,l,f,p,!0,x)),R}function bC(r){let e=0,n=0;for(let p of r)e+=p.w*p.h,n=Math.max(n,p.w);r.sort((p,y)=>y.h-p.h);let s=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),n),h:1/0}],l=0,f=0;for(let p of r)for(let y=s.length-1;y>=0;y--){let x=s[y];if(!(p.w>x.w||p.h>x.h)){if(p.x=x.x,p.y=x.y,f=Math.max(f,p.y+p.h),l=Math.max(l,p.x+p.w),p.w===x.w&&p.h===x.h){let b=s.pop();y<s.length&&(s[y]=b)}else p.h===x.h?(x.x+=p.w,x.w-=p.w):p.w===x.w?(x.y+=p.h,x.h-=p.h):(s.push({x:x.x+p.w,y:x.y,w:x.w-p.w,h:p.h}),x.y+=p.h,x.h-=p.h);break}}return{w:l,h:f,fill:e/(l*f)||0}}pt(Ml,"Anchor");let vh=1;class rg{static getImagePositionScale(e,n,s){if(n&&e&&e.options&&e.options.transform){let l=e.options.transform;return{x:l.a,y:l.d}}return{x:s,y:s}}constructor(e,n,s,l){this.paddedRect=e;let{pixelRatio:f,version:p,stretchX:y,stretchY:x,content:b,sdf:I,usvg:S}=n;this.pixelRatio=f,this.stretchX=y,this.stretchY=x,this.content=b,this.version=p,this.padding=s,this.sdf=I,this.usvg=S,this.scale=rg.getImagePositionScale(l,S,f)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function q1(r,e,n){let s=zs.parse(r),l=function(f,p,y=[1,1]){return{x:0,y:0,w:(f.data?f.data.width:f.width*y[0])+2*p,h:(f.data?f.data.height:f.height*y[1])+2*p}}(e,n,[s.options.transform.a,s.options.transform.d]);return{bin:l,imagePosition:new rg(l,e,n,s),imageVariant:s}}class wC{constructor(e,n,s){let l=new Map,f=new Map;this.haveRenderCallbacks=[];let p=[];this.addImages(e,l,vh,p),this.addImages(n,f,2,p);let{w:y,h:x}=bC(p),b=new pr({width:y||1,height:x||1});for(let[I,S]of e.entries()){let D=l.get(I).paddedRect;pr.copy(S.data,b,{x:0,y:0},{x:D.x+vh,y:D.y+vh},S.data,s,S.sdf)}for(let[I,S]of n.entries()){let D=f.get(I),R=D.paddedRect,L=D.padding,F=R.x+L,V=R.y+L,$=S.data.width,Y=S.data.height;L=L>1?L-1:L,pr.copy(S.data,b,{x:0,y:0},{x:F,y:V},S.data,s),pr.copy(S.data,b,{x:0,y:Y-L},{x:F,y:V-L},{width:$,height:L},s),pr.copy(S.data,b,{x:0,y:0},{x:F,y:V+Y},{width:$,height:L},s),pr.copy(S.data,b,{x:$-L,y:0},{x:F-L,y:V},{width:L,height:Y},s),pr.copy(S.data,b,{x:0,y:0},{x:F+$,y:V},{width:L,height:Y},s),pr.copy(S.data,b,{x:$-L,y:Y-L},{x:F-L,y:V-L},{width:L,height:L},s),pr.copy(S.data,b,{x:0,y:Y-L},{x:F+$,y:V-L},{width:L,height:L},s),pr.copy(S.data,b,{x:0,y:0},{x:F+$,y:V+Y},{width:L,height:L},s),pr.copy(S.data,b,{x:$-L,y:0},{x:F-L,y:V+Y},{width:L,height:L},s)}this.lut=s,this.image=b,this.iconPositions=l,this.patternPositions=f}addImages(e,n,s,l){for(let[f,p]of e.entries()){let{bin:y,imagePosition:x,imageVariant:b}=q1(f,p,s);n.set(f,x),l.push(y),p.hasRenderCallback&&this.haveRenderCallbacks.push(b.id)}}patchUpdatedImages(e,n,s){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(l=>e.hasImage(l,s)),e.dispatchRenderCallbacks(this.haveRenderCallbacks,s);for(let l of e.getUpdatedImages(s)){for(let f of this.iconPositions.keys()){let p=zs.parse(f);if(so.isEqual(p.id,l)){let y=e.getImage(l,s);this.patchUpdatedImage(this.iconPositions.get(f),y,n)}}for(let f of this.patternPositions.keys()){let p=zs.parse(f);if(so.isEqual(p.id,l)){let y=e.getImage(l,s);this.patchUpdatedImage(this.patternPositions.get(f),y,n)}}}}patchUpdatedImage(e,n,s){if(!e||!n||e.version===n.version)return;e.version=n.version;let[l,f]=e.tl,p=e.sdf;if(this.lut||p){let y={width:n.data.width,height:n.data.height},x=new pr(y);pr.copy(n.data,x,{x:0,y:0},{x:0,y:0},y,this.lut,p),s.update(x,{position:{x:l,y:f}})}else s.update(n.data,{position:{x:l,y:f}})}}pt(rg,"ImagePosition"),pt(wC,"ImageAtlas");let av=1e20;function EC(r,e,n,s,l,f,p,y,x){for(let b=e;b<e+s;b++)TC(r,n*f+b,f,l,p,y,x);for(let b=n;b<n+l;b++)TC(r,b*f+e,1,s,p,y,x)}function TC(r,e,n,s,l,f,p){f[0]=0,p[0]=-1e20,p[1]=av,l[0]=r[e];for(let y=1,x=0,b=0;y<s;y++){l[y]=r[e+y*n];let I=y*y;do{let S=f[x];b=(l[y]-l[S]+I-S*S)/(y-S)/2}while(b<=p[x]&&--x>-1);x++,f[x]=y,p[x]=b,p[x+1]=av}for(let y=0,x=0;y<s;y++){for(;p[x+1]<y;)x++;let b=f[x],I=y-b;r[e+y*n]=l[b]+I*I}}let Xs=2,W1={none:0,ideographs:1,all:2};class mf{constructor(e,n,s){this.requestManager=e,this.localGlyphMode=n,this.localFontFamily=s,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e,n){this.urls[n]=e}getGlyphs(e,n,s){let l=[],f=this.urls[n]||ar.GLYPHS_URL;for(let p in e)for(let y of e[p])l.push({stack:p,id:y});ve(l,({stack:p,id:y},x)=>{let b=this.entries[p];b||(b=this.entries[p]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let I=b.glyphs[y];if(I!==void 0)return void x(null,{stack:p,id:y,glyph:I});if(I=this._tinySDF(b,p,y),I)return b.glyphs[y]=I,void x(null,{stack:p,id:y,glyph:I});let S=Math.floor(y/256);if(256*S>65535)return qt("glyphs > 65535 not supported"),void x(null,{stack:p,id:y,glyph:I});if(b.ranges[S])return void x(null,{stack:p,id:y,glyph:I});let D=b.requests[S];D||(D=b.requests[S]=[],mf.loadGlyphRange(p,S,f,this.requestManager,(R,L)=>{if(L){b.ascender=L.ascender,b.descender=L.descender;for(let F in L.glyphs)this._doesCharSupportLocalGlyph(+F)||(b.glyphs[+F]=L.glyphs[+F]);b.ranges[S]=!0}for(let F of D)F(R,L);delete b.requests[S]})),D.push((R,L)=>{R?x(R):L&&x(null,{stack:p,id:y,glyph:L.glyphs[y]||null})})},(p,y)=>{if(p)s(p);else if(y){let x={};for(let{stack:b,id:I,glyph:S}of y)x[b]===void 0&&(x[b]={}),x[b].glyphs===void 0&&(x[b].glyphs={}),x[b].glyphs[I]=S&&{id:S.id,bitmap:S.bitmap.clone(),metrics:S.metrics},x[b].ascender=this.entries[b].ascender,x[b].descender=this.entries[b].descender;s(null,x)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==W1.none&&(this.localGlyphMode===W1.all?!!this.localFontFamily:!!this.localFontFamily&&(Mt["CJK Unified Ideographs"](e)||Mt["Hangul Syllables"](e)||Mt.Hiragana(e)||Mt.Katakana(e)||Mt["CJK Symbols and Punctuation"](e)||Mt["CJK Unified Ideographs Extension A"](e)||Mt["CJK Unified Ideographs Extension B"](e)||Mt.Osage(e)))}_tinySDF(e,n,s){let l=this.localFontFamily;if(!l||!this._doesCharSupportLocalGlyph(s))return;let f=e.tinySDF;if(!f){let F="400";/bold/i.test(n)?F="900":/medium/i.test(n)?F="500":/light/i.test(n)&&(F="200"),f=e.tinySDF=new mf.TinySDF({fontFamily:l,fontWeight:F,fontSize:24*Xs,buffer:3*Xs,radius:8*Xs}),f.fontWeight=F}if(this.localGlyphs[f.fontWeight][s])return this.localGlyphs[f.fontWeight][s];let p=String.fromCodePoint(s),{data:y,width:x,height:b,glyphWidth:I,glyphHeight:S,glyphLeft:D,glyphTop:R,glyphAdvance:L}=f.draw(p);return this.localGlyphs[f.fontWeight][s]={id:s,bitmap:new Bc({width:x,height:b},y),metrics:{width:I/Xs,height:S/Xs,left:D/Xs,top:R/Xs-27,advance:L/Xs,localGlyph:!0}}}}mf.loadGlyphRange=function(r,e,n,s,l){let f=256*e,p=f+255,y=s.transformRequest(s.normalizeGlyphsURL(n).replace("{fontstack}",r).replace("{range}",`${f}-${p}`),Du.Glyphs);Cu(y,(x,b)=>{if(x)l(x);else if(b){let I={},S=function(D){return new ov(D).readFields(Gk,{})}(b);for(let D of S.glyphs)I[D.id]=D;l(null,{glyphs:I,ascender:S.ascender,descender:S.descender})}})},mf.TinySDF=class{constructor({fontSize:r=24,buffer:e=3,radius:n=8,cutoff:s=.25,fontFamily:l="sans-serif",fontWeight:f="normal",fontStyle:p="normal"}={}){this.buffer=e,this.cutoff=s,this.radius=n;let y=this.size=r+4*e,x=this._createCanvas(y),b=this.ctx=x.getContext("2d",{willReadFrequently:!0});b.font=`${p} ${f} ${r}px ${l}`,b.textBaseline="alphabetic",b.textAlign="left",b.fillStyle="black",this.gridOuter=new Float64Array(y*y),this.gridInner=new Float64Array(y*y),this.f=new Float64Array(y),this.z=new Float64Array(y+1),this.v=new Uint16Array(y)}_createCanvas(r){let e=document.createElement("canvas");return e.width=e.height=r,e}draw(r){let{width:e,actualBoundingBoxAscent:n,actualBoundingBoxDescent:s,actualBoundingBoxLeft:l,actualBoundingBoxRight:f}=this.ctx.measureText(r),p=Math.ceil(n),y=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(f-l))),x=Math.min(this.size-this.buffer,p+Math.ceil(s)),b=y+2*this.buffer,I=x+2*this.buffer,S=Math.max(b*I,0),D=new Uint8ClampedArray(S),R={data:D,width:b,height:I,glyphWidth:y,glyphHeight:x,glyphTop:p,glyphLeft:0,glyphAdvance:e};if(y===0||x===0)return R;let{ctx:L,buffer:F,gridInner:V,gridOuter:$}=this;L.clearRect(F,F,y,x),L.fillText(r,F,F+p);let Y=L.getImageData(F,F,y,x);$.fill(av,0,S),V.fill(0,0,S);for(let K=0;K<x;K++)for(let z=0;z<y;z++){let W=Y.data[4*(K*y+z)+3]/255;if(W===0)continue;let J=(K+F)*b+z+F;if(W===1)$[J]=0,V[J]=av;else{let te=.5-W;$[J]=te>0?te*te:0,V[J]=te<0?te*te:0}}EC($,0,0,b,I,b,this.f,this.v,this.z),EC(V,F,F,y,x,b,this.f,this.v,this.z);for(let K=0;K<S;K++){let z=Math.sqrt($[K])-Math.sqrt(V[K]);D[K]=Math.round(255-255*(z/this.radius+this.cutoff))}return R}};let xh=vh;function IC(r,e){return r+e[1]-e[0]}function SC(r,e,n,s,l=1){let f=[],p=r.imagePrimary,y=p.pixelRatio,x=p.paddedRect.w-2*xh,b=p.paddedRect.h-2*xh,I=(r.right-r.left)*l,S=(r.bottom-r.top)*l,D=p.stretchX||[[0,x]],R=p.stretchY||[[0,b]],L=D.reduce(IC,0),F=R.reduce(IC,0),V=x-L,$=b-F,Y=0,K=L,z=0,W=F,J=0,te=V,me=0,de=$;if(p.content&&s){let xe=p.content;Y=lv(D,0,xe[0]),z=lv(R,0,xe[1]),K=lv(D,xe[0],xe[2]),W=lv(R,xe[1],xe[3]),J=xe[0]-Y,me=xe[1]-z,te=xe[2]-xe[0]-K,de=xe[3]-xe[1]-W}let ge=(xe,ke,Xe,He)=>{let Ze=cv(xe.stretch-Y,K,I,r.left*l),Ye=uv(xe.fixed-J,te,xe.stretch,L),Ne=cv(ke.stretch-z,W,S,r.top*l),qe=uv(ke.fixed-me,de,ke.stretch,F),Le=cv(Xe.stretch-Y,K,I,r.left*l),Fe=uv(Xe.fixed-J,te,Xe.stretch,L),Qe=cv(He.stretch-z,W,S,r.top*l),tt=uv(He.fixed-me,de,He.stretch,F),Dt=new ot(Ze,Ne),vt=new ot(Le,Ne),ct=new ot(Le,Qe),Je=new ot(Ze,Qe),jt=new ot(Ye/y,qe/y),yt=new ot(Fe/y,tt/y),bt=e*Math.PI/180;if(bt){let nn=Math.sin(bt),Cn=Math.cos(bt),Qn=[Cn,-nn,nn,Cn];Dt._matMult(Qn),vt._matMult(Qn),Je._matMult(Qn),ct._matMult(Qn)}let Ft=xe.stretch+xe.fixed,Gt=Xe.stretch+Xe.fixed,$t=ke.stretch+ke.fixed,tn=He.stretch+He.fixed,Xt=r.imageSecondary;return{tl:Dt,tr:vt,bl:Je,br:ct,texPrimary:{x:p.paddedRect.x+xh+Ft,y:p.paddedRect.y+xh+$t,w:Gt-Ft,h:tn-$t},texSecondary:Xt?{x:Xt.paddedRect.x+xh+Ft,y:Xt.paddedRect.y+xh+$t,w:Gt-Ft,h:tn-$t}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:jt,pixelOffsetBR:yt,minFontScaleX:te/y/I,minFontScaleY:de/y/S,isSDF:n}};if(s&&(p.stretchX||p.stretchY)){let xe=DC(D,V,L),ke=DC(R,$,F);for(let Xe=0;Xe<xe.length-1;Xe++){let He=xe[Xe],Ze=xe[Xe+1];for(let Ye=0;Ye<ke.length-1;Ye++)f.push(ge(He,ke[Ye],Ze,ke[Ye+1]))}}else f.push(ge({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:x+1},{fixed:0,stretch:b+1}));return f}function lv(r,e,n){let s=0;for(let l of r)s+=Math.max(e,Math.min(n,l[1]))-Math.max(e,Math.min(n,l[0]));return s}function DC(r,e,n){let s=[{fixed:-1,stretch:0}];for(let[l,f]of r){let p=s[s.length-1];s.push({fixed:l-p.stretch,stretch:p.stretch}),s.push({fixed:l-p.stretch,stretch:p.stretch+(f-l)})}return s.push({fixed:e+xh,stretch:n}),s}function cv(r,e,n,s){return r/e*n+s}function uv(r,e,n,s){return r-e*n/s}function eF(r,e,n,s){let l=e+r.positionedLines[s].lineOffset;return s===0?n+l/2:n+(l+(e+r.positionedLines[s-1].lineOffset))/2}function tF(r,e=1,n=!1){let s=1/0,l=1/0,f=-1/0,p=-1/0,y=r[0];for(let R=0;R<y.length;R++){let L=y[R];(!R||L.x<s)&&(s=L.x),(!R||L.y<l)&&(l=L.y),(!R||L.x>f)&&(f=L.x),(!R||L.y>p)&&(p=L.y)}let x=Math.min(f-s,p-l),b=x/2,I=new bd([],nF);if(x===0)return new ot(s,l);for(let R=s;R<f;R+=x)for(let L=l;L<p;L+=x)I.push(new gf(R+b,L+b,b,r));let S=function(R){let L=0,F=0,V=0,$=R[0];for(let Y=0,K=$.length,z=K-1;Y<K;z=Y++){let W=$[Y],J=$[z],te=W.x*J.y-J.x*W.y;F+=(W.x+J.x)*te,V+=(W.y+J.y)*te,L+=3*te}return new gf(F/L,V/L,0,R)}(r),D=I.length;for(;I.length;){let R=I.pop();(R.d>S.d||!S.d)&&(S=R,n&&console.log("found best %d after %d probes",Math.round(1e4*R.d)/1e4,D)),R.max-S.d<=e||(b=R.h/2,I.push(new gf(R.p.x-b,R.p.y-b,b,r)),I.push(new gf(R.p.x+b,R.p.y-b,b,r)),I.push(new gf(R.p.x-b,R.p.y+b,b,r)),I.push(new gf(R.p.x+b,R.p.y+b,b,r)),D+=4)}return n&&(console.log(`num probes: ${D}`),console.log(`best distance: ${S.d}`)),S.p}function nF(r,e){return e.max-r.max}class gf{constructor(e,n,s,l){this.p=new ot(e,n),this.h=s,this.d=function(f,p){let y=!1,x=1/0;for(let b=0;b<p.length;b++){let I=p[b];for(let S=0,D=I.length,R=D-1;S<D;R=S++){let L=I[S],F=I[R];L.y>f.y!=F.y>f.y&&f.x<(F.x-L.x)*(f.y-L.y)/(F.y-L.y)+L.x&&(y=!y),x=Math.min(x,of(f,L,F))}}return(y?1:-1)*Math.sqrt(x)}(this.p,l),this.max=this.d+this.h*Math.SQRT2}}let iF=Object.keys,Z1=Number.POSITIVE_INFINITY,rF=Math.sqrt(2);function CC(r,[e,n]){let s=0,l=0;if(n===Z1){e<0&&(e=0);let f=e/rF;switch(r){case"top-right":case"top-left":l=f-7;break;case"bottom-right":case"bottom-left":l=7-f;break;case"bottom":l=7-e;break;case"top":l=e-7}switch(r){case"top-right":case"bottom-right":s=-f;break;case"top-left":case"bottom-left":s=f;break;case"left":s=e;break;case"right":s=-e}}else{switch(e=Math.abs(e),n=Math.abs(n),r){case"top-right":case"top-left":case"top":l=n-7;break;case"bottom-right":case"bottom-left":case"bottom":l=7-n}switch(r){case"top-right":case"bottom-right":case"right":s=-e;break;case"top-left":case"bottom-left":case"left":s=e}}return[s,l]}function hv(r,e,n,s,l,f,p,y,x){if(!e||!e.usvg)return;let b=pC(s),I=pC(l),S=f!=="both"&&f!=="width"||!dC(s)?1:I.width/b.width,D=f!=="both"&&f!=="height"||!fC(s)?1:I.height/b.height;n.scaleSelf(S,D);let R=n.toString();p.set(R,n),y.set(R,e);let{imagePosition:L}=q1(R,e,vh);x.set(R,L)}function MC(r,e,n,s,l,f,p,y,x){if(!r)return;let b=function(I,S,D,R,L,F){if(I.kind==="camera")return I.maxSize;if(I.kind==="composite"){let V=S.possiblyEvaluate(new zn(I.maxZoom,{worldview:F}),D).evaluate(L,{},D),$=S.possiblyEvaluate(new zn(I.minZoom,{worldview:F}),D).evaluate(L,{},D);return Math.max(V,$)}return S.possiblyEvaluate(new zn(R,{worldview:F})).evaluate(L,{},D)}(e,n,s,l,f,x);return r.scaleSelf(b*y*p)}function AC(r,e,n,s,l,f,p,y,x){return{iconPrimary:MC(r.getPrimary(),e,n,s,l,f,p,y,x),iconSecondary:MC(r.getSecondary(),e,n,s,l,f,p,y,x)}}function oF(r,e,n){if(!e)return;let s=n.get(r.toString()),l=n.get(e.toString());l&&(s.paddedRect.w===l.paddedRect.w&&s.paddedRect.h===l.paddedRect.h||qt(`Mismatch in icon variant sizes: ${r.toString()} and ${e.toString()}`),s.usvg!==l.usvg&&qt(`Mismatch in icon variant image types: ${r.id} and ${e.id}`))}function RC(r,e,n,s){if(!r)return;let l=e.get(n.toString());if(r.imagePrimary=l,s){let f=e.get(s.toString());r.imageSecondary=f}}function sF(r,e){for(let n in r.horizontal)PC(r.horizontal[n],e);PC(r.vertical,e)}function PC(r,e){if(r){for(let n of r.positionedLines)for(let s of n.positionedGlyphs)if(s.image!==null){let l=s.image.toString();s.rect=e.get(l).paddedRect}}}function X1(r){switch(r){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function aF(r,e,n,s,l,f,p,y,x){let b=Y1(f.horizontal)||f.vertical,I=n.get("icon-text-fit-padding").evaluate(s,{},l),S,D=e;return e&&x!=="none"&&(r.allowVerticalPlacement&&f.vertical&&(S=hC(e,f.vertical,x,I,y,p)),b&&(D=hC(e,b,x,I,y,p))),{defaultShapedIcon:D,verticallyShapedIcon:S}}function lF(r,e,n,s,l,f,p,y,x,b,I,S,D,R,L,F,V,$,Y,K){let z=p.textMaxSize.evaluate(e,{},D);z===void 0?z=y*p.textScaleFactor:z*=p.textScaleFactor;let W=r.layers[0].layout,J=Y1(n.horizontal)||n.vertical,te=R.name==="globe",me=sr,de=r.tilePixelRatio*z/me,ge=(Ye=r.overscaling,r.zoom>18&&Ye>2&&(Ye>>=1),Math.max(at/(512*Ye),1)*W.get("symbol-spacing")),xe=W.get("text-padding")*r.tilePixelRatio,ke=W.get("icon-padding")*r.tilePixelRatio,Xe=gn(W.get("text-max-angle")),He=W.get("icon-rotation-alignment")==="map"&&K!=="point",Ze=ge/2;var Ye;r.hasAnyIconTextFit===!1&&V!=="none"&&(r.hasAnyIconTextFit=!0);let Ne=e.properties?+e.properties[on]:null,qe=Ne&&r.elevationFeatureIdToIndex?r.elevationFeatureIdToIndex.get(Ne):65535,Le=(Fe,Qe,tt)=>{if(Qe.x<0||Qe.x>=at||Qe.y<0||Qe.y>=at)return;let Dt=null;if(te){let{x:vt,y:ct,z:Je}=R.projectTilePoint(Qe.x,Qe.y,tt);Dt={anchor:new Ml(vt,ct,Je,0,void 0),up:R.upVector(tt,Qe.x,Qe.y)}}(function(vt,ct,Je,jt,yt,bt,Ft,Gt,$t,tn,Xt,nn,Cn,Qn,Q,ne,ze,it,ut,lt,_t,Ot,an,ln,Yt,Pn,Zn,cn,vi){let ei=vt.addToLineVertexArray(ct,jt),Mn,Li,oi,Xn,ti,Fn,Jt,Bn=0,xi=0,Rt=0,fn=0,si=-1,Mi=-1,di={},Zi=Au(""),jn=Je?Je.anchor:ct,Gi=cn!=="none",uo=0,mr=0;if($t._unevaluatedLayout.getValue("text-radial-offset")===void 0){let Xi=$t.layout.get("text-offset").evaluate(_t,{},Yt);uo=Xi[0]*sr,mr=Xi[1]*sr}else uo=$t.layout.get("text-radial-offset").evaluate(_t,{},Yt)*sr,mr=Z1;if(vt.allowVerticalPlacement&&yt.vertical){let Xi=yt.vertical;if(Q)Fn=K1(Xi),Gt&&(Jt=K1(Gt));else{let Ji=$t.layout.get("text-rotate").evaluate(_t,{},Yt)+90;oi=dv(tn,jn,ct,Xt,nn,Cn,Xi,Qn,Ji,ne),Gt&&(Xn=dv(tn,jn,ct,Xt,nn,Cn,Gt,it,Ji))}}if(bt){let Xi=vt.iconSizeData,Ji=$t.layout.get("icon-rotate").evaluate(_t,{},Yt),gr=SC(bt,Ji,an,Gi,Ot.iconScaleFactor),jr=Gt?SC(Gt,Ji,an,Gi,Ot.iconScaleFactor):void 0;Li=dv(tn,jn,ct,Xt,nn,Cn,bt,it,Ji,null),Bn=4*gr.length;let Sr=null;Xi.kind==="source"?(Sr=[za*$t.layout.get("icon-size").evaluate(_t,{},Yt)*Ot.iconScaleFactor],Sr[0]>jc&&qt(`${vt.layerIds[0]}: Value for "icon-size" is >= ${og}. Reduce your "icon-size".`)):Xi.kind==="composite"&&(Sr=[za*Ot.compositeIconSizes[0].evaluate(_t,{},Yt)*Ot.iconScaleFactor,za*Ot.compositeIconSizes[1].evaluate(_t,{},Yt)*Ot.iconScaleFactor],(Sr[0]>jc||Sr[1]>jc)&&qt(`${vt.layerIds[0]}: Value for "icon-size" is >= ${og}. Reduce your "icon-size".`)),vt.addSymbols(vt.icon,gr,Sr,lt,ut,_t,void 0,Je,ct,ei.lineStartIndex,ei.lineLength,-1,ln,Yt,Pn,Zn),si=vt.icon.placedSymbolArray.length-1,jr&&(xi=4*jr.length,vt.addSymbols(vt.icon,jr,Sr,lt,ut,_t,To.vertical,Je,ct,ei.lineStartIndex,ei.lineLength,-1,ln,Yt,Pn,Zn),Mi=vt.icon.placedSymbolArray.length-1)}for(let Xi in yt.horizontal){let Ji=Xi,gr=yt.horizontal[Ji];Mn||(Zi=Au(gr.text),Q?ti=K1(gr):Mn=dv(tn,jn,ct,Xt,nn,Cn,gr,Qn,$t.layout.get("text-rotate").evaluate(_t,{},Yt),ne));let jr=gr.positionedLines.length===1;if(Rt+=LC(vt,Je,ct,gr,Ft,$t,Q,_t,ne,ei,yt.vertical?To.horizontal:To.horizontalOnly,jr?iF(yt.horizontal):[Ji],di,si,Ot,ln,Yt,Pn),jr)break}yt.vertical&&(fn+=LC(vt,Je,ct,yt.vertical,Ft,$t,Q,_t,ne,ei,To.vertical,["vertical"],di,Mi,Ot,ln,Yt,Pn));let hr=-1,ho=(Xi,Ji)=>Xi?Math.max(Xi,Ji):Ji;hr=ho(ti,hr),hr=ho(Fn,hr),hr=ho(Jt,hr);let Ba=hr>-1?1:0;vt.glyphOffsetArray.length>=65535&&qt("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),_t.sortKey!==void 0&&vt.addToSortKeyRanges(vt.symbolInstances.length,_t.sortKey),vt.symbolInstances.emplaceBack(ct.x,ct.y,jn.x,jn.y,jn.z,di.right>=0?di.right:-1,di.center>=0?di.center:-1,di.left>=0?di.left:-1,di.vertical>=0?di.vertical:-1,si,Mi,Zi,Mn!==void 0?Mn:vt.collisionBoxArray.length,Mn!==void 0?Mn+1:vt.collisionBoxArray.length,oi!==void 0?oi:vt.collisionBoxArray.length,oi!==void 0?oi+1:vt.collisionBoxArray.length,Li!==void 0?Li:vt.collisionBoxArray.length,Li!==void 0?Li+1:vt.collisionBoxArray.length,Xn||vt.collisionBoxArray.length,Xn?Xn+1:vt.collisionBoxArray.length,Xt,Rt,fn,Bn,xi,Ba,0,uo,mr,hr,0,Gi?1:0,vi)})(r,Qe,Dt,Fe,n,s,f,l,r.layers[0],r.collisionBoxArray,e.index,e.sourceLayerIndex,r.index,xe,Y,b,0,ke,He,$,e,p,I,S,D,L,F,V,qe)};if(K==="line")for(let Fe of ev(e.geometry,0,0,at,at)){let Qe=Qk(Fe,ge,Xe,n.vertical||J,s,me,de,r.overscaling,at);for(let tt of Qe)J&&cF(r,J.text,Ze,tt)||Le(Fe,tt,D)}else if(K==="line-center"){for(let Fe of e.geometry)if(Fe.length>1){let Qe=Jk(Fe,Xe,n.vertical||J,s,me,de);Qe&&Le(Fe,Qe,D)}}else if(e.type==="Polygon")for(let Fe of Zy(e.geometry,0)){let Qe=tF(Fe,16);Le(Fe[0],new Ml(Qe.x,Qe.y,0,0,void 0),D)}else if(e.type==="LineString")for(let Fe of e.geometry)Le(Fe,new Ml(Fe[0].x,Fe[0].y,0,0,void 0),D);else if(e.type==="Point")for(let Fe of e.geometry)for(let Qe of Fe)Le([Qe],new Ml(Qe.x,Qe.y,0,0,void 0),D)}let og=255,jc=og*za;function LC(r,e,n,s,l,f,p,y,x,b,I,S,D,R,L,F,V,$){let Y=function(W,J,te,me,de,ge,xe,ke){let Xe=[];if(J.positionedLines.length===0)return Xe;let He=me.layout.get("text-rotate").evaluate(ge,{})*Math.PI/180,Ze=function(Fe){let Qe=Fe[0],tt=Fe[1],Dt=Qe*tt;return Dt>0?[Qe,-tt]:Dt<0?[-Qe,tt]:Qe===0?[tt,Qe]:[tt,-Qe]}(te),Ye=Math.abs(J.top-J.bottom);for(let Fe of J.positionedLines)Ye-=Fe.lineOffset;let Ne=J.positionedLines.length,qe=Ye/Ne,Le=J.top-te[1];for(let Fe=0;Fe<Ne;++Fe){let Qe=J.positionedLines[Fe];Le=eF(J,qe,Le,Fe);for(let tt of Qe.positionedGlyphs){if(!tt.rect)continue;let Dt=tt.rect||{},vt=Zk+1,ct=!0,Je=1,jt=0;if(tt.image){let _t=xe.get(tt.image.toString());if(!_t)continue;if(_t.sdf){qt("SDF images are not supported in formatted text and will be ignored.");continue}ct=!1,Je=_t.pixelRatio,vt=vh/Je}let yt=(de||ke)&&tt.vertical,bt=tt.metrics.advance*tt.scale/2,Ft=tt.metrics,Gt=tt.rect;if(Gt===null)continue;ke&&J.verticalizable&&(jt=tt.image?bt-tt.metrics.width*tt.scale/2:0);let $t=de?[tt.x+bt,tt.y]:[0,0],tn=[0,0],Xt=[0,0],nn=!1;de||(yt?(Xt=[tt.x+bt+Ze[0],tt.y+Ze[1]-jt],nn=!0):tn=[tt.x+bt+te[0],tt.y+te[1]-jt]);let Cn=Gt.w*tt.scale/(Je*(tt.localGlyph?Xs:1)),Qn=Gt.h*tt.scale/(Je*(tt.localGlyph?Xs:1)),Q,ne,ze,it;if(yt){let _t=tt.y-Le,Ot=new ot(-bt,bt-_t),an=-Math.PI/2,ln=new ot(...Xt);Q=new ot(-bt+tn[0],tn[1]),Q._rotateAround(an,Ot)._add(ln),Q.x+=-_t+bt,Q.y-=(Ft.left-vt)*tt.scale;let Yt=tt.image?Ft.advance*tt.scale:sr*tt.scale,Pn=String.fromCodePoint(tt.glyph);Uk(Pn)?Q.x+=(1-vt)*tt.scale:Hk(Pn)?Q.x+=Yt-Ft.height*tt.scale+(-vt-1)*tt.scale:Q.x+=tt.image||Ft.width+2*vt===Gt.w&&Ft.height+2*vt===Gt.h?(Yt-Qn)/2:(Yt-(Ft.height+2*vt)*tt.scale)/2,ne=new ot(Q.x,Q.y-Cn),ze=new ot(Q.x+Qn,Q.y),it=new ot(Q.x+Qn,Q.y-Cn)}else{let _t=(Ft.left-vt)*tt.scale-bt+tn[0],Ot=(-Ft.top-vt)*tt.scale+tn[1],an=_t+Cn,ln=Ot+Qn;Q=new ot(_t,Ot),ne=new ot(an,Ot),ze=new ot(_t,ln),it=new ot(an,ln)}if(He){let _t;_t=de?new ot(0,0):nn?new ot(Ze[0],Ze[1]):new ot(te[0],te[1]),Q._rotateAround(He,_t),ne._rotateAround(He,_t),ze._rotateAround(He,_t),it._rotateAround(He,_t)}let ut=new ot(0,0),lt=new ot(0,0);Xe.push({tl:Q,tr:ne,bl:ze,br:it,texPrimary:Dt,texSecondary:void 0,writingMode:J.writingMode,glyphOffset:$t,sectionIndex:tt.sectionIndex,isSDF:ct,pixelOffsetTL:ut,pixelOffsetBR:lt,minFontScaleX:0,minFontScaleY:0})}}return Xe}(0,s,x,f,p,y,l,r.allowVerticalPlacement),K=r.textSizeData,z=null;K.kind==="source"?(z=[za*f.layout.get("text-size").evaluate(y,{},V)*L.textScaleFactor],z[0]>jc&&qt(`${r.layerIds[0]}: Value for "text-size" is >= ${og}. Reduce your "text-size".`)):K.kind==="composite"&&(z=[za*L.compositeTextSizes[0].evaluate(y,{},V)*L.textScaleFactor,za*L.compositeTextSizes[1].evaluate(y,{},V)*L.textScaleFactor],(z[0]>jc||z[1]>jc)&&qt(`${r.layerIds[0]}: Value for "text-size" is >= ${og}. Reduce your "text-size".`)),r.addSymbols(r.text,Y,z,x,p,y,I,e,n,b.lineStartIndex,b.lineLength,R,F,V,$,!1);for(let W of S)D[W]=r.text.placedSymbolArray.length-1;return 4*Y.length}function Y1(r){for(let e in r)return r[e];return null}function dv(r,e,n,s,l,f,p,y,x,b){let I=p.top,S=p.bottom,D=p.left,R=p.right;if(uC(p)&&p.collisionPadding){let L=p.collisionPadding;D-=L[0],I-=L[1],R+=L[2],S+=L[3]}if(x){let L=new ot(D,I),F=new ot(R,I),V=new ot(D,S),$=new ot(R,S),Y=gn(x),K=new ot(0,0);b&&(K=new ot(b[0],b[1])),L._rotateAround(Y,K),F._rotateAround(Y,K),V._rotateAround(Y,K),$._rotateAround(Y,K),D=Math.min(L.x,F.x,V.x,$.x),R=Math.max(L.x,F.x,V.x,$.x),I=Math.min(L.y,F.y,V.y,$.y),S=Math.max(L.y,F.y,V.y,$.y)}return r.emplaceBack(e.x,e.y,e.z,n.x,n.y,D,I,R,S,y,s,l,f),r.length-1}function K1(r){uC(r)&&r.collisionPadding&&(r.top-=r.collisionPadding[1],r.bottom+=r.collisionPadding[3]);let e=r.bottom-r.top;return e>0?Math.max(10,e):null}function cF(r,e,n,s){let l=r.compareText;if(e in l){let f=l[e];for(let p=f.length-1;p>=0;p--)if(s.dist(f[p])<n)return!0}else l[e]=[];return l[e].push(s),!1}function OC(r,e){let n=r.fovAboveCenter,s=r.elevation?r.elevation.getMinElevationBelowMSL()*e:0,l=(r._camera.position[2]*r.worldSize-s)/Math.cos(r._pitch),f=Math.sin(n)*l/Math.sin(Math.max(Math.PI/2-r._pitch-n,.01)),p=Math.sin(r._pitch)*f+l,y=l*(1/r._horizonShift);if(!r.elevation||r.elevation.exaggeration()===0){let x=Math.max(r.zoom-17,0);r.isOrthographic&&(x/=10),p*=1+x}return Math.min(1.01*p,y)}function sg(r,e){if(!e.isReprojectedInTileSpace)return{scale:1<<r.z,x:r.x,y:r.y,x2:r.x+1,y2:r.y+1,projection:e};let n=Math.pow(2,-r.z),s=r.x*n,l=(r.x+1)*n,f=r.y*n,p=(r.y+1)*n,y=fe(s),x=fe(l),b=Te(f),I=Te(p),S=e.project(y,b),D=e.project(x,b),R=e.project(x,I),L=e.project(y,I),F=Math.min(S.x,D.x,R.x,L.x),V=Math.min(S.y,D.y,R.y,L.y),$=Math.max(S.x,D.x,R.x,L.x),Y=Math.max(S.y,D.y,R.y,L.y),K=n/16;function z(J,te,me,de,ge,xe){let ke=(me+ge)/2,Xe=(de+xe)/2,He=e.project(fe(ke),Te(Xe)),Ze=Math.max(0,F-He.x,V-He.y,He.x-$,He.y-Y);F=Math.min(F,He.x),$=Math.max($,He.x),V=Math.min(V,He.y),Y=Math.max(Y,He.y),Ze>K&&(z(J,He,me,de,ke,Xe),z(He,te,ke,Xe,ge,xe))}z(S,D,s,f,l,f),z(D,R,l,f,l,p),z(R,L,l,p,s,p),z(L,S,s,p,s,f),F-=K,V-=K,$+=K,Y+=K;let W=1/Math.max($-F,Y-V);return{scale:W,x:F*W,y:V*W,x2:$*W,y2:Y*W,projection:e}}function kC(r,{x:e,y:n},s=0){return new ot(((e-s)*r.scale-r.x)*at,(n*r.scale-r.y)*at)}let uF=Se(new Float32Array(16));class Uc{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,n){return{x:0,y:0,z:0}}unproject(e,n){return new Z(0,0)}projectTilePoint(e,n,s){return{x:e,y:n,z:0}}locationPoint(e,n,s,l=!0){return e._coordinatePoint(e.locationCoordinate(n,s),l)}pixelsPerMeter(e,n){return he(1,e)*n}pixelSpaceConversion(e,n,s){return 1}farthestPixelDistance(e){return OC(e,e.pixelsPerMeter)}pointCoordinate(e,n,s,l){let f=e.horizonLineFromTop(!1),p=new ot(n,Math.max(f,s));return e.rayIntersectionCoordinate(e.pointRayIntersection(p,l))}pointCoordinate3D(e,n,s){let l=new ot(n,s);if(e.elevation)return e.elevation.pointCoordinate(l);{let f=this.pointCoordinate(e,l.x,l.y,0);return[f.x,f.y,f.z]}}isPointAboveHorizon(e,n){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,n.x,n.y);let s=e.horizonLineFromTop();return n.y<s}createInversionMatrix(e,n){return uF}createTileMatrix(e,n,s){let l,f,p,y=s.canonical,x=Se(new Float64Array(16));if(this.isReprojectedInTileSpace){let b=sg(y,this);l=1,f=b.x+s.wrap*b.scale,p=b.y,sn(x,x,[l/b.scale,l/b.scale,e.pixelsPerMeter/n])}else l=n/e.zoomScale(y.z),f=(y.x+Math.pow(2,y.z)*s.wrap)*l,p=y.y*l;return hn(x,x,[f,p,0]),sn(x,x,[l/at,l/at,1]),x}upVector(e,n,s){return[0,0,1]}upVectorScale(e,n,s){return{metersToTile:1}}}class hF extends Uc{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];let[n,s]=this.parallels=e.parallels||[29.5,45.5],l=Math.sin(gn(n));this.n=(l+Math.sin(gn(s)))/2,this.c=1+l*(2*this.n-l),this.r0=Math.sqrt(this.c)/this.n}project(e,n){let{n:s,c:l,r0:f}=this,p=gn(e-this.center[0]),y=gn(n),x=Math.sqrt(l-2*s*Math.sin(y))/s;return{x:x*Math.sin(p*s),y:x*Math.cos(p*s)-f,z:0}}unproject(e,n){let{n:s,c:l,r0:f}=this,p=f+n,y=Math.atan2(e,Math.abs(p))*Math.sign(p);p*s<0&&(y-=Math.PI*Math.sign(e)*Math.sign(p));let x=gn(this.center[0])*s;y=De(y,-Math.PI-x,Math.PI-x);let b=ae(Ae(y/s)+this.center[0],-180,180),I=Math.asin(ae((l-(e*e+p*p)*s*s)/(2*s),-1,1)),S=ae(Ae(I),-85.051129,Be);return new Z(b,S)}}let ag=1.340264,lg=-.081106,cg=893e-6,ug=.003796,fv=Math.sqrt(3)/2;class dF extends Uc{project(e,n){n=n/180*Math.PI,e=e/180*Math.PI;let s=Math.asin(fv*Math.sin(n)),l=s*s,f=l*l*l;return{x:.5*(e*Math.cos(s)/(fv*(ag+3*lg*l+f*(7*cg+9*ug*l)))/Math.PI+.5),y:1-.5*(s*(ag+lg*l+f*(cg+ug*l))/Math.PI+1),z:0}}unproject(e,n){e=(2*e-.5)*Math.PI;let s=n=(2*(1-n)-1)*Math.PI,l=s*s,f=l*l*l;for(let I,S,D,R=0;R<12&&(S=s*(ag+lg*l+f*(cg+ug*l))-n,D=ag+3*lg*l+f*(7*cg+9*ug*l),I=S/D,s=ae(s-I,-Math.PI/3,Math.PI/3),l=s*s,f=l*l*l,!(Math.abs(I)<1e-12));++R);let p=fv*e*(ag+3*lg*l+f*(7*cg+9*ug*l))/Math.cos(s),y=Math.asin(Math.sin(s)/fv),x=ae(180*p/Math.PI,-180,180),b=ae(180*y/Math.PI,-85.051129,Be);return new Z(x,b)}}class fF extends Uc{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,n){return{x:.5+e/360,y:.5-n/360,z:0}}unproject(e,n){let s=360*(e-.5),l=ae(360*(.5-n),-85.051129,Be);return new Z(s,l)}}let _f=Math.PI/2;function pv(r){return Math.tan((_f+r)/2)}class pF extends Uc{constructor(e){super(e),this.center=e.center||[0,30];let[n,s]=this.parallels=e.parallels||[30,30],l=gn(n),f=gn(s);this.southernCenter=l+f<0,this.southernCenter&&(l=-l,f=-f);let p=Math.cos(l),y=pv(l);this.n=l===f?Math.sin(l):Math.log(p/Math.cos(f))/Math.log(pv(f)/y),this.f=p*Math.pow(pv(l),this.n)/this.n}project(e,n){n=gn(n),this.southernCenter&&(n=-n),e=gn(e-this.center[0]);let s=1e-6,{n:l,f}=this;f>0?n<-_f+s&&(n=-_f+s):n>_f-s&&(n=_f-s);let p=f/Math.pow(pv(n),l),y=p*Math.sin(l*e),x=f-p*Math.cos(l*e);return y=.5*(y/Math.PI+.5),x=.5*(x/Math.PI+.5),{x:y,y:this.southernCenter?x:1-x,z:0}}unproject(e,n){e=(2*e-.5)*Math.PI,this.southernCenter&&(n=1-n),n=(2*(1-n)-.5)*Math.PI;let{n:s,f:l}=this,f=l-n,p=Math.sign(f),y=Math.sign(s)*Math.sqrt(e*e+f*f),x=Math.atan2(e,Math.abs(f))*p;f*s<0&&(x-=Math.PI*Math.sign(e)*p);let b=ae(Ae(x/s)+this.center[0],-180,180),I=ae(Ae(2*Math.atan(Math.pow(l/y,1/s))-_f),-85.051129,Be);return new Z(b,this.southernCenter?-I:I)}}class FC extends Uc{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,n){return{x:se(e),y:oe(n),z:0}}unproject(e,n){let s=fe(e),l=Te(n);return new Z(s,l)}}let NC=gn(Be);class mF extends Uc{project(e,n){let s=(n=gn(n))*n,l=s*s;return{x:.5*((e=gn(e))*(.8707-.131979*s+l*(l*(.003971*s-.001529*l)-.013791))/Math.PI+.5),y:1-.5*(n*(1.007226+s*(.015085+l*(.028874*s-.044475-.005916*l)))/Math.PI+1),z:0}}unproject(e,n){e=(2*e-.5)*Math.PI;let s=n=(2*(1-n)-1)*Math.PI,l=25,f=0,p=s*s;do{p=s*s;let b=p*p;f=(s*(1.007226+p*(.015085+b*(.028874*p-.044475-.005916*b)))-n)/(1.007226+p*(.045255+b*(.259866*p-.311325-.005916*11*b))),s=ae(s-f,-NC,NC)}while(Math.abs(f)>1e-6&&--l>0);p=s*s;let y=ae(Ae(e/(.8707+p*(p*(p*p*p*(.003971-.001529*p)-.013791)-.131979))),-180,180),x=Ae(s);return new Z(y,x)}}let zC=gn(Be);class gF extends Uc{project(e,n){n=gn(n),e=gn(e);let s=Math.cos(n),l=2/Math.PI,f=Math.acos(s*Math.cos(e/2)),p=Math.sin(f)/f,y=.5*(e*l+2*s*Math.sin(e/2)/p)||0,x=.5*(n+Math.sin(n)/p)||0;return{x:.5*(y/Math.PI+.5),y:1-.5*(x/Math.PI+1),z:0}}unproject(e,n){let s=e=(2*e-.5)*Math.PI,l=n=(2*(1-n)-1)*Math.PI,f=25,p=1e-6,y=0,x=0;do{let b=Math.cos(l),I=Math.sin(l),S=2*I*b,D=I*I,R=b*b,L=Math.cos(s/2),F=Math.sin(s/2),V=2*L*F,$=F*F,Y=1-R*L*L,K=Y?1/Y:0,z=Y?Math.acos(b*L)*Math.sqrt(1/Y):0,W=.5*(2*z*b*F+2*s/Math.PI)-e,J=.5*(z*I+l)-n,te=.5*K*(R*$+z*b*L*D)+1/Math.PI,me=K*(V*S/4-z*I*F),de=.125*K*(S*F-z*I*R*V),ge=.5*K*(D*L+z*$*b)+.5,xe=me*de-ge*te;y=(J*me-W*ge)/xe,x=(W*de-J*te)/xe,s=ae(s-y,-Math.PI,Math.PI),l=ae(l-x,-zC,zC)}while((Math.abs(y)>p||Math.abs(x)>p)&&--f>0);return new Z(Ae(s),Ae(l))}}class BC extends Uc{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(gn(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,n){let{scale:s,cosPhi:l}=this;return{x:gn(e)*l*s+.5,y:-Math.sin(gn(n))/l*s+.5,z:0}}unproject(e,n){let{scale:s,cosPhi:l}=this,f=-(n-.5)/s,p=ae(Ae((e-.5)/s)/l,-180,180),y=Math.asin(ae(f*l,-1,1)),x=ae(Ae(y),-85.051129,Be);return new Z(p,x)}}class _F extends FC{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,n,s){let l=Bm(e,n,s);return ai(l,l,Gy(Fa(s))),{x:l[0],y:l[1],z:l[2]}}locationPoint(e,n,s){let l=B(n.lat,n.lng),f=bi([],l),p=s?e._centerAltitude+s:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(n),e._centerAltitude):e._centerAltitude;yo(l,l,f,he(1,0)*at*p);let y=Se(new Float64Array(16));return Lt(y,e.pixelMatrix,e.globeMatrix),ai(l,l,y),new ot(l[0],l[1])}pixelsPerMeter(e,n){return he(1,0)*n}pixelSpaceConversion(e,n,s){let l=he(1,e)*n,f=kt(he(1,45)*n,l,s);return this.pixelsPerMeter(e,n)/f}createTileMatrix(e,n,s){let l=p1(Fa(s.canonical));return Lt(new Float64Array(16),e.globeMatrix,l)}createInversionMatrix(e,n){let{center:s}=e,l=Gy(Fa(n));return fr(l,l,gn(s.lng)),Yi(l,l,gn(s.lat)),sn(l,l,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(l)}pointCoordinate(e,n,s,l){return bS(e,n,s,!0)||new _e(0,0)}pointCoordinate3D(e,n,s){let l=this.pointCoordinate(e,n,s,0);return[l.x,l.y,l.z]}isPointAboveHorizon(e,n){return!bS(e,n.x,n.y,!1)}farthestPixelDistance(e){let n=function(l,f){let p=l.cameraToCenterDistance,y=l._centerAltitude*f,x=l._camera,b=l._camera.forward(),I=Ui([],pi([],b,-p),[0,0,y]),S=l.worldSize/(2*Math.PI),D=[0,0,-S],R=l.width/l.height,L=Math.tan(l.fovAboveCenter),F=pi([],x.up(),L),V=pi([],x.right(),L*R),$=bi([],Ui([],Ui([],b,F),V)),Y=[],K;if(new ii(I,$).closestPointOnSphere(D,S,Y)){let z=Ui([],Y,D),W=Vi([],z,I);K=Math.cos(l.fovAboveCenter)*Pr(W)}else{let z=Vi([],I,D),W=Vi([],D,I);bi(W,W);let J=Pr(z)-S;K=Math.sqrt(J*(J+2*S));let te=Math.acos(K/(S+J))-Math.acos(Bi(b,W));K*=Math.cos(te)}return 1.01*K}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),s=zc(e.zoom);if(s>0){let l=OC(e,he(1,e.center.lat)*e.worldSize),f=e.worldSize/(2*Math.PI),p=Math.max(e.width,e.height)/e.worldSize*Math.PI;return kt(n,l+f*(1-Math.cos(p)),Math.pow(s,10))}return n}upVector(e,n,s){return Bm(n,s,e,1)}upVectorScale(e){return{metersToTile:Uy($y(Fa(e)))}}}function VC(r){let e=r.parallels,n=!!e&&Math.abs(e[0]+e[1])<.01;switch(r.name){case"mercator":return new FC(r);case"equirectangular":return new fF(r);case"naturalEarth":return new mF(r);case"equalEarth":return new dF(r);case"winkelTripel":return new gF(r);case"albers":return n?new BC(r):new hF(r);case"lambertConformalConic":return n?new BC(r):new pF(r);case"globe":return new _F(r)}throw new Error(`Invalid projection name: ${r.name}`)}let yF=Kt.VectorTileFeature.types,vF=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function mv(r,e,n,s,l,f,p,y,x,b,I,S,D){let R=y?Math.min(jc,Math.round(y[0])):0,L=y?Math.min(jc,Math.round(y[1])):0;r.emplaceBack(e,n,Math.round(32*s),Math.round(32*l),f,p,(R<<1)+(x?1:0),L,16*b,16*I,256*S,256*D)}function gv(r,e,n){r.emplaceBack(e,n)}function _v(r,e,n,s,l,f,p){r.emplaceBack(e,n,s,l,f,p)}let yv=(r,e,n,s)=>{for(let l=0;l<e;l++)r.emplaceBack(n[0],n[1],n[2],s[0],s[1],s[2])};function vv(r,e,n,s,l){r.emplaceBack(e,n,s,l),r.emplaceBack(e,n,s,l),r.emplaceBack(e,n,s,l),r.emplaceBack(e,n,s,l)}function xF(r){for(let e of r.sections)if(i1(e.text))return!0;return!1}class J1{constructor(e){this.layoutVertexArray=new Mc,this.indexArray=new cr,this.programConfigurations=e,this.segments=new Di,this.dynamicLayoutVertexArray=new lr,this.opacityVertexArray=new Rc,this.placedSymbolArray=new Cy,this.iconTransitioningVertexArray=new Ra,this.globeExtVertexArray=new Ac,this.zOffsetVertexArray=new Ma,this.orientationVertexArray=new Cm}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(e,n,s,l,f){this.isEmpty()||(s&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Pk.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,n),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,Ok.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,vF,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,Nk.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,Lk.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||f)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,kk.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=e.createVertexBuffer(this.orientationVertexArray,Fk.members,!0)),this.opacityVertexBuffer.itemSize=1),(s||l)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}pt(J1,"SymbolBuffers");class Q1{constructor(e,n,s){this.layoutVertexArray=new e,this.layoutAttributes=n,this.indexArray=new s,this.segments=new Di,this.collisionVertexArray=new ih,this.collisionVertexArrayExt=new lr}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,zk.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,Bk.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}pt(Q1,"CollisionBuffers");class xv{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.lut=e.lut,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(p=>p.fqid),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Se([]),this.placementViewportMatrix=Se([]);let n=this.layers[0]._unevaluatedLayout._values;this.worldview=e.worldview,this.textSizeData=mC(this.zoom,n["text-size"],this.worldview),this.iconSizeData=mC(this.zoom,n["icon-size"],this.worldview);let s=this.layers[0].layout,l=s.get("symbol-sort-key"),f=s.get("symbol-z-order");this.canOverlap=s.get("text-allow-overlap")||s.get("icon-allow-overlap")||s.get("text-ignore-placement")||s.get("icon-ignore-placement"),this.sortFeaturesByKey=f!=="viewport-y"&&l.constantOr(1)!==void 0,this.sortFeaturesByY=(f==="viewport-y"||f==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=s.get("text-writing-mode").map(p=>To[p]),this.stateDependentLayerIds=this.layers.filter(p=>p.isStateDependent()).map(p=>p.id),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0}createArrays(){this.text=new J1(new u(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("text")||e.startsWith("symbol"))),this.icon=new J1(new u(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("icon")||e.startsWith("symbol"))),this.glyphOffsetArray=new Pm,this.lineVertexArray=new Ry,this.symbolInstances=new Ay}calculateGlyphDependencies(e,n,s,l,f){for(let p of e){let y=p.codePointAt(0);if(y===void 0)break;if(n[y]=!0,l&&f&&y<=65535){let x=tg[p];x&&(n[x.charCodeAt(0)]=!0)}}}updateFootprints(e,n){}updateReplacement(e,n){if(n.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=n.updateTime;let s=n.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!D1(this.activeReplacements,s)&&(this.activeReplacements=s,!0)}populate(e,n,s,l){let f=this.layers[0],p=f.layout,y=this.projection.name==="globe",x=p.get("text-font"),b=p.get("text-field"),I=p.get("icon-image"),[S,D]=p.get("icon-size-scale-range"),R=ae(n.scaleFactor||1,S,D),L=(b.value.kind!=="constant"||b.value.value instanceof Nr&&!b.value.value.isEmpty()||b.value.value.toString().length>0)&&(x.value.kind!=="constant"||x.value.value.length>0),F=I.value.kind!=="constant"||!!I.value.value||Object.keys(I.parameters).length>0,V=p.get("symbol-sort-key");if(this.features=[],!L&&!F)return;let $=n.iconDependencies,Y=n.glyphDependencies,K=n.availableImages,z=new zn(this.zoom,{worldview:this.worldview});for(let{feature:W,id:J,index:te,sourceLayerIndex:me}of e){let de=f._featureFilter.needGeometry,ge=dt(W,de);if(!f._featureFilter.filter(z,ge,s))continue;if(de||(ge.geometry=gt(W,s,l)),y&&W.type!==1&&s.z<=5){let Ze=ge.geometry,Ye=.98078528056,Ne=(qe,Le)=>Bi(Bm(qe.x,qe.y,s,1),Bm(Le.x,Le.y,s,1))<Ye;for(let qe=0;qe<Ze.length;qe++)Ze[qe]=nt(Ze[qe],Ne)}let xe,ke;if(L){let Ze=f.getValueAndResolveTokens("text-field",ge,s,K),Ye=Nr.factory(Ze);xF(Ye)&&(this.hasRTLText=!0),(!this.hasRTLText||Tc()==="unavailable"||this.hasRTLText&&$s.isParsed())&&(xe=jk(Ye,f,ge))}if(F){let Ze=f.getValueAndResolveTokens("icon-image",ge,s,K);ke=typeof Ze=="string"?Yr.build(Ze):Ze}if(!xe&&!ke)continue;let Xe=this.sortFeaturesByKey?V.evaluate(ge,{},s):void 0,He={id:J,text:xe,icon:ke,index:te,sourceLayerIndex:me,geometry:ge.geometry,properties:W.properties,type:yF[W.type],sortKey:Xe};if(this.features.push(He),ke){let Ze=this.layers[0]._unevaluatedLayout._values,{iconPrimary:Ye,iconSecondary:Ne}=AC(ke,this.iconSizeData,Ze["icon-size"],s,this.zoom,He,this.pixelRatio,R,this.worldview),qe=Ye.id.toString();if($.has(qe)?$.get(qe).push(Ye):$.set(qe,[Ye]),Ne){let Le=Ne.id.toString();$.has(Le)?$.get(Le).push(Ne):$.set(Le,[Ne])}}if(xe){let Ze=x.evaluate(ge,{},s).join(","),Ye=p.get("text-rotation-alignment")==="map"&&p.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(To.vertical)>=0;for(let Ne of xe.sections)if(Ne.image){let qe=Ne.image.getPrimary().scaleSelf(this.pixelRatio),Le=qe.id.toString(),Fe=$.get(Le)||[];Fe.push(qe),$.set(Le,Fe)}else{let qe=Ku(xe.toString()),Le=Ne.fontStack||Ze,Fe=Y[Le]=Y[Le]||{};this.calculateGlyphDependencies(Ne.text,Fe,Ye,this.allowVerticalPlacement,qe)}}}if(p.get("symbol-placement")==="line"&&(this.features=function(W){let J={},te={},me=[],de=0;function ge(He){me.push(W[He]),de++}function xe(He,Ze,Ye){let Ne=te[He];return delete te[He],te[Ze]=Ne,me[Ne].geometry[0].pop(),me[Ne].geometry[0]=me[Ne].geometry[0].concat(Ye[0]),Ne}function ke(He,Ze,Ye){let Ne=J[Ze];return delete J[Ze],J[He]=Ne,me[Ne].geometry[0].shift(),me[Ne].geometry[0]=Ye[0].concat(me[Ne].geometry[0]),Ne}function Xe(He,Ze,Ye){let Ne=Ye?Ze[0][Ze[0].length-1]:Ze[0][0];return`${He}:${Ne.x}:${Ne.y}`}for(let He=0;He<W.length;He++){let Ze=W[He],Ye=Ze.geometry,Ne=Ze.text?Ze.text.toString():null;if(!Ne){ge(He);continue}let qe=Xe(Ne,Ye),Le=Xe(Ne,Ye,!0);if(qe in te&&Le in J&&te[qe]!==J[Le]){let Fe=ke(qe,Le,Ye),Qe=xe(qe,Le,me[Fe].geometry);delete J[qe],delete te[Le],te[Xe(Ne,me[Qe].geometry,!0)]=Qe,me[Fe].geometry=null}else qe in te?xe(qe,Le,Ye):Le in J?ke(qe,Le,Ye):(ge(He),J[qe]=de-1,te[Le]=de-1)}return me.filter(He=>He.geometry)}(this.features)),p.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",n.elevationFeatures){!this.elevationFeatures&&n.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(let W of n.elevationFeatures)this.elevationFeatureIdToIndex.set(W.id,this.elevationFeatures.length),this.elevationFeatures.push(W)}}else p.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort((W,J)=>W.sortKey-J.sortKey)}update(e,n,s,l,f,p,y){this.text.programConfigurations.updatePaintArrays(e,n,f,s,l,p,y,this.worldview),this.icon.programConfigurations.updatePaintArrays(e,n,f,s,l,p,y,this.worldview)}updateRoadElevation(e){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let n=!1,s=Oe(e),l=1/s,f=!1,p=!1;for(let y=0;y<this.symbolInstances.length;y++){let x=this.symbolInstances.get(y),b=qn(1,0,0),I=qn(0,1,0),{numHorizontalGlyphVertices:S,numVerticalGlyphVertices:D,numIconVertices:R,numVerticalIconVertices:L}=x,F=S>0||D>0,V=R>0,$=this.elevationFeatures[x.elevationFeatureIndex];if($){let Y=new ot(x.tileAnchorX,x.tileAnchorY),K=.075+$.pointElevation(Y);x.zOffset!==K&&(n=!0,x.zOffset=K);let z=$.computeSlopeNormal(Y,l),W=Jl(io(),qn(0,0,1),z);Rs(b,b,W),Rs(I,I,W),b[2]*=s,I[2]*=s,b[0]===1&&b[1]===0&&b[2]===0&&I[0]===0&&I[1]===1&&I[2]===0||(f=f||F,p=p||V)}if(F&&(yv(this.text.orientationVertexArray,S,b,I),yv(this.text.orientationVertexArray,D,b,I)),V){let{placedIconSymbolIndex:Y,verticalPlacedIconSymbolIndex:K}=x;Y>=0&&yv(this.icon.orientationVertexArray,R,b,I),K>=0&&yv(this.icon.orientationVertexArray,L,b,I)}}f||(this.text.orientationVertexArray=void 0),p||(this.icon.orientationVertexArray=void 0),n&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){let e=(f,p,y)=>{s+=p,s>f.length&&f.resize(s);for(let x=-p;x<0;x++)f.emplace(x+s,y)},n=(f,p,y)=>{l+=p,l>f.length&&f.resize(l);for(let x=-p;x<0;x++)f.emplace(x+l,y)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let s=0,l=0;for(let f=0;f<this.symbolInstances.length;f++){let p=this.symbolInstances.get(f),{numHorizontalGlyphVertices:y,numVerticalGlyphVertices:x,numIconVertices:b}=p,I=p.zOffset,S=b>0;if((y>0||x>0)&&(e(this.text.zOffsetVertexArray,y,I),e(this.text.zOffsetVertexArray,x,I)),S){let{placedIconSymbolIndex:D,verticalPlacedIconSymbolIndex:R}=p;D>=0&&n(this.icon.zOffsetVertexArray,b,I),R>=0&&n(this.icon.zOffsetVertexArray,p.numVerticalIconVertices,I)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=VC(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,n){let s=this.lineVertexArray.length;if(e.segment!==void 0)for(let{x:l,y:f}of n)this.lineVertexArray.emplaceBack(l,f);return{lineStartIndex:s,lineLength:this.lineVertexArray.length-s}}addSymbols(e,n,s,l,f,p,y,x,b,I,S,D,R,L,F,V){let $=e.indexArray,Y=e.layoutVertexArray,K=e.globeExtVertexArray,z=e.segments.prepareSegment(4*n.length,Y,$,this.canOverlap?p.sortKey:void 0),W=this.glyphOffsetArray.length,J=z.vertexLength,te=this.allowVerticalPlacement&&y===To.vertical?Math.PI/2:0,me=p.text&&p.text.sections;for(let ge=0;ge<n.length;ge++){let{tl:xe,tr:ke,bl:Xe,br:He,texPrimary:Ze,texSecondary:Ye,pixelOffsetTL:Ne,pixelOffsetBR:qe,minFontScaleX:Le,minFontScaleY:Fe,glyphOffset:Qe,isSDF:tt,sectionIndex:Dt}=n[ge],vt=z.vertexLength,ct=Qe[1];if(mv(Y,b.x,b.y,xe.x,ct+xe.y,Ze.x,Ze.y,s,tt,Ne.x,Ne.y,Le,Fe),mv(Y,b.x,b.y,ke.x,ct+ke.y,Ze.x+Ze.w,Ze.y,s,tt,qe.x,Ne.y,Le,Fe),mv(Y,b.x,b.y,Xe.x,ct+Xe.y,Ze.x,Ze.y+Ze.h,s,tt,Ne.x,qe.y,Le,Fe),mv(Y,b.x,b.y,He.x,ct+He.y,Ze.x+Ze.w,Ze.y+Ze.h,s,tt,qe.x,qe.y,Le,Fe),x){let{x:Je,y:jt,z:yt}=x.anchor,[bt,Ft,Gt]=x.up;_v(K,Je,jt,yt,bt,Ft,Gt),_v(K,Je,jt,yt,bt,Ft,Gt),_v(K,Je,jt,yt,bt,Ft,Gt),_v(K,Je,jt,yt,bt,Ft,Gt),vv(e.dynamicLayoutVertexArray,Je,jt,yt,te)}else vv(e.dynamicLayoutVertexArray,b.x,b.y,b.z,te);if(V){let Je=Ye||Ze;gv(e.iconTransitioningVertexArray,Je.x,Je.y),gv(e.iconTransitioningVertexArray,Je.x+Je.w,Je.y),gv(e.iconTransitioningVertexArray,Je.x,Je.y+Je.h),gv(e.iconTransitioningVertexArray,Je.x+Je.w,Je.y+Je.h)}$.emplaceBack(vt,vt+1,vt+2),$.emplaceBack(vt+1,vt+2,vt+3),z.vertexLength+=4,z.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(Qe[0]),ge!==n.length-1&&Dt===n[ge+1].sectionIndex||e.programConfigurations.populatePaintArrays(Y.length,p,p.index,{},R,L,F,me&&me[Dt],this.worldview)}let de=x?x.anchor:b;e.placedSymbolArray.emplaceBack(de.x,de.y,de.z,b.x,b.y,W,this.glyphOffsetArray.length-W,J,I,S,b.segment,s?s[0]:0,s?s[1]:0,l[0],l[1],y,0,0,0,D,0)}_commitLayoutVertex(e,n,s,l,f,p,y){e.emplaceBack(n,s,l,f,p,Math.round(y.x),Math.round(y.y))}_addCollisionDebugVertices(e,n,s,l,f,p,y){let x=s.segments.prepareSegment(4,s.layoutVertexArray,s.indexArray),b=x.vertexLength,I=y.tileAnchorX,S=y.tileAnchorY;for(let R=0;R<4;R++)s.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(s.collisionVertexArrayExt,n,e.padding,y.zOffset),this._commitLayoutVertex(s.layoutVertexArray,l,f,p,I,S,new ot(e.x1,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,l,f,p,I,S,new ot(e.x2,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,l,f,p,I,S,new ot(e.x2,e.y2)),this._commitLayoutVertex(s.layoutVertexArray,l,f,p,I,S,new ot(e.x1,e.y2)),x.vertexLength+=4;let D=s.indexArray;D.emplaceBack(b,b+1),D.emplaceBack(b+1,b+2),D.emplaceBack(b+2,b+3),D.emplaceBack(b+3,b),x.primitiveLength+=4}_addTextDebugCollisionBoxes(e,n,s,l,f,p){for(let y=l;y<f;y++){let x=s.get(y),b=this.getSymbolInstanceTextSize(e,p,n,y);this._addCollisionDebugVertices(x,b,this.textCollisionBox,x.projectedAnchorX,x.projectedAnchorY,x.projectedAnchorZ,p)}}_addIconDebugCollisionBoxes(e,n,s,l,f,p){for(let y=l;y<f;y++){let x=s.get(y),b=this.getSymbolInstanceIconSize(e,n,p.placedIconSymbolIndex);this._addCollisionDebugVertices(x,b,this.iconCollisionBox,x.projectedAnchorX,x.projectedAnchorY,x.projectedAnchorZ,p)}}generateCollisionDebugBuffers(e,n,s){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Q1(Xd,tC.members,Ra),this.iconCollisionBox=new Q1(Xd,tC.members,Ra);let l=ig(this.iconSizeData,e),f=ig(this.textSizeData,e,s);for(let p=0;p<this.symbolInstances.length;p++){let y=this.symbolInstances.get(p);this._addTextDebugCollisionBoxes(f,e,n,y.textBoxStartIndex,y.textBoxEndIndex,y),this._addTextDebugCollisionBoxes(f,e,n,y.verticalTextBoxStartIndex,y.verticalTextBoxEndIndex,y),this._addIconDebugCollisionBoxes(l,e,n,y.iconBoxStartIndex,y.iconBoxEndIndex,y),this._addIconDebugCollisionBoxes(l,e,n,y.verticalIconBoxStartIndex,y.verticalIconBoxEndIndex,y)}}getSymbolInstanceTextSize(e,n,s,l){let f=this.text.placedSymbolArray.get(n.rightJustifiedTextSymbolIndex>=0?n.rightJustifiedTextSymbolIndex:n.centerJustifiedTextSymbolIndex>=0?n.centerJustifiedTextSymbolIndex:n.leftJustifiedTextSymbolIndex>=0?n.leftJustifiedTextSymbolIndex:n.verticalPlacedTextSymbolIndex>=0?n.verticalPlacedTextSymbolIndex:l),p=G1(this.textSizeData,e,f)/sr;return this.tilePixelRatio*p}getSymbolInstanceIconSize(e,n,s){let l=this.icon.placedSymbolArray.get(s),f=G1(this.iconSizeData,e,l);return this.tilePixelRatio*f}_commitDebugCollisionVertexUpdate(e,n,s,l){e.emplaceBack(n,-s,-s,l),e.emplaceBack(n,s,-s,l),e.emplaceBack(n,s,s,l),e.emplaceBack(n,-s,s,l)}_updateTextDebugCollisionBoxes(e,n,s,l,f,p,y){for(let x=l;x<f;x++){let b=s.get(x),I=this.getSymbolInstanceTextSize(e,p,n,x);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,I,b.padding,p.zOffset)}}_updateIconDebugCollisionBoxes(e,n,s,l,f,p,y){for(let x=l;x<f;x++){let b=s.get(x),I=this.getSymbolInstanceIconSize(e,n,p.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,I,b.padding,p.zOffset)}}updateCollisionDebugBuffers(e,n,s,l){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();let f=ig(this.iconSizeData,e,l),p=ig(this.textSizeData,e,s);for(let y=0;y<this.symbolInstances.length;y++){let x=this.symbolInstances.get(y);this._updateTextDebugCollisionBoxes(p,e,n,x.textBoxStartIndex,x.textBoxEndIndex,x,s),this._updateTextDebugCollisionBoxes(p,e,n,x.verticalTextBoxStartIndex,x.verticalTextBoxEndIndex,x,s),this._updateIconDebugCollisionBoxes(f,e,n,x.iconBoxStartIndex,x.iconBoxEndIndex,x,l),this._updateIconDebugCollisionBoxes(f,e,n,x.verticalIconBoxStartIndex,x.verticalIconBoxEndIndex,x,l)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,n,s,l,f,p,y,x,b){let I={};if(n<s){let{x1:S,y1:D,x2:R,y2:L,padding:F,projectedAnchorX:V,projectedAnchorY:$,projectedAnchorZ:Y,tileAnchorX:K,tileAnchorY:z,featureIndex:W}=e.get(n);I.textBox={x1:S,y1:D,x2:R,y2:L,padding:F,projectedAnchorX:V,projectedAnchorY:$,projectedAnchorZ:Y,tileAnchorX:K,tileAnchorY:z},I.textFeatureIndex=W}if(l<f){let{x1:S,y1:D,x2:R,y2:L,padding:F,projectedAnchorX:V,projectedAnchorY:$,projectedAnchorZ:Y,tileAnchorX:K,tileAnchorY:z,featureIndex:W}=e.get(l);I.verticalTextBox={x1:S,y1:D,x2:R,y2:L,padding:F,projectedAnchorX:V,projectedAnchorY:$,projectedAnchorZ:Y,tileAnchorX:K,tileAnchorY:z},I.verticalTextFeatureIndex=W}if(p<y){let{x1:S,y1:D,x2:R,y2:L,padding:F,projectedAnchorX:V,projectedAnchorY:$,projectedAnchorZ:Y,tileAnchorX:K,tileAnchorY:z,featureIndex:W}=e.get(p);I.iconBox={x1:S,y1:D,x2:R,y2:L,padding:F,projectedAnchorX:V,projectedAnchorY:$,projectedAnchorZ:Y,tileAnchorX:K,tileAnchorY:z},I.iconFeatureIndex=W}if(x<b){let{x1:S,y1:D,x2:R,y2:L,padding:F,projectedAnchorX:V,projectedAnchorY:$,projectedAnchorZ:Y,tileAnchorX:K,tileAnchorY:z,featureIndex:W}=e.get(x);I.verticalIconBox={x1:S,y1:D,x2:R,y2:L,padding:F,projectedAnchorX:V,projectedAnchorY:$,projectedAnchorZ:Y,tileAnchorX:K,tileAnchorY:z},I.verticalIconFeatureIndex=W}return I}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let n=0;n<this.symbolInstances.length;n++){let s=this.symbolInstances.get(n);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,s.textBoxStartIndex,s.textBoxEndIndex,s.verticalTextBoxStartIndex,s.verticalTextBoxEndIndex,s.iconBoxStartIndex,s.iconBoxEndIndex,s.verticalIconBoxStartIndex,s.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,n){let s=e.placedSymbolArray.get(n),l=s.vertexStartIndex+4*s.numGlyphs;for(let f=s.vertexStartIndex;f<l;f+=4)e.indexArray.emplaceBack(f,f+1,f+2),e.indexArray.emplaceBack(f+1,f+2,f+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;let n=Math.sin(e),s=Math.cos(e),l=[],f=[],p=[];for(let y=0;y<this.symbolInstances.length;++y){p.push(y);let x=this.symbolInstances.get(y);l.push(0|Math.round(n*x.tileAnchorX+s*x.tileAnchorY)),f.push(x.featureIndex)}return p.sort((y,x)=>l[y]-l[x]||f[x]-f[y]),p}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((e,n)=>this.symbolInstances.get(n).zOffset-this.symbolInstances.get(e).zOffset)}addToSortKeyRanges(e,n){let s=this.sortKeyRanges[this.sortKeyRanges.length-1];s&&s.sortKey===n?s.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:n,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(let n of this.symbolInstanceIndexes){let s=this.symbolInstances.get(n);this.featureSortOrder.push(s.featureIndex);let{rightJustifiedTextSymbolIndex:l,centerJustifiedTextSymbolIndex:f,leftJustifiedTextSymbolIndex:p,verticalPlacedTextSymbolIndex:y,placedIconSymbolIndex:x,verticalPlacedIconSymbolIndex:b}=s;l>=0&&this.addIndicesForPlacedSymbol(this.text,l),f>=0&&f!==l&&this.addIndicesForPlacedSymbol(this.text,f),p>=0&&p!==f&&p!==l&&this.addIndicesForPlacedSymbol(this.text,p),y>=0&&this.addIndicesForPlacedSymbol(this.text,y),x>=0&&this.addIndicesForPlacedSymbol(this.icon,x),b>=0&&this.addIndicesForPlacedSymbol(this.icon,b)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let jC,UC,ew;pt(xv,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),xv.addDynamicAttributes=vv;class HC{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:oc,this.defaultValue=e}evaluate(e){if(e.formattedSection){let n=this.defaultValue.property.overrides;if(n&&n.hasOverride(e.formattedSection))return n.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}pt(HC,"FormatSectionOverride",{omit:["defaultValue"]});let tw=()=>ew||(ew={layout:jC||(jC=new Ei({"symbol-placement":new Ke(Ee.layout_symbol["symbol-placement"]),"symbol-spacing":new Ke(Ee.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Ke(Ee.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new ht(Ee.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Ke(Ee.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new Ke(Ee.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new Ke(Ee.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new Ke(Ee.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Ke(Ee.layout_symbol["icon-ignore-placement"]),"icon-optional":new Ke(Ee.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Ke(Ee.layout_symbol["icon-rotation-alignment"]),"icon-size":new ht(Ee.layout_symbol["icon-size"]),"icon-size-scale-range":new Ke(Ee.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new ht(Ee.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new ht(Ee.layout_symbol["icon-text-fit-padding"]),"icon-image":new ht(Ee.layout_symbol["icon-image"]),"icon-rotate":new ht(Ee.layout_symbol["icon-rotate"]),"icon-padding":new Ke(Ee.layout_symbol["icon-padding"]),"icon-keep-upright":new Ke(Ee.layout_symbol["icon-keep-upright"]),"icon-offset":new ht(Ee.layout_symbol["icon-offset"]),"icon-anchor":new ht(Ee.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Ke(Ee.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Ke(Ee.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Ke(Ee.layout_symbol["text-rotation-alignment"]),"text-field":new ht(Ee.layout_symbol["text-field"]),"text-font":new ht(Ee.layout_symbol["text-font"]),"text-size":new ht(Ee.layout_symbol["text-size"]),"text-size-scale-range":new Ke(Ee.layout_symbol["text-size-scale-range"]),"text-max-width":new ht(Ee.layout_symbol["text-max-width"]),"text-line-height":new ht(Ee.layout_symbol["text-line-height"]),"text-letter-spacing":new ht(Ee.layout_symbol["text-letter-spacing"]),"text-justify":new ht(Ee.layout_symbol["text-justify"]),"text-radial-offset":new ht(Ee.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Ke(Ee.layout_symbol["text-variable-anchor"]),"text-anchor":new ht(Ee.layout_symbol["text-anchor"]),"text-max-angle":new Ke(Ee.layout_symbol["text-max-angle"]),"text-writing-mode":new Ke(Ee.layout_symbol["text-writing-mode"]),"text-rotate":new ht(Ee.layout_symbol["text-rotate"]),"text-padding":new Ke(Ee.layout_symbol["text-padding"]),"text-keep-upright":new Ke(Ee.layout_symbol["text-keep-upright"]),"text-transform":new ht(Ee.layout_symbol["text-transform"]),"text-offset":new ht(Ee.layout_symbol["text-offset"]),"text-allow-overlap":new Ke(Ee.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Ke(Ee.layout_symbol["text-ignore-placement"]),"text-optional":new Ke(Ee.layout_symbol["text-optional"]),visibility:new Ke(Ee.layout_symbol.visibility)})),paint:UC||(UC=new Ei({"icon-opacity":new ht(Ee.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new ht(Ee.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new ht(Ee.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new ht(Ee.paint_symbol["text-emissive-strength"]),"icon-color":new ht(Ee.paint_symbol["icon-color"]),"icon-halo-color":new ht(Ee.paint_symbol["icon-halo-color"]),"icon-halo-width":new ht(Ee.paint_symbol["icon-halo-width"]),"icon-halo-blur":new ht(Ee.paint_symbol["icon-halo-blur"]),"icon-translate":new Ke(Ee.paint_symbol["icon-translate"]),"icon-translate-anchor":new Ke(Ee.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new Ke(Ee.paint_symbol["icon-image-cross-fade"]),"text-opacity":new ht(Ee.paint_symbol["text-opacity"]),"text-occlusion-opacity":new ht(Ee.paint_symbol["text-occlusion-opacity"]),"text-color":new ht(Ee.paint_symbol["text-color"],{runtimeType:ao,getOverride:r=>r.textColor,hasOverride:r=>!!r.textColor}),"text-halo-color":new ht(Ee.paint_symbol["text-halo-color"]),"text-halo-width":new ht(Ee.paint_symbol["text-halo-width"]),"text-halo-blur":new ht(Ee.paint_symbol["text-halo-blur"]),"text-translate":new Ke(Ee.paint_symbol["text-translate"]),"text-translate-anchor":new Ke(Ee.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new Ke(Ee.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new Ke(Ee.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new Ke(Ee.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new Ke(Ee.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new ht(Ee.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"})}))},ew);class bv extends Ir{constructor(e,n,s,l){super(e,tw(),n,s,l),this._colorAdjustmentMatrix=Se([]),this.hasInitialOcclusionOpacityProperties=e.paint!==void 0&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}recalculate(e,n){super.recalculate(e,n),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));let s=this.layout.get("text-writing-mode");if(s){let l=[];for(let f of s)l.indexOf(f)<0&&l.push(f);this.layout._values["text-writing-mode"]=l}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,n,s,l){return this._saturation===e&&this._contrast===n&&this._brightnessMin===s&&this._brightnessMax===l||(this._colorAdjustmentMatrix=function(f,p,y,x){f=wr(f),p=Zr(p);let b=st(),I=f/3,S=1-2*I,D=[S,I,I,0,I,S,I,0,I,I,S,0,0,0,0,1],R=.5-.5*p,L=x-y;return Lt(b,[L,0,0,0,0,L,0,0,0,0,L,0,y,y,y,1],[p,0,0,0,0,p,0,0,0,0,p,0,R,R,R,1]),Lt(b,b,D),b}(e,n,s,l),this._saturation=e,this._contrast=n,this._brightnessMin=s,this._brightnessMax=l),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,n,s,l){let f=this.layout.get(e).evaluate(n,{},s,l),p=this._unevaluatedLayout._values[e];return p.isDataDriven()||Bd(p.value)||!f?f:function(y,x){return x.replace(/{([^{}]+)}/g,(b,I)=>I in y?String(y[I]):"")}(n.properties,f)}createBucket(e){return new xv(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(let e of tw().paint.overridableProperties){if(!bv.hasPaintOverride(this.layout,e))continue;let n=this.paint.get(e),s=new HC(n),l=new bc(s,n.property.specification,this.scope,this.options),f=null;f=n.value.kind==="constant"||n.value.kind==="source"?new Xu("source",l):new Yu("composite",l,n.value.zoomStops,n.value.interpolationType),this.paint._values[e]=new Ic(n.property,f,n.parameters)}}_handleOverridablePaintPropertyUpdate(e,n,s){return!(!this.layout||n.isDataDriven()||s.isDataDriven())&&bv.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,n){let s=e.get("text-field"),l=tw().paint.properties[n],f=!1,p=y=>{for(let x of y)if(l.overrides&&l.overrides.hasOverride(x))return void(f=!0)};if(s.value.kind==="constant"&&s.value.value instanceof Nr)p(s.value.value.sections);else if(s.value.kind==="source"){let y=b=>{f||(b instanceof Bt&&ft(b.value)===Pu?p(b.value.sections):b instanceof ac?p(b.sections):b.eachChild(y))},x=s.value;x._styleExpression&&y(x._styleExpression.expression)}return f}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,n,s){return{config:new kc(this,{zoom:n,lut:s}),overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("symbol-elevation-reference")==="hd-road-markup"}}let $C,GC,qC,WC;var nw=mn([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function iw(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function rw(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class ow{constructor(e,n,s,l){this.context=e,this.format=s,this.useMipmap=l&&l.useMipmap,this.texture=e.gl.createTexture(),this.update(n,{premultiply:l&&l.premultiply})}update(e,n){let s=e&&e instanceof HTMLVideoElement&&e.width===0?e.videoWidth:e.width,l=e&&e instanceof HTMLVideoElement&&e.height===0?e.videoHeight:e.height,{context:f}=this,{gl:p}=f,{x:y,y:x}=n&&n.position?n.position:{x:0,y:0},b=y+s,I=x+l;!this.size||this.size[0]===b&&this.size[1]===I||(p.bindTexture(p.TEXTURE_2D,null),p.deleteTexture(this.texture),this.texture=p.createTexture(),this.size=null),p.bindTexture(p.TEXTURE_2D,this.texture),f.pixelStoreUnpackFlipY.set(!1),f.pixelStoreUnpack.set(1),f.pixelStoreUnpackPremultiplyAlpha.set(this.format===p.RGBA8&&(!n||n.premultiply!==!1));let S=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&b>0&&I>0){let D=this.useMipmap?Math.floor(Math.log2(Math.max(b,I)))+1:1;p.texStorage2D(p.TEXTURE_2D,D,this.format,b,I),this.size=[b,I]}if(this.size)if(S)p.texSubImage2D(p.TEXTURE_2D,0,y,x,iw(this.format),rw(this.format),e);else{let D=e.data;D&&p.texSubImage2D(p.TEXTURE_2D,0,y,x,s,l,iw(this.format),rw(this.format),D)}this.useMipmap&&p.generateMipmap(p.TEXTURE_2D)}bind(e,n,s=!1){let{context:l}=this,{gl:f}=l;f.bindTexture(f.TEXTURE_2D,this.texture),e!==this.minFilter&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,e),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,this.useMipmap&&!s?e===f.NEAREST?f.NEAREST_MIPMAP_NEAREST:f.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),n!==this.wrapS&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,n),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,n),this.wrapS=n)}bindExtraParam(e,n,s,l,f){let{context:p}=this,{gl:y}=p;y.bindTexture(y.TEXTURE_2D,this.texture),n!==this.magFilter&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,n),this.magFilter=n),e!==this.minFilter&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,this.useMipmap?e===y.NEAREST?y.NEAREST_MIPMAP_NEAREST:y.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),s!==this.wrapS&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,s),this.wrapS=s),l!==this.wrapT&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,l),this.wrapT=l),f!==this.compareMode&&(f?(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_MODE,y.COMPARE_REF_TO_TEXTURE),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_FUNC,f)):y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_MODE,y.NONE),this.compareMode=f)}destroy(){let{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class wv{constructor(e,n){this.context=e,this.texture=n}bind(e,n){let{context:s}=this,{gl:l}=s;l.bindTexture(l.TEXTURE_2D,this.texture),e!==this.minFilter&&(l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,e),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,e),this.minFilter=e),n!==this.wrapS&&(l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,n),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,n),this.wrapS=n)}}function Ev(r,e,n,s,l,f,p,y){let x=[r,e,1,n,s,1,l,f,1],b=[p,y,1],I=be([],x),[S,D,R]=Zl(b,b,I);return Pe(x,x,[S,0,0,0,D,0,0,0,R])}function ZC(r,e,n,s,l,f,p,y){let x=function(b,I,S,D,R,L,F,V){let $=Ev(0,0,1,0,1,1,0,1),Y=Ev(b,I,S,D,R,L,F,V);return Pe(Y,Y,be([],$))}(r,e,n,s,l,f,p,y);return[x[2]/x[8]/at,x[5]/x[8]/at]}function Tv(r){return[r[0],Math.min(Math.max(r[1],-85.051129),Be)]}class XC extends ul{constructor(e,n,s,l){super(),this.id=e,this.dispatcher=s,this.coordinates=n.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(l),this.options=n,this._dirty=!1}load(e,n){if(this._loaded=n||!1,this.fire(new cl("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=Fp(this.map._requestManager.transformRequest(this.url,Du.Image),(s,l)=>{this._imageRequest=null,this._loaded=!0,s?this.fire(new dd(s)):l&&(this.image=l instanceof HTMLImageElement?Zo.getImageData(l):l,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())})}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new wv(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new cl("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof wv||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let n=e[0][1],s=e[0][1];for(let f of e)f[1]>s&&(s=f[1]),f[1]<n&&(n=f[1]);let l=(s+n)/2;if(l>Be?this.onNorthPole=!0:l<-85.051129&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){let f=e.map(_e.fromLngLat);this.tileID=function(p){let y=1/0,x=1/0,b=-1/0,I=-1/0;for(let F of p)y=Math.min(y,F.x),x=Math.min(x,F.y),b=Math.max(b,F.x),I=Math.max(I,F.y);let S=Math.max(b-y,I-x),D=Math.max(0,Math.floor(-Math.log(S)/Math.LN2)),R=Math.pow(2,D),L=Math.floor((y+b)/2*R);return L>1&&(L-=1),new mh(D,L,Math.floor((x+I)/2*R))}(f),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new cl("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(let $ in this.tiles){let Y=this.tiles[$];Y.state!=="loaded"&&(Y.state="loaded",Y.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;let n=sg(new mh(0,0,0),this.map.transform.projection),s=[n.projection.project(this.coordinates[0][0],this.coordinates[0][1]),n.projection.project(this.coordinates[1][0],this.coordinates[1][1]),n.projection.project(this.coordinates[2][0],this.coordinates[2][1]),n.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function($){let Y=$[1].x-$[0].x,K=$[1].y-$[0].y,z=$[2].x-$[1].x,W=$[2].y-$[1].y,J=$[3].x-$[2].x,te=$[3].y-$[2].y,me=$[0].x-$[3].x,de=$[0].y-$[3].y,ge=Y*W-z*K,xe=z*te-J*W,ke=J*de-me*te,Xe=me*K-Y*de;return ge>0&&xe>0&&ke>0&&Xe>0||ge<0&&xe<0&&ke<0&&Xe<0}(s))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);let l=sg(this.tileID,this.map.transform.projection),[f,p,y,x]=this.coordinates.map($=>{let Y=l.projection.project($[0],$[1]);return kC(l,Y)._round()});this.perspectiveTransform=ZC(f.x,f.y,p.x,p.y,y.x,y.y,x.x,x.y);let b=this._boundsArray=new Dc;b.emplaceBack(f.x,f.y,0,0),b.emplaceBack(p.x,p.y,at,0),b.emplaceBack(x.x,x.y,0,at),b.emplaceBack(y.x,y.y,at,at),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(b,nw.members),this.boundsSegments=Di.simpleSegment(0,0,4,2);let I=[],S=[Tv((D=this.coordinates)[0]),Tv(D[1]),Tv(D[2]),Tv(D[3])];var D;let[R,L,F,V]=function($){let Y=$[0][0],K=Y,z=$[0][1],W=z;for(let J=1;J<$.length;J++)$[J][0]<Y?Y=$[J][0]:$[J][0]>K&&(K=$[J][0]),$[J][1]<z?z=$[J][1]:$[J][1]>W&&(W=$[J][1]);return[Y,z,K-Y,W-z]}(S);{let $=new Dc,[Y,K,z,W]=function(Ne){let qe=Ne[0].x,Le=qe,Fe=Ne[0].y,Qe=Fe;for(let tt=1;tt<Ne.length;tt++)Ne[tt].x<qe?qe=Ne[tt].x:Ne[tt].x>Le&&(Le=Ne[tt].x),Ne[tt].y<Fe?Fe=Ne[tt].y:Ne[tt].y>Qe&&(Qe=Ne[tt].y);return[qe,Fe,Le-qe,Qe-Fe]}(s),J=Ne=>[(Ne.x-Y)/z,(Ne.y-K)/W],[te,me,de,ge]=s.map(J),xe=function(Ne,qe,Le,Fe,Qe,tt,Dt,vt){let ct=Ev(0,0,1,0,1,1,0,1);return Pe(ct,ct,be([],Ev(Ne,qe,Le,Fe,Qe,tt,Dt,vt)))}(te[0],te[1],me[0],me[1],de[0],de[1],ge[0],ge[1]);this.elevatedGlobePerspectiveTransform=ZC(te[0],te[1],me[0],me[1],de[0],de[1],ge[0],ge[1]);let ke=(Ne,qe)=>{I.push(Ne.lng);let Le=Math.round((Ne.lng-R)/F*at),Fe=Math.round((Ne.lat-L)/V*at),Qe=J(qe),tt=Zl([],[Qe[0],Qe[1],1],xe),Dt=Math.round(tt[0]/tt[2]*at),vt=Math.round(tt[1]/tt[2]*at);$.emplaceBack(Le,Fe,Dt,vt)},Xe=s[3].x-s[0].x,He=s[3].y-s[0].y,Ze=s[2].x-s[1].x,Ye=s[2].y-s[1].y;for(let Ne=0;Ne<65;Ne++){let qe=Ne/64,Le=[s[0].x+qe*Xe,s[0].y+qe*He],Fe=[s[1].x+qe*Ze,s[1].y+qe*Ye],Qe=Fe[0]-Le[0],tt=Fe[1]-Le[1];for(let Dt=0;Dt<65;Dt++){let vt=Dt/64,ct={x:Le[0]+Qe*vt,y:Le[1]+tt*vt};ke(n.projection.unproject(ct.x,ct.y),ct)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer($,nw.members)}{this.maxLongitudeTriangleSize=0;let $=[],Y=new cr,K=(z,W,J)=>{Y.emplaceBack(z,W,J);let te=I[z],me=I[W],de=I[J],ge=Math.min(Math.min(te,me),de),xe=Math.max(Math.max(te,me),de)-ge;xe>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=xe),$.push(ge+xe/2)};for(let z=0;z<64;z++)for(let W=0;W<64;W++){let J=65*z+W,te=J+1,me=J+65,de=me+1;K(J,me,te),K(te,me,de)}[$,Y]=function(z,W){let J=Array.from({length:z.length},(de,ge)=>ge);J.sort((de,ge)=>z[de]-z[ge]);let te=[],me=new cr;for(let de=0;de<J.length;de++){let ge=J[de];te.push(z[ge]);let xe=3*ge,ke=xe+1;me.emplaceBack(W.uint16[xe],W.uint16[ke],W.uint16[ke+1])}return[te,me]}($,Y),this.elevatedGlobeTrianglesCenterLongitudes=$,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(Y)}this.elevatedGlobeSegments=Di.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,F/at,0,V/at,0,0,L,R,0])}prepare(){let e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;let n=this.map.painter.context,s=n.gl;!this._dirty||this.texture instanceof wv||(this.texture?this.texture.update(this.image):(this.texture=new ow(n,this.image,s.RGBA8),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(n)}loadTile(e,n){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},n(null)):(e.state="errored",n(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){let n=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!n)return null;let s=this.elevatedGlobeTrianglesCenterLongitudes,l=(f=e+180)+360*Math.round((s[0]-f)/360);var f;let p=new Di,y=(S,D)=>{p.segments.push({vertexOffset:0,primitiveOffset:S,vertexLength:n.segments[0].vertexLength,primitiveLength:D,sortKey:void 0,vaos:{}})},x=.51*this.maxLongitudeTriangleSize;if(Math.abs(s[0]-l)<=x){let S=rr(s,0,s.length,l+x);return S===s.length||y(S,_i(s,S+1,s.length,l+360-x)-S),p}l<s[0]&&(l+=360);let b=_i(s,0,s.length,l-x);if(b===s.length)return y(0,s.length),p;y(0,b-0);let I=rr(s,b+1,s.length,l+x);return I!==s.length&&y(I,s.length-I),p}}let bF=(Math.pow(256,2)-1)/16907520;class YC extends Ir{constructor(e,n,s,l){super(e,{layout:qC||(qC=new Ei({visibility:new Ke(Ee.layout_raster.visibility)})),paint:WC||(WC=new Ei({"raster-opacity":new Ke(Ee.paint_raster["raster-opacity"]),"raster-color":new Tl(Ee.paint_raster["raster-color"]),"raster-color-mix":new Ke(Ee.paint_raster["raster-color-mix"]),"raster-color-range":new Ke(Ee.paint_raster["raster-color-range"]),"raster-hue-rotate":new Ke(Ee.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Ke(Ee.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Ke(Ee.paint_raster["raster-brightness-max"]),"raster-saturation":new Ke(Ee.paint_raster["raster-saturation"]),"raster-contrast":new Ke(Ee.paint_raster["raster-contrast"]),"raster-resampling":new Ke(Ee.paint_raster["raster-resampling"]),"raster-fade-duration":new Ke(Ee.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new Ke(Ee.paint_raster["raster-emissive-strength"]),"raster-array-band":new Ke(Ee.paint_raster["raster-array-band"]),"raster-elevation":new Ke(Ee.paint_raster["raster-elevation"]),"raster-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"})}))},n,s,l),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof XC&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;let n=this._transitionablePaint._values["raster-color"].value.expression,[s,l]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(s)&&isNaN(l)||s===this._curRampRange[0]&&l===this._curRampRange[1]||(this.colorRamp=Vm({expression:n,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:s,end:l}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[s,l])}}let KC,JC,QC,eM,tM;class nM extends Ir{constructor(e,n,s,l){super(e,{layout:KC||(KC=new Ei({visibility:new Ke(Ee["layout_raster-particle"].visibility)})),paint:JC||(JC=new Ei({"raster-particle-array-band":new Ke(Ee["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new Ke(Ee["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new Tl(Ee["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new Ke(Ee["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new Ke(Ee["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new Ke(Ee["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new Ke(Ee["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new Ke(Ee["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"})}))},n,s,l),this._updateColorRamp(),this.lastInvalidatedAt=Zo.now()}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;let e=this._transitionablePaint._values["raster-particle-color"].value.expression,n=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=Vm({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:n}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=Zo.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class wF extends Ir{constructor(e,n){super(e,{},n,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function sw(r,e,n){let s=[0,0,1],l=ua([]);return da(l,l,n?-gn(r)+Math.PI:gn(r)),ha(l,l,-gn(e)),Rs(s,s,l),bi(s,s)}function iM(r,e){let n=Iv(r.projection,r.zoom,r.width,r.height),s=function(f,p,y,x,b){let I=new Z(y.lng-180*Hc,y.lat),S=new Z(y.lng+180*Hc,y.lat),D=f.project(I.lng,I.lat),R=f.project(S.lng,S.lat),L=-Math.atan2(R.y-D.y,R.x-D.x),F=_e.fromLngLat(y);F.y=ae(F.y,-1+Hc,1-Hc);let V=F.toLngLat(),$=f.project(V.lng,V.lat),Y=_e.fromLngLat(V);Y.x+=Hc;let K=Y.toLngLat(),z=f.project(K.lng,K.lat),W=oM(z.x-$.x,z.y-$.y,L),J=_e.fromLngLat(V);J.y+=Hc;let te=J.toLngLat(),me=f.project(te.lng,te.lat),de=oM(me.x-$.x,me.y-$.y,L),ge=Math.abs(W.x)/Math.abs(de.y),xe=Se([]);_o(xe,xe,-L*(1-(b?0:x)));let ke=Se([]);return sn(ke,ke,[1,1-(1-ge)*x,1]),ke[4]=-de.x/de.y*x,_o(ke,ke,L),Lt(ke,xe,ke),ke}(r.projection,0,r.center,n,e),l=rM(r);return sn(s,s,[l,l,1]),s}function rM(r){let e=r.projection,n=Iv(r.projection,r.zoom,r.width,r.height),s=aw(e,r.center),l=aw(e,Z.convert(e.center));return Math.pow(2,s*n+(1-n)*l)}function Iv(r,e,n,s,l=1/0){let f=r.range;if(!f)return 0;let p=Math.min(l,Math.max(n,s)),y=Math.log(p/1024)/Math.LN2;return ye(f[0]+y,f[1]+y,e)}let Hc=1/4e4;function aw(r,e){let n=ae(e.lat,-85.051129,Be),s=new Z(e.lng-180*Hc,n),l=new Z(e.lng+180*Hc,n),f=r.project(s.lng,n),p=r.project(l.lng,n),y=_e.fromLngLat(s),x=_e.fromLngLat(l),b=p.x-f.x,I=p.y-f.y,S=x.x-y.x,D=x.y-y.y,R=Math.sqrt((S*S+D*D)/(b*b+I*I));return Math.log(R)/Math.LN2}function oM(r,e,n){let s=Math.cos(n),l=Math.sin(n);return{x:r*s-e*l,y:r*l+e*s}}function sM(r,e,n){Se(r),_o(r,r,gn(e[2])),Yi(r,r,gn(e[0])),fr(r,r,gn(e[1])),sn(r,r,n),Lt(r,r,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function Sv(r,e,n,s,l,f,p,y){let x=[n[0]-e[0],n[1]-e[1],0],b=[s[0]-e[0],s[1]-e[1],0];if(Pr(x)<1e-12||Pr(b)<1e-12)return ua(r);let I=er([],x,b);bi(I,I),Qi(b,s,e),x[2]=(f-l)*y,b[2]=(p-l)*y;let S=x;return er(S,x,b),bi(S,S),Jl(r,I,S)}function lw(r,e,n=!1){let s=zc(e.zoom),l=function(f,p,y){let x=p.worldSize,b=[f[12],f[13],f[14]],I=Te(b[1]/x),S=fe(b[0]/x),D=Se([]),R=he(1,I)*x,L=he(1,0)*x*We(I,p.zoom),F=1/m1(x),V=L*F;if(y){let z=Iv(p.projection,p.zoom,p.width,p.height,1024);V=F*p.projection.pixelSpaceConversion(p.center.lat,x,z)}let $=B(I,S);Ui($,$,pi([],bi([],$),R*V*b[2]));let Y=function(z){let W=[z[0],z[1],z[2]],J=[0,1,0],te=er([],J,W);return er(J,W,te),ql(J)===0&&(J=[0,1,0],er(te,W,J)),bi(te,te),bi(J,J),bi(W,W),[te[0],te[1],te[2],0,J[0],J[1],J[2],0,W[0],W[1],W[2],0,z[0],z[1],z[2],1]}($);sn(D,D,[V,V,V*R]),hn(D,D,[-b[0],-b[1],-b[2]]);let K=Lt([],p.globeMatrix,Y);return Lt(K,K,D),Lt(K,K,f),K}(r,e,n);if(s>0){let f=function(p,y){let x=y.worldSize,b=he(1,0)*x*We(y.center.lat,y.zoom)/m1(x),I=he(1,y.center.lat)*x,S=Se([]);return fr(S,S,gn(y.center.lng)),Yi(S,S,gn(y.center.lat)),hn(S,S,[0,0,v]),sn(S,S,[b,b,b*I]),hn(S,S,[y.point.x-.5*x,y.point.y-.5*x,0]),Lt(S,S,p),Lt(S,y.globeMatrix,S)}(r,e);return function(p,y,x){let b=(L,F,V)=>{let $=Pr(L),Y=Pr(F),K=Cl(L,F,V);return pi(K,K,1/Pr(K)*kt($,Y,V))},I=b([p[0],p[1],p[2]],[y[0],y[1],y[2]],x),S=b([p[4],p[5],p[6]],[y[4],y[5],y[6]],x),D=b([p[8],p[9],p[10]],[y[8],y[9],y[10]],x),R=Cl([p[12],p[13],p[14]],[y[12],y[13],y[14]],x);return[I[0],I[1],I[2],0,S[0],S[1],S[2],0,D[0],D[1],D[2],0,R[0],R[1],R[2],1]}(l,f,s)}return l}function aM(r,e,n,s){let l=_n.projectAabbCorners(s,n),f=Number.MAX_VALUE,p=-1;for(let b=0;b<l.length;++b){let I=l[b];I[0]=(.5*I[0]+.5)*e.width,I[1]=(.5-.5*I[1])*e.height,I[2]<f&&(p=b,f=I[2])}let y=b=>new ot(l[b][0],l[b][1]),x;switch(p){case 0:case 6:x=[y(1),y(5),y(4),y(7),y(3),y(2),y(1)];break;case 1:case 7:x=[y(0),y(4),y(5),y(6),y(2),y(3),y(0)];break;case 3:case 5:x=[y(1),y(0),y(4),y(7),y(6),y(2),y(1)];break;default:x=[y(1),y(5),y(6),y(7),y(3),y(0),y(1)]}if(Jr(r,x))return f}let EF=mn([{name:"a_pos_3f",components:3,type:"Float32"}]),TF=mn([{name:"a_color_3f",components:3,type:"Float32"}]),IF=mn([{name:"a_color_4f",components:4,type:"Float32"}]),SF=mn([{name:"a_uv_2f",components:2,type:"Float32"}]),DF=mn([{name:"a_normal_3f",components:3,type:"Float32"}]),CF=mn([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),MF=mn([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]),lM={None:0,Model:1,Symbol:2,FillExtrusion:4};class Dv{constructor(e,n,s,l){this.message=(e?`${e}: `:"")+s,l&&(this.identifier=l),n!=null&&n.__line__&&(this.line=n.__line__)}}function cw(r,e){let n=r.indexOf("://")===-1;try{return new URL(r,n&&e?"http://example.com":void 0),!0}catch{return!1}}class cM{constructor(e,n){this.feature=e,this.instancedDataOffset=n,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class uM{constructor(){this.instancedDataArray=new Pc,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class uw{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.projection=e.projection,this.index=e.index,this.worldview=e.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=e.styleDefinedModelURLs}updateFootprints(e,n){}populate(e,n,s,l){this.tileToMeter=Oe(s);let f=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(let{feature:p,id:y,index:x,sourceLayerIndex:b}of e){let I=y??(p.properties&&p.properties.hasOwnProperty("id")?p.properties.id:void 0),S=dt(p,f);if(!this.layers[0]._featureFilter.filter(new zn(this.zoom,{worldview:this.worldview}),S,s))continue;let D={id:I,sourceLayerIndex:b,index:x,geometry:f?S.geometry:gt(p,s,l),properties:p.properties,type:p.type,patterns:{}},R=this.addFeature(D,D.geometry,S);R&&n.featureIndex.insert(p,D.geometry,x,b,this.index,this.instancesPerModel[R].instancedDataArray.length,at/32)}this.lookup=null}update(e,n,s,l){for(let f in this.instancesPerModel){let p=this.instancesPerModel[f];for(let y in e)p.idToFeaturesIndex.hasOwnProperty(y)&&(this.evaluate(p.features[p.idToFeaturesIndex[y]],e[y],p,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(let n in this.instancesPerModel){let s=this.instancesPerModel[n];for(let l of s.features){let f=this.layers[0],p=l.feature,y=this.canonical,x=f.paint.get("model-rotation").evaluate(p,{},y),b=f.paint.get("model-scale").evaluate(p,{},y),I=f.paint.get("model-translation").evaluate(p,{},y);Wo(l.rotation,x)&&Wo(l.scale,b)&&Wo(l.translation,I)||(this.evaluate(l,l.featureStates,s,!0),e=!0)}}return e}updateReplacement(e,n,s,l){if(n.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=n.updateTime;let f=n.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(D1(this.activeReplacements,f))return!1;this.activeReplacements=f;let p=!1;for(let y in this.instancesPerModel){let x=this.instancesPerModel[y],b=x.instancedDataArray;for(let I of x.features){let S=I.instancedDataOffset,D=I.instancedDataCount;for(let R=0;R<D;R++){let L=16*(R+S),F=b.float32[L+0],V=F>at;F=V?F-at:F;let $=Math.floor(F),Y=b.float32[L+1],K=!1;for(let z of this.activeReplacements)if(!nD(z,s,lM.Model,l)&&!(z.min.x>$||$>z.max.x||z.min.y>Y||Y>z.max.y)&&(K=lD(aD($,Y,e.canonical,z.footprintTileId.canonical),z.footprint),K))break;b.float32[L]=K?F+at:F,p=p||K!==V}}}return p}isEmpty(){for(let e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(let n in this.instancesPerModel){let s=this.instancesPerModel[n];s.instancedDataArray.length<0||s.instancedDataArray.length===0||(s.instancedDataBuffer?s.instancedDataBuffer.updateData(s.instancedDataArray):s.instancedDataBuffer=e.createVertexBuffer(s.instancedDataArray,CF.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(let n in this.instancesPerModel){let s=this.instancesPerModel[n];s.instancedDataArray.length!==0&&s.instancedDataBuffer&&s.instancedDataBuffer.destroy()}let e=this.layers[0].modelManager;if(e&&this.modelUris&&this.modelsRequested)for(let n of this.modelUris)e.removeModel(n,"",!0)}addFeature(e,n,s){let l=this.layers[0],f=l.layout.get("model-id").evaluate(s,{},this.canonical);if(!f)return qt(`modelId is not evaluated for layer ${l.id} and it is not going to get rendered.`),f;(cw(f,!1)||this.styleDefinedModelURLs[f]!==void 0)&&(this.modelUris.includes(f)||this.modelUris.push(f)),this.instancesPerModel[f]||(this.instancesPerModel[f]=new uM);let p=this.instancesPerModel[f],y=p.instancedDataArray,x=new cM(s,y.length);for(let b of n)for(let I of b){if(I.x<0||I.x>=at||I.y<0||I.y>=at)continue;let S=(this.lookupDim-1)/at,D=this.lookupDim*(I.y*S|0)+I.x*S|0;if(this.lookup){if(this.lookup[D]!==0)continue;this.lookup[D]=1}this.instanceCount++;let R=y.length;y.resize(R+1),p.instancesEvaluatedElevation.push(0),y.float32[16*R]=I.x,y.float32[16*R+1]=I.y}return x.instancedDataCount=p.instancedDataArray.length-x.instancedDataOffset,x.instancedDataCount>0&&(e.id&&(p.idToFeaturesIndex[e.id]=p.features.length),p.features.push(x),this.evaluate(x,{},p,!1)),f}getModelUris(){return this.modelUris}evaluate(e,n,s,l){let f=this.layers[0],p=e.feature,y=this.canonical,x=e.rotation=f.paint.get("model-rotation").evaluate(p,n,y),b=e.scale=f.paint.get("model-scale").evaluate(p,n,y),I=e.translation=f.paint.get("model-translation").evaluate(p,n,y),S=f.paint.get("model-color").evaluate(p,n,y);S.a=f.paint.get("model-color-mix-intensity").evaluate(p,n,y);let D=[];this.maxVerticalOffset<I[2]&&(this.maxVerticalOffset=I[2]),this.maxScale=Math.max(Math.max(this.maxScale,b[0]),Math.max(b[1],b[2])),sM(D,x,b);let R=Math.round(100*S.a)+S.b/1.05;for(let L=0;L<e.instancedDataCount;++L){let F=e.instancedDataOffset+L,V=16*F,$=s.instancedDataArray.float32,Y=0;l&&(Y=$[V+6]-s.instancesEvaluatedElevation[F]);let K=0|$[V+1];$[V]=(0|$[V])+S.r/1.05,$[V+1]=K+S.g/1.05,$[V+2]=R,$[V+3]=1/(y.z>10?this.tileToMeter:Oe(y,K)),$[V+4]=I[0],$[V+5]=I[1],$[V+6]=I[2]+Y,$[V+7]=D[0],$[V+8]=D[1],$[V+9]=D[2],$[V+10]=D[4],$[V+11]=D[5],$[V+12]=D[6],$[V+13]=D[8],$[V+14]=D[9],$[V+15]=D[10],s.instancesEvaluatedElevation[F]=I[2]}}}let hM,dM;pt(uw,"ModelBucket",{omit:["layers"]}),pt(uM,"PerModelAttributes"),pt(cM,"ModelFeature");let bh=64,yf={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function fM(r,e,n,s,l,f,p,y,x,b=!1){let I=n.zoom,S=n.project(s),D=We(s.lat,I),R=1/D;Se(r),hn(r,r,[S.x+p[0]*R,S.y+p[1]*R,p[2]]);let L=1,F=1,V=n.worldSize;if(b){if(n.projection.name==="mercator"){let z=0;n.elevation&&(z=n.elevation.getAtPointOrZero(new _e(S.x/V,S.y/V),0));let W=Or([],[S.x,S.y,z,1],n.projMatrix)[3]/n.cameraToCenterDistance;L=W,F=W*We(n.center.lat,I)}else if(n.projection.name==="globe"){let z=lw(r,n),W=[0,0,0,1];Or(W,W,Lt([],n.projMatrix,z));let J=W[3]/n.cameraToCenterDistance,te=zc(I),me=n.projection.pixelsPerMeter(s.lat,V)*We(s.lat,I),de=n.projection.pixelsPerMeter(n.center.lat,V)*We(n.center.lat,I);L=J/kt(me,Ve(n.center.lat),te),F=J*D/me,L*=de,F*=de}}else L=R;sn(r,r,[L,L,F]);let $=[...r],Y=e.orientation,K=[];if(sM(K,[Y[0]+l[0],Y[1]+l[1],Y[2]+l[2]],f),Lt(r,$,K),y&&n.elevation){let z=0,W=[];if(x&&n.elevation){z=function(te,me,de,ge,xe){let ke=me.elevation;if(!ke)return 0;let Xe=_n.projectAabbCorners(de,ge),He=he(1,xe.lat)*me.worldSize,Ze=function(Je,jt){let yt=[0,0,1],bt=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(let Ft of bt){let Gt=Je[Ft.corners[0]],$t=Je[Ft.corners[1]],tn=Je[Ft.corners[2]],Xt=[$t[0]-Gt[0],$t[1]-Gt[1],jt*($t[2]-Gt[2])],nn=er(Xt,Xt,[tn[0]-Gt[0],tn[1]-Gt[1],jt*(tn[2]-Gt[2])]);bi(nn,nn),Ft.dotProductWithUp=Bi(nn,yt)}return bt.sort((Ft,Gt)=>Ft.dotProductWithUp-Gt.dotProductWithUp),bt[0].corners}(Xe,He),Ye=Xe[Ze[0]],Ne=Xe[Ze[1]],qe=Xe[Ze[2]],Le=Xe[Ze[3]],Fe=ke.getAtPointOrZero(new _e(Ye[0]/me.worldSize,Ye[1]/me.worldSize),0),Qe=ke.getAtPointOrZero(new _e(Ne[0]/me.worldSize,Ne[1]/me.worldSize),0),tt=ke.getAtPointOrZero(new _e(qe[0]/me.worldSize,qe[1]/me.worldSize),0),Dt=ke.getAtPointOrZero(new _e(Le[0]/me.worldSize,Le[1]/me.worldSize),0),vt=(Fe+Dt)/2,ct=(Qe+tt)/2;return vt>ct?Qe<tt?Sv(te,Ne,Le,Ye,Qe,Dt,Fe,He):Sv(te,qe,Ye,Le,tt,Fe,Dt,He):Fe<Dt?Sv(te,Ye,Ne,qe,Fe,Qe,tt,He):Sv(te,Le,qe,Ne,Dt,tt,Qe,He),Math.max(vt,ct)}(W,n,e.aabb,r,s);let J=Lt([],ds([],W),K);Lt(r,$,J)}else z=n.elevation.getAtPointOrZero(new _e(S.x/V,S.y/V),0);z!==0&&(r[14]+=z)}}function hg(r,e,n=!1){r.uploaded||(r.gfxTexture=new ow(e,r.image,n?e.gl.R8:e.gl.RGBA8,{useMipmap:r.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),r.uploaded=!0,r.image=null)}function AF(r,e,n){r.indexBuffer=e.createIndexBuffer(r.indexArray,!1,!0),r.vertexBuffer=e.createVertexBuffer(r.vertexArray,EF.members,!1,!0),r.normalArray&&(r.normalBuffer=e.createVertexBuffer(r.normalArray,DF.members,!1,!0)),r.texcoordArray&&(r.texcoordBuffer=e.createVertexBuffer(r.texcoordArray,SF.members,!1,!0)),r.colorArray&&(r.colorBuffer=e.createVertexBuffer(r.colorArray,(r.colorArray.bytesPerElement===12?TF:IF).members,!1,!0)),r.featureArray&&(r.pbrBuffer=e.createVertexBuffer(r.featureArray,MF.members,!0)),r.segments=Di.simpleSegment(0,0,r.vertexArray.length,r.indexArray.length);let s=r.material;s.pbrMetallicRoughness.baseColorTexture&&hg(s.pbrMetallicRoughness.baseColorTexture,e),s.pbrMetallicRoughness.metallicRoughnessTexture&&hg(s.pbrMetallicRoughness.metallicRoughnessTexture,e),s.normalTexture&&hg(s.normalTexture,e),s.occlusionTexture&&hg(s.occlusionTexture,e,n),s.emissionTexture&&hg(s.emissionTexture,e)}function hw(r,e,n){if(r.meshes)for(let s of r.meshes)AF(s,e,n);if(r.children)for(let s of r.children)hw(s,e,n)}function Cv(r){if(r.meshes)for(let e of r.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(r.children)for(let e of r.children)Cv(e)}function dw(r){if(r.meshes)for(let n of r.meshes)n.vertexBuffer&&(n.vertexBuffer.destroy(),n.indexBuffer.destroy(),n.normalBuffer&&n.normalBuffer.destroy(),n.texcoordBuffer&&n.texcoordBuffer.destroy(),n.colorBuffer&&n.colorBuffer.destroy(),n.pbrBuffer&&n.pbrBuffer.destroy(),n.segments.destroy(),n.material&&((e=n.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(r.children)for(let n of r.children)dw(n)}class vf{constructor(e,n,s){this._demTile=e,this._dem=this._demTile.dem,this._scale=n,this._offset=s}static create(e,n,s){let l=s||e.findDEMTileFor(n);if(!l||!l.dem)return;let f=l.dem,p=l.tileID,y=1<<n.canonical.z-p.canonical.z;return new vf(l,f.dim/at/y,[(n.canonical.x/y-p.canonical.x)*f.dim,(n.canonical.y/y-p.canonical.y)*f.dim])}tileCoordToPixel(e,n){let s=n*this._scale+this._offset[1],l=Math.floor(e*this._scale+this._offset[0]),f=Math.floor(s);return new ot(l,f)}getElevationAt(e,n,s,l){let f=e*this._scale+this._offset[0],p=n*this._scale+this._offset[1],y=Math.floor(f),x=Math.floor(p),b=this._dem;return l=!!l,s?kt(kt(b.get(y,x,l),b.get(y,x+1,l),p-x),kt(b.get(y+1,x,l),b.get(y+1,x+1,l),p-x),f-y):b.get(y,x,l)}getElevationAtPixel(e,n,s){return this._dem.get(e,n,!!s)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*he(1,e)*this._dem.stride}}let fw=new Float32Array(262144),wh=new Uint8Array(262144);function pM(r){let e=0;if(r.meshes)for(let n of r.meshes)e=Math.max(e,n.aabb.max[2]);if(r.children)for(let n of r.children)e=Math.max(e,pM(n));return e}function mM(r,e,n){if(r.meshes)for(let s of r.meshes){if(s.aabb.min[0]===1/0)continue;let l=_n.applyTransform(s.aabb,r.matrix);n.insert(e,l.min[0],l.min[1],l.max[0],l.max[1])}if(r.children)for(let s of r.children)mM(s,e,n)}let gM=["","wall","door","roof","window","lamp","logo"];class _M{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:pM(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new _n([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0,n=new _n([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(let s of this.node.meshes)this.node.lightMeshIndex!==e&&(s.transformedAabb=_n.applyTransformFast(s.aabb,this.node.matrix),n.encapsulate(s.transformedAabb)),e++;this.aabb=n}return this.aabb}}class Mv{constructor(e,n,s,l,f,p,y,x){this.id=s,this.layers=e,this.layerIds=this.layers.map(b=>b.fqid),this.stateDependentLayerIds=this.layers.filter(b=>b.isStateDependent()).map(b=>b.id),this.modelTraits|=yf.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,l&&(this.modelTraits|=yf.HasMapboxMeshFeatures),f&&(this.modelTraits|=yf.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=p,this.worldview=x,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(let b of n)this.nodesInfo.push(new _M(b)),mM(b,y.featureIndexArray.length,y.grid),y.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,y.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(e,n){for(let s of this.getNodesInfo()){let l=s.node;l.footprint&&n.push({footprint:l.footprint,id:e})}}update(e){let n=Object.keys(e).length!==0;if(n&&!this.stateDependentLayers.length)return;let s=n?this.stateDependentLayers:this.layers;if(!Ls(e,this.states))for(let l of s)this.evaluate(l,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;let n=this.getNodesInfo();for(let s of n){let l=s.node;this.uploaded?this.updatePbrBuffer(l):hw(l,e,!0)}for(let s of n)Cv(s.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let n=!1;if(!e.meshes)return n;for(let s of e.meshes)s.pbrBuffer&&(s.pbrBuffer.updateData(s.featureArray),n=!0);return n}needsReEvaluation(e,n,s){let l=e.transform.projectionOptions,f=e.style.getBrightness(),p=this.brightness!==f;if(!this.uploaded||this.dirty||l.name!==this.projection.name||dg(s.paint.get("model-color").value,p)||dg(s.paint.get("model-color-mix-intensity").value,p)||dg(s.paint.get("model-roughness").value,p)||dg(s.paint.get("model-emissive-strength").value,p)||dg(s.paint.get("model-height-based-emissive-strength-multiplier").value,p)){this.projection=l,this.brightness=f;let y=this.getNodesInfo();for(let x of y)x.state=null;return!0}return!1}evaluateTransform(e,n){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;let s=this.getNodesInfo(),l=this.id.canonical;for(let f of s){let p=f.feature;f.evaluatedTranslation=n.paint.get("model-translation").evaluate(p,{},l),f.evaluatedScale=n.paint.get("model-scale").evaluate(p,{},l)}}evaluate(e,n){let s=this.getNodesInfo();for(let l of s){if(!l.node.meshes)continue;let f=l.feature,p=n&&n[f.id];if(Ls(p,l.state))continue;l.state=structuredClone(p);let y=l.node.meshes&&l.node.meshes[0].featureData,x=l.evaluatedColor[2],b=l.evaluatedRMEA[2],I=this.id.canonical;if(l.hasTranslucentParts=!1,y){for(let S=0;S<gM.length;S++){let D=gM[S];D.length&&(f.properties.part=D);let R=e.paint.get("model-color").evaluate(f,p,I).toPremultipliedRenderColor(null),L=e.paint.get("model-color-mix-intensity").evaluate(f,p,I);l.evaluatedColor[S]=[R.r,R.g,R.b,L],l.evaluatedRMEA[S][0]=e.paint.get("model-roughness").evaluate(f,p,I),l.evaluatedRMEA[S][2]=e.paint.get("model-emissive-strength").evaluate(f,p,I),l.evaluatedRMEA[S][3]=R.a,l.emissionHeightBasedParams[S]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(f,p,I),!l.hasTranslucentParts&&R.a<1&&(l.hasTranslucentParts=!0)}delete f.properties.part,PF(l,x!==l.evaluatedColor[2]||b!==l.evaluatedRMEA[2],this.modelTraits)}else l.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(f,p,I);l.evaluatedTranslation=e.paint.get("model-translation").evaluate(f,p,I),l.evaluatedScale=e.paint.get("model-scale").evaluate(f,p,I),this.updatePbrBuffer(l.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,n,s,l){let f=e.findDEMTileFor(s);if(f&&(f.tileID.canonical!==this.terrainTile||n!==this.terrainExaggeration)){if(f.dem&&f.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=f.tileID.overscaledZ;let p=vf.create(e,s,f);if(!p)return;this.modelTraits&yf.HasMapboxMeshFeatures&&this.updateDEM(e,p,s,l);for(let y of this.getNodesInfo()){let x=y.node;if(!x.footprint||!x.footprint.vertices||!x.footprint.vertices.length)continue;let b=x.footprint.vertices,I=p.getElevationAt(b[0].x,b[0].y,!0,!0);for(let S=1;S<b.length;S++)I=Math.min(I,p.getElevationAt(b[S].x,b[S].y,!0,!0));x.elevation=I}}this.terrainTile=f.tileID.canonical,this.terrainExaggeration=n}}updateDEM(e,n,s,l){let f=n._dem._modifiedForSources[l];if(f===void 0&&(n._dem._modifiedForSources[l]=[],f=n._dem._modifiedForSources[l]),f.includes(s.canonical))return;let p=n._dem.dim;f.push(s.canonical);let y=!1;for(let x of this.getNodesInfo()){let b=x.node;if(!b.footprint||!b.footprint.grid)continue;let I=b.footprint.grid,S=n.tileCoordToPixel(I.min.x,I.min.y),D=n.tileCoordToPixel(I.max.x,I.max.y),R=Math.min(Math.min(p-D.y,S.x),Math.min(S.y,p-D.x));if(R<0)continue;let L=ae(R,2,5),F=Math.max(0,S.x-L),V=Math.max(0,S.y-L),$=Math.min(D.x+L,p-1),Y=Math.min(D.y+L,p-1);for(let J=V;J<=Y;++J)for(let te=F;te<=$;++te)wh[J*p+te]=255;let K=0,z=0;for(let J=0;J<I.cellsY;++J)for(let te=0;te<I.cellsX;++te){if(!I.cells[J*I.cellsX+te])continue;let me=n.tileCoordToPixel(I.min.x+te/I.xScale,I.min.y+J/I.yScale),de=n.tileCoordToPixel(I.min.x+(te+1)/I.xScale,I.min.y+(J+1)/I.yScale);for(let ge=me.y;ge<=Math.min(de.y+1,p-1);++ge)for(let xe=me.x;xe<=Math.min(de.x+1,p-1);++xe)wh[ge*p+xe]===255&&(wh[ge*p+xe]=0,K+=n.getElevationAtPixel(xe,ge),z++)}let W=K/z;F=Math.max(1,S.x-L),V=Math.max(1,S.y-L),$=Math.min(D.x+L,p-2),Y=Math.min(D.y+L,p-2),y=!0;for(let J=V;J<=Y;++J)for(let te=F;te<=$;++te)wh[J*p+te]===0&&(fw[J*p+te]=n._dem.set(te,J,W));for(let J=1;J<L;++J){F=Math.max(1,S.x-J),V=Math.max(1,S.y-J),$=Math.min(D.x+J,p-2),Y=Math.min(D.y+J,p-2);for(let te=V;te<=Y;++te)for(let me=F;me<=$;++me){let de=te*p+me;if(wh[de]===255){let ge=0,xe=0,ke=-1,Xe=-1;for(let He=-1;He<=1;++He)for(let Ze=-1;Ze<=1;++Ze){let Ye=(te+He)*p+me+Ze;if(wh[Ye]>=J)continue;let Ne=fw[Ye],qe=Math.abs(Ne);qe>xe&&(ge=Ne,xe=qe,ke=Ze,Xe=He)}if(xe>.1){let He=1-(J+.5*Math.abs(ke*Xe))/L,Ze=n._dem.get(me,te)+ge*He,Ye=n._dem.get(me+ke,te+Xe),Ne=n._dem.get(me-ke,te-Xe,!0);(Ze-Ye)*(Ze-Ne)>0&&(Ze=(Ye+Ne)/2),fw[de]=n._dem.set(me,te,Ze),wh[de]=J}}}}}y&&(n._demTile.needsDEMTextureUpload=!0,n._dem._timestamp=Zo.now())}setFilter(e){this.filter=e?ym(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter(e=>this.filter.filter(new zn(this.id.overscaledZ,{worldview:this.worldview}),e.feature,this.id.canonical)):this.nodesInfo}destroy(){let e=this.getNodesInfo();for(let n of e)Cv(n.node),dw(n.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,n){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;let s=n.getReplacementRegionsForTile(e.toUnwrapped());for(let l of this.getNodesInfo()){let f=l.node.footprint;l.hiddenByReplacement=!!f&&!s.find(p=>p.footprint===f)}}getHeightAtTileCoord(e,n){let s=[],l=[0,0,0],f=Se([]);for(let p of this.getNodesInfo()){let y=p.node.meshes[0],x=y.transformedAabb;if(e<x.min[0]||n<x.min[1]||e>x.max[0]||n>x.max[1])continue;if(p.node.hidden===!0)return{height:1/0,maxHeight:p.feature.properties.height,hidden:!1,verticalScale:p.evaluatedScale[2]};It(f,p.node.matrix),l[0]=e,l[1]=n,ai(l,l,f);let b=(l[0]-y.aabb.min[0])/(y.aabb.max[0]-y.aabb.min[0])*bh|0,I=Math.min(63,(l[1]-y.aabb.min[1])/(y.aabb.max[1]-y.aabb.min[1])*bh|0)*bh+Math.min(63,b),S=y.heightmap[I];if(!(S<0&&p.node.footprint))return p.hiddenByReplacement?void 0:{height:S,maxHeight:p.feature.properties.height,hidden:!1,verticalScale:p.evaluatedScale[2]};if(p.node.footprint.grid.query(new ot(e,n),new ot(e,n),s),s.length>0)return{height:void 0,maxHeight:p.feature.properties.height,hidden:p.hiddenByReplacement,verticalScale:p.evaluatedScale[2]}}}}function dg(r,e){return r instanceof Xu&&!r.isLightConstant&&e}function RF(r,e,n,s,l,f,p,y){let x=(61440&e|(61440&e)>>4)>>8,b=(3840&e|(3840&e)>>4)>>4,I=240&e|(240&e)>>4;n[3]>0&&(x=kt(x,255*n[0],n[3]),b=kt(b,255*n[1],n[3]),I=kt(I,255*n[2],n[3]));let S=x<<8|b,D=I<<8|Math.floor(255*s[3]),R=function(J){let te=ae(J,0,2);return Math.min(Math.round(.5*te*255),255)}(s[2])<<8|15*s[0]<<4|15*s[1],L=ae(l[0],0,1),F=ae(l[1],0,1),V=ae(l[2],0,1),$=ae(l[3],0,1),Y,K,z,W;if(L!==F&&p!==f&&F!==L){let J=p-f;K=1/(J*(F-L)),z=-(f+J*L)/(J*(F-L));let te=ae(l[4],-1,1);W=Math.pow(10,te),Y=255*V<<8|255*$}else Y=65535,K=0,z=1,W=1;if(r.emplaceBack(S,D,R,Y,K,z,W),y){let J=y.length;y.clear();for(let te=0;te<J;te++)y.emplaceBack(S,D,R,Y,K,z,W)}}function PF(r,e,n){let s=r.node,l=0,f=n&yf.HasMeshoptCompression;for(let p of s.meshes){if(s.lights&&s.lightMeshIndex===l||!p.featureData)continue;p.featureArray=new ah,p.featureArray.reserve(p.featureData.length);let y=e;for(let x of p.featureData){let b=f?65535&x:x>>16&65535,I=f?x>>16&65535:65535&x,S=(15&I)<8?15&I:0,D=r.evaluatedRMEA[S],R=r.evaluatedColor[S],L=r.emissionHeightBasedParams[S],F;if(y&&S===2&&s.lights&&(F=new ah,F.resize(10*s.lights.length)),RF(p.featureArray,b,R,D,L,p.aabb.min[2],p.aabb.max[2],F),F&&y){y=!1;let V=s.meshes[s.lightMeshIndex];V.featureArray=F,V.featureArray._trim()}}p.featureArray._trim(),l++}}function yM(r,e,n,s){let l=1<<r.z;e.lat=Te((s/at+r.y)/l),e.lng=fe((n/at+r.x)/l)}function LF(r,e,n,s){let l=r.getNodesInfo()[e];if(!l||l.hiddenByReplacement||!l.node.meshes)return;let f=Number.MAX_VALUE,p=l.node,y=n.tile,x=s.calculatePosMatrix(y.tileID.toUnwrapped(),s.worldSize),b=l.evaluatedScale,I=0;s.elevation&&p.elevation&&(I=p.elevation*s.elevation.exaggeration()),hn(x,x,[(p.anchor?p.anchor[0]:0)*(b[0]-1),(p.anchor?p.anchor[1]:0)*(b[1]-1),I]),sn(x,x,b);let S=n.queryGeometry,D=S.isPointQuery()?S.screenBounds:S.screenGeometry,R=function(F){let V=Lt([],x,F.matrix);Lt(V,s.expandedFarZProjMatrix,V);for(let $=0;$<F.meshes.length;++$){let Y=F.meshes[$];if($===F.lightMeshIndex)continue;let K=aM(D,s,V,Y.aabb);K!=null&&(f=Math.min(K,f))}if(F.children)for(let $ of F.children)R($)};if(R(p),f===Number.MAX_VALUE)return;let L=new Z(0,0);return yM(y.tileID.canonical,L,l.node.anchor[0],l.node.anchor[1]),{intersectionZ:f,position:L,feature:l.feature}}pt(Mv,"Tiled3dModelBucket",{omit:["layers"]}),pt(_M,"Tiled3dModelFeature");let OF={circle:class extends Ir{constructor(r,e,n,s){super(r,{layout:gS||(gS=new Ei({"circle-sort-key":new ht(Ee.layout_circle["circle-sort-key"]),"circle-elevation-reference":new Ke(Ee.layout_circle["circle-elevation-reference"]),visibility:new Ke(Ee.layout_circle.visibility)})),paint:_S||(_S=new Ei({"circle-radius":new ht(Ee.paint_circle["circle-radius"]),"circle-color":new ht(Ee.paint_circle["circle-color"]),"circle-blur":new ht(Ee.paint_circle["circle-blur"]),"circle-opacity":new ht(Ee.paint_circle["circle-opacity"]),"circle-translate":new Ke(Ee.paint_circle["circle-translate"]),"circle-translate-anchor":new Ke(Ee.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Ke(Ee.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Ke(Ee.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new ht(Ee.paint_circle["circle-stroke-width"]),"circle-stroke-color":new ht(Ee.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new ht(Ee.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new Ke(Ee.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s)}createBucket(r){return new Bo(r)}queryRadius(r){let e=r;return af("circle-radius",this,e)+af("circle-stroke-width",this,e)+Vy(this.paint.get("circle-translate"))}queryIntersectsFeature(r,e,n,s,l,f,p,y){let x=mS(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),f.angle,r.pixelToTileUnitsFactor),b=this.paint.get("circle-radius").evaluate(e,n)+this.paint.get("circle-stroke-width").evaluate(e,n);return AS(r,s,f,p,y,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",x,b)}getProgramIds(){return["circle"]}getDefaultProgramParams(r,e,n){let s=MS(this);return{config:new kc(this,{zoom:e,lut:n}),defines:s,overrideFog:!1}}is3D(r){return!r&&!!this.layout&&this.layout.get("circle-elevation-reference")!=="none"}hasElevation(){return this.layout&&this.layout.get("circle-elevation-reference")!=="none"}},heatmap:class extends Ir{createBucket(r){return new PS(r)}constructor(r,e,n,s){super(r,{layout:LS||(LS=new Ei({visibility:new Ke(Ee.layout_heatmap.visibility)})),paint:OS||(OS=new Ei({"heatmap-radius":new ht(Ee.paint_heatmap["heatmap-radius"]),"heatmap-weight":new ht(Ee.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Ke(Ee.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Tl(Ee.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Ke(Ee.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(r){r==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Vm({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(r){return af("heatmap-radius",this,r)}queryIntersectsFeature(r,e,n,s,l,f,p,y){let x=this.paint.get("heatmap-radius").evaluate(e,n);return AS(r,s,f,p,y,!0,!0,new ot(0,0),x)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(r,e,n){return r==="heatmap"?{config:new kc(this,{zoom:e,lut:n}),overrideFog:!1}:{}}},hillshade:class extends Ir{constructor(r,e,n,s){super(r,{layout:kS||(kS=new Ei({visibility:new Ke(Ee.layout_hillshade.visibility)})),paint:FS||(FS=new Ei({"hillshade-illumination-direction":new Ke(Ee.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Ke(Ee.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Ke(Ee.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Ke(Ee.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Ke(Ee.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Ke(Ee.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new Ke(Ee.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(r,e,n){return{overrideFog:!1}}},fill:class extends Ir{constructor(r,e,n,s){super(r,{layout:KS||(KS=new Ei({"fill-sort-key":new ht(Ee.layout_fill["fill-sort-key"]),visibility:new Ke(Ee.layout_fill.visibility),"fill-elevation-reference":new Ke(Ee.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new ht(Ee.layout_fill["fill-construct-bridge-guard-rail"])})),paint:JS||(JS=new Ei({"fill-antialias":new Ke(Ee.paint_fill["fill-antialias"]),"fill-opacity":new ht(Ee.paint_fill["fill-opacity"]),"fill-color":new ht(Ee.paint_fill["fill-color"]),"fill-outline-color":new ht(Ee.paint_fill["fill-outline-color"]),"fill-translate":new Ke(Ee.paint_fill["fill-translate"]),"fill-translate-anchor":new Ke(Ee.paint_fill["fill-translate-anchor"]),"fill-pattern":new ht(Ee.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new Ke(Ee.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new Ke(Ee.paint_fill["fill-emissive-strength"]),"fill-z-offset":new ht(Ee.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new ht(Ee.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new ht(Ee.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s)}getProgramIds(){let r=this.paint.get("fill-pattern"),e=r&&r.constantOr(1),n=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&n.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),n}getDefaultProgramParams(r,e,n){return{config:new kc(this,{zoom:e,lut:n}),overrideFog:!1}}recalculate(r,e){super.recalculate(r,e);let n=this.paint._values["fill-outline-color"];n.value.kind==="constant"&&n.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(r){return new T1(r)}queryRadius(){return Vy(this.paint.get("fill-translate"))}queryIntersectsFeature(r,e,n,s,l,f){return!r.queryGeometry.isAboveHorizon&&ts(pS(r.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),f.angle,r.pixelToTileUnitsFactor),s)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(r){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;let e=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return r!=null?e&&!r:e}hasElevation(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}hasShadowPass(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}},"fill-extrusion":class extends Ir{constructor(r,e,n,s){super(r,{layout:ED||(ED=new Ei({visibility:new Ke(Ee["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new Ke(Ee["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:TD||(TD=new Ei({"fill-extrusion-opacity":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new ht(Ee["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new ht(Ee["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new ht(Ee["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new ht(Ee["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new ht(Ee["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new ht(Ee["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new ht(Ee["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new ht(Ee["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new Qy(r)}queryRadius(){return Vy(this.paint.get("fill-extrusion-translate"))}is3D(r){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(r,e,n,s,l,f,p,y,x){let b=mS(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),f.angle,r.pixelToTileUnitsFactor),I=this.paint.get("fill-extrusion-height").evaluate(e,n),S=this.paint.get("fill-extrusion-base").evaluate(e,n),D=[0,0],R=y&&f.elevation,L=f.elevation?f.elevation.exaggeration():1,F=r.tile.getBucket(this);if(R&&F instanceof Qy){let z=F.centroidVertexArray,W=x+1;W<z.length&&(D[0]=z.geta_centroid_pos0(W),D[1]=z.geta_centroid_pos1(W))}if(D[0]===0&&D[1]===1)return!1;f.projection.name==="globe"&&(s=wD([s],[new ot(0,0),new ot(at,at)],r.tileID.canonical).map(z=>z.polygon).flat());let V=R?y:null,[$,Y]=function(z,W,J,te,me,de,ge,xe,ke,Xe,He){return z.projection.name==="globe"?function(Ze,Ye,Ne,qe,Le,Fe,Qe,tt,Dt,vt,ct){let Je=[],jt=[],yt=Ze.projection.upVectorScale(ct,Ze.center.lat,Ze.worldSize).metersToTile,bt=[0,0,0,1],Ft=[0,0,0,1],Gt=(tn,Xt,nn,Cn)=>{tn[0]=Xt,tn[1]=nn,tn[2]=Cn,tn[3]=1},$t=bD();Ne>0&&(Ne+=$t),qe+=$t;for(let tn of Ye){let Xt=[],nn=[];for(let Cn of tn){let Qn=Cn.x+Le.x,Q=Cn.y+Le.y,ne=Ze.projection.projectTilePoint(Qn,Q,ct),ze=Ze.projection.upVector(ct,Cn.x,Cn.y),it=Ne,ut=qe;if(Qe){let lt=AD(Qn,Q,Ne,qe,Qe,tt,Dt,vt);it+=lt.base,ut+=lt.top}Ne!==0?Gt(bt,ne.x+ze[0]*yt*it,ne.y+ze[1]*yt*it,ne.z+ze[2]*yt*it):Gt(bt,ne.x,ne.y,ne.z),Gt(Ft,ne.x+ze[0]*yt*ut,ne.y+ze[1]*yt*ut,ne.z+ze[2]*yt*ut),ai(bt,bt,Fe),ai(Ft,Ft,Fe),Xt.push(new yh(bt[0],bt[1],bt[2])),nn.push(new yh(Ft[0],Ft[1],Ft[2]))}Je.push(Xt),jt.push(nn)}return[Je,jt]}(z,W,J,te,me,de,ge,xe,ke,Xe,He):ge?function(Ze,Ye,Ne,qe,Le,Fe,Qe,tt,Dt){let vt=[],ct=[],Je=[0,0,0,1];for(let jt of Ze){let yt=[],bt=[];for(let Ft of jt){let Gt=Ft.x+qe.x,$t=Ft.y+qe.y,tn=AD(Gt,$t,Ye,Ne,Fe,Qe,tt,Dt);Je[0]=Gt,Je[1]=$t,Je[2]=tn.base,Je[3]=1,Or(Je,Je,Le),Je[3]=Math.max(Je[3],1e-5);let Xt=new yh(Je[0]/Je[3],Je[1]/Je[3],Je[2]/Je[3]);Je[0]=Gt,Je[1]=$t,Je[2]=tn.top,Je[3]=1,Or(Je,Je,Le),Je[3]=Math.max(Je[3],1e-5);let nn=new yh(Je[0]/Je[3],Je[1]/Je[3],Je[2]/Je[3]);yt.push(Xt),bt.push(nn)}vt.push(yt),ct.push(bt)}return[vt,ct]}(W,J,te,me,de,ge,xe,ke,Xe):function(Ze,Ye,Ne,qe,Le){let Fe=[],Qe=[],tt=Le[8]*Ye,Dt=Le[9]*Ye,vt=Le[10]*Ye,ct=Le[11]*Ye,Je=Le[8]*Ne,jt=Le[9]*Ne,yt=Le[10]*Ne,bt=Le[11]*Ne;for(let Ft of Ze){let Gt=[],$t=[];for(let tn of Ft){let Xt=tn.x+qe.x,nn=tn.y+qe.y,Cn=Le[0]*Xt+Le[4]*nn+Le[12],Qn=Le[1]*Xt+Le[5]*nn+Le[13],Q=Le[2]*Xt+Le[6]*nn+Le[14],ne=Le[3]*Xt+Le[7]*nn+Le[15],ze=Cn+tt,it=Qn+Dt,ut=Q+vt,lt=Math.max(ne+ct,1e-5),_t=Cn+Je,Ot=Qn+jt,an=Q+yt,ln=Math.max(ne+bt,1e-5);Gt.push(new yh(ze/lt,it/lt,ut/lt)),$t.push(new yh(_t/ln,Ot/ln,an/ln))}Fe.push(Gt),Qe.push($t)}return[Fe,Qe]}(W,J,te,me,de)}(f,s,S,I,b,p,V,D,L,f.center.lat,r.tileID.canonical),K=r.queryGeometry;return function(z,W,J){let te=1/0;ts(J,W)&&(te=MD(J,W[0]));for(let me=0;me<W.length;me++){let de=W[me],ge=z[me];for(let xe=0;xe<de.length-1;xe++){let ke=de[xe],Xe=[ke,de[xe+1],ge[xe+1],ge[xe],ke];Jr(J,Xe)&&(te=Math.min(te,MD(J,Xe)))}}return te!==1/0&&te}($,Y,K.isPointQuery()?K.screenBounds:K.screenGeometry)}},building:class extends Ir{constructor(r,e,n,s){super(r,{layout:UD||(UD=new Ei({visibility:new Ke(Ee.layout_building.visibility),"building-roof-shape":new ht(Ee.layout_building["building-roof-shape"]),"building-height":new ht(Ee.layout_building["building-height"]),"building-base":new ht(Ee.layout_building["building-base"])})),paint:HD||(HD=new Ei({"building-opacity":new Ke(Ee.paint_building["building-opacity"]),"building-ambient-occlusion-wall-intensity":new Ke(Ee.paint_building["building-ambient-occlusion-wall-intensity"]),"building-ambient-occlusion-ground-intensity":new Ke(Ee.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new Ke(Ee.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new Ke(Ee.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new Ke(Ee.paint_building["building-vertical-scale"]),"building-cast-shadows":new Ke(Ee.paint_building["building-cast-shadows"]),"building-color":new ht(Ee.paint_building["building-color"]),"building-emissive-strength":new ht(Ee.paint_building["building-emissive-strength"]),"building-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new jD(r)}},line:class extends Ir{constructor(r,e,n,s){let l=QD();super(r,l,e,n,s),l.layout&&(this.layout=new El(l.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(r){if(r==="line-gradient"){let e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof Uu,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(r,e){super.recalculate(r,e),this.paint._values["line-floorwidth"]=(()=>{if(eg)return eg;let n=QD();return eg=new Rk(n.paint.properties["line-width"].specification),eg.useIntegerZoom=!0,eg})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,r)}createBucket(r){return new N1(r)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(r,e,n){let s=KD(this);return{config:new kc(this,{zoom:e,lut:n}),defines:s,overrideFog:!1}}queryRadius(r){let e=r,n=eC(af("line-width",this,e),af("line-gap-width",this,e)),s=af("line-offset",this,e);return n/2+Math.abs(s)+Vy(this.paint.get("line-translate"))}queryIntersectsFeature(r,e,n,s,l,f){if(r.queryGeometry.isAboveHorizon)return!1;let p=pS(r.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),f.angle,r.pixelToTileUnitsFactor),y=r.pixelToTileUnitsFactor/2*eC(this.paint.get("line-width").evaluate(e,n),this.paint.get("line-gap-width").evaluate(e,n)),x=this.paint.get("line-offset").evaluate(e,n);return x&&(s=function(b,I){let S=[],D=new ot(0,0);for(let R=0;R<b.length;R++){let L=b[R],F=[];for(let V=0;V<L.length;V++){let $=L[V],Y=L[V+1],K=V===0?D:$.sub(L[V-1])._unit()._perp(),z=V===L.length-1?D:Y.sub($)._unit()._perp(),W=K._add(z)._unit();W._mult(1/(W.x*z.x+W.y*z.y)),F.push(W._mult(I)._add($))}S.push(F)}return S}(s,x*r.pixelToTileUnitsFactor)),function(b,I,S){for(let D=0;D<I.length;D++){let R=I[D];if(b.length>=3){for(let L=0;L<R.length;L++)if(vs(b,R[L]))return!0}if(Oa(b,R,S))return!0}return!1}(p,s,y)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(r){return!this.hasElevatedBuckets}hasElevation(){return this.layout&&this.layout.get("line-elevation-reference")!=="none"}},symbol:bv,background:class extends Ir{constructor(r,e,n,s){super(r,{layout:$C||($C=new Ei({visibility:new Ke(Ee.layout_background.visibility)})),paint:GC||(GC=new Ei({"background-pitch-alignment":new Ke(Ee.paint_background["background-pitch-alignment"]),"background-color":new Ke(Ee.paint_background["background-color"]),"background-pattern":new Ke(Ee.paint_background["background-pattern"]),"background-opacity":new Ke(Ee.paint_background["background-opacity"]),"background-emissive-strength":new Ke(Ee.paint_background["background-emissive-strength"]),"background-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(r,e,n){return{overrideFog:!1}}is3D(r){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:YC,"raster-particle":nM,sky:class extends Ir{constructor(r,e,n,s){super(r,{layout:QC||(QC=new Ei({visibility:new Ke(Ee.layout_sky.visibility)})),paint:eM||(eM=new Ei({"sky-type":new Ke(Ee.paint_sky["sky-type"]),"sky-atmosphere-sun":new Ke(Ee.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Ke(Ee.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Ke(Ee.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Ke(Ee.paint_sky["sky-gradient-radius"]),"sky-gradient":new Tl(Ee.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Ke(Ee.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Ke(Ee.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Ke(Ee.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(r){r==="sky-gradient"?this._updateColorRamp():r!=="sky-atmosphere-sun"&&r!=="sky-atmosphere-halo-color"&&r!=="sky-atmosphere-color"&&r!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Vm({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(r){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){let e=r.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(r,e){if(this.paint.get("sky-type")==="atmosphere"){let s=this.paint.get("sky-atmosphere-sun"),l=!s,f=r.style.light,p=f.properties.get("position");return l&&f.properties.get("anchor")==="viewport"&&qt("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),l?sw(p.azimuthal,90-p.polar,e):sw(s[0],90-s[1],e)}let n=this.paint.get("sky-gradient-center");return sw(n[0],90-n[1],e)}isSky(){return!0}markSkyboxValid(r){this._skyboxInvalidated=!1,this._lightPosition=r.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){let r=this.paint.get("sky-type");return r==="atmosphere"?["skyboxCapture","skybox"]:r==="gradient"?["skyboxGradient"]:null}},slot:class extends Ir{constructor(r,e,n,s){super(r,{paint:tM||(tM=new Ei({}))},e,null)}},model:class extends Ir{constructor(r,e,n,s){super(r,{layout:hM||(hM=new Ei({visibility:new Ke(Ee.layout_model.visibility),"model-id":new ht(Ee.layout_model["model-id"])})),paint:dM||(dM=new Ei({"model-opacity":new ht(Ee.paint_model["model-opacity"]),"model-rotation":new ht(Ee.paint_model["model-rotation"]),"model-scale":new ht(Ee.paint_model["model-scale"]),"model-translation":new ht(Ee.paint_model["model-translation"]),"model-color":new ht(Ee.paint_model["model-color"]),"model-color-mix-intensity":new ht(Ee.paint_model["model-color-mix-intensity"]),"model-type":new Ke(Ee.paint_model["model-type"]),"model-cast-shadows":new Ke(Ee.paint_model["model-cast-shadows"]),"model-receive-shadows":new Ke(Ee.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new Ke(Ee.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new ht(Ee.paint_model["model-emissive-strength"]),"model-roughness":new ht(Ee.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new ht(Ee.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new Ke(Ee.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new Ke(Ee.paint_model["model-front-cutoff"]),"model-color-use-theme":new ht({type:"string",default:"default","property-type":"data-driven"})}))},e,n,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new uw(r)}getProgramIds(){return["model"]}is3D(r){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(r){return r instanceof Mv?at-1:0}queryIntersectsFeature(r,e,n,s,l,f){if(!this.modelManager)return!1;let p=this.modelManager,y=r.tile.getBucket(this);if(!(y&&y instanceof uw))return!1;for(let x in y.instancesPerModel){let b=y.instancesPerModel[x],I=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(b.idToFeaturesIndex.hasOwnProperty(I)){let S=b.features[b.idToFeaturesIndex[I]],D=p.getModel(x,this.scope);if(!D)return!1;let R=st(),L=new Z(0,0),F=y.canonical,V=Number.MAX_VALUE;for(let $=0;$<S.instancedDataCount;++$){let Y=16*(S.instancedDataOffset+$),K=b.instancedDataArray.float32,z=[K[Y+4],K[Y+5],K[Y+6]];yM(F,L,K[Y],0|K[Y+1]),fM(R,D,f,L,S.rotation,S.scale,z,!1,!1,!1),f.projection.name==="globe"&&(R=lw(R,f));let W=Lt([],f.projMatrix,R),J=r.queryGeometry,te=aM(J.isPointQuery()?J.screenBounds:J.screenGeometry,f,W,D.aabb);te!=null&&(V=Math.min(te,V))}return V!==Number.MAX_VALUE&&V}}return!1}_handleOverridablePaintPropertyUpdate(r,e,n){return!(!this.layout||e.isDataDriven()||n.isDataDriven()||r!=="model-color"&&r!=="model-color-mix-intensity"&&r!=="model-rotation"&&r!=="model-scale"&&r!=="model-translation"&&r!=="model-emissive-strength")}_isPropertyZoomDependent(r){let e=this._transitionablePaint._values[r];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof Yu}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends Ir{constructor(r,e,n,s){super(r,{layout:QS||(QS=new Ei({"clip-layer-types":new Ke(Ee.layout_clip["clip-layer-types"]),"clip-layer-scope":new Ke(Ee.layout_clip["clip-layer-scope"])})),paint:eD||(eD=new Ei({}))},e,n,s)}recalculate(r,e){super.recalculate(r,e)}createBucket(r){return new tD(r)}is3D(r){return!0}}},pw=new In(0,0,0),mw={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},gw={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},Av={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},kF={PAINT_ORDER_FILL_AND_STROKE:1},fg={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},vM={MASK_TYPE_LUMINANCE:1};function FF(r,e,n){r===1&&e.icons.push(function(s,l){return function(f){if(f.usvg_tree.height||(f.usvg_tree.height=f.usvg_tree.width),!f.metadata)return f;let{metadata:p}=f;if(p.content_area){let{content_area:y}=p;y.top==null&&(y.top=y.left),y.width==null&&(y.width=f.usvg_tree.width),y.height==null&&(y.height=y.width)}return p.stretch_x&&p.stretch_x.length&&xM(p,"x"),p.stretch_y&&p.stretch_y.length&&xM(p,"y"),f}(s.readFields(NF,{name:void 0},l))}(n,n.readVarint()+n.pos))}function xM(r,e){let n=[],s=r[`stretch_${e}`],l=null;for(let f=0;f<s.length;f++)l===null?l=n.length===0?s[0]:n[n.length-1][1]+s[f]:(n.push([l,l+s[f]]),l=null);r[`stretch_${e}_areas`]=n}function NF(r,e,n){r===1?e.name=n.readString():r===2?e.metadata=function(s,l){return s.readFields(zF,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},l)}(n,n.readVarint()+n.pos):r===3&&(e.usvg_tree=function(s,l){return s.readFields(jF,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},l)}(n,n.readVarint()+n.pos),e.data="usvg_tree")}function zF(r,e,n){r===1?e.stretch_x=n.readPackedVarint():r===2?e.stretch_y=n.readPackedVarint():r===3?e.content_area=function(s,l){return s.readFields(BF,{left:0},l)}(n,n.readVarint()+n.pos):r===4&&e.variables.push(function(s,l){return s.readFields(VF,{name:void 0},l)}(n,n.readVarint()+n.pos))}function BF(r,e,n){r===1?e.left=n.readVarint():r===2?e.width=n.readVarint():r===3?e.top=n.readVarint():r===4&&(e.height=n.readVarint())}function VF(r,e,n){r===1?e.name=n.readString():r===2&&(e.rgb_color=Lv(n.readVarint()),e.value="rgb_color")}function jF(r,e,n){r===1?e.width=e.height=n.readVarint():r===2?e.height=n.readVarint():r===3?e.children.push(Rv(n,n.readVarint()+n.pos)):r===4?e.linear_gradients.push(function(s,l){return s.readFields(ZF,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},l)}(n,n.readVarint()+n.pos)):r===5?e.radial_gradients.push(function(s,l){return s.readFields(YF,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},l)}(n,n.readVarint()+n.pos)):r===7?e.clip_paths.push(function(s,l){return s.readFields(KF,{children:[]},l)}(n,n.readVarint()+n.pos)):r===8&&e.masks.push(function(s,l){let f=s.readFields(JF,{left:0,width:20,mask_type:vM.MASK_TYPE_LUMINANCE,children:[]},l);return f.height==null&&(f.height=f.width),f.top==null&&(f.top=f.left),f}(n,n.readVarint()+n.pos))}function Rv(r,e){return r.readFields(UF,{},e)}function UF(r,e,n){r===1?(e.group=function(s,l){return s.readFields(HF,{opacity:255,children:[]},l)}(n,n.readVarint()+n.pos),e.node="group"):r===2&&(e.path=function(s,l){return s.readFields(GF,{paint_order:1,commands:[],step:1,diffs:[],rule:mw.PATH_RULE_NON_ZERO},l)}(n,n.readVarint()+n.pos),e.node="path")}function HF(r,e,n){r===1?e.transform=Pv(n,n.readVarint()+n.pos):r===2?e.opacity=n.readVarint():r===5?e.clip_path_idx=n.readVarint():r===6?e.mask_idx=n.readVarint():r===7&&e.children.push(Rv(n,n.readVarint()+n.pos))}function Pv(r,e){return r.readFields($F,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function $F(r,e,n){r===1?e.sx=n.readFloat():r===2?e.ky=n.readFloat():r===3?e.kx=n.readFloat():r===4?e.sy=n.readFloat():r===5?e.tx=n.readFloat():r===6&&(e.ty=n.readFloat())}function GF(r,e,n){r===1?e.fill=function(s,l){return s.readFields(qF,{rgb_color:pw,paint:"rgb_color",opacity:255},l)}(n,n.readVarint()+n.pos):r===2?e.stroke=function(s,l){return s.readFields(WF,{rgb_color:pw,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},l)}(n,n.readVarint()+n.pos):r===3?e.paint_order=n.readVarint():r===5?n.readPackedVarint(e.commands):r===6?e.step=n.readFloat():r===7?n.readPackedSVarint(e.diffs):r===8&&(e.rule=n.readVarint())}function qF(r,e,n){r===1?(e.rgb_color=Lv(n.readVarint()),e.paint="rgb_color"):r===2?(e.linear_gradient_idx=n.readVarint(),e.paint="linear_gradient_idx"):r===3?(e.radial_gradient_idx=n.readVarint(),e.paint="radial_gradient_idx"):r===5&&(e.opacity=n.readVarint())}function Lv(r){return new In((r>>16&255)/255,(r>>8&255)/255,(255&r)/255,1)}function WF(r,e,n){r===1?(e.rgb_color=Lv(n.readVarint()),e.paint="rgb_color"):r===2?(e.linear_gradient_idx=n.readVarint(),e.paint="linear_gradient_idx"):r===3?(e.radial_gradient_idx=n.readVarint(),e.paint="radial_gradient_idx"):r===5?n.readPackedFloat(e.dasharray):r===6?e.dashoffset=n.readFloat():r===7?e.miterlimit=n.readFloat():r===8?e.opacity=n.readVarint():r===9?e.width=n.readFloat():r===10?e.linecap=n.readVarint():r===11&&(e.linejoin=n.readVarint())}function ZF(r,e,n){r===1?e.transform=Pv(n,n.readVarint()+n.pos):r===2?e.spread_method=n.readVarint():r===3?e.stops.push(bM(n,n.readVarint()+n.pos)):r===4?e.x1=n.readFloat():r===5?e.y1=n.readFloat():r===6?e.x2=n.readFloat():r===7&&(e.y2=n.readFloat())}function bM(r,e){return r.readFields(XF,{offset:0,opacity:255,rgb_color:pw},e)}function XF(r,e,n){r===1?e.offset=n.readFloat():r===2?e.opacity=n.readVarint():r===3&&(e.rgb_color=Lv(n.readVarint()))}function YF(r,e,n){r===1?e.transform=Pv(n,n.readVarint()+n.pos):r===2?e.spread_method=n.readVarint():r===3?e.stops.push(bM(n,n.readVarint()+n.pos)):r===4?e.cx=n.readFloat():r===5?e.cy=n.readFloat():r===6?e.r=n.readFloat():r===7?e.fx=n.readFloat():r===8?e.fy=n.readFloat():r===9&&(e.fr=n.readFloat())}function KF(r,e,n){r===1?e.transform=Pv(n,n.readVarint()+n.pos):r===2?e.clip_path_idx=n.readVarint():r===3&&e.children.push(Rv(n,n.readVarint()+n.pos))}function JF(r,e,n){r===1?e.left=e.top=n.readFloat():r===2?e.width=e.height=n.readFloat():r===3?e.top=n.readFloat():r===4?e.height=n.readFloat():r===5?e.mask_type=n.readVarint():r===6?e.mask_idx=n.readVarint():r===7&&e.children.push(Rv(n,n.readVarint()+n.pos))}class QF{static calculate(e={},n=[]){let s=new Map,l=new Map;if(Object.keys(e).length===0)return s;n.forEach(f=>{l.set(f.name,f.rgb_color||new In(0,0,0))});for(let[f,p]of Object.entries(e))l.has(f)?s.set(l.get(f).toString(),p):console.warn(`Ignoring unknown image variable "${f}"`);return s}}function xf(r,e=255,n){let s=e/255,l=r.toString(),f=n.has(l)?n.get(l).clone():r.clone();return f.a*=s,f.toString()}function pg(r,e){if(!ld()){let n=document.createElement("canvas");return n.width=r,n.height=e,n}return new OffscreenCanvas(r,e)}function eN(r,e){let n=QF.calculate(e.params,r.metadata?r.metadata.variables:[]),s=r.usvg_tree,l=s.width,f=s.height,p=e.transform?e.transform:new DOMMatrix,y=Math.max(1,Math.round(l*p.a)),x=Math.max(1,Math.round(f*p.d)),b=new DOMMatrix([y/l,0,0,x/f,0,0]),I=pg(y,x).getContext("2d");return _w(I,b,s,s,n),I.getImageData(0,0,y,x)}function _w(r,e,n,s,l){for(let f of s.children)wM(r,e,n,f,l)}function wM(r,e,n,s,l){s.group?(r.save(),function(f,p,y,x,b){let I=x.mask_idx!=null?y.masks[x.mask_idx]:null,S=x.clip_path_idx!=null?y.clip_paths[x.clip_path_idx]:null;if(x.transform&&(p=bf(x.transform).preMultiplySelf(p)),!function(L,F,V){return L.opacity!==255||F||V}(x,S!=null,I!=null))return void _w(f,p,y,x,b);let D=pg(f.canvas.width,f.canvas.height),R=D.getContext("2d");_w(R,p,y,x,b),S&&MM(R,p,y,S),I&&AM(R,p,y,I,b),f.globalAlpha=x.opacity/255,f.drawImage(D,0,0)}(r,e,n,s.group,l),r.restore()):s.path&&(r.save(),function(f,p,y,x,b){f.setTransform(p),x.paint_order===kF.PAINT_ORDER_FILL_AND_STROKE?(EM(f,y,x,b),IM(f,y,x,b)):(IM(f,y,x,b),EM(f,y,x,b))}(r,e,n,s.path,l),r.restore())}function EM(r,e,n,s){let l=n.fill;if(!l)return;let f=l.opacity/255;switch(r.save(),r.beginPath(),RM(n,r),l.paint){case"rgb_color":r.fillStyle=xf(l.rgb_color,l.opacity,s);break;case"linear_gradient_idx":{let p=e.linear_gradients[l.linear_gradient_idx];p.transform&&r.setTransform(bf(p.transform).preMultiplySelf(r.getTransform())),r.fillStyle=SM(r,p,f,s);break}case"radial_gradient_idx":{let p=e.radial_gradients[l.radial_gradient_idx];p.transform&&r.setTransform(bf(p.transform).preMultiplySelf(r.getTransform())),r.fillStyle=DM(r,p,f,s)}}r.fill(TM(n)),r.restore()}function TM(r){return r.rule===mw.PATH_RULE_NON_ZERO?"nonzero":r.rule===mw.PATH_RULE_EVEN_ODD?"evenodd":void 0}function IM(r,e,n,s){let l=n.stroke;if(!l)return;let f=PM(n);r.lineWidth=l.width,r.miterLimit=l.miterlimit,r.setLineDash(l.dasharray),r.lineDashOffset=l.dashoffset;let p=l.opacity/255;switch(l.paint){case"rgb_color":r.strokeStyle=xf(l.rgb_color,l.opacity,s);break;case"linear_gradient_idx":r.strokeStyle=SM(r,e.linear_gradients[l.linear_gradient_idx],p,s,!0);break;case"radial_gradient_idx":r.strokeStyle=DM(r,e.radial_gradients[l.radial_gradient_idx],p,s,!0)}switch(l.linejoin){case Av.LINE_JOIN_MITER_CLIP:case Av.LINE_JOIN_MITER:r.lineJoin="miter";break;case Av.LINE_JOIN_ROUND:r.lineJoin="round";break;case Av.LINE_JOIN_BEVEL:r.lineJoin="bevel"}switch(l.linecap){case gw.LINE_CAP_BUTT:r.lineCap="butt";break;case gw.LINE_CAP_ROUND:r.lineCap="round";break;case gw.LINE_CAP_SQUARE:r.lineCap="square"}r.stroke(f)}function SM(r,e,n,s,l=!1){if(e.stops.length===1){let D=e.stops[0];return xf(D.rgb_color,D.opacity*n,s)}let{x1:f,y1:p,x2:y,y2:x}=e,b=new DOMPoint(f,p),I=new DOMPoint(y,x);if(l){let D=bf(e.transform);b=D.transformPoint(b),I=D.transformPoint(I)}let S=r.createLinearGradient(b.x,b.y,I.x,I.y);for(let D of e.stops)S.addColorStop(D.offset,xf(D.rgb_color,D.opacity*n,s));return S}function DM(r,e,n,s,l=!1){if(e.stops.length===1){let $=e.stops[0];return xf($.rgb_color,$.opacity*n,s)}let f=bf(e.transform),{fx:p,fy:y,fr:x,cx:b,cy:I,r:S}=e,D=new DOMPoint(p,y),R=new DOMPoint(b,I),L=x,F=S;if(l){D=f.transformPoint(D),R=f.transformPoint(R);let $=(f.a+f.d)/2;L=x*$,F=e.r*$}let V=r.createRadialGradient(D.x,D.y,L,R.x,R.y,F);for(let $ of e.stops)V.addColorStop($.offset,xf($.rgb_color,$.opacity*n,s));return V}function CM(r,e,n,s){let l=s.transform?bf(s.transform).preMultiplySelf(e):e,f=pg(r.canvas.width,r.canvas.height),p=f.getContext("2d");for(let x of s.children)if(x.group)CM(p,l,n,x.group);else if(x.path){let b=x.path,I=new Path2D;I.addPath(PM(b),l),p.fill(I,TM(b))}let y=s.clip_path_idx!=null?n.clip_paths[s.clip_path_idx]:null;y&&MM(p,l,n,y),r.globalCompositeOperation="source-over",r.drawImage(f,0,0)}function MM(r,e,n,s){let l=pg(r.canvas.width,r.canvas.height);CM(l.getContext("2d"),e,n,s),r.globalCompositeOperation="destination-in",r.drawImage(l,0,0)}function AM(r,e,n,s,l){if(s.children.length===0)return;let f=s.mask_idx!=null?n.masks[s.mask_idx]:null;f&&AM(r,e,n,f,l);let p=r.canvas.width,y=r.canvas.height,x=pg(p,y),b=x.getContext("2d"),I=s.width,S=s.height,D=s.left,R=s.top,L=new Path2D,F=new Path2D;F.rect(D,R,I,S),L.addPath(F,e),b.clip(L);for(let Y of s.children)wM(b,e,n,Y,l);let V=b.getImageData(0,0,p,y),$=V.data;if(s.mask_type===vM.MASK_TYPE_LUMINANCE)for(let Y=0;Y<$.length;Y+=4)$[Y+3]=$[Y+3]/255*(.2126*$[Y]+.7152*$[Y+1]+.0722*$[Y+2]);b.putImageData(V,0,0),r.globalCompositeOperation="destination-in",r.drawImage(x,0,0)}function bf(r){return r?new DOMMatrix([r.sx,r.ky,r.kx,r.sy,r.tx,r.ty]):new DOMMatrix}function RM(r,e){let n=r.step,s=r.diffs[0]*n,l=r.diffs[1]*n;e.moveTo(s,l);for(let f=0,p=2;f<r.commands.length;f++)switch(r.commands[f]){case fg.PATH_COMMAND_MOVE:s+=r.diffs[p++]*n,l+=r.diffs[p++]*n,e.moveTo(s,l);break;case fg.PATH_COMMAND_LINE:s+=r.diffs[p++]*n,l+=r.diffs[p++]*n,e.lineTo(s,l);break;case fg.PATH_COMMAND_QUAD:{let y=s+r.diffs[p++]*n,x=l+r.diffs[p++]*n;s=y+r.diffs[p++]*n,l=x+r.diffs[p++]*n,e.quadraticCurveTo(y,x,s,l);break}case fg.PATH_COMMAND_CUBIC:{let y=s+r.diffs[p++]*n,x=l+r.diffs[p++]*n,b=y+r.diffs[p++]*n,I=x+r.diffs[p++]*n;s=b+r.diffs[p++]*n,l=I+r.diffs[p++]*n,e.bezierCurveTo(y,x,b,I,s,l);break}case fg.PATH_COMMAND_CLOSE:e.closePath()}return e}function PM(r){return RM(r,new Path2D)}class Ov{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;let n=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,n),n}put(e,n){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,n)}delete(e){this.cache.delete(e)}}pt(Ov,"LRUCache");class yw{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new pr(e,e.data)}getFromCache(e,n,s){return this.cacheMap.has(s)||this.cacheMap.set(s,new Ov(150)),this.cacheMap.get(s).get(Il(e.toString(),n))}setInCache(e,n,s,l){this.cacheDependenciesMap.has(l)||this.cacheDependenciesMap.set(l,new Map),this.cacheMap.has(l)||this.cacheMap.set(l,new Ov(150));let f=this.cacheDependenciesMap.get(l),p=Il(e.id.toString(),s);f.get(p)||f.set(p,new Set);let y=this.cacheMap.get(l),x=e.toString();f.get(p).add(x),y.put(Il(e.toString(),s),n)}removeImagesFromCacheByIds(e,n,s=0){if(!this.cacheMap.has(s)||!this.cacheDependenciesMap.has(s))return;let l=this.cacheMap.get(s),f=this.cacheDependenciesMap.get(s);for(let p of e){let y=Il(p.toString(),n);if(f.has(y)){for(let x of f.get(y))l.delete(x);f.delete(y)}}}rasterize(e,n,s,l,f=eN){let p=this.getFromCache(e,s,l);if(p)return p.clone();let y=f(n.icon,e.options),x=yw._getImage(y);return this.setInCache(e,x,s,l),x.clone()}}class LM{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,n){let s=this.toIdx(e,n);return{min:this.minimums[s],max:this.maximums[s]}}isLeaf(e,n){return this.leaves[this.toIdx(e,n)]}toIdx(e,n){return n*this.size+e}}function OM(r,e,n,s){let l=0,f=Number.MAX_VALUE;for(let p=0;p<3;p++)if(Math.abs(s[p])<1e-15){if(n[p]<r[p]||n[p]>e[p])return null}else{let y=1/s[p],x=(r[p]-n[p])*y,b=(e[p]-n[p])*y;if(x>b){let I=x;x=b,b=I}if(x>l&&(l=x),b<f&&(f=b),l>f)return null}return l}function kM(r,e,n,s,l,f,p,y,x,b,I){let S=s-r,D=l-e,R=f-n,L=p-r,F=y-e,V=x-n,$=I[1]*V-I[2]*F,Y=I[2]*L-I[0]*V,K=I[0]*F-I[1]*L,z=S*$+D*Y+R*K;if(Math.abs(z)<1e-15)return null;let W=1/z,J=b[0]-r,te=b[1]-e,me=b[2]-n,de=(J*$+te*Y+me*K)*W;if(de<0||de>1)return null;let ge=te*R-me*D,xe=me*S-J*R,ke=J*D-te*S,Xe=(I[0]*ge+I[1]*xe+I[2]*ke)*W;return Xe<0||de+Xe>1?null:(L*ge+F*xe+V*ke)*W}function FM(r,e,n){return(r-e)/(n-e)}function NM(r,e,n,s,l,f,p,y,x){let b=1<<n,I=f-s,S=p-l,D=(r+1)/b*I+s,R=(e+0)/b*S+l,L=(e+1)/b*S+l;y[0]=(r+0)/b*I+s,y[1]=R,x[0]=D,x[1]=L}class zM{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;let n=function(f){let p=Math.ceil(Math.log2(f.dim/8)),y=[],x=Math.ceil(Math.pow(2,p)),b=1/x,I=(R,L,F,V,$)=>{let Y=V?1:0,K=(R+1)*F-Y,z=L*F,W=(L+1)*F-Y;$[0]=R*F,$[1]=z,$[2]=K,$[3]=W},S=new LM(x),D=[];for(let R=0;R<x*x;R++){I(R%x,Math.floor(R/x),b,!1,D);let L=$c(D[0],D[1],f),F=$c(D[2],D[1],f),V=$c(D[2],D[3],f),$=$c(D[0],D[3],f);S.minimums.push(Math.min(L,F,V,$)),S.maximums.push(Math.max(L,F,V,$)),S.leaves.push(1)}for(y.push(S),x/=2;x>=1;x/=2){let R=y[y.length-1];S=new LM(x);for(let L=0;L<x*x;L++){I(L%x,Math.floor(L/x),2,!0,D);let F=R.getElevation(D[0],D[1]),V=R.getElevation(D[2],D[1]),$=R.getElevation(D[2],D[3]),Y=R.getElevation(D[0],D[3]),K=R.isLeaf(D[0],D[1]),z=R.isLeaf(D[2],D[1]),W=R.isLeaf(D[2],D[3]),J=R.isLeaf(D[0],D[3]),te=Math.min(F.min,V.min,$.min,Y.min),me=Math.max(F.max,V.max,$.max,Y.max),de=K&&z&&W&&J;S.maximums.push(me),S.minimums.push(te),S.leaves.push(me-te<=5&&de?1:0)}y.push(S)}return y}(this.dem),s=n.length-1,l=n[s];this._addNode(l.minimums[0],l.maximums[0],l.leaves[0]),this._construct(n,0,0,s,0)}raycastRoot(e,n,s,l,f,p,y=1){return OM([e,n,-100],[s,l,this.maximums[0]*y],f,p)}raycast(e,n,s,l,f,p,y=1){if(!this.nodeCount)return null;let x=this.raycastRoot(e,n,s,l,f,p,y);if(x==null)return null;let b=[],I=[],S=[],D=[],R=[{idx:0,t:x,nodex:0,nodey:0,depth:0}];for(;R.length>0;){let{idx:L,t:F,nodex:V,nodey:$,depth:Y}=R.pop();if(this.leaves[L]){NM(V,$,Y,e,n,s,l,S,D);let z=1<<Y,W=(V+0)/z,J=(V+1)/z,te=($+0)/z,me=($+1)/z,de=$c(W,te,this.dem)*y,ge=$c(J,te,this.dem)*y,xe=$c(J,me,this.dem)*y,ke=$c(W,me,this.dem)*y,Xe=kM(S[0],S[1],de,D[0],S[1],ge,D[0],D[1],xe,f,p),He=kM(D[0],D[1],xe,S[0],D[1],ke,S[0],S[1],de,f,p),Ze=Math.min(Xe!==null?Xe:Number.MAX_VALUE,He!==null?He:Number.MAX_VALUE);if(Ze!==Number.MAX_VALUE)return Ze;{let Ye=yo([],f,p,F);if(BM(de,ge,ke,xe,FM(Ye[0],S[0],D[0]),FM(Ye[1],S[1],D[1]))>=Ye[2])return F}continue}let K=0;for(let z=0;z<this._siblingOffset.length;z++){NM((V<<1)+this._siblingOffset[z][0],($<<1)+this._siblingOffset[z][1],Y+1,e,n,s,l,S,D),S[2]=-100,D[2]=this.maximums[this.childOffsets[L]+z]*y;let W=OM(S,D,f,p);if(W!=null){let J=W;b[z]=J;let te=!1;for(let me=0;me<K&&!te;me++)J>=b[I[me]]&&(I.splice(me,0,z),te=!0);te||(I[K]=z),K++}}for(let z=0;z<K;z++){let W=I[z];R.push({idx:this.childOffsets[L]+W,t:b[W],nodex:(V<<1)+this._siblingOffset[W][0],nodey:($<<1)+this._siblingOffset[W][1],depth:Y+1})}}return null}_addNode(e,n,s){return this.minimums.push(e),this.maximums.push(n),this.leaves.push(s),this.childOffsets.push(0),this.nodeCount++}_construct(e,n,s,l,f){if(e[l].isLeaf(n,s)===1)return;this.childOffsets[f]||(this.childOffsets[f]=this.nodeCount);let p=l-1,y=e[p],x=0,b=0;for(let I=0;I<this._siblingOffset.length;I++){let S=2*n+this._siblingOffset[I][0],D=2*s+this._siblingOffset[I][1],R=y.getElevation(S,D),L=y.isLeaf(S,D),F=this._addNode(R.min,R.max,L);L&&(x|=1<<I),b||(b=F)}for(let I=0;I<this._siblingOffset.length;I++)x&1<<I||this._construct(e,2*n+this._siblingOffset[I][0],2*s+this._siblingOffset[I][1],p,b+I)}}function BM(r,e,n,s,l,f){return kt(kt(r,n,f),kt(e,s,f),l)}function $c(r,e,n){let s=n.dim,l=ae(r*s-.5,0,s-1),f=ae(e*s-.5,0,s-1),p=Math.floor(l),y=Math.floor(f),x=Math.min(p+1,s-1),b=Math.min(y+1,s-1);return BM(n.get(p,y),n.get(x,y),n.get(p,b),n.get(x,b),l-p,f-y)}let tN={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function nN(r,e,n){return(256*r*256+256*e+n)/10-1e4}function iN(r,e,n){return 256*r+e+n/256-32768}class kv{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,n,s,l=!1){if(this.uid=e,n.height!==n.width)throw new RangeError("DEM tiles must be square");if(s&&s!=="mapbox"&&s!=="terrarium")return void qt(`"${s}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=n.height;let f=this.dim=n.height-2,p=new Uint32Array(n.data.buffer);if(this.pixels=new Uint8Array(n.data.buffer),this.floatView=new Float32Array(n.data.buffer),this.borderReady=l,this._modifiedForSources={},!l){for(let x=0;x<f;x++)p[this._idx(-1,x)]=p[this._idx(0,x)],p[this._idx(f,x)]=p[this._idx(f-1,x)],p[this._idx(x,-1)]=p[this._idx(x,0)],p[this._idx(x,f)]=p[this._idx(x,f-1)];p[this._idx(-1,-1)]=p[this._idx(0,0)],p[this._idx(f,-1)]=p[this._idx(f-1,0)],p[this._idx(-1,f)]=p[this._idx(0,f-1)],p[this._idx(f,f)]=p[this._idx(f-1,f-1)]}let y=s==="terrarium"?iN:nN;for(let x=0;x<p.length;++x){let b=4*x;this.floatView[x]=y(this.pixels[b],this.pixels[b+1],this.pixels[b+2])}this._timestamp=Zo.now()}_buildQuadTree(){this._tree=new zM(this)}get(e,n,s=!1){s&&(e=ae(e,-1,this.dim),n=ae(n,-1,this.dim));let l=this._idx(e,n);return this.floatView[l]}set(e,n,s){let l=this._idx(e,n),f=this.floatView[l];return this.floatView[l]=s,s-f}static getUnpackVector(e){return tN[e]}_idx(e,n){if(e<-1||e>=this.dim+1||n<-1||n>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(n+1)*this.stride+(e+1)}static pack(e,n){let s=[0,0,0,0],l=kv.getUnpackVector(n),f=Math.floor((e+l[3])/l[2]);return s[2]=f%256,f=Math.floor(f/256),s[1]=f%256,f=Math.floor(f/256),s[0]=f,s}getPixels(){return new BS({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,n,s){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let l=n*this.dim,f=n*this.dim+this.dim,p=s*this.dim,y=s*this.dim+this.dim;switch(n){case-1:l=f-1;break;case 1:f=l+1}switch(s){case-1:p=y-1;break;case 1:y=p+1}let x=-n*this.dim,b=-s*this.dim;for(let I=p;I<y;I++)for(let S=l;S<f;S++){let D=4*this._idx(S,I),R=4*this._idx(S+x,I+b);this.pixels[D+0]=e.pixels[R+0],this.pixels[D+1]=e.pixels[R+1],this.pixels[D+2]=e.pixels[R+2],this.pixels[D+3]=e.pixels[R+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function rN(r,e,n){r===1?e.headerLength=n.readFixed32():r===2?e.x=n.readVarint():r===3?e.y=n.readVarint():r===4?e.z=n.readVarint():r===5&&e.layers.push(function(s,l){return s.readFields(cN,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},l)}(n,n.readVarint()+n.pos))}function oN(r,e,n){r===1?(e.delta_filter=function(s,l){return s.readFields(sN,{blockSize:0},l)}(n,n.readVarint()+n.pos),e.filter="delta_filter"):r===2?(n.readVarint(),e.filter="zigzag_filter"):r===3?(n.readVarint(),e.filter="bitshuffle_filter"):r===4&&(n.readVarint(),e.filter="byteshuffle_filter")}function sN(r,e,n){r===1&&(e.blockSize=n.readVarint())}function aN(r,e,n){r===1?(n.readVarint(),e.codec="gzip_data"):r===2?(n.readVarint(),e.codec="jpeg_image"):r===3?(n.readVarint(),e.codec="webp_image"):r===4&&(n.readVarint(),e.codec="png_image")}function lN(r,e,n){let s=0,l=0;r===1?e.firstByte=n.readFixed64():r===2?e.lastByte=n.readFixed64():r===3?e.filters.push(function(f,p){return f.readFields(oN,{},p)}(n,n.readVarint()+n.pos)):r===4?e.codec=function(f,p){return f.readFields(aN,{},p)}(n,n.readVarint()+n.pos):r===5?l=n.readFloat():r===6?s=n.readFloat():r===7?e.bands.push(n.readString()):r===8?e.offset=n.readDouble():r===9&&(e.scale=n.readDouble()),e.offset===0&&(e.offset=l),e.scale===0&&(e.scale=s)}function cN(r,e,n){r===1?e.version=n.readVarint():r===2?e.name=n.readString():r===3?e.units=n.readString():r===4?e.tileSize=n.readVarint():r===5?e.buffer=n.readVarint():r===6?e.pixelFormat=n.readVarint():r===7&&e.dataIndex.push(function(s,l){return s.readFields(lN,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},l)}(n,n.readVarint()+n.pos))}function uN(r,e,n){if(r===2)(function(s,l,f){s.readFields(hN,f,l)})(n,n.readVarint()+n.pos,e);else if(r===3)throw new Error("Not implemented")}function hN(r,e,n){if(r===1){let s=0,l=n.readVarint()+n.pos;for(;n.pos<l;)e[s++]=n.readVarint()}}function dN(r,e){if(e.length!==4)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let n=e[3];for(let s=2;s>=1;s--){let l=s===1?1:0,f=s===2?1:0;for(let p=0;p<e[0];p++){let y=e[1]*p;for(let x=l;x<e[1];x++){let b=e[2]*(x+y);for(let I=f;I<e[2];I++){let S=e[3]*(I+b);for(let D=0;D<e[3];D++){let R=S+D;r[R]+=r[R-n]}}}}n*=e[s]}return r}function fN(r){for(let e=0,n=r.length;e<n;e++)r[e]=r[e]>>>1^-(1&r[e]);return r}function pN(r,e){switch(e){case"uint32":return r;case"uint16":for(let n=0;n<r.length;n+=2){let s=r[n],l=r[n+1];r[n]=(240&s)>>4|(61440&s)>>8|(240&l)<<4|61440&l,r[n+1]=15&s|(3840&s)>>4|(15&l)<<8|(3840&l)<<4}return r;case"uint8":for(let n=0;n<r.length;n+=4){let s=r[n],l=r[n+1],f=r[n+2],p=r[n+3];r[n+0]=(192&s)>>6|(192&l)>>4|(192&f)>>2|192&p,r[n+1]=(48&s)>>4|(48&l)>>2|48&f|(48&p)<<2,r[n+2]=(12&s)>>2|12&l|(12&f)<<2|(12&p)<<4,r[n+3]=3&s|(3&l)<<2|(3&f)<<4|(3&p)<<6}return r;default:throw new Error(`Invalid pixel format, "${e}"`)}}pt(kv,"DEMData"),pt(zM,"DemMinMaxQuadTree",{omit:["dem"]});var ns=Uint8Array,mg=Uint16Array,mN=Int32Array,VM=new ns([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),jM=new ns([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),gN=new ns([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),UM=function(r,e){for(var n=new mg(31),s=0;s<31;++s)n[s]=e+=1<<r[s-1];var l=new mN(n[30]);for(s=1;s<30;++s)for(var f=n[s];f<n[s+1];++f)l[f]=f-n[s]<<5|s;return{b:n,r:l}},HM=UM(VM,2),$M=HM.b,_N=HM.r;$M[28]=258,_N[258]=28;for(var yN=UM(jM,0).b,GM=new mg(32768),Ki=0;Ki<32768;++Ki){var wf=(43690&Ki)>>1|(21845&Ki)<<1;GM[Ki]=((65280&(wf=(61680&(wf=(52428&wf)>>2|(13107&wf)<<2))>>4|(3855&wf)<<4))>>8|(255&wf)<<8)>>1}var gg=function(r,e,n){for(var s=r.length,l=0,f=new mg(e);l<s;++l)r[l]&&++f[r[l]-1];var p,y=new mg(e);for(l=1;l<e;++l)y[l]=y[l-1]+f[l-1]<<1;p=new mg(1<<e);var x=15-e;for(l=0;l<s;++l)if(r[l])for(var b=l<<4|r[l],I=e-r[l],S=y[r[l]-1]++<<I,D=S|(1<<I)-1;S<=D;++S)p[GM[S]>>x]=b;return p},_g=new ns(288);for(Ki=0;Ki<144;++Ki)_g[Ki]=8;for(Ki=144;Ki<256;++Ki)_g[Ki]=9;for(Ki=256;Ki<280;++Ki)_g[Ki]=7;for(Ki=280;Ki<288;++Ki)_g[Ki]=8;var qM=new ns(32);for(Ki=0;Ki<32;++Ki)qM[Ki]=5;var vN=gg(_g,9),xN=gg(qM,5),vw=function(r){for(var e=r[0],n=1;n<r.length;++n)r[n]>e&&(e=r[n]);return e},Ys=function(r,e,n){var s=e/8|0;return(r[s]|r[s+1]<<8)>>(7&e)&n},xw=function(r,e){var n=e/8|0;return(r[n]|r[n+1]<<8|r[n+2]<<16)>>(7&e)},bN=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Ks=function(r,e,n){var s=new Error(e||bN[r]);if(s.code=r,Error.captureStackTrace&&Error.captureStackTrace(s,Ks),!n)throw s;return s},wN=new ns(0),EN=typeof TextDecoder<"u"&&new TextDecoder;try{EN.decode(wN,{stream:!0})}catch{}let TN={gzip_data:"gzip"};class xs extends Error{constructor(e){super(e),this.name="MRTError"}}let IN={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},WM={uint32:1,uint16:2,uint8:4},SN={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array},bw;class Fv{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){let n=this.layers[e];if(!n)throw new xs(`Layer '${e}' not found`);return n}getHeaderLength(e){let n=new Uint8Array(e),s=new DataView(e);if(n[0]!==13)throw new xs("File is not a valid MRT.");return s.getUint32(1,!0)}parseHeader(e){let n=new Uint8Array(e),s=this.getHeaderLength(e);if(n.length<s)throw new xs(`Expected header with length >= ${s} but got buffer of length ${n.length}`);let l=function(f,p){return f.readFields(rN,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0)}(new bw(n.subarray(0,s)));if(!isNaN(this.x)&&(this.x!==l.x||this.y!==l.y||this.z!==l.z))throw new xs(`Invalid attempt to parse header ${l.z}/${l.x}/${l.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=l.x,this.y=l.y,this.z=l.z;for(let f of l.layers)this.layers[f.name]=new ZM(f,{cacheSize:this._cacheSize});return this}createDecodingTask(e){let n=[],s=this.getLayer(e.layerName);for(let l of e.blockIndices){let f=s.dataIndex[l],p=f.firstByte-e.firstByte,y=f.lastByte-e.firstByte;if(s._blocksInProgress.has(l))continue;let x={layerName:s.name,firstByte:p,lastByte:y,pixelFormat:s.pixelFormat,blockIndex:l,blockShape:[f.bands.length].concat(s.bandShape),buffer:s.buffer,codec:f.codec.codec,filters:f.filters.map(b=>b.filter)};s._blocksInProgress.add(l),n.push(x)}return new XM(n,()=>{n.forEach(l=>s._blocksInProgress.delete(l.blockIndex))},(l,f)=>{if(n.forEach(p=>s._blocksInProgress.delete(p.blockIndex)),l)throw l;f.forEach(p=>{this.getLayer(p.layerName).processDecodedData(p)})})}}class ZM{constructor({version:e,name:n,units:s,tileSize:l,pixelFormat:f,buffer:p,dataIndex:y},x){if(this.version=e,this.version!==1)throw new xs(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=n,this.units=s,this.tileSize=l,this.buffer=p,this.pixelFormat=IN[f],this.dataIndex=y,this.bandShape=[l+2*p,l+2*p,WM[this.pixelFormat]],this._decodedBlocks=new Ov(x?x.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return WM[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:e})=>e).flat()}processDecodedData(e){let n=e.blockIndex.toString();this._decodedBlocks.get(n)||this._decodedBlocks.put(n,e.data)}getBlockForBand(e){let n=0;switch(typeof e){case"string":for(let[s,l]of this.dataIndex.entries()){for(let[f,p]of l.bands.entries())if(p===e)return{bandIndex:n+f,blockIndex:s,blockBandIndex:f};n+=l.bands.length}break;case"number":for(let[s,l]of this.dataIndex.entries()){if(e>=n&&e<n+l.bands.length)return{bandIndex:e,blockIndex:s,blockBandIndex:e-n};n+=l.bands.length}break;default:throw new xs(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(e){let n=1/0,s=-1/0,l=[],f=new Set;for(let p of e){let{blockIndex:y}=this.getBlockForBand(p);if(y<0)throw new xs(`Invalid band: ${JSON.stringify(p)}`);let x=this.dataIndex[y];l.includes(y)||l.push(y),f.add(y),n=Math.min(n,x.firstByte),s=Math.max(s,x.lastByte)}if(f.size>this.cacheSize)throw new xs(`Number of blocks to decode (${f.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:n,lastByte:s,blockIndices:l}}hasBand(e){let{blockIndex:n}=this.getBlockForBand(e);return n>=0}hasDataForBand(e){let{blockIndex:n}=this.getBlockForBand(e);return n>=0&&!!this._decodedBlocks.get(n.toString())}getBandView(e){let{blockIndex:n,blockBandIndex:s}=this.getBlockForBand(e);if(n<0)throw new xs(`Band not found: ${JSON.stringify(e)}`);let l=this._decodedBlocks.get(n.toString());if(!l)throw new xs(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);let f=this.dataIndex[n],p=this.bandShape.reduce((b,I)=>b*I,1),y=s*p,x=l.subarray(y,y+p);return{data:x,bytes:new Uint8Array(x.buffer).subarray(x.byteOffset,x.byteOffset+x.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:f.offset,scale:f.scale}}}Fv.setPbf=function(r){bw=r};class XM{constructor(e,n,s){this.tasks=e,this._onCancel=n,this._onComplete=s,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,n){this._finalized||(this._onComplete(e,n),this._finalized=!0)}}function Eh(r,e){let n=r.json.bufferViews[e.bufferView],s=iv[e.componentType];return new s(r.buffers[n.buffer],(e.byteOffset||0)+(n.byteOffset||0),e.count*(n.byteStride&&n.byteStride!==Qm[e.type]*s.BYTES_PER_ELEMENT?n.byteStride/s.BYTES_PER_ELEMENT:Qm[e.type]))}function ww(r,e,n,s){let l=iv[e.componentType],f=function(I){switch(I){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(l),p=r.json.bufferViews[e.bufferView],y=p.byteStride?p.byteStride/l.BYTES_PER_ELEMENT:Qm[e.type],x=n.float32,b=x.length/n.capacity;for(let I=0,S=0;I<e.count*y;I+=y,S+=b)for(let D=0;D<b;D++)x[S+D]=s[I+D]*f;n._trim()}function DN(r,e,n){let s=r.indices,l=r.attributes,f={};f.indexArray=new cr;let p=e.json.accessors[s],y=p.count/3;f.indexArray.reserve(y);let x=Eh(e,p);for(let D=0;D<y;D++)f.indexArray.emplaceBack(x[3*D],x[3*D+1],x[3*D+2]);f.indexArray._trim(),f.vertexArray=new gs;let b=e.json.accessors[l.POSITION];f.vertexArray.reserve(b.count);let I=Eh(e,b);for(let D=0;D<b.count;D++)f.vertexArray.emplaceBack(I[3*D],I[3*D+1],I[3*D+2]);if(f.vertexArray._trim(),f.aabb=new _n(b.min,b.max),f.centroid=function(D,R){let L=[0,0,0],F=D.length;if(F>0){for(let V=0;V<F;V++){let $=3*D[V];L[0]+=R[$],L[1]+=R[$+1],L[2]+=R[$+2]}L[0]/=F,L[1]/=F,L[2]/=F}return L}(x,I),l.COLOR_0!==void 0){let D=e.json.accessors[l.COLOR_0],R=Qm[D.type],L=Eh(e,D);f.colorArray=R===3?new gs:new lr,f.colorArray.resize(D.count),ww(e,D,f.colorArray,L)}if(l.NORMAL!==void 0){f.normalArray=new gs;let D=e.json.accessors[l.NORMAL];f.normalArray.resize(D.count);let R=Eh(e,D);ww(e,D,f.normalArray,R)}if(l.TEXCOORD_0!==void 0&&n.length>0){f.texcoordArray=new Sl;let D=e.json.accessors[l.TEXCOORD_0];f.texcoordArray.resize(D.count);let R=Eh(e,D);ww(e,D,f.texcoordArray,R)}if(l._FEATURE_ID_RGBA4444!==void 0){let D=e.json.accessors[l._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(f.featureData=Eh(e,D))}l._FEATURE_RGBA4444!==void 0&&(f.featureData=new Uint32Array(Eh(e,e.json.accessors[l._FEATURE_RGBA4444]).buffer));let S=r.material;return f.material=function(D,R){let{emissiveFactor:L=[0,0,0],alphaMode:F="OPAQUE",alphaCutoff:V=.5,normalTexture:$,occlusionTexture:Y,emissiveTexture:K,doubleSided:z}=D,{baseColorFactor:W=[1,1,1,1],metallicFactor:J=1,roughnessFactor:te=1,baseColorTexture:me,metallicRoughnessTexture:de}=D.pbrMetallicRoughness||{},ge=Y?R[Y.index]:void 0;if(Y&&Y.extensions&&Y.extensions.KHR_texture_transform&&ge){let xe=Y.extensions.KHR_texture_transform;ge.offsetScale=[xe.offset[0],xe.offset[1],xe.scale[0],xe.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new In(...W),metallicFactor:J,roughnessFactor:te,baseColorTexture:me?R[me.index]:void 0,metallicRoughnessTexture:de?R[de.index]:void 0},doubleSided:z,emissiveFactor:new In(...L),alphaMode:F,alphaCutoff:V,normalTexture:$?R[$.index]:void 0,occlusionTexture:ge,emissionTexture:K?R[K.index]:void 0,defined:D.defined===void 0}}(S!==void 0?e.json.materials[S]:{defined:!1},n),f}function YM(r,e,n){let{matrix:s,rotation:l,translation:f,scale:p,mesh:y,extras:x,children:b}=r,I={};if(I.matrix=s||function(S,D,R,L){var F=D[0],V=D[1],$=D[2],Y=D[3],K=F+F,z=V+V,W=$+$,J=F*K,te=F*z,me=F*W,de=V*z,ge=V*W,xe=$*W,ke=Y*K,Xe=Y*z,He=Y*W,Ze=L[0],Ye=L[1],Ne=L[2];return S[0]=(1-(de+xe))*Ze,S[1]=(te+He)*Ze,S[2]=(me-Xe)*Ze,S[3]=0,S[4]=(te-He)*Ye,S[5]=(1-(J+xe))*Ye,S[6]=(ge+ke)*Ye,S[7]=0,S[8]=(me+Xe)*Ne,S[9]=(ge-ke)*Ne,S[10]=(1-(J+de))*Ne,S[11]=0,S[12]=R[0],S[13]=R[1],S[14]=R[2],S[15]=1,S}([],l||[0,0,0,1],f||[0,0,0],p||[1,1,1]),y!==void 0){I.meshes=n[y];let S=I.anchor=[0,0];for(let D of I.meshes){let{min:R,max:L}=D.aabb;S[0]+=R[0]+L[0],S[1]+=R[1]+L[1]}S[0]=Math.floor(S[0]/I.meshes.length/2),S[1]=Math.floor(S[1]/I.meshes.length/2)}if(x&&(x.id&&(I.id=x.id),x.lights&&(I.lights=function(S){if(!S.length)return[];let D=function($){let Y=atob($),K=new Uint8Array(Y.length);for(let z=0;z<Y.length;z++)K[z]=Y.codePointAt(z);return K}(S),R=[],L=D.length/24,F=new Uint16Array(D.buffer),V=new Float32Array(D.buffer);for(let $=0;$<L;$++){let Y=F[2*$*6]/30,K=F[2*$*6+1]/30,z=F[2*$*6+10]/100,W=V[6*$+1],J=V[6*$+2],te=V[6*$+3],me=V[6*$+4],de=te-W,ge=me-J,xe=Math.hypot(de,ge);R.push({pos:[W+.5*de,J+.5*ge,K],normal:[ge/xe,-de/xe,0],width:xe,height:Y,depth:z,points:[W,J,te,me]})}return R}(x.lights))),b){let S=[];for(let D of b)S.push(YM(e.json.nodes[D],e,n));I.children=S}return I}function CN(r){if(r.vertices.length===0||r.indices.length===0)return null;let e=new I1(r.vertices,r.indices,8,256),[n,s]=[e.min.clone(),e.max.clone()];return{vertices:r.vertices,indices:r.indices,grid:e,min:n,max:s}}function MN(r){if(!r.extras||!r.extras.ground)return null;let e=r.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;let n=e[0];if(!n||!Array.isArray(n)||n.length===0)return null;let s=[];for(let p of n){if(!Array.isArray(p)||p.length!==2)continue;let y=p[0],x=p[1];typeof y=="number"&&typeof x=="number"&&s.push(new ot(y,x))}if(s.length<3)return null;s.length>1&&s[s.length-1].equals(s[0])&&s.pop();let l=0;for(let p=0;p<s.length;p++){let y=s[p],x=s[(p+1)%s.length],b=s[(p+2)%s.length];l+=(y.x-x.x)*(b.y-x.y)-(b.x-x.x)*(y.y-x.y)}l>0&&s.reverse();let f=jm(s.flatMap(p=>[p.x,p.y]),[]);return f.length===0?null:{vertices:s,indices:f}}function AN(r,e){let n=[],s=[],l=0,f=[];for(let p of r){l=n.length;let y=p.vertexArray.float32,x=p.indexArray.uint16;for(let b=0;b<p.vertexArray.length;b++)f[0]=y[3*b+0],f[1]=y[3*b+1],f[2]=y[3*b+2],ai(f,f,e),n.push(new ot(f[0],f[1]));for(let b=0;b<3*p.indexArray.length;b++)s.push(x[b]+l)}if(s.length%3!=0)return null;for(let p=0;p<s.length;p+=3){let y=n[s[p+0]],x=n[s[p+1]],b=n[s[p+2]];(y.x-x.x)*(b.y-x.y)-(b.x-x.x)*(y.y-x.y)>0&&([s[p+1],s[p+2]]=[s[p+2],s[p+1]])}return{vertices:n,indices:s}}function KM(r){let e=function(x,b){let I=[],S=WebGL2RenderingContext;if(x.json.textures)for(let D of x.json.textures){let R={magFilter:S.LINEAR,minFilter:S.NEAREST,wrapS:S.REPEAT,wrapT:S.REPEAT};D.sampler!==void 0&&Object.assign(R,x.json.samplers[D.sampler]),I.push({image:b[D.source],sampler:R,uploaded:!1})}return I}(r,r.images),n=function(x,b){let I=[];for(let S of x.json.meshes){let D=[];for(let R of S.primitives)D.push(DN(R,x,b));I.push(D)}return I}(r,e),{scenes:s,scene:l,nodes:f}=r.json,p=s?s[l||0].nodes:f,y=[];for(let x of p)y.push(YM(f[x],r,n));return function(x,b,I){let S={},D=new Set;for(let R=0;R<x.length;R++){let L=I[b[R]];if(!L.extras)continue;let F=L.extras["mapbox:footprint:version"],V=L.extras["mapbox:footprint:id"];(F||V)&&D.add(R),F==="1.0.0"&&V&&(S[V]=R)}for(let R=0;R<x.length;R++){if(D.has(R))continue;let L=x[R],F=I[b[R]];if(!F.extras)continue;let V=null;L.id in S&&(V=AN(x[S[L.id]].meshes,L.matrix)),V||(V=MN(F)),V&&(L.footprint=CN(V))}if(D.size>0){let R=Array.from(D.values()).sort((L,F)=>L-F);for(let L=R.length-1;L>=0;L--)x.splice(R[L],1)}}(y,p,r.json.nodes),y}function RN(r){r.heightmap=new Float32Array(4096),r.heightmap.fill(-1);let e=r.vertexArray.float32,n=r.aabb.min[0]-1,s=r.aabb.min[1]-1,l=bh/(r.aabb.max[0]-n+2),f=bh/(r.aabb.max[1]-s+2);for(let p=0;p<e.length;p+=3){let y=e[p+2],x=(e[p+0]-n)*l|0,b=(e[p+1]-s)*f|0;y>r.heightmap[b*bh+x]&&(r.heightmap[b*bh+x]=y)}}function PN(r,e){let n={};n.indexArray=new cr,n.indexArray.reserve(4*r.length),n.vertexArray=new gs,n.vertexArray.reserve(10*r.length),n.colorArray=new lr,n.vertexArray.reserve(10*r.length);let s=0;for(let p of r){let y=Math.min(10,Math.max(4,1.3*p.height))*e,x=[-p.normal[1],p.normal[0],0],b=Math.min(.29,.1*p.width/p.depth),I=p.width-2*p.depth*e*(b+.01),S=yo([],p.pos,x,I/2),D=yo([],p.pos,x,-I/2),R=[S[0],S[1],S[2]+p.height],L=[D[0],D[1],D[2]+p.height],F=yo([],p.normal,x,b);pi(F,F,y);let V=yo([],p.normal,x,-b);pi(V,V,y),Ui(F,S,F),Ui(V,D,V),S[2]+=.1,D[2]+=.1,n.vertexArray.emplaceBack(F[0],F[1],F[2]),n.vertexArray.emplaceBack(V[0],V[1],V[2]),n.vertexArray.emplaceBack(S[0],S[1],S[2]),n.vertexArray.emplaceBack(D[0],D[1],D[2]),n.vertexArray.emplaceBack(R[0],R[1],R[2]),n.vertexArray.emplaceBack(L[0],L[1],L[2]),n.vertexArray.emplaceBack(S[0],S[1],S[2]),n.vertexArray.emplaceBack(D[0],D[1],D[2]),n.vertexArray.emplaceBack(F[0],F[1],F[2]),n.vertexArray.emplaceBack(V[0],V[1],V[2]);let $=I/y/2;n.colorArray.emplaceBack(-$-b,-1,$,.8),n.colorArray.emplaceBack($+b,-1,$,.8),n.colorArray.emplaceBack(-$,0,$,1.3),n.colorArray.emplaceBack($,0,$,1.3),n.colorArray.emplaceBack($+b,-.8,$,.7),n.colorArray.emplaceBack($+b,-.8,$,.7),n.colorArray.emplaceBack(0,0,$,1.3),n.colorArray.emplaceBack(0,0,$,1.3),n.colorArray.emplaceBack($+b,-1.2,$,.8),n.colorArray.emplaceBack($+b,-1.2,$,.8),n.indexArray.emplaceBack(6+s,4+s,8+s),n.indexArray.emplaceBack(7+s,9+s,5+s),n.indexArray.emplaceBack(0+s,1+s,2+s),n.indexArray.emplaceBack(1+s,3+s,2+s),s+=10}let l={defined:!0};l.emissiveFactor=In.black;let f={};return f.baseColorFactor=In.white,l.pbrMetallicRoughness=f,n.material=l,n.aabb=new _n([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),n}Fv.performDecoding=function(r,e){let n=new Uint8Array(r);return Promise.all(e.tasks.map(s=>{let{layerName:l,firstByte:f,lastByte:p,pixelFormat:y,blockShape:x,blockIndex:b,filters:I,codec:S}=s,D=n.subarray(f,p+1),R=new Uint32Array(x[0]*x[1]*x[2]),L;if(S!=="gzip_data")throw new xs(`Unhandled codec: ${S}`);return L=function(F,V){if(!globalThis.DecompressionStream&&V==="gzip_data")return Promise.resolve(((z=function(te){te[0]==31&&te[1]==139&&te[2]==8||Ks(6,"invalid gzip data");var me=te[3],de=10;4&me&&(de+=2+(te[10]|te[11]<<8));for(var ge=(me>>3&1)+(me>>4&1);ge>0;ge-=!te[de++]);return de+(2&me)}(K=F))+8>K.length&&Ks(6,"invalid gzip data"),function(te,me,de,ge){var xe=te.length;if(!xe||me.f&&!me.l)return de||new ns(0);var ke=!de,Xe=ke||me.i!=2,He=me.i;ke&&(de=new ns(3*xe));var Ze,Ye,Ne=function(Li){var oi=de.length;if(Li>oi){var Xn=new ns(Math.max(2*oi,Li));Xn.set(de),de=Xn}},qe=me.f||0,Le=me.p||0,Fe=me.b||0,Qe=me.l,tt=me.d,Dt=me.m,vt=me.n,ct=8*xe;do{if(!Qe){qe=Ys(te,Le,1);var Je=Ys(te,Le+1,3);if(Le+=3,!Je){var jt=te[(Q=4+((Le+7)/8|0))-4]|te[Q-3]<<8,yt=Q+jt;if(yt>xe){He&&Ks(0);break}Xe&&Ne(Fe+jt),de.set(te.subarray(Q,yt),Fe),me.b=Fe+=jt,me.p=Le=8*yt,me.f=qe;continue}if(Je==1)Qe=vN,tt=xN,Dt=9,vt=5;else if(Je==2){var bt=Ys(te,Le,31)+257,Ft=Ys(te,Le+10,15)+4,Gt=bt+Ys(te,Le+5,31)+1;Le+=14;for(var $t=new ns(Gt),tn=new ns(19),Xt=0;Xt<Ft;++Xt)tn[gN[Xt]]=Ys(te,Le+3*Xt,7);Le+=3*Ft;var nn=vw(tn),Cn=(1<<nn)-1,Qn=gg(tn,nn);for(Xt=0;Xt<Gt;){var Q,ne=Qn[Ys(te,Le,Cn)];if(Le+=15&ne,(Q=ne>>4)<16)$t[Xt++]=Q;else{var ze=0,it=0;for(Q==16?(it=3+Ys(te,Le,3),Le+=2,ze=$t[Xt-1]):Q==17?(it=3+Ys(te,Le,7),Le+=3):Q==18&&(it=11+Ys(te,Le,127),Le+=7);it--;)$t[Xt++]=ze}}var ut=$t.subarray(0,bt),lt=$t.subarray(bt);Dt=vw(ut),vt=vw(lt),Qe=gg(ut,Dt),tt=gg(lt,vt)}else Ks(1);if(Le>ct){He&&Ks(0);break}}Xe&&Ne(Fe+131072);for(var _t=(1<<Dt)-1,Ot=(1<<vt)-1,an=Le;;an=Le){var ln=(ze=Qe[xw(te,Le)&_t])>>4;if((Le+=15&ze)>ct){He&&Ks(0);break}if(ze||Ks(2),ln<256)de[Fe++]=ln;else{if(ln==256){an=Le,Qe=null;break}var Yt=ln-254;ln>264&&(Yt=Ys(te,Le,(1<<(cn=VM[Xt=ln-257]))-1)+$M[Xt],Le+=cn);var Pn=tt[xw(te,Le)&Ot],Zn=Pn>>4;if(Pn||Ks(3),Le+=15&Pn,lt=yN[Zn],Zn>3){var cn=jM[Zn];lt+=xw(te,Le)&(1<<cn)-1,Le+=cn}if(Le>ct){He&&Ks(0);break}Xe&&Ne(Fe+131072);var vi=Fe+Yt;if(Fe<lt){var ei=0-lt,Mn=Math.min(lt,vi);for(ei+Fe<0&&Ks(3);Fe<Mn;++Fe)de[Fe]=(void 0)[ei+Fe]}for(;Fe<vi;++Fe)de[Fe]=de[Fe-lt]}}me.l=Qe,me.p=an,me.b=Fe,me.f=qe,Qe&&(qe=1,me.m=Dt,me.d=tt,me.n=vt)}while(!qe);return Fe!=de.length&&ke?(Ze=de,((Ye=Fe)==null||Ye>Ze.length)&&(Ye=Ze.length),new ns(Ze.subarray(0,Ye))):de.subarray(0,Fe)}(K.subarray(z,-8),{i:2},new ns((($=K)[(Y=$.length)-4]|$[Y-3]<<8|$[Y-2]<<16|$[Y-1]<<24)>>>0))));var $,Y,K,z;let W=TN[V];if(!W)throw new Error(`Unhandled codec: ${V}`);let J=new globalThis.DecompressionStream(W);return new Response(new Blob([F]).stream().pipeThrough(J)).arrayBuffer().then(te=>new Uint8Array(te))}(D,S).then(F=>(function(V,$){V.readFields(uN,$)}(new bw(F),R),new SN[y](R.buffer))),L.then(F=>{for(let V=I.length-1;V>=0;V--)switch(I[V]){case"delta_filter":dN(F,x);break;case"zigzag_filter":fN(F);break;case"bitshuffle_filter":pN(F,y);break;default:throw new xs(`Unhandled filter "${I[V]}"`)}return{layerName:l,blockIndex:b,data:F}}).catch(F=>{throw F})}))},pt(XM,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),pt(Fv,"MapboxRasterTile"),pt(ZM,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class JM{constructor(e){this._stringToNumber={},this._numberToString=[];for(let n=0;n<e.length;n++){let s=e[n];this._stringToNumber[s]=n,this._numberToString[n]=s}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}let LN=["id","tile","layer","source","sourceLayer","state"];class Ef{constructor(e,n,s,l,f){this.type="Feature",this._vectorTileFeature=e,this._z=n,this._x=s,this._y=l,this.properties=e.properties,this.id=f}clone(){let e=new Ef(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){let e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(let n of LN)this[n]!==void 0&&(e[n]=this[n]);return e}}class QM{constructor(e,n){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new js(at,16,0),this.featureIndexArray=new Ly,this.promoteId=n,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,n,s,l,f,p=0,y=0){let x=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(s,l,f,p);let b=this.grid;for(let I=0;I<n.length;I++){let S=n[I],D=[1/0,1/0,-1/0,-1/0];for(let R=0;R<S.length;R++){let L=S[R];D[0]=Math.min(D[0],L.x),D[1]=Math.min(D[1],L.y),D[2]=Math.max(D[2],L.x),D[3]=Math.max(D[3],L.y)}y!==0&&(D[0]-=y,D[1]-=y,D[2]+=y,D[3]+=y),D[0]<at&&D[1]<at&&D[2]>=0&&D[3]>=0&&b.insert(x,D[0],D[1],D[2],D[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Kt.VectorTile(new ov(this.rawTileData)).layers,this.sourceLayerCoder=new JM(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(let e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,n){let{tilespaceGeometry:s,transform:l,tileTransform:f,pixelPosMatrix:p,availableImages:y,worldview:x}=n;this.loadVTLayers(),this.serializedLayersCache.clear();let b=s.bufferedTilespaceBounds,I=this.grid.query(b.min.x,b.min.y,b.max.x,b.max.y,(L,F,V,$)=>Nc(s.bufferedTilespaceGeometry,L,F,V,$));I.sort(ON);let S=null;l.elevation&&I.length>0&&(S=vf.create(l.elevation,this.tileID));let D={},R;for(let L=0;L<I.length;L++){let F=I[L];if(F===R)continue;R=F;let V=this.featureIndexArray.get(F),$=null;this.is3DTile?this.loadMatchingModelFeature(D,V,e,s,l,x):this.loadMatchingFeature(D,V,e,y,x,(Y,K,z,W=0)=>($||($=gt(Y,this.tileID.canonical,f)),K.queryIntersectsFeature(s,Y,z,$,this.z,l,p,S,W)))}return D}loadMatchingFeature(e,n,s,l,f,p){let{featureIndex:y,bucketIndex:x,sourceLayerIndex:b,layoutVertexArrayOffset:I}=n,S=this.bucketLayerIDs[x],D=s.layers,R=Object.keys(D);if(R.length&&!Ut(R,S))return;let L=s.sourceCache,F=this.sourceLayerCoder.decode(b),V=this.vtLayers[F].feature(y),$=this.getId(V,F);for(let Y=0;Y<S.length;Y++){let K=S[Y];if(!D[K])continue;let{styleLayer:z,targets:W}=D[K],J={};$!==void 0&&(J=L.getFeatureState(z.sourceLayer,$));let te=!p||p(V,z,J,I);if(!te)continue;let me=new Ef(V,this.z,this.x,this.y,$);me.tile=this.tileID.canonical,me.state=J;let de=this.serializedLayersCache.get(K);de||(de=z.serialize(),de.id=K,this.serializedLayersCache.set(K,de)),me.source=de.source,me.sourceLayer=de["source-layer"],me.layer=Ce({},de),me.layer.paint=eA(de.paint,z.paint,V,J,l),me.layer.layout=eA(de.layout,z.layout,V,J,l);let ge=!1;for(let xe of W){this.updateFeatureProperties(me,xe);let{filter:ke}=xe;if(ke){if(V.properties=me.properties,ke.needGeometry){let Xe=dt(V,!0);if(!ke.filter(new zn(this.tileID.overscaledZ,{worldview:f}),Xe,this.tileID.canonical))continue}else if(!ke.filter(new zn(this.tileID.overscaledZ,{worldview:f}),V))continue}ge=!0,xe.targetId&&this.addFeatureVariant(me,xe)}ge&&this.appendToResult(e,K,y,me,te)}}loadMatchingModelFeature(e,n,s,l,f,p){let{featureIndex:y,bucketIndex:x}=n,b=this.bucketLayerIDs[x],I=s.layers,S=Object.keys(I);if(!S.length||Ut(S,b))for(let D=0;D<b.length;D++){let R=b[D],{styleLayer:L,targets:F}=I[R];if(L.type!=="model")continue;let V=l.tile,$=V.getBucket(L);if(!($&&$ instanceof Mv))continue;let Y=LF($,y,l,f);if(!Y)continue;let{z:K,x:z,y:W}=V.tileID.canonical,{feature:J,intersectionZ:te,position:me}=Y,de={};J.id!==void 0&&(de=s.sourceCache.getFeatureState(L.sourceLayer,J.id));let ge=new Ef({},K,z,W,J.id);ge.tile=this.tileID.canonical,ge.state=de,ge.properties=J.properties,ge.geometry={type:"Point",coordinates:[me.lng,me.lat]};let xe=this.serializedLayersCache.get(R);xe||(xe=L.serialize(),xe.id=R,this.serializedLayersCache.set(R,xe)),ge.source=xe.source,ge.sourceLayer=xe["source-layer"],ge.layer=Ce({},xe);let ke=!1;for(let Xe of F){this.updateFeatureProperties(ge,Xe);let{filter:He}=Xe;if(He){if(J.properties=ge.properties,He.needGeometry){if(!He.filter(new zn(this.tileID.overscaledZ,{worldview:p}),J,this.tileID.canonical))continue}else if(!He.filter(new zn(this.tileID.overscaledZ,{worldview:p}),J))continue}ke=!0,Xe.targetId&&this.addFeatureVariant(ge,Xe)}ke&&this.appendToResult(e,R,y,ge,te)}}updateFeatureProperties(e,n,s){if(n.properties){let l={};for(let f in n.properties){let p=n.properties[f].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,s);p!=null&&(l[f]=p)}e.properties=l}}addFeatureVariant(e,n,s){let l={target:n.target,namespace:n.namespace,uniqueFeatureID:n.uniqueFeatureID};n.properties&&(l.properties=e.properties),e.variants=e.variants||{},e.variants[n.targetId]=e.variants[n.targetId]||[],e.variants[n.targetId].push(l)}appendToResult(e,n,s,l,f){let p=e[n];p===void 0&&(p=e[n]=[]),p.push({featureIndex:s,feature:l,intersectionZ:f})}lookupSymbolFeatures(e,n,s,l,f,p){let y={};this.loadVTLayers();for(let x of e)this.loadMatchingFeature(y,{bucketIndex:n,sourceLayerIndex:s,featureIndex:x,layoutVertexArrayOffset:0},l,f,p);return y}loadFeature(e){let{featureIndex:n,sourceLayerIndex:s}=e;this.loadVTLayers();let l=this.sourceLayerCoder.decode(s),f=this.vtFeatures[l];if(f[n])return f[n];let p=this.vtLayers[l].feature(n);return f[n]=p,p}hasLayer(e){for(let n of this.bucketLayerIDs)for(let s of n)if(e===s)return!0;return!1}getId(e,n){let s=e.id;if(this.promoteId){let l=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[n];if(l!=null)if(Array.isArray(l)){if(!this.promoteIdExpression){let f=Vs(l);if(f.result!=="success"){let p=f.value.map(y=>`${y.key}: ${y.message}`).join(", ");return void qt(`Failed to create expression for promoteId: ${p}`)}this.promoteIdExpression=f.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new Nu),s=this.promoteIdExpression.evaluate({zoom:0},e)}else s=e.properties[l];typeof s=="boolean"&&(s=Number(s))}return s}}function eA(r,e,n,s,l){return wt(r,(f,p)=>{let y=e instanceof El?e.get(p):null;return y&&y.evaluate?y.evaluate(n,s,void 0,l):y})}function ON(r,e){return e-r}pt(QM,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});let tA=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Ew{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");let[n,s]=new Uint8Array(e,0,2);if(n!==219)throw new Error("Data does not appear to be in a KDBush format.");let l=s>>4;if(l!==1)throw new Error(`Got v${l} data when expected v1.`);let f=tA[15&s];if(!f)throw new Error("Unrecognized array type.");let[p]=new Uint16Array(e,2,1),[y]=new Uint32Array(e,4,1);return new Ew(y,p,f,e)}constructor(e,n=64,s=Float64Array,l){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+n,2),65535),this.ArrayType=s,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;let f=tA.indexOf(this.ArrayType),p=2*e*this.ArrayType.BYTES_PER_ELEMENT,y=e*this.IndexArrayType.BYTES_PER_ELEMENT,x=(8-y%8)%8;if(f<0)throw new Error(`Unexpected typed array class: ${s}.`);l&&l instanceof ArrayBuffer?(this.data=l,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+y+x,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+p+y+x),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+y+x,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+f]),new Uint16Array(this.data,2,1)[0]=n,new Uint32Array(this.data,4,1)[0]=e)}add(e,n){let s=this._pos>>1;return this.ids[s]=s,this.coords[this._pos++]=e,this.coords[this._pos++]=n,s}finish(){let e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return Tw(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,n,s,l){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");let{ids:f,coords:p,nodeSize:y}=this,x=[0,f.length-1,0],b=[];for(;x.length;){let I=x.pop()||0,S=x.pop()||0,D=x.pop()||0;if(S-D<=y){for(let V=D;V<=S;V++){let $=p[2*V],Y=p[2*V+1];$>=e&&$<=s&&Y>=n&&Y<=l&&b.push(f[V])}continue}let R=D+S>>1,L=p[2*R],F=p[2*R+1];L>=e&&L<=s&&F>=n&&F<=l&&b.push(f[R]),(I===0?e<=L:n<=F)&&(x.push(D),x.push(R-1),x.push(1-I)),(I===0?s>=L:l>=F)&&(x.push(R+1),x.push(S),x.push(1-I))}return b}within(e,n,s){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");let{ids:l,coords:f,nodeSize:p}=this,y=[0,l.length-1,0],x=[],b=s*s;for(;y.length;){let I=y.pop()||0,S=y.pop()||0,D=y.pop()||0;if(S-D<=p){for(let V=D;V<=S;V++)iA(f[2*V],f[2*V+1],e,n)<=b&&x.push(l[V]);continue}let R=D+S>>1,L=f[2*R],F=f[2*R+1];iA(L,F,e,n)<=b&&x.push(l[R]),(I===0?e-s<=L:n-s<=F)&&(y.push(D),y.push(R-1),y.push(1-I)),(I===0?e+s>=L:n+s>=F)&&(y.push(R+1),y.push(S),y.push(1-I))}return x}}function Tw(r,e,n,s,l,f){if(l-s<=n)return;let p=s+l>>1;nA(r,e,p,s,l,f),Tw(r,e,n,s,p-1,1-f),Tw(r,e,n,p+1,l,1-f)}function nA(r,e,n,s,l,f){for(;l>s;){if(l-s>600){let b=l-s+1,I=n-s+1,S=Math.log(b),D=.5*Math.exp(2*S/3),R=.5*Math.sqrt(S*D*(b-D)/b)*(I-b/2<0?-1:1);nA(r,e,n,Math.max(s,Math.floor(n-I*D/b+R)),Math.min(l,Math.floor(n+(b-I)*D/b+R)),f)}let p=e[2*n+f],y=s,x=l;for(yg(r,e,s,n),e[2*l+f]>p&&yg(r,e,s,l);y<x;){for(yg(r,e,y,x),y++,x--;e[2*y+f]<p;)y++;for(;e[2*x+f]>p;)x--}e[2*s+f]===p?yg(r,e,s,x):(x++,yg(r,e,x,l)),x<=n&&(s=x+1),n<=x&&(l=x-1)}}function yg(r,e,n,s){Iw(r,n,s),Iw(e,2*n,2*s),Iw(e,2*n+1,2*s+1)}function Iw(r,e,n){let s=r[e];r[e]=r[n],r[n]=s}function iA(r,e,n,s){let l=r-n,f=e-s;return l*l+f*f}i.$=or,i.A=cl,i.B=zs,i.C=Il,i.D=uf,i.E=ul,i.F=2,i.G=rg,i.H=bC,i.I=so,i.J=va,i.K=class extends Dv{},i.L=dl,i.M=Jo,i.N=Wu,i.O=qu,i.P=ot,i.Q=dm,i.R=Du,i.S=Bd,i.T=ow,i.U=Hd,i.V=Dv,i.W=fy,i.X=Vs,i.Y=Sd,i.Z=_c,i._=gc,i.a=function(r){return ar.API_CDN_URL_REGEX.test(r)},i.a$=Re,i.a0=hl,i.a1=$d,i.a2=Zu,i.a3=hm,i.a4=function(r){let e=r.value,n=[];if(!e)return n;let s=va(e);return s!=="string"?(n=n.concat([new Dv(r.key,e,`string expected, "${s}" found`)]),n):(cw(e,!0)||(n=n.concat([new Dv(r.key,e,`invalid url "${e}"`)])),n)},i.a5=Ee,i.a6=vy,i.a7=Ei,i.a8=Ke,i.a9=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return ci(r.expression.evaluate(e))}interpolate(r,e,n){return{x:kt(r.x,e.x,n),y:kt(r.y,e.y,n),z:kt(r.z,e.z,n),azimuthal:kt(r.azimuthal,e.azimuthal,n),polar:kt(r.polar,e.polar,n)}}},i.aA=Or,i.aB=v,i.aC=vs,i.aD=se,i.aE=Me,i.aF=function(r,e){let n={};for(let s=0;s<e.length;s++){let l=e[s];l in r&&(n[l]=r[l])}return n},i.aG=ee,i.aH=oe,i.aI=class{constructor(r){this.entries={},this.scheduler=r}request(r,e,n,s){let l=this.entries[r]=this.entries[r]||{callbacks:[]};if(l.result){let[f,p]=l.result;return this.scheduler?this.scheduler.add(()=>{s(f,p)},e):s(f,p),()=>{}}return l.callbacks.push(s),l.cancel||(l.cancel=n((f,p)=>{l.result=[f,p];for(let y of l.callbacks)this.scheduler?this.scheduler.add(()=>{y(f,p)},e):y(f,p);setTimeout(()=>delete this.entries[r],3e3)})),()=>{l.result||(l.callbacks=l.callbacks.filter(f=>f!==s),l.callbacks.length||(l.cancel(),delete this.entries[r]))}}},i.aJ=function(r,e,n){let s=JSON.stringify(r.request);return r.data&&(this.deduped.entries[s]={result:[null,r.data]}),this.deduped.request(s,{type:"parseTile",isSymbolTile:r.isSymbolTile,zoom:r.tileZoom},l=>{let f=Cu(r.request,(p,y,x,b)=>{p?l(p):y&&l(null,{vectorTile:n?void 0:new Kt.VectorTile(new ov(y)),rawData:y,cacheControl:x,expires:b})});return()=>{f.cancel(),l()}},e)},i.aK=function(r){Op++,Op>ks&&(r.getActor().send("enforceCacheSizeLimit",Xo),Op=0)},i.aL=function(r){return r<=1?1:Math.pow(2,Math.floor(Math.log(r)/Math.LN2))},i.aM=Vr,i.aN=YC,i.aO=nM,i.aP=XC,i.aQ=function(r,e){let n=document.createElement("video");n.muted=!0,n.onloadstart=function(){e(null,n)};for(let s=0;s<r.length;s++){let l=document.createElement("source");Db(r[s])||(n.crossOrigin="Anonymous"),l.src=r[s],n.appendChild(l)}return{cancel:()=>{}}},i.aR=wv,i.aS=function(r){return fetch(r).then(e=>e.arrayBuffer()).then(e=>VD(e,0,r))},i.aT=KM,i.aU=class{constructor(r,e,n,s){this.id=r,this.position=e!=null?new Z(e[0],e[1]):new Z(0,0),this.orientation=n??[0,0,0],this.nodes=s,this.uploaded=!1,this.aabb=new _n([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(r,e){if(Lt(r.matrix,e,r.matrix),r.meshes)for(let n of r.meshes){let s=_n.applyTransformFast(n.aabb,r.matrix);this.aabb.encapsulate(s)}if(r.children)for(let n of r.children)this._applyTransformations(n,r.matrix)}computeBoundsAndApplyParent(){let r=Se([]);for(let e of this.nodes)this._applyTransformations(e,r)}computeModelMatrix(r,e,n,s,l,f,p=!1){fM(this.matrix,this,r.transform,this.position,e,n,s,l,f,p)}upload(r){if(!this.uploaded){for(let e of this.nodes)hw(e,r);for(let e of this.nodes)Cv(e);this.uploaded=!0}}destroy(){for(let r of this.nodes)dw(r)}},i.aV=xt,i.aW=sg,i.aX=fe,i.aY=Te,i.aZ=Dc,i.a_=cr,i.aa=zn,i.ab=Yu,i.ac=_e,i.ad=ai,i.ae=Pr,i.af=ye,i.ag=El,i.ah=zc,i.ai=kt,i.aj=at,i.ak=pd,i.al=gn,i.am=In,i.an=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return function([n,s]){let l=ci([1,n,s]);return{x:l.x,y:l.y,z:l.z}}(r.expression.evaluate(e))}interpolate(r,e,n){return{x:kt(r.x,e.x,n),y:kt(r.y,e.y,n),z:kt(r.z,e.z,n)}}},i.ao=function(r,e,n=0,s=!0){let l=new ot(n,n),f=r.sub(l),p=e.add(l),y=[f,new ot(p.x,f.y),p,new ot(f.x,p.y)];return s&&y.push(f.clone()),y},i.ap=function(r,e){let n=[];for(let s=0;s<r.length;s++){let l=De(s-1,-1,r.length-1),f=De(s+1,-1,r.length-1),p=r[s],y=r[f],x=r[l].sub(p).unit(),b=y.sub(p).unit(),I=b.angleWithSep(x.x,x.y),S=x.add(b).unit().mult(-1*e/Math.sin(I/2));n.push(p.add(S))}return n},i.aq=kC,i.ar=Nc,i.as=function(r,e,n=0){return qn(((e.x-n)*r.scale-r.x)*at,(e.y*r.scale-r.y)*at,Ie(e.z,e.y))},i.at=Vi,i.au=bi,i.av=ii,i.aw=WD,i.ax=function(r){let e=1/0,n=1/0,s=-1/0,l=-1/0;for(let f of r)e=Math.min(e,f.x),n=Math.min(n,f.y),s=Math.max(s,f.x),l=Math.max(l,f.y);return{min:new ot(e,n),max:new ot(s,l)}},i.ay=ae,i.az=Lt,i.b=function(r){return ar.API_FONTS_REGEX.test(r)},i.b$=function(r,e,n){n*=.5;var s=e[0],l=e[1],f=e[2],p=e[3],y=Math.sin(n),x=Math.cos(n);return r[0]=s*x+l*y,r[1]=l*x-s*y,r[2]=f*x+p*y,r[3]=p*x-f*y,r},i.b0=Jd,i.b1=xv,i.b2=function(){$s.isLoading()||$s.isLoaded()||Tc()!=="deferred"||yy()},i.b3=ym,i.b4=dt,i.b5=Ef,i.b6=yn,i.b7=N1,i.b8=T1,i.b9=gt,i.bA=function(r,e){let{x:n,y:s}=r.point,l=SS(n,s,r.worldSize/r._pixelsPerMercatorPixel,0,0);return Lt(l,l,p1(Fa(e)))},i.bB=H,i.bC=function(r){return r[0]=0,r[1]=0,r[2]=0,r},i.bD=function(r,e){return Math.hypot(e[0]-r[0],e[1]-r[1],e[2]-r[2])},i.bE=yo,i.bF=er,i.bG=Bi,i.bH=ig,i.bI=To,i.bJ=G1,i.bK=function(r,e,n,s,l){let f=5*e+2;r.float32[f+0]=n,r.float32[f+1]=s,r.float32[f+2]=l},i.bL=vv,i.bM=ev,i.bN=Jr,i.bO=sr,i.bP=nD,i.bQ=lM,i.bR=aD,i.bS=lD,i.bT=$1,i.bU=CC,i.bV=X1,i.bW=Ew,i.bX=De,i.bY=pi,i.bZ=ca,i.b_=ua,i.ba=Gs,i.bb=sh,i.bc=xS,i.bd=Di,i.be=jm,i.bf=nw,i.bg=function(r,e){let n=zc(e.zoom);if(n===0)return Fa(r);let s=Hy(r),l=f1(s),f=se(s.getWest())*e.worldSize,p=se(s.getEast())*e.worldSize,y=oe(s.getNorth())*e.worldSize,x=oe(s.getSouth())*e.worldSize,b=[f,y,0],I=[p,y,0],S=[f,x,0],D=[p,x,0],R=It([],e.globeMatrix);return ai(b,b,R),ai(I,I,R),ai(S,S,R),ai(D,D,R),l[0]=Cl(l[0],S,n),l[1]=Cl(l[1],D,n),l[2]=Cl(l[2],I,n),l[3]=Cl(l[3],b,n),_n.fromPoints(l)},i.bh=Gy,i.bi=It,i.bj=Bm,i.bk=Cl,i.bl=th,i.bm=TO,i.bn=Cs,i.bo=hn,i.bp=Fv,i.bq=ov,i.br=Cu,i.bs=function(r,e){let n=[];for(let s in r)s in e||n.push(s);return n},i.bt=ve,i.bu=["type","source","source-layer","minzoom","maxzoom","filter","layout"],i.bv=Ls,i.bw=function(r){var e=new N(16);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],e},i.bx=Se,i.by=_o,i.bz=st,i.c=od,i.c$=nv,i.c0=ha,i.c1=wi,i.c2=function(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r[3]=e[3],r},i.c3=ds,i.c4=function(r,e,n,s,l){var f,p=1/Math.tan(e/2);return r[0]=p/n,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=p,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,l!=null&&l!==1/0?(r[10]=(l+s)*(f=1/(s-l)),r[14]=2*l*s*f):(r[10]=-1,r[14]=-2*s),r},i.c5=function(r,e,n,s,l,f,p){var y=1/(e-n),x=1/(s-l),b=1/(f-p);return r[0]=-2*y,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-2*x,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=2*b,r[11]=0,r[12]=(e+n)*y,r[13]=(l+s)*x,r[14]=(p+f)*b,r[15]=1,r},i.c6=he,i.c7=function(r,e,n){r[4*e+0]=n[0],r[4*e+1]=n[1],r[4*e+2]=n[2],r[4*e+3]=n[3]},i.c8=nf,i.c9=uh,i.cA=Iv,i.cB=id,i.cC=iM,i.cD=function(r){let e=iM(r,!0);return H([],[e[0],e[1],e[4],e[5]])},i.cE=sn,i.cF=Wn,i.cG=Yi,i.cH=function(r){let{x:e,y:n}=r.point,{lng:s,lat:l}=r._center;return SS(e,n,r.worldSize,s,l)},i.cI=Ms,i.cJ=Ae,i.cK=lf,i.cL=E,i.cM=function(r,e,n){let s=0;for(let l=0;l<2;++l)r[l]>0&&(s+=(r[l]-0)*(r[l]-0)),e[l]<0&&(s+=(0-e[l])*(0-e[l]));return s},i.cN=function(r){return r*r*r*r*r},i.cO=le,i.cP=45,i.cQ=rf,i.cR=function(r,e,n){let s=Math.sqrt(r*r+e*e+n*n),l=s>0?Math.acos(n/s)*vu:0,f=r!==0||e!==0?Math.atan2(-e,-r)*vu+90:0;return f<0&&(f+=360),[s,f,l]},i.cS=qn,i.cT=ci,i.cU=Oe,i.cV=Ui,i.cW=_n,i.cX=Qi,i.cY=function(r){return[Math.pow(r[0],1/2.2),Math.pow(r[1],1/2.2),Math.pow(r[2],1/2.2)]},i.cZ=cw,i.c_=function(r,e){return r.readFields(FF,{icons:[]},e)},i.ca=Ni,i.cb=_s,i.cc=Lc,i.cd=Z,i.ce=VC,i.cf=function(){var r=new N(4);return N!=Float32Array&&(r[1]=0,r[2]=0),r[0]=1,r[3]=1,r},i.cg=function(r,e,n){var s=e[0],l=e[1],f=e[2],p=e[3],y=Math.sin(n),x=Math.cos(n);return r[0]=s*x+f*y,r[1]=l*x+p*y,r[2]=s*-y+f*x,r[3]=l*-y+p*x,r},i.ch=function(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]&&r[3]===e[3]},i.ci=Wo,i.cj=function(r){return Math.hypot(r[0],r[1],r[2],r[3])},i.ck=Ps,i.cl=Rs,i.cm=vS,i.cn=hi,i.co=rM,i.cp=mh,i.cq=ES,i.cr=function(r,e,n,s,l,f,p,y,x){if(x.name==="globe")return ES(r,e,new mh(n,s,l),!1);let b=sg({z:n,x:s,y:l},x);return new _n([(f+b.x/b.scale)*e,e*(b.y/b.scale),p],[(f+b.x2/b.scale)*e,e*(b.y2/b.scale),y])},i.cs=function(r,e,n){return r[0]=Math.min(e[0],n[0]),r[1]=Math.min(e[1],n[1]),r[2]=Math.min(e[2],n[2]),r[3]=Math.min(e[3],n[3]),r},i.ct=function(r,e,n){return r[0]=Math.max(e[0],n[0]),r[1]=Math.max(e[1],n[1]),r[2]=Math.max(e[2],n[2]),r[3]=Math.max(e[3],n[3]),r},i.cu=function(r){let e=Math.round((r+45+360)%360/90)%4;return G[e]},i.cv=Be,i.cw=el,i.cx=T,i.cy=function(r){let e=Se(new Float64Array(16));Lt(e,r.pixelMatrix,r.globeMatrix);let n=[0,P,0],s=[0,k,0];return ai(n,n,e),ai(s,s,e),[n[0]>0&&n[0]<=r.width&&n[1]>0&&n[1]<=r.height&&!g1(r,new Z(r.center.lat,90)),s[0]>0&&s[0]<=r.width&&s[1]>0&&s[1]<=r.height&&!g1(r,new Z(r.center.lat,-90))]},i.cz=function(r,e){let{scale:n}=r.tileTransform,s=n*at/(r.tileSize*Math.pow(2,e.zoom-r.tileID.overscaledZ+r.tileID.canonical.z));return function(l,f,p){var y=f[1],x=f[2],b=f[3],I=p[0],S=p[1];return l[0]=f[0]*I,l[1]=y*I,l[2]=x*S,l[3]=b*S,l}(new Float32Array(4),e.inverseAdjustmentMatrix,[s,s])},i.d=function(r){return ar.API_TILEJSON_REGEX.test(r)},i.d$=Rm,i.d0=mf,i.d1=W1,i.d2=cd,i.d3=wl,i.d4=Oo,i.d5=Au,i.d6=Vt,i.d7=function(r){let e=r.indexOf(Qu);return e>=0?r.slice(0,e):r},i.d8=function(r){return r.indexOf(Qu)>=0},i.d9=function(r){let e=r.lastIndexOf(Qu);return e>=0?r.slice(e+1):""},i.dA=IS,i.dB=Zr,i.dC=wr,i.dD=256,i.dE=function(r,e){let n=[0,0,0];return ai(n,n,Gy(Fa(e.canonical))),ai(n,n,r),n},i.dF=r=>({u_matrix:new Lc(r),u_texsize:new _s(r),u_pixels_to_tile_units:new hh(r),u_device_pixel_ratio:new Ni(r),u_width_scale:new Ni(r),u_floor_width_scale:new Ni(r),u_image:new nf(r),u_units_to_pixels:new _s(r),u_tile_units_to_pixels:new Ni(r),u_alpha_discard_threshold:new Ni(r),u_trim_offset:new _s(r),u_trim_fade_range:new _s(r),u_trim_color:new rf(r),u_emissive_strength:new Ni(r),u_zbias_factor:new Ni(r),u_tile_to_meter:new Ni(r),u_ground_shadow_factor:new uh(r),u_pattern_transition:new Ni(r)}),i.dG=r=>({u_matrix:new Lc(r),u_pixels_to_tile_units:new hh(r),u_device_pixel_ratio:new Ni(r),u_width_scale:new Ni(r),u_floor_width_scale:new Ni(r),u_units_to_pixels:new _s(r),u_dash_image:new nf(r),u_gradient_image:new nf(r),u_image_height:new Ni(r),u_texsize:new _s(r),u_tile_units_to_pixels:new Ni(r),u_alpha_discard_threshold:new Ni(r),u_trim_offset:new _s(r),u_trim_fade_range:new _s(r),u_trim_color:new rf(r),u_emissive_strength:new Ni(r),u_zbias_factor:new Ni(r),u_tile_to_meter:new Ni(r),u_ground_shadow_factor:new uh(r)}),i.dH=r=>({u_camera_to_center_distance:new Ni(r),u_extrude_scale:new hh(r),u_device_pixel_ratio:new Ni(r),u_matrix:new Lc(r),u_inv_rot_matrix:new Lc(r),u_merc_center:new _s(r),u_tile_id:new uh(r),u_zoom_transition:new Ni(r),u_up_dir:new uh(r),u_emissive_strength:new Ni(r)}),i.dI=Sm,i.dJ=Vk,i.dK=MS,i.dL=(r,e,n,s,l,f)=>{let p=r.transform,y=p.projection.name==="globe",x;if(f.paint.get("circle-pitch-alignment")==="map")if(y){let I=IS(p.zoom,e.canonical)*p._pixelsPerMercatorPixel;x=Float32Array.from([I,0,0,I])}else x=p.calculatePixelsToTileUnitsMatrix(n);else x=new Float32Array([p.pixelsToGLUnits[0],0,0,p.pixelsToGLUnits[1]]);let b={u_camera_to_center_distance:r.transform.getCameraToCenterDistance(p.projection),u_matrix:r.translatePosMatrix(e.projMatrix,n,f.paint.get("circle-translate"),f.paint.get("circle-translate-anchor")),u_device_pixel_ratio:Zo.devicePixelRatio,u_extrude_scale:x,u_inv_rot_matrix:MO,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:f.paint.get("circle-emissive-strength")};if(y){b.u_inv_rot_matrix=s,b.u_merc_center=l,b.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],b.u_zoom_transition=zc(p.zoom);let I=l[0]*at,S=l[1]*at;b.u_up_dir=p.projection.upVector(new mh(0,0,0),I,S)}return b},i.dM=KD,i.dN=Yr,i.dO=(r,e,n,s,l,f,p,y,x,b)=>{let I=r.transform,S=I.pitch<15?ZD(.07,.7,ae((14-I.zoom)/5,0,1)):.07,D=n.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:YD(r,e,n,s),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:I.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:l,u_width_scale:f,u_floor_width_scale:p,u_image:0,u_tile_units_to_pixels:XD(e,I),u_units_to_pixels:[1/I.pixelsToGLUnits[0],1/I.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:y,u_trim_fade_range:n.paint.get("line-trim-fade-range"),u_trim_color:n.paint.get("line-trim-color").toPremultipliedRenderColor(D?null:n.lut).toArray01(),u_emissive_strength:n.paint.get("line-emissive-strength"),u_zbias_factor:S,u_tile_to_meter:Oe(e.tileID.canonical,0),u_ground_shadow_factor:x,u_pattern_transition:b}},i.dP=(r,e,n,s,l,f,p,y,x,b)=>{let I=r.transform,S=I.calculatePixelsToTileUnitsMatrix(e),D=n.paint.get("line-trim-color-use-theme").constantOr("default")==="none",R=I.pitch<15?ZD(.07,.7,ae((14-I.zoom)/5,0,1)):.07;return{u_matrix:YD(r,e,n,s),u_pixels_to_tile_units:S,u_device_pixel_ratio:f,u_width_scale:p,u_floor_width_scale:y,u_units_to_pixels:[1/I.pixelsToGLUnits[0],1/I.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:l,u_texsize:JD(n)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:XD(e,r.transform),u_alpha_discard_threshold:0,u_trim_offset:x,u_trim_fade_range:n.paint.get("line-trim-fade-range"),u_trim_color:n.paint.get("line-trim-color").toPremultipliedRenderColor(D?null:n.lut).toArray01(),u_emissive_strength:n.paint.get("line-emissive-strength"),u_zbias_factor:R,u_tile_to_meter:Oe(e.tileID.canonical,0),u_ground_shadow_factor:b}},i.dQ=rt,i.dR=Vm,i.dS=Ie,i.dT=wO,i.dU=Qy,i.dV=bD,i.dW=Vc,i.dX=450,i.dY=7,i.dZ=bF,i.d_=mn,i.da=function(r){let e=[],n=r.id;return n===void 0&&e.push({message:`layers.${n}: missing required property "id"`}),r.render===void 0&&e.push({message:`layers.${n}: missing required method "render"`}),r.renderingMode&&r.renderingMode!=="2d"&&r.renderingMode!=="3d"&&e.push({message:`layers.${n}: property "renderingMode" must be either "2d" or "3d"`}),e},i.db=function(r,e,n,s){return r.type==="custom"?new wF(r,e):new OF[r.type](r,e,n,s)},i.dc=zt,i.dd=function(r){let e=r.indexOf(Qu);return e>=0?r.slice(e+1):""},i.de=class extends Ef{constructor(r,e){super(r._vectorTileFeature,r._z,r._x,r._y,r.id),r.state&&(this.state=Object.assign({},r.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=r.source,this.sourceLayer=r.sourceLayer,this.layer=r.layer)}toJSON(){let r=super.toJSON();return r.target=this.target,r.namespace=this.namespace,r}},i.df=Ud,i.dg=ic,i.dh=function(r){return r({pluginStatus:Br,pluginURL:Hs}),Ud.on("pluginStateChange",r),r},i.di=By,i.dj=class extends qs{constructor(r){super(r),this.current=km}set(r,e,n){if(this.fetchUniformLocation(r,e)){for(let s=0;s<9;s++)if(n[s]!==this.current[s]){this.current=n,this.gl.uniformMatrix3fv(this.location,!1,n);break}}}},i.dk=X,i.dl=function(r,e,n){let s=zc(n.zoom),l=r.style.map._antialias,f=r.terrain&&r.terrain.exaggeration()>0;return s===0&&!l&&!f},i.dm=function(r){let e=r.pixelsPerMeter,n=e/he(1,r.center.lat),s=Se(new Float64Array(16));return hn(s,s,[r.point.x,r.point.y,0]),sn(s,s,[n,n,e]),Float32Array.from(s)},i.dn=Hy,i.dp=function(r){let e=Be-5;r=ae(r,-80.051129,e)/e*90;let n=Math.pow(Math.abs(Math.sin(gn(r))),3);return Math.round(n*(O.length-1))},i.dq=function(r,e,n,s){let l=e.getNorth(),f=e.getSouth(),p=e.getWest(),y=e.getEast(),x=1<<r.z,b=y-p,I=l-f,S=b/M,D=-I/O[n],R=[0,S,0,D,0,0,l,p,0];if(r.z>0){let L=180/s;Pe(R,R,[L/b+1,0,0,0,L/I+1,0,-.5*L/S,.5*L/D,1])}return R[2]=x,R[5]=r.x,R[8]=r.y,R},i.dr=Fa,i.ds=function(r,e,n){let s=Se(new Float64Array(16)),l=(e/(1<<r)-.5)*Math.PI*2;return fr(s,n.globeMatrix,l),Float32Array.from(s)},i.dt=class{isDataAvailableAtPoint(r){let e=this._source();if(this.isUsingMockSource()||!e||r.y<0||r.y>1)return!1;let n=e.getSource().maxzoom,s=1<<n,l=Math.floor(r.x),f=Math.floor((r.x-l)*s),p=Math.floor(r.y*s),y=this.findDEMTileFor(new Vr(n,l,n,f,p));return!(!y||!y.dem)}getAtPointOrZero(r,e=0){return this.getAtPoint(r,e)||0}getAtPoint(r,e,n=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);let s=this._source();if(!s||r.y<0||r.y>1)return e;let l=s.getSource().maxzoom,f=1<<l,p=Math.floor(r.x),y=r.x-p,x=new Vr(l,p,l,Math.floor(y*f),Math.floor(r.y*f)),b=this.findDEMTileFor(x);if(!b||!b.dem)return e;let I=b.dem,S=1<<b.tileID.canonical.z,D=(y*S-b.tileID.canonical.x)*I.dim,R=(r.y*S-b.tileID.canonical.y)*I.dim,L=Math.floor(D),F=Math.floor(R);return(n?this.exaggeration():1)*kt(kt(I.get(L,F),I.get(L,F+1),R-F),kt(I.get(L+1,F),I.get(L+1,F+1),R-F),D-L)}getAtTileOffset(r,e,n){let s=1<<r.canonical.z;return this.getAtPointOrZero(new _e(r.wrap+(r.canonical.x+e/at)/s,(r.canonical.y+n/at)/s))}getAtTileOffsetFunc(r,e,n,s){return l=>{let f=this.getAtTileOffset(r,l.x,l.y),p=s.upVector(r.canonical,l.x,l.y);return pi(p,p,f*s.upVectorScale(r.canonical,e,n).metersToTile),p}}getForTilePoints(r,e,n,s){if(this.isUsingMockSource())return!1;let l=vf.create(this,r,s);return!!l&&(e.forEach(f=>{f[2]=this.exaggeration()*l.getElevationAt(f[0],f[1],n)}),!0)}getMinMaxForTile(r){if(this.isUsingMockSource())return null;let e=this.findDEMTileFor(r);if(!e||!e.dem)return null;let n=e.dem.tree,s=e.tileID,l=1<<r.canonical.z-s.canonical.z,f=r.canonical.x/l-s.canonical.x,p=r.canonical.y/l-s.canonical.y,y=0;for(let x=0;x<r.canonical.z-s.canonical.z&&!n.leaves[y];x++){f*=2,p*=2;let b=2*Math.floor(p)+Math.floor(f);y=n.childOffsets[y]+b,f%=1,p%=1}return{min:this.exaggeration()*n.minimums[y],max:this.exaggeration()*n.maximums[y]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(r,e,n){throw new Error("Pure virtual method called.")}pointCoordinate(r){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(r){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){let r=this.visibleDemTiles;if(r.length===0)return null;let e=!1,n=Number.MAX_VALUE,s=Number.MIN_VALUE;for(let l of r){let f=this.getMinMaxForTile(l.tileID);f&&(n=Math.min(n,f.min),s=Math.max(s,f.max),e=!0)}return e?{min:n,max:s}:null}},i.du=BS,i.dv=Uy,i.dw=function(r,e){return[Math.pow(r[0],2.2)*e,Math.pow(r[1],2.2)*e,Math.pow(r[2],2.2)*e]},i.dx=ce,i.dy=function(r,e){var n=Math.sin(e),s=Math.cos(e);return r[0]=s,r[1]=n,r[2]=0,r[3]=-n,r[4]=s,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},i.dz=Zl,i.e=ar,i.e$=JM,i.e0=256,i.e1=p1,i.e2=gs,i.e3=fr,i.e4=function(r,e){return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[4],r[4]=e[5],r[5]=e[6],r[6]=e[8],r[7]=e[9],r[8]=e[10],r},i.e5=Pa,i.e6=oh,i.e7=ly,i.e8=function(r,e,n,s,l){return ae((r-e)/(n-e)*(l-s)+s,s,l)},i.e9=da,i.eA=function(r,e,n){return r[0]=e[0]/n[0],r[1]=e[1]/n[1],r[2]=e[2]/n[2],r},i.eB=Xl,i.eC=B,i.eD=ql,i.eE=function(r,e,n,s){return r[0]=e,r[1]=n,r[2]=s,r},i.eF=function([r,e,n]){let s=Math.hypot(r,e,n),l=Math.atan2(r,n),f=.5*Math.PI-Math.acos(-e/s);return new Z(Ae(l),Ae(f))},i.eG=_u,i.eH=aw,i.eI=function(r){let e=r.navigator?r.navigator.userAgent:null;return!!function(n){if(Ri==null){let s=n.navigator?n.navigator.userAgent:null;Ri=!!n.safari||!(!s||!(/\b(iPad|iPhone|iPod)\b/.test(s)||s.match("Safari")&&!s.match("Chrome")))}return Ri}(r)&&!(!e||!(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},i.eJ=function(r,e){Xo=r,ks=e},i.eK=g1,i.eL=DS,i.eM=function(r){let e=[0,0,0],n=Se(new Float64Array(16));return Lt(n,r.pixelMatrix,r.globeMatrix),ai(e,e,n),new ot(e[0],e[1])},i.eN=function(){let r=Km;r&&(r.isPreloaded()&&r.numActive()===1?(r.release(R1),Km=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},i.eO=function(){nv().acquire(R1)},i.eP=Tc,i.eQ=function(r,e,n=!1){if(Br===lo.deferred||Br===lo.loading||Br===lo.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");Hs=Zo.resolveURL(r),Br=lo.deferred,_m=e,jd(),n||yy()},i.eR=function(r){hf=Zo.resolveURL(r),df||(df=new uf(nv(),new ul)),df.broadcast("setMeshoptUrl",hf)},i.eS=OD,i.eT=function(r){L1=Zo.resolveURL(r),df||(df=new uf(nv(),new ul)),df.broadcast("setDracoUrl",L1)},i.eU=LD,i.eV=Ym,i.eW=function(r){let e=ol();if(!e)return;let n=e.delete(Os);r&&n.then(()=>r()).catch(r)},i.eX=tv,i.eY=pt,i.eZ=Bc,i.e_=Xs,i.ea=function(r,e){var n=e[0],s=e[1],l=e[2],f=e[3],p=e[4],y=e[5],x=e[6],b=e[7],I=e[8],S=I*p-y*b,D=-I*f+y*x,R=b*f-p*x,L=n*S+s*D+l*R;return L?(r[0]=S*(L=1/L),r[1]=(-I*s+l*b)*L,r[2]=(y*s-l*p)*L,r[3]=D*L,r[4]=(I*n-l*x)*L,r[5]=(-y*n+l*f)*L,r[6]=R*L,r[7]=(-b*n+s*x)*L,r[8]=(p*n-s*f)*L,r):null},i.eb=Wl,i.ec=We,i.ed=lw,i.ee=function(r,e){if(r===e){var n=e[1],s=e[2],l=e[3],f=e[6],p=e[7],y=e[11];r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=n,r[6]=e[9],r[7]=e[13],r[8]=s,r[9]=f,r[11]=e[14],r[12]=l,r[13]=p,r[14]=y}else r[0]=e[0],r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=e[1],r[5]=e[5],r[6]=e[9],r[7]=e[13],r[8]=e[2],r[9]=e[6],r[10]=e[10],r[11]=e[14],r[12]=e[3],r[13]=e[7],r[14]=e[11],r[15]=e[15];return r},i.ef=ji,i.eg=[1,1,1],i.eh=class{constructor(r,e,n,s){this.context=r,this.format=s,this.size=n,this.texture=r.gl.createTexture();let[l,f,p]=this.size,{gl:y}=r;y.bindTexture(y.TEXTURE_3D,this.texture),r.pixelStoreUnpackFlipY.set(!1),r.pixelStoreUnpack.set(1),r.pixelStoreUnpackPremultiplyAlpha.set(!1),y.texImage3D(y.TEXTURE_3D,0,this.format,l,f,p,0,iw(this.format),rw(this.format),e.data)}bind(r,e){let{context:n}=this,{gl:s}=n;s.bindTexture(s.TEXTURE_3D,this.texture),r!==this.minFilter&&(s.texParameteri(s.TEXTURE_3D,s.TEXTURE_MAG_FILTER,r),s.texParameteri(s.TEXTURE_3D,s.TEXTURE_MIN_FILTER,r),this.minFilter=r),e!==this.wrapS&&(s.texParameteri(s.TEXTURE_3D,s.TEXTURE_WRAP_S,e),s.texParameteri(s.TEXTURE_3D,s.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){let{gl:r}=this.context;r.deleteTexture(this.texture),this.texture=null}},i.ei=vf,i.ej=function(r,e,n,s){var l=new N(4);return l[0]=r,l[1]=e,l[2]=n,l[3]=s,l},i.ek=Lr,i.el=function(r,e,n,s){var l=e[0],f=e[1],p=e[2],y=e[3];return r[0]=l+s*(n[0]-l),r[1]=f+s*(n[1]-f),r[2]=p+s*(n[2]-p),r[3]=y+s*(n[3]-y),r},i.em=yf,i.en=Ra,i.eo=Sl,i.ep=function(r,e,n,s,l,f,p,y,x,b,I,S,D,R,L,F){var V=new N(16);return V[0]=r,V[1]=e,V[2]=n,V[3]=s,V[4]=l,V[5]=f,V[6]=p,V[7]=y,V[8]=x,V[9]=b,V[10]=I,V[11]=S,V[12]=D,V[13]=R,V[14]=L,V[15]=F,V},i.eq=U,i.er=Yd,i.es=Mm,i.et=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new ot(1/0,1/0),max:new ot(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(r,e=!1){let n=rD(new ot(0,0),new ot(at,at),r),s=[];if(e&&!S1(n,this._globalClipBounds))return s;for(let l of this._activeRegions){if(l.hiddenByOverlap||!S1(n,l))continue;let f=ik(l.min,l.max,r);s.push({min:f.min,max:f.max,sourceId:this._sourceIds[l.priority],footprint:l.footprint,footprintTileId:l.tileId,order:l.order,clipMask:l.clipMask,clipScope:l.clipScope})}return s}setSources(r){this._setSources(r.map(e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{let n=[];for(let s of e.cache.getVisibleCoordinates()){let l=e.cache.getTile(s).buckets[e.layer];l&&l.updateFootprints(s.toUnwrapped(),n)}return n},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope})))}_addSource(r){let e=r.getFootprints();if(e.length===0)return;let n=r.getOrder(),s=r.getClipMask(),l=r.getClipScope();for(let f of e){if(!f.footprint)continue;let p=rD(f.footprint.min,f.footprint.max,f.id);this._activeRegions.push({min:p.min,max:p.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:f.id,footprint:f.footprint,order:n,clipMask:s,clipScope:l})}this._sourceIds.push(r.getSourceId())}_computeReplacement(){this._activeRegions.sort((e,n)=>e.priority-n.priority||Ky(e.min,n.min)||Ky(e.max,n.max)||e.order-n.order||e.clipMask-n.clipMask||function(s,l){let f=(p,y)=>p+y;return s.length-l.length||s.reduce(f,"").localeCompare(l.reduce(f,""))}(e.clipScope,n.clipScope));let r=this._activeRegions.length!==this._prevRegions.length;if(!r){let e=0;for(;!r&&e!==this._activeRegions.length;){let n=this._activeRegions[e],s=this._prevRegions[e];r=n.priority!==s.priority||!iD(n,s)||n.order!==s.order||n.clipMask!==s.clipMask||!Ls(n.clipScope,s.clipScope),++e}}if(r){++this._updateTime;for(let n of this._activeRegions)n.order!==Yy&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,n.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,n.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,n.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,n.max.y));let e=n=>{let s=this._activeRegions;if(n>=s.length)return n;let l=s[n].priority;for(;n<s.length&&s[n].priority===l;)++n;return n};if(this._sourceIds.length>1){let n=0,s=e(n);for(;n!==s;){let l=n,f=n;for(;l!==s;){let p=this._activeRegions[l];p.hiddenByOverlap=!1;for(let y=0;y<f;y++){let x=this._activeRegions[y];if(!x.hiddenByOverlap&&p.order===Yy&&S1(p,x)&&(p.hiddenByOverlap=sD(p.footprint,p.tileId,x.footprint,x.tileId),p.hiddenByOverlap))break}++l}n=s,s=e(n)}}}}_setSources(r){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=r.length-1;e>=0;e--)this._addSource(r[e]);this._computeReplacement()}},i.eu=Yy,i.ev=class{constructor(r){this._createGrid(r),this._createPoles(r)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(let r of this._poleSegments)r.destroy();for(let r of this._gridSegments)r.withSkirts.destroy(),r.withoutSkirts.destroy()}_fillGridMeshWithLods(r,e){let n=new Gs,s=new cr,l=[],f=r+1+2,p=e[0]+1,y=e[0]+1+(1+e.length),x=(b,I,S)=>{let D=b===f-1?b-2:b===0?b:b-1;return D+=S?24575:0,[D,I]};for(let b=0;b<f;++b)n.emplaceBack(...x(b,0,!0));for(let b=0;b<p;++b)for(let I=0;I<f;++I)n.emplaceBack(...x(I,b,(I===0||I===f-1)&&!0));for(let b=0;b<e.length;++b){let I=e[b];for(let S=0;S<f;++S)n.emplaceBack(...x(S,I,!0))}for(let b=0;b<e.length;++b){let I=s.length,S=e[b]+1+2,D=new cr;for(let F=0;F<S-1;F++){let V=F===S-2,$=V?f*(y-e.length+b-F):f;for(let Y=0;Y<f-1;Y++){let K=F*f+Y;F===0||V||Y===0||Y===f-2?(D.emplaceBack(K+1,K,K+$),D.emplaceBack(K+$,K+$+1,K+1)):(s.emplaceBack(K+1,K,K+$),s.emplaceBack(K+$,K+$+1,K+1))}}let R=Di.simpleSegment(0,I,n.length,s.length-I);for(let F=0;F<D.uint16.length;F+=3)s.emplaceBack(D.uint16[F],D.uint16[F+1],D.uint16[F+2]);let L=Di.simpleSegment(0,I,n.length,s.length-I);l.push({withoutSkirts:R,withSkirts:L})}return{vertices:n,indices:s,segments:l}}_createGrid(r){let e=this._fillGridMeshWithLods(M,O);this._gridSegments=e.segments,this._gridBuffer=r.createVertexBuffer(e.vertices,xS.members),this._gridIndexBuffer=r.createIndexBuffer(e.indices,!0)}_createPoles(r){let e=new cr;for(let p=0;p<=M;p++)e.emplaceBack(0,p+1,p+2);this._poleIndexBuffer=r.createIndexBuffer(e,!0);let n=new Pa,s=new Pa,l=new Pa,f=new Pa;this._poleSegments=[];for(let p=0,y=0;p<E;p++){let x=360/(1<<p);n.emplaceBack(0,-v,0,.5,0),s.emplaceBack(0,-v,0,.5,1),l.emplaceBack(0,-v,0,.5,.5),f.emplaceBack(0,-v,0,.5,.5);for(let b=0;b<=M;b++){let I=b/M,S=0,D=kt(0,x,I),[R,L,F]=j(DO,CO,D,v);n.emplaceBack(R,L,F,I,S),s.emplaceBack(R,L,F,I,1-S);let V=gn(D);I=.5+.5*Math.sin(V),S=.5+.5*Math.cos(V),l.emplaceBack(R,L,F,I,S),f.emplaceBack(R,L,F,I,1-S)}this._poleSegments.push(Di.simpleSegment(y,0,66,64)),y+=66}this._poleNorthVertexBuffer=r.createVertexBuffer(n,jy,!1),this._poleSouthVertexBuffer=r.createVertexBuffer(s,jy,!1),this._texturedPoleNorthVertexBuffer=r.createVertexBuffer(l,jy,!1),this._texturedPoleSouthVertexBuffer=r.createVertexBuffer(f,jy,!1)}getGridBuffers(r,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[r].withSkirts:this._gridSegments[r].withoutSkirts]}getPoleBuffers(r,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[r]]}},i.ew=ie,i.ex=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},i.ey=pe,i.ez=we,i.f=function(r){return btoa(encodeURIComponent(r).replace(/%([0-9A-F]{2})/g,(e,n)=>String.fromCharCode(+("0x"+n))))},i.f0=QM,i.f1=$D,i.f2=on,i.f3="hd_road_elevation",i.f4=Eo,i.f5=wt,i.f6=_h,i.f7=q1,i.f8=vh,i.f9=function(r,e,n,s,l,f,p,y=1,x,b,I){r.createArrays(),r.tilePixelRatio=at/(512*r.overscaling),r.compareText={},r.iconsNeedLinear=!1;let S=r.layers[0].layout,D=r.layers[0]._unevaluatedLayout._values,R={};R.scaleFactor=y,R.textSizeScaleRange=S.get("text-size-scale-range"),R.iconSizeScaleRange=S.get("icon-size-scale-range");let[L,F]=R.textSizeScaleRange,[V,$]=R.iconSizeScaleRange;R.textScaleFactor=ae(R.scaleFactor,L,F),R.iconScaleFactor=ae(R.scaleFactor,V,$);let Y=D["text-size"],K=D["icon-size"];if(r.textSizeData.kind==="composite"){let{minZoom:de,maxZoom:ge}=r.textSizeData;R.compositeTextSizes=[Y.possiblyEvaluate(new zn(de,{worldview:I}),f),Y.possiblyEvaluate(new zn(ge,{worldview:I}),f)]}if(r.iconSizeData.kind==="composite"){let{minZoom:de,maxZoom:ge}=r.iconSizeData;R.compositeIconSizes=[K.possiblyEvaluate(new zn(de,{worldview:I}),f),K.possiblyEvaluate(new zn(ge,{worldview:I}),f)]}R.layoutTextSize=Y.possiblyEvaluate(new zn(p+1,{worldview:I}),f),R.layoutIconSize=K.possiblyEvaluate(new zn(p+1,{worldview:I}),f),R.textMaxSize=Y.possiblyEvaluate(new zn(18,{worldview:I}),f);let z=S.get("symbol-placement"),W=S.get("text-rotation-alignment")==="map"&&z!=="point",J=S.get("text-size"),te=!1,me=[];for(let de of r.features){let ge=S.get("text-font").evaluate(de,{},f).join(","),xe=J.evaluate(de,{},f)*R.textScaleFactor,ke=R.layoutTextSize.evaluate(de,{},f)*R.textScaleFactor,Xe=R.layoutIconSize.evaluate(de,{},f)*R.iconScaleFactor,He={horizontal:{},vertical:void 0},Ze=de.text,Ye,Ne=[0,0];if(Ze){let Ft=Ze.toString(),Gt=S.get("text-letter-spacing").evaluate(de,{},f)*sr,$t=S.get("text-line-height").evaluate(de,{},f)*sr,tn=Qb(Ft)?Gt:0,Xt=S.get("text-anchor").evaluate(de,{},f),nn=S.get("text-variable-anchor");if(!nn){let ze=S.get("text-radial-offset").evaluate(de,{},f);if(ze)Ne=CC(Xt,[ze*sr,Z1]);else{let it=S.get("text-offset").evaluate(de,{},f);Ne=[it[0]*sr,it[1]*sr]}}let Cn=W?"center":S.get("text-justify").evaluate(de,{},f),Qn=z==="point",Q=Qn?S.get("text-max-width").evaluate(de,{},f)*sr:1/0,ne=ze=>{r.allowVerticalPlacement&&Ku(Ft)&&(He.vertical=H1(Ze,e,n,l,ge,Q,$t,Xt,ze,tn,Ne,To.vertical,!0,ke,xe,x))};if(!W&&nn){let ze=Cn==="auto"?nn.map(ut=>X1(ut)):[Cn],it=!1;for(let ut=0;ut<ze.length;ut++){let lt=ze[ut];if(!He.horizontal[lt])if(it)He.horizontal[lt]=He.horizontal[0];else{let _t=H1(Ze,e,n,l,ge,Q,$t,"center",lt,tn,Ne,To.horizontal,!1,ke,xe,x);_t&&(He.horizontal[lt]=_t,it=_t.positionedLines.length===1)}}ne("left")}else{if(Cn==="auto"&&(Cn=X1(Xt)),Qn||S.get("text-writing-mode").indexOf("horizontal")>=0||!Ku(Ft)){let ze=H1(Ze,e,n,l,ge,Q,$t,Xt,Cn,tn,Ne,To.horizontal,!1,ke,xe,x);ze&&(He.horizontal[Cn]=ze)}ne(Qn?"left":Cn)}}let qe,Le,Fe,Qe,tt,Dt,vt=!1,ct=S.get("icon-text-fit").evaluate(de,{},f);if(de.icon&&de.icon.hasPrimary()){let Ft=AC(de.icon,r.iconSizeData,D["icon-size"],f,r.zoom,de,x,R.iconScaleFactor,I);qe=Ft.iconPrimary,Fe=Ft.iconSecondary;let Gt=qe.toString();if(Le=s.get(Gt),Le&&(tt=S.get("icon-offset").evaluate(de,{},f),Dt=S.get("icon-anchor").evaluate(de,{},f),Ye=Kk(l.get(Gt),Fe?l.get(Fe.toString()):void 0,tt,Dt),vt=Le.sdf,r.sdfIcons===void 0?r.sdfIcons=Le.sdf:r.sdfIcons!==Le.sdf&&qt("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Le.pixelRatio!==r.pixelRatio||S.get("icon-rotate").constantOr(1)!==0)&&(r.iconsNeedLinear=!0)),Fe){let $t=Fe.toString();Qe=s.get($t)}}te=te||!(!de.icon||!de.icon.hasSecondary());let Je=Y1(He.horizontal)||He.vertical;r.iconsInText||(r.iconsInText=!!Je&&Je.iconsInText);let jt=ke*R.textScaleFactor/sr,{defaultShapedIcon:yt,verticallyShapedIcon:bt}=aF(r,Ye,S,de,f,He,jt,tt,ct);ct!=="none"&&Ye&&(dC(Ye)||fC(Ye))&&(hv(0,Le,qe,Ye,yt,ct,b,s,l),hv(0,Qe,Fe,Ye,yt,ct,b,s,l),bt&&(hv(0,Le,qe,Ye,bt,ct,b,s,l),hv(0,Qe,Fe,Ye,bt,ct,b,s,l))),Ye=yt,me.push({feature:de,shapedTextOrientations:He,shapedText:Je,shapedIcon:Ye,iconPrimary:qe,iconSecondary:Fe,iconOffset:tt,iconAnchor:Dt,verticallyShapedIcon:bt,layoutTextSize:ke,layoutIconSize:Xe,textOffset:Ne,isSDFIcon:vt,iconTextFit:ct})}return{featureData:me,sizes:R,hasAnySecondaryIcon:te,textAlongLine:W,symbolPlacement:z}},i.fa=wC,i.fb=function(r,e,n,s,l,f,p,y,x,b){let{featureData:I,hasAnySecondaryIcon:S,sizes:D,textAlongLine:R,symbolPlacement:L}=e;for(let F of I){let{shapedIcon:V,verticallyShapedIcon:$,feature:Y,shapedTextOrientations:K,shapedText:z,layoutTextSize:W,textOffset:J,isSDFIcon:te,iconPrimary:me,iconSecondary:de,iconTextFit:ge,iconOffset:xe}=F;RC(V,b.iconPositions,me,de),RC($,b.iconPositions,me,de),sF(K,b.iconPositions),oF(me,de,b.iconPositions),(z||V)&&lF(r,Y,K,V,$,x,D,W,0,J,te,s,l,p,y,S,ge,xe,R,L)}n&&r.generateCollisionDebugBuffers(f,r.collisionBoxArray,D.textScaleFactor)},i.fc=Kt,i.fd=kv,i.fe=il,i.ff=Ht,i.fg=rC,i.fh=ma,i.fi=function(r){let e=0;if(new Uint32Array(r,0,1)[0]!==FD){let n=new Uint32Array(r,0,7),[,,s,l,f,p]=n;e=n.byteLength+l+f+p+f,(s!==r.byteLength||e>=r.byteLength)&&qt("Invalid b3dm header information.")}return VD(r,e)},i.fj=function(r,e){let n=KM(r);for(let s of n){for(let l of s.meshes)RN(l);s.lights&&(s.lightMeshIndex=s.meshes.length,s.meshes.push(PN(s.lights,e)))}return n},i.fk=Mv,i.fl=An,i.fm=RD,i.fn=$s,i.fo=lo,i.fp=function(r){tc(),fs?.then(e=>{e.keys().then(n=>{for(let s=0;s<n.length-r;s++)e.delete(n[s]).catch(l=>qt(l.message))}).catch(n=>qt(n.message))}).catch(e=>qt(e.message))},i.g=function(r,e){return ic(Ce(r,{method:"GET"}),e)},i.h=Ce,i.i=function(r){return ar.API_STYLE_REGEX.test(r)&&!od(r)},i.j=function(r){return r.indexOf("mapbox:")===0},i.k=ga,i.l=kp,i.m=function(r){return decodeURIComponent(atob(r).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))},i.n=function(r,e){return ic(Ce(r,{type:"json"}),e)},i.o=Fp,i.p=function(r,e){return ic(Ce(r,{method:"POST"}),e)},i.q=Zo,i.r=pr,i.s=function(r){try{let e=self[r];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}},i.t=ld,i.u=function(){return function r(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,r)}()},i.v=function(r){return!!r&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(r)},i.w=qt,i.x=function(){return P1||(P1=new tv),P1},i.y=yw,i.z=dd}),g(["./shared"],function(i){function A(Ae){let G=Ae?Ae.url.toString():void 0;return G?performance.getEntriesByName(G):[]}function N(Ae){if(typeof Ae=="number"||typeof Ae=="boolean"||typeof Ae=="string"||Ae==null)return JSON.stringify(Ae);if(Array.isArray(Ae)){let X="[";for(let ie of Ae)X+=`${N(ie)},`;return`${X}]`}let G="{";for(let X of Object.keys(Ae).sort())G+=`${X}:${N(Ae[X])},`;return`${G}}`}function H(Ae){let G="";for(let X of i.bu)G+=`/${N(Ae[X])}`;return G}class ce{constructor(G){this.keyCache={},this._layers={},this._layerConfigs={},G&&this.replace(G)}replace(G,X){this._layerConfigs={},this._layers={},this.update(G,[],X)}update(G,X,ie){this._options=ie;for(let ae of G)this._layerConfigs[ae.id]=ae,(this._layers[ae.id]=i.db(ae,this.scope,null,this._options)).compileFilter(ie),this.keyCache[ae.id]&&delete this.keyCache[ae.id];for(let ae of X)delete this.keyCache[ae],delete this._layerConfigs[ae],delete this._layers[ae];this.familiesBySource={};let pe=function(ae,ye){let De={};for(let Ce=0;Ce<ae.length;Ce++){let $e=ae[Ce],Re=ye&&ye[$e.id];Re||($e.type==="symbol"?Re=$e.id:(Re=H($e),$e.type==="line"&&$e.paint&&function xt(wt){return typeof wt=="string"&&wt==="line-progress"||(Array.isArray(wt)?wt.some(xt):!(!wt||typeof wt!="object")&&Object.values(wt).some(xt))}($e.paint["line-width"])&&(Re+=`/${N($e.paint["line-width"])}`))),ye&&(ye[$e.id]=Re);let rt=De[Re];rt||(rt=De[Re]=[]),rt.push($e)}let ve=[];for(let Ce in De)ve.push(De[Ce]);return ve}(Object.values(this._layerConfigs),this.keyCache);for(let ae of pe){let ye=ae.map(rt=>this._layers[rt.id]),De=ye[0];if(De.visibility==="none")continue;let ve=De.source||"",Ce=this.familiesBySource[ve];Ce||(Ce=this.familiesBySource[ve]={});let $e=De.sourceLayer||"_geojsonTileLayer",Re=Ce[$e];Re||(Re=Ce[$e]=[]),Re.push(ye)}}}let be=1*i.e_;class Pe{constructor(G){let X={},ie=[];for(let De in G){let ve=G[De],Ce=X[De]={};for(let $e in ve.glyphs){let Re=ve.glyphs[+$e];if(!Re||Re.bitmap.width===0||Re.bitmap.height===0)continue;let rt=Re.metrics.localGlyph?be:1,xt={x:0,y:0,w:Re.bitmap.width+2*rt,h:Re.bitmap.height+2*rt};ie.push(xt),Ce[$e]=xt}}let{w:pe,h:ae}=i.H(ie),ye=new i.eZ({width:pe||1,height:ae||1});for(let De in G){let ve=G[De];for(let Ce in ve.glyphs){let $e=ve.glyphs[+Ce];if(!$e||$e.bitmap.width===0||$e.bitmap.height===0)continue;let Re=X[De][Ce],rt=$e.metrics.localGlyph?be:1;i.eZ.copy($e.bitmap,ye,{x:0,y:0},{x:Re.x+rt,y:Re.y+rt},$e.bitmap)}}this.image=ye,this.positions=X}}i.eY(Pe,"GlyphAtlas");class st{constructor(G){this.tileID=new i.aM(G.tileID.overscaledZ,G.tileID.wrap,G.tileID.canonical.z,G.tileID.canonical.x,G.tileID.canonical.y),this.tileZoom=G.tileZoom,this.uid=G.uid,this.zoom=G.zoom,this.lut=G.lut,this.canonical=G.tileID.canonical,this.pixelRatio=G.pixelRatio,this.tileSize=G.tileSize,this.source=G.source,this.scope=G.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=G.showCollisionBoxes,this.collectResourceTiming=!!G.request&&G.request.collectResourceTiming,this.promoteId=G.promoteId,this.isSymbolTile=G.isSymbolTile,this.tileTransform=i.aW(G.tileID.canonical,G.projection),this.projection=G.projection,this.worldview=G.worldview,this.localizableLayerIds=G.localizableLayerIds,this.brightness=G.brightness,this.extraShadowCaster=!!G.extraShadowCaster,this.tessellationStep=G.tessellationStep,this.scaleFactor=G.scaleFactor,this.worldview=G.worldview}parse(G,X,ie,pe,ae,ye){this.status="parsing",this.data=G,this.collisionBoxArray=new i.b0;let De=new i.e$(Object.keys(G.layers).sort()),ve=new i.f0(this.tileID,this.promoteId);ve.bucketLayerIDs=[];let Ce={},$e=new i.f1(256,256),Re={featureIndex:ve,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:$e,availableImages:ie,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},rt=[],xt=X.familiesBySource[this.source];for(let zt in xt){let Vt=G.layers[zt];if(!Vt)continue;let Ut=!1,rn=!1,qt=!1;for(let An of xt[zt])An[0].type==="symbol"?Ut=!0:rn=!0,An[0].is3D()&&An[0].type!=="model"&&(qt=!0);if(this.extraShadowCaster&&!qt||this.isSymbolTile===!0&&!Ut||this.isSymbolTile===!1&&!rn)continue;Vt.version===1&&i.w(`Vector tile source "${this.source}" layer "${zt}" does not use vector tile spec v2 and therefore may have some rendering errors.`);let Hn=De.encode(zt),li=[],ci=!1;for(let An=0,yn=0;An<Vt.length;An++){let Ri=Vt.feature(An),wi=ve.getId(Ri,zt);if(this.localizableLayerIds&&this.localizableLayerIds.has(zt)){let _i=Ri.properties?Ri.properties.worldview:null;if(this.worldview&&typeof _i=="string")if(_i==="all")Ri.properties.$localized=!0;else{if(!_i.split(",").includes(this.worldview))continue;Ri.properties.$localized=!0,Ri.properties.worldview=this.worldview}}!ci&&Ri.properties&&Ri.properties.hasOwnProperty(i.f2)&&(ci=!0),li.push({feature:Ri,id:wi,index:yn,sourceLayerIndex:Hn}),yn++}ci&&!Re.elevationFeatures&&G.layers.hasOwnProperty(i.f3)&&(Re.elevationFeatures=i.f4.parseFrom(G.layers[i.f3],this.canonical));for(let An of xt[zt]){let yn=An[0];if(this.extraShadowCaster&&(!yn.is3D()||yn.type==="model")||this.isSymbolTile!==void 0&&yn.type==="symbol"!==this.isSymbolTile||yn.minzoom&&this.zoom<Math.floor(yn.minzoom)||yn.maxzoom&&this.zoom>=yn.maxzoom||yn.visibility==="none")continue;Se(An,this.zoom,Re.brightness,ie,this.worldview);let Ri=Ce[yn.id]=yn.createBucket({index:ve.bucketLayerIDs.length,layers:An,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Hn,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:pe,worldview:this.worldview});ve.bucketLayerIDs.push(An.map(_i=>i.C(_i.id,_i.scope)));let wi=Ri.prepare?Ri.prepare():null;wi!=null?(wi=wi.then(()=>Ri.populate(li,Re,this.tileID.canonical,this.tileTransform)),rt.push(wi)):Ri.populate(li,Re,this.tileID.canonical,this.tileTransform)}}let wt=()=>{let zt,Vt,Ut,rn,qt,Hn;$e.trim();let li={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},ci=()=>{if(zt)return this.status="done",ye(zt);if(this.extraShadowCaster)this.status="done",ye(null,{buckets:Object.values(Ce).filter(yn=>!yn.isEmpty()),featureIndex:ve,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:Re.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(Vt&&Ut&&rn){let yn=new Pe(Vt),Ri=new Map;for(let[rr,Zr]of Ut.entries()){let{imagePosition:wr}=i.f7(rr,Zr,i.f8);Ri.set(rr,wr)}let wi={};for(let rr in Ce){let Zr=Ce[rr];Zr instanceof i.b1&&(Se(Zr.layers,this.zoom,Re.brightness,ie,this.worldview),wi[rr]=i.f9(Zr,Vt,yn.positions,Ut,Ri,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,qt,this.worldview))}let _i={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(ae,Ut,qt,()=>{_i.iconsPending=!1,An(wi,yn,_i)}),this.rasterizeIfNeeded(ae,rn,Hn,()=>{_i.patternsPending=!1,An(wi,yn,_i)})}},An=(yn,Ri,wi,_i)=>{if(wi.iconsPending||wi.patternsPending)return;let rr=new i.fa(Ut,rn,this.lut);for(let Zr in Ce){let wr=Ce[Zr];if(Zr in yn)i.fb(wr,yn[Zr],this.showCollisionBoxes,ie,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,Ut,rr);else if(wr.hasPattern&&(wr instanceof i.b7||wr instanceof i.b8||wr instanceof i.dU)){Se(wr.layers,this.zoom,Re.brightness,ie,this.worldview);let xu=Object.fromEntries(rr.patternPositions);wr.addFeatures(Re,this.tileID.canonical,xu,ie,this.tileTransform,this.brightness)}}this.status="done",ye(null,{buckets:Object.values(Ce).filter(Zr=>!Zr.isEmpty()),featureIndex:ve,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Ri.image,lineAtlas:$e,imageAtlas:rr,brightness:Re.brightness})};if(!this.extraShadowCaster){let yn=i.f5(Re.glyphDependencies,_i=>Object.keys(_i).map(Number));Object.keys(yn).length?ae.send("getGlyphs",{uid:this.uid,stacks:yn,scope:this.scope},(_i,rr)=>{zt||(zt=_i,Vt=rr,ci())},void 0,!1,li):Vt={};let Ri=Array.from(Re.iconDependencies.keys()).map(_i=>i.I.parse(_i));Ri.length?ae.send("getImages",{images:Ri,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(_i,rr)=>{zt||(zt=_i,Ut=new Map,qt=this.updateImageMapAndGetImageTaskQueue(Ut,rr,Re.iconDependencies),ci())},void 0,!1,li):(Ut=new Map,qt=new Map);let wi=Array.from(Re.patternDependencies.keys()).map(_i=>i.I.parse(_i));wi.length?ae.send("getImages",{images:wi,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(_i,rr)=>{zt||(zt=_i,rn=new Map,Hn=this.updateImageMapAndGetImageTaskQueue(rn,rr,Re.patternDependencies),ci())},void 0,!1,li):(rn=new Map,Hn=new Map)}if(Re.elevationFeatures&&Re.elevationFeatures.length>0){let yn=[];for(let wi of Object.values(Ce))if(wi instanceof i.b8){let _i=wi.getUnevaluatedPortalGraph();_i&&yn.push(_i)}let Ri=i.f6.evaluate(yn);for(let wi of Object.values(Ce))if(wi instanceof i.b8){let _i=G.layers[De.decode(wi.sourceLayerIndex)];wi.setEvaluatedPortalGraph(Ri,_i,this.tileID.canonical,Re.availableImages,Re.brightness)}}ci()};rt.length>0?Promise.allSettled(rt).then(wt).catch(ye):wt()}rasterizeIfNeeded(G,X,ie,pe){Array.from(X.values()).some(ae=>ae.usvg)?this.rasterize(G,X,ie,pe):pe()}updateImageMapAndGetImageTaskQueue(G,X,ie){let pe=new Map;for(let ae of X.keys()){let ye=ie.get(ae)||[];for(let De of ye){let ve=De.toString(),Ce=X.get(De.id.toString());Ce.usvg?pe.has(ve)||(pe.set(ve,De),G.set(ve,Object.assign({},Ce))):G.set(ve,Ce)}}return pe}rasterize(G,X,ie,pe){this.rasterizeTask=G.send("rasterizeImages",{scope:this.scope,tasks:ie},(ae,ye)=>{if(!ae)for(let[De,ve]of ye.entries()){let Ce=Object.assign(X.get(De),{data:ve});X.set(De,Ce)}pe()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function Se(Ae,G,X,ie,pe){let ae=new i.aa(G,{brightness:X,worldview:pe});for(let ye of Ae)ye.recalculate(ae,ie)}class It extends i.E{constructor(G,X,ie,pe,ae,ye,De){super(),this.actor=G,this.layerIndex=X,this.availableImages=ie,this.availableModels=pe,this.loadVectorData=ye||i.aJ,this.loading={},this.loaded={},this.deduped=new i.aI(G.scheduler),this.isSpriteLoaded=ae,this.scheduler=G.scheduler,this.brightness=De}loadTile(G,X){let ie=G.uid,pe=G&&G.request,ae=pe&&pe.collectResourceTiming,ye=this.loading[ie]=new st(G);ye.abort=this.loadVectorData(G,(De,ve)=>{let Ce=!this.loading[ie];if(delete this.loading[ie],ye.cancelRasterize(),Ce||De||!ve)return ye.status="done",Ce||(this.loaded[ie]=ye),X(De);let $e=ve.rawData,Re={};ve.expires&&(Re.expires=ve.expires),ve.cacheControl&&(Re.cacheControl=ve.cacheControl),ye.vectorTile=ve.vectorTile||new i.fc.VectorTile(new i.bq($e));let rt=()=>{ye.parse(ye.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,(xt,wt)=>{if(xt||!wt)return X(xt);let zt={};if(ae){let Vt=A(pe);Vt.length>0&&(zt.resourceTiming=JSON.parse(JSON.stringify(Vt)))}X(null,i.h({rawTileData:$e.slice(0)},wt,Re,zt))})};this.isSpriteLoaded?rt():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(rt,{type:"parseTile",isSymbolTile:G.isSymbolTile,zoom:G.tileZoom}):rt()}),this.loaded=this.loaded||{},this.loaded[ie]=ye})}reloadTile(G,X){let ie=this.loaded,pe=G.uid;if(ie&&ie[pe]){let ae=ie[pe];ae.scaleFactor=G.scaleFactor,ae.showCollisionBoxes=G.showCollisionBoxes,ae.projection=G.projection,ae.brightness=G.brightness,ae.tileTransform=i.aW(G.tileID.canonical,G.projection),ae.extraShadowCaster=G.extraShadowCaster,ae.lut=G.lut,ae.worldview=G.worldview;let ye=(De,ve)=>{let Ce=ae.reloadCallback;Ce&&(delete ae.reloadCallback,ae.parse(ae.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,Ce)),X(De,ve)};ae.status==="parsing"?ae.reloadCallback=ye:ae.status==="done"&&(ae.vectorTile?ae.parse(ae.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,ye):ye())}else X(null,void 0)}abortTile(G,X){let ie=G.uid,pe=this.loading[ie];pe&&(pe.abort&&pe.abort(),delete this.loading[ie]),X()}removeTile(G,X){let ie=this.loaded,pe=G.uid;ie&&ie[pe]&&delete ie[pe],X()}}class Lt{loadTile(G,X){let{uid:ie,encoding:pe,rawImageData:ae,padding:ye}=G,De=ImageBitmap&&ae instanceof ImageBitmap?this.getImageData(ae,ye):ae;X(null,new i.fd(ie,De,pe,ye<1))}reloadTile(G,X){X(null,null)}abortTile(G,X){X()}removeTile(G,X){X()}getImageData(G,X){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(G.width,G.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=G.width,this.offscreenCanvas.height=G.height,this.offscreenCanvasContext.drawImage(G,0,0,G.width,G.height);let ie=this.offscreenCanvasContext.getImageData(-X,-X,G.width+2*X,G.height+2*X);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),ie}}i.bp.setPbf(i.bq);class hn{constructor(G){this._mrt=new i.bp(G.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=G.uid,this.tileID=G.tileID,this.source=G.source}parse(G,X){let ie=this._mrt;this.status="parsing",this._entireBuffer=G;try{ie.parseHeader(G),this._isHeaderLoaded=!0;let pe=[];for(let ae in ie.layers){let ye=ie.getLayer(ae),De=ye.getDataRange(ye.getBandList()),ve=ie.createDecodingTask(De),Ce=G.slice(De.firstByte,De.lastByte+1),$e=i.bp.performDecoding(Ce,ve).then(Re=>ve.complete(null,Re)).catch(Re=>ve.complete(Re,null));pe.push($e)}Promise.allSettled(pe).then(()=>X(null,ie)).catch(ae=>X(ae))}catch(pe){X(pe)}}}class sn{constructor(G){this.actor=G,this.loading={},this.loaded={}}loadTile(G,X){let ie=G.uid,pe=G.request,ae=this.loading[ie]=new hn(G),{cancel:ye}=i.br(pe,(De,ve,Ce,$e)=>{let Re=!this.loading[ie];if(delete this.loading[ie],Re||De||!ve)return ae.status="done",Re||(this.loaded[ie]=ae),X(De);ae.parse(ve,(rt,xt)=>{if(rt||!xt)return X(rt);X(null,xt,Ce,$e)}),this.loaded[ie]=ae});ae.abort=ye}reloadTile(G,X){X(null,void 0)}abortTile(G,X){let ie=G.uid,pe=this.loading[ie];pe&&(pe.abort&&pe.abort(),delete this.loading[ie]),X()}removeTile(G,X){let ie=G.uid;this.loaded[ie]&&delete this.loaded[ie],X()}decodeRasterArray(G,X){i.bp.performDecoding(G.buffer,G.task).then(ie=>X(null,ie)).catch(ie=>X(ie))}}let Yi=i.fc.VectorTileFeature.prototype.toGeoJSON;class fr{constructor(G){this._feature=G,this.extent=i.aj,this.type=G.type,this.properties=G.tags,"id"in G&&!isNaN(G.id)&&(this.id=parseInt(G.id,10))}loadGeometry(){if(this._feature.type===1){let G=[];for(let X of this._feature.geometry)G.push([new i.P(X[0],X[1])]);return G}{let G=[];for(let X of this._feature.geometry){let ie=[];for(let pe of X)ie.push(new i.P(pe[0],pe[1]));G.push(ie)}return G}}toGeoJSON(G,X,ie){return Yi.call(this,G,X,ie)}}class _o{constructor(G){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=i.aj,this.length=G.length,this._features=G}feature(G){return new fr(this._features[G])}}class Cs{constructor(G,X){this.name=G,this.extent=i.aj,this.length=X.length,this._features=X}feature(G){return new fr(this._features[G])}}class la extends _o{constructor(G){super([]),this.layers={};for(let X in G)this.layers[X]=new Cs(X,G[X])}}let ds=64/4096,id=128;class ji{constructor(){this.features=new Map}clear(){this.features.clear()}load(G=[],X){for(let ie of G){let pe=ie.id;if(pe==null)continue;let ae=this.features.get(pe);ae&&this.updateCache(ae,X),ie.geometry?(ae=Pr(ie),this.updateCache(ae,X),this.features.set(pe,ae)):this.features.delete(pe),this.updateCache(ae,X)}}updateCache(G,X){for(let{canonical:ie,uid:pe}of Object.values(X)){let{z:ae,x:ye,y:De}=ie;Qa(G,Math.pow(2,ae),ye,De)&&delete X[pe]}}getTile(G,X,ie){let pe=Math.pow(2,G),ae=[];for(let ye of this.features.values())Qa(ye,pe,X,ie)&&ae.push(Ms(ye,pe,X,ie));return{features:ae}}getFeatures(){return[...this.features.values()]}}function Qa({minX:Ae,minY:G,maxX:X,maxY:ie},pe,ae,ye){return Ae<(ae+1+ds)/pe&&G<(ye+1+ds)/pe&&X>(ae-ds)/pe&&ie>(ye-ds)/pe}function Pr(Ae){let{id:G,geometry:X,properties:ie}=Ae;if(!X)return;if(X.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");let{type:pe,coordinates:ae}=X,ye={id:G,type:1,geometry:[],tags:ie,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},De=ye.geometry;if(pe==="Point")qn(ae,De,ye);else if(pe==="MultiPoint")for(let ve of ae)qn(ve,De,ye);else if(pe==="LineString")ye.type=2,Ui(ae,De,ye);else if(pe==="MultiLineString")ye.type=2,Qi(ae,De,ye);else if(pe==="Polygon")ye.type=3,Qi(ae,De,ye,!0);else{if(pe!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");ye.type=3;for(let ve of ae)Qi(ve,De,ye,!0)}return ye}function qn([Ae,G],X,ie){let pe=i.aD(Ae),ae=i.aH(G);ae=ae<0?0:ae>1?1:ae,X.push(pe,ae),ie.minX=Math.min(ie.minX,pe),ie.minY=Math.min(ie.minY,ae),ie.maxX=Math.max(ie.maxX,pe),ie.maxY=Math.max(ie.maxY,ae)}function Ui(Ae,G,X,ie=!1,pe=!1){let ae=[];for(let ye of Ae)qn(ye,ae,X);G.push(ae),ie&&function(ye,De){let ve=0;for(let Ce=0,$e=ye.length,Re=$e-2;Ce<$e;Re=Ce,Ce+=2)ve+=(ye[Ce]-ye[Re])*(ye[Ce+1]+ye[Re+1]);if(ve>0===De)for(let Ce=0,$e=ye.length;Ce<$e/2;Ce+=2){let Re=ye[Ce],rt=ye[Ce+1];ye[Ce]=ye[$e-2-Ce],ye[Ce+1]=ye[$e-1-Ce],ye[$e-2-Ce]=Re,ye[$e-1-Ce]=rt}}(ae,pe)}function Qi(Ae,G,X,ie=!1){for(let pe=0;pe<Ae.length;pe++)Ui(Ae[pe],G,X,ie,pe===0)}function Ms(Ae,G,X,ie){let{id:pe,type:ae,geometry:ye,tags:De}=Ae,ve=[];if(ae===1)(function(Ce,$e,Re,rt,xt){for(let wt=0;wt<Ce.length;wt+=2){let zt=Math.round(i.aj*(Ce[wt+0]*$e-Re)),Vt=Math.round(i.aj*(Ce[wt+1]*$e-rt));xt.push([zt,Vt])}})(ye,G,X,ie,ve);else for(let Ce of ye)As(Ce,G,X,ie,ve);return{id:pe,type:ae,geometry:ve,tags:De}}function As(Ae,G,X,ie,pe){let ye=i.aj+id,De;for(let ve=0;ve<Ae.length-2;ve+=2){let Ce=Math.round(i.aj*(Ae[ve+0]*G-X)),$e=Math.round(i.aj*(Ae[ve+1]*G-ie)),Re=Math.round(i.aj*(Ae[ve+2]*G-X)),rt=Math.round(i.aj*(Ae[ve+3]*G-ie)),xt=Re-Ce,wt=rt-$e;Ce<-128&&Re<-128||(Ce<-128?($e+=Math.round(wt*((-128-Ce)/xt)),Ce=-128):Re<-128&&(rt=$e+Math.round(wt*((-128-Ce)/xt)),Re=-128),$e<-128&&rt<-128||($e<-128?(Ce+=Math.round(xt*((-128-$e)/wt)),$e=-128):rt<-128&&(Re=Ce+Math.round(xt*((-128-$e)/wt)),rt=-128),Ce>=ye&&Re>=ye||(Ce>=ye?($e+=Math.round(wt*((ye-Ce)/xt)),Ce=ye):Re>=ye&&(rt=$e+Math.round(wt*((ye-Ce)/xt)),Re=ye),$e>=ye&&rt>=ye||($e>=ye?(Ce+=Math.round(xt*((ye-$e)/wt)),$e=ye):rt>=ye&&(Re=Ce+Math.round(xt*((ye-$e)/wt)),rt=ye),De&&Ce===De[De.length-1][0]&&$e===De[De.length-1][1]||(De=[[Ce,$e]],pe.push(De)),De.push([Re,rt])))))}}var Go,pi,yo,qo={exports:{}},ql=function(){if(yo)return qo.exports;yo=1;var Ae=i.fg(),G=function(){if(pi)return Go;pi=1;var $e=i.fe(),Re=i.ff().VectorTileFeature;function rt(wt,zt){this.options=zt||{},this.features=wt,this.length=wt.length}function xt(wt,zt){this.id=typeof wt.id=="number"?wt.id:void 0,this.type=wt.type,this.rawGeometry=wt.type===1?[wt.geometry]:wt.geometry,this.properties=wt.tags,this.extent=zt||4096}return Go=rt,rt.prototype.feature=function(wt){return new xt(this.features[wt],this.options.extent)},xt.prototype.loadGeometry=function(){var wt=this.rawGeometry;this.geometry=[];for(var zt=0;zt<wt.length;zt++){for(var Vt=wt[zt],Ut=[],rn=0;rn<Vt.length;rn++)Ut.push(new $e(Vt[rn][0],Vt[rn][1]));this.geometry.push(Ut)}return this.geometry},xt.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var wt=this.geometry,zt=1/0,Vt=-1/0,Ut=1/0,rn=-1/0,qt=0;qt<wt.length;qt++)for(var Hn=wt[qt],li=0;li<Hn.length;li++){var ci=Hn[li];zt=Math.min(zt,ci.x),Vt=Math.max(Vt,ci.x),Ut=Math.min(Ut,ci.y),rn=Math.max(rn,ci.y)}return[zt,Ut,Vt,rn]},xt.prototype.toGeoJSON=Re.prototype.toGeoJSON,Go}();function X($e){var Re=new Ae;return function(rt,xt){for(var wt in rt.layers)xt.writeMessage(3,ie,rt.layers[wt])}($e,Re),Re.finish()}function ie($e,Re){var rt;Re.writeVarintField(15,$e.version||1),Re.writeStringField(1,$e.name||""),Re.writeVarintField(5,$e.extent||4096);var xt={keys:[],values:[],keycache:{},valuecache:{}};for(rt=0;rt<$e.length;rt++)xt.feature=$e.feature(rt),Re.writeMessage(2,pe,xt);var wt=xt.keys;for(rt=0;rt<wt.length;rt++)Re.writeStringField(3,wt[rt]);var zt=xt.values;for(rt=0;rt<zt.length;rt++)Re.writeMessage(4,Ce,zt[rt])}function pe($e,Re){var rt=$e.feature;rt.id!==void 0&&Re.writeVarintField(1,rt.id),Re.writeMessage(2,ae,$e),Re.writeVarintField(3,rt.type),Re.writeMessage(4,ve,rt)}function ae($e,Re){var rt=$e.feature,xt=$e.keys,wt=$e.values,zt=$e.keycache,Vt=$e.valuecache;for(var Ut in rt.properties){var rn=rt.properties[Ut],qt=zt[Ut];if(rn!==null){qt===void 0&&(xt.push(Ut),zt[Ut]=qt=xt.length-1),Re.writeVarint(qt);var Hn=typeof rn;Hn!=="string"&&Hn!=="boolean"&&Hn!=="number"&&(rn=JSON.stringify(rn));var li=Hn+":"+rn,ci=Vt[li];ci===void 0&&(wt.push(rn),Vt[li]=ci=wt.length-1),Re.writeVarint(ci)}}}function ye($e,Re){return(Re<<3)+(7&$e)}function De($e){return $e<<1^$e>>31}function ve($e,Re){for(var rt=$e.loadGeometry(),xt=$e.type,wt=0,zt=0,Vt=rt.length,Ut=0;Ut<Vt;Ut++){var rn=rt[Ut],qt=1;xt===1&&(qt=rn.length),Re.writeVarint(ye(1,qt));for(var Hn=xt===3?rn.length-1:rn.length,li=0;li<Hn;li++){li===1&&xt!==1&&Re.writeVarint(ye(2,Hn-1));var ci=rn[li].x-wt,An=rn[li].y-zt;Re.writeVarint(De(ci)),Re.writeVarint(De(An)),wt+=ci,zt+=An}xt===3&&Re.writeVarint(ye(7,1))}}function Ce($e,Re){var rt=typeof $e;rt==="string"?Re.writeStringField(1,$e):rt==="boolean"?Re.writeBooleanField(7,$e):rt==="number"&&($e%1!=0?Re.writeDoubleField(3,$e):$e<0?Re.writeSVarintField(6,$e):Re.writeVarintField(5,$e))}return qo.exports=X,qo.exports.fromVectorTileJs=X,qo.exports.fromGeojsonVt=function($e,Re){Re=Re||{};var rt={};for(var xt in $e)rt[xt]=new G($e[xt].features,Re),rt[xt].name=xt,rt[xt].version=Re.version,rt[xt].extent=Re.extent;return X({layers:rt})},qo.exports.GeoJSONWrapper=G,qo.exports}(),Wl=i.fh(ql);let bi={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Ae=>Ae},Bi=Math.fround||(er=new Float32Array(1),Ae=>(er[0]=+Ae,er[0]));var er;let Po=3,ai=5,Zl=6;class Rs{constructor(G){this.options=Object.assign(Object.create(bi),G),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(G){let{log:X,minZoom:ie,maxZoom:pe}=this.options;X&&console.time("total time");let ae=`prepare ${G.length} points`;X&&console.time(ae),this.points=G;let ye=[];for(let ve=0;ve<G.length;ve++){let Ce=G[ve];if(!Ce.geometry)continue;let[$e,Re]=Ce.geometry.coordinates,rt=Bi(Xl($e)),xt=Bi(ca(Re));ye.push(rt,xt,1/0,ve,-1,1),this.options.reduce&&ye.push(0)}let De=this.trees[pe+1]=this._createTree(ye);X&&console.timeEnd(ae);for(let ve=pe;ve>=ie;ve--){let Ce=+Date.now();De=this.trees[ve]=this._createTree(this._cluster(De,ve)),X&&console.log("z%d: %d clusters in %dms",ve,De.numItems,+Date.now()-Ce)}return X&&console.timeEnd("total time"),this}getClusters(G,X){let ie=((G[0]+180)%360+360)%360-180,pe=Math.max(-90,Math.min(90,G[1])),ae=G[2]===180?180:((G[2]+180)%360+360)%360-180,ye=Math.max(-90,Math.min(90,G[3]));if(G[2]-G[0]>=360)ie=-180,ae=180;else if(ie>ae){let Re=this.getClusters([ie,pe,180,ye],X),rt=this.getClusters([-180,pe,ae,ye],X);return Re.concat(rt)}let De=this.trees[this._limitZoom(X)],ve=De.range(Xl(ie),ca(ye),Xl(ae),ca(pe)),Ce=De.data,$e=[];for(let Re of ve){let rt=this.stride*Re;$e.push(Ce[rt+ai]>1?Wo(Ce,rt,this.clusterProps):this.points[Ce[rt+Po]])}return $e}getChildren(G){let X=this._getOriginId(G),ie=this._getOriginZoom(G),pe="No cluster with the specified id.",ae=this.trees[ie];if(!ae)throw new Error(pe);let ye=ae.data;if(X*this.stride>=ye.length)throw new Error(pe);let De=this.options.radius/(this.options.extent*Math.pow(2,ie-1)),ve=ae.within(ye[X*this.stride],ye[X*this.stride+1],De),Ce=[];for(let $e of ve){let Re=$e*this.stride;ye[Re+4]===G&&Ce.push(ye[Re+ai]>1?Wo(ye,Re,this.clusterProps):this.points[ye[Re+Po]])}if(Ce.length===0)throw new Error(pe);return Ce}getLeaves(G,X,ie){let pe=[];return this._appendLeaves(pe,G,X=X||10,ie=ie||0,0),pe}getTile(G,X,ie){let pe=this.trees[this._limitZoom(G)],ae=Math.pow(2,G),{extent:ye,radius:De}=this.options,ve=De/ye,Ce=(ie-ve)/ae,$e=(ie+1+ve)/ae,Re={features:[]};return this._addTileFeatures(pe.range((X-ve)/ae,Ce,(X+1+ve)/ae,$e),pe.data,X,ie,ae,Re),X===0&&this._addTileFeatures(pe.range(1-ve/ae,Ce,1,$e),pe.data,ae,ie,ae,Re),X===ae-1&&this._addTileFeatures(pe.range(0,Ce,ve/ae,$e),pe.data,-1,ie,ae,Re),Re.features.length?Re:null}getClusterExpansionZoom(G){let X=this._getOriginZoom(G)-1;for(;X<=this.options.maxZoom;){let ie=this.getChildren(G);if(X++,ie.length!==1)break;G=ie[0].properties.cluster_id}return X}_appendLeaves(G,X,ie,pe,ae){let ye=this.getChildren(X);for(let De of ye){let ve=De.properties;if(ve&&ve.cluster?ae+ve.point_count<=pe?ae+=ve.point_count:ae=this._appendLeaves(G,ve.cluster_id,ie,pe,ae):ae<pe?ae++:G.push(De),G.length===ie)break}return ae}_createTree(G){let X=new i.bW(G.length/this.stride|0,this.options.nodeSize,Float32Array);for(let ie=0;ie<G.length;ie+=this.stride)X.add(G[ie],G[ie+1]);return X.finish(),X.data=G,X}_addTileFeatures(G,X,ie,pe,ae,ye){for(let De of G){let ve=De*this.stride,Ce=X[ve+ai]>1,$e,Re,rt;if(Ce)$e=Vi(X,ve,this.clusterProps),Re=X[ve],rt=X[ve+1];else{let zt=this.points[X[ve+Po]];$e=zt.properties;let[Vt,Ut]=zt.geometry.coordinates;Re=Xl(Vt),rt=ca(Ut)}let xt={type:1,geometry:[[Math.round(this.options.extent*(Re*ae-ie)),Math.round(this.options.extent*(rt*ae-pe))]],tags:$e},wt;wt=Ce||this.options.generateId?X[ve+Po]:this.points[X[ve+Po]].id,wt!==void 0&&(xt.id=wt),ye.features.push(xt)}}_limitZoom(G){return Math.max(this.options.minZoom,Math.min(Math.floor(+G),this.options.maxZoom+1))}_cluster(G,X){let{radius:ie,extent:pe,reduce:ae,minPoints:ye}=this.options,De=ie/(pe*Math.pow(2,X)),ve=G.data,Ce=[],$e=this.stride;for(let Re=0;Re<ve.length;Re+=$e){if(ve[Re+2]<=X)continue;ve[Re+2]=X;let rt=ve[Re],xt=ve[Re+1],wt=G.within(ve[Re],ve[Re+1],De),zt=ve[Re+ai],Vt=zt;for(let Ut of wt){let rn=Ut*$e;ve[rn+2]>X&&(Vt+=ve[rn+ai])}if(Vt>zt&&Vt>=ye){let Ut,rn=rt*zt,qt=xt*zt,Hn=-1,li=(Re/$e<<5)+(X+1)+this.points.length;for(let ci of wt){let An=ci*$e;if(ve[An+2]<=X)continue;ve[An+2]=X;let yn=ve[An+ai];rn+=ve[An]*yn,qt+=ve[An+1]*yn,ve[An+4]=li,ae&&(Ut||(Ut=this._map(ve,Re,!0),Hn=this.clusterProps.length,this.clusterProps.push(Ut)),ae(Ut,this._map(ve,An)))}ve[Re+4]=li,Ce.push(rn/Vt,qt/Vt,1/0,li,-1,Vt),ae&&Ce.push(Hn)}else{for(let Ut=0;Ut<$e;Ut++)Ce.push(ve[Re+Ut]);if(Vt>1)for(let Ut of wt){let rn=Ut*$e;if(!(ve[rn+2]<=X)){ve[rn+2]=X;for(let qt=0;qt<$e;qt++)Ce.push(ve[rn+qt])}}}}return Ce}_getOriginId(G){return G-this.points.length>>5}_getOriginZoom(G){return(G-this.points.length)%32}_map(G,X,ie){if(G[X+ai]>1){let ye=this.clusterProps[G[X+Zl]];return ie?Object.assign({},ye):ye}let pe=this.points[G[X+Po]].properties,ae=this.options.map(pe);return ie&&ae===pe?Object.assign({},ae):ae}}function Wo(Ae,G,X){return{type:"Feature",id:Ae[G+Po],properties:Vi(Ae,G,X),geometry:{type:"Point",coordinates:[(ie=Ae[G],360*(ie-.5)),Lr(Ae[G+1])]}};var ie}function Vi(Ae,G,X){let ie=Ae[G+ai],pe=ie>=1e4?`${Math.round(ie/1e3)}k`:ie>=1e3?Math.round(ie/100)/10+"k":ie,ae=Ae[G+Zl],ye=ae===-1?{}:Object.assign({},X[ae]);return Object.assign(ye,{cluster:!0,cluster_id:Ae[G+Po],point_count:ie,point_count_abbreviated:pe})}function Xl(Ae){return Ae/360+.5}function ca(Ae){let G=Math.sin(Ae*Math.PI/180),X=.5-.25*Math.log((1+G)/(1-G))/Math.PI;return X<0?0:X>1?1:X}function Lr(Ae){let G=(180-360*Ae)*Math.PI/180;return 360*Math.atan(Math.exp(G))/Math.PI-90}function el(Ae,G,X,ie){let pe=ie,ae=G+(X-G>>1),ye,De=X-G,ve=Ae[G],Ce=Ae[G+1],$e=Ae[X],Re=Ae[X+1];for(let rt=G+3;rt<X;rt+=3){let xt=_u(Ae[rt],Ae[rt+1],ve,Ce,$e,Re);if(xt>pe)ye=rt,pe=xt;else if(xt===pe){let wt=Math.abs(rt-ae);wt<De&&(ye=rt,De=wt)}}pe>ie&&(ye-G>3&&el(Ae,G,ye,ie),Ae[ye+2]=pe,X-ye>3&&el(Ae,ye,X,ie))}function _u(Ae,G,X,ie,pe,ae){let ye=pe-X,De=ae-ie;if(ye!==0||De!==0){let ve=((Ae-X)*ye+(G-ie)*De)/(ye*ye+De*De);ve>1?(X=pe,ie=ae):ve>0&&(X+=ye*ve,ie+=De*ve)}return ye=Ae-X,De=G-ie,ye*ye+De*De}function Or(Ae,G,X,ie){let pe={id:Ae??null,type:G,geometry:X,tags:ie,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(G==="Point"||G==="MultiPoint"||G==="LineString")io(pe,X);else if(G==="Polygon")io(pe,X[0]);else if(G==="MultiLineString")for(let ae of X)io(pe,ae);else if(G==="MultiPolygon")for(let ae of X)io(pe,ae[0]);return pe}function io(Ae,G){for(let X=0;X<G.length;X+=3)Ae.minX=Math.min(Ae.minX,G[X]),Ae.minY=Math.min(Ae.minY,G[X+1]),Ae.maxX=Math.max(Ae.maxX,G[X]),Ae.maxY=Math.max(Ae.maxY,G[X+1])}function ua(Ae,G,X,ie){if(!G.geometry)return;let pe=G.geometry.coordinates;if(pe&&pe.length===0)return;let ae=G.geometry.type,ye=Math.pow(X.tolerance/((1<<X.maxZoom)*X.extent),2),De=[],ve=G.id;if(X.promoteId?ve=G.properties[X.promoteId]:X.generateId&&(ve=ie||0),ae==="Point")ha(pe,De);else if(ae==="MultiPoint")for(let Ce of pe)ha(Ce,De);else if(ae==="LineString")da(pe,De,ye,!1);else if(ae==="MultiLineString"){if(X.lineMetrics){for(let Ce of pe)De=[],da(Ce,De,ye,!1),Ae.push(Or(ve,"LineString",De,G.properties));return}kr(pe,De,ye,!1)}else if(ae==="Polygon")kr(pe,De,ye,!0);else{if(ae!=="MultiPolygon"){if(ae==="GeometryCollection"){for(let Ce of G.geometry.geometries)ua(Ae,{id:ve,geometry:Ce,properties:G.properties},X,ie);return}throw new Error("Input data is not a valid GeoJSON object.")}for(let Ce of pe){let $e=[];kr(Ce,$e,ye,!0),De.push($e)}}Ae.push(Or(ve,ae,De,G.properties))}function ha(Ae,G){G.push(Yl(Ae[0]),Kl(Ae[1]),0)}function da(Ae,G,X,ie){let pe,ae,ye=0;for(let ve=0;ve<Ae.length;ve++){let Ce=Yl(Ae[ve][0]),$e=Kl(Ae[ve][1]);G.push(Ce,$e,0),ve>0&&(ye+=ie?(pe*$e-Ce*ae)/2:Math.sqrt(Math.pow(Ce-pe,2)+Math.pow($e-ae,2))),pe=Ce,ae=$e}let De=G.length-3;G[2]=1,el(G,0,De,X),G[De+2]=1,G.size=Math.abs(ye),G.start=0,G.end=G.size}function kr(Ae,G,X,ie){for(let pe=0;pe<Ae.length;pe++){let ae=[];da(Ae[pe],ae,X,ie),G.push(ae)}}function Yl(Ae){return Ae/360+.5}function Kl(Ae){let G=Math.sin(Ae*Math.PI/180),X=.5-.25*Math.log((1+G)/(1-G))/Math.PI;return X<0?0:X>1?1:X}function ro(Ae,G,X,ie,pe,ae,ye,De){if(ie/=G,ae>=(X/=G)&&ye<ie)return Ae;if(ye<X||ae>=ie)return null;let ve=[];for(let Ce of Ae){let $e=Ce.geometry,Re=Ce.type,rt=pe===0?Ce.minX:Ce.minY,xt=pe===0?Ce.maxX:Ce.maxY;if(rt>=X&&xt<ie){ve.push(Ce);continue}if(xt<X||rt>=ie)continue;let wt=[];if(Re==="Point"||Re==="MultiPoint")yu($e,wt,X,ie,pe);else if(Re==="LineString")Ps($e,wt,X,ie,pe,!1,De.lineMetrics);else if(Re==="MultiLineString")br($e,wt,X,ie,pe,!1);else if(Re==="Polygon")br($e,wt,X,ie,pe,!0);else if(Re==="MultiPolygon")for(let zt of $e){let Vt=[];br(zt,Vt,X,ie,pe,!0),Vt.length&&wt.push(Vt)}if(wt.length){if(De.lineMetrics&&Re==="LineString"){for(let zt of wt)ve.push(Or(Ce.id,Re,zt,Ce.tags));continue}Re!=="LineString"&&Re!=="MultiLineString"||(wt.length===1?(Re="LineString",wt=wt[0]):Re="MultiLineString"),Re!=="Point"&&Re!=="MultiPoint"||(Re=wt.length===3?"Point":"MultiPoint"),ve.push(Or(Ce.id,Re,wt,Ce.tags))}}return ve.length?ve:null}function yu(Ae,G,X,ie,pe){for(let ae=0;ae<Ae.length;ae+=3){let ye=Ae[ae+pe];ye>=X&&ye<=ie&&Lo(G,Ae[ae],Ae[ae+1],Ae[ae+2])}}function Ps(Ae,G,X,ie,pe,ae,ye){let De=Jl(Ae),ve=pe===0?tl:fa,Ce,$e,Re=Ae.start;for(let Vt=0;Vt<Ae.length-3;Vt+=3){let Ut=Ae[Vt],rn=Ae[Vt+1],qt=Ae[Vt+2],Hn=Ae[Vt+3],li=Ae[Vt+4],ci=pe===0?Ut:rn,An=pe===0?Hn:li,yn=!1;ye&&(Ce=Math.sqrt(Math.pow(Ut-Hn,2)+Math.pow(rn-li,2))),ci<X?An>X&&($e=ve(De,Ut,rn,Hn,li,X),ye&&(De.start=Re+Ce*$e)):ci>ie?An<ie&&($e=ve(De,Ut,rn,Hn,li,ie),ye&&(De.start=Re+Ce*$e)):Lo(De,Ut,rn,qt),An<X&&ci>=X&&($e=ve(De,Ut,rn,Hn,li,X),yn=!0),An>ie&&ci<=ie&&($e=ve(De,Ut,rn,Hn,li,ie),yn=!0),!ae&&yn&&(ye&&(De.end=Re+Ce*$e),G.push(De),De=Jl(Ae)),ye&&(Re+=Ce)}let rt=Ae.length-3,xt=Ae[rt],wt=Ae[rt+1],zt=pe===0?xt:wt;zt>=X&&zt<=ie&&Lo(De,xt,wt,Ae[rt+2]),rt=De.length-3,ae&&rt>=3&&(De[rt]!==De[0]||De[rt+1]!==De[1])&&Lo(De,De[0],De[1],De[2]),De.length&&G.push(De)}function Jl(Ae){let G=[];return G.size=Ae.size,G.start=Ae.start,G.end=Ae.end,G}function br(Ae,G,X,ie,pe,ae){for(let ye of Ae)Ps(ye,G,X,ie,pe,ae,!1)}function Lo(Ae,G,X,ie){Ae.push(G,X,ie)}function tl(Ae,G,X,ie,pe,ae){let ye=(ae-G)/(ie-G);return Lo(Ae,ae,X+(pe-X)*ye,1),ye}function fa(Ae,G,X,ie,pe,ae){let ye=(ae-X)/(pe-X);return Lo(Ae,G+(ie-G)*ye,ae,1),ye}function nl(Ae,G){let X=[];for(let ie=0;ie<Ae.length;ie++){let pe=Ae[ie],ae=pe.type,ye;if(ae==="Point"||ae==="MultiPoint"||ae==="LineString")ye=pa(pe.geometry,G);else if(ae==="MultiLineString"||ae==="Polygon"){ye=[];for(let De of pe.geometry)ye.push(pa(De,G))}else if(ae==="MultiPolygon"){ye=[];for(let De of pe.geometry){let ve=[];for(let Ce of De)ve.push(pa(Ce,G));ye.push(ve)}}X.push(Or(pe.id,ae,ye,pe.tags))}return X}function pa(Ae,G){let X=[];X.size=Ae.size,Ae.start!==void 0&&(X.start=Ae.start,X.end=Ae.end);for(let ie=0;ie<Ae.length;ie+=3)X.push(Ae[ie]+G,Ae[ie+1],Ae[ie+2]);return X}function Ql(Ae,G){if(Ae.transformed)return Ae;let X=1<<Ae.z,ie=Ae.x,pe=Ae.y;for(let ae of Ae.features){let ye=ae.geometry,De=ae.type;if(ae.geometry=[],De===1)for(let ve=0;ve<ye.length;ve+=2)ae.geometry.push(mi(ye[ve],ye[ve+1],G,X,ie,pe));else for(let ve=0;ve<ye.length;ve++){let Ce=[];for(let $e=0;$e<ye[ve].length;$e+=2)Ce.push(mi(ye[ve][$e],ye[ve][$e+1],G,X,ie,pe));ae.geometry.push(Ce)}}return Ae.transformed=!0,Ae}function mi(Ae,G,X,ie,pe,ae){return[Math.round(X*(Ae*ie-pe)),Math.round(X*(G*ie-ae))]}function ma(Ae,G,X,ie,pe){let ae=G===pe.maxZoom?0:pe.tolerance/((1<<G)*pe.extent),ye={features:[],numPoints:0,numSimplified:0,numFeatures:Ae.length,source:null,x:X,y:ie,z:G,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(let De of Ae)ec(ye,De,ae,pe);return ye}function ec(Ae,G,X,ie){let pe=G.geometry,ae=G.type,ye=[];if(Ae.minX=Math.min(Ae.minX,G.minX),Ae.minY=Math.min(Ae.minY,G.minY),Ae.maxX=Math.max(Ae.maxX,G.maxX),Ae.maxY=Math.max(Ae.maxY,G.maxY),ae==="Point"||ae==="MultiPoint")for(let De=0;De<pe.length;De+=3)ye.push(pe[De],pe[De+1]),Ae.numPoints++,Ae.numSimplified++;else if(ae==="LineString")oo(ye,pe,Ae,X,!1,!1);else if(ae==="MultiLineString"||ae==="Polygon")for(let De=0;De<pe.length;De++)oo(ye,pe[De],Ae,X,ae==="Polygon",De===0);else if(ae==="MultiPolygon")for(let De=0;De<pe.length;De++){let ve=pe[De];for(let Ce=0;Ce<ve.length;Ce++)oo(ye,ve[Ce],Ae,X,!0,Ce===0)}if(ye.length){let De=G.tags||null;if(ae==="LineString"&&ie.lineMetrics){De={};for(let Ce in G.tags)De[Ce]=G.tags[Ce];De.mapbox_clip_start=pe.start/pe.size,De.mapbox_clip_end=pe.end/pe.size}let ve={geometry:ye,type:ae==="Polygon"||ae==="MultiPolygon"?3:ae==="LineString"||ae==="MultiLineString"?2:1,tags:De};G.id!==null&&(ve.id=G.id),Ae.features.push(ve)}}function oo(Ae,G,X,ie,pe,ae){let ye=ie*ie;if(ie>0&&G.size<(pe?ye:ie))return void(X.numPoints+=G.length/3);let De=[];for(let ve=0;ve<G.length;ve+=3)(ie===0||G[ve+2]>ye)&&(X.numSimplified++,De.push(G[ve],G[ve+1])),X.numPoints++;pe&&function(ve,Ce){let $e=0;for(let Re=0,rt=ve.length,xt=rt-2;Re<rt;xt=Re,Re+=2)$e+=(ve[Re]-ve[xt])*(ve[Re+1]+ve[xt+1]);if($e>0===Ce)for(let Re=0,rt=ve.length;Re<rt/2;Re+=2){let xt=ve[Re],wt=ve[Re+1];ve[Re]=ve[rt-2-Re],ve[Re+1]=ve[rt-1-Re],ve[rt-2-Re]=xt,ve[rt-1-Re]=wt}}(De,ae),Ae.push(De)}let Pp={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class rd{constructor(G,X){let ie=(X=this.options=function(ae,ye){for(let De in ye)ae[De]=ye[De];return ae}(Object.create(Pp),X)).debug;if(ie&&console.time("preprocess data"),X.maxZoom<0||X.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(X.promoteId&&X.generateId)throw new Error("promoteId and generateId cannot be used together.");let pe=function(ae,ye){let De=[];if(ae.type==="FeatureCollection")for(let ve=0;ve<ae.features.length;ve++)ua(De,ae.features[ve],ye,ve);else ua(De,ae.type==="Feature"?ae:{geometry:ae},ye);return De}(G,X);this.tiles={},this.tileCoords=[],ie&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",X.indexMaxZoom,X.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),pe=function(ae,ye){let De=ye.buffer/ye.extent,ve=ae,Ce=ro(ae,1,-1-De,De,0,-1,2,ye),$e=ro(ae,1,1-De,2+De,0,-1,2,ye);return(Ce||$e)&&(ve=ro(ae,1,-De,1+De,0,-1,2,ye)||[],Ce&&(ve=nl(Ce,1).concat(ve)),$e&&(ve=ve.concat(nl($e,-1)))),ve}(pe,X),pe.length&&this.splitTile(pe,0,0,0),ie&&(pe.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(G,X,ie,pe,ae,ye,De){let ve=[G,X,ie,pe],Ce=this.options,$e=Ce.debug;for(;ve.length;){pe=ve.pop(),ie=ve.pop(),X=ve.pop(),G=ve.pop();let Re=1<<X,rt=il(X,ie,pe),xt=this.tiles[rt];if(!xt&&($e>1&&console.time("creation"),xt=this.tiles[rt]=ma(G,X,ie,pe,Ce),this.tileCoords.push({z:X,x:ie,y:pe}),$e)){$e>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",X,ie,pe,xt.numFeatures,xt.numPoints,xt.numSimplified),console.timeEnd("creation"));let yn=`z${X}`;this.stats[yn]=(this.stats[yn]||0)+1,this.total++}if(xt.source=G,ae==null){if(X===Ce.indexMaxZoom||xt.numPoints<=Ce.indexMaxPoints)continue}else{if(X===Ce.maxZoom||X===ae)continue;if(ae!=null){let yn=ae-X;if(ie!==ye>>yn||pe!==De>>yn)continue}}if(xt.source=null,G.length===0)continue;$e>1&&console.time("clipping");let wt=.5*Ce.buffer/Ce.extent,zt=.5-wt,Vt=.5+wt,Ut=1+wt,rn=null,qt=null,Hn=null,li=null,ci=ro(G,Re,ie-wt,ie+Vt,0,xt.minX,xt.maxX,Ce),An=ro(G,Re,ie+zt,ie+Ut,0,xt.minX,xt.maxX,Ce);G=null,ci&&(rn=ro(ci,Re,pe-wt,pe+Vt,1,xt.minY,xt.maxY,Ce),qt=ro(ci,Re,pe+zt,pe+Ut,1,xt.minY,xt.maxY,Ce),ci=null),An&&(Hn=ro(An,Re,pe-wt,pe+Vt,1,xt.minY,xt.maxY,Ce),li=ro(An,Re,pe+zt,pe+Ut,1,xt.minY,xt.maxY,Ce),An=null),$e>1&&console.timeEnd("clipping"),ve.push(rn||[],X+1,2*ie,2*pe),ve.push(qt||[],X+1,2*ie,2*pe+1),ve.push(Hn||[],X+1,2*ie+1,2*pe),ve.push(li||[],X+1,2*ie+1,2*pe+1)}}getTile(G,X,ie){G=+G,X=+X,ie=+ie;let pe=this.options,{extent:ae,debug:ye}=pe;if(G<0||G>24)return null;let De=1<<G,ve=il(G,X=X+De&De-1,ie);if(this.tiles[ve])return Ql(this.tiles[ve],ae);ye>1&&console.log("drilling down to z%d-%d-%d",G,X,ie);let Ce,$e=G,Re=X,rt=ie;for(;!Ce&&$e>0;)$e--,Re>>=1,rt>>=1,Ce=this.tiles[il($e,Re,rt)];return Ce&&Ce.source?(ye>1&&(console.log("found parent tile z%d-%d-%d",$e,Re,rt),console.time("drilling down")),this.splitTile(Ce.source,$e,Re,rt,G,X,ie),ye>1&&console.timeEnd("drilling down"),this.tiles[ve]?Ql(this.tiles[ve],ae):null):null}}function il(Ae,G,X){return 32*((1<<Ae)*X+G)+Ae}function ot(Ae,G){let X=Ae.tileID.canonical;if(!this._geoJSONIndex)return void G(null,null);let ie=this._geoJSONIndex.getTile(X.z,X.x,X.y);if(!ie)return void G(null,null);let pe=ve=>ve.tags&&"3d_elevation_id"in ve.tags&&"source"in ve.tags&&ve.tags.source==="elevation",ae=ie.features.filter(ve=>pe(ve)),ye;if(ae.length>0){let ve=ie.features.filter(Ce=>!pe(Ce));ye=new la({_geojsonTileLayer:ve,hd_road_elevation:ae})}else ye=new _o(ie.features);let De=Wl(ye);De.byteOffset===0&&De.byteLength===De.buffer.byteLength||(De=new Uint8Array(De)),G(null,{vectorTile:ye,rawData:De.buffer})}class Ls extends It{constructor(G,X,ie,pe,ae,ye,De){super(G,X,ie,pe,ae,ot,De),ye&&(this.loadGeoJSON=ye),this._dynamicIndex=new ji}loadData(G,X){let ie=G&&G.request,pe=ie&&ie.collectResourceTiming;this.loadGeoJSON(G,(ae,ye)=>{if(ae||!ye)return X(ae);if(typeof ye!="object")return X(new Error(`Input data given to '${G.source}' is not a valid GeoJSON object.`));{try{if(G.filter){let ve=i.X(G.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(ve.result==="error")throw new Error(ve.value.map(Ce=>`${Ce.key}: ${Ce.message}`).join(", "));ye.features=ye.features.filter(Ce=>ve.value.evaluate({zoom:0},Ce))}G.dynamic?(ye.type==="Feature"&&(ye={type:"FeatureCollection",features:[ye]}),G.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(ye.features,this.loaded),G.cluster&&(ye.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=G.cluster?new Rs(function({superclusterOptions:ve,clusterProperties:Ce}){if(!Ce||!ve)return ve;let $e={},Re={},rt={accumulated:null,zoom:0},xt={properties:null},wt=Object.keys(Ce);for(let zt of wt){let[Vt,Ut]=Ce[zt],rn=i.X(Ut),qt=i.X(typeof Vt=="string"?[Vt,["accumulated"],["get",zt]]:Vt);$e[zt]=rn.value,Re[zt]=qt.value}return ve.map=zt=>{xt.properties=zt;let Vt={};for(let Ut of wt)Vt[Ut]=$e[Ut].evaluate(rt,xt);return Vt},ve.reduce=(zt,Vt)=>{xt.properties=Vt;for(let Ut of wt)rt.accumulated=zt[Ut],zt[Ut]=Re[Ut].evaluate(rt,xt)},ve}(G)).load(ye.features):G.dynamic?this._dynamicIndex:function(ve,Ce){return new rd(ve,Ce)}(ye,G.geojsonVtOptions)}catch(ve){return X(ve)}let De={};if(pe){let ve=A(ie);ve&&(De.resourceTiming={},De.resourceTiming[G.source]=JSON.parse(JSON.stringify(ve)))}X(null,De)}})}reloadTile(G,X){let ie=this.loaded;return ie&&ie[G.uid]?G.partial?X(null,void 0):super.reloadTile(G,X):this.loadTile(G,X)}loadGeoJSON(G,X){if(G.request)i.n(G.request,X);else{if(typeof G.data!="string")return X(new Error(`Input data given to '${G.source}' is not a valid GeoJSON object.`));try{return X(null,JSON.parse(G.data))}catch{return X(new Error(`Input data given to '${G.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(G,X){try{X(null,this._geoJSONIndex.getClusterExpansionZoom(G.clusterId))}catch(ie){X(ie)}}getClusterChildren(G,X){try{X(null,this._geoJSONIndex.getChildren(G.clusterId))}catch(ie){X(ie)}}getClusterLeaves(G,X){try{X(null,this._geoJSONIndex.getLeaves(G.clusterId,G.limit,G.offset))}catch(ie){X(ie)}}}class Lp{constructor(G,X,ie){this.tileID=new i.aM(G.tileID.overscaledZ,G.tileID.wrap,G.tileID.canonical.z,G.tileID.canonical.x,G.tileID.canonical.y),this.tileZoom=G.tileZoom,this.uid=G.uid,this.zoom=G.zoom,this.canonical=G.tileID.canonical,this.pixelRatio=G.pixelRatio,this.tileSize=G.tileSize,this.source=G.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=G.projection,this.brightness=X,this.worldview=ie}parse(G,X,ie,pe){this.status="parsing";let ae=new i.aM(ie.tileID.overscaledZ,ie.tileID.wrap,ie.tileID.canonical.z,ie.tileID.canonical.x,ie.tileID.canonical.y),ye=[],De=X.familiesBySource[ie.source],ve=new i.f0(ae,ie.promoteId);ve.bucketLayerIDs=[],ve.is3DTile=!0,i.fi(G).then(Ce=>{if(!Ce)return pe(new Error("Could not parse tile"));let $e=Ce.json.extensionsUsed&&Ce.json.extensionsUsed.includes("MAPBOX_mesh_features")||Ce.json.asset.extras&&Ce.json.asset.extras.MAPBOX_mesh_features,Re=Ce.json.extensionsUsed&&Ce.json.extensionsUsed.includes("EXT_meshopt_compression"),rt=new i.aa(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(let xt in De)for(let wt of De[xt]){let zt=wt[0];ve.bucketLayerIDs.push(wt.map(rn=>i.C(rn.id,rn.scope))),zt.recalculate(rt,[]);let Vt=i.fj(Ce,1/i.cU(ie.tileID.canonical)),Ut=new i.fk(wt,Vt,ae,$e,Re,this.brightness,ve,this.worldview);$e||(Ut.needsUpload=!0),ye.push(Ut),Ut.evaluate(zt)}this.status="done",pe(null,{buckets:ye,featureIndex:ve,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(Ce=>pe(new Error(Ce.message)))}}class vu{constructor(G,X,ie,pe,ae,ye,De,ve){this.actor=G,this.layerIndex=X,this.availableImages=ie,this.availableModels=pe,this.brightness=De,this.loading={},this.loaded={},this.worldview=ve}loadTile(G,X){let ie=G.uid,pe=this.loading[ie]=new Lp(G,this.brightness,this.worldview);i.br(G.request,(ae,ye)=>{let De=!this.loading[ie];return delete this.loading[ie],De||ae?(pe.status="done",De||(this.loaded[ie]=pe),X(ae)):ye&&ye.byteLength!==0?void pe.parse(ye,this.layerIndex,G,(ve,Ce)=>{pe.status="done",this.loaded=this.loaded||{},this.loaded[ie]=pe,ve||!Ce?X(ve):X(null,Ce)}):(pe.status="done",this.loaded[ie]=pe,X())})}reloadTile(G,X){let ie=this.loaded,pe=G.uid;if(ie&&ie[pe]){let ae=ie[pe];ae.projection=G.projection,ae.brightness=G.brightness;let ye=(De,ve)=>{ae.reloadCallback&&(delete ae.reloadCallback,this.loadTile(G,X)),X(De,ve)};ae.status==="parsing"?ae.reloadCallback=ye:ae.status==="done"&&this.loadTile(G,X)}}abortTile(G,X){let ie=G.uid;this.loading[ie]&&delete this.loading[ie],X()}removeTile(G,X){let ie=this.loaded,pe=G.uid;ie&&ie[pe]&&delete ie[pe],X()}}class gn{constructor(G){this.self=G,this.actor=new i.fm(G,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new i.y,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=i.ce({name:"mercator"}),this.workerSourceTypes={vector:It,geojson:Ls,"raster-dem":Lt,"raster-array":sn,"batched-model":vu},this.workerSources={},this.self.registerWorkerSource=(X,ie)=>{if(this.workerSourceTypes[X])throw new Error(`Worker source with name "${X}" already registered.`);this.workerSourceTypes[X]=ie},this.self.registerRTLTextPlugin=X=>{if(i.fn.isParsed())throw new Error("RTL text plugin already registered.");i.fn.setState({pluginStatus:i.fo.parsed,pluginURL:i.fn.getPluginURL()}),i.fn.applyArabicShaping=X.applyArabicShaping,i.fn.processBidirectionalText=X.processBidirectionalText,i.fn.processStyledBidirectionalText=X.processStyledBidirectionalText;for(let ie of this.rtlPluginParsingListeners)ie(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches(G,X,ie){delete this.layerIndexes[G],delete this.availableImages[G],delete this.availableModels[G],delete this.workerSources[G],ie()}checkIfReady(G,X,ie){ie()}setReferrer(G,X){this.referrer=X}spriteLoaded(G,X){this.isSpriteLoaded[G]||(this.isSpriteLoaded[G]={});let{scope:ie,isLoaded:pe}=X;if(this.isSpriteLoaded[G][ie]=pe,this.workerSources[G]&&this.workerSources[G][ie])for(let ae in this.workerSources[G][ie]){let ye=this.workerSources[G][ie][ae];for(let De in ye){let ve=ye[De];ve instanceof It&&(ve.isSpriteLoaded=pe,ve.fire(new i.A("isSpriteLoaded")))}}}setImages(G,X,ie){this.availableImages[G]||(this.availableImages[G]={});let{scope:pe,images:ae}=X;if(this.availableImages[G][pe]=ae,this.workerSources[G]&&this.workerSources[G][pe]){for(let ye in this.workerSources[G][pe]){let De=this.workerSources[G][pe][ye];for(let ve in De)De[ve].availableImages=ae}ie()}else ie()}setModels(G,{scope:X,models:ie},pe){if(this.availableModels[G]||(this.availableModels[G]={}),this.availableModels[G][X]=ie,this.workerSources[G]&&this.workerSources[G][X]){for(let ae in this.workerSources[G][X]){let ye=this.workerSources[G][X][ae];for(let De in ye)ye[De].availableModels=ie}pe()}else pe()}setProjection(G,X){this.projections[G]=i.ce(X)}setBrightness(G,X,ie){this.brightness=X,ie()}setWorldview(G,X,ie){this.worldview=X,ie()}setLayers(G,X,ie){this.getLayerIndex(G,X.scope).replace(X.layers,X.options),ie()}updateLayers(G,X,ie){this.getLayerIndex(G,X.scope).update(X.layers,X.removedIds,X.options),ie()}loadTile(G,X,ie){X.projection=this.projections[G]||this.defaultProjection,this.getWorkerSource(G,X.type,X.source,X.scope).loadTile(X,ie)}decodeRasterArray(G,X,ie){this.getWorkerSource(G,X.type,X.source,X.scope).decodeRasterArray(X,ie)}reloadTile(G,X,ie){X.projection=this.projections[G]||this.defaultProjection,this.getWorkerSource(G,X.type,X.source,X.scope).reloadTile(X,ie)}abortTile(G,X,ie){this.getWorkerSource(G,X.type,X.source,X.scope).abortTile(X,ie)}removeTile(G,X,ie){this.getWorkerSource(G,X.type,X.source,X.scope).removeTile(X,ie)}removeSource(G,X,ie){if(!(this.workerSources[G]&&this.workerSources[G][X.scope]&&this.workerSources[G][X.scope][X.type]&&this.workerSources[G][X.scope][X.type][X.source]))return;let pe=this.workerSources[G][X.scope][X.type][X.source];delete this.workerSources[G][X.scope][X.type][X.source],pe.removeSource!==void 0?pe.removeSource(X,ie):ie()}loadWorkerSource(G,X,ie){try{this.self.importScripts(X.url),ie()}catch(pe){ie(pe.toString())}}syncRTLPluginState(G,X,ie){if(i.fn.isParsed())ie(null,!0);else if(i.fn.isParsing())this.rtlPluginParsingListeners.push(ie);else try{i.fn.setState(X);let pe=i.fn.getPluginURL();!i.fn.isLoaded()||i.fn.isParsed()||i.fn.isParsing()||pe==null||(i.fn.setState({pluginStatus:i.fo.parsing,pluginURL:i.fn.getPluginURL()}),this.self.importScripts(pe),i.fn.isParsed()?ie(null,!0):this.rtlPluginParsingListeners.push(ie))}catch(pe){ie(pe.toString())}}setDracoUrl(G,X){this.dracoUrl=X}getAvailableImages(G,X){this.availableImages[G]||(this.availableImages[G]={});let ie=this.availableImages[G][X];return ie||(ie=[]),ie}getAvailableModels(G,X){this.availableModels[G]||(this.availableModels[G]={});let ie=this.availableModels[G][X];return ie||(ie={}),ie}getLayerIndex(G,X){this.layerIndexes[G]||(this.layerIndexes[G]={});let ie=this.layerIndexes[G][X];return ie||(ie=this.layerIndexes[G][X]=new ce,ie.scope=X),ie}getWorkerSource(G,X,ie,pe){let ae=this.workerSources;return ae[G]||(ae[G]={}),ae[G][pe]||(ae[G][pe]={}),ae[G][pe][X]||(ae[G][pe][X]={}),this.isSpriteLoaded[G]||(this.isSpriteLoaded[G]={}),ae[G][pe][X][ie]||(ae[G][pe][X][ie]=new this.workerSourceTypes[X]({send:(ye,De,ve,Ce,$e,Re)=>this.actor.send(ye,De,ve,G,$e,Re),scheduler:this.actor.scheduler},this.getLayerIndex(G,pe),this.getAvailableImages(G,pe),this.getAvailableModels(G,pe),this.isSpriteLoaded[G][pe],void 0,this.brightness,this.worldview)),ae[G][pe][X][ie]}rasterizeImagesWorker(G,X,ie){let pe=new Map;for(let[ae,{image:ye,imageVariant:De}]of X.tasks.entries()){let ve=this.imageRasterizer.rasterize(De,ye,X.scope,G);pe.set(ae,ve)}ie(void 0,pe)}removeRasterizedImages(G,X,ie){this.imageRasterizer.removeImagesFromCacheByIds(X.imageIds,X.scope,G),ie()}enforceCacheSizeLimit(G,X){i.fp(X)}getWorkerPerformanceMetrics(G,X,ie){ie(void 0,void 0)}}return i.fl(self)&&(self.worker=new gn(self)),gn}),g(["./shared"],function(i){var A="3.13.0";let N={create:"create",load:"load",fullLoad:"fullLoad"},H={mark(u){performance.mark(u)},measure(u,t,o){performance.measure(u,t,o)}};function ce(u){let t=u.name.split("?")[0];return i.a(t)&&t.includes("mapbox-gl.js")?"javascript":i.a(t)&&t.includes("mapbox-gl.css")?"css":i.b(t)?"fontRange":i.c(t)?"sprite":i.i(t)?"style":i.d(t)?"tilejson":"other"}var be,Pe={},st=function(){if(be)return Pe;function u(h){return!t(h)}function t(h){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var _,v,E=new Blob([""],{type:"text/javascript"}),T=URL.createObjectURL(E);try{v=new Worker(T),_=!0}catch{_=!1}return v&&v.terminate(),URL.revokeObjectURL(T),_}()?function(){var _=document.createElement("canvas");_.width=_.height=1;var v=_.getContext("2d");if(!v)return!1;var E=v.getImageData(0,0,1,1);return E&&E.width===_.width}()?(o[m=h&&h.failIfMajorPerformanceCaveat]===void 0&&(o[m]=function(_){var v,E=function(T){var C=document.createElement("canvas"),M=Object.create(u.webGLContextAttributes);return M.failIfMajorPerformanceCaveat=T,C.getContext("webgl2",M)}(_);if(!E)return!1;try{v=E.createShader(E.VERTEX_SHADER)}catch{return!1}return!(!v||E.isContextLost())&&(E.shaderSource(v,"void main() {}"),E.compileShader(v),E.getShaderParameter(v,E.COMPILE_STATUS)===!0)}(m)),o[m]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var m}be=1,Pe.supported=u,Pe.notSupportedReason=t;var o={};return u.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},Pe}();function Se(u,t,o){let h=document.createElement(u);return t!=null&&(h.className=t),o&&o.appendChild(h),h}function It(u,t,o){let h=document.createElementNS("http://www.w3.org/2000/svg",u);for(let m of Object.keys(t))h.setAttributeNS(null,m,String(t[m]));return o&&o.appendChild(h),h}let Lt=typeof document<"u"?document.documentElement&&document.documentElement.style:null,hn=Lt&&Lt.userSelect!==void 0?"userSelect":"WebkitUserSelect",sn;function Yi(){Lt&&hn&&(sn=Lt[hn],Lt[hn]="none")}function fr(){Lt&&hn&&(Lt[hn]=sn)}function _o(u){u.preventDefault(),u.stopPropagation(),window.removeEventListener("click",_o,!0)}function Cs(){window.addEventListener("click",_o,!0),window.setTimeout(()=>{window.removeEventListener("click",_o,!0)},0)}function la(u,t){let o=u.getBoundingClientRect();return ji(u,o,t)}function ds(u,t){let o=u.getBoundingClientRect(),h=[];for(let m=0;m<t.length;m++)h.push(ji(u,o,t[m]));return h}function id(u){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&u.button===2&&u.ctrlKey?0:u.button}function ji(u,t,o){let h=u.offsetWidth===t.width?1:u.offsetWidth/t.width;return new i.P((o.clientX-t.left)*h,(o.clientY-t.top)*h)}let Qa="01",Pr="NO_ACCESS_TOKEN";class qn{constructor(t,o,h){this._transformRequestFn=t,this._customAccessToken=o,this._silenceAuthErrors=!!h,this._createSkuToken()}_createSkuToken(){let t=function(){let o="";for(let h=0;h<10;h++)o+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Qa,o].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,o){return this._transformRequestFn&&this._transformRequestFn(t,o)||{url:t}}normalizeStyleURL(t,o){if(!i.j(t))return t;let h=Qi(t);return h.params.push(`sdk=js-${A}`),h.path=`/styles/v1${h.path}`,this._makeAPIURL(h,this._customAccessToken||o)}normalizeGlyphsURL(t,o){if(!i.j(t))return t;let h=Qi(t);return h.path=`/fonts/v1${h.path}`,this._makeAPIURL(h,this._customAccessToken||o)}normalizeModelURL(t,o){if(!i.j(t))return t;let h=Qi(t);return h.path=`/models/v1${h.path}`,this._makeAPIURL(h,this._customAccessToken||o)}normalizeSourceURL(t,o,h,m){if(!i.j(t))return t;let _=Qi(t);return _.path=`/v4/${_.authority}.json`,_.params.push("secure"),h&&_.params.push(`language=${h}`),m&&_.params.push(`worldview=${m}`),this._makeAPIURL(_,this._customAccessToken||o)}normalizeIconsetURL(t,o){let h=Qi(t);return i.j(t)?(h.path=`/styles/v1${h.path}/iconset.pbf`,this._makeAPIURL(h,this._customAccessToken||o)):Ms(h)}normalizeSpriteURL(t,o,h,m){let _=Qi(t);return i.j(t)?(_.path=`/styles/v1${_.path}/sprite${o}${h}`,this._makeAPIURL(_,this._customAccessToken||m)):(_.path+=`${o}${h}`,Ms(_))}normalizeTileURL(t,o,h){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!i.j(t))return t;let m=Qi(t);m.path=m.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${o||h&&m.authority!=="raster"&&h===512?"@2x":""}${i.l.supported?".webp":"$1"}`),m.authority==="raster"?m.path=`/${i.e.RASTER_URL_PREFIX}${m.path}`:m.authority==="rasterarrays"?m.path=`/${i.e.RASTERARRAYS_URL_PREFIX}${m.path}`:m.authority==="3dtiles"?m.path=`/${i.e.TILES3D_URL_PREFIX}${m.path}`:(m.path=m.path.replace(/^.+\/v4\//,"/"),m.path=`/${i.e.TILE_URL_VERSION}${m.path}`);let _=this._customAccessToken||function(v){for(let E of v){let T=E.match(/^access_token=(.*)$/);if(T)return T[1]}return null}(m.params)||i.e.ACCESS_TOKEN;return i.e.REQUIRE_ACCESS_TOKEN&&_&&this._skuToken&&m.params.push(`sku=${this._skuToken}`),this._makeAPIURL(m,_)}canonicalizeTileURL(t,o){let h=Qi(t);if(!h.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!h.path.match(/\.[\w]+$/))return t;let m="mapbox://";h.path.match(/^\/raster\/v1\//)?m+=`raster/${h.path.replace(`/${i.e.RASTER_URL_PREFIX}/`,"")}`:h.path.match(/^\/rasterarrays\/v1\//)?m+=`rasterarrays/${h.path.replace(`/${i.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:m+=`tiles/${h.path.replace(`/${i.e.TILE_URL_VERSION}/`,"")}`;let _=h.params;return o&&(_=_.filter(v=>!v.match(/^access_token=/))),_.length&&(m+=`?${_.join("&")}`),m}canonicalizeTileset(t,o){let h=!!o&&i.j(o),m=[];for(let _ of t.tiles||[])i.k(_)?m.push(this.canonicalizeTileURL(_,h)):m.push(_);return m}_makeAPIURL(t,o){let h="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",m=Qi(i.e.API_URL);if(t.protocol=m.protocol,t.authority=m.authority,t.protocol==="http"){let _=t.params.indexOf("secure");_>=0&&t.params.splice(_,1)}if(m.path!=="/"&&(t.path=`${m.path}${t.path}`),!i.e.REQUIRE_ACCESS_TOKEN)return Ms(t);if(o=o||i.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!o)throw new Error(`An API access token is required to use Mapbox GL. ${h}`);if(o[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${h}`)}return t.params=t.params.filter(_=>_.indexOf("access_token")===-1),t.params.push(`access_token=${o||""}`),Ms(t)}}let Ui=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Qi(u){let t=u.match(Ui);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function Ms(u){let t=u.params.length?`?${u.params.join("&")}`:"";return`${u.protocol}://${u.authority}${u.path}${t}`}let As="mapbox.eventData";function Go(u){if(!u)return null;let t=u.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(i.m(t[1]))}catch{return null}}class pi{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){let o=Go(i.e.ACCESS_TOKEN),h="";return h=o&&o.u?i.f(o.u):i.e.ACCESS_TOKEN||"",t?`${As}.${t}:${h}`:`${As}:${h}`}fetchEventData(){let t=i.s("localStorage"),o=this.getStorageKey(),h=this.getStorageKey("uuid");if(t)try{let m=localStorage.getItem(o);m&&(this.eventData=JSON.parse(m));let _=localStorage.getItem(h);_&&(this.anonId=_)}catch{i.w("Unable to read from LocalStorage")}}saveEventData(){let t=i.s("localStorage"),o=this.getStorageKey(),h=this.getStorageKey("uuid"),m=this.anonId;if(t&&m)try{localStorage.setItem(h,m),Object.keys(this.eventData).length>=1&&localStorage.setItem(o,JSON.stringify(this.eventData))}catch{i.w("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,o,h,m){if(!i.e.EVENTS_URL)return;let _=Qi(i.e.EVENTS_URL);_.params.push(`access_token=${m||i.e.ACCESS_TOKEN||""}`);let v={event:this.type,created:new Date(t).toISOString()},E=o?i.h(v,o):v,T={url:Ms(_),headers:{"Content-Type":"text/plain"},body:JSON.stringify([E])};this.pendingRequest=i.p(T,C=>{this.pendingRequest=null,h(C),this.saveEventData(),this.processRequests(m)})}queueRequest(t,o){this.queue.push(t),this.processRequests(o)}}let yo=new class extends pi{constructor(u){super("appUserTurnstile"),this._customAccessToken=u}postTurnstileEvent(u,t){i.e.EVENTS_URL&&i.e.ACCESS_TOKEN&&Array.isArray(u)&&u.some(o=>i.j(o)||i.k(o))&&this.queueRequest(Date.now(),t)}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();let t=Go(i.e.ACCESS_TOKEN),o=t?t.u:i.e.ACCESS_TOKEN,h=o!==this.eventData.tokenU;i.v(this.anonId)||(this.anonId=i.u(),h=!0);let m=this.queue.shift();if(this.eventData.lastSuccess){let _=new Date(this.eventData.lastSuccess),v=new Date(m),E=(m-this.eventData.lastSuccess)/864e5;h=h||E>=1||E<-1||_.getDate()!==v.getDate()}else h=!0;h?this.postEvent(m,{sdkIdentifier:"mapbox-gl-js",sdkVersion:A,skuId:Qa,"enabled.telemetry":!1,userId:this.anonId},_=>{_||(this.eventData.lastSuccess=m,this.eventData.tokenU=o)},u):this.processRequests()}},qo=yo.postTurnstileEvent.bind(yo),ql=new class extends pi{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(u,t,o,h){this.skuToken=t,this.errorCb=h,i.e.EVENTS_URL&&(o||i.e.ACCESS_TOKEN?this.queueRequest({id:u,timestamp:Date.now()},o):this.errorCb(new Error(Pr)))}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;let{id:t,timestamp:o}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),i.v(this.anonId)||(this.anonId=i.u()),this.postEvent(o,{sdkIdentifier:"mapbox-gl-js",sdkVersion:A,skuId:Qa,skuToken:this.skuToken,userId:this.anonId},h=>{h?this.errorCb(h):t&&(this.success[t]=!0)},u))}remove(){this.errorCb=null}},Wl=ql.postMapLoadEvent.bind(ql),bi=new class extends pi{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(u){let t=this.mapInstanceIdMap.get(u);return t||(t=i.u(),this.mapInstanceIdMap.set(u,t)),t}getEventId(u){let t=this.eventIdPerMapInstanceMap.get(u)||0;return this.eventIdPerMapInstanceMap.set(u,t+1),t}postStyleLoadEvent(u,t){let{map:o,style:h,importedStyles:m}=t;if(!i.e.EVENTS_URL||!u&&!i.e.ACCESS_TOKEN)return;let _=this.getMapInstanceId(o),v={mapInstanceId:_,eventId:this.getEventId(_),style:h};m.length&&(v.importedStyles=m),this.queueRequest({timestamp:Date.now(),payload:v},u)}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;let{timestamp:t,payload:o}=this.queue.shift();this.postEvent(t,o,()=>{},u)}},Bi=bi.postStyleLoadEvent.bind(bi),er=new class extends pi{constructor(){super("gljs.performance")}postPerformanceEvent(u,t){i.e.EVENTS_URL&&(u||i.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},u)}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;let{timestamp:t,performanceData:o}=this.queue.shift(),h=function(m){let _=performance.getEntriesByType("resource"),v=performance.getEntriesByType("mark"),E=function(k){let j={};if(k){for(let B in k)if(B!=="other")for(let U of k[B]){let q=`${B}ResolveRangeMin`,Z=`${B}ResolveRangeMax`,ee=`${B}RequestCount`,re=`${B}RequestCachedCount`;j[q]=Math.min(j[q]||1/0,U.startTime),j[Z]=Math.max(j[Z]||-1/0,U.responseEnd);let ue=le=>{j[le]===void 0&&(j[le]=0),++j[le]};U.transferSize!==void 0&&U.transferSize===0&&ue(re),ue(ee)}}return j}(function(k,j){let B={};if(k)for(let U of k){let q=j(U);B[q]===void 0&&(B[q]=[]),B[q].push(U)}return B}(_,ce)),T=window.devicePixelRatio,C=navigator.connection||navigator.mozConnection||navigator.webkitConnection,M=C?C.effectiveType:void 0,O={counters:[],metadata:[],attributes:[]},P=(k,j,B)=>{B!=null&&k.push({name:j,value:B.toString()})};for(let k in E)P(O.counters,k,E[k]);if(m.interactionRange[0]!==1/0&&m.interactionRange[1]!==-1/0&&(P(O.counters,"interactionRangeMin",m.interactionRange[0]),P(O.counters,"interactionRangeMax",m.interactionRange[1])),v)for(let k of Object.keys(N)){let j=N[k],B=v.find(U=>U.name===j);B&&P(O.counters,j,B.startTime)}return P(O.counters,"visibilityHidden",m.visibilityHidden),P(O.attributes,"style",function(k){if(k)for(let j of k){let B=j.name.split("?")[0];if(i.i(B)){let U=B.split("/").slice(-2);if(U.length===2)return`mapbox://styles/${U[0]}/${U[1]}`}}}(_)),P(O.attributes,"terrainEnabled",m.terrainEnabled?"true":"false"),P(O.attributes,"fogEnabled",m.fogEnabled?"true":"false"),P(O.attributes,"projection",m.projection),P(O.attributes,"zoom",m.zoom),P(O.metadata,"devicePixelRatio",T),P(O.metadata,"connectionEffectiveType",M),P(O.metadata,"navigatorUserAgent",navigator.userAgent),P(O.metadata,"screenWidth",window.screen.width),P(O.metadata,"screenHeight",window.screen.height),P(O.metadata,"windowWidth",window.innerWidth),P(O.metadata,"windowHeight",window.innerHeight),P(O.metadata,"mapWidth",m.width/T),P(O.metadata,"mapHeight",m.height/T),P(O.metadata,"webglRenderer",m.renderer),P(O.metadata,"webglVendor",m.vendor),P(O.metadata,"sdkVersion",A),P(O.metadata,"sdkIdentifier","mapbox-gl-js"),O}(o);for(let m of h.metadata);for(let m of h.counters);for(let m of h.attributes);this.postEvent(t,h,()=>{},u)}},Po=er.postPerformanceEvent.bind(er),ai=new class extends pi{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(u,t,o,h){if(!i.e.API_URL||!i.e.SESSION_PATH)return;let m=Qi(i.e.API_URL+i.e.SESSION_PATH);m.params.push(`sku=${t||""}`),m.params.push(`access_token=${h||i.e.ACCESS_TOKEN||""}`);let _={url:Ms(m),headers:{"Content-Type":"text/plain"}};this.pendingRequest=i.g(_,v=>{this.pendingRequest=null,o(v),this.saveEventData(),this.processRequests(h)})}getSessionAPI(u,t,o,h){this.skuToken=t,this.errorCb=h,i.e.SESSION_PATH&&i.e.API_URL&&(o||i.e.ACCESS_TOKEN?this.queueRequest({id:u,timestamp:Date.now()},o):this.errorCb(new Error(Pr)))}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;let{id:t,timestamp:o}=this.queue.shift();t&&this.success[t]||this.getSession(o,this.skuToken,h=>{h?this.errorCb(h):t&&(this.success[t]=!0)},u)}remove(){this.errorCb=null}},Zl=ai.getSessionAPI.bind(ai),Rs=new Set;function Wo(u,t){t?Rs.add(u):Rs.delete(u)}class Vi{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,o){this._updatedSourceCaches[t]=o,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){let o=t.scope;this._updatedLayers[o]=this._updatedLayers[o]||new Set,this._updatedLayers[o].add(t.id),this.setDirty()}removeLayer(t){let o=t.scope;this._removedLayers[o]=this._removedLayers[o]||{},this._updatedLayers[o]=this._updatedLayers[o]||new Set,this._removedLayers[o][t.id]=t,this._updatedLayers[o].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){let t={};for(let o in this._updatedLayers)t[o]=t[o]||{},t[o].updatedIds=Array.from(this._updatedLayers[o].values());for(let o in this._removedLayers)t[o]=t[o]||{},t[o].removedIds=Object.keys(this._removedLayers[o]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(t){return this._updatedImages[t]?Array.from(this._updatedImages[t].values()):[]}updateImage(t,o){this._updatedImages[o]=this._updatedImages[o]||new Set,this._updatedImages[o].add(i.I.toString(t)),this.setDirty()}resetUpdatedImages(t){this._updatedImages[t]&&this._updatedImages[t].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function Xl(u){let{userImage:t}=u;return!!(t&&t.render&&t.render())&&(u.data.replace(new Uint8Array(t.data.buffer)),!0)}class ca extends i.E{constructor(t){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=t,t!=="raster"&&i.t()&&(this.imageRasterizerDispatcher=new i.D(i.x(),this,"Image Rasterizer Worker",1))}addScope(t){this.loaded.set(t,!1),this.imageProviders.set(t,new Map),this.images.set(t,new Map),this.updatedImages.set(t,new Set),this.callbackDispatchedThisFrame.set(t,new Set),this.patterns.set(t,new Map),this.atlasImage.set(t,new i.r({width:1,height:1}))}removeScope(t){this.loaded.delete(t),this.imageProviders.delete(t),this.images.delete(t),this.updatedImages.delete(t),this.callbackDispatchedThisFrame.delete(t),this.patterns.delete(t),this.atlasImage.delete(t);let o=this.atlasTexture.get(t);o&&(o.destroy(),this.atlasTexture.delete(t))}addImageProvider(t,o){this.imageProviders.has(o)||this.imageProviders.set(o,new Map),this.imageProviders.get(o).set(t.id,t)}removeImageProvider(t,o){this.imageProviders.has(o)&&this.imageProviders.get(o).delete(t)}getPendingImageProviders(){let t=[];for(let o of this.imageProviders.values())for(let h of o.values())h.hasPendingRequests()&&t.push(h);return t}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new i.y),this._imageRasterizer}isLoaded(){for(let t of this.loaded.keys())if(!this.loaded.get(t))return!1;return!0}setLoaded(t,o){if(this.loaded.get(o)!==t&&(this.loaded.set(o,t),t)){for(let{ids:h,callback:m}of this.requestors)this._notify(h,o,m);this.requestors=[]}}hasImage(t,o){return!!this.getImage(t,o)}getImage(t,o){return this.images.get(o).get(t.toString())}addImage(t,o,h){this._validate(t,h)&&this.images.get(o).set(t.toString(),h)}_validate(t,o){let h=!0;return this._validateStretch(o.stretchX,o.data&&o.data.width)||(this.fire(new i.z(new Error(`Image "${t.name}" has invalid "stretchX" value`))),h=!1),this._validateStretch(o.stretchY,o.data&&o.data.height)||(this.fire(new i.z(new Error(`Image "${t.name}" has invalid "stretchY" value`))),h=!1),this._validateContent(o.content,o)||(this.fire(new i.z(new Error(`Image "${t.name}" has invalid "content" value`))),h=!1),h}_validateStretch(t,o){if(!t)return!0;let h=0;for(let m of t){if(m[0]<h||m[1]<m[0]||o<m[1])return!1;h=m[1]}return!0}_validateContent(t,o){return t?t.length!==4||!o.usvg&&(t[0]<0||o.data.width<t[0]||t[1]<0||o.data.height<t[1]||t[2]<0||o.data.width<t[2]||t[3]<0||o.data.height<t[3])?!1:!(t[2]<t[0]||t[3]<t[1]):!0}updateImage(t,o,h){let m=this.images.get(o).get(t.toString());h.version=m.version+1,this.images.get(o).set(t.toString(),h),this.updatedImages.get(o).add(t),this.removeFromImageRasterizerCache(t,o)}clearUpdatedImages(t){this.updatedImages.get(t).clear()}removeFromImageRasterizerCache(t,o){this.spriteFormat!=="raster"&&(i.t()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[t],scope:o}):this.imageRasterizer.removeImagesFromCacheByIds([t],o))}removeImage(t,o){let h=this.images.get(o),m=h.get(t.toString());h.delete(t.toString()),this.patterns.get(o).delete(t.toString()),this.removeFromImageRasterizerCache(t,o),m.userImage&&m.userImage.onRemove&&m.userImage.onRemove()}listImages(t){return Array.from(this.images.get(t).keys()).map(o=>i.I.from(o))}getImages(t,o,h){let m=[],_=[],v=this.imageProviders.get(o);for(let M of t){if(!M.iconsetId){m.push(M);continue}let O=v.get(M.iconsetId);O&&(this.getImage(M,o)?_.push(M):O.addPendingRequest(M))}if(m.length===0)return void this._notify(_,o,h);let E=!0,T=!!this.loaded.get(o),C=this.images.get(o);if(!T)for(let M of m)C.has(M.toString())||(E=!1);T||E?this._notify(m,o,h):this.requestors.push({ids:m,scope:o,callback:h})}rasterizeImages(t,o){let h=new Map,{tasks:m,scope:_}=t;for(let[v,E]of m.entries()){let T=this.getImage(E.id,_);T&&h.set(v,{image:T,imageVariant:E})}this._rasterizeImages(_,h,o)}_rasterizeImages(t,o,h){if(i.t())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:o,scope:t},h);else{let m=new Map;for(let[_,{image:v,imageVariant:E}]of o.entries())m.set(_,this.imageRasterizer.rasterize(E,v,t,0));h(void 0,m)}}getUpdatedImages(t){return this.updatedImages.get(t)||new Set}_notify(t,o,h){let m=this.images.get(o),_=new Map;for(let v of t){if(!m.get(v.toString())){if(v.iconsetId)continue;this.fire(new i.A("styleimagemissing",{id:v.name}))}let E=m.get(v.toString());if(!E){i.w(`Image "${v.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}let T={data:E.usvg?null:E.data.clone(),pixelRatio:E.pixelRatio,sdf:E.sdf,usvg:E.usvg,version:E.version,stretchX:E.stretchX,stretchY:E.stretchY,content:E.content,hasRenderCallback:!!(E.userImage&&E.userImage.render)};E.usvg&&Object.assign(T,{width:E.icon.usvg_tree.width,height:E.icon.usvg_tree.height}),_.set(i.I.toString(v),T)}h(null,_)}getPixelSize(t){let{width:o,height:h}=this.atlasImage.get(t);return{width:o,height:h}}getPattern(t,o,h){let m=t.toString(),_=this.patterns.get(o),v=_.get(m),E=this.getImage(t,o);if(!E)return null;if(v){if(v.position.version===E.version)return v.position;v.position.version=E.version}else{if(E.usvg&&!E.data){let T=this.getPatternInFlightId(m,o);if(this.patternsInFlight.has(T))return null;this.patternsInFlight.add(T);let C=new i.B(t).scaleSelf(i.q.devicePixelRatio),M=new Map([[C.toString(),{image:E,imageVariant:C}]]);return this._rasterizeImages(o,M,(O,P)=>this.storePatternImage(C,o,E,h,P)),null}this.storePattern(t,o,E)}return this._updatePatternAtlas(o,h),_.get(m).position}getPatternInFlightId(t,o){return i.C(t,o)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(t,o,h,m,_){let v=t.toString(),E=_?_.get(v):void 0;E&&(h.data=E,this.storePattern(t.id,o,h),this._updatePatternAtlas(o,m),this.patternsInFlight.delete(this.getPatternInFlightId(t.id.toString(),o)))}storePattern(t,o,h){let m={w:h.data.width+2*i.F,h:h.data.height+2*i.F,x:0,y:0},_=new i.G(m,h,i.F);this.patterns.get(o).set(t.toString(),{bin:m,position:_})}bind(t,o){let h=t.gl,m=this.atlasTexture.get(o);m?this.dirty&&(m.update(this.atlasImage.get(o)),this.dirty=!1):(m=new i.T(t,this.atlasImage.get(o),h.RGBA8),this.atlasTexture.set(o,m)),m.bind(h.LINEAR,h.CLAMP_TO_EDGE)}_updatePatternAtlas(t,o){let h=this.patterns.get(t),m=Array.from(h.values()).map(({bin:C})=>C),{w:_,h:v}=i.H(m),E=this.atlasImage.get(t);E.resize({width:_||1,height:v||1});let T=this.images.get(t);for(let[C,{bin:M,position:O}]of h.entries()){let P=O.padding,k=M.x+P,j=M.y+P,B=T.get(C).data,U=B.width,q=B.height;P=P>1?P-1:P,i.r.copy(B,E,{x:0,y:0},{x:k,y:j},{width:U,height:q},o),i.r.copy(B,E,{x:0,y:q-P},{x:k,y:j-P},{width:U,height:P},o),i.r.copy(B,E,{x:0,y:0},{x:k,y:j+q},{width:U,height:P},o),i.r.copy(B,E,{x:U-P,y:0},{x:k-P,y:j},{width:P,height:q},o),i.r.copy(B,E,{x:0,y:0},{x:k+U,y:j},{width:P,height:q},o),i.r.copy(B,E,{x:U-P,y:q-P},{x:k-P,y:j-P},{width:P,height:P},o),i.r.copy(B,E,{x:0,y:q-P},{x:k+U,y:j-P},{width:P,height:P},o),i.r.copy(B,E,{x:0,y:0},{x:k+U,y:j+q},{width:P,height:P},o),i.r.copy(B,E,{x:U-P,y:0},{x:k-P,y:j+q},{width:P,height:P},o)}this.dirty=!0}beginFrame(){for(let t of this.images.keys())this.callbackDispatchedThisFrame.set(t,new Set)}dispatchRenderCallbacks(t,o){let h=this.images.get(o);for(let m of t){if(this.callbackDispatchedThisFrame.get(o).has(m.toString()))continue;this.callbackDispatchedThisFrame.get(o).add(m.toString());let _=h.get(m.toString());Xl(_)&&this.updateImage(m,o,_)}}}function Lr(u){let t=u.key,o=u.value,h=u.valueSpec||{},m=u.objectElementValidators||{},_=u.style,v=u.styleSpec,E=[],T=i.J(o);if(T!=="object")return[new i.V(t,o,`object expected, ${T} found`)];for(let C in o){let M=C.split(".")[0],O;m[M]?O=m[M]:h[M]?O=mi:m["*"]?O=m["*"]:h["*"]&&(O=mi),O?E=E.concat(O({key:(t&&`${t}.`)+C,value:o[C],valueSpec:h[M]||h["*"],style:_,styleSpec:v,object:o,objectKey:C},o)):E.push(new i.K(t,o[C],`unknown property "${C}"`))}for(let C in h)m[C]||h[C].required&&h[C].default===void 0&&o[C]===void 0&&E.push(new i.V(t,o,`missing required property "${C}"`));return E}function el(u){let t=u.value,o=u.valueSpec,h=u.style,m=u.styleSpec,_=u.key,v=u.arrayElementValidator||mi;if(i.J(t)!=="array")return[new i.V(_,t,`array expected, ${i.J(t)} found`)];if(o.length&&t.length!==o.length)return[new i.V(_,t,`array length ${o.length} expected, length ${t.length} found`)];if(o["min-length"]&&t.length<o["min-length"])return[new i.V(_,t,`array length at least ${o["min-length"]} expected, length ${t.length} found`)];let E={type:o.value,values:o.values,minimum:o.minimum,maximum:o.maximum,function:void 0};m.$version<7&&(E.function=o.function),i.J(o.value)==="object"&&(E=o.value);let T=[];for(let C=0;C<t.length;C++)T=T.concat(v({array:t,arrayIndex:C,value:t[C],valueSpec:E,style:h,styleSpec:m,key:`${_}[${C}]`},!0));return T}function _u(u){let t=u.key,o=u.value,h=u.valueSpec,m=i.J(o);if(m==="number"&&o!=o&&(m="NaN"),m!=="number")return[new i.V(t,o,`number expected, ${m} found`)];if("minimum"in h){let _=h.minimum;if(i.J(h.minimum)==="array"&&(_=h.minimum[u.arrayIndex]),o<_)return[new i.V(t,o,`${o} is less than the minimum value ${_}`)]}if("maximum"in h){let _=h.maximum;if(i.J(h.maximum)==="array"&&(_=h.maximum[u.arrayIndex]),o>_)return[new i.V(t,o,`${o} is greater than the maximum value ${_}`)]}return[]}function Or(u){let t=u.valueSpec,o=i.M(u.value.type),h,m,_,v={},E=o!=="categorical"&&u.value.property===void 0,T=!E,C=i.J(u.value.stops)==="array"&&i.J(u.value.stops[0])==="array"&&i.J(u.value.stops[0][0])==="object",M=Lr({key:u.key,value:u.value,valueSpec:u.styleSpec.function,style:u.style,styleSpec:u.styleSpec,objectElementValidators:{stops:function(k){if(o==="identity")return[new i.V(k.key,k.value,'identity function may not have a "stops" property')];let j=[],B=k.value;return j=j.concat(el({key:k.key,value:B,valueSpec:k.valueSpec,style:k.style,styleSpec:k.styleSpec,arrayElementValidator:O})),i.J(B)==="array"&&B.length===0&&j.push(new i.V(k.key,B,"array must have at least one stop")),j},default:function(k){return mi({key:k.key,value:k.value,valueSpec:t,style:k.style,styleSpec:k.styleSpec})}}});return o==="identity"&&E&&M.push(new i.V(u.key,u.value,'missing required property "property"')),o==="identity"||u.value.stops||M.push(new i.V(u.key,u.value,'missing required property "stops"')),o==="exponential"&&u.valueSpec.expression&&!i.N(u.valueSpec)&&M.push(new i.V(u.key,u.value,"exponential functions not supported")),u.styleSpec.$version>=8&&(T&&!i.O(u.valueSpec)?M.push(new i.V(u.key,u.value,"property functions not supported")):E&&!i.Q(u.valueSpec)&&M.push(new i.V(u.key,u.value,"zoom functions not supported"))),o!=="categorical"&&!C||u.value.property!==void 0||M.push(new i.V(u.key,u.value,'"property" property is required')),M;function O(k){let j=[],B=k.value,U=k.key;if(i.J(B)!=="array")return[new i.V(U,B,`array expected, ${i.J(B)} found`)];if(B.length!==2)return[new i.V(U,B,`array length 2 expected, length ${B.length} found`)];if(C){if(i.J(B[0])!=="object")return[new i.V(U,B,`object expected, ${i.J(B[0])} found`)];if(B[0].zoom===void 0)return[new i.V(U,B,"object stop key must have zoom")];if(B[0].value===void 0)return[new i.V(U,B,"object stop key must have value")];let q=i.M(B[0].zoom);if(typeof q!="number")return[new i.V(U,B[0].zoom,"stop zoom values must be numbers")];if(_&&_>q)return[new i.V(U,B[0].zoom,"stop zoom values must appear in ascending order")];q!==_&&(_=q,m=void 0,v={}),j=j.concat(Lr({key:`${U}[0]`,value:B[0],valueSpec:{zoom:{}},style:k.style,styleSpec:k.styleSpec,objectElementValidators:{zoom:_u,value:P}}))}else j=j.concat(P({key:`${U}[0]`,value:B[0],style:k.style,styleSpec:k.styleSpec},B));return i.S(i.U(B[1]))?j.concat([new i.V(`${U}[1]`,B[1],"expressions are not allowed in function stops.")]):j.concat(mi({key:`${U}[1]`,value:B[1],valueSpec:t,style:k.style,styleSpec:k.styleSpec}))}function P(k,j){let B=i.J(k.value),U=i.M(k.value),q=k.value!==null?k.value:j;if(h){if(B!==h)return[new i.V(k.key,q,`${B} stop domain type must match previous stop domain type ${h}`)]}else h=B;if(B!=="number"&&B!=="string"&&B!=="boolean"&&typeof U!="number"&&typeof U!="string"&&typeof U!="boolean")return[new i.V(k.key,q,"stop domain value must be a number, string, or boolean")];if(B!=="number"&&o!=="categorical"){let Z=`number expected, ${B} found`;return i.O(t)&&o===void 0&&(Z+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new i.V(k.key,q,Z)]}return o!=="categorical"||B!=="number"||typeof U=="number"&&isFinite(U)&&Math.floor(U)===U?o!=="categorical"&&B==="number"&&typeof U=="number"&&typeof m=="number"&&m!==void 0&&U<m?[new i.V(k.key,q,"stop domain values must appear in ascending order")]:(m=U,o==="categorical"&&U in v?[new i.V(k.key,q,"stop domain values must be unique")]:(v[U]=!0,[])):[new i.V(k.key,q,`integer expected, found ${String(U)}`)]}}function io(u){let t=(u.expressionContext==="property"?i.W:i.X)(i.U(u.value),u.valueSpec);if(t.result==="error")return t.value.map(h=>new i.V(`${u.key}${h.key}`,u.value,h.message));let o=t.value.expression||t.value._styleExpression.expression;if(u.expressionContext==="property"&&u.propertyKey==="text-font"&&!o.outputDefined())return[new i.V(u.key,u.value,`Invalid data expression for "${u.propertyKey}". Output values must be contained as literals within the expression.`)];if(u.expressionContext==="property"&&u.propertyType==="layout"&&!i.Y(o))return[new i.V(u.key,u.value,'"feature-state" data expressions are not supported with layout properties.')];if(u.expressionContext==="filter")return ua(o,u);if(u.expressionContext&&u.expressionContext.indexOf("cluster")===0){if(!i.Z(o,["zoom","feature-state"]))return[new i.V(u.key,u.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(u.expressionContext==="cluster-initial"&&!i._(o))return[new i.V(u.key,u.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function ua(u,t){let o=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(let m of t.valueSpec.expression.parameters)o.delete(m);if(o.size===0)return[];let h=[];return u instanceof i.$&&o.has(u.name)?[new i.V(t.key,t.value,`["${u.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(u.eachChild(m=>{h.push(...ua(m,t))}),h)}function ha(u){let t=u.key,o=u.value,h=u.valueSpec,m=[];return Array.isArray(h.values)?h.values.indexOf(i.M(o))===-1&&m.push(new i.V(t,o,`expected one of [${h.values.join(", ")}], ${JSON.stringify(o)} found`)):Object.keys(h.values).indexOf(i.M(o))===-1&&m.push(new i.V(t,o,`expected one of [${Object.keys(h.values).join(", ")}], ${JSON.stringify(o)} found`)),m}function da(u){return i.a1(i.U(u.value))?io(i.L({},u,{expressionContext:"filter",valueSpec:u.styleSpec[`filter_${u.layerType||"fill"}`]})):kr(u)}function kr(u){let t=u.value,o=u.key;if(i.J(t)!=="array")return[new i.V(o,t,`array expected, ${i.J(t)} found`)];let h=u.styleSpec,m,_=[];if(t.length<1)return[new i.V(o,t,"filter array must have at least 1 element")];switch(_=_.concat(ha({key:`${o}[0]`,value:t[0],valueSpec:h.filter_operator,style:u.style,styleSpec:u.styleSpec})),i.M(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&i.M(t[1])==="$type"&&_.push(new i.V(o,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&_.push(new i.V(o,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(m=i.J(t[1]),m!=="string"&&_.push(new i.V(`${o}[1]`,t[1],`string expected, ${m} found`)));for(let v=2;v<t.length;v++)m=i.J(t[v]),i.M(t[1])==="$type"?_=_.concat(ha({key:`${o}[${v}]`,value:t[v],valueSpec:h.geometry_type,style:u.style,styleSpec:u.styleSpec})):m!=="string"&&m!=="number"&&m!=="boolean"&&_.push(new i.V(`${o}[${v}]`,t[v],`string, number, or boolean expected, ${m} found`));break;case"any":case"all":case"none":for(let v=1;v<t.length;v++)_=_.concat(kr({key:`${o}[${v}]`,value:t[v],style:u.style,styleSpec:u.styleSpec}));break;case"has":case"!has":m=i.J(t[1]),t.length!==2?_.push(new i.V(o,t,`filter array for "${t[0]}" operator must have 2 elements`)):m!=="string"&&_.push(new i.V(`${o}[1]`,t[1],`string expected, ${m} found`))}return _}function Yl(u,t){let o=u.key,h=u.style,m=u.layer,_=u.styleSpec,v=u.value,E=u.objectKey,T=_[`${t}_${u.layerType}`];if(!T)return[];let C=E.match(/^(.*)-use-theme$/);if(t==="paint"&&C&&T[C[1]])return i.S(v)?[].concat(mi({key:u.key,value:v,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:h,styleSpec:_,expressionContext:"property",propertyType:t,propertyKey:E})):mi({key:o,value:v,valueSpec:{type:"string"},style:h,styleSpec:_});let M=E.match(/^(.*)-transition$/);if(t==="paint"&&M&&T[M[1]]&&T[M[1]].transition)return mi({key:o,value:v,valueSpec:_.transition,style:h,styleSpec:_});let O=u.valueSpec||T[E];if(!O)return[new i.K(o,v,`unknown property "${E}"`)];let P;if(i.J(v)==="string"&&i.O(O)&&!O.tokens&&(P=/^{([^}]+)}$/.exec(v))){let j=`\`{ "type": "identity", "property": ${P?JSON.stringify(P[1]):'"_"'} }\``;return[new i.V(o,v,`"${E}" does not support interpolation syntax
Use an identity property function instead: ${j}.`)]}let k=[];if(u.layerType==="symbol")E!=="text-field"||!h||h.glyphs||h.imports||k.push(new i.V(o,v,'use of "text-field" requires a style "glyphs" property')),E==="text-font"&&i.a2(i.U(v))&&i.M(v.type)==="identity"&&k.push(new i.V(o,v,'"text-font" does not support identity functions'));else if(u.layerType==="model"&&t==="paint"&&m&&m.layout&&m.layout.hasOwnProperty("model-id")&&i.O(O)&&(i.a3(O)||i.Q(O))){let j=i.W(i.U(v),O),B=j.value.expression||j.value._styleExpression.expression;B&&!i.Z(B,["measure-light"])&&(E==="model-emissive-strength"&&i._(B)&&i.Y(B)||k.push(new i.V(o,v,`${E} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return k.concat(mi({key:u.key,value:v,valueSpec:O,style:h,styleSpec:_,expressionContext:"property",propertyType:t,propertyKey:E}))}function Kl(u){return Yl(u,"paint")}function ro(u){return Yl(u,"layout")}function yu(u){let t=[],o=u.value,h=u.key,m=u.style,_=u.styleSpec;o.type||o.ref||t.push(new i.V(h,o,'either "type" or "ref" is required'));let v=i.M(o.type),E=i.M(o.ref);if(o.id){let T=i.M(o.id);for(let C=0;C<u.arrayIndex;C++){let M=m.layers[C];i.M(M.id)===T&&t.push(new i.V(h,o.id,`duplicate layer id "${o.id}", previously used at line ${M.id.__line__}`))}}if("ref"in o){let T;["type","source","source-layer","filter","layout"].forEach(C=>{C in o&&t.push(new i.V(h,o[C],`"${C}" is prohibited for ref layers`))}),m.layers.forEach(C=>{i.M(C.id)===E&&(T=C)}),T?T.ref?t.push(new i.V(h,o.ref,"ref cannot reference another ref layer")):v=i.M(T.type):typeof E=="string"&&t.push(new i.V(h,o.ref,`ref layer "${E}" not found`))}else if(v!=="background"&&v!=="sky"&&v!=="slot")if(o.source){let T=m.sources&&m.sources[o.source],C=T&&i.M(T.type);T?C==="vector"&&v==="raster"?t.push(new i.V(h,o.source,`layer "${o.id}" requires a raster source`)):C==="raster"&&v!=="raster"?t.push(new i.V(h,o.source,`layer "${o.id}" requires a vector source`)):C!=="vector"||o["source-layer"]?C==="raster-dem"&&v!=="hillshade"?t.push(new i.V(h,o.source,"raster-dem source can only be used with layer type 'hillshade'.")):C!=="raster-array"||["raster","raster-particle"].includes(v)?v==="line"&&o.paint&&(o.paint["line-gradient"]||o.paint["line-trim-offset"])&&C==="geojson"&&!T.lineMetrics?t.push(new i.V(h,o,`layer "${o.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):v==="raster-particle"&&C!=="raster-array"&&t.push(new i.V(h,o.source,`layer "${o.id}" requires a 'raster-array' source.`)):t.push(new i.V(h,o.source,"raster-array source can only be used with layer type 'raster'.")):t.push(new i.V(h,o,`layer "${o.id}" must specify a "source-layer"`)):t.push(new i.V(h,o.source,`source "${o.source}" not found`))}else t.push(new i.V(h,o,'missing required property "source"'));return t=t.concat(Lr({key:h,value:o,valueSpec:_.layer,style:u.style,styleSpec:u.styleSpec,objectElementValidators:{"*":()=>[],type:()=>mi({key:`${h}.type`,value:o.type,valueSpec:_.layer.type,style:u.style,styleSpec:u.styleSpec,object:o,objectKey:"type"}),filter:T=>da(i.L({layerType:v},T)),layout:T=>Lr({layer:o,key:T.key,value:T.value,valueSpec:{},style:T.style,styleSpec:T.styleSpec,objectElementValidators:{"*":C=>ro(i.L({layerType:v},C))}}),paint:T=>Lr({layer:o,key:T.key,value:T.value,valueSpec:{},style:T.style,styleSpec:T.styleSpec,objectElementValidators:{"*":C=>Kl(i.L({layerType:v,layer:o},C))}})}})),t}function Ps(u){let t=u.value,o=u.key,h=i.J(t);return h!=="string"?[new i.V(o,t,`string expected, ${h} found`)]:[]}let Jl={promoteId:function u({key:t,value:o}){if(i.J(o)==="string")return Ps({key:t,value:o});if(Array.isArray(o)){let h=[],m=i.U(o),_=i.X(m);return _.result==="error"&&_.value.forEach(v=>{h.push(new i.V(`${t}${v.key}`,null,`${v.message}`))}),i.Z(_.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||h.push(new i.V(`${t}`,null,"promoteId expression should be only feature dependent")),h}{let h=[];for(let m in o)h.push(...u({key:`${t}.${m}`,value:o[m]}));return h}}};function br(u){let t=u.value,o=u.key,h=u.styleSpec,m=u.style;if(!t.type)return[new i.V(o,t,'"type" is required')];let _=i.M(t.type),v=[];switch(["vector","raster","raster-dem","raster-array"].includes(_)&&(t.url||t.tiles||v.push(new i.K(o,t,'Either "url" or "tiles" is required.'))),_){case"vector":case"raster":case"raster-dem":case"raster-array":return v=v.concat(Lr({key:o,value:t,valueSpec:h[`source_${_.replace("-","_")}`],style:u.style,styleSpec:h,objectElementValidators:Jl})),v;case"geojson":if(v=Lr({key:o,value:t,valueSpec:h.source_geojson,style:m,styleSpec:h,objectElementValidators:Jl}),t.cluster)for(let E in t.clusterProperties){let[T,C]=t.clusterProperties[E],M=typeof T=="string"?[T,["accumulated"],["get",E]]:T;v.push(...io({key:`${o}.${E}.map`,value:C,expressionContext:"cluster-map"})),v.push(...io({key:`${o}.${E}.reduce`,value:M,expressionContext:"cluster-reduce"}))}return v;case"video":return Lr({key:o,value:t,valueSpec:h.source_video,style:m,styleSpec:h});case"image":return Lr({key:o,value:t,valueSpec:h.source_image,style:m,styleSpec:h});case"canvas":return[new i.V(o,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return ha({key:`${o}.type`,value:t.type,valueSpec:{values:Lo(h)}})}}function Lo(u){return u.source.reduce((t,o)=>{let h=u[o];return h.type.type==="enum"&&(t=t.concat(Object.keys(h.type.values))),t},[])}function tl(u){let t=u.value,o=u.styleSpec,h=o.light,m=u.style,_=[],v=i.J(t);if(t===void 0)return _;if(v!=="object")return _=_.concat([new i.V("light",t,`object expected, ${v} found`)]),_;for(let E in t){let T=E.match(/^(.*)-transition$/),C=E.match(/^(.*)-use-theme$/);_=_.concat(C&&h[C[1]]?mi({key:E,value:t[E],valueSpec:{type:"string"},style:m,styleSpec:o}):T&&h[T[1]]&&h[T[1]].transition?mi({key:E,value:t[E],valueSpec:o.transition,style:m,styleSpec:o}):h[E]?mi({key:E,value:t[E],valueSpec:h[E],style:m,styleSpec:o}):[new i.V(E,t[E],`unknown property "${E}"`)])}return _}function fa(u){let t=u.value,o=[];if(!t)return o;let h=i.J(t);if(h!=="object")return o=o.concat([new i.V("light-3d",t,`object expected, ${h} found`)]),o;let m=u.styleSpec,_=m["light-3d"],v=u.key,E=u.style,T=u.style.lights;for(let O of["type","id"])if(!(O in t))return o=o.concat([new i.V("light-3d",t,`missing property ${O} on light`)]),o;if(t.type&&T)for(let O=0;O<u.arrayIndex;O++){let P=i.M(t.type),k=T[O];i.M(k.type)===P&&o.push(new i.V(v,t.id,`duplicate light type "${t.type}", previously defined at line ${k.id.__line__}`))}let C=`properties_light_${t.type}`;if(!(C in m))return o=o.concat([new i.V("light-3d",t,`Invalid light type ${t.type}`)]),o;let M=m[C];for(let O in t)if(O==="properties"){let P=t[O],k=i.J(P);if(k!=="object")return o=o.concat([new i.V("properties",P,`object expected, ${k} found`)]),o;for(let j in P){let B=j.match(/^(.*)-transition$/),U=j.match(/^(.*)-use-theme$/);o=o.concat(U&&M[U[1]]?mi({key:O,value:P[j],valueSpec:{type:"string"},style:E,styleSpec:m}):B&&M[B[1]]&&M[B[1]].transition?mi({key:O,value:t[O],valueSpec:m.transition,style:E,styleSpec:m}):M[j]?mi({key:j,value:P[j],valueSpec:M[j],style:E,styleSpec:m}):[new i.K(u.key,P[j],`unknown property "${j}"`)])}}else o=o.concat(_[O]?mi({key:O,value:t[O],valueSpec:_[O],style:E,styleSpec:m}):[new i.K(O,t[O],`unknown property "${O}"`)]);return o}function nl(u){let t=u.value,o=u.key,h=u.style,m=u.styleSpec,_=m.terrain,v=[],E=i.J(t);if(t===void 0||E==="null")return v;if(E!=="object")return v=v.concat([new i.V("terrain",t,`object expected, ${E} found`)]),v;for(let T in t){let C=T.match(/^(.*)-transition$/),M=T.match(/^(.*)-use-theme$/);v=v.concat(M&&_[M[1]]?mi({key:T,value:t[T],valueSpec:{type:"string"},style:h,styleSpec:m}):C&&_[C[1]]&&_[C[1]].transition?mi({key:T,value:t[T],valueSpec:m.transition,style:h,styleSpec:m}):_[T]?mi({key:T,value:t[T],valueSpec:_[T],style:h,styleSpec:m}):[new i.K(T,t[T],`unknown property "${T}"`)])}if(t.source){let T=h.sources&&h.sources[t.source],C=T&&i.M(T.type);T?C!=="raster-dem"&&v.push(new i.V(o,t.source,`terrain cannot be used with a source of type ${String(C)}, it only be used with a "raster-dem" source type`)):v.push(new i.V(o,t.source,`source "${t.source}" not found`))}else v.push(new i.V(o,t,'terrain is missing required property "source"'));return v}function pa(u){let t=u.value,o=u.style,h=u.styleSpec,m=h.fog,_=[],v=i.J(t);if(t===void 0)return _;if(v!=="object")return _=_.concat([new i.V("fog",t,`object expected, ${v} found`)]),_;for(let E in t){let T=E.match(/^(.*)-transition$/),C=E.match(/^(.*)-use-theme$/);_=_.concat(C&&m[C[1]]?mi({key:E,value:t[E],valueSpec:{type:"string"},style:o,styleSpec:h}):T&&m[T[1]]&&m[T[1]].transition?mi({key:E,value:t[E],valueSpec:h.transition,style:o,styleSpec:h}):m[E]?mi({key:E,value:t[E],valueSpec:m[E],style:o,styleSpec:h}):[new i.K(E,t[E],`unknown property "${E}"`)])}return _}let Ql={"*":()=>[],array:el,boolean:function(u){let t=u.value,o=u.key,h=i.J(t);return h!=="boolean"?[new i.V(o,t,`boolean expected, ${h} found`)]:[]},number:_u,color:function(u){let t=u.key,o=u.value,h=i.J(o);return h!=="string"?[new i.V(t,o,`color expected, ${h} found`)]:i.a0.parseCSSColor(o)===null?[new i.V(t,o,`color expected, "${o}" found`)]:[]},enum:ha,filter:da,function:Or,layer:yu,object:Lr,source:br,model:i.a4,light:tl,"light-3d":fa,terrain:nl,fog:pa,string:Ps,formatted:function(u){return Ps(u).length===0?[]:io(u)},resolvedImage:function(u){return Ps(u).length===0?[]:io(u)},projection:function(u){let t=u.value,o=u.styleSpec,h=o.projection,m=u.style,_=[],v=i.J(t);if(v==="object")for(let E in t)_=_.concat(mi({key:E,value:t[E],valueSpec:h[E],style:m,styleSpec:o}));else v!=="string"&&(_=_.concat([new i.V("projection",t,`object or string expected, ${v} found`)]));return _},import:function(u){let{value:t,styleSpec:o}=u,v=t,{data:h}=v,m=Mw(v,["data"]);Object.defineProperty(m,"__line__",{value:t.__line__,enumerable:!1});let _=Lr(i.L({},u,{value:m,valueSpec:o.import}));return i.M(m.id)===""&&_.push(new i.V(`${u.key}.id`,m,"import id can't be an empty string")),h&&(_=_.concat(ec(h,o,{key:`${u.key}.data`}))),_},iconset:function(u){let t=u.value,o=u.key,h=u.styleSpec,m=u.style;if(!t.type)return[new i.V(o,t,'"type" is required')];let _=i.M(t.type),v=[];if(v=v.concat(Lr({key:o,value:t,valueSpec:h[`iconset_${_}`],style:m,styleSpec:h})),_==="source"&&t.source){let E=m.sources&&m.sources[t.source],T=E&&i.M(E.type);E?T!=="raster-array"&&v.push(new i.V(o,t.source,`iconset cannot be used with a source of type ${String(T)}, it only be used with a "raster-array" source type`)):v.push(new i.V(o,t.source,`source "${t.source}" not found`))}return v}};function mi(u,t=!1){let o=u.value,h=u.valueSpec,m=u.styleSpec;if(h.expression&&i.a2(i.M(o)))return Or(u);if(h.expression&&i.S(i.U(o)))return io(u);if(h.type&&Ql[h.type]){let _=Ql[h.type](u);return t===!0&&_.length>0&&i.J(u.value)==="array"?io(u):_}return Lr(i.L({},u,{valueSpec:h.type?m[h.type]:h}))}function ma(u){let t=u.value,o=u.key,h=Ps(u);return h.length||(t.indexOf("{fontstack}")===-1&&h.push(new i.V(o,t,'"glyphs" url must include a "{fontstack}" token')),t.indexOf("{range}")===-1&&h.push(new i.V(o,t,'"glyphs" url must include a "{range}" token'))),h}function ec(u,t=i.a5,o={}){return mi({key:o.key||"",value:u,valueSpec:t.$root,styleSpec:t,style:u,objectElementValidators:{glyphs:ma,"*":()=>[]}})}function oo(u,t=i.a5){return pe(ec(u,t))}let Pp=u=>pe(br(u)),rd=u=>pe(tl(u)),il=u=>pe(fa(u)),ot=u=>pe(nl(u)),Ls=u=>pe(pa(u)),Lp=u=>pe(function(t){let o=t.value,h=t.style,m=t.styleSpec,_=m.snow,v=[],E=i.J(o);if(o===void 0)return v;if(E!=="object")return v=v.concat([new i.V("snow",o,`object expected, ${E} found`)]),v;for(let T in o){let C=T.match(/^(.*)-transition$/);v=v.concat(C&&_[C[1]]&&_[C[1]].transition?mi({key:T,value:o[T],valueSpec:m.transition,style:h,styleSpec:m}):_[T]?mi({key:T,value:o[T],valueSpec:_[T],style:h,styleSpec:m}):[new i.K(T,o[T],`unknown property "${T}"`)])}return v}(u)),vu=u=>pe(function(t){let o=t.value,h=t.style,m=t.styleSpec,_=m.rain,v=[],E=i.J(o);if(o===void 0)return v;if(E!=="object")return v=v.concat([new i.V("rain",o,`object expected, ${E} found`)]),v;for(let T in o){let C=T.match(/^(.*)-transition$/);v=v.concat(C&&_[C[1]]&&_[C[1]].transition?mi({key:T,value:o[T],valueSpec:m.transition,style:h,styleSpec:m}):_[T]?mi({key:T,value:o[T],valueSpec:_[T],style:h,styleSpec:m}):[new i.K(T,o[T],`unknown property "${T}"`)])}return v}(u)),gn=u=>pe(yu(u)),Ae=u=>pe(da(u)),G=u=>pe(Kl(u)),X=u=>pe(ro(u)),ie=u=>pe(i.a4(u));function pe(u){return u.slice().sort((t,o)=>t.line&&o.line?t.line-o.line:0)}function ae(u,t){let o=!1;if(t&&t.length)for(let h of t)h instanceof i.K?i.w(h.message):(u.fire(new i.z(new Error(h.message))),o=!0);return o}let ye;class De extends i.E{constructor(t,o="flat"){super(),this._transitionable=new i.a6(ye||(ye=new i.a7({anchor:new i.a8(i.a5.light.anchor),position:new i.a9(i.a5.light.position),color:new i.a8(i.a5.light.color),intensity:new i.a8(i.a5.light.intensity)}))),this.setLight(t,o),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,o,h={}){this._validate(rd,t,h)||(this._transitionable.setTransitionOrValue(t),this.id=o)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,o,h){return(!h||h.validate!==!1)&&ae(this,t.call(oo,i.h({value:o,style:{glyphs:!0,sprite:!0},styleSpec:i.a5})))}}let ve=class extends i.E{constructor(u,t,o,h,m){super(),this.scope=o,this._transitionable=new i.a6(new i.a7({source:new i.a8(i.a5.terrain.source),exaggeration:new i.a8(i.a5.terrain.exaggeration)}),o,h),this._transitionable.setTransitionOrValue(u,h),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t,this.worldview=m}get(){return this._transitionable.serialize()}set(u,t){this._transitionable.setTransitionOrValue(u,t)}updateTransitions(u){this._transitioning=this._transitionable.transitioned(u,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(u){this.properties=this._transitioning.possiblyEvaluate(u)}getExaggeration(u){return this._transitioning.possiblyEvaluate(new i.aa(u,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;let u=this._transitionable._values.exaggeration;if(!u)return null;let t=u.value.expression;if(!t)return null;let o=-1,h=-1,m=1;for(let _ of t.zoomStops)m=t.evaluate(new i.aa(_,{worldview:this.worldview})),m>.01?(o=_,h=-1):h=_;return m<.01&&o>0&&h>o?[o,h]:null}isZoomDependent(){let u=this._transitionable._values.exaggeration;return u!=null&&u.value!=null&&u.value.expression!=null&&u.value.expression instanceof i.ab}},Ce=45,$e=65,Re=.05;function rt(u,t,o,h){let m=i.af(Ce,$e,o),[_,v]=xt(u,h),E=1-Math.min(1,Math.exp((t-_)/(v-_)*-6));return E*=E*E,E=Math.min(1,1.00747*E),E*m*u.alpha}function xt(u,t){let o=.5/Math.tan(.5*t);return[u.range[0]+o,u.range[1]+o]}function wt(u,t,o,h,m){let _=i.ad([],[t,o,h],m.mercatorFogMatrix);return rt(u,i.ae(_),m.pitch,m._fov)}function zt(u,t,o,h,m,_,v){let E=[[o,h,0],[m,h,0],[m,_,0],[o,_,0]],T=Number.MAX_VALUE,C=-Number.MAX_VALUE;for(let M of E){let O=i.ad([],M,t),P=i.ae(O);T=Math.min(T,P),C=Math.max(C,P)}return[rt(u,T,v.pitch,v._fov),rt(u,C,v.pitch,v._fov)]}class Vt extends i.E{constructor(t,o,h,m){super();let _=new i.a7({range:new i.a8(i.a5.fog.range),color:new i.a8(i.a5.fog.color),"color-use-theme":new i.a8({type:"string","property-type":"data-constant",default:"default"}),"high-color":new i.a8(i.a5.fog["high-color"]),"high-color-use-theme":new i.a8({type:"string","property-type":"data-constant",default:"default"}),"space-color":new i.a8(i.a5.fog["space-color"]),"space-color-use-theme":new i.a8({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new i.a8(i.a5.fog["horizon-blend"]),"star-intensity":new i.a8(i.a5.fog["star-intensity"]),"vertical-range":new i.a8(i.a5.fog["vertical-range"])});this._transitionable=new i.a6(_,h,new Map(m)),this.set(t,m),this._transitioning=this._transitionable.untransitioned(),this._transform=o,this.properties=new i.ag(_),this.scope=h}get state(){let t=this._transform,o=t.projection.name==="globe",h=i.ah(t.zoom),m=this.properties.get("range"),_=[.5,3];return{range:o?[i.ai(_[0],m[0],h),i.ai(_[1],m[1],h)]:m,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,o,h={}){if(this._validate(Ls,t,h))return;let m=i.h({},t);for(let _ of Object.keys(i.a5.fog))m[_]===void 0&&(m[_]=i.a5.fog[_].default);this._options=m,this._transitionable.setTransitionOrValue(this._options,o)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;let o=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:i.af(Ce,$e,t))*o.a}getOpacityAtLatLng(t,o){return this._transform.projection.supportsFog?function(h,m,_){let v=i.ac.fromLngLat(m),E=_.elevation?_.elevation.getAtPointOrZero(v):0;return wt(h,v.x,v.y,E,_)}(this.state,t,o):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];let o=this._transform.calculateFogTileMatrix(t.toUnwrapped());return zt(this.state,o,0,0,i.aj,i.aj,this._transform)}getOpacityForBounds(t,o,h,m,_){return this._transform.projection.supportsFog?zt(this.state,t,o,h,m,_,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?xt(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;let o=[4,5,6,7];for(let h of o){let m=t.points[h],_;if(m[2]>=0)_=m;else{let v=t.points[h-4];_=i.ak(v,m,v[2]/(v[2]-m[2]))}if(wt(this.state,_[0],_[1],0,this._transform)>=Re)return!0}return!1}updateConfig(t){this._transitionable.setTransitionOrValue(this._options,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,o,h){return(!h||h.validate!==!1)&&ae(this,t.call(oo,i.h({value:o,style:{glyphs:!0,sprite:!0},styleSpec:i.a5})))}}let Ut,rn,qt,Hn,li=class extends i.E{constructor(u,t,o,h){super();let m=Ut||(Ut=new i.a7({density:new i.a8(i.a5.snow.density),intensity:new i.a8(i.a5.snow.intensity),color:new i.a8(i.a5.snow.color),opacity:new i.a8(i.a5.snow.opacity),vignette:new i.a8(i.a5.snow.vignette),"vignette-color":new i.a8(i.a5.snow["vignette-color"]),"center-thinning":new i.a8(i.a5.snow["center-thinning"]),direction:new i.a8(i.a5.snow.direction),"flake-size":new i.a8(i.a5.snow["flake-size"])}));this._transitionable=new i.a6(m,o,new Map(h)),this.set(u,h),this._transitioning=this._transitionable.untransitioned(),this.properties=new i.ag(m),this.scope=o}get state(){let u=this.properties.get("opacity"),t=this.properties.get("color"),o=this.properties.get("direction"),h=i.al(o[0]),m=-Math.max(i.al(o[1]),.01),_=[Math.cos(h)*Math.cos(m),Math.sin(h)*Math.cos(m),Math.sin(m)],v=this.properties.get("vignette"),E=this.properties.get("vignette-color");return E.a=v,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new i.am(t.r,t.g,t.b,t.a*u),direction:_,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:E}}get(){return this._transitionable.serialize()}set(u,t,o={}){if(this._validate(Lp,u,o))return;let h=i.h({},u);for(let m of Object.keys(i.a5.snow))h[m]===void 0&&(h[m]=i.a5.snow[m].default);this._options=h,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(u){this._transitionable.setTransitionOrValue(this._options,new Map(u))}updateTransitions(u){this._transitioning=this._transitionable.transitioned(u,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(u){this.properties=this._transitioning.possiblyEvaluate(u)}_validate(u,t,o){return(!o||o.validate!==!1)&&ae(this,u.call(oo,i.h({value:t,style:{glyphs:!0,sprite:!0},styleSpec:i.a5})))}},ci=class extends i.E{constructor(u,t,o,h){super();let m=rn||(rn=new i.a7({density:new i.a8(i.a5.rain.density),intensity:new i.a8(i.a5.rain.intensity),color:new i.a8(i.a5.rain.color),opacity:new i.a8(i.a5.rain.opacity),vignette:new i.a8(i.a5.rain.vignette),"vignette-color":new i.a8(i.a5.rain["vignette-color"]),"center-thinning":new i.a8(i.a5.rain["center-thinning"]),direction:new i.a8(i.a5.rain.direction),"droplet-size":new i.a8(i.a5.rain["droplet-size"]),"distortion-strength":new i.a8(i.a5.rain["distortion-strength"])}));this._transitionable=new i.a6(m,o,new Map(h)),this.set(u,h),this._transitioning=this._transitionable.untransitioned(),this.properties=new i.ag(m),this.scope=o}get state(){let u=this.properties.get("opacity"),t=this.properties.get("color"),o=this.properties.get("direction"),h=i.al(o[0]),m=-Math.max(i.al(o[1]),.01),_=[Math.cos(h)*Math.cos(m),Math.sin(h)*Math.cos(m),Math.sin(m)],v=this.properties.get("vignette-color");return v.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new i.am(t.r,t.g,t.b,t.a*u),direction:_,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:v}}get(){return this._transitionable.serialize()}set(u,t,o={}){if(this._validate(vu,u,o))return;let h=i.h({},u);for(let m of Object.keys(i.a5.rain))h[m]===void 0&&(h[m]=i.a5.rain[m].default);this._options=h,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(u){this._transitionable.setTransitionOrValue(this._options,new Map(u))}updateTransitions(u){this._transitioning=this._transitionable.transitioned(u,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(u){this.properties=this._transitioning.possiblyEvaluate(u)}_validate(u,t,o){return(!o||o.validate!==!1)&&ae(this,u.call(oo,i.h({value:t,style:{glyphs:!0,sprite:!0},styleSpec:i.a5})))}};class An extends i.E{constructor(t,o,h,m){super(),this.scope=h,this._options=t,this.properties=new i.ag(o),this._transitionable=new i.a6(o,h,new Map(m)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,o){this._options=t,this._transitionable.setTransitionOrValue(t.properties,o)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class yn{constructor(t,o,h,m){this.screenBounds=t,this.cameraPoint=o,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=h,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,m)}static createFromScreenPoints(t,o){let h,m;if(t instanceof i.P||typeof t[0]=="number"){let _=i.P.convert(t);h=[_],m=o.isPointAboveHorizon(_)}else{let _=i.P.convert(t[0]),v=i.P.convert(t[1]),E=_.add(v)._div(2);h=[_,v],m=i.ao(_,v).every(T=>o.isPointAboveHorizon(T))&&o.isPointAboveHorizon(E)}return new yn(h,o.getCameraPoint(),m,o)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(t){return i.ao(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){let o=this.screenBounds[0],h=this.screenBounds.length===1?this.screenBounds[0].add(new i.P(1,1)):this.screenBounds[1],m=i.ao(o,h,0,!1);return this.cameraPoint.y>h.y&&(this.cameraPoint.x>o.x&&this.cameraPoint.x<h.x?m.splice(3,0,this.cameraPoint):this.cameraPoint.x>=h.x?m[2]=this.cameraPoint:this.cameraPoint.x<=o.x&&(m[3]=this.cameraPoint)),i.ap(m,t)}bufferedCameraGeometryGlobe(t){let o=this.screenBounds[0],h=this.screenBounds.length===1?this.screenBounds[0].add(new i.P(1,1)):this.screenBounds[1],m=i.ao(o,h,t),_=this.cameraPoint.clone();switch(3*((_.y>o.y)+(_.y>h.y))+((_.x>o.x)+(_.x>h.x))){case 0:m[0]=_,m[4]=_.clone();break;case 1:m.splice(1,0,_);break;case 2:m[1]=_;break;case 3:m.splice(4,0,_);break;case 5:m.splice(2,0,_);break;case 6:m[3]=_;break;case 7:m.splice(3,0,_);break;case 8:m[2]=_}return m}containsTile(t,o,h,m=0){let _=t.queryPadding/o._pixelsPerMercatorPixel+1,v=h?this._bufferedCameraMercator(_,o):this._bufferedScreenMercator(_,o),E=t.tileID.wrap+(v.unwrapped?m:0),T=v.polygon.map(U=>i.aq(t.tileTransform,U,E));if(!i.ar(T,0,0,i.aj,i.aj))return;E=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?m:0);let C=this.screenGeometryMercator.polygon.map(U=>i.as(t.tileTransform,U,E)),M=C.map(U=>new i.P(U[0],U[1])),O=o.getFreeCameraOptions().position||new i.ac(0,0,0),P=i.as(t.tileTransform,O,E),k=C.map(U=>{let q=i.at(U,U,P);return i.au(q,q),new i.av(P,q)}),j=i.aw(t,1,o.zoom)*o._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:M,tilespaceRays:k,bufferedTilespaceGeometry:T,bufferedTilespaceBounds:(B=i.ax(T),B.min.x=i.ay(B.min.x,0,i.aj),B.min.y=i.ay(B.min.y,0,i.aj),B.max.x=i.ay(B.max.x,0,i.aj),B.max.y=i.ay(B.max.y,0,i.aj),B),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:j};var B}_bufferedScreenMercator(t,o){let h=_i(t);if(this._screenRaycastCache[h])return this._screenRaycastCache[h];{let m;return m=o.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(t),o):{polygon:this.bufferedScreenGeometry(t).map(_=>o.pointCoordinate3D(_)),unwrapped:!0},this._screenRaycastCache[h]=m,m}}_bufferedCameraMercator(t,o){let h=_i(t);if(this._cameraRaycastCache[h])return this._cameraRaycastCache[h];{let m;return m=o.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),o):{polygon:this.bufferedCameraGeometry(t).map(_=>o.pointCoordinate3D(_)),unwrapped:!0},this._cameraRaycastCache[h]=m,m}}_projectAndResample(t,o){let h=function(_,v){let E=i.az([],v.pixelMatrix,v.globeMatrix),T=[0,-i.aB,0,1],C=[0,i.aB,0,1],M=[0,0,0,1];i.aA(T,T,E),i.aA(C,C,E),i.aA(M,M,E);let O=new i.P(T[0]/T[3],T[1]/T[3]),P=new i.P(C[0]/C[3],C[1]/C[3]),k=i.aC(_,O)&&T[3]<M[3],j=i.aC(_,P)&&C[3]<M[3];if(!k&&!j)return null;let B=function(se,oe,he){for(let fe=1;fe<se.length;fe++){let Te=wi(oe.pointCoordinate3D(se[fe-1]).x),Ie=wi(oe.pointCoordinate3D(se[fe]).x);if(he<0){if(Te<Ie)return{idx:fe,t:-Te/(Ie-1-Te)}}else if(Ie<Te)return{idx:fe,t:(1-Te)/(Ie+1-Te)}}return null}(_,v,k?-1:1);if(!B)return null;let{idx:U,t:q}=B,Z=U>1?Ri(_.slice(0,U),v):[],ee=U<_.length?Ri(_.slice(U),v):[];Z=Z.map(se=>new i.P(wi(se.x),se.y)),ee=ee.map(se=>new i.P(wi(se.x),se.y));let re=[...Z];re.length===0&&re.push(ee[ee.length-1]);let ue=i.ai(re[re.length-1].y,(ee.length===0?Z[0]:ee[0]).y,q),le;return le=k?[new i.P(0,ue),new i.P(0,0),new i.P(1,0),new i.P(1,ue)]:[new i.P(1,ue),new i.P(1,1),new i.P(0,1),new i.P(0,ue)],re.push(...le),ee.length===0?re.push(Z[0]):re.push(...ee),{polygon:re.map(se=>new i.ac(se.x,se.y)),unwrapped:!1}}(t,o);if(h)return h;let m=function(_,v){let E=!1,T=-1/0,C=0;for(let O=0;O<_.length-1;O++)_[O].x>T&&(T=_[O].x,C=O);for(let O=0;O<_.length-1;O++){let P=(C+O)%(_.length-1),k=_[P],j=_[P+1];Math.abs(k.x-j.x)>.5&&(k.x<j.x?(k.x+=1,P===0&&(_[_.length-1].x+=1)):(j.x+=1,P+1===_.length-1&&(_[0].x+=1)),E=!0)}let M=i.aD(v.center.lng);return E&&M<Math.abs(M-1)&&_.forEach(O=>{O.x-=1}),{polygon:_,unwrapped:E}}(Ri(t,o).map(_=>new i.P(wi(_.x),_.y)),o);return{polygon:m.polygon.map(_=>new i.ac(_.x,_.y)),unwrapped:m.unwrapped}}}function Ri(u,t){return i.aE(u,o=>{let h=t.pointCoordinate3D(o);o.x=h.x,o.y=h.y},1/256)}function wi(u){return u<0?1+u%1:u%1}function _i(u){return 100*u|0}function rr(u,t,o,h,m){let _=function(E,T){if(E)return m(E);if(T){if(u.url&&T.tiles&&u.tiles&&delete u.tiles,T.variants){if(!Array.isArray(T.variants))return m(new Error("variants must be an array"));for(let M of T.variants){if(M==null||typeof M!="object"||M.constructor!==Object)return m(new Error("variant must be an object"));if(!Array.isArray(M.capabilities))return m(new Error("capabilities must be an array"));if(M.capabilities.length===1&&M.capabilities[0]==="meshopt"){T=i.h(T,M);break}}}let C=i.aF(i.h({},T,u),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);C.tiles=t.canonicalizeTileset(C,u.url),m(null,C)}},v=function(E,T,C){if(!E)return null;if(!T&&!C)return E;C=C||E.worldview_default;let M=Object.values(E.language||{});if(M.length===0)return null;let O=Object.values(E.worldview||{});if(O.length===0)return null;let P=M.every(j=>j===T),k=O.every(j=>j===C);return P&&k?E:T in(E.language_options||{})||C in(E.worldview_options||{})?null:E.language_options&&E.worldview_options?E:null}(u.data,o,h);return v?i.q.frame(()=>_(null,v)):u.url?i.n(t.transformRequest(t.normalizeSourceURL(u.url,null,o,h),i.R.Source),_):i.q.frame(()=>{let C=u,{data:E}=C,T=Mw(C,["data"]);_(null,T)})}function Zr(u,t){let o=Math.pow(2,t.z),h=Math.floor(i.aD(u.getWest())*o),m=Math.floor(i.aH(u.getNorth())*o),_=Math.ceil(i.aD(u.getEast())*o),v=Math.ceil(i.aH(u.getSouth())*o);return t.x>=h&&t.x<_&&t.y>=m&&t.y<v}class wr{constructor(t,o,h){this.bounds=t?i.aG.convert(this.validateBounds(t)):null,this.minzoom=o||0,this.maxzoom=h||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}addExtraBounds(t){if(t){this.extraBounds||(this.extraBounds=[]);for(let o of t)this.extraBounds.push(i.aG.convert(this.validateBounds(o)))}}contains(t){if(t.z>this.maxzoom||t.z<this.minzoom||this.bounds&&!Zr(this.bounds,t))return!1;if(!this.extraBounds)return!0;for(let o of this.extraBounds)if(Zr(o,t))return!0;return!1}static fromTileJSON(t){if(!t.bounds&&!t.extra_bounds)return null;let o=new wr(t.bounds,t.minzoom,t.maxzoom);return o.addExtraBounds(t.extra_bounds),o}}class xu extends i.E{constructor(t,o,h,m){if(super(),this.id=t,this.dispatcher=h,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,i.h(this,i.aF(o,["url","scheme","tileSize","promoteId"])),this._options=i.h({type:"vector"},o),this._collectResourceTiming=!!o.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(m),this._tileWorkers={},this._deduped=new i.aI}load(t){this._loaded=!1,this.fire(new i.A("dataloading",{dataType:"source"}));let o=Array.isArray(this.map._language)?this.map._language.join():this.map._language,h=this.map.getWorldview();this._tileJSONRequest=rr(this._options,this.map._requestManager,o,h,(m,_)=>{if(this._tileJSONRequest=null,this._loaded=!0,m)o&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${o}`),h&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${h}`),this.fire(new i.z(m));else if(_){if(i.h(this,_),this.hasWorldviews=!!_.worldview_options,_.worldview_default&&(this.worldviewDefault=_.worldview_default),_.vector_layers){this.vectorLayers=_.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(let v of _.vector_layers)this.vectorLayerIds.push(v.id),_.worldview&&_.worldview[v.source]&&this.localizableLayerIds.add(v.id)}this.tileBounds=wr.fromTileJSON(_),qo(_.tiles,this.map._requestManager._customAccessToken),this.fire(new i.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.A("data",{dataType:"source",sourceDataType:"content"}))}t&&t(m)})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();let t=i.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return i.h({},this._options)}loadTile(t,o){let h=t.tileID.canonical.url(this.tiles,this.scheme),m=this.map._requestManager.normalizeTileURL(h),_=this.map._requestManager.transformRequest(m,i.R.Tile),v=this.map.style?this.map.style.getLut(this.scope):null,E=v?{image:v.image.clone()}:null,T={request:_,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:E,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:i.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault};if(this.hasWorldviews&&i.j(h)&&(T.localizableLayerIds=this.localizableLayerIds),T.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired")t.state==="loading"?t.reloadCallback=o:t.request=t.actor.send("reloadTile",T,C.bind(this));else if(t.actor=this._tileWorkers[m]=this._tileWorkers[m]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",T,C.bind(this),void 0,!0);else{let M=i.aJ.call({deduped:this._deduped},T,(O,P)=>{O||!P?C.call(this,O):(T.data={cacheControl:P.cacheControl,expires:P.expires,rawData:P.rawData.slice(0)},t.actor&&t.actor.send("loadTile",T,C.bind(this),void 0,!0))},!0);t.request={cancel:M}}function C(M,O){return delete t.request,t.aborted?o(null):M&&M.status!==404?o(M):(O&&O.resourceTiming&&(t.resourceTiming=O.resourceTiming),this.map._refreshExpiredTiles&&O&&t.setExpiryData(O),t.loadVectorData(O,this.map.painter),i.aK(this.dispatcher),o(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,o){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class ar extends i.E{constructor(t,o,h,m){super(),this.id=t,this.dispatcher=h,this.setEventedParent(m),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=i.h({type:"raster"},o),i.h(this,i.aF(o,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new i.A("dataloading",{dataType:"source"}));let o=this.map.getWorldview();this._tileJSONRequest=rr(this._options,this.map._requestManager,null,o,(h,m)=>{this._tileJSONRequest=null,this._loaded=!0,h?this.fire(new i.z(h)):m&&(i.h(this,m),m.raster_layers&&(this.rasterLayers=m.raster_layers,this.rasterLayerIds=this.rasterLayers.map(_=>_.id)),this.tileBounds=wr.fromTileJSON(m),qo(m.tiles),this.fire(new i.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.A("data",{dataType:"source",sourceDataType:"content"}))),t&&t(h)})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();let t=i.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return i.h({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,o){let h=i.q.devicePixelRatio>=2,m=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),h,this.tileSize);t.request=i.o(this.map._requestManager.transformRequest(m,i.R.Tile),(_,v,E,T)=>(delete t.request,t.aborted?(t.state="unloaded",o(null)):_?(t.state="errored",o(_)):v?(this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:E,expires:T}),t.setTexture(v,this.map.painter),t.state="loaded",i.aK(this.dispatcher),void o(null)):o(null)))}abortTile(t,o){t.request&&(t.request.cancel(),delete t.request),o&&o()}unloadTile(t,o){t.texture&&t.texture instanceof i.T?(t.destroy(!0),t.texture&&t.texture instanceof i.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),o&&o()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class ga extends ar{constructor(t,o,h,m){super(t,o,h,m),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._options=i.h({type:"raster-array"},o)}triggerRepaint(t){let o=this.map.painter._terrain,h=this.map.style.getSourceCache(this.id);o&&o.enabled&&h&&o._clearRenderCacheForTile(h.id,t.tileID),this.map.triggerRepaint()}loadTile(t,o){let h=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),m=this.map._requestManager.transformRequest(h,i.R.Tile),_={request:m,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};t.source=this.id,t.scope=this.scope,t.requestParams=m,t.actor||(t.actor=this.dispatcher.getActor());let v=(E,T,C,M)=>{if(delete t.request,t.aborted)return t.state="unloaded",o(null);if(E)return E.name==="AbortError"?void 0:(t.state="errored",o(E));if(this.map._refreshExpiredTiles&&T&&t.setExpiryData({cacheControl:C,expires:M}),this.partial)t.state="empty";else{if(!T)return o(null);t.state="loaded",t._isHeaderLoaded=!0,t._mrt=T}o(null)};t.request=this.partial?t.fetchHeader(void 0,v.bind(this)):t.actor.send("loadTile",_,v.bind(this),void 0,!0)}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,o){let h=t.texture;h&&h instanceof i.T?(t.destroy(!0),this.map.painter.saveTileTexture(h)):(t.destroy(),t.flushQueues(),t._isHeaderLoaded=!1,delete t._mrt,delete t.textureDescriptor),t.fbo&&(t.fbo.destroy(),delete t.fbo),delete t.request,delete t.requestParams,delete t.neighboringTiles,t.state="unloaded"}prepareTile(t,o,h){t._isHeaderLoaded&&(t.state!=="empty"&&(t.state="reloading"),t.fetchBand(o,h,(m,_)=>{if(m)return t.state="errored",this.fire(new i.z(m)),void this.triggerRepaint(t);_&&(t._isHeaderLoaded=!0,t.setTexture(_,this.map.painter),t.state="loaded",this.triggerRepaint(t))}))}getInitialBand(t){if(!this.rasterLayers)return 0;let o=this.rasterLayers.find(({id:_})=>_===t),h=o&&o.fields,m=h&&h.bands&&h.bands;return m?m[0]:0}getTextureDescriptor(t,o,h){if(!t)return;let m=o.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!m)return;let _=null;o instanceof i.aN?_=o.paint.get("raster-array-band"):o instanceof i.aO&&(_=o.paint.get("raster-particle-array-band"));let v=_||this.getInitialBand(m);if(v!=null)if(t.textureDescriptor){if(!t.updateNeeded(m,v)||h)return Object.assign({},t.textureDescriptor,{texture:t.texture})}else this.prepareTile(t,m,v)}getImages(t,o){let h=new Map;for(let m of t)for(let _ of o){let[v,E]=_.split("/"),T=m.getLayer(v);if(!T||!T.hasBand(E)||!T.hasDataForBand(E))continue;let{bytes:C,tileSize:M,buffer:O}=T.getBandView(E),P=M+2*O,k={data:new i.r({width:P,height:P},C),pixelRatio:2,sdf:!1,usvg:!1,version:0};h.set(_,k)}return h}}let od={vector:xu,raster:ar,"raster-dem":class extends ar{constructor(u,t,o,h){super(u,t,o,h),this.type="raster-dem",this.maxzoom=22,this._options=i.h({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(u,t){let o=this.map._requestManager.normalizeTileURL(u.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function h(m,_){m&&(u.state="errored",t(m)),_&&(u.dem=_,u.dem.onDeserialize(),u.needsHillshadePrepare=!0,u.needsDEMTextureUpload=!0,u.state="loaded",t(null))}u.request=i.o(this.map._requestManager.transformRequest(o,i.R.Tile),(function(m,_,v,E){if(delete u.request,u.aborted)u.state="unloaded",t(null);else if(m)u.state="errored",t(m);else if(_){this.map._refreshExpiredTiles&&u.setExpiryData({cacheControl:v,expires:E});let T=ImageBitmap&&_ instanceof ImageBitmap&&i.t(),C=1-(_.width-i.aL(_.width))/2;C<1||u.neighboringTiles||(u.neighboringTiles=this._getNeighboringTiles(u.tileID));let M=T?_:i.q.getImageData(_,C),O={uid:u.uid,tileID:u.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:M,encoding:this.encoding,padding:C};u.actor&&u.state!=="expired"||(u.actor=this.dispatcher.getActor(),u.actor.send("loadTile",O,h.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(u){let t=u.canonical,o=Math.pow(2,t.z),h=(t.x-1+o)%o,m=t.x===0?u.wrap-1:u.wrap,_=(t.x+1+o)%o,v=t.x+1===o?u.wrap+1:u.wrap,E={};return E[new i.aM(u.overscaledZ,m,t.z,h,t.y).key]={backfilled:!1},E[new i.aM(u.overscaledZ,v,t.z,_,t.y).key]={backfilled:!1},t.y>0&&(E[new i.aM(u.overscaledZ,m,t.z,h,t.y-1).key]={backfilled:!1},E[new i.aM(u.overscaledZ,u.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},E[new i.aM(u.overscaledZ,v,t.z,_,t.y-1).key]={backfilled:!1}),t.y+1<o&&(E[new i.aM(u.overscaledZ,m,t.z,h,t.y+1).key]={backfilled:!1},E[new i.aM(u.overscaledZ,u.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},E[new i.aM(u.overscaledZ,v,t.z,_,t.y+1).key]={backfilled:!1}),E}},"raster-array":ga,geojson:class extends i.E{constructor(u,t,o,h){super(),this.id=u,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=o.getActor(),this.setEventedParent(h),this._data=t.data,this._options=i.h({},t),this._collectResourceTiming=t.collectResourceTiming,t.maxzoom!==void 0&&(this.maxzoom=t.maxzoom),t.minzoom!==void 0&&(this.minzoom=t.minzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;let m=i.aj/this.tileSize;this.workerOptions=i.h({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(t.buffer!==void 0?t.buffer:128)*m,tolerance:(t.tolerance!==void 0?t.tolerance:.375)*m,extent:i.aj,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:t.clusterMaxZoom!==void 0?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:i.aj,radius:(t.clusterRadius!==void 0?t.clusterRadius:50)*m,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter,dynamic:t.dynamic},t.workerOptions)}onAdd(u){this.map=u,this.setData(this._data)}setData(u){return this._data=u,this._updateWorkerData(),this}updateData(u){if(!this._options.dynamic)return this.fire(new i.z(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof u!="string"&&(u.type==="Feature"&&(u={type:"FeatureCollection",features:[u]}),u.type!=="FeatureCollection"))return this.fire(new i.z(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof u!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){let t=new Map;for(let o of this._data.features)t.set(o.id,o);for(let o of u.features)t.set(o.id,o);this._data.features=[...t.values()]}else this._data=u;return this._updateWorkerData(!0),this}getClusterExpansionZoom(u,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:u,source:this.id,scope:this.scope},t),this}getClusterChildren(u,t){return this.actor.send("geojson.getClusterChildren",{clusterId:u,source:this.id,scope:this.scope},t),this}getClusterLeaves(u,t,o,h){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:u,limit:t,offset:o},h),this}_updateWorkerData(u=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new i.A("dataloading",{dataType:"source"})),this._loaded=!1;let t=i.h({append:u},this.workerOptions);t.scope=this.scope;let o=this._data;typeof o=="string"?(t.request=this.map._requestManager.transformRequest(i.q.resolveURL(o),i.R.Source),t.request.collectResourceTiming=this._collectResourceTiming):t.data=JSON.stringify(o),this._pendingLoad=this.actor.send(`${this.type}.loadData`,t,(h,m)=>{if(this._loaded=!0,this._pendingLoad=null,h)this.fire(new i.z(h));else{let _={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&m&&m.resourceTiming&&m.resourceTiming[this.id]&&(_.resourceTiming=m.resourceTiming[this.id]),u&&(this._partialReload=!0),this.fire(new i.A("data",_)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(u),this._coalesce=!1)})}loaded(){return this._loaded}reload(){let u=i.C(this.id,this.scope);this.map.style.clearSource(u),this._updateWorkerData()}loadTile(u,t){let o=u.actor?"reloadTile":"loadTile";u.actor=this.actor;let h=this.map.style?this.map.style.getLut(this.scope):null,m=h?{image:h.image.clone()}:null,_=this._partialReload,v={type:this.type,uid:u.uid,tileID:u.tileID,tileZoom:u.tileZoom,zoom:u.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:m,scope:this.scope,pixelRatio:i.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:u.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:_,worldview:this.map.getWorldview()};u.request=this.actor.send(o,v,(E,T)=>_&&!T?(u.state="loaded",t(null)):(delete u.request,u.destroy(),u.aborted?t(null):E?t(E):(u.loadVectorData(T,this.map.painter,o==="reloadTile"),t(null))),void 0,o==="loadTile")}abortTile(u){u.request&&(u.request.cancel(),delete u.request),u.aborted=!0}unloadTile(u,t){this.actor.send("removeTile",{uid:u.uid,type:this.type,source:this.id,scope:this.scope}),u.destroy()}onRemove(u){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return i.h({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends i.aP{constructor(u,t,o,h){super(u,t,o,h),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;let u=this.options;this.urls=[];for(let t of u.urls)this.urls.push(this.map._requestManager.transformRequest(t,i.R.Source).url);i.aQ(this.urls,(t,o)=>{this._loaded=!0,t?this.fire(new i.z(t)):o&&(this.video=o,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(u){if(this.video){let t=this.video.seekable;u<t.start(0)||u>t.end(0)?this.fire(new i.z(new i.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=u}}getVideo(){return this.video}onAdd(u){this.map||(this.map=u,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;let u=this.map.painter.context,t=u.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new i.T(u,this.video,t.RGBA8),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(u)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:i.aP,model:class extends i.E{constructor(u,t,o,h){super(),this.id=u,this.type="model",this.models=[],this._loaded=!1,this._options=t}load(){let u=[];for(let t in this._options.models){let o=this._options.models[t],h=i.aS(this.map._requestManager.transformRequest(o.uri,i.R.Model).url).then(m=>{if(!m)return;let _=i.aT(m),v=new i.aU(t,o.position,o.orientation,_);v.computeBoundsAndApplyParent(),this.models.push(v)}).catch(m=>{this.fire(new i.z(new Error(`Could not load model ${t} from ${o.uri}: ${m.message}`)))});u.push(h)}Promise.allSettled(u).then(()=>{this._loaded=!0,this.fire(new i.A("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(t=>{this._loaded=!0,this.fire(new i.z(new Error(`Could not load models: ${t.message}`)))})}onAdd(u){this.map=u,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(u,t){}serialize(){return this._options}},"batched-model":class extends i.E{constructor(u,t,o,h){super(),this.type="batched-model",this.id=u,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=o,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(h)}onAdd(u){this.map=u,this.load()}reload(){this.cancelTileJSONRequest();let u=i.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(u))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(u){this._loaded=!1,this.fire(new i.A("dataloading",{dataType:"source"}));let t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,o=this.map.getWorldview();this._tileJSONRequest=rr(this._options,this.map._requestManager,t,o,(h,m)=>{this._tileJSONRequest=null,this._loaded=!0,h?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),o&&o.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${o}`),this.fire(new i.z(h))):m&&(i.h(this,m),m.bounds&&(this.tileBounds=new wr(m.bounds,this.minzoom,this.maxzoom)),qo(m.tiles,this.map._requestManager._customAccessToken),this.fire(new i.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.A("data",{dataType:"source",sourceDataType:"content"}))),u&&u(h)})}hasTransition(){return!1}hasTile(u){return!this.tileBounds||this.tileBounds.contains(u.canonical)}loaded(){return this._loaded}loadTile(u,t){let o=this.map._requestManager.normalizeTileURL(u.tileID.canonical.url(this.tiles,this.scheme)),h={request:this.map._requestManager.transformRequest(o,i.R.Tile),data:void 0,uid:u.uid,tileID:u.tileID,tileZoom:u.tileZoom,zoom:u.tileID.overscaledZ,tileSize:this.tileSize*u.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:u.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:i.q.devicePixelRatio,promoteId:this.promoteId};if(u.actor&&u.state!=="expired")if(u.state==="loading")u.reloadCallback=t;else{if(u.buckets){let _=Object.values(u.buckets);for(let v of _)v.dirty=!0;return void(u.state="loaded")}u.request=u.actor.send("reloadTile",h,m.bind(this))}else u.actor=this.dispatcher.getActor(),u.request=u.actor.send("loadTile",h,m.bind(this),void 0,!0);function m(_,v){return u.aborted?t(null):_&&_.status!==404?t(_):(this.map._refreshExpiredTiles&&v&&u.setExpiryData(v),u.loadModelData(v,this.map.painter),u.state="loaded",void t(null))}}serialize(){return i.h({},this._options)}},canvas:class extends i.aP{constructor(u,t,o,h){super(u,t,o,h),t.coordinates?Array.isArray(t.coordinates)&&t.coordinates.length===4&&!t.coordinates.some(m=>!Array.isArray(m)||m.length!==2||m.some(_=>typeof _!="number"))||this.fire(new i.z(new i.V(`sources.${u}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new i.z(new i.V(`sources.${u}`,null,'missing required property "coordinates"'))),t.animate&&typeof t.animate!="boolean"&&this.fire(new i.z(new i.V(`sources.${u}`,null,'optional "animate" property must be a boolean value'))),t.canvas?typeof t.canvas=="string"||t.canvas instanceof HTMLCanvasElement||this.fire(new i.z(new i.V(`sources.${u}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new i.z(new i.V(`sources.${u}`,null,'missing required property "canvas"'))),this.options=t,this.animate=t.animate===void 0||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new i.z(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(u){this.map=u,this.load(),this.canvas&&this.animate&&this.play()}onRemove(u){this.pause()}prepare(){let u=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,u=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,u=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;let t=this.map.painter.context;this.texture?!u&&!this._playing||this.texture instanceof i.aR||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new i.T(t,this.canvas,t.gl.RGBA8,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(let u of[this.canvas.width,this.canvas.height])if(isNaN(u)||u<=0)return!0;return!1}},custom:class extends i.E{constructor(u,t,o,h){super(),this.id=u,this.type="custom",this._dataType="raster",this._dispatcher=o,this._implementation=t,this.setEventedParent(h),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new i.z(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new i.z(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new wr(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),i.h(this,i.aF(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return i.aF(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new i.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.A("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(u){this.map=u,this._loaded=!1,this.fire(new i.A("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(u),this.load()}onRemove(u){this._implementation.onRemove&&this._implementation.onRemove(u)}hasTile(u){if(this._implementation.hasTile){let{x:t,y:o,z:h}=u.canonical;return this._implementation.hasTile({x:t,y:o,z:h})}return!this.tileBounds||this.tileBounds.contains(u.canonical)}loadTile(u,t){let{x:o,y:h,z:m}=u.tileID.canonical,_=new AbortController;u.request=Promise.resolve(this._implementation.loadTile({x:o,y:h,z:m},{signal:_.signal})).then((function(v){return delete u.request,u.aborted?(u.state="unloaded",t(null)):v===void 0?(u.state="errored",t(null)):v===null?(this.loadTileData(u,{width:this.tileSize,height:this.tileSize,data:null}),u.state="loaded",t(null)):function(E){return E instanceof ImageData||E instanceof HTMLCanvasElement||E instanceof ImageBitmap||E instanceof HTMLImageElement}(v)?(this.loadTileData(u,v),u.state="loaded",void t(null)):(u.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(v=>{v.name!=="AbortError"&&(u.state="errored",t(v))}),u.request.cancel=()=>_.abort()}loadTileData(u,t){u.setTexture(t,this.map.painter)}unloadTile(u,t){if(u.texture&&u.texture instanceof i.T?(u.destroy(!0),u.texture&&u.texture instanceof i.T&&this.map.painter.saveTileTexture(u.texture)):u.destroy(),this._implementation.unloadTile){let{x:o,y:h,z:m}=u.tileID.canonical;this._implementation.unloadTile({x:o,y:h,z:m})}t&&t()}abortTile(u,t){u.request&&u.request.cancel&&(u.request.cancel(),delete u.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(u=>({x:u.canonical.x,y:u.canonical.y,z:u.canonical.z}))}_clearTiles(){let u=i.C(this.id,this.scope);this.map.style.clearSource(u)}_update(){this.fire(new i.A("data",{dataType:"source",sourceDataType:"content"}))}}},bu=function(u,t,o,h){let m=new od[t.type](u,t,o,h);if(m.id!==u)throw new Error(`Expected Source id to be ${u} instead of ${m.id}`);return i.aV(["load","abort","unload","serialize","prepare"],m),m};function wu(u,t,o=""){return`${o}:${t.id||""}:${t.layer.id}:${function(h){if("layerId"in h)return`layer:${h.layerId}`;{let{featuresetId:m,importId:_}=h;return`featureset:${m}${_?`:import:${_}`:""}`}}(u.target)}`}function sd(u,t,o,h=""){if(u.uniqueFeatureID){let m=wu(u,t,h);if(o.has(m))return!0;o.add(m)}return!1}function ad(u,t,o,h,m=!1){let _=t.sourceCache.transform,v=t.sourceCache.tilesIn(u,t.has3DLayers,m);v.sort(ld);let E=[];for(let T of v){let C=T.tile.queryRenderedFeatures(t,T,o,h,_,m);Object.keys(C).length&&E.push({wrappedTileID:T.tile.tileID.wrapped().key,queryResults:C})}return E.length===0?{}:function(T){let C={},M={};for(let O of T){let P=O.queryResults,k=O.wrappedTileID,j=M[k]=M[k]||{};for(let B in P){let U=P[B],q=j[B]=j[B]||{},Z=C[B]=C[B]||[];for(let ee of U)q[ee.featureIndex]||(q[ee.featureIndex]=!0,Z.push(ee))}}return C}(E)}function rl(u,t,o,h,m,_){let v={},E=h.queryRenderedSymbols(u),T=[];for(let C of Object.keys(E).map(Number))T.push(m[C]);T.sort(ld);for(let C of T){let M=C.featureIndex.lookupSymbolFeatures(E[C.bucketInstanceId],C.bucketIndex,C.sourceLayerIndex,t,o,_);for(let O in M){let P=v[O]=v[O]||[],k=M[O];k.sort((j,B)=>{let U=C.featureSortOrder;if(U){let q=U.indexOf(j.featureIndex);return U.indexOf(B.featureIndex)-q}return B.featureIndex-j.featureIndex});for(let j of k)P.push(j)}}return v}function Eu(u,t){let o=u.getRenderableIds().map(_=>u.getTileByID(_)),h=[],m={};for(let _=0;_<o.length;_++){let v=o[_],E=v.tileID.canonical.key;m[E]||(m[E]=!0,v.querySourceFeatures(h,t))}return h}function ld(u,t){let o=u.tileID,h=t.tileID;return o.overscaledZ-h.overscaledZ||o.canonical.y-h.canonical.y||o.wrap-h.wrap||o.canonical.x-h.canonical.x}function Zo(u,t){let o={};if(!t)return o;for(let h of u){let m=h.layerIds.map(_=>t.getLayer(_)).filter(Boolean);if(m.length!==0){h.layers=m,h.stateDependentLayerIds&&(h.stateDependentLayers=h.stateDependentLayerIds.map(_=>m.filter(v=>v.id===_)[0]));for(let _ of m)o[_.fqid]=h}}return o}let vo=32,Oo=33,Os=new Uint16Array(8184);for(let u=0;u<2046;u++){let t=u+2,o=0,h=0,m=0,_=0,v=0,E=0;for(1&t?m=_=v=vo:o=h=E=vo;(t>>=1)>1;){let C=o+m>>1,M=h+_>>1;1&t?(m=o,_=h,o=v,h=E):(o=m,h=_,m=v,_=E),v=C,E=M}let T=4*u;Os[T+0]=o,Os[T+1]=h,Os[T+2]=m,Os[T+3]=_}let Xo=new Uint16Array(2178),ks=new Uint8Array(1089),Tu=new Uint16Array(1089);function fs(u){return u===0?-.03125:u===32?.03125:0}let Iu={type:2,extent:i.aj,loadGeometry:()=>[[new i.P(0,0),new i.P(i.aj+1,0),new i.P(i.aj+1,i.aj+1),new i.P(0,i.aj+1),new i.P(0,0)]]};class ol{constructor(t,o,h,m,_,v){this.tileID=t,this.uid=i.a$(),this.uses=0,this.tileSize=o,this.tileZoom=h,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=_,m&&m.style&&(this._lastUpdatedBrightness=m.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",m&&m.transform&&(this.projection=m.transform.projection),this.worldview=v}registerFadeDuration(t){let o=t+this.timeAdded;o<i.q.now()||this.fadeEndTime&&o<this.fadeEndTime||(this.fadeEndTime=o)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=i.aW(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,o,h){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=Zo(t.buckets,o.style),this.hasSymbolBuckets=!1;for(let m in this.buckets){let _=this.buckets[m];if(_ instanceof i.b1){if(this.hasSymbolBuckets=!0,!h)break;_.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(let m in this.buckets){let _=this.buckets[m];if(_ instanceof i.b1&&_.hasRTLText){this.hasRTLText=!0,i.b2();break}}this.queryPadding=0;for(let m in this.buckets){let _=this.buckets[m],v=o.style.getOwnLayer(m);if(!v)continue;let E=v.queryRadius(_);this.queryPadding=Math.max(this.queryPadding,E)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new i.b0}unloadVectorData(){if(this.hasData()){for(let t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(t,o,h){t&&(t.resourceTiming&&(this.resourceTiming=t.resourceTiming),this.buckets=Object.assign({},this.buckets,Zo(t.buckets,o.style)),t.featureIndex&&(this.latestFeatureIndex=t.featureIndex))}getBucket(t){return this.buckets[t.fqid]}upload(t){for(let m in this.buckets){let _=this.buckets[m];_.uploadPending()&&_.upload(t)}let o=t.gl,h=this.imageAtlas;h&&!h.uploaded&&(this.imageAtlasTexture=new i.T(t,h.image,o.RGBA8,{useMipmap:!!h.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new i.T(t,this.glyphAtlasImage,o.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new i.T(t,this.lineAtlas.image,o.R8),this.lineAtlas.uploaded=!0)}prepare(t,o,h){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,h),!o||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;let m=o.style.getBrightness();(this._lastUpdatedBrightness||m)&&(this._lastUpdatedBrightness&&m&&Math.abs(this._lastUpdatedBrightness-m)<.001||(this.updateBuckets(o,this._lastUpdatedBrightness!==m),this._lastUpdatedBrightness=m))}queryRenderedFeatures(t,o,h,m,_,v){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};let E=function(T,C){let M=i.bn([],[.5*T.width,.5*-T.height,1]);return i.bo(M,M,[1,-1,0]),i.az(M,M,T.calculateProjMatrix(C.toUnwrapped())),Float32Array.from(M)}(_,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:o,pixelPosMatrix:E,transform:m,availableImages:h,tileTransform:this.tileTransform,worldview:this.worldview})}querySourceFeatures(t,o){let h=this.latestFeatureIndex;if(!h||!h.rawTileData)return;let m=h.loadVTLayers(),_=o?o.sourceLayer:"",v=m._geojsonTileLayer||m[_];if(!v)return;let E=i.b3(o&&o.filter),{z:T,x:C,y:M}=this.tileID.canonical,O={z:T,x:C,y:M};for(let P=0;P<v.length;P++){let k=v.feature(P);if(E.needGeometry){let U=i.b4(k,!0);if(!E.filter(new i.aa(this.tileID.overscaledZ,{worldview:this.worldview}),U,this.tileID.canonical))continue}else if(!E.filter(new i.aa(this.tileID.overscaledZ,{worldview:this.worldview}),k))continue;let j=h.getId(k,_),B=new i.b5(k,T,C,M,j);B.tile=O,t.push(B)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(t){let o=this.expirationTime;if(t.cacheControl){let h=i.b6(t.cacheControl);h["max-age"]&&(this.expirationTime=Date.now()+1e3*h["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){let h=Date.now(),m=!1;if(this.expirationTime>h)m=!1;else if(o)if(this.expirationTime<o)m=!0;else{let _=this.expirationTime-o;_?this.expirationTime=h+Math.max(_,3e4):m=!0}else m=!0;m?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(t){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&t&&this.updateBuckets(t)}updateBuckets(t,o){if(!this.latestFeatureIndex||!t.style)return;let h=this.latestFeatureIndex.loadVTLayers(),m=t.style.listImages(),_=t.style.getBrightness();for(let v in this.buckets){if(!t.style.hasLayer(v))continue;let E=this.buckets[v],T=E.layers[0],C=T.sourceLayer||"_geojsonTileLayer",M=h[C],O=t.style.getLayerSourceCache(T),P={};O&&(P=O._state.getState(C,void 0));let k=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},j=Object.keys(P).length>0&&!o;j&&!E.stateDependentLayers.length&&!o||E.update(P,M,m,k,j?E.stateDependentLayers:E.layers,o,_),(E instanceof i.b7||E instanceof i.b8)&&t._terrain&&t._terrain.enabled&&O&&E.uploadPending()&&t._terrain._clearRenderCacheForTile(O.id,this.tileID);let B=t&&t.style&&t.style.getOwnLayer(v);B&&(this.queryPadding=Math.max(this.queryPadding,B.queryRadius(E)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<i.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=i.q.now()+t}setTexture(t,o){let h=o.context,m=h.gl;this.texture=this.texture||o.getTileTexture(t.width),this.texture&&this.texture instanceof i.T?this.texture.update(t):(this.texture=new i.T(h,t,m.RGBA8,{useMipmap:!0}),this.texture.bind(m.LINEAR,m.CLAMP_TO_EDGE))}setDependencies(t,o){let h={};for(let m of o)h[m]=!0;this.dependencies[t]=h}hasDependency(t,o){for(let h of t){let m=this.dependencies[h];if(m){for(let _ of o)if(m[_])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,o){if(!o||o.name==="mercator"||this._tileDebugBuffer)return;let h=i.b9(Iu,this.tileID.canonical,this.tileTransform)[0],m=new i.ba,_=new i.bb;for(let v=0;v<h.length;v++){let{x:E,y:T}=h[v];m.emplaceBack(E,T),_.emplaceBack(v)}_.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(_),this._tileDebugBuffer=t.createVertexBuffer(m,i.bc.members),this._tileDebugSegments=i.bd.simpleSegment(0,0,m.length,_.length)}_makeTileBoundsBuffers(t,o){if(this._tileBoundsBuffer||!o||o.name==="mercator")return;let h=i.b9(Iu,this.tileID.canonical,this.tileTransform)[0],m,_;if(this.isRaster){let v=function(E,T){let C=i.aW(E,T),M=Math.pow(2,E.z);for(let U=0;U<Oo;U++)for(let q=0;q<Oo;q++){let Z=i.aX((E.x+(q+fs(q))/vo)/M),ee=i.aY((E.y+(U+fs(U))/vo)/M),re=T.project(Z,ee),ue=U*Oo+q;Xo[2*ue+0]=Math.round((re.x*C.scale-C.x)*i.aj),Xo[2*ue+1]=Math.round((re.y*C.scale-C.y)*i.aj)}ks.fill(0),Tu.fill(0);for(let U=2045;U>=0;U--){let q=4*U,Z=Os[q+0],ee=Os[q+1],re=Os[q+2],ue=Os[q+3],le=Z+re>>1,se=ee+ue>>1,oe=le+se-ee,he=se+Z-le,fe=ee*Oo+Z,Te=ue*Oo+re,Ie=se*Oo+le,Be=Math.hypot((Xo[2*fe+0]+Xo[2*Te+0])/2-Xo[2*Ie+0],(Xo[2*fe+1]+Xo[2*Te+1])/2-Xo[2*Ie+1])>=16;ks[Ie]=ks[Ie]||(Be?1:0),U<1022&&(ks[Ie]=ks[Ie]||ks[(ee+he>>1)*Oo+(Z+oe>>1)]||ks[(ue+he>>1)*Oo+(re+oe>>1)])}let O=new i.aZ,P=new i.a_,k=0;function j(U,q){let Z=q*Oo+U;return Tu[Z]===0&&(O.emplaceBack(Xo[2*Z+0],Xo[2*Z+1],U*i.aj/vo,q*i.aj/vo),Tu[Z]=++k),Tu[Z]-1}function B(U,q,Z,ee,re,ue){let le=U+Z>>1,se=q+ee>>1;if(Math.abs(U-re)+Math.abs(q-ue)>1&&ks[se*Oo+le])B(re,ue,U,q,le,se),B(Z,ee,re,ue,le,se);else{let oe=j(U,q),he=j(Z,ee),fe=j(re,ue);P.emplaceBack(oe,he,fe)}}return B(0,0,vo,vo,vo,0),B(vo,vo,0,0,0,vo),{vertices:O,indices:P}}(this.tileID.canonical,o);m=v.vertices,_=v.indices}else{m=new i.aZ,_=new i.a_;for(let{x:E,y:T}of h)m.emplaceBack(E,T,0,0);let v=i.be(m.int16.subarray(0,4*m.length),void 0,4);for(let E=0;E<v.length;E+=3)_.emplaceBack(v[E],v[E+1],v[E+2])}this._tileBoundsBuffer=t.createVertexBuffer(m,i.bf.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(_),this._tileBoundsSegments=i.bd.simpleSegment(0,0,m.length,_.length)}_makeGlobeTileDebugBuffers(t,o){let h=o.projection;if(!h||h.name!=="globe"||o.freezeTileCoverage)return;let m=this.tileID.canonical,_=i.bg(m,o),v=i.bh(_),E=i.ah(o.zoom),T;E>0&&(T=i.bi(new Float64Array(16),o.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,m,o,v,T,E),this._makeGlobeTileDebugTextBuffer(t,m,o,v,T,E)}_globePoint(t,o,h,m,_,v,E){let T=i.bj(t,o,h);if(v){let C=1<<h.z,M=i.aD(m.center.lng),O=i.aH(m.center.lat),P=(h.x+.5)/C-M,k=0;P>.5?k=-1:P<-.5&&(k=1);let j=(t/i.aj+h.x)/C+k,B=(o/i.aj+h.y)/C;j=(j-M)*m._pixelsPerMercatorPixel+M,B=(B-O)*m._pixelsPerMercatorPixel+O;let U=[j*m.worldSize,B*m.worldSize,0];i.ad(U,U,v),T=i.bk(T,U,E)}return i.ad(T,T,_)}_makeGlobeTileDebugBorderBuffer(t,o,h,m,_,v){let E=new i.ba,T=new i.bb,C=new i.bl,M=(P,k,j,B,U)=>{let q=(j-P)/(U-1),Z=(B-k)/(U-1),ee=E.length;for(let re=0;re<U;re++){let ue=P+re*q,le=k+re*Z;E.emplaceBack(ue,le);let se=this._globePoint(ue,le,o,h,m,_,v);C.emplaceBack(se[0],se[1],se[2]),T.emplaceBack(ee+re)}},O=i.aj;M(0,0,O,0,16),M(O,0,O,O,16),M(O,O,0,O,16),M(0,O,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(T),this._tileDebugBuffer=t.createVertexBuffer(E,i.bc.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(C,i.bm.members),this._tileDebugSegments=i.bd.simpleSegment(0,0,E.length,T.length)}_makeGlobeTileDebugTextBuffer(t,o,h,m,_,v){let E=i.aj/4,T=new i.ba,C=new i.a_,M=new i.bl,O=25;C.reserve(32),T.reserve(O),M.reserve(O);let P=(k,j)=>O*k+j;for(let k=0;k<O;k++){let j=k*E;for(let B=0;B<O;B++){let U=B*E;T.emplaceBack(U,j);let q=this._globePoint(U,j,o,h,m,_,v);M.emplaceBack(q[0],q[1],q[2])}}for(let k=0;k<4;k++)for(let j=0;j<4;j++){let B=P(k,j),U=P(k,j+1),q=P(k+1,j),Z=P(k+1,j+1);C.emplaceBack(B,U,q),C.emplaceBack(q,U,Z)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(C),this._tileDebugTextBuffer=t.createVertexBuffer(T,i.bc.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(M,i.bm.members),this._tileDebugTextSegments=i.bd.simpleSegment(0,0,O,32)}destroy(t=!1){for(let o in this.buckets)this.buckets[o].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!t&&this.texture&&this.texture instanceof i.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}i.bp.setPbf(i.bq);class tc extends ol{constructor(t,o,h,m,_){super(t,o,h,m,_),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(t){return this._mrt&&this._mrt.getLayer(t)}setTexture(t,o){let h=o.context,m=h.gl;this.texture=this.texture||o.getTileTexture(t.width),this.texture&&this.texture instanceof i.T?this.texture.update(t,{premultiply:!1}):this.texture=new i.T(h,t,m.RGBA8,{premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(t=16384,o){let h=this._mrt=new i.bp(30),m=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=i.br(m,(_,v,E,T)=>{if(_)o(_);else try{let C=h.getHeaderLength(v);if(C>t)return void(this.request=this.fetchHeader(C,o));h.parseHeader(v),this._isHeaderLoaded=!0;let M=0;for(let O of Object.values(h.layers))M=Math.max(M,O.dataIndex[O.dataIndex.length-1].lastByte);v.byteLength>=M&&(this.entireBuffer=v),o(null,this.entireBuffer||v,E,T)}catch(C){o(C)}}),this.request}fetchBand(t,o,h){let m=this._mrt;if(!this._isHeaderLoaded||!m)return void h(new Error("Tile header is not ready"));let _=this.actor;if(!_)return void h(new Error("Can't fetch tile band without an actor"));let v,E=(O,P)=>{v.complete(O,P),O?h(O):(this.updateTextureDescriptor(t,o),h(null,this.textureDescriptor&&this.textureDescriptor.img))},T=(O,P)=>{if(O)return h(O);let k=_.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:P,task:v},E,void 0,!0);this._workQueue.push(()=>{k&&k.cancel(),v.cancel()})},C=m.getLayer(t);if(!C)return void h(new Error(`Unknown sourceLayer "${t}"`));if(C.hasDataForBand(o))return this.updateTextureDescriptor(t,o),void h(null,this.textureDescriptor?this.textureDescriptor.img:null);let M=C.getDataRange([o]);if(v=m.createDecodingTask(M),!v||v.tasks.length)if(this.flushQueues(),this.entireBuffer)T(null,this.entireBuffer.slice(M.firstByte,M.lastByte+1));else{let O=Object.assign({},this.requestParams,{headers:{Range:`bytes=${M.firstByte}-${M.lastByte}`}}),P=i.br(O,T);this._fetchQueue.push(()=>{P.cancel(),v.cancel()})}else h(null)}updateNeeded(t,o){return(!this.textureDescriptor||this.textureDescriptor.band!==o||this.textureDescriptor.layer!==t)&&this.state!=="errored"}updateTextureDescriptor(t,o){if(!this._mrt)return;let h=this._mrt.getLayer(t);if(!h||!h.hasBand(o)||!h.hasDataForBand(o))return;let{bytes:m,tileSize:_,buffer:v,offset:E,scale:T}=h.getBandView(o),C=_+2*v,M=new i.r({width:C,height:C},m),O=this.texture;O&&O instanceof i.T&&O.update(M,{premultiply:!1}),this.textureDescriptor={layer:t,band:o,img:M,buffer:v,offset:E,tileSize:_,format:h.pixelFormat,mix:[T,256*T,65536*T,16777216*T]}}}class Op{constructor(t,o){this.max=t,this.onRemove=o,this.reset()}reset(){for(let t in this.data)for(let o of this.data[t])o.timeout&&clearTimeout(o.timeout),this.onRemove(o.value);return this.data={},this.order=[],this}add(t,o,h){let m=t.wrapped().key;this.data[m]===void 0&&(this.data[m]=[]);let _={value:o,timeout:void 0};if(h!==void 0&&(_.timeout=setTimeout(()=>{this.remove(t,_)},h)),this.data[m].push(_),this.order.push(m),this.order.length>this.max){let v=this._getAndRemoveByKey(this.order[0]);v&&this.onRemove(v)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){let o=this.data[t].shift();return o.timeout&&clearTimeout(o.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),o.value}getByKey(t){let o=this.data[t];return o?o[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,o){if(!this.has(t))return this;let h=t.wrapped().key,m=o===void 0?0:this.data[h].indexOf(o),_=this.data[h][m];return this.data[h].splice(m,1),_.timeout&&clearTimeout(_.timeout),this.data[h].length===0&&delete this.data[h],this.onRemove(_.value),this.order.splice(this.order.indexOf(h),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){let o=this._getAndRemoveByKey(this.order[0]);o&&this.onRemove(o)}return this}filter(t){let o=[];for(let h in this.data)for(let m of this.data[h])t(m.value)||o.push(m);for(let h of o)this.remove(h.value.tileID,h)}}class kp{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,o,h){let m=String(o);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][m]=this.stateChanges[t][m]||{},i.h(this.stateChanges[t][m],h),this.deletedStates[t]===null){this.deletedStates[t]={};for(let _ in this.state[t])_!==m&&(this.deletedStates[t][_]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][m]===null){this.deletedStates[t][m]={};for(let _ in this.state[t][m])h[_]||(this.deletedStates[t][m][_]=null)}else for(let _ in h)this.deletedStates[t]&&this.deletedStates[t][m]&&this.deletedStates[t][m][_]===null&&delete this.deletedStates[t][m][_]}removeFeatureState(t,o,h){if(this.deletedStates[t]===null)return;let m=String(o);if(this.deletedStates[t]=this.deletedStates[t]||{},h&&o!==void 0)this.deletedStates[t][m]!==null&&(this.deletedStates[t][m]=this.deletedStates[t][m]||{},this.deletedStates[t][m][h]=null);else if(o!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][m])for(h in this.deletedStates[t][m]={},this.stateChanges[t][m])this.deletedStates[t][m][h]=null;else this.deletedStates[t][m]=null;else this.deletedStates[t]=null}getState(t,o){let h=this.state[t]||{},m=this.stateChanges[t]||{},_=this.deletedStates[t];if(_===null)return{};if(o!==void 0){let E=String(o),T=i.h({},h[E],m[E]);if(_){let C=_[o];if(C===null)return{};for(let M in C)delete T[M]}return T}let v=i.h({},h,m);if(_)for(let E in _)delete v[E];return v}initializeTileState(t,o){t.refreshFeatureState(o)}coalesceChanges(t,o){let h={};for(let m in this.stateChanges){this.state[m]=this.state[m]||{};let _={};for(let v in this.stateChanges[m])this.state[m][v]||(this.state[m][v]={}),i.h(this.state[m][v],this.stateChanges[m][v]),_[v]=this.state[m][v];h[m]=_}for(let m in this.deletedStates){this.state[m]=this.state[m]||{};let _={};if(this.deletedStates[m]===null)for(let v in this.state[m])_[v]={},this.state[m][v]={};else for(let v in this.deletedStates[m]){if(this.deletedStates[m][v]===null)this.state[m][v]={};else if(this.state[m][v])for(let E of Object.keys(this.deletedStates[m][v]))delete this.state[m][v][E];_[v]=this.state[m][v]}h[m]=h[m]||{},i.h(h[m],_)}if(this.stateChanges={},this.deletedStates={},Object.keys(h).length!==0)for(let m in t)t[m].refreshFeatureState(o)}}class Xr extends i.E{constructor(t,o,h){super(),this.id=t,this._onlySymbols=h,o.on("data",m=>{m.dataType==="source"&&m.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&m.dataType==="source"&&m.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),o.on("error",()=>{this._sourceErrored=!0}),this._source=o,this._tiles={},this._cache=new Op(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=o.minTileCacheSize,this._maxTileCacheSize=o.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new kp,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(let t in this._tiles)if(!this._tiles[t].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;let t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,o){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,o)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t)}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t)}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(let o in this._tiles){let h=this._tiles[o];h.upload(t),h.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map(t=>t.tileID).sort(sl).map(t=>t.key)}getRenderableIds(t,o){let h=[];for(let m in this._tiles)this._isIdRenderable(+m,t,o)&&h.push(this._tiles[m]);return t?h.sort((m,_)=>{let v=m.tileID,E=_.tileID,T=new i.P(v.canonical.x,v.canonical.y)._rotate(this.transform.angle),C=new i.P(E.canonical.x,E.canonical.y)._rotate(this.transform.angle);return v.overscaledZ-E.overscaledZ||C.y-T.y||C.x-T.x}).map(m=>m.tileID.key):h.map(m=>m.tileID).sort(sl).map(m=>m.key)}hasRenderableParent(t){let o=this.findLoadedParent(t,0);return!!o&&this._isIdRenderable(o.tileID.key)}_isIdRenderable(t,o,h){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(o||!this._tiles[t].holdingForFade())&&(h||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(let t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,o){let h=this._tiles[t];h&&(h.state!=="loading"&&(h.state=o),this._loadTile(h,this._tileLoaded.bind(this,h,t,o)))}_tileLoaded(t,o,h,m){if(m)if(t.state="errored",m.status!==404)this._source.fire(new i.z(m,{tile:t}));else{if(this._source.fire(new i.A("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){let _=this.map.painter.terrain;this.update(this.transform,_.getScaledDemTileSize(),!0),_.resetTileLookupCache(this.id)}else this.update(this.transform)}else t.timeAdded=i.q.now(),h==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(o,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new i.A("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){let o=this.getRenderableIds();for(let m=0;m<o.length;m++){let _=o[m];if(t.neighboringTiles&&t.neighboringTiles[_]){let v=this.getTileByID(_);h(t,v),h(v,t)}}function h(m,_){if(!m.dem||m.dem.borderReady)return;m.needsHillshadePrepare=!0,m.needsDEMTextureUpload=!0;let v=_.tileID.canonical.x-m.tileID.canonical.x,E=_.tileID.canonical.y-m.tileID.canonical.y,T=Math.pow(2,m.tileID.canonical.z),C=_.tileID.key;v===0&&E===0||Math.abs(E)>1||(Math.abs(v)>1&&(Math.abs(v+T)===1?v+=T:Math.abs(v-T)===1&&(v-=T)),_.dem&&m.dem&&(m.dem.backfillBorder(_.dem,v,E),m.neighboringTiles&&m.neighboringTiles[C]&&(m.neighboringTiles[C].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,o,h,m){for(let _ in this._tiles){let v=this._tiles[_];if(m[_]||!v.hasData()||v.tileID.overscaledZ<=o||v.tileID.overscaledZ>h)continue;let E=v.tileID;for(;v&&v.tileID.overscaledZ>o+1;){let C=v.tileID.scaledTo(v.tileID.overscaledZ-1);v=this._tiles[C.key],v&&v.hasData()&&(E=C)}let T=E;for(;T.overscaledZ>o;)if(T=T.scaledTo(T.overscaledZ-1),t[T.key]){m[E.key]=E;break}}}findLoadedParent(t,o){if(t.key in this._loadedParentTiles){let h=this._loadedParentTiles[t.key];return h&&h.tileID.overscaledZ>=o?h:null}for(let h=t.overscaledZ-1;h>=o;h--){let m=t.scaledTo(h),_=this._getLoadedTile(m);if(_)return _}}_getLoadedTile(t){let o=this._tiles[t.key];return o&&o.hasData()?o:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,o){o=o||this._source.tileSize;let h=Math.ceil(t.width/o)+1,m=Math.ceil(t.height/o)+1,_=Math.floor(h*m*5),v=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,_):_,E=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,v):v;this._cache.setMaxSize(E)}handleWrapJump(t){let o=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,o){let h={};for(let m in this._tiles){let _=this._tiles[m];_.tileID=_.tileID.unwrapTo(_.tileID.wrap+o),h[_.tileID.key]=_}this._tiles=h;for(let m in this._timers)clearTimeout(this._timers[m]),delete this._timers[m];for(let m in this._tiles)this._setTileReloadTimer(+m,this._tiles[m])}}update(t,o,h,m,_){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!h)return;this.updateCacheSize(t,o),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};let v=this._source.type==="batched-model",E,T=this._source.maxzoom,C=this.map&&this.map.painter?this.map.painter._terrain:null;if(C&&C.sourceCache===this&&C.attenuationRange()){let P=C.attenuationRange()[0],k=Math.floor(P)-Math.log2(C.getDemUpscale());T>k&&(T=k)}if(this.used||this.usedForTerrain){if(this._source.tileID)E=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(P=>new i.aM(P.canonical.z,P.wrap,P.canonical.z,P.canonical.x,P.canonical.y));else if(this.tileCoverLift!==0){let P=t.clone();P.tileCoverLift=this.tileCoverLift,E=P.coveringTiles({tileSize:o||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:T,roundZoom:this._source.roundZoom&&!h,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:v}),this._source.minzoom<=1&&t.projection.name==="globe"&&(E.push(new i.aM(1,0,1,0,0)),E.push(new i.aM(1,0,1,1,0)),E.push(new i.aM(1,0,1,0,1)),E.push(new i.aM(1,0,1,1,1)))}else if(E=t.coveringTiles({tileSize:o||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:T,roundZoom:this._source.roundZoom&&!h,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:v}),this._source.hasTile){let P=this._source.hasTile.bind(this._source);E=E.filter(k=>P(k))}}else E=[];if(E.length>0&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!Su(this._source.type)){let P=t.coveringZoomLevel({tileSize:o||this._source.tileSize,roundZoom:this._source.roundZoom&&!h}),k=Math.min(P,this._source.maxzoom);if(v){let j=t.extendTileCover(E,k);for(let B of j)E.push(B)}else if(_){let j=t.extendTileCover(E,k,this.transform._camera.forward());for(let B of j)E.push(B)}else if(this.castsShadows&&m){let j=t.extendTileCover(E,k,m);for(let B of j)this._shadowCasterTiles[B.key]=!0,E.push(B)}}let M=this._updateRetainedTiles(E);if(Su(this._source.type)&&E.length!==0){let P={},k={},j=Object.keys(M);for(let U of j){let q=M[U],Z=this._tiles[U];if(!Z||Z.fadeEndTime&&Z.fadeEndTime<=i.q.now())continue;let ee=this.findLoadedParent(q,Math.max(q.overscaledZ-Xr.maxOverzooming,this._source.minzoom));ee&&(this._addTile(ee.tileID),P[ee.tileID.key]=ee.tileID),k[U]=q}let B=E[E.length-1].overscaledZ;for(let U in this._tiles){let q=this._tiles[U];if(M[U]||!q.hasData())continue;let Z=q.tileID;for(;Z.overscaledZ>B;){Z=Z.scaledTo(Z.overscaledZ-1);let ee=this._tiles[Z.key];if(ee&&ee.hasData()&&k[Z.key]){M[U]=q.tileID;break}}}for(let U in P)M[U]||(this._coveredTiles[U]=!0,M[U]=P[U])}for(let P in M)this._tiles[P].clearFadeHold();let O=i.bs(this._tiles,M);for(let P of O){let k=this._tiles[P];k.hasSymbolBuckets&&!k.holdingForFade()?k.setHoldDuration(this.map._fadeDuration):k.hasSymbolBuckets&&!k.symbolFadeFinished()||this._removeTile(+P)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(let t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){let o={};if(t.length===0)return o;let h={},m=t.reduce((C,M)=>Math.min(C,M.overscaledZ),1/0),_=t[0].overscaledZ,v=Math.max(_-Xr.maxOverzooming,this._source.minzoom),E=Math.max(_+Xr.maxUnderzooming,this._source.minzoom),T={};for(let C of t){let M=this._addTile(C);o[C.key]=C,M.hasData()||m<this._source.maxzoom&&(T[C.key]=C)}this._retainLoadedChildren(T,m,E,o);for(let C of t){let M=this._tiles[C.key];if(M.hasData())continue;if(C.canonical.z>=this._source.maxzoom){let P=C.children(this._source.maxzoom)[0],k=this.getTile(P);if(k&&k.hasData()){o[P.key]=P;continue}}else{let P=C.children(this._source.maxzoom);if(o[P[0].key]&&o[P[1].key]&&o[P[2].key]&&o[P[3].key])continue}let O=M.wasRequested();for(let P=C.overscaledZ-1;P>=v;--P){let k=C.scaledTo(P);if(h[k.key]||(h[k.key]=!0,M=this.getTile(k),!M&&O&&(M=this._addTile(k)),M&&(o[k.key]=k,O=M.wasRequested(),M.hasData())))break}}return o}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(let t in this._tiles){let o=[],h,m=this._tiles[t].tileID;for(;m.overscaledZ>0;){if(m.key in this._loadedParentTiles){h=this._loadedParentTiles[m.key];break}o.push(m.key);let _=m.scaledTo(m.overscaledZ-1);if(h=this._getLoadedTile(_),h)break;m=_}for(let _ of o)this._loadedParentTiles[_]=h}}_addTile(t){let o=this._tiles[t.key];if(o)return o.isExtraShadowCaster!==!0||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),o;o=this._cache.getAndRemove(t),o&&(this._setTileReloadTimer(t.key,o),o.tileID=t,this._state.initializeTileState(o,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,o)));let h=!!o;if(!h){let m=this.map?this.map.painter:null,_=this._source.tileSize*t.overscaleFactor();o=this._source.type==="raster-array"?new tc(t,_,this.transform.tileZoom,m,this._isRaster):new ol(t,_,this.transform.tileZoom,m,this._isRaster,this._source.worldview),this._loadTile(o,this._tileLoaded.bind(this,o,t.key,o.state))}return o.uses++,this._tiles[t.key]=o,h||this._source.fire(new i.A("dataloading",{tile:o,coord:o.tileID,dataType:"source"})),o}_setTileReloadTimer(t,o){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);let h=o.getExpiryTimeout();h&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},h))}_removeTile(t){let o=this._tiles[t];o&&(o.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),o.uses>0||(o.hasData()&&o.state!=="reloading"||o.state==="empty"?this._cache.add(o.tileID,o,o.getExpiryTimeout()):(o.aborted=!0,this._abortTile(o),this._unloadTile(o))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(let t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,o,h){let m=[],_=this.transform;if(!_)return m;let v=_.projection.name==="globe",E=i.aD(_.center.lng);for(let T in this._tiles){let C=this._tiles[T];if(h&&C.clearQueryDebugViz(),C.holdingForFade())continue;let M;if(v){let O=C.tileID.canonical;if(O.z===0){let P=[Math.abs(i.ay(E,...nc(O,-1))-E),Math.abs(i.ay(E,...nc(O,1))-E)];M=[0,2*P.indexOf(Math.min(...P))-1]}else{let P=[Math.abs(i.ay(E,...nc(O,-1))-E),Math.abs(i.ay(E,...nc(O,0))-E),Math.abs(i.ay(E,...nc(O,1))-E)];M=[P.indexOf(Math.min(...P))-1]}}else M=[0];for(let O of M){let P=t.containsTile(C,_,o,O);P&&m.push(P)}}return m}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,o){let h=this.getRenderableIds(t,o).map(_=>this._tiles[_].tileID),m=this.transform.projection.name==="globe";for(let _ of h)_.projMatrix=this.transform.calculateProjMatrix(_.toUnwrapped()),_.expandedProjMatrix=m?this.transform.calculateProjMatrix(_.toUnwrapped(),!1,!0):_.projMatrix;return h}sortCoordinatesByDistance(t){let o=t.slice(),h=this.transform._camera.position,m=this.transform._camera.forward(),_={};for(let v of o){let E=1/(1<<v.canonical.z);_[v.key]=((v.canonical.x+.5)*E+v.wrap-h[0])*m[0]+((v.canonical.y+.5)*E-h[1])*m[1]-h[2]*m[2]}return o.sort((v,E)=>_[v.key]-_[E.key]),o}hasTransition(){if(this._source.hasTransition())return!0;if(Su(this._source.type))for(let t in this._tiles){let o=this._tiles[t];if(o.fadeEndTime!==void 0&&o.fadeEndTime>=i.q.now())return!0}return!1}setFeatureState(t,o,h){this._state.updateState(t=t||"_geojsonTileLayer",o,h)}removeFeatureState(t,o,h){this._state.removeFeatureState(t=t||"_geojsonTileLayer",o,h)}getFeatureState(t,o){return this._state.getState(t=t||"_geojsonTileLayer",o)}setDependencies(t,o,h){let m=this._tiles[t];m&&m.setDependencies(o,h)}reloadTilesForDependencies(t,o){for(let h in this._tiles)this._tiles[h].hasDependency(t,o)&&this._reloadTile(+h,"reloading");this._cache.filter(h=>!h.hasDependency(t,o))}_preloadTiles(t,o){if(!this._sourceLoaded){let T=()=>{this._sourceLoaded&&(this._source.off("data",T),this._preloadTiles(t,o))};return void this._source.on("data",T)}let h=new Map,m=Array.isArray(t)?t:[t],_=this.map.painter.terrain,v=this.usedForTerrain&&_?_.getScaledDemTileSize():this._source.tileSize;for(let T of m){let C=T.coveringTiles({tileSize:v,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(let M of C)h.set(M.key,M);this.usedForTerrain&&T.updateElevation(!1)}let E=Array.from(h.values());i.bt(E,(T,C)=>{let M=new ol(T,this._source.tileSize*T.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(M,O=>{this._source.type==="raster-dem"&&M.dem&&this._backfillDEM(M),C(O,M)})},o)}}function sl(u,t){let o=Math.abs(2*u.wrap)-+(u.wrap<0),h=Math.abs(2*t.wrap)-+(t.wrap<0);return u.overscaledZ-t.overscaledZ||h-o||t.canonical.y-u.canonical.y||t.canonical.x-u.canonical.x}function Su(u){return u==="raster"||u==="image"||u==="video"||u==="custom"}function nc(u,t){let o=1<<u.z;return[u.x/o+t,(u.x+1)/o+t]}Xr.maxOverzooming=10,Xr.maxUnderzooming=3;class V_{constructor(t){this.style=t,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];let t=!1,o=!1;for(let h in this.style._mergedLayers){let m=this.style._mergedLayers[h];if(m.type==="fill-extrusion"||m.type==="building")this.layers.push({layer:m,visible:t,visibilityChanged:o});else if(m.type==="model"){let _=this.style.getLayerSource(m);_&&_.type==="batched-model"&&this.layers.push({layer:m,visible:t,visibilityChanged:o})}}}onNewFrame(t){this.layersGotHidden=!1;for(let o of this.layers){let h=o.layer,m=!1;h.type==="fill-extrusion"?m=!h.isHidden(t)&&h.paint.get("fill-extrusion-opacity")>0:h.type==="building"?m=!h.isHidden(t)&&h.paint.get("building-opacity")>0:h.type==="model"&&(m=!h.isHidden(t)&&h.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!m&&o.visible,o.visible=m}}updateZOffset(t,o){this.currentBuildingBuckets=[];for(let m of this.layers){let _=m.layer,v=this.style.getLayerSourceCache(_),E=1;_.type==="fill-extrusion"?E=m.visible?_.paint.get("fill-extrusion-vertical-scale"):0:_.type==="building"&&(E=m.visible?_.paint.get("building-vertical-scale"):0);let T=v?v.getTile(o):null;if(!T&&v&&o.canonical.z>v.getSource().minzoom){let C=o.scaledTo(Math.min(v.getSource().maxzoom,o.overscaledZ-1));for(;C.overscaledZ>=v.getSource().minzoom&&(T=v.getTile(C),!T&&C.overscaledZ!==0);)C=C.scaledTo(C.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:T?T.getBucket(_):null,tileID:T?T.tileID:o,verticalScale:E})}t.hasAnyZOffset=!1;let h=!1;for(let m=0;m<t.symbolInstances.length;m++){let _=t.symbolInstances.get(m),v=_.zOffset,E=this._getHeightAtTileOffset(o,_.tileAnchorX,_.tileAnchorY);_.zOffset=E!==Number.NEGATIVE_INFINITY?E:v,h||v===_.zOffset||(h=!0),t.hasAnyZOffset||_.zOffset===0||(t.hasAnyZOffset=!0)}h&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,o,h,m){let _=o,v=h;if(t.canonical.z!==m.canonical.z){let E=m.canonical,T=1/(1<<t.canonical.z-E.z);_=(o+t.canonical.x*i.aj)*T-E.x*i.aj|0,v=(h+t.canonical.y*i.aj)*T-E.y*i.aj|0}return{tileX:_,tileY:v}}_getHeightAtTileOffset(t,o,h){let m,_;for(let v=0;v<this.layers.length;++v){let E=this.layers[v].layer;if(E.type!=="fill-extrusion"&&E.type!=="building")continue;let{bucket:T,tileID:C,verticalScale:M}=this.currentBuildingBuckets[v];if(!T)continue;let{tileX:O,tileY:P}=this._mapCoordToOverlappingTile(t,o,h,C),k=T.getHeightAtTileCoord(O,P);k&&k.height!==void 0&&(k.hidden?m=k.height:_=Math.max(k.height*M,_||0))}if(_!==void 0)return _;for(let v=0;v<this.layers.length;++v){let E=this.layers[v];if(E.layer.type!=="model"||!E.visible)continue;let{bucket:T,tileID:C}=this.currentBuildingBuckets[v];if(!T)continue;let{tileX:M,tileY:O}=this._mapCoordToOverlappingTile(t,o,h,C),P=T.getHeightAtTileCoord(M,O);if(P&&!P.hidden)return P.height===void 0&&m!==void 0?Math.min(P.maxHeight,m)*P.verticalScale:P.height?P.height*P.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function j_(u,t){let o={};for(let h in u)h!=="ref"&&(o[h]=u[h]);return i.bu.forEach(h=>{h in t&&(o[h]=t[h])}),o}function Du(u){u=u.slice();let t=Object.create(null);for(let o=0;o<u.length;o++)t[u[o].id]=u[o];for(let o=0;o<u.length;o++)"ref"in u[o]&&(u[o]=j_(u[o],t[u[o].ref]));return u}let pn={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function cd(u,t,o){o.push({command:pn.addSource,args:[u,t[u]]})}function ic(u,t,o){t.push({command:pn.removeSource,args:[u]}),o[u]=!0}function Cu(u,t,o,h){ic(u,o,h),cd(u,t,o)}function Db(u,t,o){let h;for(h in u[o])if(u[o].hasOwnProperty(h)&&h!=="data"&&!i.bv(u[o][h],t[o][h]))return!1;for(h in t[o])if(t[o].hasOwnProperty(h)&&h!=="data"&&!i.bv(u[o][h],t[o][h]))return!1;return!0}function Mu(u,t,o,h,m,_){let v;for(v in t=t||{},u=u||{})u.hasOwnProperty(v)&&(i.bv(u[v],t[v])||o.push({command:_,args:[h,v,t[v],m]}));for(v in t)t.hasOwnProperty(v)&&!u.hasOwnProperty(v)&&(i.bv(u[v],t[v])||o.push({command:_,args:[h,v,t[v],m]}))}function al(u){return u.id}function _a(u,t){return u[t.id]=t,u}class Fp{constructor(t,o){this.reset(t,o)}reset(t,o){this.points=t||[],this._distances=[0];for(let h=1;h<this.points.length;h++)this._distances[h]=this._distances[h-1]+this.points[h].dist(this.points[h-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(o||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=i.ay(t,0,1);let o=1,h=this._distances[o],m=t*this.paddedLength+this.padding;for(;h<m&&o<this._distances.length;)h=this._distances[++o];let _=o-1,v=this._distances[_],E=h-v,T=E>0?(m-v)/E:0;return this.points[_].mult(1-T).add(this.points[o].mult(T))}}class Np{constructor(t,o,h){let m=this.boxCells=[],_=this.circleCells=[];this.xCellCount=Math.ceil(t/h),this.yCellCount=Math.ceil(o/h);for(let v=0;v<this.xCellCount*this.yCellCount;v++)m.push([]),_.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=o,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/o,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,o,h,m,_){this._forEachCell(o,h,m,_,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(o),this.bboxes.push(h),this.bboxes.push(m),this.bboxes.push(_)}insertCircle(t,o,h,m){this._forEachCell(o-m,h-m,o+m,h+m,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(o),this.circles.push(h),this.circles.push(m)}_insertBoxCell(t,o,h,m,_,v){this.boxCells[_].push(v)}_insertCircleCell(t,o,h,m,_,v){this.circleCells[_].push(v)}_query(t,o,h,m,_,v){if(h<0||t>this.width||m<0||o>this.height)return!_&&[];let E=[];if(t<=0&&o<=0&&this.width<=h&&this.height<=m){if(_)return!0;for(let T=0;T<this.boxKeys.length;T++)E.push({key:this.boxKeys[T],x1:this.bboxes[4*T],y1:this.bboxes[4*T+1],x2:this.bboxes[4*T+2],y2:this.bboxes[4*T+3]});for(let T=0;T<this.circleKeys.length;T++){let C=this.circles[3*T],M=this.circles[3*T+1],O=this.circles[3*T+2];E.push({key:this.circleKeys[T],x1:C-O,y1:M-O,x2:C+O,y2:M+O})}return v?E.filter(v):E}return this._forEachCell(t,o,h,m,this._queryCell,E,{hitTest:_,seenUids:{box:{},circle:{}}},v),_?E.length>0:E}_queryCircle(t,o,h,m,_){let v=t-h,E=t+h,T=o-h,C=o+h;if(E<0||v>this.width||C<0||T>this.height)return!m&&[];let M=[];return this._forEachCell(v,T,E,C,this._queryCellCircle,M,{hitTest:m,circle:{x:t,y:o,radius:h},seenUids:{box:{},circle:{}}},_),m?M.length>0:M}query(t,o,h,m,_){return this._query(t,o,h,m,!1,_)}hitTest(t,o,h,m,_){return this._query(t,o,h,m,!0,_)}hitTestCircle(t,o,h,m){return this._queryCircle(t,o,h,!0,m)}_queryCell(t,o,h,m,_,v,E,T){let C=E.seenUids,M=this.boxCells[_];if(M!==null){let P=this.bboxes;for(let k of M)if(!C.box[k]){C.box[k]=!0;let j=4*k;if(t<=P[j+2]&&o<=P[j+3]&&h>=P[j+0]&&m>=P[j+1]&&(!T||T(this.boxKeys[k]))){if(E.hitTest)return v.push(!0),!0;v.push({key:this.boxKeys[k],x1:P[j],y1:P[j+1],x2:P[j+2],y2:P[j+3]})}}}let O=this.circleCells[_];if(O!==null){let P=this.circles;for(let k of O)if(!C.circle[k]){C.circle[k]=!0;let j=3*k;if(this._circleAndRectCollide(P[j],P[j+1],P[j+2],t,o,h,m)&&(!T||T(this.circleKeys[k]))){if(E.hitTest)return v.push(!0),!0;{let B=P[j],U=P[j+1],q=P[j+2];v.push({key:this.circleKeys[k],x1:B-q,y1:U-q,x2:B+q,y2:U+q})}}}}}_queryCellCircle(t,o,h,m,_,v,E,T){let C=E.circle,M=E.seenUids,O=this.boxCells[_];if(O!==null){let k=this.bboxes;for(let j of O)if(!M.box[j]){M.box[j]=!0;let B=4*j;if(this._circleAndRectCollide(C.x,C.y,C.radius,k[B+0],k[B+1],k[B+2],k[B+3])&&(!T||T(this.boxKeys[j])))return v.push(!0),!0}}let P=this.circleCells[_];if(P!==null){let k=this.circles;for(let j of P)if(!M.circle[j]){M.circle[j]=!0;let B=3*j;if(this._circlesCollide(k[B],k[B+1],k[B+2],C.x,C.y,C.radius)&&(!T||T(this.circleKeys[j])))return v.push(!0),!0}}}_forEachCell(t,o,h,m,_,v,E,T){let C=this._convertToXCellCoord(t),M=this._convertToYCellCoord(o),O=this._convertToXCellCoord(h),P=this._convertToYCellCoord(m);for(let k=C;k<=O;k++)for(let j=M;j<=P;j++)if(_.call(this,t,o,h,m,this.xCellCount*j+k,v,E,T))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,o,h,m,_,v){let E=m-t,T=_-o,C=h+v;return C*C>E*E+T*T}_circleAndRectCollide(t,o,h,m,_,v,E){let T=(v-m)/2,C=Math.abs(t-(m+T));if(C>T+h)return!1;let M=(E-_)/2,O=Math.abs(o-(_+M));if(O>M+h)return!1;if(C<=T||O<=M)return!0;let P=C-T,k=O-M;return P*P+k*k<=h*h}}let ll={unknown:0,flipRequired:1,flipNotRequired:2},U_=Math.tan(85*Math.PI/180);function Fs(u,t,o,h,m,_,v){let E=i.bz();if(o)if(_.name==="globe"){let T=i.bA(m,t);i.az(E,E,T)}else{let T=i.bB([],v);E[0]=T[0],E[1]=T[1],E[4]=T[2],E[5]=T[3],h||i.by(E,E,m.angle)}else i.az(E,m.labelPlaneMatrix,u);return E}function ud(u,t,o,h,m,_,v){let E=Fs(u,t,o,h,m,_,v);return _.name==="globe"&&o||(E[2]=E[6]=E[10]=E[14]=0),E}function hd(u,t,o,h,m,_,v){if(o){if(_.name==="globe"){let E=Fs(u,t,o,h,m,_,v);return i.bi(E,E),i.az(E,u,E),E}{let E=i.bw(u),T=i.bx([]);return T[0]=v[0],T[1]=v[1],T[4]=v[2],T[5]=v[3],i.az(E,E,T),h||i.by(E,E,-m.angle),E}}return m.glCoordMatrix}function Yo(u,t,o,h){let m=[u,t,o,1];o?i.aA(m,m,h):In(m,m,h);let _=m[3];return m[0]/=_,m[1]/=_,m[2]/=_,m}function Au(u,t){return Math.min(.5+u/t*.5,1.5)}function cl(u,t){let o=u[0]/u[3],h=u[1]/u[3];return o>=-t[0]&&o<=t[0]&&h>=-t[1]&&h<=t[1]}function dd(u,t,o,h,m,_,v,E,T,C){let M=o.transform,O=h?u.textSizeData:u.iconSizeData,P=i.bH(O,o.transform.zoom),k=M.projection.name==="globe",j=[256/o.width*2+1,256/o.height*2+1],B=h?u.text.dynamicLayoutVertexArray:u.icon.dynamicLayoutVertexArray;B.clear();let U=null;k&&(U=h?u.text.globeExtVertexArray:u.icon.globeExtVertexArray);let q=u.lineVertexArray,Z=h?u.text.placedSymbolArray:u.icon.placedSymbolArray,ee=o.transform.width/o.transform.height,re,ue=!1;for(let le=0;le<Z.length;le++){let se=Z.get(le),{numGlyphs:oe,writingMode:he}=se;if(he!==i.bI.vertical||ue||re===i.bI.horizontal||(ue=!0),re=he,(se.hidden||he===i.bI.vertical)&&!ue){hl(oe,B);continue}ue=!1;let fe=new i.P(se.tileAnchorX,se.tileAnchorY),{x:Te,y:Ie,z:Be}=M.projection.projectTilePoint(fe.x,fe.y,C.canonical);if(T){let[mt,gt,dt]=T(fe);Te+=mt,Ie+=gt,Be+=dt}let Ve=[Te,Ie,Be,1];if(i.aA(Ve,Ve,t),!cl(Ve,j)){hl(oe,B);continue}let We=Ve[3],we=Au(o.transform.getCameraToCenterDistance(M.projection),We),Oe=i.bJ(O,P,se),_e=v?Oe/we:Oe*we,Ue=Yo(Te,Ie,Be,m);if(Ue[3]<=0){hl(oe,B);continue}let Me={},Ge=i.al(u.layers[0].layout.get("text-max-angle")),nt=Math.cos(Ge),je=v?null:T,et=ul(se,_e,!1,E,t,m,_,u.glyphOffsetArray,q,B,U,Ue,fe,Me,ee,je,M.projection,C,v,nt);ue=et.useVertical,je&&et.needsFlipping&&(Me={}),(et.notEnoughRoom||ue||et.needsFlipping&&ul(se,_e,!0,E,t,m,_,u.glyphOffsetArray,q,B,U,Ue,fe,Me,ee,je,M.projection,C,v,nt).notEnoughRoom)&&hl(oe,B)}h?(u.text.dynamicLayoutVertexBuffer.updateData(B),U&&u.text.globeExtVertexBuffer&&u.text.globeExtVertexBuffer.updateData(U)):(u.icon.dynamicLayoutVertexBuffer.updateData(B),U&&u.icon.globeExtVertexBuffer&&u.icon.globeExtVertexBuffer.updateData(U))}function zp(u,t,o,h,m,_,v,E,T,C,M,O,P,k,j,B,U){let{lineStartIndex:q,glyphStartIndex:Z,segment:ee}=E,re=Z+E.numGlyphs,ue=q+E.lineLength,le=t.getoffsetX(Z),se=t.getoffsetX(re-1),oe=rc(u*le,o,h,m,_,v,ee,q,ue,T,C,M,O,P,!0,k,j,B,U);if(!oe)return null;let he=rc(u*se,o,h,m,_,v,ee,q,ue,T,C,M,O,P,!0,k,j,B,U);return he?{first:oe,last:he}:null}function fd(u,t,o,h){return u===i.bI.horizontal&&Math.abs(h)>Math.abs(o)?{useVertical:!0}:u===i.bI.vertical?h>0?{needsFlipping:!0}:null:t!==ll.unknown&&function(m,_){return m===0||Math.abs(_/m)>U_}(o,h)?t===ll.flipRequired?{needsFlipping:!0}:null:o<0?{needsFlipping:!0}:null}function ul(u,t,o,h,m,_,v,E,T,C,M,O,P,k,j,B,U,q,Z,ee){let re=t/24,ue=u.lineOffsetX*re,le=u.lineOffsetY*re,{lineStartIndex:se,glyphStartIndex:oe,numGlyphs:he,segment:fe,writingMode:Te,flipState:Ie}=u,Be=se+u.lineLength,Ve=We=>{if(M){let[Ue,Me,Ge]=We.up,nt=C.length;i.bK(M,nt+0,Ue,Me,Ge),i.bK(M,nt+1,Ue,Me,Ge),i.bK(M,nt+2,Ue,Me,Ge),i.bK(M,nt+3,Ue,Me,Ge)}let[we,Oe,_e]=We.point;i.bL(C,we,Oe,_e,We.angle)};if(he>1){let We=zp(re,E,ue,le,o,O,P,u,T,_,k,B,!1,U,q,Z,ee);if(!We)return{notEnoughRoom:!0};if(h&&!o){let[we,Oe,_e]=We.first.point,[Ue,Me,Ge]=We.last.point;[we,Oe]=Yo(we,Oe,_e,v),[Ue,Me]=Yo(Ue,Me,Ge,v);let nt=fd(Te,Ie,(Ue-we)*j,Me-Oe);if(u.flipState=nt&&nt.needsFlipping?ll.flipRequired:ll.flipNotRequired,nt)return nt}Ve(We.first);for(let we=oe+1;we<oe+he-1;we++){let Oe=rc(re*E.getoffsetX(we),ue,le,o,O,P,fe,se,Be,T,_,k,B,!1,!1,U,q,Z,ee);if(!Oe)return C.length-=4*(we-oe),{notEnoughRoom:!0};Ve(Oe)}Ve(We.last)}else{if(h&&!o){let we=Yo(P.x,P.y,0,m),Oe=se+fe+1,_e=new i.P(T.getx(Oe),T.gety(Oe)),Ue=Yo(_e.x,_e.y,0,m),Me=Ue[3]>0?Ue:Bp(P,_e,we,1,m,void 0,U,q.canonical),Ge=fd(Te,Ie,(Me[0]-we[0])*j,Me[1]-we[1]);if(u.flipState=Ge&&Ge.needsFlipping?ll.flipRequired:ll.flipNotRequired,Ge)return Ge}let We=rc(re*E.getoffsetX(oe),ue,le,o,O,P,fe,se,Be,T,_,k,B,!1,!1,U,q,Z,ee);if(!We)return{notEnoughRoom:!0};Ve(We)}return{}}function so(u,t,o,h,m){let{x:_,y:v,z:E}=h.projectTilePoint(u.x,u.y,t);if(!m)return Yo(_,v,E,o);let[T,C,M]=m(u);return Yo(_+T,v+C,E+M,o)}function Bp(u,t,o,h,m,_,v,E){let T=so(u.sub(t)._unit()._add(u),E,m,v,_);return i.at(T,o,T),i.au(T,T),i.bE(T,o,T,h)}function rc(u,t,o,h,m,_,v,E,T,C,M,O,P,k,j,B,U,q,Z){let ee=h?u-t:u+t,re=ee>0?1:-1,ue=0;h&&(re*=-1,ue=Math.PI),re<0&&(ue+=Math.PI);let le=E+v+(re>0?0:1)|0,se=m,oe=m,he=0,fe=0,Te=Math.abs(ee),Ie=[],Be=[],Ve=_,We=Ve,we=i.bC([]),Oe=()=>Bp(We,Ve,oe,Te-he+1,M,P,B,U.canonical);for(;he+fe<=Te;){if(le+=re,le<E||le>=T)return null;if(oe=se,We=Ve,Ie.push(oe),k&&Be.push(We),Ve=new i.P(C.getx(le),C.gety(le)),se=O[le],!se){let dt=so(Ve,U.canonical,M,B,P);se=dt[3]>0?O[le]=dt:Oe()}he+=fe;let mt=i.at([],se,oe),gt=i.bD(oe,se);if(o&&gt>0&&fe>0&&i.bG(we,mt)/(fe*gt)<Z)return null;fe=gt,we=mt}j&&P&&(O[le]&&(se=Oe(),fe=i.bD(oe,se),we=i.at([],se,oe)),O[le]=se);let _e=(Te-he)/fe,Ue=Ve.sub(We)._mult(_e)._add(We),Me=i.bE([],oe,we,_e),Ge=[0,0,1],nt=we[0],je=we[1];if(q&&(Ge=B.upVector(U.canonical,Ue.x,Ue.y),Ge[0]!==0||Ge[1]!==0||Ge[2]!==1)){let mt=[Ge[2],0,-Ge[0]],gt=i.bF([],Ge,mt);i.au(mt,mt),i.au(gt,gt),nt=i.bG(we,mt),je=i.bG(we,gt)}if(o){let mt=i.bF([],Ge,we);i.au(mt,mt),i.bE(Me,Me,mt,o*re)}let et=ue+Math.atan2(je,nt);return Ie.push(Me),k&&Be.push(Ue),{point:Me,angle:et,path:Ie,tilePath:Be,up:Ge}}function hl(u,t){let o=t.length,h=o+4*u;t.resize(h),t.float32.fill(-1/0,4*o,4*h)}function In(u,t,o){let h=t[0],m=t[1];return u[0]=o[0]*h+o[4]*m+o[12],u[1]=o[1]*h+o[5]*m+o[13],u[3]=o[3]*h+o[7]*m+o[15],u}let Ko=100;class Cb{constructor(t,o,h=new Np(t.width+200,t.height+200,25),m=new Np(t.width+200,t.height+200,25)){this.transform=t,this.grid=h,this.ignoredGrid=m,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+Ko,this.screenBottomBoundary=t.height+Ko,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=o}placeCollisionBox(t,o,h,m,_,v,E,T){let C=h.projectedAnchorX,M=h.projectedAnchorY,O=h.projectedAnchorZ,P=h.elevation,k=h.tileID,j=t.getProjection();if(P&&k){let[le,se,oe]=j.upVector(k.canonical,h.tileAnchorX,h.tileAnchorY),he=j.upVectorScale(k.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;C+=le*P*he,M+=se*P*he,O+=oe*P*he}let B=this.projectAndGetPerspectiveRatio(E,C,M,O,h.tileID,j.name==="globe"||!!P||this.transform.pitch>0,j),U=v*B.perspectiveRatio,q=(h.x1*o+m.x-h.padding)*U+B.point.x,Z=(h.y1*o+m.y-h.padding)*U+B.point.y,ee=(h.x2*o+m.x+h.padding)*U+B.point.x,re=(h.y2*o+m.y+h.padding)*U+B.point.y,ue=B.perspectiveRatio<=.55||B.occluded;return!this.isInsideGrid(q,Z,ee,re)||!_&&this.grid.hitTest(q,Z,ee,re,T)||ue?{box:[],offscreen:!1,occluded:B.occluded}:{box:[q,Z,ee,re],offscreen:this.isOffscreen(q,Z,ee,re),occluded:!1}}placeCollisionCircles(t,o,h,m,_,v,E,T,C,M,O,P,k,j,B){let U=[],q=this.transform.elevation,Z=t.getProjection(),ee=q?q.getAtTileOffsetFunc(B,this.transform.center.lat,this.transform.worldSize,Z):null,re=new i.P(h.tileAnchorX,h.tileAnchorY),{x:ue,y:le,z:se}=Z.projectTilePoint(re.x,re.y,B.canonical);if(ee){let[Ge,nt,je]=ee(re);ue+=Ge,le+=nt,se+=je}let oe=Z.name==="globe",he=this.projectAndGetPerspectiveRatio(E,ue,le,se,B,oe||!!q||this.transform.pitch>0,Z),{perspectiveRatio:fe}=he,Te=(O?v/fe:v*fe)/i.bO,Ie=Yo(ue,le,se,T),Be=h.lineOffsetX*Te,Ve=h.lineOffsetY*Te,We=i.al(t.layers[0].layout.get("text-max-angle")),we=Math.cos(We),Oe=he.signedDistanceFromCamera>0?zp(Te,_,Be,Ve,!1,Ie,re,h,m,T,{},q&&!O?ee:null,O&&!!q,Z,B,O,we):null,_e=!1,Ue=!1,Me=!0;if(Oe&&!he.occluded){let Ge=.5*k*fe+j,nt=new i.P(-100,-100),je=new i.P(this.screenRightBoundary,this.screenBottomBoundary),et=new Fp,{first:mt,last:gt}=Oe,dt=mt.path.length,Et=[];for(let Nt=dt-1;Nt>=1;Nt--)Et.push(mt.path[Nt]);for(let Nt=1;Nt<gt.path.length;Nt++)Et.push(gt.path[Nt]);let St=2.5*Ge;C&&(Et=Et.map(([Nt,Zt,Dn],Kn)=>(ee&&!oe&&(Dn=ee(Kn<dt-1?mt.tilePath[dt-1-Kn]:gt.tilePath[Kn-dt+2])[2]),Yo(Nt,Zt,Dn,C))),Et.some(Nt=>Nt[3]<=0)&&(Et=[]));let Ct=[];if(Et.length>0){let Nt=1/0,Zt=-1/0,Dn=1/0,Kn=-1/0;for(let Rn of Et)Nt=Math.min(Nt,Rn[0]),Dn=Math.min(Dn,Rn[1]),Zt=Math.max(Zt,Rn[0]),Kn=Math.max(Kn,Rn[1]);Zt>=nt.x&&Nt<=je.x&&Kn>=nt.y&&Dn<=je.y&&(Ct=[Et.map(Rn=>new i.P(Rn[0],Rn[1]))],(Nt<nt.x||Zt>je.x||Dn<nt.y||Kn>je.y)&&(Ct=i.bM(Ct,nt.x,nt.y,je.x,je.y)))}for(let Nt of Ct){et.reset(Nt,.25*Ge);let Zt=0;Zt=et.length<=.5*Ge?1:Math.ceil(et.paddedLength/St)+1;for(let Dn=0;Dn<Zt;Dn++){let Kn=Dn/Math.max(Zt-1,1),Rn=et.lerp(Kn),kn=Rn.x+Ko,Pi=Rn.y+Ko;U.push(kn,Pi,Ge,0);let Ht=kn-Ge,Kt=Pi-Ge,on=kn+Ge,ni=Pi+Ge;if(Me=Me&&this.isOffscreen(Ht,Kt,on,ni),Ue=Ue||this.isInsideGrid(Ht,Kt,on,ni),!o&&this.grid.hitTestCircle(kn,Pi,Ge,P)&&(_e=!0,!M))return{circles:[],offscreen:!1,collisionDetected:_e,occluded:!1}}}}return{circles:!M&&_e||!Ue?[]:U,offscreen:Me,collisionDetected:_e,occluded:he.occluded}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};let o=[],h=1/0,m=1/0,_=-1/0,v=-1/0;for(let M of t){let O=new i.P(M.x+Ko,M.y+Ko);h=Math.min(h,O.x),m=Math.min(m,O.y),_=Math.max(_,O.x),v=Math.max(v,O.y),o.push(O)}let E=this.grid.query(h,m,_,v).concat(this.ignoredGrid.query(h,m,_,v)),T={},C={};for(let M of E){let O=M.key;if(T[O.bucketInstanceId]===void 0&&(T[O.bucketInstanceId]={}),T[O.bucketInstanceId][O.featureIndex])continue;let P=[new i.P(M.x1,M.y1),new i.P(M.x2,M.y1),new i.P(M.x2,M.y2),new i.P(M.x1,M.y2)];i.bN(o,P)&&(T[O.bucketInstanceId][O.featureIndex]=!0,C[O.bucketInstanceId]===void 0&&(C[O.bucketInstanceId]=[]),C[O.bucketInstanceId].push(O.featureIndex))}return C}insertCollisionBox(t,o,h,m,_){(o?this.ignoredGrid:this.grid).insert({bucketInstanceId:h,featureIndex:m,collisionGroupID:_},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,o,h,m,_){let v=o?this.ignoredGrid:this.grid,E={bucketInstanceId:h,featureIndex:m,collisionGroupID:_};for(let T=0;T<t.length;T+=4)v.insertCircle(E,t[T],t[T+1],t[T+2])}projectAndGetPerspectiveRatio(t,o,h,m,_,v,E){let T=[o,h,m,1],C=!1;m||this.transform.pitch>0?(i.aA(T,T,t),this.fogState&&_&&E.name!=="globe"&&(C=function(P,k,j,B,U,q){let Z=q.calculateFogTileMatrix(U),ee=[k,j,B];return i.ad(ee,ee,Z),rt(P,i.ae(ee),q.pitch,q._fov)}(this.fogState,o,h,m,_.toUnwrapped(),this.transform)>.9)):In(T,T,t);let M=T[3];return{point:new i.P((T[0]/M+1)/2*this.transform.width+Ko,(-T[1]/M+1)/2*this.transform.height+Ko),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(E)/M*.5,1.5),signedDistanceFromCamera:M,occluded:v&&T[2]>M||C}}isOffscreen(t,o,h,m){return h<Ko||t>=this.screenRightBoundary||m<Ko||o>this.screenBottomBoundary}isInsideGrid(t,o,h,m){return h>=0&&t<this.gridRightBoundary&&m>=0&&o<this.gridBottomBoundary}getViewportMatrix(){let t=i.bx([]);return i.bo(t,t,[-100,-100,0]),t}}function Vp(u,t,o){let h=t.createTileMatrix(u,u.worldSize,o.toUnwrapped());return i.az(new Float32Array(16),u.projMatrix,h)}function kt(u,t,o){if(t.projection.name===o.projection.name)return u.projMatrix;let h=o.clone();return h.setProjection(t.projection),Vp(h,t.getProjection(),u)}function pd(u,t,o){return t.name===o.projection.name?u.projMatrix:Vp(o,t,u)}class Ru{constructor(t,o,h,m){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?o:-o))):m&&h?1:0,this.placed=h}isHidden(){return this.opacity===0&&!this.placed}}class dl{constructor(t,o,h,m,_,v=!1){this.text=new Ru(t?t.text:null,o,h,_),this.icon=new Ru(t?t.icon:null,o,m,_),this.clipped=v}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class xo{constructor(t,o,h,m=!1){this.text=t,this.icon=o,this.skipFade=h,this.clipped=m}}class jp{constructor(){this.invProjMatrix=i.bz(),this.viewportMatrix=i.bz(),this.circles=[]}}class oc{constructor(t,o,h,m,_){this.bucketInstanceId=t,this.featureIndex=o,this.sourceLayerIndex=h,this.bucketIndex=m,this.tileID=_}}class Tt{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){let o=++this.maxGroupID;this.collisionGroups[t]={ID:o,predicate:h=>h.collisionGroupID===o}}return this.collisionGroups[t]}}function On(u,t,o,h,m){let{horizontalAlign:_,verticalAlign:v}=i.bT(u),E=-(_-.5)*t,T=-(v-.5)*o,C=i.bU(u,h);return new i.P(E+C[0]*m,T+C[1]*m)}function bn(u,t,o,h,m){let _=new i.P(u,t);return o&&_._rotate(h?m:-m),_}class ao{constructor(t,o,h,m,_,v){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new Cb(this.transform,_),this.buildingIndex=v,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=o,this.retainedQueryData={},this.collisionGroups=new Tt(h),this.collisionCircleArrays={},this.prevPlacement=m,m&&(m.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,o,h,m,_=1){let v=h.getBucket(o),E=h.latestFeatureIndex;if(!v||!E||o.fqid!==v.layerIds[0])return;let T=v.layers[0].layout,C=v.layers[0].paint,M=h.collisionBoxArray,O=Math.pow(2,this.transform.zoom-h.tileID.overscaledZ),P=h.tileSize/i.aj,k=h.tileID.toUnwrapped();this.transform.setProjection(v.projection);let j=(B=h.tileID,U=v.getProjection(),q=this.transform,U.name===this.projection?q.calculateProjMatrix(B.toUnwrapped()):Vp(q,U,B));var B,U,q;let Z=T.get("text-pitch-alignment")==="map",ee=T.get("text-rotation-alignment")==="map";o.compileFilter(o.options);let re=o.dynamicFilter(),ue=o.dynamicFilterNeedsFeature(),le=this.transform.calculatePixelsToTileUnitsMatrix(h),se=ud(j,h.tileID.canonical,Z,ee,this.transform,v.getProjection(),le),oe=null;if(Z){let Oe=hd(j,h.tileID.canonical,Z,ee,this.transform,v.getProjection(),le);oe=i.az([],this.transform.labelPlaneMatrix,Oe)}let he=null;re&&h.latestFeatureIndex&&(he={unwrappedTileID:k,dynamicFilter:re,dynamicFilterNeedsFeature:ue}),this.retainedQueryData[v.bucketInstanceId]=new oc(v.bucketInstanceId,E,v.sourceLayerIndex,v.index,h.tileID);let[fe,Te]=v.layers[0].layout.get("text-size-scale-range"),Ie=i.ay(_,fe,Te),[Be,Ve]=T.get("icon-size-scale-range"),We=i.ay(_,Be,Ve),we={bucket:v,layout:T,paint:C,posMatrix:j,textLabelPlaneMatrix:se,labelToScreenMatrix:oe,clippingData:he,scale:O,textPixelRatio:P,holdingForFade:h.holdingForFade(),collisionBoxArray:M,partiallyEvaluatedTextSize:i.bH(v.textSizeData,this.transform.zoom,Ie),partiallyEvaluatedIconSize:i.bH(v.iconSizeData,this.transform.zoom,We),collisionGroup:this.collisionGroups.get(v.sourceID),latestFeatureIndex:h.latestFeatureIndex};if(m)for(let Oe of v.sortKeyRanges){let{sortKey:_e,symbolInstanceStart:Ue,symbolInstanceEnd:Me}=Oe;t.push({sortKey:_e,symbolInstanceStart:Ue,symbolInstanceEnd:Me,parameters:we})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:v.symbolInstances.length,parameters:we})}attemptAnchorPlacement(t,o,h,m,_,v,E,T,C,M,O,P,k,j,B,U,q,Z){let{textOffset0:ee,textOffset1:re,crossTileID:ue}=P,le=[ee,re],se=On(t,h,m,le,_),oe=this.collisionIndex.placeCollisionBox(j,_,o,bn(se.x,se.y,v,E,this.transform.angle),O,T,C,M.predicate);if(U){let he=j.getSymbolInstanceIconSize(Z,this.transform.zoom,P.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(j,he,U,bn(se.x,se.y,v,E,this.transform.angle),O,T,C,M.predicate).box.length===0)return}if(oe.box.length>0){let he;return this.prevPlacement&&this.prevPlacement.variableOffsets[ue]&&this.prevPlacement.placements[ue]&&this.prevPlacement.placements[ue].text&&(he=this.prevPlacement.variableOffsets[ue].anchor),this.variableOffsets[ue]={textOffset:le,width:h,height:m,anchor:t,textScale:_,prevAnchor:he},this.markUsedJustification(j,t,P,B),j.allowVerticalPlacement&&(this.markUsedOrientation(j,B,P),this.placedOrientations[ue]=B),{shift:se,placedGlyphBoxes:oe}}}placeLayerBucketPart(t,o,h,m,_=1){let{bucket:v,layout:E,paint:T,posMatrix:C,textLabelPlaneMatrix:M,labelToScreenMatrix:O,clippingData:P,textPixelRatio:k,holdingForFade:j,collisionBoxArray:B,partiallyEvaluatedTextSize:U,partiallyEvaluatedIconSize:q,collisionGroup:Z,latestFeatureIndex:ee}=t.parameters,re=E.get("text-optional"),ue=E.get("icon-optional"),le=E.get("text-allow-overlap"),se=E.get("icon-allow-overlap"),oe=E.get("text-rotation-alignment")==="map",he=E.get("text-pitch-alignment")==="map",fe=T.get("symbol-z-offset"),Te=E.get("symbol-elevation-reference")==="sea",[Ie,Be]=E.get("text-size-scale-range"),[Ve,We]=E.get("icon-size-scale-range"),we=i.ay(_,Ie,Be),Oe=i.ay(_,Ve,We);this.transform.setProjection(v.projection);let _e=le&&(se||!v.hasIconData()||ue),Ue=se&&(le||!v.hasTextData()||re),Me=!fe.isConstant();!v.collisionArrays&&B&&v.deserializeCollisionBoxes(B),h&&m&&v.updateCollisionDebugBuffers(this.transform.zoom,B,we,Oe);let Ge=(je,et,mt)=>{let{crossTileID:gt,numVerticalGlyphVertices:dt}=je,Et=null;if(P&&P.dynamicFilterNeedsFeature||Me){let Wn=this.retainedQueryData[v.bucketInstanceId];Et=ee.loadFeature({featureIndex:je.featureIndex,bucketIndex:Wn.bucketIndex,sourceLayerIndex:Wn.sourceLayerIndex,layoutVertexArrayOffset:0})}if(P&&!(0,P.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},Et,this.retainedQueryData[v.bucketInstanceId].tileID.canonical,new i.P(je.tileAnchorX,je.tileAnchorY),this.transform.calculateDistanceTileData(P.unwrappedTileID)))return this.placements[gt]=new xo(!1,!1,!1,!0),void o.add(gt);let St=fe.evaluate(Et,{});if(o.has(gt))return;if(j)return void(this.placements[gt]=new xo(!1,!1,!1));let Ct=!1,Nt=!1,Zt=!0,Dn=!1,Kn=!1,Rn=null,kn={box:null,offscreen:null,occluded:null},Pi={box:null},Ht=null,Kt=null,on=null,ni=0,$i=0,Jn=0;mt.textFeatureIndex?ni=mt.textFeatureIndex:je.useRuntimeCollisionCircles&&(ni=je.featureIndex),mt.verticalTextFeatureIndex&&($i=mt.verticalTextFeatureIndex);let vn=Wn=>{Wn.tileID=this.retainedQueryData[v.bucketInstanceId].tileID;let ri=this.transform.elevation;Wn.elevation=Te?St:St+(ri?ri.getAtTileOffset(Wn.tileID,Wn.tileAnchorX,Wn.tileAnchorY):0),Wn.elevation+=je.zOffset},Ti=mt.textBox;if(Ti){vn(Ti);let Wn=wn=>{let Ci=i.bI.horizontal;if(v.allowVerticalPlacement&&!wn&&this.prevPlacement){let ur=this.prevPlacement.placedOrientations[gt];ur&&(this.placedOrientations[gt]=ur,Ci=ur,this.markUsedOrientation(v,Ci,je))}return Ci},ri=(wn,Ci)=>{if(v.allowVerticalPlacement&&dt>0&&mt.verticalTextBox){for(let ur of v.writingModes)if(ur===i.bI.vertical?(kn=Ci(),Pi=kn):kn=wn(),kn&&kn.box&&kn.box.length)break}else kn=wn()};if(E.get("text-variable-anchor")){let wn=E.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[gt]){let hi=this.prevPlacement.variableOffsets[gt];wn.indexOf(hi.anchor)>0&&(wn=wn.filter(_n=>_n!==hi.anchor),wn.unshift(hi.anchor))}let Ci=(hi,_n,co)=>{let Kr=v.getSymbolInstanceTextSize(U,je,this.transform.zoom,et),Eo=(hi.x2-hi.x1)*Kr+2*hi.padding,es=(hi.y2-hi.y1)*Kr+2*hi.padding,Bo=je.hasIconTextFit&&!se?_n:null;Bo&&vn(Bo);let Jr={box:[],offscreen:!1,occluded:!1},La=le?2*wn.length:wn.length;for(let ts=0;ts<La;++ts){let Oa=this.attemptAnchorPlacement(wn[ts%wn.length],hi,Eo,es,Kr,oe,he,k,C,Z,ts>=wn.length,je,et,v,co,Bo,U,q);if(Oa&&(Jr=Oa.placedGlyphBoxes,Jr&&Jr.box&&Jr.box.length)){Ct=!0,Rn=Oa.shift;break}}return Jr};ri(()=>Ci(Ti,mt.iconBox,i.bI.horizontal),()=>{let hi=mt.verticalTextBox;return hi&&vn(hi),v.allowVerticalPlacement&&!(kn&&kn.box&&kn.box.length)&&dt>0&&hi?Ci(hi,mt.verticalIconBox,i.bI.vertical):{box:null,offscreen:null,occluded:null}}),kn&&(Ct=kn.box,Zt=kn.offscreen,Dn=kn.occluded);let ur=Wn(!(!kn||!kn.box));if(!Ct&&this.prevPlacement){let hi=this.prevPlacement.variableOffsets[gt];hi&&(this.variableOffsets[gt]=hi,this.markUsedJustification(v,hi.anchor,je,ur))}}else{let wn=(Ci,ur)=>{let hi=v.getSymbolInstanceTextSize(U,je,this.transform.zoom,et,_),_n=this.collisionIndex.placeCollisionBox(v,hi,Ci,new i.P(0,0),le,k,C,Z.predicate);return _n&&_n.box&&_n.box.length&&(this.markUsedOrientation(v,ur,je),this.placedOrientations[gt]=ur),_n};ri(()=>wn(Ti,i.bI.horizontal),()=>{let Ci=mt.verticalTextBox;return v.allowVerticalPlacement&&dt>0&&Ci?(vn(Ci),wn(Ci,i.bI.vertical)):{box:null,offscreen:null,occluded:null}}),Wn(!!(kn&&kn.box&&kn.box.length))}}if(Ht=kn,Ct=Ht&&Ht.box&&Ht.box.length>0,Zt=Ht&&Ht.offscreen,Dn=Ht&&Ht.occluded,je.useRuntimeCollisionCircles){let Wn=v.text.placedSymbolArray.get(je.centerJustifiedTextSymbolIndex>=0?je.centerJustifiedTextSymbolIndex:je.verticalPlacedTextSymbolIndex),ri=i.bJ(v.textSizeData,U,Wn),wn=E.get("text-padding");Kt=this.collisionIndex.placeCollisionCircles(v,le,Wn,v.lineVertexArray,v.glyphOffsetArray,ri,C,M,O,h,he,Z.predicate,je.collisionCircleDiameter*ri/i.bO,wn,this.retainedQueryData[v.bucketInstanceId].tileID),Ct=le||Kt.circles.length>0&&!Kt.collisionDetected,Zt=Zt&&Kt.offscreen,Dn=Kt.occluded}if(mt.iconFeatureIndex&&(Jn=mt.iconFeatureIndex),mt.iconBox){let Wn=ri=>{vn(ri);let wn=je.hasIconTextFit&&Rn?bn(Rn.x,Rn.y,oe,he,this.transform.angle):new i.P(0,0),Ci=v.getSymbolInstanceIconSize(q,this.transform.zoom,je.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(v,Ci,ri,wn,se,k,C,Z.predicate)};Pi&&Pi.box&&Pi.box.length&&mt.verticalIconBox?(on=Wn(mt.verticalIconBox),Nt=on.box.length>0):(on=Wn(mt.iconBox),Nt=on.box.length>0),Zt=Zt&&on.offscreen,Kn=on.occluded}let dn=re||je.numHorizontalGlyphVertices===0&&dt===0,zi=ue||je.numIconVertices===0;if(dn||zi?zi?dn||(Nt=Nt&&Ct):Ct=Nt&&Ct:Nt=Ct=Nt&&Ct,Ct&&Ht&&Ht.box&&this.collisionIndex.insertCollisionBox(Ht.box,E.get("text-ignore-placement"),v.bucketInstanceId,Pi&&Pi.box&&$i?$i:ni,Z.ID),Nt&&on&&this.collisionIndex.insertCollisionBox(on.box,E.get("icon-ignore-placement"),v.bucketInstanceId,Jn,Z.ID),Kt&&(Ct&&this.collisionIndex.insertCollisionCircles(Kt.circles,E.get("text-ignore-placement"),v.bucketInstanceId,ni,Z.ID),h)){let Wn=v.bucketInstanceId,ri=this.collisionCircleArrays[Wn];ri===void 0&&(ri=this.collisionCircleArrays[Wn]=new jp);for(let wn=0;wn<Kt.circles.length;wn+=4)ri.circles.push(Kt.circles[wn+0]),ri.circles.push(Kt.circles[wn+1]),ri.circles.push(Kt.circles[wn+2]),ri.circles.push(Kt.collisionDetected?1:0)}let ii=v.projection.name!=="globe";_e=_e&&(ii||!Dn),Ue=Ue&&(ii||!Kn),this.placements[gt]=new xo(Ct||_e,Nt||Ue,Zt||v.justReloaded),o.add(gt)},nt=this.retainedQueryData[v.bucketInstanceId].tileID;if(v.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(v,nt),v.elevationType==="road"&&v.updateRoadElevation(nt.canonical),v.updateZOffset(),v.sortFeaturesByY){let je=v.getSortedSymbolIndexes(this.transform.angle);for(let et=je.length-1;et>=0;--et){let mt=je[et];Ge(v.symbolInstances.get(mt),mt,v.collisionArrays[mt])}v.hasAnyZOffset&&i.w(`${v.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(v.hasAnyZOffset){let je=v.getSortedIndexesByZOffset();for(let et=0;et<je.length;++et){let mt=je[et];Ge(v.symbolInstances.get(mt),mt,v.collisionArrays[mt])}}else for(let je=t.symbolInstanceStart;je<t.symbolInstanceEnd;je++)Ge(v.symbolInstances.get(je),je,v.collisionArrays[je]);if(h&&v.bucketInstanceId in this.collisionCircleArrays){let je=this.collisionCircleArrays[v.bucketInstanceId];i.bi(je.invProjMatrix,C),je.viewportMatrix=this.collisionIndex.getViewportMatrix()}v.justReloaded=!1}markUsedJustification(t,o,h,m){let{leftJustifiedTextSymbolIndex:_,centerJustifiedTextSymbolIndex:v,rightJustifiedTextSymbolIndex:E,verticalPlacedTextSymbolIndex:T,crossTileID:C}=h,M=i.bV(o),O=m===i.bI.vertical?T:M==="left"?_:M==="center"?v:M==="right"?E:-1;_>=0&&(t.text.placedSymbolArray.get(_).crossTileID=O>=0&&_!==O?0:C),v>=0&&(t.text.placedSymbolArray.get(v).crossTileID=O>=0&&v!==O?0:C),E>=0&&(t.text.placedSymbolArray.get(E).crossTileID=O>=0&&E!==O?0:C),T>=0&&(t.text.placedSymbolArray.get(T).crossTileID=O>=0&&T!==O?0:C)}markUsedOrientation(t,o,h){let m=o===i.bI.horizontal||o===i.bI.horizontalOnly?o:0,_=o===i.bI.vertical?o:0,{leftJustifiedTextSymbolIndex:v,centerJustifiedTextSymbolIndex:E,rightJustifiedTextSymbolIndex:T,verticalPlacedTextSymbolIndex:C}=h,M=t.text.placedSymbolArray;v>=0&&(M.get(v).placedOrientation=m),E>=0&&(M.get(E).placedOrientation=m),T>=0&&(M.get(T).placedOrientation=m),C>=0&&(M.get(C).placedOrientation=_)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;let o=this.prevPlacement,h=!1;this.prevZoomAdjustment=o?o.zoomAdjustment(this.transform.zoom):0;let m=o?o.symbolFadeChange(t):1,_=o?o.opacities:{},v=o?o.variableOffsets:{},E=o?o.placedOrientations:{};for(let T in this.placements){let C=this.placements[T],M=_[T];M?(this.opacities[T]=new dl(M,m,C.text,C.icon,null,C.clipped),h=h||C.text!==M.text.placed||C.icon!==M.icon.placed):(this.opacities[T]=new dl(null,m,C.text,C.icon,C.skipFade,C.clipped),h=h||C.text||C.icon)}for(let T in _){let C=_[T];if(!this.opacities[T]){let M=new dl(C,m,!1,!1);M.isHidden()||(this.opacities[T]=M,h=h||C.text.placed||C.icon.placed)}}for(let T in v)this.variableOffsets[T]||!this.opacities[T]||this.opacities[T].isHidden()||(this.variableOffsets[T]=v[T]);for(let T in E)this.placedOrientations[T]||!this.opacities[T]||this.opacities[T].isHidden()||(this.placedOrientations[T]=E[T]);h?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=o?o.lastPlacementChangeTime:t)}updateLayerOpacities(t,o,h,m){let _=new Set;for(let v of o){let E=v.getBucket(t);E&&v.latestFeatureIndex&&t.fqid===E.layerIds[0]&&(this.updateBucketOpacities(E,_,v,v.collisionBoxArray,h,m,v.tileID,t.scope),E.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(E,v.tileID),E.elevationType==="road"&&E.updateRoadElevation(v.tileID.canonical),E.updateZOffset())}}updateBucketOpacities(t,o,h,m,_,v,E,T){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();let C=t.layers[0].layout,M=t.layers[0].paint,O=!!t.layers[0].dynamicFilter(),P=new dl(null,0,!1,!1,!0),k=C.get("text-allow-overlap"),j=C.get("icon-allow-overlap"),B=C.get("text-variable-anchor"),U=C.get("text-rotation-alignment")==="map",q=C.get("text-pitch-alignment")==="map",Z=M.get("symbol-z-offset"),ee=C.get("symbol-elevation-reference")==="sea",re=!Z.isConstant(),ue=new dl(null,0,k&&(j||!t.hasIconData()||C.get("icon-optional")),j&&(k||!t.hasTextData()||C.get("text-optional")),!0);!t.collisionArrays&&m&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(m);let le=(oe,he,fe)=>{for(let Te=0;Te<he/4;Te++)oe.opacityVertexArray.emplaceBack(fe)},se=0;v&&t.updateReplacement(E,v);for(let oe=0;oe<t.symbolInstances.length;oe++){let he=t.symbolInstances.get(oe),{numHorizontalGlyphVertices:fe,numVerticalGlyphVertices:Te,crossTileID:Ie,numIconVertices:Be,tileAnchorX:Ve,tileAnchorY:We}=he,we=null,Oe=this.retainedQueryData[t.bucketInstanceId];re&&he&&Oe&&(we=h.latestFeatureIndex.loadFeature({featureIndex:he.featureIndex,bucketIndex:Oe.bucketIndex,sourceLayerIndex:Oe.sourceLayerIndex,layoutVertexArrayOffset:0}));let _e=Z.evaluate(we,{}),Ue=o.has(Ie),Me=this.opacities[Ie];Ue?Me=P:Me||(Me=ue,this.opacities[Ie]=Me),o.add(Ie);let Ge=fe>0||Te>0,nt=Be>0,je=this.placedOrientations[Ie],et=je===i.bI.vertical,mt=je===i.bI.horizontal||je===i.bI.horizontalOnly;!Ge&&!nt||Me.isHidden()||se++;let gt=!1;if((Ge||nt)&&v)for(let dt of t.activeReplacements){if(i.bP(dt,_,i.bQ.Symbol,T)||dt.min.x>Ve||Ve>dt.max.x||dt.min.y>We||We>dt.max.y)continue;let Et=i.bR(Ve,We,E.canonical,dt.footprintTileId.canonical);if(gt=i.bS(Et,dt.footprint),gt)break}if(Ge){let dt=gt?ya:sc(Me.text);le(t.text,fe,et?ya:dt),le(t.text,Te,mt?ya:dt);let Et=Me.text.isHidden(),{leftJustifiedTextSymbolIndex:St,centerJustifiedTextSymbolIndex:Ct,rightJustifiedTextSymbolIndex:Nt,verticalPlacedTextSymbolIndex:Zt}=he,Dn=t.text.placedSymbolArray,Kn=Et||et?1:0;St>=0&&(Dn.get(St).hidden=Kn),Ct>=0&&(Dn.get(Ct).hidden=Kn),Nt>=0&&(Dn.get(Nt).hidden=Kn),Zt>=0&&(Dn.get(Zt).hidden=Et||mt?1:0);let Rn=this.variableOffsets[Ie];Rn&&this.markUsedJustification(t,Rn.anchor,he,je);let kn=this.placedOrientations[Ie];kn&&(this.markUsedJustification(t,"left",he,kn),this.markUsedOrientation(t,kn,he))}if(nt){let dt=gt?ya:sc(Me.icon),{placedIconSymbolIndex:Et,verticalPlacedIconSymbolIndex:St}=he,Ct=t.icon.placedSymbolArray,Nt=Me.icon.isHidden()?1:0;Et>=0&&(le(t.icon,Be,et?ya:dt),Ct.get(Et).hidden=Nt),St>=0&&(le(t.icon,he.numVerticalIconVertices,mt?ya:dt),Ct.get(St).hidden=Nt)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){let dt=t.collisionArrays[oe];if(dt){let Et=new i.P(0,0),St=!0;if(dt.textBox||dt.verticalTextBox){if(B){let Nt=this.variableOffsets[Ie];Nt?(Et=On(Nt.anchor,Nt.width,Nt.height,Nt.textOffset,Nt.textScale),U&&Et._rotate(q?this.transform.angle:-this.transform.angle)):St=!1}O&&(St=!Me.clipped),dt.textBox&&Ns(t.textCollisionBox.collisionVertexArray,Me.text.placed,!St||et,_e,ee,Et.x,Et.y),dt.verticalTextBox&&Ns(t.textCollisionBox.collisionVertexArray,Me.text.placed,!St||mt,_e,ee,Et.x,Et.y)}let Ct=St&&!!(!mt&&dt.verticalIconBox);dt.iconBox&&Ns(t.iconCollisionBox.collisionVertexArray,Me.icon.placed,Ct,_e,ee,he.hasIconTextFit?Et.x:0,he.hasIconTextFit?Et.y:0),dt.verticalIconBox&&Ns(t.iconCollisionBox.collisionVertexArray,Me.icon.placed,!Ct,_e,ee,he.hasIconTextFit?Et.x:0,he.hasIconTextFit?Et.y:0)}}}if(t.fullyClipped=se===0,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){let oe=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=oe.invProjMatrix,t.placementViewportMatrix=oe.viewportMatrix,t.collisionCircleArray=oe.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,o){let h=this.zoomAtLastRecencyCheck===o?1-this.zoomAdjustment(o):1;return this.zoomAtLastRecencyCheck=o,this.commitTime+this.fadeDuration*h>t}setStale(){this.stale=!0}}function Ns(u,t,o,h,m,_,v){u.emplaceBack(t?1:0,o?1:0,_||0,v||0,h,m?1:0),u.emplaceBack(t?1:0,o?1:0,_||0,v||0,h,m?1:0),u.emplaceBack(t?1:0,o?1:0,_||0,v||0,h,m?1:0),u.emplaceBack(t?1:0,o?1:0,_||0,v||0,h,m?1:0)}let Sn=Math.pow(2,25),md=Math.pow(2,24),Pu=Math.pow(2,17),Lu=Math.pow(2,16),Fr=Math.pow(2,9),Wi=Math.pow(2,8),Mb=Math.pow(2,1);function sc(u){if(u.opacity===0&&!u.placed)return 0;if(u.opacity===1&&u.placed)return 4294967295;let t=u.placed?1:0,o=Math.floor(127*u.opacity);return o*Sn+t*md+o*Pu+t*Lu+o*Fr+t*Wi+o*Mb+t}let ya=0;class Ou{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&t.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,o,h,m,_,v){let E=this._bucketParts;for(;this._currentTileIndex<t.length;)if(o.getBucketParts(E,m,t[this._currentTileIndex],this._sortAcrossTiles,v),this._currentTileIndex++,_())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,E.sort((T,C)=>T.sortKey-C.sortKey));this._currentPartIndex<E.length;){let T=E[this._currentPartIndex];if(o.placeLayerBucketPart(T,this._seenCrossTileIDs,h,T.symbolInstanceStart===0,v),this._currentPartIndex++,_())return!0}return!1}}class gd{constructor(t,o,h,m,_,v,E,T,C){this.placement=new ao(t,_,v,E,T,C),this._currentPlacementIndex=o.length-1,this._forceFullPlacement=h,this._showCollisionBoxes=m,this._done=!1}isDone(){return this._done}continuePlacement(t,o,h,m,_){let v=i.q.now(),E=()=>{let T=i.q.now()-v;return!this._forceFullPlacement&&T>2};for(;this._currentPlacementIndex>=0;){let T=o[t[this._currentPlacementIndex]],C=this.placement.collisionIndex.transform.zoom;if(T.type==="symbol"&&(!T.minzoom||T.minzoom<=C)&&(!T.maxzoom||T.maxzoom>C)){let M=T,O=M.layout.get("symbol-z-elevate"),P=M.layout.get("symbol-sort-key").constantOr(1)!==void 0,k=M.layout.get("symbol-z-order"),j=k==="viewport-y"||k==="auto"&&!(k!=="viewport-y"&&P),B=M.layout.get("text-allow-overlap")||M.layout.get("icon-allow-overlap")||M.layout.get("text-ignore-placement")||M.layout.get("icon-ignore-placement"),U=j&&B,q=this._inProgressLayer=this._inProgressLayer||new Ou(M),Z=i.C(T.source,T.scope);if(q.continuePlacement(O||U?m[Z]:h[Z],this.placement,this._showCollisionBoxes,T,E,_))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}let ku=512/i.aj/2;class _d{constructor(t,o,h){this.tileID=t,this.bucketInstanceId=h,this.index=new i.bW(o.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];let m=t.canonical.x*i.aj,_=t.canonical.y*i.aj;for(let v=0;v<o.length;v++){let{key:E,crossTileID:T,tileAnchorX:C,tileAnchorY:M}=o.get(v),O=Math.floor((m+C)*ku),P=Math.floor((_+M)*ku);this.index.add(O,P),this.keys.push(E),this.crossTileIDs.push(T)}this.index.finish()}findMatches(t,o,h){let m=this.tileID.canonical.z<o.canonical.z?1:Math.pow(2,this.tileID.canonical.z-o.canonical.z),_=ku/Math.pow(2,o.canonical.z-this.tileID.canonical.z),v=o.canonical.x*i.aj,E=o.canonical.y*i.aj;for(let T=0;T<t.length;T++){let C=t.get(T);if(C.crossTileID)continue;let{key:M,tileAnchorX:O,tileAnchorY:P}=C,k=Math.floor((v+O)*_),j=Math.floor((E+P)*_),B=this.index.range(k-m,j-m,k+m,j+m).sort((U,q)=>U-q);for(let U of B){let q=this.crossTileIDs[U];if(this.keys[U]===M&&!h.has(q)){h.add(q),C.crossTileID=q;break}}}}}class Nr{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class zs{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){let o=Math.round((t-this.lng)/360);if(o!==0)for(let h in this.indexes){let m=this.indexes[h],_={};for(let v in m){let E=m[v];E.tileID=E.tileID.unwrapTo(E.tileID.wrap+o),_[E.tileID.key]=E}this.indexes[h]=_}this.lng=t}addBucket(t,o,h){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===o.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let _=0;_<o.symbolInstances.length;_++)o.symbolInstances.get(_).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);let m=this.usedCrossTileIDs[t.overscaledZ];for(let _ in this.indexes){let v=this.indexes[_];if(Number(_)>t.overscaledZ)for(let E in v){let T=v[E];T.tileID.isChildOf(t)&&T.findMatches(o.symbolInstances,t,m)}else{let E=v[t.scaledTo(Number(_)).key];E&&E.findMatches(o.symbolInstances,t,m)}}for(let _=0;_<o.symbolInstances.length;_++){let v=o.symbolInstances.get(_);v.crossTileID||(v.crossTileID=h.generate(),m.add(v.crossTileID))}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new _d(t,o.symbolInstances,o.bucketInstanceId),!0}removeBucketCrossTileIDs(t,o){for(let h of o.crossTileIDs)this.usedCrossTileIDs[t].delete(h)}removeStaleBuckets(t){let o=!1;for(let h in this.indexes){let m=this.indexes[h];for(let _ in m)t[m[_].bucketInstanceId]||(this.removeBucketCrossTileIDs(h,m[_]),delete m[_],o=!0)}return o}}class Yr{constructor(){this.layerIndexes={},this.crossTileIDs=new Nr,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,o,h,m){let _=this.layerIndexes[t.fqid];_===void 0&&(_=this.layerIndexes[t.fqid]=new zs);let v=!1,E={};m.name!=="globe"&&_.handleWrapJump(h);for(let T of o){let C=T.getBucket(t);C&&t.fqid===C.layerIds[0]&&(C.bucketInstanceId||(C.bucketInstanceId=++this.maxBucketInstanceId),_.addBucket(T.tileID,C,this.crossTileIDs)&&(v=!0),E[C.bucketInstanceId]=!0)}return _.removeStaleBuckets(E)&&(v=!0),v}pruneUnusedLayers(t){let o={};t.forEach(h=>{o[h]=!0});for(let h in this.layerIndexes)o[h]||delete this.layerIndexes[h]}}let fl=771;class en{constructor(t,o,h,m){this.blendFunction=t,this.blendColor=o.toNonPremultipliedRenderColor(null),this.mask=h,this.blendEquation=m}}en.Replace=[1,0,1,0],en.disabled=new en(en.Replace,i.am.transparent,[!1,!1,!1,!1]),en.unblended=new en(en.Replace,i.am.transparent,[!0,!0,!0,!0]),en.alphaBlended=new en([1,fl,1,fl],i.am.transparent,[!0,!0,!0,!0]),en.alphaBlendedNonPremultiplied=new en([770,fl,770,fl],i.am.transparent,[!0,!0,!0,!0]),en.multiply=new en([774,0,774,0],i.am.transparent,[!0,!0,!0,!0]);class ft{constructor(t,o,h){this.func=t,this.mask=o,this.range=h}}ft.ReadOnly=!1,ft.ReadWrite=!0,ft.disabled=new ft(519,ft.ReadOnly,[0,1]);let ko=7680;class Bt{constructor(t,o,h,m,_,v){this.test=t,this.ref=o,this.mask=h,this.fail=m,this.depthFail=_,this.pass=v}}Bt.disabled=new Bt({func:519,mask:0},0,0,ko,ko,ko);let Hi=1029,Fu=2305;class Pt{constructor(t,o,h){this.enable=t,this.mode=o,this.frontFace=h}}function ac(u,t){let o=i.c1(u,3);i.c3(u,t),i.c7(u,3,o)}function lc(u,t){let o=i.b_([]);return i.b$(o,o,-t),i.c0(o,o,-u),o}function va(u,t){let o=[u[0],u[1],0],h=[t[0],t[1],0];if(i.ae(o)>=1e-15){let v=i.au([],o);i.bY(h,v,i.bG(h,v)),t[0]=h[0],t[1]=h[1]}let m=i.bF([],t,u);if(i.bZ(m)<1e-15)return null;let _=Math.atan2(-m[1],m[0]);return lc(Math.atan2(Math.sqrt(u[0]*u[0]+u[1]*u[1]),-u[2]),_)}Pt.disabled=new Pt(!1,Hi,Fu),Pt.backCCW=new Pt(!0,Hi,Fu),Pt.backCW=new Pt(!0,Hi,2304),Pt.frontCW=new Pt(!0,1028,2304),Pt.frontCCW=new Pt(!0,1028,Fu);class H_{constructor(t,o){this.position=t,this.orientation=o}get position(){return this._position}set position(t){if(t){let o=t instanceof i.ac?t:new i.ac(t[0],t[1],t[2]);this._renderWorldCopies&&(o.x=i.bX(o.x,0,1)),this._position=o}else this._position=null}lookAtPoint(t,o){if(this.orientation=null,!this.position)return;let h=this.position,m=this._elevation?this._elevation.getAtPointOrZero(i.ac.fromLngLat(t)):0,_=i.ac.fromLngLat(t,m),v=[_.x-h.x,_.y-h.y,_.z-h.z];o||(o=[0,0,1]),o[2]=Math.abs(o[2]),this.orientation=va(v,o)}setPitchBearing(t,o){this.orientation=lc(i.al(t),i.al(-o))}}class Fo{constructor(t,o){this._transform=i.bx([]),this.orientation=o,this.position=t}get mercatorPosition(){let t=this.position;return new i.ac(t[0],t[1],t[2])}get position(){let t=i.c1(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var o;t&&i.c7(this._transform,3,[(o=t)[0],o[1],o[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||i.b_([]),t&&ac(this._transform,this._orientation)}getPitchBearing(){let t=this.forward(),o=this.right();return{bearing:Math.atan2(-o[1],o[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,o){this._orientation=lc(t,o),ac(this._transform,this._orientation)}forward(){let t=i.c1(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){let t=i.c1(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){let t=i.c1(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,o){let h=new Float64Array(16);return i.bi(h,this.getWorldToCamera(t,o)),h}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,o,h){let m=this.position;i.bY(m,m,-t);let _=new Float64Array(16);return i.bn(_,[h,h,h]),i.bo(_,_,m),_[10]*=o,_}getWorldToCamera(t,o){let h=new Float64Array(16),m=new Float64Array(4),_=this.position;return i.c2(m,this._orientation),i.bY(_,_,-t),i.c3(h,m),i.bo(h,h,_),h[1]*=-1,h[5]*=-1,h[9]*=-1,h[13]*=-1,h[8]*=o,h[9]*=o,h[10]*=o,h[11]*=o,h}getCameraToClipPerspective(t,o,h,m){let _=new Float64Array(16);return i.c4(_,t,o,h,m),_}getCameraToClipOrthographic(t,o,h,m,_,v){let E=new Float64Array(16);return i.c5(E,t,o,h,m,_,v),E}getDistanceToElevation(t,o=!1){let h=t===0?0:i.c6(t,o?i.aY(this.position[1]):this.position[1]),m=this.forward();return(h-this.position[2])/m[2]}clone(){return new Fo([...this.position],[...this.orientation])}}let zr={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class Nu{constructor(t=0,o=0,h=0,m=0){if(isNaN(t)||t<0||isNaN(o)||o<0||isNaN(h)||h<0||isNaN(m)||m<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=o,this.left=h,this.right=m}interpolate(t,o,h){return o.top!=null&&t.top!=null&&(this.top=i.ai(t.top,o.top,h)),o.bottom!=null&&t.bottom!=null&&(this.bottom=i.ai(t.bottom,o.bottom,h)),o.left!=null&&t.left!=null&&(this.left=i.ai(t.left,o.left,h)),o.right!=null&&t.right!=null&&(this.right=i.ai(t.right,o.right,h)),this}getCenter(t,o){let h=i.ay((this.left+t-this.right)/2,0,t),m=i.ay((this.top+o-this.bottom)/2,0,o);return new i.P(h,m)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new Nu(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}let or=15;class Up{constructor(t,o,h,m,_,v,E){this.tileSize=512,this._renderWorldCopies=_===void 0||_,this._minZoom=t||0,this._maxZoom=o||22,this._minPitch=h??0,this._maxPitch=m??60,this.setProjection(v),this.setMaxBounds(E),this.width=0,this.height=0,this._center=new i.cd(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Nu,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Fo,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){let t=new Up(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t._allowWorldUnderZoom=this._allowWorldUnderZoom,t}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<or}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(t,o=!1){let h=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||h)&&this._updateCameraOnTerrain(),(t||h)&&this._constrainCamera(o),this._calcMatrices()}getProjection(){return i.aF(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};let o=this.projection?this.getProjection():void 0;this.projection=i.ce(this.projectionOptions);let h=this.getProjection(),m=!i.bv(o,h);return m&&this._calcMatrices(),this.mercatorFromTransition=!1,m}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){let t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=i.ce({name:"mercator"});let o=t!==this.projection.name;return o&&this._calcMatrices(),o}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){let t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){let t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return i.c6(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new i.P(this.width,this.height)}get bearing(){return i.bX(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){let o=-t*Math.PI/180;this.angle!==o&&(this._unmodified=!1,this.angle=o,this._calcMatrices(),this.rotationMatrix=i.cf(),i.cg(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){let o=i.ay(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==o&&(this._unmodified=!1,this._pitch=o,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=i.al(t),this._calcMatrices())}get fovX(){return this._fov}get fovY(){let t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){let o=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==o&&(this._unmodified=!1,this._setZoom(o),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(t){this._tileCoverLift!==t&&(this._tileCoverLift=t)}_updateCameraOnTerrain(){let t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,o=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!o||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);let h=this._elevation;o||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&h.exaggeration()&&this._centerAltitudeValidForExaggeration!==h.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*h.exaggeration(),this._centerAltitudeValidForExaggeration=h.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=h.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(this._centerAltitudeValidForExaggeration===void 0)return;let t=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(t)}sampleAverageElevation(){if(!this._elevation)return 0;let t=this._elevation,o=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],h=this.horizonLineFromTop(),m=0,_=0;for(let v=0;v<o.length;v++){let E=new i.P(o[v][0]*this.width,h+o[v][1]*(this.height-h)),T=t.pointCoordinate(E);if(!T)continue;let C=1/Math.hypot(T[0]-this._camera.position[0],T[1]-this._camera.position[1]);m+=T[3]*C,_+=C}return _===0?NaN:m/_}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;let t=this._seaLevelZoom,o=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),h=this.pixelsPerMeter/this.worldSize*o,m=this._mercatorZfromZoom(t),_=this._mercatorZfromZoom(this._maxZoom),v=Math.max(m-h,_);this._setZoom(this._zoomFromMercatorZ(v))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){let o=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude())),h;h=t.z<this._camera.position[2]?[o.x,o.y,o.z]:[t.x,t.y,t.z];let m=i.ae(i.at([],this._camera.position,h));return i.ay(this._zoomFromMercatorZ(m),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let o=!1;if(t.orientation&&!i.ch(t.orientation,this._camera.orientation)&&(o=this._setCameraOrientation(t.orientation)),t.position){let h=[t.position.x,t.position.y,t.position.z];i.ci(h,this._camera.position)||(this._setCameraPosition(h),o=!0)}o&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();let t=this._camera.position,o=new H_;return o.position=new i.ac(t[0],t[1],t[2]),o.orientation=this._camera.orientation,o._elevation=this.elevation,o._renderWorldCopies=this.renderWorldCopies,o}_setCameraOrientation(t){if(!i.cj(t))return!1;i.ck(t,t);let o=i.cl([],[0,0,-1],t),h=i.cl([],[0,-1,0],t);if(h[2]<0)return!1;let m=va(o,h);return!!m&&(this._camera.orientation=m,!0)}_setCameraPosition(t){let o=this.zoomScale(this.minZoom)*this.tileSize,h=this.zoomScale(this.maxZoom)*this.tileSize,m=this.cameraToCenterDistance;t[2]=i.ay(t[2],m/h,m/o),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,o,h){this._unmodified=!1,this._edgeInsets.interpolate(t,o,h),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){let o=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,o)}getVisibleUnwrappedCoordinates(t){let o=[new i.cm(0,t)];if(this.renderWorldCopies){let h=this.pointCoordinate(new i.P(0,0)),m=this.pointCoordinate(new i.P(this.width,0)),_=this.pointCoordinate(new i.P(this.width,this.height)),v=this.pointCoordinate(new i.P(0,this.height)),E=Math.floor(Math.min(h.x,m.x,_.x,v.x)),T=Math.floor(Math.max(h.x,m.x,_.x,v.x)),C=1;for(let M=E-C;M<=T+C;M++)M!==0&&o.push(new i.cm(M,t))}return o}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,o,h){let m=[],_=h!=null,v=!_;if(v&&this.zoom<o||_&&h[0]===0&&h[1]===0)return m;let E=new Set,T=(M,O,P,k,j)=>{let B=i.cK(O,M,P,k,j);E.has(B)||(m.push(new i.aM(M,O,P,k,j)),E.add(B))};for(let M=0;M<t.length;M++){let O=t[M];if(v&&O.canonical.z!==o)continue;let P=O.canonical,k=O.overscaledZ,j=O.wrap,B=1<<P.z,U=P.x+1<B,q=P.x>0,Z=P.y+1<B,ee=P.y>0,re=O.wrap-(q?0:1),ue=O.wrap+(U?0:1),le=q?P.x-1:B-1,se=U?P.x+1:0;if(_)h[0]<0?(T(k,ue,P.z,se,P.y),h[1]<0&&Z&&(T(k,j,P.z,P.x,P.y+1),T(k,ue,P.z,se,P.y+1)),h[1]>0&&ee&&(T(k,j,P.z,P.x,P.y-1),T(k,ue,P.z,se,P.y-1))):h[0]>0?(T(k,re,P.z,le,P.y),h[1]<0&&Z&&(T(k,j,P.z,P.x,P.y+1),T(k,re,P.z,le,P.y+1)),h[1]>0&&ee&&(T(k,j,P.z,P.x,P.y-1),T(k,re,P.z,le,P.y-1))):h[1]<0&&Z?T(k,j,P.z,P.x,P.y+1):ee&&T(k,j,P.z,P.x,P.y-1);else{let oe=O.visibleQuadrants;1&oe&&(T(k,re,P.z,le,P.y),ee&&(T(k,j,P.z,P.x,P.y-1),T(k,re,P.z,le,P.y-1))),2&oe&&(T(k,ue,P.z,se,P.y),ee&&(T(k,j,P.z,P.x,P.y-1),T(k,ue,P.z,se,P.y-1))),4&oe&&(T(k,re,P.z,le,P.y),Z&&(T(k,j,P.z,P.x,P.y+1),T(k,re,P.z,le,P.y+1))),8&oe&&(T(k,ue,P.z,se,P.y),Z&&(T(k,j,P.z,P.x,P.y+1),T(k,ue,P.z,se,P.y+1)))}}let C=[];for(let M of m)m.some(O=>M.isChildOf(O))||C.push(M);if(m=C.filter(M=>!t.some(O=>!!(M.overscaledZ<o&&O.isChildOf(M))||M.equals(O)||M.isChildOf(O))),v){let M=1<<o,O=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),P=[M*O.x,M*O.y],k=4,j=k*k;m=m.filter(B=>{let U=B.canonical.x+.5-P[0],q=B.canonical.y+.5-P[1];return U*U+q*q<j})}return m}coveringTiles(t){let o=this.coveringZoomLevel(t),h=o,m=this.elevation&&this.elevation.exaggeration(),_=m&&!t.isTerrainDEM,v=this.projection.name==="mercator";if(t.minzoom!==void 0&&o<t.minzoom)return[];t.maxzoom!==void 0&&o>t.maxzoom&&(o=t.maxzoom);let E=this.locationCoordinate(this.center),T=this.center.lat,C=1<<o,M=[C*E.x,C*E.y,0],O=this.projection.name==="globe",P=!O,k=i.cn.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,o,P),j=O?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),B=C*i.c6(1,this.center.lat),U=this._camera.position[2]/i.c6(1,this.center.lat),q=[C*j.x,C*j.y,U*(P?1:B)],Z=O||m,ee=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),re=this.isLODDisabled(!0)?o:0,ue;if(this._elevation&&t.isTerrainDEM)ue=1e4*this._elevation.exaggeration();else if(this._elevation){let _e=this._elevation.getMinMaxForVisibleTiles();ue=_e?_e.max:this._centerAltitude}else ue=this._centerAltitude;let le=t.isTerrainDEM?-ue:this._elevation?this._elevation.getMinElevationBelowMSL():0,se=this.projection.isReprojectedInTileSpace?i.co(this):1,oe=_e=>{let Me=new i.ac(_e.x+25e-6,_e.y,_e.z),Ge=new i.ac(_e.x,_e.y+25e-6,_e.z),nt=_e.toLngLat(),je=Me.toLngLat(),et=Ge.toLngLat(),mt=this.locationCoordinate(nt),gt=this.locationCoordinate(je),dt=this.locationCoordinate(et),Et=Math.hypot(gt.x-mt.x,gt.y-mt.y),St=Math.hypot(dt.x-mt.x,dt.y-mt.y);return Math.sqrt(Et*St)*se/25e-6},he=_e=>{let Ue=ue,Me=le;return{aabb:i.cr(this,C,0,0,0,_e,Me,Ue,this.projection),zoom:0,x:0,y:0,minZ:Me,maxZ:Ue,wrap:_e,fullyVisible:!1}},fe=[],Te=[],Ie=o,Be=t.reparseOverscaled?h:o,Ve=(U-this._centerAltitude)*B,We=_e=>{if(!this._elevation||!_e.tileID||!v)return;let Ue=this._elevation.getMinMaxForTile(_e.tileID),Me=_e.aabb;Ue?(Me.min[2]=Ue.min,Me.max[2]=Ue.max,Me.center[2]=(Me.min[2]+Me.max[2])/2):(_e.shouldSplit=Oe(_e),_e.shouldSplit||(Me.min[2]=Me.max[2]=Me.center[2]=this._centerAltitude))},we=(_e,Ue)=>{if(.707*Ue<_e)return 1;let Me=Ue/_e;return Me/(1.4144271570014144+(Math.pow(1.1,Me-1.4144271570014144+1)-1)/(1.1-1)-1)},Oe=_e=>{if(_e.zoom<re)return!0;if(_e.zoom===Ie)return!1;if(_e.shouldSplit!=null)return _e.shouldSplit;let Ue=_e.aabb.distanceX(q),Me=_e.aabb.distanceY(q),Ge=Ve,nt=1;if(O){Ge=_e.aabb.distanceZ(q);let St=Math.pow(2,_e.zoom),Ct=i.aY((_e.y+1)/St),Nt=i.aY(_e.y/St),Zt=Math.min(Math.max(T,Ct),Nt),Dn=i.cO(Zt)/i.cO(T);if(nt=Zt===T?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Dn/this._mercatorScaleRatio),this.zoom<=i.cL&&_e.zoom===Ie-1&&Dn>=.9)return!0}else if(_&&(Ge=_e.aabb.distanceZ(q)*B),this.projection.isReprojectedInTileSpace&&h<=5){let St=Math.pow(2,_e.zoom),Ct=oe(new i.ac((_e.x+.5)/St,(_e.y+.5)/St));nt=Ct>.85?1:Ct}if(!v){let St=Math.sqrt(Ue*Ue+Me*Me+Ge*Ge),Ct=(1<<Ie-_e.zoom)*ee*nt;return Ct*=we(Math.max(Ge,Ve),St),St<Ct}let je=Number.MAX_VALUE,et=0,mt=_e.aabb.getCorners(),gt=[];for(let St of mt){i.at(gt,St,q),O||(_?gt[2]*=B:gt[2]=Ve);let Ct=i.bG(gt,this._camera.forward());Ct<je&&(je=Ct,et=Math.abs(gt[2]))}let dt=(1<<Ie-_e.zoom)*ee*nt;if(dt*=we(Math.max(et,Ve),je),je<dt)return!0;let Et=_e.aabb.closestPoint(M);return Et[0]===M[0]&&Et[1]===M[1]};if(this.renderWorldCopies)for(let _e=1;_e<=3;_e++)fe.push(he(-_e)),fe.push(he(_e));for(fe.push(he(0));fe.length>0;){let _e=fe.pop(),Ue=_e.x,Me=_e.y,Ge=_e.fullyVisible,nt=()=>this.projection.name==="globe"&&(_e.y===0||_e.y===(1<<_e.zoom)-1);if(!Ge){let je=Z?_e.aabb.intersects(k):_e.aabb.intersectsFlat(k);if(je===0&&nt()){let et=new i.cp(_e.zoom,Ue,Me);je=i.cq(this,C,et,!0).intersects(k)}if(je===0)continue;Ge=je===2}if(_e.zoom!==Ie&&Oe(_e))for(let je=0;je<4;je++){let et=(Ue<<1)+je%2,mt=(Me<<1)+(je>>1),gt={aabb:v?_e.aabb.quadrant(je):i.cr(this,C,_e.zoom+1,et,mt,_e.wrap,_e.minZ,_e.maxZ,this.projection),zoom:_e.zoom+1,x:et,y:mt,wrap:_e.wrap,fullyVisible:Ge,tileID:void 0,shouldSplit:void 0,minZ:_e.minZ,maxZ:_e.maxZ};_&&!O&&(gt.tileID=new i.aM(_e.zoom+1===Ie?Be:_e.zoom+1,_e.wrap,_e.zoom+1,et,mt),We(gt)),fe.push(gt)}else{let je=_e.zoom===Ie?Be:_e.zoom;if(t.minzoom&&t.minzoom>je)continue;let et=0;if(!Ge){let Et=Z?_e.aabb.intersectsPrecise(k):_e.aabb.intersectsPreciseFlat(k);if(Et===0&&nt()){let St=new i.cp(_e.zoom,Ue,Me);Et=i.cq(this,C,St,!0).intersectsPrecise(k)}if(Et===0)continue;if(t.calculateQuadrantVisibility)if(k.containsPoint(_e.aabb.center))et=15;else for(let St=0;St<4;St++)_e.aabb.quadrant(St).intersects(k)!==0&&(et|=1<<St)}let mt=M[0]-(.5+Ue+(_e.wrap<<_e.zoom))*(1<<o-_e.zoom),gt=M[1]-.5-Me,dt=_e.tileID?_e.tileID:new i.aM(je,_e.wrap,_e.zoom,Ue,Me);t.calculateQuadrantVisibility&&(dt.visibleQuadrants=et),Te.push({tileID:dt,distanceSq:mt*mt+gt*gt})}}if(this.fogCullDistSq){let _e=this.fogCullDistSq,Ue=this.horizonLineFromTop();Te=Te.filter(Me=>{let Ge=[0,0,0,1],nt=[i.aj,i.aj,0,1],je=this.calculateFogTileMatrix(Me.tileID.toUnwrapped());i.aA(Ge,Ge,je),i.aA(nt,nt,je);let et=i.cs([],Ge,nt),mt=i.ct([],Ge,nt),gt=i.cM(et,mt);if(gt===0)return!0;let dt=!1,Et=this._elevation;if(Et&&gt>_e&&Ue!==0){let St=this.calculateProjMatrix(Me.tileID.toUnwrapped()),Ct;t.isTerrainDEM||(Ct=Et.getMinMaxForTile(Me.tileID)),Ct||(Ct={min:le,max:ue});let Nt=i.cu(this.rotation),Zt=[Nt[0]*i.aj,Nt[1]*i.aj,Ct.max];i.ad(Zt,Zt,St),dt=(1-Zt[1])*this.height*.5<Ue}return gt<_e||dt})}return Te.sort((_e,Ue)=>_e.distanceSq-Ue.distanceSq).map(_e=>_e.tileID)}resize(t,o){this.width=t,this.height=o,this.pixelsToGLUnits=[2/t,-2/o],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){let o=i.ay(t.lat,-85.051129,i.cv),h=this.projection.project(t.lng,o);return new i.P(h.x*this.worldSize,h.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/i.c6(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,o){let h,m,_=this.centerPoint;if(this.projection.name==="globe"){let E=this.worldSize;h=(o.x-_.x)/E,m=(o.y-_.y)/E}else{let E=this.pointCoordinate(o),T=this.pointCoordinate(_);h=E.x-T.x,m=E.y-T.y}let v=this.locationCoordinate(t);this.setLocation(new i.ac(v.x-h,v.y-m))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t,o){return this.projection.locationPoint(this,t,o)}locationPoint3D(t,o){return this.projection.locationPoint(this,t,o,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t,o){return this.coordinateLocation(this.pointCoordinate3D(t,o))}locationCoordinate(t,o){let h=o?i.c6(o,t.lat):void 0,m=this.projection.project(t.lng,t.lat);return new i.ac(m.x,m.y,h)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,o){let h=o??this._centerAltitude,m=[t.x,t.y,0,1],_=[t.x,t.y,1,1];i.aA(m,m,this.pixelMatrixInverse),i.aA(_,_,this.pixelMatrixInverse);let v=_[3];i.cw(m,m,1/m[3]),i.cw(_,_,1/v);let E=m[2],T=_[2];return{p0:m,p1:_,t:E===T?0:(h-E)/(T-E)}}screenPointToMercatorRay(t){let o=[t.x,t.y,0,1],h=[t.x,t.y,1,1];return i.aA(o,o,this.pixelMatrixInverse),i.aA(h,h,this.pixelMatrixInverse),i.cw(o,o,1/o[3]),i.cw(h,h,1/h[3]),o[2]=i.c6(o[2],this._center.lat)*this.worldSize,h[2]=i.c6(h[2],this._center.lat)*this.worldSize,i.cw(o,o,1/this.worldSize),i.cw(h,h,1/this.worldSize),new i.av([o[0],o[1],o[2]],i.au([],i.at([],h,o)))}rayIntersectionCoordinate(t){let{p0:o,p1:h,t:m}=t,_=i.c6(o[2],this._center.lat),v=i.c6(h[2],this._center.lat);return new i.ac(i.ai(o[0],h[0],m)/this.worldSize,i.ai(o[1],h[1],m)/this.worldSize,i.ai(_,v,m))}pointCoordinate(t,o=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,o)}pointCoordinate3D(t,o){if(!this.elevation)return this.pointCoordinate(t,o);let h=this.projection.pointCoordinate3D(this,t.x,t.y);if(h)return new i.ac(h[0],h[1],h[2]);let m=0,_=this.horizonLineFromTop();if(t.y>_)return this.pointCoordinate(t,o);let v=.02*_,E=t.clone();for(let T=0;T<10&&_-m>v;T++){E.y=i.ai(m,_,.66);let C=this.projection.pointCoordinate3D(this,E.x,E.y);C?(_=E.y,h=C):m=E.y}return h?new i.ac(h[0],h[1],h[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=i.cx)return!this.isPointAboveHorizon(t);let o=this.pointCoordinate(t);return o.y>=0&&o.y<=1}_coordinatePoint(t,o){let h=o&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,m=[t.x*this.worldSize,t.y*this.worldSize,h+t.toAltitude(),1];return i.aA(m,m,this.pixelMatrix),m[3]>0?new i.P(m[0]/m[3],m[1]/m[3]):new i.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){let{top:t,left:o}=this._edgeInsets,h=this.height-this._edgeInsets.bottom,m=this.width-this._edgeInsets.right,_=this.pointLocation3D(new i.P(o,t)),v=this.pointLocation3D(new i.P(m,t)),E=this.pointLocation3D(new i.P(m,h)),T=this.pointLocation3D(new i.P(o,h)),C=Math.min(_.lng,v.lng,E.lng,T.lng),M=Math.max(_.lng,v.lng,E.lng,T.lng),O=Math.min(_.lat,v.lat,E.lat,T.lat),P=Math.max(_.lat,v.lat,E.lat,T.lat),k=Math.pow(2,-this.zoom)/16*270,j=this.projection.name==="globe"?1:4,B=(U,q,Z,ee,re)=>{let ue=(U+Z)/2,le=(q+ee)/2,se=new i.P(ue,le),{lng:oe,lat:he}=this.pointLocation3D(se),fe=Math.max(0,C-oe,O-he,oe-M,he-P);C=Math.min(C,oe),M=Math.max(M,oe),O=Math.min(O,he),P=Math.max(P,he),(re<j||fe>k)&&(B(U,q,ue,le,re+1),B(ue,le,Z,ee,re+1))};if(B(o,t,m,t,1),B(m,t,m,h,1),B(m,h,o,h,1),B(o,h,o,t,1),this.projection.name==="globe"){let[U,q]=i.cy(this);U?(P=90,M=180,C=-180):q&&(O=-90,M=180,C=-180)}return new i.aG(new i.cd(C,O),new i.cd(M,P))}_getBoundsRectangular(t,o){let{top:h,left:m}=this._edgeInsets,_=this.height-this._edgeInsets.bottom,v=this.width-this._edgeInsets.right,E=new i.P(m,h),T=new i.P(v,h),C=new i.P(v,_),M=new i.P(m,_),O=this.pointCoordinate(E,t),P=this.pointCoordinate(T,t),k=this.pointCoordinate(C,o),j=this.pointCoordinate(M,o),B=(U,q)=>(q.y-U.y)/(q.x-U.x);return O.y>1&&P.y>=0?O=new i.ac((1-j.y)/B(j,O)+j.x,1):O.y<0&&P.y<=1&&(O=new i.ac(-j.y/B(j,O)+j.x,0)),P.y>1&&O.y>=0?P=new i.ac((1-k.y)/B(k,P)+k.x,1):P.y<0&&O.y<=1&&(P=new i.ac(-k.y/B(k,P)+k.x,0)),new i.aG().extend(this.coordinateLocation(O)).extend(this.coordinateLocation(P)).extend(this.coordinateLocation(j)).extend(this.coordinateLocation(k))}_getBoundsRectangularTerrain(){let t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);let o=t.visibleDemTiles.reduce((h,m)=>{if(m.dem){let _=m.dem.tree;h.min=Math.min(h.min,_.minimums[0]),h.max=Math.max(h.max,_.maximums[0])}return h},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(o.min*t.exaggeration(),o.max*t.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){let o=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,h=this.height/2-o*(1-this._horizonShift);return t?Math.max(0,h):h}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-85.051129,this.maxLat=i.cv,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=i.aD(this.minLng)*this.tileSize,this.worldMaxX=i.aD(this.maxLng)*this.tileSize,this.worldMinY=i.aH(this.maxLat)*this.tileSize,this.worldMaxY=i.aH(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,o){return this.projection.createTileMatrix(this,o,t)}calculateDistanceTileData(t){let o=t.key,h=this._distanceTileDataCache;if(h[o])return h[o];let m=t.canonical,_=1/this.height,v=this.cameraWorldSize,E=v/this.zoomScale(m.z),T=(m.x+Math.pow(2,m.z)*t.wrap)*E,C=m.y*E,M=this.point;M.x*=v/this.worldSize,M.y*=v/this.worldSize;let O=this.angle,P=Math.sin(-O),k=-Math.cos(-O);return h[o]={bearing:[P,k],center:[(M.x-T)*_,(M.y-C)*_],scale:E/i.aj*_},h[o]}calculateFogTileMatrix(t){let o=t.key,h=this._fogTileMatrixCache;if(h[o])return h[o];let m=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return i.az(m,this.worldToFogMatrix,m),h[o]=new Float32Array(m),h[o]}calculateProjMatrix(t,o=!1,h=!1){let m=t.key,_;if(_=h?this._expandedProjMatrixCache:o?this._alignedProjMatrixCache:this._projMatrixCache,_[m])return _[m];let v=this.calculatePosMatrix(t,this.worldSize),E;return E=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:h?this.expandedFarZProjMatrix:o?this.alignedProjMatrix:this.projMatrix,i.az(v,E,v),_[m]=new Float32Array(v),_[m]}calculatePixelsToTileUnitsMatrix(t){let o=t.tileID.key,h=this._pixelsToTileUnitsCache;if(h[o])return h[o];let m=i.cz(t,this);return h[o]=m,h[o]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){let t=1/this.worldSize,o=i.bn([],[t,t,t]);return i.az(o,o,this.globeMatrix),o}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;let t=this._elevation;this._updateCameraState();let o=i.c6(1,this._center.lat)*this.worldSize,h=this._computeCameraPosition(o),m=this._camera.forward(),_=i.c6(1,this._center.lat);h[2]/=_,m[2]/=_,i.au(m,m);let v=t.raycast(h,m,t.exaggeration());if(v){let E=i.bE([],h,m,v),T=new i.ac(E[0],E[1],i.c6(E[2],i.aY(E[1]))),C=(T.z+i.ae([T.x-h[0],T.y-h[1],T.z-h[2]*_]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(C),this._centerAltitude=T.toAltitude(),this._center=this.coordinateLocation(T),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;let o=this._elevation,h=i.c6(1,this._center.lat)*this.worldSize,m=this._computeCameraPosition(h),_=o.getAtPointOrZero(new i.ac(...m)),v=this.pixelsPerMeter/this.worldSize*_,E=this._minimumHeightOverTerrain(),T=m[2]-v;if(T<=E)if(T<0||t){let C=this.locationCoordinate(this._center,this._centerAltitude),M=[m[0],m[1],C.z-m[2]],O=i.ae(M);M[2]-=(E-T)/this._pixelsPerMercatorPixel;let P=i.ae(M);if(P===0)return;i.bY(M,M,O/P*this._pixelsPerMercatorPixel),this._camera.position=[m[0],m[1],C.z*this._pixelsPerMercatorPixel-M[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;let t=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){let P=this.center;return P.lat=i.ay(P.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(P.lng=i.ay(P.lng,this.minLng,this.maxLng)),this.center=P,void(this._constraining=!1)}let o=this._unmodified,{x:h,y:m}=this.point,_=0,v=h,E=m,T=this.width/2,C=this.height/2,M=this.worldMinY*this.scale,O=this.worldMaxY*this.scale;if(m-C<M&&(E=M+C),m+C>O&&(E=O-C),O-M<this.height&&(_=Math.max(_,this.height/(O-M)),E=(O+M)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){let P=this.worldMinX*this.scale,k=this.worldMaxX*this.scale,j=this.worldSize/2-(P+k)/2;v=(h+j+this.worldSize)%this.worldSize-j,v-T<P&&(v=P+T),v+T>k&&(v=k-T),k-P<this.width&&(_=Math.max(_,this.width/(k-P)),v=(k+P)/2)}v===h&&E===m||this._allowWorldUnderZoom||(this.center=this.unproject(new i.P(v,E))),_&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(_)),this._constrainCamera(),this._unmodified=o,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;let t=this.centerOffset,o=this.projection.name==="globe",h=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=i.c6(1,this.center.lat)/i.c6(1,i.cP));let m=i.cA(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,m),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;let _=this.projection.zAxisUnit==="meters"?h:1,v=this._camera.getWorldToCamera(this.worldSize,_),E,T=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(T[8]=2*-t.x/this.width,T[9]=2*t.y/this.height,this.isOrthographic){let he=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),fe=he*this.aspect,Te=-fe,Ie=-he;fe-=t.x,Te-=t.x,he+=t.y,Ie+=t.y,E=this._camera.getCameraToClipOrthographic(Te,fe,Ie,he,this._nearZ,this._farZ),((Be,Ve,We,we)=>{for(let Oe=0;Oe<16;Oe++)Be[Oe]=i.ai(Ve[Oe],We[Oe],we)})(E,E,T,i.cN(this.pitch>=or?1:this.pitch/or))}else E=T;let C=i.cB([],T,v),M=i.cB([],E,v);if(this.projection.isReprojectedInTileSpace){let he=this.locationCoordinate(this.center),fe=i.bx([]);i.bo(fe,fe,[he.x*this.worldSize,he.y*this.worldSize,0]),i.az(fe,fe,i.cC(this)),i.bo(fe,fe,[-he.x*this.worldSize,-he.y*this.worldSize,0]),i.az(M,M,fe),i.az(C,C,fe),this.inverseAdjustmentMatrix=i.cD(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=i.cE([],M,[this.worldSize,this.worldSize,this.worldSize/_,1]),this.projMatrix=M,this.invProjMatrix=i.bi(new Float64Array(16),this.projMatrix),o){let he=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);he[8]=2*-t.x/this.width,he[9]=2*t.y/this.height,this.expandedFarZProjMatrix=i.cB([],he,v)}else this.expandedFarZProjMatrix=this.projMatrix;let O=i.bi([],E);this.frustumCorners=i.cF.fromInvProjectionMatrix(O,this.horizonLineFromTop(),this.height),this.cameraFrustum=i.cn.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!o);let P=new Float32Array(16);i.bx(P),i.cE(P,P,[1,-1,1]),i.cG(P,P,this._pitch),i.by(P,P,this.angle);let k=i.c4(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=i.bw(k);let j=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;k[8]=2*-t.x/this.width,k[9]=2*(t.y+j)/this.height,this.skyboxMatrix=i.az(P,k,P);let B=this.point,U=B.x,q=B.y,Z=this.width%2/2,ee=this.height%2/2,re=Math.cos(this.angle),ue=Math.sin(this.angle),le=U-Math.round(U)+re*Z+ue*ee,se=q-Math.round(q)+re*ee+ue*Z,oe=new Float64Array(M);if(i.bo(oe,oe,[le>.5?le-1:le,se>.5?se-1:se,0]),this.alignedProjMatrix=oe,M=i.bz(),i.cE(M,M,[this.width/2,-this.height/2,1]),i.bo(M,M,[1,-1,0]),this.labelPlaneMatrix=M,M=i.bz(),i.cE(M,M,[1,-1,1]),i.bo(M,M,[-1,-1,0]),i.cE(M,M,[2/this.width,2/this.height,1]),this.glCoordMatrix=M,this.pixelMatrix=i.az(new Float64Array(16),this.labelPlaneMatrix,C),this._calcFogMatrices(),this._distanceTileDataCache={},M=i.bi(new Float64Array(16),this.pixelMatrix),!M)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=M,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=i.cH(this);let he=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=i.ad(he,he,v),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=M;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};let t=this.cameraWorldSizeForFog,o=this.cameraPixelsPerMeter,h=this._camera.position,m=1/this.height/this._pixelsPerMercatorPixel,_=[t,t,o];i.bY(_,_,m),i.bY(h,h,-1),i.cI(h,h,_);let v=i.bz();i.bo(v,v,h),i.cE(v,v,_),this.mercatorFogMatrix=v,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,o,m)}_computeCameraPosition(t){let o=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,h=this._camera.forward(),m=this.point,_=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*o-t/this.worldSize*this._centerAltitude;return[m.x/this.worldSize-h[0]*_,m.y/this.worldSize-h[1]*_,t/this.worldSize*this._centerAltitude-h[2]*_]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){let o=this._maxCameraBoundsDistance()*Math.cos(this._pitch),h=this._camera.position[2],m=t[2],_=1;this.projection.wrap&&(this.center=this.center.wrap()),m>0&&(_=Math.min((o-h)/m,1)),this._camera.position=i.bE([],this._camera.position,t,_),this._updateStateFromCamera()}_updateStateFromCamera(){let t=this._camera.position,o=this._camera.forward(),{pitch:h,bearing:m}=this._camera.getPitchBearing(),_=i.c6(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,v=this._mercatorZfromZoom(this._maxZoom)*Math.cos(i.al(this._maxPitch)),E=Math.max((t[2]-_)/Math.cos(h),v),T=this._zoomFromMercatorZ(E);i.bE(t,t,o,E),this._pitch=i.ay(h,i.al(this.minPitch),i.al(this.maxPitch)),this.angle=i.bX(m,-Math.PI,Math.PI),this._setZoom(i.ay(T,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new i.ac(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){let t=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,t)*this.tileSize))}zoomFromMercatorZAdjusted(t){let o=0,h=i.cx,m=0,_=1/0;for(;h-o>1e-6&&h>o;){let v=o+.5*(h-o),E=this.tileSize*Math.pow(2,v),T=this.getCameraToCenterDistance(this.projection,v,E),C=this.scaleZoom(T/(Math.max(0,t)*this.tileSize)),M=Math.abs(v-C);M<_&&(_=M,m=v),v<C?o=v:h=v}return m}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(i.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,o){let h=Math.min(t.x,o.x),m=Math.max(t.x,o.x),_=Math.min(t.y,o.y),v=Math.max(t.y,o.y);if(_<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;let E=[new i.P(h,_),new i.P(m,v),new i.P(h,v),new i.P(m,_)],T=this.renderWorldCopies?-3:0,C=this.renderWorldCopies?4:1;for(let M of E){let O=this.pointRayIntersection(M);if(O.t<0)return!0;let P=this.rayIntersectionCoordinate(O);if(P.x<T||P.y<0||P.x>C||P.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+i.cJ(this.fovAboveCenter)>88||this.anyCornerOffEdge(new i.P(0,0),new i.P(this.width,this.height))}zoomDeltaToMovement(t,o){let h=i.ae(i.at([],this._camera.position,t)),m=this._zoomFromMercatorZ(h)+o;return h-this._mercatorZfromZoom(m)}getCameraPoint(){if(this.projection.name==="globe"){let t=function([o,h,m],_){let v=[o,h,m,1];i.aA(v,v,_);let E=v[3]=Math.max(v[3],1e-6);return v[0]/=E,v[1]/=E,v[2]/=E,v}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new i.P(t[0],t[1])}{let t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new i.P(0,t))}}getCameraToCenterDistance(t,o=this.zoom,h=this.worldSize){let m=i.cA(t,o,this.width,this.height,1024),_=t.pixelSpaceConversion(this.center.lat,h,m),v=.5/Math.tan(.5*this._fov)*this.height*_;return this.isOrthographic&&(v=i.ai(1,v,i.cN(this.pitch>=or?1:this.pitch/or))),v}getWorldToCameraMatrix(){let t=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&i.az(t,t,this.globeMatrix),t}getFrustum(t){return i.cn.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,this.projection.zAxisUnit==="meters")}}let ps=(u,t)=>{if(t>0&&u.terrain&&i.w("Cutoff is currently disabled on terrain"),t<=0||u.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};let o=u.transform,h=Math.max(Math.abs(o._zoom-(u.minCutoffZoom-1)),1),m=o.isLODDisabled(!1)?i.af(60,45,o.pitch):i.af(30,15,o.pitch),_=o._farZ-o._nearZ,v=t*o.height,E=((1-(T=m))*o.cameraToCenterDistance+T*(o._farZ+v))*h;var T;return{shouldRenderCutoff:m<1,uniformValues:{u_cutoff_params:[o._nearZ,o._farZ,(E-o._nearZ)/_,(E-v-o._nearZ)/_]}}},Er={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class zu{constructor(t,o){this.aabb=t,this.lastCascade=o}}class Ab{add(t,o){let h=this.receivers[t.key];h!==void 0?(h.aabb.min[0]=Math.min(h.aabb.min[0],o.min[0]),h.aabb.min[1]=Math.min(h.aabb.min[1],o.min[1]),h.aabb.min[2]=Math.min(h.aabb.min[2],o.min[2]),h.aabb.max[0]=Math.max(h.aabb.max[0],o.max[0]),h.aabb.max[1]=Math.max(h.aabb.max[1],o.max[1]),h.aabb.max[2]=Math.max(h.aabb.max[2],o.max[2])):this.receivers[t.key]=new zu(o,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,o,h){let m=i.cW.fromPoints(t.points),_=0;for(let v in this.receivers){let E=this.receivers[v];if(!E||!m.intersectsAabb(E.aabb))continue;E.aabb.min=m.closestPoint(E.aabb.min),E.aabb.max=m.closestPoint(E.aabb.max);let T=E.aabb.getCorners();for(let C=0;C<h.length;C++){let M=!0;for(let O of T){let P=[O[0]*o,O[1]*o,O[2]];if(i.ad(P,P,h[C].matrix),P[0]<-1||P[0]>1||P[1]<-1||P[1]>1){M=!1;break}}if(E.lastCascade=C,_=Math.max(_,C),M)break}}return _+1}}class Rb{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new Ab,this._depthMode=new ft(t.context.gl.LEQUAL,ft.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,t.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),t.tp.registerParameter(Er,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),t.tp.registerParameter(Er,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),t.tp.registerParameter(Er,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),t.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(let t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,o){let h=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!o||!o.properties)return;let m=o.properties.get("shadow-intensity");if(!o.shadowsEnabled()||m<=0||(this._shadowLayerCount=h.style.order.reduce((j,B)=>{let U=h.style._mergedLayers[B];return j+(U.hasShadowPass()&&!U.isHidden(t.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;let _=h.context,v=Er.shadowMapResolution,E=Er.shadowMapResolution;if(this._cascades.length===0||Er.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let j=0;j<Er.cascadeCount;++j){let B=h._shadowMapDebug,U=_.gl,q=_.createFramebuffer(v,E,B,"texture"),Z=new i.T(_,{width:v,height:E,data:null},U.DEPTH_COMPONENT16);if(q.depthAttachment.set(Z.texture),B){let ee=new i.T(_,{width:v,height:E,data:null},U.RGBA8);q.colorAttachment.set(ee.texture)}this._cascades.push({framebuffer:q,texture:Z,matrix:[],far:0,boundingSphereRadius:0,frustum:new i.cn,scale:0})}}this.shadowDirection=cc(o);let T=0;if(t.elevation){let j=t.elevation,B=[1e4,-1e4];j.visibleDemTiles.filter(U=>U.dem).forEach(U=>{let q=U.dem.tree;B[0]=Math.min(B[0],q.minimums[0]),B[1]=Math.max(B[1],q.maximums[0])}),B[0]!==1e4&&(T=(B[1]-B[0])*j.exaggeration())}let C=1.5*t.cameraToCenterDistance,M=3*C,O=new Float64Array(16);for(let j=0;j<this._cascades.length;++j){let B=this._cascades[j],U=t.height/50,q=1;Er.cascadeCount===1?q=M:j===0?q=C:(U=C,q=M);let[Z,ee]=uc(t,this.shadowDirection,U,q,Er.shadowMapResolution,T);B.scale=t.scale,B.matrix=Z,B.boundingSphereRadius=ee,i.bi(O,B.matrix),B.frustum=i.cn.fromInvProjectionMatrix(O,1,0,!0),B.far=q}let P=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[P].far,this._cascades[P].far],this._uniformValues.u_shadow_intensity=m,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/Er.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=Er.shadowMapResolution,this._uniformValues.u_shadowmap_0=zr.ShadowMap0,this._uniformValues.u_shadowmap_1=zr.ShadowMap0+1,this._groundShadowTiles=h.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});let k=h.transform.elevation;for(let j of this._groundShadowTiles){let B={min:0,max:0};if(k){let U=k.getMinMaxForTile(j);U&&(B=U)}this.addShadowReceiver(j.toUnwrapped(),B.min,B.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(t){this._enabled=t}drawShadowPass(t,o){if(!this.enabled)return;let h=this.painter,m=h.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(h.transform.getFrustum(0),h.transform.worldSize,this._cascades),m.viewport.set([0,0,Er.shadowMapResolution,Er.shadowMapResolution]);for(let _=0;_<this._numCascadesToRender;++_){h.currentShadowCascade=_,m.bindFramebuffer.set(this._cascades[_].framebuffer.framebuffer),m.clear({color:i.am.white,depth:1});for(let v of t.order){let E=t._mergedLayers[v];if(!E.hasShadowPass()||E.isHidden(h.transform.zoom))continue;let T=t.getLayerSourceCache(E),C=T?o[T.id]:void 0;(E.type==="model"||C&&C.length)&&h.renderLayer(h,T,E,C)}}h.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;let t=this.painter,o=t.style,h=t.context,m=h.gl,_=o.directionalLight,v=o.ambientLight;if(!_||!v)return;let E=[],T=ps(t,t.longestCutoffRange);T.shouldRenderCutoff&&E.push("RENDER_CUTOFF"),E.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&E.push("NORMAL_OFFSET");let C=pl(o,_,v),M=new ft(m.LEQUAL,ft.ReadOnly,t.depthRangeFor3D),O=new Bt({func:m.EQUAL,mask:255},0,255,m.KEEP,m.KEEP,m.KEEP);for(let P of this._groundShadowTiles){let k=P.toUnwrapped(),j=t.isTileAffectedByFog(P),B=t.getOrCreateProgram("groundShadow",{defines:E,overrideFog:j});this.setupShadows(k,B),t.uploadCommonUniforms(h,B,k,null,T);let U={u_matrix:t.transform.calculateProjMatrix(k),u_ground_shadow_factor:C};B.draw(t,m.TRIANGLES,M,O,en.multiply,Pt.disabled,U,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,null,t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?en.unblended:en.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){let o=this.painter.transform,h=o.calculatePosMatrix(t,o.worldSize);return i.az(h,this._cascades[this.painter.currentShadowCascade].matrix,h),Float32Array.from(h)}calculateShadowPassMatrixFromMatrix(t){return i.az(t,this._cascades[this.painter.currentShadowCascade].matrix,t),Float32Array.from(t)}setupShadows(t,o,h,m=0){if(!this.enabled)return;let _=this.painter.transform,v=this.painter.context,E=v.gl,T=this._uniformValues,C=new Float64Array(16),M=_.calculatePosMatrix(t,_.worldSize);for(let O=0;O<this._cascades.length;O++)i.az(C,this._cascades[O].matrix,M),T[O===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(C),v.activeTexture.set(E.TEXTURE0+zr.ShadowMap0+O),this._cascades[O].texture.bindExtraParam(E.LINEAR,E.LINEAR,E.CLAMP_TO_EDGE,E.CLAMP_TO_EDGE,E.GREATER);if(this.useNormalOffset=!!h,this.useNormalOffset){let O=i.cU(t.canonical),P=2/_.tileSize*i.aj/Er.shadowMapResolution,k=P*this._cascades[0].boundingSphereRadius,j=P*this._cascades[this._cascades.length-1].boundingSphereRadius,B=(h==="vector-tile"?1:3)/Math.pow(2,m-t.canonical.z-(1-_.zoom+Math.floor(_.zoom)));T.u_shadow_normal_offset=[O,k*B,j*B],T.u_shadow_bias=[6e-5,.0012,.012]}else T.u_shadow_bias=[36e-5,.0012,.012];o.setShadowUniformValues(v,T)}setupShadowsFromMatrix(t,o,h=!1){if(!this.enabled)return;let m=this.painter.context,_=m.gl,v=this._uniformValues,E=new Float64Array(16);for(let T=0;T<Er.cascadeCount;T++)i.az(E,this._cascades[T].matrix,t),v[T===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(E),m.activeTexture.set(_.TEXTURE0+zr.ShadowMap0+T),this._cascades[T].texture.bindExtraParam(_.LINEAR,_.LINEAR,_.CLAMP_TO_EDGE,_.CLAMP_TO_EDGE,_.GREATER);if(this.useNormalOffset=h,h){let T=Er.normalOffset;v.u_shadow_normal_offset=[1,T,T],v.u_shadow_bias=[6e-5,.0012,.012]}else v.u_shadow_bias=[36e-5,.0012,.012];o.setShadowUniformValues(m,v)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,o,h,m){if(m[2]>=0)return{};let _=function(T,C,M){let O=M/(1<<T.canonical.z);return new i.cW([T.canonical.x*O+T.wrap*M,T.canonical.y*O+T.wrap*M,0],[(T.canonical.x+1)*O+T.wrap*M,(T.canonical.y+1)*O+T.wrap*M,C])}(t,o,h).getCorners(),v=o/-m[2];m[0]<0?(i.cV(_[0],_[0],[m[0]*v,0,0]),i.cV(_[3],_[3],[m[0]*v,0,0])):m[0]>0&&(i.cV(_[1],_[1],[m[0]*v,0,0]),i.cV(_[2],_[2],[m[0]*v,0,0])),m[1]<0?(i.cV(_[0],_[0],[0,m[1]*v,0]),i.cV(_[1],_[1],[0,m[1]*v,0])):m[1]>0&&(i.cV(_[2],_[2],[0,m[1]*v,0]),i.cV(_[3],_[3],[0,m[1]*v,0]));let E={};return E.vertices=_,E.planes=[xa(_[1],_[0],_[4]),xa(_[2],_[1],_[5]),xa(_[3],_[2],_[6]),xa(_[0],_[3],_[7])],E}addShadowReceiver(t,o,h){this._receivers.add(t,i.cW.fromTileIdAndHeight(t,o,h))}getMaxCascadeForTile(t){let o=this._receivers.get(t);return o&&o.lastCascade?o.lastCascade:0}}function xa(u,t,o){let h=i.at([],o,t),m=i.at([],u,t),_=i.bF([],h,m),v=i.ae(_);return v===0?[0,0,1,0]:(i.bY(_,_,1/v),[_[0],_[1],_[2],-i.bG(_,t)])}function cc(u){let t=u.properties.get("direction"),o=i.cR(t.x,t.y,t.z);o[2]=i.ay(o[2],0,75);let h=i.cT([o[0],o[1],o[2]]);return i.cS(h.x,h.y,h.z)}function pl(u,t,o){let h=t.properties.get("color-use-theme")==="none",m=t.properties.get("color"),_=t.properties.get("intensity"),v=t.properties.get("direction"),E=[v.x,v.y,v.z],T=o.properties.get("color-use-theme")==="none",C=o.properties.get("color"),M=o.properties.get("intensity"),O=Math.max(i.bG([0,0,1],E),0),P=[0,0,0];i.bY(P,C.toPremultipliedRenderColor(T?null:u.getLut(t.scope)).toArray01Linear().slice(0,3),M);let k=[0,0,0];return i.bY(k,m.toPremultipliedRenderColor(h?null:u.getLut(o.scope)).toArray01Linear().slice(0,3),O*_),i.cY([P[0]>0?P[0]/(P[0]+k[0]):0,P[1]>0?P[1]/(P[1]+k[1]):0,P[2]>0?P[2]/(P[2]+k[2]):0])}function uc(u,t,o,h,m,_){let v=u.zoom,E=u.scale,T=u.worldSize,C=1/T,M=u.aspect,O=Math.sqrt(1+M*M)*Math.tan(.5*u.fovX),P=O*O,k=h-o,j=h+o,B,U;P>k/j?(B=h,U=h*O):(B=.5*j*(1+P),U=.5*Math.sqrt(k*k+2*(h*h+o*o)*P+j*j*P*P));let q=u.projection.pixelsPerMeter(u.center.lat,T),Z=u._camera.getCameraToWorldMercator(),ee=[0,0,-B*C];i.ad(ee,ee,Z);let re=U*C,ue=u._edgeInsets;if(!(ue.left===0&&ue.top===0&&ue.right===0&&ue.bottom===0||ue.left===ue.right&&ue.top===ue.bottom)){let Ge=u._camera.getWorldToCamera(u.worldSize,u.projection.zAxisUnit==="meters"?q:1),nt=u._camera.getCameraToClipPerspective(u._fov,u.width/u.height,o,h);nt[8]=2*-u.centerOffset.x/u.width,nt[9]=2*u.centerOffset.y/u.height;let je=new Float64Array(16);i.cB(je,nt,Ge);let et=new Float64Array(16);i.bi(et,je);let mt=i.cn.fromInvProjectionMatrix(et,T,v,!0);for(let gt of mt.points){let dt=((le=gt)[0]/=E,le[1]/=E,le[2]=i.c6(le[2],u._center.lat),le);re=Math.max(re,i.bZ(i.cX([],ee,dt)))}}var le;re*=m/(m-1);let se=Math.acos(t[2]),oe=Math.atan2(-t[0],-t[1]),he=new Fo;he.position=ee,he.setPitchBearing(se,oe);let fe=he.getWorldToCamera(T,q),Te=re*T,Ie=Math.min(u._mercatorZfromZoom(17)*T*-2,-2*Te),Be=he.getCameraToClipOrthographic(-Te,Te,-Te,Te,Ie,(Te+_*q)/t[2]),Ve=new Float64Array(16);i.az(Ve,Be,fe);let We=i.cS(Math.floor(1e6*ee[0])/1e6*T,Math.floor(1e6*ee[1])/1e6*T,0),we=.5*m,Oe=[0,0,0];i.ad(Oe,We,Ve),i.bY(Oe,Oe,we);let _e=[Math.floor(Oe[0]),Math.floor(Oe[1]),Math.floor(Oe[2])],Ue=[0,0,0];i.at(Ue,Oe,_e),i.bY(Ue,Ue,-1/we);let Me=new Float64Array(16);return i.bx(Me),i.bo(Me,Me,Ue),i.az(Ve,Me,Ve),[Ve,Te]}class $_ extends i.E{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(t,o){return i.aS(this.requestManager.transformRequest(o,i.R.Model).url).then(h=>{if(!h)return;let m=i.aT(h),_=new i.aU(t,void 0,void 0,m);return _.computeBoundsAndApplyParent(),_}).catch(h=>{if(h&&h.status===404)return null;this.fire(new i.z(new Error(`Could not load model ${t} from ${o}: ${h.message}`)))})}load(t,o,h={forceReload:!1}){this.models[o]||(this.models[o]={});let m=Object.keys(t),_=[],v=[];for(let E of m){let T=t[E];this.hasURLBeenRequested(T)&&!h.forceReload||(this.modelByURL[T]={modelId:E,scope:o},_.push(this.loadModel(E,T)),v.push(E)),this.models[o][E]||(this.models[o][E]={model:null,numReferences:1})}this.numModelsLoading[o]=(this.numModelsLoading[o]||0)+v.length,Promise.allSettled(_).then(E=>{for(let T=0;T<E.length;T++){let{status:C}=E[T];if(C==="rejected")continue;let{value:M}=E[T];this.models[o][v[T]]||(this.models[o][v[T]]={model:null,numReferences:1}),this.models[o][v[T]].model=M}this.numModelsLoading[o]-=v.length,this.fire(new i.A("data",{dataType:"style"}))}).catch(E=>{this.fire(new i.z(new Error(`Could not load models: ${E.message}`)))})}isLoaded(){for(let t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,o,h={exactIdMatch:!1}){return!!(h.exactIdMatch?this.getModel(t,o):this.getModelByURL(this.modelUris[o][t]))}getModel(t,o){return this.models[o]||(this.models[o]={}),this.models[o][t]?this.models[o][t].model:void 0}getModelByURL(t){if(!t)return null;let o=this.modelByURL[t];return o?this.models[o.scope][o.modelId].model:null}hasModelBeenAdded(t,o){return this.models[o]&&this.models[o][t]!==void 0}getModelURIs(t){return this.modelUris[t]||{}}addModel(t,o,h){this.models[h]||(this.models[h]={}),this.modelUris[h]||(this.modelUris[h]={});let m=this.requestManager.normalizeModelURL(o);if((this.hasModel(t,h,{exactIdMatch:!0})||this.hasModelBeenAdded(t,h))&&this.modelUris[h][t]===m)this.models[h][t].numReferences++;else if(this.hasURLBeenRequested(m)){let{scope:_,modelId:v}=this.modelByURL[m];this.models[_][v].numReferences++}else this.modelUris[h][t]=m,this.load({[t]:this.modelUris[h][t]},h)}addModelURLs(t,o){this.models[o]||(this.models[o]={}),this.modelUris[o]||(this.modelUris[o]={});let h=this.modelUris[o];for(let m in t)h[m]=this.requestManager.normalizeModelURL(t[m])}reloadModels(t){this.load(this.modelUris[t],t,{forceReload:!0})}addModelsFromBucket(t,o){this.models[o]||(this.models[o]={}),this.modelUris[o]||(this.modelUris[o]={});let h={};for(let m of t)this.hasModel(m,o,{exactIdMatch:!0})||this.hasURLBeenRequested(m)?this.models[o][m].numReferences++:this.modelUris[o][m]&&!this.hasURLBeenRequested(m)?h[m]=this.modelUris[o][m]:!this.hasURLBeenRequested(m)&&i.cZ(m,!1)&&(this.modelUris[o][m]=this.requestManager.normalizeModelURL(m),h[m]=this.modelUris[o][m]);this.load(h,o)}hasURLBeenRequested(t){return this.modelByURL[t]!==void 0}removeModel(t,o,h=!1){if(this.models[o]&&this.models[o][t]&&(this.models[o][t].numReferences--,this.models[o][t].numReferences===0)){let m=this.modelUris[o][t];h||delete this.modelUris[o][t],delete this.modelByURL[m];let _=this.models[o][t].model;if(!_)return;delete this.models[o][t],_.destroy()}}destroy(){for(let t of Object.keys(this.models))for(let o of Object.keys(this.models[t])){let h=this.models[t][o].model;delete this.models[t][o],h&&h.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,o){this.models[o]||(this.models[o]={});for(let h in this.models[o])this.models[o][h].model&&this.models[o][h].model.upload(t.context)}}let yd=new i.a7({data:new i.a8(i.a5.colorTheme.data)}),Hp={"mbx-indoor-active-floorplans":{default:["literal",[]]},"mbx-indoor-underground":{default:["literal",!1]},"mbx-indoor-loaded-levels":{default:["literal",[]]},"mbx-indoor-level-height":{default:["literal",{}]},"mbx-indoor-level-base":{default:["literal",{}]},"mbx-indoor-level-selected":{default:["literal",{}]},"mbx-indoor-level-overlapped":{default:["literal",{}]}};function Bs(u){return u=u||{},Object.assign(u,Hp)}class Pb extends i.E{constructor(t){super(),this.mergeFloors=!0,this._scope=void 0,this._queryFeatureSetId=void 0,this._buildingEntryFeatureSetId=void 0,this._selectedFloorplan=void 0,this._indoorData=void 0,this._floorplanStates={},i.aV(["_onLoad","_onMove","_checkFloorplanVisible"],this),this._map=t,this._checkFloorplanVisible(),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=void 0}_onLoad(){this._map.style.forEachFragmentStyle(t=>{t.stylesheet.indoor&&(this._queryFeatureSetId?this.fire(new i.z(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._queryFeatureSetId=t.stylesheet.indoor.floorplanFeaturesetId,this._buildingEntryFeatureSetId=t.stylesheet.indoor.buildingFeaturesetId,this._scope=t.scope))}),this._queryFeatureSetId&&this._buildingEntryFeatureSetId&&this._map.addInteraction("mbx-indoor-buildingclick",{type:"click",target:{featuresetId:this._buildingEntryFeatureSetId,importId:this._scope},handler:t=>(t.feature&&t.feature.properties.floorplan&&this.selectFloorplan(t.feature.properties.floorplan),!0)}),this._checkFloorplanVisible()}_onMove(){this._checkFloorplanVisible()}_checkFloorplanVisible(){if(!this._queryFeatureSetId||!this._map.isStyleLoaded())return;let t=()=>{this._indoorData=void 0,this._selectedFloorplan=void 0,this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",["literal",[]]),this.fire(new i.A("floorplangone"))};if(this._map.transform.zoom<13)return void t();let o={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},h=this._map.transform.width,m=this._map.transform.height,_=h*(2/3),v=m*(2/3),E=.5*(h-_),T=.5*(m-v),C=[new i.P(E,T),new i.P(E+_,T+v)],M=this._map.queryRenderedFeatures(C,o);M.length>0?this._selectedFloorplan&&M[0].properties.id===this._selectedFloorplan.properties.id||(this._selectedFloorplan=M[0],this._floorplanSelected()):t()}_floorplanSelected(){this._indoorData=JSON.parse(this._selectedFloorplan.properties["indoor-data"]),this._indoorData.id=this._selectedFloorplan.properties.id,this._floorplanStates[this._indoorData.id]=this._floorplanStates[this._indoorData.id]||{},this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",["literal",[this._indoorData.id]]);let t=this._floorplanStates[this._indoorData.id].selectedBuilding,o=t?this._indoorData.buildings.find(E=>E.id===t):this._indoorData.buildings.length>0?this._indoorData.buildings[0]:null,h=this._floorplanStates[this._indoorData.id].selectedLevel,m=this._indoorData.levels.find(E=>E.id===h),_=this._indoorData.levels.find(E=>!(!o||!o.levels)&&Number(E.levelOrder)===0&&o.levels.includes(E.id)),v=m?m.id:_?_.id:void 0;this.fire(new i.A("floorplanselected",{buildings:this._indoorData.buildings,levels:this._indoorData.levels,selectedLevelId:v})),o&&this._buildingSelected(o,!1),v&&this._levelSelected(v)}_buildingSelected(t,o){if(!t||!t.id)return void console.warn("IndoorManager: Building or building id is undefined");o&&t.extent&&this._map.fitBounds(t.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),this._floorplanStates[this._indoorData.id].selectedBuilding=t?t.id:void 0;let h=this._indoorData.levels.filter(m=>t.levels.includes(m.id));this.fire(new i.A("buildingselected",{buildingId:t.id,levels:h}))}_levelSelected(t){let o=this._indoorData.levels.find(h=>h.id===t);o?(this._updateLevels(o,!0),this.fire(new i.A("levelselected",{levelId:o.id}))):console.warn(`IndoorManager: Level with ID ${t} not found in the current floorplan.`)}_updateLevels(t,o){if(!t||!t.id)throw new Error("IndoorManager: Selected level or level ID is undefined");function h(C){let M=C.indexOf("/floor/");if(M===-1)return C;let O=M+7,P=C.indexOf("/",O);return P===-1?C.slice(O):C.slice(O,P)}this._floorplanStates[this._indoorData.id].selectedLevel=t.id;let m=[],_={},v={},E={},T={};for(let C of this._indoorData.levels){if(m.push(C.id),_[C.id]=C.levelOrder>=0?3*Math.abs(C.levelOrder+1):3*Math.abs(C.levelOrder),v[C.id]=C.levelOrder>=0?3*C.levelOrder:0,this.mergeFloors){let M=h(t.id),O=h(C.id);E[C.id]=O===M?"true":"false"}else E[C.id]=C.id===t.id?"true":"false";T[C.id]=C.levelOrder<t.levelOrder?"true":"false"}this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",m]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-height",["literal",_]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-base",["literal",v]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",E]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-overlapped",["literal",T]),this._map.setConfigProperty(this._scope,"mbx-indoor-underground",t.levelOrder<0)}selectFloorplan(t){let o={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},h=[new i.P(0,0),new i.P(this._map.transform.width,this._map.transform.height)],m=this._map.queryRenderedFeatures(h,o);if(m.length>0){for(let _ of m)if(JSON.parse(_.properties["indoor-data"]).id===t){this._selectedFloorplan=_,this._floorplanSelected();break}}}selectBuilding(t){let o=this._indoorData.buildings.find(h=>h.id===t);this._buildingSelected(o,!0)}selectLevel(t){this._levelSelected(t)}}function Lb(u){if(!u.metadata||!u.metadata.content_area)return;let t=i.q.devicePixelRatio,{left:o,top:h,width:m,height:_}=u.metadata.content_area,v=o*t,E=h*t;return[v,E,v+m*t,E+_*t]}function G_(u){if(u)return u.map(([t,o])=>[t*i.q.devicePixelRatio,o*i.q.devicePixelRatio])}class q_{constructor(t,o,h){this.id=t,this.scope=o,this.sourceCache=h,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(t){this.missingRequests.has(t.name)||this.pendingRequests.has(t.name)||this.pendingRequests.add(t.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){let t=new Map;if(!this.sourceCache.loaded())return t;let o=this.sourceCache.getVisibleCoordinates();if(o.length===0)return t;let h=this.sourceCache.getSource();if(!(h instanceof ga))return t;let m=o.map(v=>this.sourceCache.getTile(v)),_=h.getImages(m,Array.from(this.pendingRequests));for(let[v,E]of _)t.set(i.I.from({name:v,iconsetId:this.id}),E),this.pendingRequests.delete(v);for(let v of this.pendingRequests)this.missingRequests.add(v);return this.pendingRequests.clear(),t}}let ml=(u,t)=>ae(u,t&&t.filter(o=>o.identifier!=="source.canvas")),$p=i.aF(pn,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),W_=i.aF(pn,["setCenter","setZoom","setBearing","setPitch"]),vd=new Set(["background","sky","slot","custom"]),Gp={version:8,layers:[],sources:{}},qp={duration:300,delay:0};class Tr extends i.E{constructor(t,o={}){super(),this.map=t,this.scope=o.scope||"",this.globalId=null,this.fragments=[],this.importDepth=o.importDepth||0,this.importsCache=o.importsCache||new Map,this.resolvedImports=o.resolvedImports||new Set,this.transition=i.h({},qp),this._buildingIndex=new V_(this),this.crossTileSymbolIndex=new Yr,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=o.styleChanges||new Vi,this.dispatcher=o.dispatcher?o.dispatcher:new i.D(i.c$(),this),o.imageManager?this.imageManager=o.imageManager:(this.imageManager=new ca(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=o.glyphManager?o.glyphManager:new i.d0(t._requestManager,o.localFontFamily?i.d1.all:o.localIdeographFontFamily?i.d1.ideographs:i.d1.none,o.localFontFamily||o.localIdeographFontFamily),o.modelManager?this.modelManager=o.modelManager:(this.modelManager=new $_(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=o.configOptions?o.configOptions:new Map,this._configDependentLayers=o.configDependentLayers?o.configDependentLayers:new Set,this._config=o.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:o.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=o.initialConfig,this.dispatcher.broadcast("setReferrer",i.d2());let h=this;this._rtlTextPluginCallback=Tr.registerForPluginStateChange(m=>{h.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:m.pluginStatus,pluginURL:m.pluginURL},(_,v)=>{if(i.d3(_),v&&v.every(E=>E))for(let E in h._sourceCaches){let T=h._sourceCaches[E],C=T.getSource().type;C!=="vector"&&C!=="geojson"||T.reload()}})}),this.on("data",m=>{if(m.dataType!=="source"||m.sourceDataType!=="metadata")return;let _=this.getOwnSource(m.sourceId);if(_&&_.vectorLayerIds)for(let v in this._layers){let E=this._layers[v];E.source===_.id&&this._validateLayer(E)}})}load(t){return t?(typeof t=="string"?this.loadURL(t):this.loadJSON(t),this):this}_getGlobalId(t){if(!t)return null;if(typeof t=="string"){if(i.j(t))return t;let o=i.d4(t);if(!o.startsWith("http"))try{return new URL(o,location.href).toString()}catch{return o}return o}return`json://${i.d5(JSON.stringify(t))}`}_diffStyle(t,o,h){this.globalId=this._getGlobalId(t);let m=(_,v)=>{try{v(null,this.setState(_,h))}catch(E){v(E,!1)}};if(typeof t=="string"){let _=this.map._requestManager.normalizeStyleURL(t),v=this.map._requestManager.transformRequest(_,i.R.Style);i.n(v,(E,T)=>{E?this.fire(new i.z(E)):T&&m(T,o)})}else typeof t=="object"&&m(t,o)}loadURL(t,o={}){this.fire(new i.A("dataloading",{dataType:"style"}));let h=typeof o.validate=="boolean"?o.validate:!i.j(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,o.accessToken),this.resolvedImports.add(t);let m=this.importsCache.get(t);if(m)return this._load(m,h);let _=this.map._requestManager.transformRequest(t,i.R.Style);this._request=i.n(_,(v,E)=>{if(this._request=null,v)this.fire(new i.z(v));else if(E)return this.importsCache.set(t,E),this._load(E,h)})}loadJSON(t,o={}){this.fire(new i.A("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=i.q.frame(()=>{this._request=null,this._load(t,o.validate!==!1)})}loadEmpty(){this.fire(new i.A("dataloading",{dataType:"style"})),this._load(Gp,!1)}_loadImports(t,o,h){if(this.importDepth>=4)return i.w("Style doesn't support nesting deeper than 5"),Promise.resolve();let m=[];for(let _ of t){let v=this._createFragmentStyle(_),E=new Promise(M=>{v.once("style.import.load",M),v.once("error",M)}).then(()=>this.mergeAll());if(m.push(E),this.resolvedImports.has(_.url)){v.loadEmpty();continue}let T=_.data||this.importsCache.get(_.url);T?(v.loadJSON(T,{validate:o}),this._isInternalStyle(T)&&(v.globalId=null)):_.url?v.loadURL(_.url,{validate:o}):v.loadEmpty();let C={style:v,id:_.id,config:_.config};if(h){let M=this.fragments.findIndex(({id:O})=>O===h);this.fragments=this.fragments.slice(0,M).concat(C).concat(this.fragments.slice(M))}else this.fragments.push(C)}return Promise.allSettled(m)}getImportGlobalIds(t=this,o=new Set){for(let h of t.fragments)h.style.globalId&&o.add(h.style.globalId),this.getImportGlobalIds(h.style,o);return[...o.values()]}_createFragmentStyle(t){let o=this.scope?i.C(t.id,this.scope):t.id,h,m=this._initialConfig&&this._initialConfig[o];(t.config||m)&&(h=i.h({},t.config,m));let _=new Tr(this.map,{scope:o,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:h,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers});return _.setEventedParent(this.map,{style:_}),_}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(t){return this.isRootStyle()&&(t.fragment||!!t.schema&&t.fragment!==!1)}_load(t,o){let h=t.indoor?Bs(t.schema):t.schema;if(this._isInternalStyle(t)){let v=i.h({},Gp,{imports:[{id:"basemap",data:t,url:""}]});return void this._load(v,o)}if(this.updateConfig(this._config,h),o&&ml(this,oo(t)))return;this._loaded=!0,this.stylesheet=i.d6(t);let m=()=>{for(let C in t.sources)this.addSource(C,t.sources[C],{validate:!1,isInitialLoad:!0});if(t.iconsets)for(let C in t.iconsets)this.addIconset(C,t.iconsets[C]);t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.setGlyphsUrl(t.glyphs);let v=Du(this.stylesheet.layers);if(this._order=v.map(C=>C.id),this.stylesheet.light&&i.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){let C=this.stylesheet.lights[0];this.light=new De(C.properties,C.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new De(this.stylesheet.light)),this._layers={};for(let C of v){let M=i.db(C,this.scope,this._styleColorTheme.lut,this.options);M.configDependencies.size!==0&&this._configDependentLayers.add(M.fqid),M.setEventedParent(this,{layer:{id:M.id}}),this._layers[M.id]=M;let O=this.getOwnLayerSourceCache(M),P=!!this.directionalLight&&this.directionalLight.shadowsEnabled();O&&M.canCastShadows()&&P&&(O.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);let E=this.stylesheet.terrain;E&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(E,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new i.A("data",{dataType:"style"}));let T=this.isRootStyle();t.imports?this._loadImports(t.imports,o).then(()=>{this._reloadImports(),this.fire(new i.A(T?"style.load":"style.import.load"))}).catch(C=>{this.fire(new i.z(new Error("Failed to load imports",C))),this.fire(new i.A(T?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new i.A(T?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];let _=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(_){let v=this._evaluateColorThemeData(_);this._loadColorTheme(v).then(()=>{m()}).catch(E=>{i.w(`Couldn't load color theme from the stylesheet: ${E}`),m()})}else this._styleColorTheme.lut=null,m()}isRootStyle(){return this.importDepth===0}mergeAll(){let t,o,h,m,_,v,E,T,C,M,O={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(P=>{if(P.stylesheet){if(P.light!=null&&(t=P.light),P.stylesheet.lights)for(let k of P.stylesheet.lights)k.type==="ambient"&&P.ambientLight!=null&&(o=P.ambientLight),k.type==="directional"&&P.directionalLight!=null&&(h=P.directionalLight);m=this._prioritizeTerrain(m,P.terrain,P.stylesheet.terrain),P.stylesheet.fog&&P.fog!=null&&(_=P.fog),P.stylesheet.snow&&P.snow!=null&&(v=P.snow),P.stylesheet.rain&&P.rain!=null&&(E=P.rain),P.stylesheet.camera!=null&&(M=P.stylesheet.camera),P.stylesheet.projection!=null&&(T=P.stylesheet.projection),P.stylesheet.transition!=null&&(C=P.stylesheet.transition),O[P.scope]=P._styleColorTheme}}),this.light=t,this.ambientLight=o,this.directionalLight=h,this.fog=_,this.snow=v,this.rain=E,this._styleColorThemeForScope=O,m===null?delete this.terrain:this.terrain=m,this.camera=M||{"camera-projection":"perspective"},this.projection=T||{name:"mercator"},this.transition=i.h({},qp,C),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(t){let o=h=>{for(let m of h.fragments)o(m.style);t(h)};o(this)}_prioritizeTerrain(t,o,h){let m=t&&t.drapeRenderMode===0;return h===null?o&&o.drapeRenderMode===0?o:m?t:null:o!=null&&(!t||m||o&&o.drapeRenderMode===1)?o:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(o=>{t=this._prioritizeTerrain(t,o.terrain,o.stylesheet.terrain)}),t===null?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle(o=>{o.stylesheet.projection!=null&&(t=o.stylesheet.projection)}),this.projection=t||{name:"mercator"}}mergeSources(){let t={},o={},h={};this.forEachFragmentStyle(m=>{for(let _ in m._sourceCaches){let v=i.C(_,m.scope);t[v]=m._sourceCaches[_]}for(let _ in m._otherSourceCaches){let v=i.C(_,m.scope);o[v]=m._otherSourceCaches[_]}for(let _ in m._symbolSourceCaches){let v=i.C(_,m.scope);h[v]=m._symbolSourceCaches[_]}}),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=o,this._mergedSymbolSourceCaches=h}mergeLayers(){let t={},o=[],h={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(_=>{for(let v of _._order){let E=_._layers[v];if(E.type==="slot"){let T=i.d7(v);if(t[T])continue;t[T]=[]}E.slot&&t[E.slot]?t[E.slot].push(E):o.push(E)}}),this._mergedOrder=[];let m=(_=[])=>{for(let v of _)if(v.type==="slot"){let E=i.d7(v.id);t[E]&&m(t[E]),this._mergedSlots.push(E)}else{let E=i.C(v.id,v.scope);this._mergedOrder.push(E),h[E]=v,v.is3D(!!this.terrain)&&(this._has3DLayers=!0),v.type==="circle"&&(this._hasCircleLayers=!0),v.type==="symbol"&&(this._hasSymbolLayers=!0),v.type==="clip"&&(this._clipLayerPresent=!0)}};m(o),this._mergedOrder.sort((_,v)=>{let E=h[_],T=h[v];return E.hasInitialOcclusionOpacityProperties?T.is3D(!!this.terrain)?1:0:E.is3D(!!this.terrain)&&T.hasInitialOcclusionOpacityProperties?-1:0}),this._mergedLayers=h,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=i.h({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?function(o,h,m,_){let v=i.h({},h);for(let T of Object.keys(i.a5.colorTheme))v[T]===void 0&&(v[T]=i.a5.colorTheme[T].default);let E=new i.a6(yd,o,new Map(m));return E.setTransitionOrValue(v,m),E.untransitioned().possiblyEvaluate(new i.aa(0,{worldview:void 0}))}(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;let o=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((h,m)=>{let _="data:image/png;base64,";if(!t||t.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void h();let v=t;v.startsWith(_)||(v=_+v);let E=i.I.from("mapbox-reserved-lut"),T=new Image;T.src=v,T.onerror=()=>{this._styleColorTheme.lutLoading=!1,m(new Error("Failed to load image data"))},T.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==o)return void h();this._styleColorTheme.lutLoading=!1;let{width:C,height:M,data:O}=i.q.getImageData(T);if(M>32)return void m(new Error("The height of the image must be less than or equal to 32 pixels."));if(C!==M*M)return void m(new Error("The width of the image must be equal to the height squared."));this.getImage(E)&&this.removeImage(E),this.addImage(E,{data:new i.r({width:C,height:M},O),pixelRatio:1,sdf:!1,usvg:!1,version:0});let P=this.imageManager.getImage(E,this.scope);P?(this._styleColorTheme.lut={image:P.data,data:t},h()):m(new Error("Missing LUT image."))}})}getLut(t){let o=this._styleColorThemeForScope[t];return o?o.lut:null}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=function(o,h,m){let _,v,E,T=i.q.devicePixelRatio>1?"@2x":"",C=i.n(h.transformRequest(h.normalizeSpriteURL(o,T,".json"),i.R.SpriteJSON),(P,k)=>{C=null,E||(E=P,_=k,O())}),M=i.o(h.transformRequest(h.normalizeSpriteURL(o,T,".png"),i.R.SpriteImage),(P,k)=>{M=null,E||(E=P,v=k,O())});function O(){if(E)m(E);else if(_&&v){let P=i.q.getImageData(v),k={};for(let j in _){let{width:B,height:U,x:q,y:Z,sdf:ee,pixelRatio:re,stretchX:ue,stretchY:le,content:se}=_[j],oe=new i.r({width:B,height:U});i.r.copy(P,oe,{x:q,y:Z},{x:0,y:0},{width:B,height:U},null),k[j]={data:oe,pixelRatio:re,sdf:ee,stretchX:ue,stretchY:le,content:se,usvg:!1}}m(null,k)}}return{cancel(){C&&(C.cancel(),C=null),M&&(M.cancel(),M=null)}}}(t,this.map._requestManager,(o,h)=>{if(this._spriteRequest=null,o)this.fire(new i.z(o));else if(h){let m=new Map;for(let _ in h)m.set(i.I.from(_),h[_]);this.addImages(m)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new i.A("data",{dataType:"style"}))})}addIconset(t,o){if(o.type==="sprite")return void this._loadSprite(o.url);let h=this.getOwnSourceCache(o.source);if(!h)return void this.fire(new i.z(new Error(`Source "${o.source}" as specified by iconset "${t}" does not exist and cannot be used as an iconset source`)));let m=h.getSource();if(m.type!=="raster-array")return void this.fire(new i.z(new Error(`Source "${o.source}" as specified by iconset "${t}" is not a "raster-array" source and cannot be used as an iconset source`)));m.partial=!1;let _=new q_(t,this.scope,h);this.imageManager.addImageProvider(_,this.scope)}removeIconset(t){this.imageManager.removeImageProvider(t,this.scope)}_loadIconset(t){if(!i.j(t)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(t);let o=this.map._spriteFormat==="auto";var h,m;this._spriteRequest=(m=(_,v)=>{if(this._spriteRequest=null,_)o?this._loadSprite(t):this.fire(new i.z(_));else if(v){let E=new Map;for(let T in v)E.set(i.I.from(T),v[T]);this.addImages(E)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new i.A("data",{dataType:"style"}))},i.br((h=this.map._requestManager).transformRequest(h.normalizeIconsetURL(t),i.R.Iconset),(_,v)=>{if(_)return void m(_);let E={},T=i.c_(new i.bq(v));for(let C of T.icons){let M={version:1,pixelRatio:i.q.devicePixelRatio,content:Lb(C),stretchX:C.metadata?G_(C.metadata.stretch_x_areas):void 0,stretchY:C.metadata?G_(C.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:C};E[C.name]=M}m(null,E)}))}_validateLayer(t){let o=this.getOwnSource(t.source);if(!o)return;let h=t.sourceLayer;h&&(o.type==="geojson"||o.vectorLayerIds&&o.vectorLayerIds.indexOf(h)===-1)&&this.fire(new i.z(new Error(`Source layer "${h}" does not exist on source "${o.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(let t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(let{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((t,o)=>{let h=this.fragments[o];return h&&h.style&&(t.data=h.style.serialize()),t})}_serializeSources(){let t={};for(let o in this._sourceCaches){let h=this._sourceCaches[o].getSource();t[h.id]||(t[h.id]=h.serialize())}return t}_serializeLayers(t){let o=[];for(let h of t){let m=this._layers[h];m&&m.type!=="custom"&&o.push(m.serialize())}return o}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(let t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(let t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(t){return t?this.order:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&t.isDraped(this.getLayerSourceCache(t))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){let o=this.getOwnLayer(t);if(o)return o;this.fire(new i.z(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){let o=this.getOwnSource(t);if(o)return o;this.fire(new i.z(new Error(`The source '${t}' does not exist in the map's style.`)))}precompilePrograms(t,o){let h=this.map.painter;if(h)for(let m=t.minzoom||0;m<(t.maxzoom||25.5);m++){let _=t.getProgramIds();if(_)for(let v of _){let E=t.getDefaultProgramParams(v,o.zoom,this._styleColorTheme.lut);E&&(h.style=this,this.fog&&(h._fogVisible=!0,E.overrideFog=!0,h.getOrCreateProgram(v,E)),h._fogVisible=!1,E.overrideFog=!1,h.getOrCreateProgram(v,E),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(E.overrideRtt=!0,h.getOrCreateProgram(v,E)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);let o=this.calculateLightsBrightness();t.brightness=o||0,o!==this._brightness&&(this._brightness=o,this.dispatcher.broadcast("setBrightness",o)),t.worldview!==this._worldview&&(this._worldview=t.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));let h=this._changes.isDirty(),m=!1;if(this._changes.isDirty()){let E=this._changes.getLayerUpdatesByScope();for(let T in E){let{updatedIds:C,removedIds:M}=E[T];(C||M)&&(this._updateWorkerLayers(T,C,M),m=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}let _={};for(let E in this._mergedSourceCaches){let T=this._mergedSourceCaches[E];_[E]=T.used,T.used=!1,T.tileCoverLift=0}for(let E of this._mergedOrder){let T=this._mergedLayers[E];if(T.recalculate(t,this._availableImages),!T.isHidden(t.zoom)){let C=this.getLayerSourceCache(T);C&&(C.used=!0,C.tileCoverLift=Math.max(C.tileCoverLift,T.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(T,t)}):this.precompilePrograms(T,t))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&m&&this.mergeLayers();let v=this.imageManager.getPendingImageProviders();for(let E of v)E.sourceCache.used=!0;for(let E in _){let T=this._mergedSourceCaches[E];_[E]!==T.used&&T.getSource().fire(new i.A("data",{sourceDataType:"visibility",dataType:"source",sourceId:T.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),h&&this.fire(new i.A("data",{dataType:"style"}))}updateImageProviders(){let t=this.imageManager.getPendingImageProviders();for(let o of t){let h=o.resolvePendingRequests(),m=this.getFragmentStyle(o.scope);m&&m.addImages(h)}}_updateTilesForChangedImages(){let t={};for(let o in this._mergedSourceCaches){let h=this._mergedSourceCaches[o].getSource().scope;t[h]=t[h]||this._changes.getUpdatedImages(h),t[h].length!==0&&this._mergedSourceCaches[o].reloadTilesForDependencies(["icons","patterns"],t[h])}for(let o in t)this._changes.resetUpdatedImages(o)}_updateWorkerLayers(t,o,h){let m=this.getFragmentStyle(t);m&&this.dispatcher.broadcast("updateLayers",{layers:o?m._serializeLayers(o):[],scope:t,removedIds:h||[],options:m.options})}setState(t,o){if(this._checkLoaded(),ml(this,oo(t)))return!1;(t=i.d6(t)).layers=Du(t.layers);let h=function(v,E){if(!v)return[{command:pn.setStyle,args:[E]}];let T=[];try{if(!i.bv(v.version,E.version))return[{command:pn.setStyle,args:[E]}];if(i.bv(v.center,E.center)||T.push({command:pn.setCenter,args:[E.center]}),i.bv(v.zoom,E.zoom)||T.push({command:pn.setZoom,args:[E.zoom]}),i.bv(v.bearing,E.bearing)||T.push({command:pn.setBearing,args:[E.bearing]}),i.bv(v.pitch,E.pitch)||T.push({command:pn.setPitch,args:[E.pitch]}),i.bv(v.sprite,E.sprite)||T.push({command:pn.setSprite,args:[E.sprite]}),i.bv(v.glyphs,E.glyphs)||T.push({command:pn.setGlyphs,args:[E.glyphs]}),i.bv(v.imports,E.imports)||function(k=[],j=[],B){j=j||[];let U=(k=k||[]).map(al),q=j.map(al),Z=k.reduce(_a,{}),ee=j.reduce(_a,{}),re=U.slice(),ue,le,se,oe;for(ue=0,le=0;ue<U.length;ue++)se=U[ue],ee.hasOwnProperty(se)?le++:(B.push({command:pn.removeImport,args:[se]}),re.splice(re.indexOf(se,le),1));for(ue=0,le=0;ue<q.length;ue++)se=q[q.length-1-ue],re[re.length-1-ue]!==se&&(Z.hasOwnProperty(se)?(B.push({command:pn.removeImport,args:[se]}),re.splice(re.lastIndexOf(se,re.length-le),1)):le++,oe=re[re.length-ue],B.push({command:pn.addImport,args:[ee[se],oe]}),re.splice(re.length-ue,0,se));for(let he of j){let fe=Z[he.id];fe&&(delete fe.data,i.bv(fe,he)||B.push({command:pn.updateImport,args:[he.id,he]}))}}(v.imports,E.imports,T),i.bv(v.transition,E.transition)||T.push({command:pn.setTransition,args:[E.transition]}),i.bv(v.light,E.light)||T.push({command:pn.setLight,args:[E.light]}),i.bv(v.fog,E.fog)||T.push({command:pn.setFog,args:[E.fog]}),i.bv(v.snow,E.snow)||T.push({command:pn.setSnow,args:[E.snow]}),i.bv(v.rain,E.rain)||T.push({command:pn.setRain,args:[E.rain]}),i.bv(v.projection,E.projection)||T.push({command:pn.setProjection,args:[E.projection]}),i.bv(v.lights,E.lights)||T.push({command:pn.setLights,args:[E.lights]}),i.bv(v.camera,E.camera)||T.push({command:pn.setCamera,args:[E.camera]}),i.bv(v.iconsets,E.iconsets)||function(k,j,B){let U;for(U in j=j||{},k=k||{})k.hasOwnProperty(U)&&(j.hasOwnProperty(U)||B.push({command:pn.removeIconset,args:[U]}));for(U in j){if(!j.hasOwnProperty(U))continue;let q=j[U];k.hasOwnProperty(U)?i.bv(k[U],q)||(B.push({command:pn.removeIconset,args:[U]}),B.push({command:pn.addIconset,args:[U,q]})):B.push({command:pn.addIconset,args:[U,q]})}}(v.iconsets,E.iconsets,T),!i.bv(v["color-theme"],E["color-theme"]))return[{command:pn.setStyle,args:[E]}];let C={},M=[];(function(k,j,B,U){let q;for(q in j=j||{},k=k||{})k.hasOwnProperty(q)&&(j.hasOwnProperty(q)||ic(q,B,U));for(q in j){if(!j.hasOwnProperty(q))continue;let Z=j[q];k.hasOwnProperty(q)?i.bv(k[q],Z)||(k[q].type==="geojson"&&Z.type==="geojson"&&Db(k,j,q)?B.push({command:pn.setGeoJSONSourceData,args:[q,Z.data]}):Cu(q,j,B,U)):cd(q,j,B)}})(v.sources,E.sources,M,C);let O=[];v.layers&&v.layers.forEach(k=>{k.source&&C[k.source]?T.push({command:pn.removeLayer,args:[k.id]}):O.push(k)});let P=v.terrain;P&&C[P.source]&&(T.push({command:pn.setTerrain,args:[void 0]}),P=void 0),T=T.concat(M),i.bv(P,E.terrain)||T.push({command:pn.setTerrain,args:[E.terrain]}),function(k,j,B){j=j||[];let U=(k=k||[]).map(al),q=j.map(al),Z=k.reduce(_a,{}),ee=j.reduce(_a,{}),re=U.slice(),ue=Object.create(null),le,se,oe,he,fe,Te,Ie;for(le=0,se=0;le<U.length;le++)oe=U[le],ee.hasOwnProperty(oe)?se++:(B.push({command:pn.removeLayer,args:[oe]}),re.splice(re.indexOf(oe,se),1));for(le=0,se=0;le<q.length;le++)oe=q[q.length-1-le],re[re.length-1-le]!==oe&&(Z.hasOwnProperty(oe)?(B.push({command:pn.removeLayer,args:[oe]}),re.splice(re.lastIndexOf(oe,re.length-se),1)):se++,Te=re[re.length-le],B.push({command:pn.addLayer,args:[ee[oe],Te]}),re.splice(re.length-le,0,oe),ue[oe]=!0);for(le=0;le<q.length;le++)if(oe=q[le],he=Z[oe],fe=ee[oe],!ue[oe]&&!i.bv(he,fe))if(i.bv(he.source,fe.source)&&i.bv(he["source-layer"],fe["source-layer"])&&i.bv(he.type,fe.type)){for(Ie in Mu(he.layout,fe.layout,B,oe,null,pn.setLayoutProperty),Mu(he.paint,fe.paint,B,oe,null,pn.setPaintProperty),i.bv(he.slot,fe.slot)||B.push({command:pn.setSlot,args:[oe,fe.slot]}),i.bv(he.filter,fe.filter)||B.push({command:pn.setFilter,args:[oe,fe.filter]}),i.bv(he.minzoom,fe.minzoom)&&i.bv(he.maxzoom,fe.maxzoom)||B.push({command:pn.setLayerZoomRange,args:[oe,fe.minzoom,fe.maxzoom]}),he)he.hasOwnProperty(Ie)&&Ie!=="layout"&&Ie!=="paint"&&Ie!=="filter"&&Ie!=="metadata"&&Ie!=="minzoom"&&Ie!=="maxzoom"&&Ie!=="slot"&&(Ie.indexOf("paint.")===0?Mu(he[Ie],fe[Ie],B,oe,Ie.slice(6),pn.setPaintProperty):i.bv(he[Ie],fe[Ie])||B.push({command:pn.setLayerProperty,args:[oe,Ie,fe[Ie]]}));for(Ie in fe)fe.hasOwnProperty(Ie)&&!he.hasOwnProperty(Ie)&&Ie!=="layout"&&Ie!=="paint"&&Ie!=="filter"&&Ie!=="metadata"&&Ie!=="minzoom"&&Ie!=="maxzoom"&&Ie!=="slot"&&(Ie.indexOf("paint.")===0?Mu(he[Ie],fe[Ie],B,oe,Ie.slice(6),pn.setPaintProperty):i.bv(he[Ie],fe[Ie])||B.push({command:pn.setLayerProperty,args:[oe,Ie,fe[Ie]]}))}else B.push({command:pn.removeLayer,args:[oe]}),Te=re[re.lastIndexOf(oe)+1],B.push({command:pn.addLayer,args:[fe,Te]})}(O,E.layers,T)}catch(C){console.warn("Unable to compute style diff:",C),T=[{command:pn.setStyle,args:[E]}]}return T}(this.serialize(),t).filter(v=>!(v.command in W_));if(h.length===0)return!1;let m=h.filter(v=>!(v.command in $p));if(m.length>0)throw new Error(`Unimplemented: ${m.map(v=>v.command).join(", ")}.`);let _=[];return h.forEach(v=>{_.push(this[v.command](...v.args))}),o&&Promise.all(_).then(o).catch(o),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(t){for(let[o,h]of t.entries()){if(this.getImage(o))return this.fire(new i.z(new Error(`An image with the name "${o.name}" already exists.`)));this.imageManager.addImage(o,this.scope,h),this._changes.updateImage(o,this.scope)}return this._updateWorkerImages(),this.fire(new i.A("data",{dataType:"style"})),this}addImage(t,o){return this.getImage(t)?this.fire(new i.z(new Error(`An image with the name "${t.name}" already exists.`))):(this.imageManager.addImage(t,this.scope,o),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new i.A("data",{dataType:"style"})),this)}updateImage(t,o,h=!1){this.imageManager.updateImage(t,this.scope,o),h&&(this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new i.A("data",{dataType:"style"})))}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new i.A("data",{dataType:"style"})),this):this.fire(new i.z(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModelURLs(t){return this.modelManager.addModelURLs(t,this.scope),this._updateWorkerModels(),this.fire(new i.A("data",{dataType:"style"})),this}addModel(t,o,h={}){return this._checkLoaded(),this._validate(ie,`models.${t}`,o,null,h)||(this.modelManager.addModel(t,o,this.scope),this.fire(new i.A("data",{dataType:"style"}))),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope),this.fire(new i.A("data",{dataType:"style"})),this):this.fire(new i.z(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,o,h={}){if(this._checkLoaded(),this.getOwnSource(t)!==void 0)throw new Error(`There is already a source with ID "${t}".`);if(!o.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(o).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(o.type)>=0&&this._validate(Pp,`sources.${t}`,o,null,h))return;this.map&&this.map._collectResourceTiming&&(o.collectResourceTiming=!0);let m=bu(t,o,this.dispatcher,this);m.scope=this.scope,m.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(m.id),source:m.serialize(),sourceId:m.id}));let _=v=>{let E=(v?"symbol:":"other:")+m.id,T=i.C(E,this.scope),C=this._sourceCaches[E]=new Xr(T,m,v);(v?this._symbolSourceCaches:this._otherSourceCaches)[m.id]=C,C.onAdd(this.map)};_(!1),o.type!=="vector"&&o.type!=="geojson"||_(!0),m.onAdd&&m.onAdd(this.map),h.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();let o=this.getOwnSource(t);if(!o)throw new Error("There is no source with this ID");for(let m in this._layers)if(this._layers[m].source===t)return this.fire(new i.z(new Error(`Source "${t}" cannot be removed while layer "${m}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new i.z(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){let m=Object.entries(this.stylesheet.iconsets).find(([_,v])=>v.type==="source"&&v.source===t);if(m)return this.fire(new i.z(new Error(`Source "${t}" cannot be removed while iconset "${m[0]}" is using it.`)))}let h=this.getOwnSourceCaches(t);for(let m of h){let _=i.d7(m.id);delete this._sourceCaches[_],this._changes.discardSourceCacheUpdate(m.id),m.fire(new i.A("data",{sourceDataType:"metadata",dataType:"source",sourceId:m.getSource().id})),m.setEventedParent(null),m.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),o.setEventedParent(null),o.onRemove&&o.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,o){this._checkLoaded(),this.getOwnSource(t).setData(o),this._changes.setDirty()}getOwnSource(t){let o=this.getOwnSourceCache(t);return o&&o.getSource()}getOwnSources(){let t=[];for(let o in this._otherSourceCaches){let h=this.getOwnSourceCache(o);h&&t.push(h.getSource())}return t}areTilesLoaded(){let t=this._mergedSourceCaches;for(let o in t){let h=t[o]._tiles;for(let m in h){let _=h[m];if(_.state!=="loaded"&&_.state!=="errored")return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;let o=this._getTransitionParameters();for(let _ of t){if(this._validate(il,"lights",_))return;switch(_.type){case"ambient":if(this.ambientLight){let v=this.ambientLight;v.set(_),v.updateTransitions(o)}else this.ambientLight=new An(_,qt||(qt=new i.a7({color:new i.a8(i.a5.properties_light_ambient.color),"color-use-theme":new i.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new i.a8(i.a5.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){let v=this.directionalLight;v.set(_),v.updateTransitions(o)}else this.directionalLight=new An(_,Hn||(Hn=new i.a7({direction:new i.an(i.a5.properties_light_directional.direction),color:new i.a8(i.a5.properties_light_directional.color),"color-use-theme":new i.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new i.a8(i.a5.properties_light_directional.intensity),"cast-shadows":new i.a8(i.a5.properties_light_directional["cast-shadows"]),"shadow-quality":new i.a8(i.a5.properties_light_directional["shadow-quality"]),"shadow-intensity":new i.a8(i.a5.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}let h=Object.assign(o,{worldview:this.map.getWorldview()}),m=new i.aa(this.z||0,h);this.ambientLight&&this.ambientLight.recalculate(m),this.directionalLight&&this.directionalLight.recalculate(m),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){let t=this.directionalLight,o=this.ambientLight;if(!t||!o)return;let h=P=>.2126*(P[0]<=.03928?P[0]/12.92:Math.pow((P[0]+.055)/1.055,2.4))+.7152*(P[1]<=.03928?P[1]/12.92:Math.pow((P[1]+.055)/1.055,2.4))+.0722*(P[2]<=.03928?P[2]/12.92:Math.pow((P[2]+.055)/1.055,2.4)),m=t.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),_=t.properties.get("intensity"),v=t.properties.get("direction"),E=1-i.cR(v.x,v.y,v.z)[2]/90,T=h(m)*_*E,C=o.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),M=o.properties.get("intensity"),O=h(C)*M;return Number(((T+O)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;let t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(t==null||t===""&&this.isRootStyle())return this;if(i.d8(t)){let o=i.d9(t),h=this.fragments.find(({id:_})=>_===o);if(!h)return;let m=i.d7(t);return h.style.getFragmentStyle(m)}{let o=this.fragments.find(({id:h})=>h===t);return o?o.style:void 0}}setFeaturesetSelectors(t){if(!t)return;let o={},h=(m,_="")=>`${m}::${_}`;this._featuresetSelectors={};for(let m in t){let _=this._featuresetSelectors[m]=[];for(let v of t[m].selectors){if(v.featureNamespace){let T=this.getOwnLayer(v.layer);if(!T){i.w(`Layer is undefined for selector: ${v.layer}`);continue}let C=h(T.source,T.sourceLayer);if(C in o&&o[C]!==v.featureNamespace){i.w(`"featureNamespace ${v.featureNamespace} of featureset ${m}'s selector is not associated to the same source, skip this selector`);continue}o[C]=v.featureNamespace}let E;if(v.properties)for(let T in v.properties){let C=i.X(v.properties[T]);C.result==="success"&&(E=E||{},E[T]=C.value)}_.push({layerId:v.layer,namespace:v.featureNamespace,properties:E,uniqueFeatureID:v._uniqueFeatureID})}}}getFeaturesetDescriptors(t){let o=this.getFragmentStyle(t);if(!o||!o.stylesheet.featuresets)return[];let h=[];for(let m in o.stylesheet.featuresets)h.push({featuresetId:m,importId:o.scope?o.scope:void 0});return h}getFeaturesetLayers(t,o){let h=this.getFragmentStyle(o),m=h.stylesheet.featuresets;if(!m||!m[t])return this.fire(new i.z(new Error(`The featureset '${t}' does not exist in the map's style and cannot be queried.`))),[];let _=[];for(let v of m[t].selectors){let E=h.getOwnLayer(v.layer);E&&_.push(E)}return _}getConfigProperty(t,o){let h=this.getFragmentStyle(t);if(!h)return null;let m=i.C(o,h.scope),_=h.options.get(m),v=_?_.value||_.default:null;return v?v.serialize():null}setConfigProperty(t,o,h){let m=this.getFragmentStyle(t);if(!m)return;let _=m.stylesheet.indoor?Bs(m.stylesheet.schema):m.stylesheet.schema;if(!_||!_[o])return;let v=i.X(h);if(v.result!=="success")return void ml(this,v.value);let E=v.value.expression,T=i.C(o,m.scope),C=m.options.get(T);if(!C)return;let M,{minValue:O,maxValue:P,stepValue:k,type:j,values:B}=_[o],U=i.X(_[o].default);U.result==="success"&&(M=U.value.expression),M?(this.options.set(T,Object.assign({},C,{value:E,default:M,minValue:O,maxValue:P,stepValue:k,type:j,values:B})),this.updateConfigDependencies(o)):this.fire(new i.z(new Error(`No schema defined for the config option "${o}" in the "${t}" fragment.`)))}getConfig(t){let o=this.getFragmentStyle(t);if(!o)return null;let h=o.stylesheet.schema;if(!h)return null;let m={};for(let _ in h){let v=i.C(_,o.scope),E=o.options.get(v),T=E?E.value||E.default:null;m[_]=T?T.serialize():null}return m}setConfig(t,o){let h=this.getFragmentStyle(t);h&&(h.updateConfig(o,h.stylesheet.schema),this.updateConfigDependencies())}getSchema(t){let o=this.getFragmentStyle(t);return o?o.stylesheet.schema:null}setSchema(t,o){let h=this.getFragmentStyle(t);h&&(h.stylesheet.schema=o,h.updateConfig(h._config,o),this.updateConfigDependencies())}updateConfig(t,o){if(this._config=t,t||o)if(o)for(let h in o){let m,_,v=i.X(o[h].default);if(v.result==="success"&&(m=v.value.expression),t&&t[h]!==void 0){let P=i.X(t[h]);P.result==="success"&&(_=P.value.expression)}let{minValue:E,maxValue:T,stepValue:C,type:M,values:O}=o[h];if(m){let P=i.C(h,this.scope);this.options.set(P,{default:m,value:_,minValue:E,maxValue:T,stepValue:C,type:M,values:O})}else this.fire(new i.z(new Error(`No schema defined for config option "${h}".`)))}else this.fire(new i.z(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(t){for(let o of this._configDependentLayers){let h=this.getLayer(o);if(h){if(t&&!h.configDependencies.has(t))continue;h.possiblyEvaluateVisibility(),this._updateLayer(h)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(o=>{let h=o._styleColorTheme.colorThemeOverride?o._styleColorTheme.colorThemeOverride:o._styleColorTheme.colorTheme;if(h){let m=o._evaluateColorThemeData(h);(!o._styleColorTheme.lut&&m!==""||o._styleColorTheme.lut&&m!==o._styleColorTheme.lut.data)&&o.setColorTheme(h)}}),this._changes.setDirty()}addLayer(t,o,h={}){this._checkLoaded();let m=t.id;if(this._layers[m])return void this.fire(new i.z(new Error(`Layer with id "${m}" already exists on this map`)));let _;if(t.type==="custom"){if(ml(this,i.da(t)))return;_=i.db(t,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof t.source=="object"&&(this.addSource(m,t.source),t=i.d6(t),t=i.h(t,{source:m})),this._validate(gn,`layers.${m}`,t,{arrayIndex:-1},h))return;_=i.db(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(_),_.setEventedParent(this,{layer:{id:m}})}_.configDependencies.size!==0&&this._configDependentLayers.add(_.fqid);let v=this._order.length;if(o){let M=this._order.indexOf(o);if(M===-1)return void this.fire(new i.z(new Error(`Layer with id "${o}" does not exist on this map.`)));_.slot===this._layers[o].slot?v=M:i.w(`Layer with id "${o}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(v,0,m),this._layerOrderChanged=!0,this._layers[m]=_;let E=this.getOwnLayerSourceCache(_),T=!!this.directionalLight&&this.directionalLight.shadowsEnabled();E&&_.canCastShadows()&&T&&(E.castsShadows=!0);let C=this._changes.getRemovedLayer(_);if(C&&_.source&&E&&_.type!=="custom"){this._changes.discardLayerRemoval(_);let M=i.C(_.source,_.scope);C.type!==_.type?this._changes.updateSourceCache(M,"clear"):(this._changes.updateSourceCache(M,"reload"),E.pause())}this._updateLayer(_),_.onAdd&&_.onAdd(this.map),_.scope=this.scope,this.mergeLayers()}moveLayer(t,o){this._checkLoaded();let h=this._checkLayer(t);if(!h||t===o)return;let m=this._order.indexOf(t);this._order.splice(m,1);let _=this._order.length;if(o){let v=this._order.indexOf(o);if(v===-1)return void this.fire(new i.z(new Error(`Layer with id "${o}" does not exist on this map.`)));h.slot===this._layers[o].slot?_=v:i.w(`Layer with id "${o}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(_,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();let o=this._checkLayer(t);if(!o)return;o.setEventedParent(null);let h=this._order.indexOf(t);this._order.splice(h,1),delete this._layers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(o.fqid),this._changes.removeLayer(o);let m=this.getOwnLayerSourceCache(o);if(m&&m.castsShadows){let _=!1;for(let v in this._layers)if(this._layers[v].source===o.source&&this._layers[v].canCastShadows()){_=!0;break}m.castsShadows=_}o.onRemove&&o.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(let o in this._layers)if(this._layers[o].type===t)return!0;return!1}setLayerZoomRange(t,o,h){this._checkLoaded();let m=this._checkLayer(t);m&&(m.minzoom===o&&m.maxzoom===h||(o!=null&&(m.minzoom=o),h!=null&&(m.maxzoom=h),this._updateLayer(m)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(t,o){this._checkLoaded();let h=this._checkLayer(t);h&&h.slot!==o&&(h.slot=o,this._updateLayer(h))}setFilter(t,o,h={}){this._checkLoaded();let m=this._checkLayer(t);if(m&&!i.bv(m.filter,o))return o==null?(m.filter=void 0,void this._updateLayer(m)):void(this._validate(Ae,`layers.${m.id}.filter`,o,{layerType:m.type},h)||(m.filter=i.d6(o),this._updateLayer(m)))}getFilter(t){let o=this._checkLayer(t);if(o)return i.d6(o.filter)}setLayoutProperty(t,o,h,m={}){this._checkLoaded();let _=this._checkLayer(t);if(_&&!i.bv(_.getLayoutProperty(o),h)){if(h!=null&&(!m||m.validate!==!1)&&ml(_,X.call(oo,{key:`layers.${t}.layout.${o}`,layerType:_.type,objectKey:o,value:h,styleSpec:i.a5,style:{glyphs:!0,sprite:!0}})))return;_.setLayoutProperty(o,h),_.configDependencies.size!==0&&this._configDependentLayers.add(_.fqid),this._updateLayer(_)}}getLayoutProperty(t,o){let h=this._checkLayer(t);if(h)return h.getLayoutProperty(o)}setPaintProperty(t,o,h,m={}){this._checkLoaded();let _=this._checkLayer(t);if(!_||i.bv(_.getPaintProperty(o),h)||h!=null&&(!m||m.validate!==!1)&&ml(_,G.call(oo,{key:`layers.${t}.paint.${o}`,layerType:_.type,objectKey:o,value:h,styleSpec:i.a5})))return;let v=_.setPaintProperty(o,h);_.configDependencies.size!==0&&this._configDependentLayers.add(_.fqid),v&&this._updateLayer(_),this._changes.updatePaintProperties(_)}getPaintProperty(t,o){let h=this._checkLayer(t);if(h)return h.getPaintProperty(o)}setFeatureState(t,o){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){let{featuresetId:T,importId:C}=t.target,M=this.getFragmentStyle(C),O=M.getFeaturesetLayers(T);for(let{source:P,sourceLayer:k}of O)M.setFeatureState({id:t.id,source:P,sourceLayer:k},o)}else if("layerId"in t.target){let{layerId:T}=t.target,C=this.getLayer(T);this.setFeatureState({id:t.id,source:C.source,sourceLayer:C.sourceLayer},o)}return}let h=t.source,m=t.sourceLayer,_=this._checkSource(h);if(!_)return;let v=_.type;if(v==="geojson"&&m)return void this.fire(new i.z(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(v==="vector"&&!m)return void this.fire(new i.z(new Error("The sourceLayer parameter must be provided for vector source types.")));t.id===void 0&&this.fire(new i.z(new Error("The feature id parameter must be provided.")));let E=this.getOwnSourceCaches(h);for(let T of E)T.setFeatureState(m,t.id,o)}removeFeatureState(t,o){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){let{featuresetId:T,importId:C}=t.target,M=this.getFragmentStyle(C),O=M.getFeaturesetLayers(T);for(let{source:P,sourceLayer:k}of O)M.removeFeatureState({id:t.id,source:P,sourceLayer:k},o)}else if("layerId"in t.target){let{layerId:T}=t.target,C=this.getLayer(T);this.removeFeatureState({id:t.id,source:C.source,sourceLayer:C.sourceLayer},o)}return}let h=t.source,m=this._checkSource(h);if(!m)return;let _=m.type,v=_==="vector"?t.sourceLayer:void 0;if(_==="vector"&&!v)return void this.fire(new i.z(new Error("The sourceLayer parameter must be provided for vector source types.")));if(o&&typeof t.id!="string"&&typeof t.id!="number")return void this.fire(new i.z(new Error("A feature id is required to remove its specific state property.")));let E=this.getOwnSourceCaches(h);for(let T of E)T.removeFeatureState(v,t.id,o)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let _;if("featuresetId"in t.target){let{featuresetId:v,importId:E}=t.target,T=this.getFragmentStyle(E),C=T.getFeaturesetLayers(v);for(let{source:M,sourceLayer:O}of C){let P=T.getFeatureState({id:t.id,source:M,sourceLayer:O});if(P&&!_)_=P;else if(!i.bv(_,P))return void this.fire(new i.z(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){let{layerId:v}=t.target,E=this.getLayer(v);_=this.getFeatureState({id:t.id,source:E.source,sourceLayer:E.sourceLayer})}return _}let o=t.source,h=t.sourceLayer,m=this._checkSource(o);if(m){if(m.type!=="vector"||h)return t.id===void 0&&this.fire(new i.z(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(o)[0].getFeatureState(h,t.id);this.fire(new i.z(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=i.h({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return i.h({},this.stylesheet.transition)}serialize(){this._checkLoaded();let t=this.getTerrain(),o=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return i.dc({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:o,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},h=>h!==void 0)}_updateFilteredLayers(t){for(let o of Object.values(this._mergedLayers))t(o)&&this._updateLayer(o)}_updateLayer(t){this._changes.updateLayer(t);let o=this.getLayerSourceCache(t),h=i.C(t.source,t.scope),m=this._changes.getUpdatedSourceCaches();t.source&&!m[h]&&o&&o.getSource().type!=="raster"&&(this._changes.updateSourceCache(h,"reload"),o.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){let o=E=>this._mergedLayers[E].is3D(!!this.terrain),h=this.order,m={},_=[];for(let E=h.length-1;E>=0;E--){let T=h[E];if(o(T)){m[T]=E;for(let C of t){let M=C[T];if(M)for(let O of M)_.push(O)}}}_.sort((E,T)=>T.intersectionZ-E.intersectionZ);let v=[];for(let E=h.length-1;E>=0;E--){let T=h[E];if(o(T))for(let C=_.length-1;C>=0;C--){let M=_[C].feature;if(M.layer&&m[M.layer.id]<E)break;v.push(M),_.pop()}else for(let C of t){let M=C[T];if(M)for(let O of M)v.push(O.feature)}}return v}queryRenderedFeatures(t,o,h){let m;o&&!Array.isArray(o)&&o.filter&&(this._validate(Ae,"queryRenderedFeatures.filter",o.filter,null,o),m=i.b3(o.filter));let _={},v=M=>{if(vd.has(M.type))return;let O=this.getOwnLayerSourceCache(M),P=_[O.id]=_[O.id]||{sourceCache:O,layers:{},has3DLayers:!1};M.is3D(!!this.terrain)&&(P.has3DLayers=!0),P.layers[M.fqid]=P.layers[M.fqid]||{styleLayer:M,targets:[]},P.layers[M.fqid].targets.push({filter:m})};if(o&&o.layers){if(!Array.isArray(o.layers))return this.fire(new i.z(new Error("parameters.layers must be an Array."))),[];for(let M of o.layers){let O=this._layers[M];if(!O)return this.fire(new i.z(new Error(`The layer '${M}' does not exist in the map's style and cannot be queried for features.`))),[];v(O)}}else for(let M in this._layers)v(this._layers[M]);let E=this._queryRenderedFeatures(t,_,h),T=this._flattenAndSortRenderedFeatures(E),C=[];for(let M of T)i.dd(M.layer.id)===this.scope&&C.push(M);return C}queryRenderedFeatureset(t,o,h){let m;o&&!Array.isArray(o)&&o.filter&&(this._validate(Ae,"queryRenderedFeatures.filter",o.filter,null,o),m=i.b3(o.filter));let _="mock",v=[];if(o&&o.target)v.push(Object.assign({},o,{targetId:_,filter:m}));else{let M=this.getFeaturesetDescriptors();for(let O of M)v.push({targetId:_,filter:m,target:O});for(let{style:O}of this.fragments){let P=O.getFeaturesetDescriptors();for(let k of P)v.push({targetId:_,filter:m,target:k})}}let E=this.queryRenderedTargets(t,v,h),T=[],C=new Set;for(let M of E)for(let O of M.variants[_])sd(O,M,C)||T.push(new i.de(M,O));return T}queryRenderedTargets(t,o,h){let m={},_=(E,T,C,M)=>{let O=m[T.id]=m[T.id]||{sourceCache:T,layers:{},has3DLayers:!1};if(O.layers[E.fqid]=O.layers[E.fqid]||{styleLayer:E,targets:[]},E.is3D(!!this.terrain)&&(O.has3DLayers=!0),!M)return C.uniqueFeatureID=!1,void O.layers[E.fqid].targets.push(C);O.layers[E.fqid].targets.push(Object.assign({},C,{namespace:M.namespace,properties:M.properties,uniqueFeatureID:M.uniqueFeatureID}))};for(let E of o)if("featuresetId"in E.target){let{featuresetId:T,importId:C}=E.target,M=this.getFragmentStyle(C);if(!M||!M._featuresetSelectors)continue;let O=M._featuresetSelectors[T];if(!O){this.fire(new i.z(new Error(`The featureset '${T}' does not exist in the map's style and cannot be queried for features.`)));continue}for(let P of O){let k=M.getOwnLayer(P.layerId);k&&!vd.has(k.type)&&_(k,M.getOwnLayerSourceCache(k),E,P)}}else if("layerId"in E.target){let{layerId:T}=E.target,C=this.getLayer(T);if(!C||vd.has(C.type))continue;_(C,this.getLayerSourceCache(C),E)}let v=this._queryRenderedFeatures(t,m,h);return this._flattenAndSortRenderedFeatures(v)}_queryRenderedFeatures(t,o,h){let m=[],_=!!this.map._showQueryGeometry,v=yn.createFromScreenPoints(t,h);for(let E in o){let T=ad(v,o[E],this._availableImages,h,_);Object.keys(T).length&&m.push(T)}if(this.placement)for(let E in o){if(!o[E].sourceCache._onlySymbols)continue;let T=rl(v.screenGeometry,o[E],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(T).length&&m.push(T)}return m}querySourceFeatures(t,o){let h=o&&o.filter;h&&this._validate(Ae,"querySourceFeatures.filter",h,null,o);let m=[],_=this.getOwnSourceCaches(t);for(let v of _)m=m.concat(Eu(v,o));return m}addSourceType(t,o,h){return Tr.getSourceType(t)?h(new Error(`A source type called "${t}" already exists.`)):(Tr.setSourceType(t,o),o.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:o.workerSourceURL},h):h(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,o,h={}){this._checkLoaded();let m=this.light.getLight(),_=!1;for(let E in t)if(!i.bv(t[E],m[E])){_=!0;break}if(!_)return;let v=this._getTransitionParameters();this.light.setLight(t,o,h),this.light.updateTransitions(v)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=i.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&i.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,o=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),o===0&&delete this.terrain,t===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let h=t,m=t.source==null;if(o===1){if(this.disableElevatedTerrain)return;if(typeof h.source=="object"){let E="terrain-dem-src";this.addSource(E,h.source),h=i.d6(h),h=i.h(h,{source:E})}let _=i.h({},h),v={};if(this.terrain&&m){_.source=this.terrain.get().source;let E=this.terrain?this.getFragmentStyle(this.terrain.scope):null;E&&(v.style=E.serialize())}if(this._validate(ot,"terrain",_,v))return}if(!this.terrain||this.terrain.scope!==this.scope&&!m||this.terrain&&o!==this.terrain.drapeRenderMode){if(!h)return;this._createTerrain(h,o),this.fire(new i.A("data",{dataType:"style"}))}else{let _=this.terrain,v=_.get();for(let E of Object.keys(i.a5.terrain))!h.hasOwnProperty(E)&&i.a5.terrain[E].default&&(h[E]=i.a5.terrain[E].default);for(let E in t)if(!i.bv(t[E],v[E])){_.set(t,this.options),this.stylesheet.terrain=t;let T=this._getTransitionParameters({duration:0});_.updateTransitions(T),this.fire(new i.A("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){let o=this.fog=new Vt(t,this.map.transform,this.scope,this.options);this.stylesheet.fog=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}_createSnow(t){let o=this.snow=new li(t,this.map.transform,this.scope,this.options);this.stylesheet.snow=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}_createRain(t){let o=this.rain=new ci(t,this.map.transform,this.scope,this.options);this.stylesheet.rain=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(let t of this.map._markers)t._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){let o=this.fog;if(!i.bv(o.get(),t)){o.set(t,this.options),this.stylesheet.fog=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){let o=this.snow;if(!i.bv(o.get(),t)){o.set(t,this.options),this.stylesheet.snow=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){let o=this.rain;if(!i.bv(o.get(),t)){o.set(t,this.options),this.stylesheet.rain=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){let t=()=>{for(let m in this._layers)this._layers[m].lut=this._styleColorTheme.lut;for(let m in this._sourceCaches)this._sourceCaches[m].clearTiles()},o=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!o)return this._styleColorTheme.lut=null,void t();let h=this._evaluateColorThemeData(o);this._loadColorTheme(h).then(()=>{this.fire(new i.A("colorthemeset")),t()}).catch(m=>{i.w(`Couldn't set color theme: ${m}`)})}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&i.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(t,o){let h=this.getFragmentStyle(t);h&&(h._styleColorTheme.colorThemeOverride=o,h._reloadColorTheme())}_getTransitionParameters(t){return{now:i.q.now(),transition:i.h(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;let t=[],o=[];for(let h of this._mergedOrder)this.isLayerDraped(this._mergedLayers[h])?t.push(h):o.push(h);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...o)}_createTerrain(t,o){let h=this.terrain=new ve(t,o,this.scope,this.options,this.map.getWorldview());o===1&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();let m=this._getTransitionParameters({duration:0});h.updateTransitions(m)}_force3DLayerUpdate(){for(let t in this._layers){let o=this._layers[t];o.type==="fill-extrusion"&&this._updateLayer(o)}}_forceSymbolLayerUpdate(){for(let t in this._layers){let o=this._layers[t];o.type==="symbol"&&this._updateLayer(o)}}_validate(t,o,h,m,_={}){if(_&&_.validate===!1)return!1;let v=i.h({},this.serialize());return ml(this,t.call(oo,i.h({key:o,style:v,value:h,styleSpec:i.a5},m)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),i.df.off("pluginStateChange",this._rtlTextPluginCallback);for(let t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(let t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(t){let o=this.getSourceCaches(t);for(let h of o)h.clearTiles()}clearSources(){for(let t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}reloadSource(t){let o=this.getSourceCaches(t);for(let h of o)h.resume(),h.reload()}reloadSources(){for(let t of this.getSources())t.reload&&t.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(t=>{t.modelManager.reloadModels(t.scope)})}updateSources(t){let o;this.directionalLight&&(o=cc(this.directionalLight));let h=new Set;for(let m in this._mergedLayers){let _=this._mergedLayers[m];_.hasElevation()&&!h.has(_.source)&&h.add(_.source)}for(let m in this._mergedSourceCaches){let _=this._mergedSourceCaches[m],v=h.has(_._source.id);_.update(t,void 0,void 0,o,v)}}_generateCollisionBoxes(){for(let t in this._sourceCaches){let o=this._sourceCaches[t];o.resume(),o.reload()}}_updatePlacement(t,o,h,m,_,v,E=!1){let T=!1,C=!1,M={},O={};for(let P of this._mergedOrder){let k=this._mergedLayers[P];if(k.type!=="symbol")continue;let j=i.C(k.source,k.scope),B=M[j];if(!B){let q=this.getLayerSourceCache(k);if(!q)continue;let Z=q.getRenderableIds(!0).map(ee=>q.getTileByID(ee));O[j]=Z.slice(),B=M[j]=Z.sort((ee,re)=>re.tileID.overscaledZ-ee.tileID.overscaledZ||(ee.tileID.isLessThan(re.tileID)?-1:1))}let U=this.crossTileSymbolIndex.addLayer(k,B,o.center.lng,o.projection);T=T||U}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),E=E||this._layerOrderChanged||m===0,this._layerOrderChanged&&this.fire(new i.A("neworder")),(E||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(i.q.now(),o.zoom))&&(this.pauseablePlacement=new gd(o,this._mergedOrder,E,h,m,_,this.placement,this.fog&&o.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,M,O,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(i.q.now()),C=!0),T&&this.pauseablePlacement.placement.setStale()),C||T){this._buildingIndex.onNewFrame(o.zoom);for(let P=0;P<this._mergedOrder.length;P++){let k=this._mergedLayers[this._mergedOrder[P]];if(k.type!=="symbol")continue;let j=this.isLayerClipped(k);this.placement.updateLayerOpacities(k,M[i.C(k.source,k.scope)],P,j?v:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(i.q.now())}}_releaseSymbolFadeTiles(){for(let t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t,o){this._checkLoaded();let h=this.stylesheet.imports=this.stylesheet.imports||[];if(h.findIndex(({id:_})=>_===t.id)!==-1)return void this.fire(new i.z(new Error(`Import with id '${t.id}' already exists in the map's style.`)));if(!o)return h.push(t),this._loadImports([t],!0);let m=h.findIndex(({id:_})=>_===o);return m===-1&&this.fire(new i.z(new Error(`Import with id "${o}" does not exist on this map.`))),this.stylesheet.imports=h.slice(0,m).concat(t).concat(h.slice(m)),this._loadImports([t],!0,o)}updateImport(t,o){this._checkLoaded();let h=this.stylesheet.imports||[],m=this.getImportIndex(t);return m===-1?this:typeof o=="string"?(this.setImportUrl(t,o),this):(o.url&&o.url!==h[m].url&&this.setImportUrl(t,o.url),i.bv(o.config,h[m].config)||this.setImportConfig(t,o.config,o.data.schema),i.bv(o.data,h[m].data)||this.setImportData(t,o.data),this)}moveImport(t,o){this._checkLoaded();let h=this.stylesheet.imports||[],m=this.getImportIndex(t);if(m===-1)return this;let _=this.getImportIndex(o);if(_===-1)return this;let v=h[m],E=this.fragments[m];return h=h.filter(({id:T})=>T!==t),this.fragments=this.fragments.filter(({id:T})=>T!==t),this.stylesheet.imports=h.slice(0,_).concat(v).concat(h.slice(_)),this.fragments=this.fragments.slice(0,_).concat(E).concat(this.fragments.slice(_)),this.mergeLayers(),this}setImportUrl(t,o){this._checkLoaded();let h=this.stylesheet.imports||[],m=this.getImportIndex(t);if(m===-1)return this;h[m].url=o;let _=this.fragments[m];return _.style=this._createFragmentStyle(h[m]),_.style.on("style.import.load",()=>this.mergeAll()),_.style.loadURL(o),this}setImportData(t,o){this._checkLoaded();let h=this.getImportIndex(t),m=this.stylesheet.imports||[];return h===-1?this:o?(this.fragments[h].style.setState(o),this._reloadImports(),this):(delete m[h].data,this.setImportUrl(t,m[h].url))}setImportConfig(t,o,h){this._checkLoaded();let m=this.getImportIndex(t),_=this.stylesheet.imports||[];if(m===-1)return this;o?_[m].config=o:delete _[m].config;let v=this.fragments[m];h&&v.style.stylesheet&&(v.style.stylesheet.schema=h);let E=v.style.stylesheet&&v.style.stylesheet.schema;return v.config=o,v.style.updateConfig(o,E),this.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();let o=this.stylesheet.imports||[],h=this.getImportIndex(t);h!==-1&&(o.splice(h,1),this.fragments[h].style._remove(),this.fragments.splice(h,1),this._reloadImports())}getImportIndex(t){let o=(this.stylesheet.imports||[]).findIndex(h=>h.id===t);return o===-1&&this.fire(new i.z(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),o}getLayer(t){return this._mergedLayers[t]}getSources(){let t=[];for(let o in this._mergedOtherSourceCaches){let h=this._mergedOtherSourceCaches[o];h&&t.push(h.getSource())}return t}getSource(t,o){let h=this.getSourceCache(t,o);return h&&h.getSource()}getLayerSource(t){let o=this.getLayerSourceCache(t);return o&&o.getSource()}getSourceCache(t,o){let h=i.C(t,o);return this._mergedOtherSourceCaches[h]}getLayerSourceCache(t){let o=i.C(t.source,t.scope);return t.type==="symbol"?this._mergedSymbolSourceCaches[o]:this._mergedOtherSourceCaches[o]}getSourceCaches(t){if(t==null)return Object.values(this._mergedSourceCaches);let o=[];return this._mergedOtherSourceCaches[t]&&o.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&o.push(this._mergedSymbolSourceCaches[t]),o}updateSourceCaches(){let t=this._changes.getUpdatedSourceCaches();for(let o in t){let h=t[o];h==="reload"?this.reloadSource(o):h==="clear"&&this.clearSource(o)}}updateLayers(t){let o=this._changes.getUpdatedPaintProperties();for(let h of o){let m=this.getLayer(h);m&&m.updateTransitions(t)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(t){this.stylesheet.glyphs=t,this.glyphManager.setURL(t,this.scope)}getImages(t,o,h){this.imageManager.getImages(o.images,o.scope,h),this._updateTilesForChangedImages();let m=v=>{if(v){let E=o.images.map(T=>i.I.toString(T));v.setDependencies(o.tileID.key,o.type,E)}},_=i.C(o.source,o.scope);m(this._mergedOtherSourceCaches[_]),m(this._mergedSymbolSourceCaches[_])}rasterizeImages(t,o,h){this.imageManager.rasterizeImages(o,h)}getGlyphs(t,o,h){this.glyphManager.getGlyphs(o.stacks,o.scope,h)}getResource(t,o,h){return i.dg(o,h)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return t.type==="symbol"?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){let o=[];return this._otherSourceCaches[t]&&o.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&o.push(this._symbolSourceCaches[t]),o}_isSourceCacheLoaded(t){let o=this.getOwnSourceCaches(t);return o.length===0?(this.fire(new i.z(new Error(`There is no source with ID '${t}'`))),!1):o.every(h=>h.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(t,o){if(!this._clipLayerPresent&&t.type!=="fill-extrusion"&&t.type!=="building")return!1;let h=t.type==="fill-extrusion"&&t.sourceLayer==="building",m=t.type==="building";if(t.is3D(!!this.terrain)){if(h||m||o&&o.type==="batched-model"||t.type==="model")return!0}else if(t.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(t=>{t.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Tr.getSourceType=function(u){return od[u]},Tr.setSourceType=function(u,t){od[u]=t},Tr.registerForPluginStateChange=i.dh;var Bu=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,Wp=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color,float height) {
#ifdef INDICATOR_CUTOUT
float verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,Zp=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}`,hc="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",dc=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif//DEPTH_OCCLUSION`,Xp=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,xd=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,bo=`#ifdef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,bd=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,at=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,Yp=`#ifdef RENDER_SHADOWS
precision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);return texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;
#ifdef SHADOWS_SINGLE_CASCADE
vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);
#else
light_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)
{highp vec2 biasUV=vec2(
pos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;let fc=[];No(Bu,fc),No(Zp,fc),No(Wp,fc);let pc={"_prelude_fog.vertex.glsl":Xp,"_prelude_terrain.vertex.glsl":dc,"_prelude_shadow.vertex.glsl":at,"_prelude_fog.fragment.glsl":xd,"_prelude_shadow.fragment.glsl":Yp,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":bo,"_prelude_raster_particle.glsl":bd},Vu={};un("",dc),un(xd,Xp),un(Yp,at),un(bo,""),un(bd,"");let ju=un(Wp,Zp),ms=Bu;var wd={background:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),building:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in highp vec3 v_normal;in highp float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
uniform lowp float u_opacity;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 apply_lighting_linear(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec4 color=vec4(v_color.rgb,1.0);vec3 normal=normalize(v_normal);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;
#ifdef RENDER_SHADOWS
shadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
shadowed_lighting_factor=dot(normal,u_lighting_directional_dir);
#endif
color.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=mix(color.rgb,v_color.rgb,v_color.a);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_height));
#endif
color.rgb=linearTosRGB(color.rgb);color*=u_opacity;
#ifdef RENDER_CUTOFF
color*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_height);
#endif
glFragColor=color; 
#ifdef DEBUG_SHOW_NORMALS
color.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;in vec3 a_normal_3f;out vec4 v_color;out highp vec3 v_normal;out highp float v_height;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));vec3 pos=a_pos_3f;v_height=pos.z;gl_Position=u_matrix*vec4(pos,1.0);
#ifdef RENDER_SHADOWS
vec3 shadow_pos=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);v_depth_shadows=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),buildingDepth:un(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,"in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? 
smoothstep(0.0,-antialiased_blur,1.0-extrude_length) : 
smoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
#ifdef ELEVATED_ROADS
in float a_circle_z_offset;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
#ifdef ELEVATED_ROADS
world_center.z+=a_circle_z_offset+ELEVATION_BIAS;
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:un("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:un(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:un(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:un("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:un("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:un("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),elevatedStructuresDepth:un(`void main() {
#ifndef DEPTH_TEXTURE
glFragColor=vec4(0.);
#endif
}`,"in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:un(`#ifdef DEPTH_RECONSTRUCTION
in float v_height;
#endif
void main() {
#ifdef DEPTH_RECONSTRUCTION
if (v_height >=0.0)
discard;
#endif
glFragColor=vec4(1.0,0.0,0.0,1.0);}`,`in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;
#ifdef DEPTH_RECONSTRUCTION
out float v_height;
#endif
void main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);
#ifdef DEPTH_RECONSTRUCTION
if (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;
#endif
gl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}`),elevatedStructures:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in vec3 v_normal;in float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;
#endif
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)
{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
vec3 color=structure_color.xyz;
#ifdef LIGHTING_3D_MODE
vec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);
#ifdef RENDER_SHADOWS
float shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);
#else
color=apply_lighting(color,transformed_normal);
#endif
color=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}
#endif
#ifdef FOG
color=fog_apply(color,v_fog_pos);
#endif
vec4 out_color=vec4(color,1.0);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_height);
#endif
glFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fill:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=opacity;
#ifdef INDICATOR_CUTOUT
if (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=z_offset;
#endif
}`),fillOutline:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,h);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=cutoff_opacity(u_cutoff_params,ground.z);if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:un(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,height);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:un(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:un(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:un(`precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)
in vec3 a_z_offset_width;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec3 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;
#ifdef VARIABLE_LINE_WIDTH
float left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;
#else
halfwidth=(u_width_scale*width)/2.0;
#endif
offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
highp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);
#else
v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),linePattern:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;
#ifdef LINE_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
uniform float u_emissive_strength;
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LINE_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}
#endif
#ifdef LINE_JOIN_NONE
highp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_with_emission_ground(color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_z_offset);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in vec3 a_z_offset_width;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);
#ifdef LINE_JOIN_NONE
v_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),raster:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:un("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:un("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:un(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:un(`#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#else
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
in highp float v_z_offset;
#endif
#endif
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#endif
#endif
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef ELEVATED_ROADS
in vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#else
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
out highp float v_z_offset;
#endif
#endif
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
#ifdef PROJECTED_POS_ON_VIEWPORT
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);
#else
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    
#endif
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;
#else
z+=u_pitch_with_map ? z_offset : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
#ifdef ELEVATED_ROADS
vec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
pos=vec3(projected_pos.xy/projected_pos.w+offset,z);
#endif
#endif
gl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
vec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=e;
#else
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
v_z_offset=e;
#endif
#endif
#endif
}`),terrainRaster:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:un("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:un(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,hc),skyboxGradient:un(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,hc),skyboxCapture:un(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:un(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:un(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor,v_position_height.w);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:un(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:un(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),snowParticle:un("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; 
uniform float u_horizontalOscillationRate; 
uniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}`),rainParticle:un("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity; 
uniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; 
pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}`),vignette:un("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:un("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function No(u,t){let o=u.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let h of o)if(h=h.trim(),h[0]==="#"&&h.includes("if")&&!h.includes("endif")){h=h.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();let m=h.split(" ");for(let _ of m)t.includes(_)||t.push(_)}}function un(u,t){let o=/#include\s+"([^"]+)"/g,h=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,m=t.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);m&&(m=m.map(C=>{let M=C.split(" ");return M[M.length-1]}),m=[...new Set(m)]);let _={},v=[],E=[];if(u=u.replace(o,(C,M)=>(E.push(M),"")),(t=t.replace(o,(C,M)=>(v.push(M),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let T=[...fc];No(u,T),No(t,T);for(let C of[...v,...E])pc[C]||console.error(`Undefined include: ${C}`),Vu[C]||(Vu[C]=[],No(pc[C],Vu[C])),T=[...T,...Vu[C]];return{fragmentSource:u=u.replace(h,(C,M,O,P,k)=>(_[k]=!0,M==="define"?`
#ifndef HAS_UNIFORM_u_${k}
in ${O} ${P} ${k};
#else
uniform ${O} ${P} u_${k};
#endif
`:M==="initialize"?`
#ifdef HAS_UNIFORM_u_${k}
    ${O} ${P} ${k} = u_${k};
#endif
`:M==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${k}
    in ${O} ${P} ${k};
#endif
`:M==="initialize-attribute"?"":void 0)),vertexSource:t=t.replace(h,(C,M,O,P,k)=>{let j=P==="float"?"vec2":P,B=k.match(/color/)?"color":j;return M==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${k}
in ${O} ${P} a_${k};
#endif
`:_[k]?M==="define"?`
#ifndef HAS_UNIFORM_u_${k}
uniform lowp float u_${k}_t;
in ${O} ${j} a_${k};
out ${O} ${P} ${k};
#else
uniform ${O} ${P} u_${k};
#endif
`:M==="initialize"?B==="vec4"?`
#ifndef HAS_UNIFORM_u_${k}
    ${k} = a_${k};
#else
    ${O} ${P} ${k} = u_${k};
#endif
`:`
#ifndef HAS_UNIFORM_u_${k}
    ${k} = unpack_mix_${B}(a_${k}, u_${k}_t);
#else
    ${O} ${P} ${k} = u_${k};
#endif
`:M==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${k}
    in ${O} ${P} a_${k};
    out ${O} ${P} ${k};
#endif
`:M==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${k}
    ${k} = a_${k};
#endif
`:void 0:M==="define"?`
#ifndef HAS_UNIFORM_u_${k}
uniform lowp float u_${k}_t;
in ${O} ${j} a_${k};
#else
uniform ${O} ${P} u_${k};
#endif
`:M==="define-instanced"?B==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${k}0;
in vec4 a_${k}1;
in vec4 a_${k}2;
in vec4 a_${k}3;
#else
uniform ${O} ${P} u_${k};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${O} ${j} a_${k};
#else
uniform ${O} ${P} u_${k};
#endif
`:M==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${k}
    ${O} ${P} ${k} = a_${k};
#endif
`:B==="vec4"?`
#ifndef HAS_UNIFORM_u_${k}
    ${O} ${P} ${k} = a_${k};
#else
    ${O} ${P} ${k} = u_${k};
#endif
`:`
#ifndef HAS_UNIFORM_u_${k}
    ${O} ${P} ${k} = unpack_mix_${B}(a_${k}, u_${k}_t);
#else
    ${O} ${P} ${k} = u_${k};
#endif
`}),staticAttributes:m,usedDefines:T,vertexIncludes:v,fragmentIncludes:E}}class mc{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,o,h,m,_,v,E,T){this.context=t;let C=this.boundPaintVertexBuffers.length!==m.length;for(let O=0;!C&&O<m.length;O++)this.boundPaintVertexBuffers[O]!==m[O]&&(C=!0);let M=this.boundDynamicVertexBuffers.length!==E.length;for(let O=0;!M&&O<E.length;O++)this.boundDynamicVertexBuffers[O]!==E[O]&&(M=!0);if(!this.vao||this.boundProgram!==o||this.boundLayoutVertexBuffer!==h||C||M||this.boundIndexBuffer!==_||this.boundVertexOffset!==v)this.freshBind(o,h,m,_,v,E,T);else{t.bindVertexArrayOES.set(this.vao);for(let O of E)O&&(O.bind(),T&&O.instanceCount&&O.setVertexAttribDivisor(t.gl,o,T));_&&_.dynamicDraw&&_.bind()}}freshBind(t,o,h,m,_,v,E){let T=t.numAttributes,C=this.context,M=C.gl;this.vao&&this.destroy(),this.vao=C.gl.createVertexArray(),C.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=o,this.boundPaintVertexBuffers=h,this.boundIndexBuffer=m,this.boundVertexOffset=_,this.boundDynamicVertexBuffers=v,o.enableAttributes(M,t),o.bind(),o.setVertexAttribPointers(M,t,_);for(let O of h)O.enableAttributes(M,t),O.bind(),O.setVertexAttribPointers(M,t,_);for(let O of v)O&&(O.enableAttributes(M,t),O.bind(),O.setVertexAttribPointers(M,t,_),E&&O.instanceCount&&O.setVertexAttribDivisor(M,t,E));m&&m.bind(),C.currentNumAttributes=T}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function Ob(u,t){let o=Math.pow(2,t.canonical.z),h=t.canonical.y;return[new i.ac(0,h/o).toLngLat().lat,new i.ac(0,(h+1)/o).toLngLat().lat]}function kb(u,t,o,h,m,_,v){let E=u.context,T=E.gl,C=o.hillshadeFBO;if(!C)return;u.prepareDrawTile();let M=u.isTileAffectedByFog(t),O=u.getOrCreateProgram("hillshade",{overrideFog:M});E.activeTexture.set(T.TEXTURE0),T.bindTexture(T.TEXTURE_2D,C.colorAttachment.get());let P=((U,q,Z,ee)=>{let re=Z.paint.get("hillshade-shadow-color"),ue=Z.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",le=Z.paint.get("hillshade-highlight-color"),se=Z.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",oe=Z.paint.get("hillshade-accent-color"),he=Z.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",fe=Z.paint.get("hillshade-emissive-strength"),Te=i.al(Z.paint.get("hillshade-illumination-direction"));if(Z.paint.get("hillshade-illumination-anchor")==="viewport")Te-=U.transform.angle;else if(U.style&&U.style.enable3dLights()&&U.style.directionalLight){let Be=U.style.directionalLight.properties.get("direction"),Ve=i.cR(Be.x,Be.y,Be.z);Te=i.al(Ve[1])}let Ie=!U.options.moving;return{u_matrix:ee||U.transform.calculateProjMatrix(q.tileID.toUnwrapped(),Ie),u_image:0,u_latrange:Ob(0,q.tileID),u_light:[Z.paint.get("hillshade-exaggeration"),Te],u_shadow:re.toPremultipliedRenderColor(ue?null:Z.lut),u_highlight:le.toPremultipliedRenderColor(se?null:Z.lut),u_emissive_strength:fe,u_accent:oe.toPremultipliedRenderColor(he?null:Z.lut)}})(u,o,h,u.terrain?t.projMatrix:null);u.uploadCommonUniforms(E,O,t.toUnwrapped());let{tileBoundsBuffer:k,tileBoundsIndexBuffer:j,tileBoundsSegments:B}=u.getTileBoundsBuffers(o);O.draw(u,T.TRIANGLES,m,_,v,Pt.disabled,P,h.id,k,j,B)}function Ed(u,t,o){if(!t.needsDEMTextureUpload)return;let h=u.context,m=h.gl;h.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||u.getTileTexture(o.stride);let _=o.getPixels();t.demTexture?t.demTexture.update(_,{premultiply:!1}):t.demTexture=new i.T(h,_,m.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function Fb(u,t,o){let h=u.context,m=h.gl;if(!t.dem)return;let _=t.dem;if(h.activeTexture.set(m.TEXTURE1),Ed(u,t,_),!t.demTexture)return;t.demTexture.bind(m.NEAREST,m.CLAMP_TO_EDGE);let v=_.dim;h.activeTexture.set(m.TEXTURE0);let E=t.hillshadeFBO;if(!E){let P=new i.T(h,{width:v,height:v,data:null},m.RGBA8);P.bind(m.LINEAR,m.CLAMP_TO_EDGE),E=t.hillshadeFBO=h.createFramebuffer(v,v,!0,"renderbuffer"),E.colorAttachment.set(P.texture)}h.bindFramebuffer.set(E.framebuffer),h.viewport.set([0,0,v,v]);let{tileBoundsBuffer:T,tileBoundsIndexBuffer:C,tileBoundsSegments:M}=u.getMercatorTileBoundsBuffers(),O=[];u.linearFloatFilteringSupported()&&O.push("TERRAIN_DEM_FLOAT_FORMAT"),u.getOrCreateProgram("hillshadePrepare",{defines:O}).draw(u,m.TRIANGLES,ft.disabled,Bt.disabled,en.unblended,Pt.disabled,((P,k)=>{let j=k.stride,B=i.bz();return i.c5(B,0,i.aj,-8192,0,0,1),i.bo(B,B,[0,-8192,0]),{u_matrix:B,u_image:1,u_dimension:[j,j],u_zoom:P.overscaledZ}})(t.tileID,_),o.id,T,C,M),t.needsHillshadePrepare=!1}class yi{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Z_ extends yi{getDefault(){return i.am.transparent.toNonPremultipliedRenderColor(null)}set(t){let o=this.current;(t.r!==o.r||t.g!==o.g||t.b!==o.b||t.a!==o.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Kp extends yi{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class Nb extends yi{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class zb extends yi{getDefault(){return[!0,!0,!0,!0]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Bb extends yi{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class Vb extends yi{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class X_ extends yi{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){let o=this.current;(t.func!==o.func||t.ref!==o.ref||t.mask!==o.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class jb extends yi{getDefault(){let t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class Td extends yi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.STENCIL_TEST):o.disable(o.STENCIL_TEST),this.current=t,this.dirty=!1}}class Ub extends yi{getDefault(){return[0,1]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class Y_ extends yi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),this.current=t,this.dirty=!1}}class Jp extends yi{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class Id extends yi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.BLEND):o.disable(o.BLEND),this.current=t,this.dirty=!1}}class Qp extends yi{getDefault(){let t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class gl extends yi{getDefault(){return i.am.transparent.toNonPremultipliedRenderColor(null)}set(t){let o=this.current;(t.r!==o.r||t.g!==o.g||t.b!==o.b||t.a!==o.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class gc extends yi{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class Sd extends yi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.CULL_FACE):o.disable(o.CULL_FACE),this.current=t,this.dirty=!1}}class Dd extends yi{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class _c extends yi{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let K_=class extends yi{getDefault(){return null}set(u){(u!==this.current||this.dirty)&&(this.gl.useProgram(u),this.current=u,this.dirty=!1)}};class em extends yi{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class J_ extends yi{getDefault(){let t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class yc extends yi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindFramebuffer(o.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class Cd extends yi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindRenderbuffer(o.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Md extends yi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindTexture(o.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class tm extends yi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindBuffer(o.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Ad extends yi{getDefault(){return null}set(t){let o=this.gl;o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Uu extends yi{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class Q_ extends yi{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.pixelStorei(o.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class ey extends yi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class ty extends yi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class ba extends yi{constructor(t,o){super(t),this.context=t,this.parent=o}getDefault(){return null}}class ny extends ba{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let o=this.gl;o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class iy extends ba{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let o=this.gl;o.framebufferRenderbuffer(o.FRAMEBUFFER,this.attachment(),o.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Hb extends ba{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let o=this.gl;o.framebufferTexture2D(o.FRAMEBUFFER,this.attachment(),o.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class $b extends iy{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}let nm=(u,t,o)=>({u_matrix:u,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:o}),Rd=(u,t,o,h,m,_,v,E,T,C,M,O,P,k,j,B)=>({u_proj_matrix:Float32Array.from(u),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(h),u_merc_matrix:o,u_zoom_transition:m,u_merc_center:_,u_image0:0,u_frustum_tl:v,u_frustum_tr:E,u_frustum_br:T,u_frustum_bl:C,u_globe_pos:M,u_globe_radius:O,u_viewport:P,u_grid_matrix:B?Float32Array.from(B):new Float32Array(9),u_skirt_height:k,u_far_z_cutoff:j});function Pd(u,t){return u!=null&&t!=null&&!(!u.hasData()||!t.hasData())&&u.demTexture!=null&&t.demTexture!=null&&u.tileID.key!==t.tileID.key}let wa=new class{constructor(){this.operations={}}newMorphing(u,t,o,h,m){if(u in this.operations){let _=this.operations[u];_.to.tileID.key!==o.tileID.key&&(_.queued=o)}else this.operations[u]={startTime:h,phase:0,duration:m,from:t,to:o,queued:null}}getMorphValuesForProxy(u){if(!(u in this.operations))return null;let t=this.operations[u];return{from:t.from,to:t.to,phase:t.phase}}update(u){for(let t in this.operations){let o=this.operations[t];for(o.phase=(u-o.startTime)/o.duration;o.phase>=1||!this._validOp(o);)if(!this._nextOp(o,u)){delete this.operations[t];break}}}_nextOp(u,t){return!!u.queued&&(u.from=u.to,u.to=u.queued,u.queued=null,u.phase=0,u.startTime=t,!0)}_validOp(u){return u.from.hasData()&&u.to.hasData()}},im={0:null,1:"TERRAIN_VERTEX_MORPHING"};function rm(u,t,o){if(t===0)return 0;let h=t<1&&o===514?.25/t:1;return 6*Math.pow(1.5,22-u)*Math.max(t,1)*h}function Gb(u,t){let o=1<<u.z;return!t&&(u.x===0||u.x===o-1)||u.y===0||u.y===o-1}let _l=u=>({u_matrix:u});function yl(u,t,o,h,m){if(m>0){let _=i.q.now(),v=(_-u.timeAdded)/m,E=t?(_-t.timeAdded)/m:-1,T=o.getSource(),C=h.coveringZoomLevel({tileSize:T.tileSize,roundZoom:T.roundZoom}),M=!t||Math.abs(t.tileID.overscaledZ-C)>Math.abs(u.tileID.overscaledZ-C),O=M&&u.refreshedUponExpiration?1:i.ay(M?v:1-E,0,1);return u.refreshedUponExpiration&&v>=1&&(u.refreshedUponExpiration=!1),t?{opacity:1,mix:1-O}:{opacity:O,mix:0}}return{opacity:1,mix:0}}class ry extends Xr{constructor(t){let o={type:"raster-dem",maxzoom:t.transform.maxZoom},h=new i.D(i.c$(),null),m=bu("mock-dem",o,h,t.style);super("mock-dem",m,!1),m.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,o){t.state="loaded",o(null)}}class wo extends Xr{constructor(t){let o=bu("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},new i.D(i.c$(),null),t.style);super("proxy",o,!1),o.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,o,h){if(t.freezeTileCoverage)return;this.transform=t;let m=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((_,v)=>{if(_[v.key]="",!this._tiles[v.key]){let E=new ol(v,this._source.tileSize*v.overscaleFactor(),t.tileZoom,void 0,void 0,this._source.worldview);E.state="loaded",this._tiles[v.key]=E}return _},{});for(let _ in this._tiles)_ in m||(this.freeFBO(_),this._tiles[_].unloadVectorData(),delete this._tiles[_])}freeFBO(t){let o=this.proxyCachedFBO[t];if(o!==void 0){let h=Object.values(o);this.renderCachePool.push(...h),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach(t=>t.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Ld extends i.aM{constructor(t,o,h){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=o,this.projMatrix=h}}class Hu extends i.dt{constructor(t,o){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},t.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};let[h,m,_]=function(T){let C=new i.ba,M=new i.a_,O=131;C.reserve(17161),M.reserve(33800);let P=i.aj/128,k=i.aj+P/2,j=k+P;for(let U=-64;U<j;U+=P)for(let q=-64;q<j;q+=P){let Z=q<0||q>k||U<0||U>k?24575:0,ee=i.ay(Math.round(q),0,i.aj),re=i.ay(Math.round(U),0,i.aj);C.emplaceBack(ee+Z,re)}let B=(U,q)=>{let Z=q*O+U;M.emplaceBack(Z+1,Z,Z+O),M.emplaceBack(Z+O,Z+O+1,Z+1)};for(let U=1;U<129;U++)for(let q=1;q<129;q++)B(q,U);return[0,129].forEach(U=>{for(let q=0;q<130;q++)B(q,U),B(U,q)}),[C,M,32768]}(),v=t.context;this.gridBuffer=v.createVertexBuffer(h,i.bc.members),this.gridIndexBuffer=v.createIndexBuffer(m),this.gridSegments=i.bd.simpleSegment(0,0,h.length,m.length),this.gridNoSkirtSegments=i.bd.simpleSegment(0,0,h.length,_),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new wo(o.map),this.orthoMatrix=i.bz(),i.c5(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,i.aj,0,i.aj,0,1);let E=v.gl;this._overlapStencilMode=new Bt({func:E.GEQUAL,mask:255},0,255,E.KEEP,E.KEEP,E.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=o,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new ry(o.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(t,o,h){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);let m=t.terrain.properties,_=t.terrain.drapeRenderMode===0,v=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=i.q.now();let E=t.terrain&&t.terrain.scope,T=m.get("source"),C=_?this._mockSourceCache:t.getSourceCache(T,E);if(!C)return void i.w(`Couldn't find terrain source "${T}".`);if(this.sourceCache=C,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=v?this.calculateExaggeration(o):m.get("exaggeration"),!o.projection.requiresDraping&&v&&this._exaggeration===0)return void this._disable();this.enabled=!0;let M=()=>{this.sourceCache.used&&i.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);let O=this.getScaledDemTileSize();this.sourceCache.update(o,O,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,M(),this._initializing=!0),M(),o.updateElevation(!0,h),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(o),this._emptyDEMTextureDirty=!0,this._previousZoom=o.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);let o=this._previousCameraAltitude,h=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=h;let m=o!=null?h-o:Number.MAX_VALUE;if(Math.abs(m)<2)return this._exaggeration;let _=t.zoom,v=this._style.terrain;if(!this._previousUpdateTimestamp)return v.getExaggeration(_);let E=_-this._previousZoom,T=this._previousUpdateTimestamp,C=_;this._evaluationZoom!=null&&(C=this._evaluationZoom,Math.abs(_-C)>.5&&(E=.5*(_-C+E)),E*m<0&&(C+=E)),this._evaluationZoom=C;let M=v.getExaggeration(C),O=M===v.getExaggeration(Math.max(0,C-.1));if(O&&Math.abs(M-this._exaggeration)<.01)return M;let P=Math.min(.1,.00375*(this._updateTimestamp-T));return(O||M<.1||Math.abs(E)<1e-4)&&(P=Math.min(.2,4*P)),i.ai(this._exaggeration,M,P)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.coord&&t.dataType==="source"?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):t.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(let t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(t=>t.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){let t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;let o=this.proxySourceCache,h=this.painter.transform;this._initializing&&(this._initializing=h._centerAltitude===0&&this.getAtPointOrZero(i.ac.fromLngLat(h.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);let m=this.proxyCoords=o.getIds().map(T=>{let C=o.getTileByID(T).tileID;return C.projMatrix=h.calculateProjMatrix(C.toUnwrapped()),C});(function(T,C){let M=C.transform.pointCoordinate(C.transform.getCameraPoint()),O=new i.P(M.x,M.y);T.sort((P,k)=>{if(k.overscaledZ-P.overscaledZ)return k.overscaledZ-P.overscaledZ;let j=new i.P(P.canonical.x+(1<<P.canonical.z)*P.wrap,P.canonical.y),B=new i.P(k.canonical.x+(1<<k.canonical.z)*k.wrap,k.canonical.y),U=O.mult(1<<P.canonical.z);return U.x-=.5,U.y-=.5,U.distSqr(j)-U.distSqr(B)})})(m,this.painter);let _=this.proxyToSource||{};this.proxyToSource={},m.forEach(T=>{this.proxyToSource[T.key]={}}),this.terrainTileForTile={};let v=this._style._mergedSourceCaches;for(let T in v){let C=v[T];if(!C.used||(C!==this.sourceCache&&this.resetTileLookupCache(C.id),this._setupProxiedCoordsForOrtho(C,t[T],_),C.usedForTerrain))continue;let M=t[T];C.getSource().reparseOverscaled&&this._assignTerrainTiles(M)}this.proxiedCoords[o.id]=m.map(T=>new Ld(T,T.key,this.orthoMatrix)),this._assignTerrainTiles(m),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(_),this.renderingToTexture=!1;let E={};this._visibleDemTiles=[];for(let T of this.proxyCoords){let C=this.terrainTileForTile[T.key];if(!C)continue;let M=C.tileID.key;M in E||(this._visibleDemTiles.push(C),E[M]=M)}}_assignTerrainTiles(t){this._initializing||t.forEach(o=>{if(this.terrainTileForTile[o.key])return;let h=this._findTileCoveringTileID(o,this.sourceCache);h&&(this.terrainTileForTile[o.key]=h)})}_prepareDEMTextures(){let t=this.painter.context,o=t.gl;for(let h in this.terrainTileForTile){let m=this.terrainTileForTile[h],_=m.dem;!_||m.demTexture&&!m.needsDEMTextureUpload||(t.activeTexture.set(o.TEXTURE1),Ed(this.painter,m,_))}}_prepareDemTileUniforms(t,o,h,m){if(!o||o.demTexture==null)return!1;let _=t.tileID.canonical,v=Math.pow(2,o.tileID.canonical.z-_.z),E=m||"";return h[`u_dem_tl${E}`]=[_.x*v%1,_.y*v%1],h[`u_dem_scale${E}`]=v,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let t=0,o=this._visibleDemTiles.reduce((h,m)=>{if(!m.dem)return h;let _=m.dem.tree.minimums[0];return _>0&&t++,h+_},0);return t?o/t:0}_updateEmptyDEMTexture(){let t=this.painter.context,o=t.gl;t.activeTexture.set(o.TEXTURE2);let h=this._getLoadedAreaMinimum(),m=new i.du({width:1,height:1},new Float32Array([h]));this._emptyDEMTextureDirty=!1;let _=this._emptyDEMTexture;return _?_.update(m,{premultiply:!1}):_=this._emptyDEMTexture=new i.T(t,m,o.R32F,{premultiply:!1}),_}setupElevationDraw(t,o,h){let m=this.painter.context,_=m.gl,v={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};v.u_exaggeration=this.exaggeration();let E=null,T=null,C=1;if(h&&h.morphing&&this._useVertexMorphing){let k=h.morphing.srcDemTile,j=h.morphing.dstDemTile;C=h.morphing.phase,k&&j&&(this._prepareDemTileUniforms(t,k,v,"_prev")&&(T=k),this._prepareDemTileUniforms(t,j,v)&&(E=j))}let M=k=>k&&k.demTexture&&this.painter.linearFloatFilteringSupported()?_.LINEAR:_.NEAREST,O=null;var P;if(this.enabled?T&&E?(O=E.demTexture,m.activeTexture.set(_.TEXTURE4),T.demTexture.bind(M(T),_.CLAMP_TO_EDGE),v.u_dem_lerp=C):(E=this.terrainTileForTile[t.tileID.key],O=this._prepareDemTileUniforms(t,E,v)?E.demTexture:this.emptyDEMTexture):O=this.emptyDEMTexture,m.activeTexture.set(_.TEXTURE2),O&&(v.u_dem_size=(P=O).size[0]===1?1:P.size[0]-2,O.bind(M(E),_.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(h&&h.useDepthForOcclusion,o,v),h&&h.useMeterToDem&&E){let k=(1<<E.tileID.canonical.z)*i.c6(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;v.u_meter_to_dem=k}if(h&&h.labelPlaneMatrixInv&&(v.u_label_plane_matrix_inv=h.labelPlaneMatrixInv),o.setTerrainUniformValues(m,v),this.painter.transform.projection.name==="globe"){let k=this.globeUniformValues(this.painter.transform,t.tileID.canonical,h&&h.useDenormalizedUpVectorScale);o.setGlobeUniformValues(m,k)}}globeUniformValues(t,o,h){let m=t.projection;return{u_tile_tl_up:m.upVector(o,0,0),u_tile_tr_up:m.upVector(o,i.aj,0),u_tile_br_up:m.upVector(o,i.aj,i.aj),u_tile_bl_up:m.upVector(o,0,i.aj),u_tile_up_scale:h?i.dv(1):m.upVectorScale(o,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){let o=this.painter,h=this.painter.context;t.length!==0&&(h.bindFramebuffer.set(null),h.viewport.set([0,0,o.width,o.height]),o.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(m,_,v,E,T){if(m.transform.projection.name==="globe")(function(C,M,O,P,k){let j=C.context,B=j.gl,U,q,Z=C.transform,ee=i.dl(C,j,Z),re=(Be,Ve)=>{if(q===Ve)return;let We=[im[Ve],"PROJECTION_GLOBE_VIEW"];ee&&We.push("CUSTOM_ANTIALIASING");let we=C.isTileAffectedByFog(Be);U=C.getOrCreateProgram("globeRaster",{defines:We,overrideFog:we}),q=Ve},ue=C.colorModeForRenderPass(),le=new ft(B.LEQUAL,ft.ReadWrite,C.depthRangeFor3D);wa.update(k);let se=i.dm(Z),oe=[i.aD(Z.center.lng),i.aH(Z.center.lat)],he=C.globeSharedBuffers,fe=[Z.width*i.q.devicePixelRatio,Z.height*i.q.devicePixelRatio],Te=Float32Array.from(Z.globeMatrix),Ie={useDenormalizedUpVectorScale:!0};{let Be=C.transform,Ve=rm(Be.zoom,M.exaggeration(),M.sourceCache._source.tileSize);q=-1;let We=B.TRIANGLES;for(let we of P){let Oe=O.getTile(we),_e=Bt.disabled,Ue=M.prevTerrainTileForTile[we.key],Me=M.terrainTileForTile[we.key];Pd(Ue,Me)&&wa.newMorphing(we.key,Ue,Me,k,250),j.activeTexture.set(B.TEXTURE0),Oe.texture&&Oe.texture.bind(B.LINEAR,B.CLAMP_TO_EDGE);let Ge=wa.getMorphValuesForProxy(we.key),nt=Ge?1:0;Ge&&i.L(Ie,{morphing:{srcDemTile:Ge.from,dstDemTile:Ge.to,phase:i.dk(Ge.phase)}});let je=i.dn(we.canonical),et=i.dp(je.getCenter().lat),mt=i.dq(we.canonical,je,et,Be.worldSize/Be._pixelsPerMercatorPixel),gt=i.bh(i.dr(we.canonical)),dt=Rd(Be.expandedFarZProjMatrix,Te,se,gt,i.ah(Be.zoom),oe,Be.frustumCorners.TL,Be.frustumCorners.TR,Be.frustumCorners.BR,Be.frustumCorners.BL,Be.globeCenterInViewSpace,Be.globeRadius,fe,Ve,Be._farZ,mt);if(re(we,nt),U&&(M.setupElevationDraw(Oe,U,Ie),C.uploadCommonUniforms(j,U,we.toUnwrapped()),he)){let[Et,St,Ct]=he.getGridBuffers(et,Ve!==0);U.draw(C,We,le,_e,ue,Pt.backCCW,dt,"globe_raster",Et,St,Ct)}}}if(he&&(C.renderDefaultNorthPole||C.renderDefaultSouthPole)){let Be=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];ee&&Be.push("CUSTOM_ANTIALIASING"),U=C.getOrCreateProgram("globeRaster",{defines:Be});for(let Ve of P){let{x:We,y:we,z:Oe}=Ve.canonical,_e=we===0,Ue=we===(1<<Oe)-1,[Me,Ge,nt,je]=he.getPoleBuffers(Oe,!1);if(je&&(_e||Ue)){let et=O.getTile(Ve);j.activeTexture.set(B.TEXTURE0),et.texture&&et.texture.bind(B.LINEAR,B.CLAMP_TO_EDGE);let mt=i.ds(Oe,We,Z),gt=i.bh(i.dr(Ve.canonical)),dt=(Et,St)=>Et.draw(C,B.TRIANGLES,le,Bt.disabled,ue,Pt.disabled,Rd(Z.expandedFarZProjMatrix,mt,mt,gt,0,oe,Z.frustumCorners.TL,Z.frustumCorners.TR,Z.frustumCorners.BR,Z.frustumCorners.BL,Z.globeCenterInViewSpace,Z.globeRadius,fe,0,Z._farZ),"globe_pole_raster",St,nt,je);M.setupElevationDraw(et,U,Ie),C.uploadCommonUniforms(j,U,Ve.toUnwrapped()),_e&&C.renderDefaultNorthPole&&dt(U,Me),Ue&&C.renderDefaultSouthPole&&(mt=i.cE(i.bz(),mt,[1,-1,1]),dt(U,Ge))}}}})(m,_,v,E,T);else{let C=m.context,M=C.gl,O,P,k=m.shadowRenderer,j=ps(m,m.longestCutoffRange),B=ue=>{if(P===ue)return;let le=[];le.push(im[ue]),j.shouldRenderCutoff&&le.push("RENDER_CUTOFF"),k&&(le.push("RENDER_SHADOWS","DEPTH_TEXTURE"),k.useNormalOffset&&le.push("NORMAL_OFFSET")),O=m.getOrCreateProgram("terrainRaster",{defines:le}),P=ue},U=m.colorModeForRenderPass(),q=new ft(M.LEQUAL,ft.ReadWrite,m.depthRangeFor3D);wa.update(T);let Z=m.transform,ee=rm(Z.zoom,_.exaggeration(),_.sourceCache._source.tileSize),re=[0,0,0];if(k){let ue=m.style.directionalLight,le=m.style.ambientLight;ue&&le&&(re=pl(m.style,ue,le))}{P=-1;let ue=M.TRIANGLES,[le,se]=[_.gridIndexBuffer,_.gridSegments];for(let oe of E){let he=v.getTile(oe),fe=Bt.disabled,Te=_.prevTerrainTileForTile[oe.key],Ie=_.terrainTileForTile[oe.key];Pd(Te,Ie)&&wa.newMorphing(oe.key,Te,Ie,T,250),C.activeTexture.set(M.TEXTURE0),he.texture&&he.texture.bind(M.LINEAR,M.CLAMP_TO_EDGE);let Be=wa.getMorphValuesForProxy(oe.key),Ve=Be?1:0,We;Be&&(We={morphing:{srcDemTile:Be.from,dstDemTile:Be.to,phase:i.dk(Be.phase)}});let we=nm(oe.projMatrix,Gb(oe.canonical,Z.renderWorldCopies)?ee/10:ee,re);if(B(Ve),!O)continue;_.setupElevationDraw(he,O,We);let Oe=oe.toUnwrapped();k&&k.setupShadows(Oe,O),m.uploadCommonUniforms(C,O,Oe,null,j),O.draw(m,ue,q,fe,U,Pt.backCCW,we,"terrain_raster",_.gridBuffer,le,se)}}}}(o,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,o.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(this._drapedRenderBatches.length===0)return t+1;this.renderingToTexture=!0;let o=this.painter,h=this.painter.context,m=this.proxySourceCache,_=this.proxiedCoords[m.id],v=this._drapedRenderBatches.shift(),E=o.style.order,T=[],C=0;for(let M of _){let O=m.getTileByID(M.proxyTileKey),P=m.proxyCachedFBO[M.key]?m.proxyCachedFBO[M.key][t]:void 0,k=P!==void 0?m.renderCache[P]:this.pool[C++],j=P!==void 0;if(O.texture=k.tex,j&&!k.dirty){T.push(O.tileID);continue}let B;h.bindFramebuffer.set(k.fb.framebuffer),this.renderedToTile=!1,k.dirty&&(h.clear({color:i.am.transparent,stencil:0}),k.dirty=!1);for(let U=v.start;U<=v.end;++U){let q=o.style._mergedLayers[E[U]];if(q.isHidden(o.transform.zoom))continue;let Z=o.style.getLayerSourceCache(q),ee=Z?this.proxyToSource[M.key][Z.id]:[M];if(!ee)continue;let re=ee;h.viewport.set([0,0,k.fb.width,k.fb.height]),B!==(Z?Z.id:null)&&(this._setupStencil(k,ee,q,Z),B=Z?Z.id:null),o.renderLayer(o,Z,q,re)}if(this._drapedRenderBatches.length===0)for(let U of this._pendingGroundEffectLayers){let q=o.style._mergedLayers[E[U]];if(q.isHidden(o.transform.zoom))continue;let Z=o.style.getLayerSourceCache(q),ee=Z?this.proxyToSource[M.key][Z.id]:[M];if(!ee)continue;let re=ee;h.viewport.set([0,0,k.fb.width,k.fb.height]),B!==(Z?Z.id:null)&&(this._setupStencil(k,ee,q,Z),B=Z?Z.id:null),o.renderLayer(o,Z,q,re)}this.renderedToTile?(k.dirty=!0,T.push(O.tileID)):j||--C,C===5&&(C=0,this.renderToBackBuffer(T))}return this.renderToBackBuffer(T),this.renderingToTexture=!1,h.bindFramebuffer.set(null),h.viewport.set([0,0,o.width,o.height]),v.end+1}postRender(){}isLayerOrderingCorrect(t){let o=t.order.length,h=-1,m=o;for(let _=0;_<o;++_)this._style.isLayerDraped(t._mergedLayers[t.order[_]])?h=Math.max(h,_):m=Math.min(m,_);return m>h}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter(o=>o.dem).forEach(o=>{t=Math.min(t,o.dem.tree.minimums[0])}),t===0?t:(t-30)*this._exaggeration}raycast(t,o,h){if(!this._visibleDemTiles)return null;let m=this._visibleDemTiles.filter(_=>_.dem).map(_=>{let v=_.tileID,E=1<<v.overscaledZ,{x:T,y:C}=v.canonical,M=T/E,O=(T+1)/E,P=C/E,k=(C+1)/E;return{minx:M,miny:P,maxx:O,maxy:k,t:_.dem.tree.raycastRoot(M,P,O,k,t,o,h),tile:_}});m.sort((_,v)=>(_.t!==null?_.t:Number.MAX_VALUE)-(v.t!==null?v.t:Number.MAX_VALUE));for(let _ of m){if(_.t==null)return null;let v=_.tile.dem.tree.raycast(_.minx,_.miny,_.maxx,_.maxy,t,o,h);if(v!=null)return v}return null}_createFBO(){let t=this.painter.context,o=t.gl,h=this.drapeBufferSize;t.activeTexture.set(o.TEXTURE0);let m=new i.T(t,{width:h[0],height:h[1],data:null},o.RGBA8);m.bind(o.LINEAR,o.CLAMP_TO_EDGE);let _=t.createFramebuffer(h[0],h[1],!0,null);return _.colorAttachment.set(m.texture),_.depthAttachment=new $b(t,_.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,h[0],h[1]),this._stencilRef=0,_.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):_.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&o.texParameterf(o.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:_,tex:m,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(let t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some(t=>{let o=this._style._mergedLayers[t],h=o.isHidden(this.painter.transform.zoom);return o.type==="hillshade"||o.type==="custom"?!h&&o.shouldRedrape():!h&&o.hasTransition()})}_clearLineLayersFromRenderCache(){let t=!1;for(let h of this._style.getSources())if(h instanceof xu){t=!0;break}if(!t)return;let o={};for(let h=0;h<this._style.order.length;++h){let m=this._style._mergedLayers[this._style.order[h]],_=this._style.getLayerSourceCache(m);if(_&&!o[_.id]&&!m.isHidden(this.painter.transform.zoom)&&m.type==="line"&&m.widthExpression()instanceof i.ab){o[_.id]=!0;for(let v of this.proxyCoords){let E=this.proxyToSource[v.key][_.id];if(E)for(let T of E)this._clearRenderCacheForTile(_.id,T)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(let h in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[h]._source instanceof ar){t=!0;break}if(!t)return;let o={};for(let h=0;h<this._style.order.length;++h){let m=this._style._mergedLayers[this._style.order[h]],_=this._style.getLayerSourceCache(m);if(!_||o[_.id]||m.isHidden(this.painter.transform.zoom)||m.type!=="raster")continue;let v=m.paint.get("raster-fade-duration");for(let E of this.proxyCoords){let T=this.proxyToSource[E.key][_.id];if(T)for(let C of T){let M=yl(_.getTile(C),_.findLoadedParent(C,0),_,this.painter.transform,v);(M.opacity!==1||M.mix!==0)&&this._clearRenderCacheForTile(_.id,C)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();let t=this._style.order,o=t.length;if(o===0)return;let h=[];this._pendingGroundEffectLayers=[];let m,_=0,v=this._style._mergedLayers[t[_]];for(;!this._style.isLayerDraped(v)&&v.isHidden(this.painter.transform.zoom)&&++_<o;)v=this._style._mergedLayers[t[_]];for(;_<o;++_){let E=this._style._mergedLayers[t[_]];E.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(E)?m===void 0&&(m=_):(E.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(_),m!==void 0&&(h.push({start:m,end:_-1}),m=void 0)))}if(m!==void 0&&h.push({start:m,end:_-1}),h.length!==0){let E=h[h.length-1];this._pendingGroundEffectLayers.every(T=>T>E.end)||i.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=h}_setupRenderCache(t){let o=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,o.renderCache.length>o.renderCachePool.length){let v=Object.values(o.proxyCachedFBO);o.proxyCachedFBO={};for(let E=0;E<v.length;++E){let T=Object.values(v[E]);o.renderCachePool.push(...T)}}return}this._clearRasterLayersFromRenderCache();let h=this.proxyCoords,m=this._tilesDirty;for(let v=h.length-1;v>=0;v--){let E=h[v];if(o.getTileByID(E.key),o.proxyCachedFBO[E.key]!==void 0){let T=t[E.key],C=this.proxyToSource[E.key],M=0;for(let O in C){let P=C[O],k=T[O];if(!k||k.length!==P.length||P.some((j,B)=>j!==k[B]||m[O]&&m[O].hasOwnProperty(j.key))){M=-1;break}++M}for(let O in o.proxyCachedFBO[E.key])o.renderCache[o.proxyCachedFBO[E.key][O]].dirty=M<0||M!==Object.values(T).length}}let _=[...this._drapedRenderBatches];_.sort((v,E)=>E.end-E.start-(v.end-v.start));for(let v of _)for(let E of h){if(o.proxyCachedFBO[E.key])continue;let T=o.renderCachePool.pop();T===void 0&&o.renderCache.length<50&&(T=o.renderCache.length,o.renderCache.push(this._createFBO())),T!==void 0&&(o.proxyCachedFBO[E.key]={},o.proxyCachedFBO[E.key][v.start]=T,o.renderCache[T].dirty=!0)}this._tilesDirty={}}_setupStencil(t,o,h,m){if(!m||!this._sourceTilesOverlap[m.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));let _=this.painter.context,v=_.gl;if(o.length<=1)return void(this._overlapStencilType=!1);let E;if(h.isTileClipped())E=o.length,this._overlapStencilMode.test={func:v.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(o[0].overscaledZ>o[o.length-1].overscaledZ))return void(this._overlapStencilType=!1);E=1,this._overlapStencilMode.test={func:v.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+E>255&&(_.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=E,this._overlapStencilMode.ref=this._stencilRef,h.isTileClipped()&&this._renderTileClippingMasks(o,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):Bt.disabled}_renderTileClippingMasks(t,o){let h=this.painter,m=this.painter.context,_=m.gl;h._tileClippingMaskIDs={},m.setColorMode(en.disabled),m.setDepthMode(ft.disabled);let v=h.getOrCreateProgram("clippingMask");for(let E of t){let T=h._tileClippingMaskIDs[E.key]=--o;v.draw(h,_.TRIANGLES,ft.disabled,new Bt({func:_.ALWAYS,mask:0},T,255,_.KEEP,_.KEEP,_.REPLACE),en.disabled,Pt.disabled,_l(E.projMatrix),"$clipping",h.tileExtentBuffer,h.quadTriangleIndexBuffer,h.tileExtentSegments)}}pointCoordinate(t){let o=this.painter.transform;if(t.x<0||t.x>o.width||t.y<0||t.y>o.height)return null;let h=[t.x,t.y,1,1];i.aA(h,h,o.pixelMatrixInverse),i.cw(h,h,1/h[3]),h[0]/=o.worldSize,h[1]/=o.worldSize;let m=o._camera.position,_=i.c6(1,o.center.lat),v=[m[0],m[1],m[2]/_,0],E=i.cX([],h.slice(0,3),v);i.au(E,E);let T=this.raycast(v,E,this._exaggeration);return T!==null&&T?(i.bE(v,v,E,T),v[3]=v[2],v[2]*=_,v):null}_setupProxiedCoordsForOrtho(t,o,h){if(t.getSource()instanceof i.aP)return this._setupProxiedCoordsForImageSource(t,o,h);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};let m=this.proxiedCoords[t.id]=[],_=this.proxyCoords;for(let T=0;T<_.length;T++){let C=_[T],M=this._findTileCoveringTileID(C,t);if(M){let O=this._createProxiedId(C,M,h[C.key]&&h[C.key][t.id]);m.push(O),this.proxyToSource[C.key][t.id]=[O]}}let v=!1,E=new Set;for(let T=0;T<o.length;T++){let C=t.getTile(o[T]);if(!C||!C.hasData())continue;let M=this._findTileCoveringTileID(C.tileID,this.proxySourceCache);if(M&&M.tileID.canonical.z!==C.tileID.canonical.z){let O=this.proxyToSource[M.tileID.key][t.id],P=this._createProxiedId(M.tileID,C,h[M.tileID.key]&&h[M.tileID.key][t.id]);O?O.splice(O.length-1,0,P):this.proxyToSource[M.tileID.key][t.id]=[P];let k=this.proxyToSource[M.tileID.key][t.id];E.has(k)||E.add(k),m.push(P),v=!0}}if(this._sourceTilesOverlap[t.id]=v,v&&this._debugParams.sortTilesHiZFirst)for(let T of E)T.sort((C,M)=>M.overscaledZ-C.overscaledZ)}_setupProxiedCoordsForImageSource(t,o,h){if(!t.getSource().loaded())return;let m=this.proxiedCoords[t.id]=[],_=this.proxyCoords,v=t.getSource(),E=v.tileID;if(!E)return;let T=new i.P(E.x,E.y)._div(1<<E.z),C=v.coordinates.map(i.ac.fromLngLat).reduce((O,P)=>(O.min.x=Math.min(O.min.x,P.x-T.x),O.min.y=Math.min(O.min.y,P.y-T.y),O.max.x=Math.max(O.max.x,P.x-T.x),O.max.y=Math.max(O.max.y,P.y-T.y),O),{min:new i.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new i.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),M=(O,P)=>{let k=O.wrap+O.canonical.x/(1<<O.canonical.z),j=O.canonical.y/(1<<O.canonical.z),B=i.aj/(1<<O.canonical.z),U=P.wrap+P.canonical.x/(1<<P.canonical.z),q=P.canonical.y/(1<<P.canonical.z);return k+B<U+C.min.x||k>U+C.max.x||j+B<q+C.min.y||j>q+C.max.y};for(let O=0;O<_.length;O++){let P=_[O];for(let k=0;k<o.length;k++){let j=t.getTile(o[k]);if(!j||!j.hasData()||M(P,j.tileID))continue;let B=this._createProxiedId(P,j,h[P.key]&&h[P.key][t.id]),U=this.proxyToSource[P.key][t.id];U?U.push(B):this.proxyToSource[P.key][t.id]=[B],m.push(B)}}}_createProxiedId(t,o,h){let m=this.orthoMatrix;if(h){let _=h.find(v=>v.key===o.tileID.key);if(_)return _}if(o.tileID.key!==t.key){let _=t.canonical.z-o.tileID.canonical.z,v,E,T;m=i.bz();let C=o.tileID.wrap-t.wrap<<t.overscaledZ;_>0?(v=i.aj>>_,E=v*((o.tileID.canonical.x<<_)-t.canonical.x+C),T=v*((o.tileID.canonical.y<<_)-t.canonical.y)):(v=i.aj<<-_,E=i.aj*(o.tileID.canonical.x-(t.canonical.x+C<<-_)),T=i.aj*(o.tileID.canonical.y-(t.canonical.y<<-_))),i.c5(m,0,v,0,v,0,1),i.bo(m,m,[E,T,0])}return new Ld(o.tileID,t.key,m)}_findTileCoveringTileID(t,o){let h=o.getTile(t);if(h&&h.hasData())return h;let m=this._findCoveringTileCache[o.id],_=m[t.key];if(h=_?o.getTileByID(_):null,h&&h.hasData()||_===null)return h;let v=h?h.tileID:t,E=v.overscaledZ,T=o.getSource().minzoom,C=[];if(!_){let O=o.getSource().maxzoom;if(t.canonical.z>=O){let P=t.canonical.z-O;o.getSource().reparseOverscaled?(E=Math.max(t.canonical.z+2,o.transform.tileZoom),v=new i.aM(E,t.wrap,O,t.canonical.x>>P,t.canonical.y>>P)):P!==0&&(E=O,v=new i.aM(E,t.wrap,O,t.canonical.x>>P,t.canonical.y>>P))}v.key!==t.key&&(C.push(v.key),h=o.getTile(v))}let M=O=>{C.forEach(P=>{m[P]=O}),C.length=0};for(E-=1;E>=T&&(!h||!h.hasData());E--){h&&M(h.tileID.key);let O=v.calculateScaledKey(E);if(h=o.getTileByID(O),h&&h.hasData())break;let P=m[O];if(P===null)break;P===void 0?C.push(O):h=o.getTileByID(P)}return M(h?h.tileID.key:null),h&&h.hasData()?h:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,o){let h=this._tilesDirty[t];h||(h=this._tilesDirty[t]={}),h[o.key]=!0}}function Od(u,t,o){let h=function(E,T,C){let M=i.bG(T,E),O=i.bG(C,[.2126,.7152,.0722]),P=(j,B,U)=>(1-U)*j+U*B,k=P(1-.3*Math.min(O,1),1,Math.min(M+1,1));return P(.92,1,Math.asin(i.ay(T[2],-1,1))/Math.PI+.5)*k}(u,[0,0,1],t),m=[0,0,0];i.bY(m,o.slice(0,3),h);let _=[0,0,0];i.bY(_,t.slice(0,3),u[2]);let v=[0,0,0];return i.cV(v,m,_),i.cY(v)}let om=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],sm=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class kd{static cacheKey(t,o,h,m){let _=`${o}${m?m.cacheKey:""}`;for(let v of h)t.usedDefines.includes(v)&&(_+=`/${v}`);return _}constructor(t,o,h,m,_,v){let E=t.gl;this.program=E.createProgram(),this.configuration=m,this.name=o,this.fixedDefines=[...v];let T=m?m.getBinderAttributes():[],C=(h.staticAttributes||[]).concat(T),M=m?m.defines():[];M=M.concat(v.map(U=>`#define ${U}`));let O=`#version 300 es
`,P=O+M.concat("precision mediump float;",ms,ju.fragmentSource).join(`
`);for(let U of h.fragmentIncludes)P+=`
${pc[U]}`;P+=`
${h.fragmentSource}`;let k=O+M.concat("precision highp float;",ms,ju.vertexSource).join(`
`);for(let U of h.vertexIncludes)k+=`
${pc[U]}`;this.forceManualRenderingForInstanceIDShaders=t.forceManualRenderingForInstanceIDShaders&&h.vertexSource.indexOf("gl_InstanceID")!==-1,this.forceManualRenderingForInstanceIDShaders&&(k+=`
uniform int u_instanceID;
`),k+=`
${h.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(k=k.replaceAll("gl_InstanceID","u_instanceID"));let j=E.createShader(E.FRAGMENT_SHADER);if(E.isContextLost())return void(this.failedToCreate=!0);E.shaderSource(j,P),E.compileShader(j),E.attachShader(this.program,j);let B=E.createShader(E.VERTEX_SHADER);if(E.isContextLost())this.failedToCreate=!0;else{E.shaderSource(B,k),E.compileShader(B),E.attachShader(this.program,B),this.attributes={},this.numAttributes=C.length;for(let U=0;U<this.numAttributes;U++)if(C[U]){let q=C[U].startsWith("a_")?C[U]:`a_${C[U]}`;E.bindAttribLocation(this.program,U,q),this.attributes[q]=U}E.linkProgram(this.program),E.deleteShader(B),E.deleteShader(j),this.fixedUniforms=_(t),this.binderUniforms=m?m.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(U=>({u_instanceID:new i.c8(U)}))(t)),(v.includes("TERRAIN")||o.indexOf("symbol")!==-1||o.indexOf("circle")!==-1)&&(this.terrainUniforms=(U=>({u_dem:new i.c8(U),u_dem_prev:new i.c8(U),u_dem_tl:new i.cb(U),u_dem_scale:new i.ca(U),u_dem_tl_prev:new i.cb(U),u_dem_scale_prev:new i.ca(U),u_dem_size:new i.ca(U),u_dem_lerp:new i.ca(U),u_exaggeration:new i.ca(U),u_depth:new i.c8(U),u_depth_size_inv:new i.cb(U),u_depth_range_unpack:new i.cb(U),u_occluder_half_size:new i.ca(U),u_occlusion_depth_offset:new i.ca(U),u_meter_to_dem:new i.ca(U),u_label_plane_matrix_inv:new i.cc(U)}))(t)),v.includes("GLOBE")&&(this.globeUniforms=(U=>({u_tile_tl_up:new i.c9(U),u_tile_tr_up:new i.c9(U),u_tile_br_up:new i.c9(U),u_tile_bl_up:new i.c9(U),u_tile_up_scale:new i.ca(U)}))(t)),v.includes("FOG")&&(this.fogUniforms=(U=>({u_fog_matrix:new i.cc(U),u_fog_range:new i.cb(U),u_fog_color:new i.cQ(U),u_fog_horizon_blend:new i.ca(U),u_fog_vertical_limit:new i.cb(U),u_fog_temporal_offset:new i.ca(U),u_frustum_tl:new i.c9(U),u_frustum_tr:new i.c9(U),u_frustum_br:new i.c9(U),u_frustum_bl:new i.c9(U),u_globe_pos:new i.c9(U),u_globe_radius:new i.ca(U),u_globe_transition:new i.ca(U),u_is_globe:new i.c8(U),u_viewport:new i.cb(U)}))(t)),v.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(U=>({u_cutoff_params:new i.cQ(U)}))(t)),v.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(U=>({u_lighting_ambient_color:new i.c9(U),u_lighting_directional_dir:new i.c9(U),u_lighting_directional_color:new i.c9(U),u_ground_radiance:new i.c9(U)}))(t)),v.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(U=>({u_light_matrix_0:new i.cc(U),u_light_matrix_1:new i.cc(U),u_fade_range:new i.cb(U),u_shadow_normal_offset:new i.c9(U),u_shadow_intensity:new i.ca(U),u_shadow_texel_size:new i.ca(U),u_shadow_map_resolution:new i.ca(U),u_shadow_direction:new i.c9(U),u_shadow_bias:new i.c9(U),u_shadowmap_0:new i.c8(U),u_shadowmap_1:new i.c8(U)}))(t))}}setTerrainUniformValues(t,o){if(!this.terrainUniforms)return;let h=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let m in o)h[m]&&h[m].set(this.program,m,o[m])}}setGlobeUniformValues(t,o){if(!this.globeUniforms)return;let h=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let m in o)h[m]&&h[m].set(this.program,m,o[m])}}setFogUniformValues(t,o){if(!this.fogUniforms)return;let h=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let m in o)h[m].set(this.program,m,o[m])}}setCutoffUniformValues(t,o){if(!this.cutoffUniforms)return;let h=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let m in o)h[m].set(this.program,m,o[m])}}setLightsUniformValues(t,o){if(!this.lightsUniforms)return;let h=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let m in o)h[m].set(this.program,m,o[m])}}setShadowUniformValues(t,o){if(this.failedToCreate||!this.shadowUniforms)return;let h=this.shadowUniforms;t.program.set(this.program);for(let m in o)h[m].set(this.program,m,o[m])}_drawDebugWireframe(t,o,h,m,_,v,E,T,C,M){let O=t.options.wireframe;if(O.terrain===!1&&O.layers2D===!1&&O.layers3D===!1)return;let P=t.context;if(!(!(!O.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!O.layers2D||t._terrain&&t._terrain.renderingToTexture||!om.includes(this.name))||!(!O.layers3D||!sm.includes(this.name))))return;let k=P.gl,j=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,_,P);if(!j)return;let B=[...this.fixedDefines];B.push("DEBUG_WIREFRAME");let U=t.getOrCreateProgram(this.name,{config:this.configuration,defines:B});P.program.set(U.program);let q=(re,ue,le)=>{if(ue[re]&&le[re])for(let se in ue[re])le[re][se]&&le[re][se].set(le.program,se,ue[re][se].current)};C&&C.setUniforms(U.program,P,U.binderUniforms,E,{zoom:T}),q("fixedUniforms",this,U),q("terrainUniforms",this,U),q("globeUniforms",this,U),q("fogUniforms",this,U),q("lightsUniforms",this,U),q("shadowUniforms",this,U),j.bind(),P.setColorMode(new en([k.ONE,k.ONE_MINUS_SRC_ALPHA,k.ZERO,k.ONE],i.am.transparent,[!0,!0,!0,!1])),P.setDepthMode(new ft(o.func===k.LESS?k.LEQUAL:o.func,ft.ReadOnly,o.range)),P.setStencilMode(Bt.disabled);let Z=3*v.primitiveLength*2,ee=3*v.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){let re=M||1;for(let ue=0;ue<re;++ue)U.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",ue),k.drawElements(k.LINES,Z,k.UNSIGNED_SHORT,ee)}else M&&M>1?k.drawElementsInstanced(k.LINES,Z,k.UNSIGNED_SHORT,ee,M):k.drawElements(k.LINES,Z,k.UNSIGNED_SHORT,ee);_.bind(),P.program.set(this.program),P.setDepthMode(o),P.setStencilMode(h),P.setColorMode(m)}checkUniforms(t,o,h){if(this.fixedDefines.includes(o)){for(let m of Object.keys(h))if(!h[m].initialized)throw new Error(`Program '${this.name}', from draw '${t}': uniform ${m} not set but required by ${o} being defined`)}}draw(t,o,h,m,_,v,E,T,C,M,O,P,k,j,B,U){let q=t.context,Z=q.gl;if(this.failedToCreate)return;q.program.set(this.program),q.setDepthMode(h),q.setStencilMode(m),q.setColorMode(_),q.setCullFace(v);for(let ue of Object.keys(this.fixedUniforms))this.fixedUniforms[ue].set(this.program,ue,E[ue]);j&&j.setUniforms(this.program,q,this.binderUniforms,P,{zoom:k});let ee={[Z.POINTS]:1,[Z.LINES]:2,[Z.TRIANGLES]:3,[Z.LINE_STRIP]:1}[o];this.checkUniforms(T,"RENDER_SHADOWS",this.shadowUniforms);let re=U&&U>0?1:void 0;for(let ue of O.get()){let le=ue.vaos||(ue.vaos={});if((le[T]||(le[T]=new mc)).bind(q,this,C,j?j.getPaintVertexBuffers():[],M,ue.vertexOffset,B||[],re),this.forceManualRenderingForInstanceIDShaders){let se=U||1;for(let oe=0;oe<se;++oe)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",oe),M?Z.drawElements(o,ue.primitiveLength*ee,Z.UNSIGNED_SHORT,ue.primitiveOffset*ee*2):Z.drawArrays(o,ue.vertexOffset,ue.vertexLength)}else U&&U>1?Z.drawElementsInstanced(o,ue.primitiveLength*ee,Z.UNSIGNED_SHORT,ue.primitiveOffset*ee*2,U):M?Z.drawElements(o,ue.primitiveLength*ee,Z.UNSIGNED_SHORT,ue.primitiveOffset*ee*2):Z.drawArrays(o,ue.vertexOffset,ue.vertexLength);o===Z.TRIANGLES&&M&&this._drawDebugWireframe(t,h,m,_,M,ue,P,k,j,U)}}}function $u(u,t,o=0){let h=Math.pow(2,t.tileID.overscaledZ),m=t.tileSize*Math.pow(2,u.transform.tileZoom)/h,_=m*(t.tileID.canonical.x+t.tileID.wrap*h),v=m*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/i.aw(t,1,u.transform.tileZoom),u_pixel_coord_upper:[_>>16,v>>16],u_pixel_coord_lower:[65535&_,65535&v],u_pattern_transition:o}}let vc={terrain:0,flat:1},am=i.bz(),Gu=(u,t,o,h,m,_,v,E,T,C,M,O,P,k,j,B,U,q)=>{let Z=t.style.light,ee=Z.properties.get("position"),re=[ee.x,ee.y,ee.z],ue=i.dx();Z.properties.get("anchor")==="viewport"&&(i.dy(ue,-t.transform.angle),i.dz(re,re,ue));let le=Z.properties.get("color").toPremultipliedRenderColor(null),se=t.transform,oe={u_matrix:u,u_lightpos:re,u_lightintensity:Z.properties.get("intensity"),u_lightcolor:[le.r,le.g,le.b],u_vertical_gradient:+o,u_opacity:h,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:am,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:vc[C],u_base_type:vc[M],u_ao:m,u_edge_radius:_,u_width_scale:v,u_flood_light_color:j,u_vertical_scale:B,u_flood_light_intensity:U,u_ground_shadow_factor:q};return se.projection.name==="globe"&&(oe.u_tile_id=[E.canonical.x,E.canonical.y,1<<E.canonical.z],oe.u_zoom_transition=O,oe.u_inv_rot_matrix=k,oe.u_merc_center=P,oe.u_up_dir=se.projection.upVector(new i.cp(0,0,0),P[0]*i.aj,P[1]*i.aj),oe.u_height_lift=T),oe},oy=(u,t,o,h,m,_)=>({u_matrix:u,u_edge_radius:t,u_width_scale:o,u_vertical_scale:h,u_height_type:vc[m],u_base_type:vc[_]}),sy=(u,t,o,h,m,_,v,E,T,C,M,O,P,k,j,B,U,q)=>{let Z=Gu(u,t,o,h,m,_,v,E,C,M,O,P,k,j,B,U,1,[0,0,0]),ee={u_height_factor:-Math.pow(2,E.overscaledZ)/T.tileSize/8};return i.h(Z,$u(t,T,q),ee)},vl=(u,t,o)=>({u_matrix:u,u_emissive_strength:t,u_ground_shadow_factor:o}),ay=(u,t,o,h,m,_=0)=>i.h(vl(u,t,m),$u(o,h,_)),qb=(u,t,o,h)=>({u_matrix:u,u_world:o,u_emissive_strength:t,u_ground_shadow_factor:h}),Wb=(u,t,o,h,m,_,v=0)=>i.h(ay(u,t,o,h,_,v),{u_world:m}),Zb=(u,t)=>({u_matrix:u,u_ground_shadow_factor:t}),Fd=(u,t,o,h,m)=>({u_matrix:u,u_camera_pos:[t[0],t[1],t[2]],u_depth_bias:o,u_height_scale:h,u_reset_depth:m}),Xb=(u,t,o,h)=>{let m=i.aj/o.tileSize;return{u_matrix:u,u_camera_to_center_distance:t.getCameraToCenterDistance(h),u_extrude_scale:[t.pixelsToGLUnits[0]/m,t.pixelsToGLUnits[1]/m]}},Nd=(u,t,o=1)=>({u_matrix:u,u_color:t,u_overlay:0,u_overlay_scale:o}),lm=i.bz(),ly=(u,t,o,h,m,_,v)=>{let E=u.transform,T=E.projection.name==="globe",C=T?i.dA(E.zoom,t.canonical)*E._pixelsPerMercatorPixel:i.aw(o,1,_),M={u_matrix:t.projMatrix,u_extrude_scale:C,u_intensity:v,u_inv_rot_matrix:lm,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(T){M.u_inv_rot_matrix=h,M.u_merc_center=m,M.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],M.u_zoom_transition=i.ah(E.zoom);let O=m[0]*i.aj,P=m[1]*i.aj;M.u_up_dir=E.projection.upVector(new i.cp(0,0,0),O,P)}return M};function xl(u,[t,o,h,m],[_,v]){if(_===v)return[0,0,0,0];let E=255*(u-1)/(u*(v-_));return[t*E,o*E,h*E,m*E]}function cm(u,t,[o,h]){return o===h?0:.5/u+(t-o)*(u-1)/(u*(h-o))}let um=(u,t,o,h,m,_,v,E,T,C,M,O,P,k,j,B,U,q,Z,ee,re)=>({u_matrix:u,u_normalize_matrix:t,u_globe_matrix:o,u_merc_matrix:h,u_grid_matrix:m,u_tl_parent:_,u_scale_parent:C,u_fade_t:M.mix,u_opacity:M.opacity*O.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:O.paint.get("raster-brightness-min"),u_brightness_high:O.paint.get("raster-brightness-max"),u_saturation_factor:i.dC(O.paint.get("raster-saturation")),u_contrast_factor:i.dB(O.paint.get("raster-contrast")),u_spin_weights:cy(O.paint.get("raster-hue-rotate")),u_perspective_transform:P,u_raster_elevation:k,u_zoom_transition:v,u_merc_center:E,u_cutoff_params:T,u_colorization_mix:xl(i.dD,B,q),u_colorization_offset:cm(i.dD,U,q),u_color_ramp:j,u_texture_offset:[ee/(Z+2*ee),Z/(Z+2*ee)],u_texture_res:[Z+2*ee,Z+2*ee],u_emissive_strength:re});function cy(u){u*=Math.PI/180;let t=Math.sin(u),o=Math.cos(u);return[(2*o+1)/3,(-Math.sqrt(3)*t-o+1)/3,(Math.sqrt(3)*t-o+1)/3]}let Ea=.05,bl=(u,t,o,h,m,_,v,E,T,C,M,O)=>({u_matrix:u,u_normalize_matrix:t,u_globe_matrix:o,u_merc_matrix:h,u_grid_matrix:m,u_tl_parent:_,u_scale_parent:C,u_fade_t:M.mix,u_opacity:M.opacity,u_image0:0,u_image1:1,u_raster_elevation:O,u_zoom_transition:v,u_merc_center:E,u_cutoff_params:T}),uy=(u,t,o,h,m,_,v,E,T,C)=>({u_particle_texture:u,u_particle_texture_side_len:t,u_tile_offset:o,u_velocity:h,u_color_ramp:_,u_velocity_res:m,u_max_speed:v,u_uv_offset:E,u_data_scale:[255*T[0],255*T[1]],u_data_offset:C,u_particle_pos_scale:1.1,u_particle_pos_offset:[Ea,Ea]}),Ta=(u,t,o,h,m,_,v,E,T,C)=>({u_particle_texture:u,u_particle_texture_side_len:t,u_velocity:o,u_velocity_res:h,u_max_speed:m,u_speed_factor:_,u_reset_rate:v,u_rand_seed:Math.random(),u_uv_offset:E,u_data_scale:[255*T[0],255*T[1]],u_data_offset:C,u_particle_pos_scale:1.1,u_particle_pos_offset:[Ea,Ea]}),zd=i.bz(),qu=(u,t,o,h,m,_,v,E,T,C,M,O,P,k,j,B,U,q,Z,ee,re,ue,le,se)=>{let oe=m.transform,he={u_is_size_zoom_constant:+(u==="constant"||u==="source"),u_is_size_feature_constant:+(u==="constant"||u==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:oe.getCameraToCenterDistance(Z),u_rotate_symbol:+o,u_aspect_ratio:oe.width/oe.height,u_fade_change:m.options.fadeDuration?m.symbolFadeChange:1,u_matrix:_,u_label_plane_matrix:v,u_coord_matrix:E,u_is_text:+C,u_elevation_from_sea:T?1:0,u_pitch_with_map:+h,u_texsize:M,u_texsize_icon:O,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:zd,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:zd,u_up_vector:[0,-1,0],u_color_adj_mat:ue,u_icon_transition:le||0,u_gamma_scale:h?m.transform.getCameraToCenterDistance(Z)*Math.cos(m.terrain?0:m.transform._pitch):1,u_device_pixel_ratio:i.q.devicePixelRatio,u_is_halo:1,u_scale_factor:se||1,u_ground_shadow_factor:ee,u_inv_matrix:i.bi(i.bz(),v),u_normal_scale:re};return Z.name==="globe"&&(he.u_tile_id=[k.canonical.x,k.canonical.y,1<<k.canonical.z],he.u_zoom_transition=j,he.u_inv_rot_matrix=U,he.u_merc_center=B,he.u_camera_forward=oe._camera.forward(),he.u_ecef_origin=i.dE(oe.globeMatrix,k.toUnwrapped()),he.u_tile_matrix=Float32Array.from(oe.globeMatrix),he.u_up_vector=q),he},hm=(u,t,o,h)=>({u_matrix:u,u_emissive_strength:t,u_opacity:o,u_color:h}),dm=(u,t,o,h,m,_,v,E,T)=>i.h(function(C,M,O,P,k,j){let{width:B,height:U}=P.imageManager.getPixelSize(M),q=Math.pow(2,j.tileID.overscaledZ),Z=j.tileSize*Math.pow(2,P.transform.tileZoom)/q,ee=Z*(j.tileID.canonical.x+j.tileID.wrap*q),re=Z*j.tileID.canonical.y;return{u_image:0,u_pattern_tl:O.tl,u_pattern_br:O.br,u_texsize:[B,U],u_pattern_size:O.displaySize,u_pattern_units_to_pixels:k?[P.transform.width,-1*P.transform.height]:[1/i.aw(j,1,P.transform.tileZoom),1/i.aw(j,1,P.transform.tileZoom)],u_pixel_coord_upper:[ee>>16,re>>16],u_pixel_coord_lower:[65535&ee,65535&re]}}(0,_,v,h,E,T),{u_matrix:u,u_emissive_strength:t,u_opacity:o}),Wu=new Float32Array(i.bx([])),Zu=(u,t,o,h,m,_,v,E,T,C,M,O,P,k=[0,0,0],j)=>{let B=m.style.light,U=B.properties.get("position"),q=[-U.x,-U.y,U.z],Z=i.dx();B.properties.get("anchor")==="viewport"&&(i.dy(Z,-m.transform.angle),i.dz(q,q,Z));let ee=M.alphaMode==="MASK",re=B.properties.get("color").toNonPremultipliedRenderColor(null),ue=P.paint.get("model-ambient-occlusion-intensity"),le=P.paint.get("model-color").constantOr(i.am.white).toNonPremultipliedRenderColor(null);return le.a=P.paint.get("model-color-mix-intensity").constantOr(0),{u_matrix:u,u_lighting_matrix:t,u_normal_matrix:o,u_node_matrix:h||Wu,u_lightpos:q,u_lightintensity:B.properties.get("intensity"),u_lightcolor:[re.r,re.g,re.b],u_camera_pos:k,u_opacity:_,u_baseTextureIsAlpha:0,u_alphaMask:+ee,u_alphaCutoff:M.alphaCutoff,u_baseColorFactor:v.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:E.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:T,u_roughnessFactor:C,u_baseColorTexture:zr.BaseColor,u_metallicRoughnessTexture:zr.MetallicRoughness,u_normalTexture:zr.Normal,u_occlusionTexture:zr.Occlusion,u_emissionTexture:zr.Emission,u_lutTexture:zr.LUT,u_color_mix:le.toArray01(),u_aoIntensity:ue,u_emissive_strength:O,u_occlusionTextureTransform:j||[0,0,0,0]}},hy=(u,t=Wu,o=Wu)=>({u_matrix:u,u_instance:t,u_node_matrix:o}),dy={fillExtrusion:u=>({u_matrix:new i.cc(u),u_lightpos:new i.c9(u),u_lightintensity:new i.ca(u),u_lightcolor:new i.c9(u),u_vertical_gradient:new i.ca(u),u_opacity:new i.ca(u),u_edge_radius:new i.ca(u),u_width_scale:new i.ca(u),u_ao:new i.cb(u),u_height_type:new i.c8(u),u_base_type:new i.c8(u),u_tile_id:new i.c9(u),u_zoom_transition:new i.ca(u),u_inv_rot_matrix:new i.cc(u),u_merc_center:new i.cb(u),u_up_dir:new i.c9(u),u_height_lift:new i.ca(u),u_flood_light_color:new i.c9(u),u_vertical_scale:new i.ca(u),u_flood_light_intensity:new i.ca(u),u_ground_shadow_factor:new i.c9(u)}),fillExtrusionDepth:u=>({u_matrix:new i.cc(u),u_edge_radius:new i.ca(u),u_width_scale:new i.ca(u),u_vertical_scale:new i.ca(u),u_height_type:new i.c8(u),u_base_type:new i.c8(u)}),fillExtrusionPattern:u=>({u_matrix:new i.cc(u),u_lightpos:new i.c9(u),u_lightintensity:new i.ca(u),u_lightcolor:new i.c9(u),u_vertical_gradient:new i.ca(u),u_height_factor:new i.ca(u),u_edge_radius:new i.ca(u),u_width_scale:new i.ca(u),u_ao:new i.cb(u),u_height_type:new i.c8(u),u_base_type:new i.c8(u),u_tile_id:new i.c9(u),u_zoom_transition:new i.ca(u),u_inv_rot_matrix:new i.cc(u),u_merc_center:new i.cb(u),u_up_dir:new i.c9(u),u_height_lift:new i.ca(u),u_image:new i.c8(u),u_texsize:new i.cb(u),u_pixel_coord_upper:new i.cb(u),u_pixel_coord_lower:new i.cb(u),u_tile_units_to_pixels:new i.ca(u),u_opacity:new i.ca(u),u_pattern_transition:new i.ca(u)}),fillExtrusionGroundEffect:u=>({u_matrix:new i.cc(u),u_opacity:new i.ca(u),u_ao_pass:new i.ca(u),u_meter_to_tile:new i.ca(u),u_ao:new i.cb(u),u_flood_light_intensity:new i.ca(u),u_flood_light_color:new i.c9(u),u_attenuation:new i.ca(u),u_edge_radius:new i.ca(u),u_fb:new i.c8(u),u_fb_size:new i.ca(u),u_dynamic_offset:new i.ca(u)}),fill:u=>({u_matrix:new i.cc(u),u_emissive_strength:new i.ca(u),u_ground_shadow_factor:new i.c9(u)}),fillPattern:u=>({u_matrix:new i.cc(u),u_emissive_strength:new i.ca(u),u_image:new i.c8(u),u_texsize:new i.cb(u),u_pixel_coord_upper:new i.cb(u),u_pixel_coord_lower:new i.cb(u),u_tile_units_to_pixels:new i.ca(u),u_ground_shadow_factor:new i.c9(u),u_pattern_transition:new i.ca(u)}),fillOutline:u=>({u_matrix:new i.cc(u),u_emissive_strength:new i.ca(u),u_world:new i.cb(u),u_ground_shadow_factor:new i.c9(u)}),fillOutlinePattern:u=>({u_matrix:new i.cc(u),u_emissive_strength:new i.ca(u),u_world:new i.cb(u),u_image:new i.c8(u),u_texsize:new i.cb(u),u_pixel_coord_upper:new i.cb(u),u_pixel_coord_lower:new i.cb(u),u_tile_units_to_pixels:new i.ca(u),u_ground_shadow_factor:new i.c9(u),u_pattern_transition:new i.ca(u)}),building:u=>({u_matrix:new i.cc(u),u_normal_matrix:new i.cc(u),u_opacity:new i.ca(u)}),buildingDepth:u=>({u_matrix:new i.cc(u)}),elevatedStructuresDepth:u=>({u_matrix:new i.cc(u),u_depth_bias:new i.ca(u)}),elevatedStructures:u=>({u_matrix:new i.cc(u),u_ground_shadow_factor:new i.c9(u)}),elevatedStructuresDepthReconstruct:u=>({u_matrix:new i.cc(u),u_camera_pos:new i.c9(u),u_depth_bias:new i.ca(u),u_height_scale:new i.ca(u),u_reset_depth:new i.ca(u)}),circle:i.dH,collisionBox:u=>({u_matrix:new i.cc(u),u_camera_to_center_distance:new i.ca(u),u_extrude_scale:new i.cb(u)}),collisionCircle:u=>({u_matrix:new i.cc(u),u_inv_matrix:new i.cc(u),u_camera_to_center_distance:new i.ca(u),u_viewport_size:new i.cb(u)}),debug:u=>({u_color:new i.di(u),u_matrix:new i.cc(u),u_overlay:new i.c8(u),u_overlay_scale:new i.ca(u)}),clippingMask:u=>({u_matrix:new i.cc(u)}),heatmap:u=>({u_extrude_scale:new i.ca(u),u_intensity:new i.ca(u),u_matrix:new i.cc(u),u_inv_rot_matrix:new i.cc(u),u_merc_center:new i.cb(u),u_tile_id:new i.c9(u),u_zoom_transition:new i.ca(u),u_up_dir:new i.c9(u)}),heatmapTexture:u=>({u_image:new i.c8(u),u_color_ramp:new i.c8(u),u_opacity:new i.ca(u)}),hillshade:u=>({u_matrix:new i.cc(u),u_image:new i.c8(u),u_latrange:new i.cb(u),u_light:new i.cb(u),u_shadow:new i.di(u),u_highlight:new i.di(u),u_emissive_strength:new i.ca(u),u_accent:new i.di(u)}),hillshadePrepare:u=>({u_matrix:new i.cc(u),u_image:new i.c8(u),u_dimension:new i.cb(u),u_zoom:new i.ca(u)}),line:i.dG,linePattern:i.dF,raster:u=>({u_matrix:new i.cc(u),u_normalize_matrix:new i.cc(u),u_globe_matrix:new i.cc(u),u_merc_matrix:new i.cc(u),u_grid_matrix:new i.dj(u),u_tl_parent:new i.cb(u),u_scale_parent:new i.ca(u),u_fade_t:new i.ca(u),u_opacity:new i.ca(u),u_image0:new i.c8(u),u_image1:new i.c8(u),u_brightness_low:new i.ca(u),u_brightness_high:new i.ca(u),u_saturation_factor:new i.ca(u),u_contrast_factor:new i.ca(u),u_spin_weights:new i.c9(u),u_perspective_transform:new i.cb(u),u_raster_elevation:new i.ca(u),u_zoom_transition:new i.ca(u),u_merc_center:new i.cb(u),u_cutoff_params:new i.cQ(u),u_colorization_mix:new i.cQ(u),u_colorization_offset:new i.ca(u),u_color_ramp:new i.c8(u),u_texture_offset:new i.cb(u),u_texture_res:new i.cb(u),u_emissive_strength:new i.ca(u)}),rasterParticle:u=>({u_matrix:new i.cc(u),u_normalize_matrix:new i.cc(u),u_globe_matrix:new i.cc(u),u_merc_matrix:new i.cc(u),u_grid_matrix:new i.dj(u),u_tl_parent:new i.cb(u),u_scale_parent:new i.ca(u),u_fade_t:new i.ca(u),u_opacity:new i.ca(u),u_image0:new i.c8(u),u_image1:new i.c8(u),u_raster_elevation:new i.ca(u),u_zoom_transition:new i.ca(u),u_merc_center:new i.cb(u),u_cutoff_params:new i.cQ(u)}),rasterParticleTexture:u=>({u_texture:new i.c8(u),u_opacity:new i.ca(u)}),rasterParticleDraw:u=>({u_particle_texture:new i.c8(u),u_particle_texture_side_len:new i.ca(u),u_tile_offset:new i.cb(u),u_velocity:new i.c8(u),u_color_ramp:new i.c8(u),u_velocity_res:new i.cb(u),u_max_speed:new i.ca(u),u_uv_offset:new i.cb(u),u_data_scale:new i.cb(u),u_data_offset:new i.ca(u),u_particle_pos_scale:new i.ca(u),u_particle_pos_offset:new i.cb(u)}),rasterParticleUpdate:u=>({u_particle_texture:new i.c8(u),u_particle_texture_side_len:new i.ca(u),u_velocity:new i.c8(u),u_velocity_res:new i.cb(u),u_max_speed:new i.ca(u),u_speed_factor:new i.ca(u),u_reset_rate:new i.ca(u),u_rand_seed:new i.ca(u),u_uv_offset:new i.cb(u),u_data_scale:new i.cb(u),u_data_offset:new i.ca(u),u_particle_pos_scale:new i.ca(u),u_particle_pos_offset:new i.cb(u)}),symbol:u=>({u_is_size_zoom_constant:new i.c8(u),u_is_size_feature_constant:new i.c8(u),u_size_t:new i.ca(u),u_size:new i.ca(u),u_camera_to_center_distance:new i.ca(u),u_rotate_symbol:new i.c8(u),u_aspect_ratio:new i.ca(u),u_fade_change:new i.ca(u),u_matrix:new i.cc(u),u_label_plane_matrix:new i.cc(u),u_coord_matrix:new i.cc(u),u_is_text:new i.c8(u),u_elevation_from_sea:new i.c8(u),u_pitch_with_map:new i.c8(u),u_texsize:new i.cb(u),u_texsize_icon:new i.cb(u),u_texture:new i.c8(u),u_texture_icon:new i.c8(u),u_gamma_scale:new i.ca(u),u_device_pixel_ratio:new i.ca(u),u_tile_id:new i.c9(u),u_zoom_transition:new i.ca(u),u_inv_rot_matrix:new i.cc(u),u_merc_center:new i.cb(u),u_camera_forward:new i.c9(u),u_tile_matrix:new i.cc(u),u_up_vector:new i.c9(u),u_ecef_origin:new i.c9(u),u_is_halo:new i.c8(u),u_icon_transition:new i.ca(u),u_color_adj_mat:new i.cc(u),u_scale_factor:new i.ca(u),u_ground_shadow_factor:new i.c9(u),u_inv_matrix:new i.cc(u),u_normal_scale:new i.ca(u)}),background:u=>({u_matrix:new i.cc(u),u_emissive_strength:new i.ca(u),u_opacity:new i.ca(u),u_color:new i.di(u)}),backgroundPattern:u=>({u_matrix:new i.cc(u),u_emissive_strength:new i.ca(u),u_opacity:new i.ca(u),u_image:new i.c8(u),u_pattern_tl:new i.cb(u),u_pattern_br:new i.cb(u),u_texsize:new i.cb(u),u_pattern_size:new i.cb(u),u_pixel_coord_upper:new i.cb(u),u_pixel_coord_lower:new i.cb(u),u_pattern_units_to_pixels:new i.cb(u)}),terrainRaster:u=>({u_matrix:new i.cc(u),u_image0:new i.c8(u),u_skirt_height:new i.ca(u),u_ground_shadow_factor:new i.c9(u)}),skybox:u=>({u_matrix:new i.cc(u),u_sun_direction:new i.c9(u),u_cubemap:new i.c8(u),u_opacity:new i.ca(u),u_temporal_offset:new i.ca(u)}),skyboxGradient:u=>({u_matrix:new i.cc(u),u_color_ramp:new i.c8(u),u_center_direction:new i.c9(u),u_radius:new i.ca(u),u_opacity:new i.ca(u),u_temporal_offset:new i.ca(u)}),skyboxCapture:u=>({u_matrix_3f:new i.dj(u),u_sun_direction:new i.c9(u),u_sun_intensity:new i.ca(u),u_color_tint_r:new i.cQ(u),u_color_tint_m:new i.cQ(u),u_luminance:new i.ca(u)}),globeRaster:u=>({u_proj_matrix:new i.cc(u),u_globe_matrix:new i.cc(u),u_normalize_matrix:new i.cc(u),u_merc_matrix:new i.cc(u),u_zoom_transition:new i.ca(u),u_merc_center:new i.cb(u),u_image0:new i.c8(u),u_grid_matrix:new i.dj(u),u_skirt_height:new i.ca(u),u_far_z_cutoff:new i.ca(u),u_frustum_tl:new i.c9(u),u_frustum_tr:new i.c9(u),u_frustum_br:new i.c9(u),u_frustum_bl:new i.c9(u),u_globe_pos:new i.c9(u),u_globe_radius:new i.ca(u),u_viewport:new i.cb(u)}),globeAtmosphere:u=>({u_frustum_tl:new i.c9(u),u_frustum_tr:new i.c9(u),u_frustum_br:new i.c9(u),u_frustum_bl:new i.c9(u),u_horizon:new i.ca(u),u_transition:new i.ca(u),u_fadeout_range:new i.ca(u),u_color:new i.cQ(u),u_high_color:new i.cQ(u),u_space_color:new i.cQ(u),u_temporal_offset:new i.ca(u),u_horizon_angle:new i.ca(u)}),model:u=>({u_matrix:new i.cc(u),u_lighting_matrix:new i.cc(u),u_normal_matrix:new i.cc(u),u_node_matrix:new i.cc(u),u_lightpos:new i.c9(u),u_lightintensity:new i.ca(u),u_lightcolor:new i.c9(u),u_camera_pos:new i.c9(u),u_opacity:new i.ca(u),u_baseColorFactor:new i.cQ(u),u_emissiveFactor:new i.cQ(u),u_metallicFactor:new i.ca(u),u_roughnessFactor:new i.ca(u),u_baseTextureIsAlpha:new i.c8(u),u_alphaMask:new i.c8(u),u_alphaCutoff:new i.ca(u),u_baseColorTexture:new i.c8(u),u_metallicRoughnessTexture:new i.c8(u),u_normalTexture:new i.c8(u),u_occlusionTexture:new i.c8(u),u_emissionTexture:new i.c8(u),u_lutTexture:new i.c8(u),u_color_mix:new i.cQ(u),u_aoIntensity:new i.ca(u),u_emissive_strength:new i.ca(u),u_occlusionTextureTransform:new i.cQ(u)}),modelDepth:u=>({u_matrix:new i.cc(u),u_instance:new i.cc(u),u_node_matrix:new i.cc(u)}),groundShadow:u=>({u_matrix:new i.cc(u),u_ground_shadow_factor:new i.c9(u)}),stars:u=>({u_matrix:new i.cc(u),u_up:new i.c9(u),u_right:new i.c9(u),u_intensity_multiplier:new i.ca(u)}),snowParticle:u=>({u_modelview:new i.cc(u),u_projection:new i.cc(u),u_time:new i.ca(u),u_cam_pos:new i.c9(u),u_velocityConeAperture:new i.ca(u),u_velocity:new i.ca(u),u_horizontalOscillationRadius:new i.ca(u),u_horizontalOscillationRate:new i.ca(u),u_boxSize:new i.ca(u),u_billboardSize:new i.ca(u),u_simpleShapeParameters:new i.cb(u),u_screenSize:new i.cb(u),u_thinningCenterPos:new i.cb(u),u_thinningShape:new i.c9(u),u_thinningAffectedRatio:new i.ca(u),u_thinningParticleOffset:new i.ca(u),u_particleColor:new i.cQ(u),u_direction:new i.c9(u)}),rainParticle:u=>({u_modelview:new i.cc(u),u_projection:new i.cc(u),u_time:new i.ca(u),u_cam_pos:new i.c9(u),u_texScreen:new i.c8(u),u_velocityConeAperture:new i.ca(u),u_velocity:new i.ca(u),u_boxSize:new i.ca(u),u_rainDropletSize:new i.cb(u),u_distortionStrength:new i.ca(u),u_rainDirection:new i.c9(u),u_color:new i.cQ(u),u_screenSize:new i.cb(u),u_thinningCenterPos:new i.cb(u),u_thinningShape:new i.c9(u),u_thinningAffectedRatio:new i.ca(u),u_thinningParticleOffset:new i.ca(u),u_shapeDirectionalPower:new i.ca(u),u_shapeNormalPower:new i.ca(u),u_mode:new i.ca(u)}),vignette:u=>({u_vignetteShape:new i.c9(u),u_vignetteColor:new i.cQ(u)}),occlusion:u=>({u_matrix:new i.cc(u),u_anchorPos:new i.c9(u),u_screenSizePx:new i.cb(u),u_occluderSizePx:new i.cb(u),u_color:new i.cQ(u)})},xc=(()=>{class u{constructor(o,h,m,_){this.id=u.uniqueIdxCounter,u.uniqueIdxCounter++,this.context=o;let v=o.gl;this.buffer=v.createBuffer(),this.dynamicDraw=!!m,this.context.unbindVAO(),o.bindElementBuffer.set(this.buffer),v.bufferData(v.ELEMENT_ARRAY_BUFFER,h.arrayBuffer,this.dynamicDraw?v.DYNAMIC_DRAW:v.STATIC_DRAW),this.dynamicDraw||_||h.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(o){this.id=u.uniqueIdxCounter,u.uniqueIdxCounter++;let h=this.context.gl;this.context.unbindVAO(),this.bind(),h.bufferSubData(h.ELEMENT_ARRAY_BUFFER,0,o.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}return u.uniqueIdxCounter=0,u})(),Yb={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Kb{constructor(t,o,h,m,_,v){this.length=o.length,this.attributes=h,this.itemSize=o.bytesPerElement,this.dynamicDraw=m,this.instanceCount=v,this.context=t;let E=t.gl;this.buffer=E.createBuffer(),t.bindVertexBuffer.set(this.buffer),E.bufferData(E.ARRAY_BUFFER,o.arrayBuffer,this.dynamicDraw?E.DYNAMIC_DRAW:E.STATIC_DRAW),this.dynamicDraw||_||o.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){let o=this.context.gl;this.bind(),o.bufferSubData(o.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,o){for(let h=0;h<this.attributes.length;h++){let m=o.attributes[this.attributes[h].name];m!==void 0&&t.enableVertexAttribArray(m)}}setVertexAttribPointers(t,o,h){for(let m=0;m<this.attributes.length;m++){let _=this.attributes[m],v=o.attributes[_.name];v!==void 0&&t.vertexAttribPointer(v,_.components,t[Yb[_.type]],!1,this.itemSize,_.offset+this.itemSize*(h||0))}}setVertexAttribDivisor(t,o,h){for(let m=0;m<this.attributes.length;m++){let _=o.attributes[this.attributes[m].name];_!==void 0&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(_,h)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class fm{constructor(t,o,h,m,_){this.context=t,this.width=o,this.height=h;let v=this.framebuffer=t.gl.createFramebuffer();m&&(this.colorAttachment=new ny(t,v)),_&&(this.depthAttachmentType=_,this.depthAttachment=_==="renderbuffer"?new iy(t,v):new Hb(t,v))}destroy(){let t=this.context.gl;if(this.colorAttachment){let o=this.colorAttachment.get();o&&t.deleteTexture(o)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){let o=this.depthAttachment.get();o&&t.deleteRenderbuffer(o)}else{let o=this.depthAttachment.get();o&&t.deleteTexture(o)}t.deleteFramebuffer(this.framebuffer)}}class Jb{constructor(t,o){this.gl=t,this.clearColor=new Z_(this),this.clearDepth=new Kp(this),this.clearStencil=new Nb(this),this.colorMask=new zb(this),this.depthMask=new Bb(this),this.stencilMask=new Vb(this),this.stencilFunc=new X_(this),this.stencilOp=new jb(this),this.stencilTest=new Td(this),this.depthRange=new Ub(this),this.depthTest=new Y_(this),this.depthFunc=new Jp(this),this.blend=new Id(this),this.blendFunc=new Qp(this),this.blendColor=new gl(this),this.blendEquation=new gc(this),this.cullFace=new Sd(this),this.cullFaceSide=new Dd(this),this.frontFace=new _c(this),this.program=new K_(this),this.activeTexture=new em(this),this.viewport=new J_(this),this.bindFramebuffer=new yc(this),this.bindRenderbuffer=new Cd(this),this.bindTexture=new Md(this),this.bindVertexBuffer=new tm(this),this.bindElementBuffer=new Ad(this),this.bindVertexArrayOES=new Uu(this),this.pixelStoreUnpack=new Q_(this),this.pixelStoreUnpackPremultiplyAlpha=new ey(this),this.pixelStoreUnpackFlipY=new ty(this),this.options=o?Object.assign({},o):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=o&&!!o.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxPointSize=t.getParameter(t.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,o,h){return new xc(this,t,o,h)}createVertexBuffer(t,o,h,m,_){return new Kb(this,t,o,h,m,_)}createRenderbuffer(t,o,h){let m=this.gl,_=m.createRenderbuffer();return this.bindRenderbuffer.set(_),m.renderbufferStorage(m.RENDERBUFFER,t,o,h),this.bindRenderbuffer.set(null),_}createFramebuffer(t,o,h,m){return new fm(this,t,o,h,m)}clear({color:t,depth:o,stencil:h,colorMask:m}){let _=this.gl,v=0;t&&(v|=_.COLOR_BUFFER_BIT,this.clearColor.set(t.toNonPremultipliedRenderColor(null)),this.colorMask.set(m||[!0,!0,!0,!0])),o!==void 0&&(v|=_.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(o),this.depthMask.set(!0)),h!==void 0&&(v|=_.STENCIL_BUFFER_BIT,this.clearStencil.set(h),this.stencilMask.set(255)),_.clear(v)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){i.bv(t.blendFunction,en.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let bc;function Bd(u,t,o,h,m,_,v){let E=u.context,T=E.gl,C=u.transform,M=u.getOrCreateProgram("collisionBox"),O=[],P=0,k=0;for(let re=0;re<h.length;re++){let ue=h[re],le=t.getTile(ue),se=le.getBucket(o);if(!se)continue;let oe=kt(ue,se,C),he=oe;m[0]===0&&m[1]===0||(he=u.translatePosMatrix(oe,le,m,_));let fe=v?se.textCollisionBox:se.iconCollisionBox,Te=se.collisionCircleArray;if(Te.length>0){let Ie=i.bz(),Be=he;i.cB(Ie,se.placementInvProjMatrix,C.glCoordMatrix),i.cB(Ie,Ie,se.placementViewportMatrix),O.push({circleArray:Te,circleOffset:k,transform:Be,invTransform:Ie,projection:se.getProjection()}),P+=Te.length/4,k=P}fe&&(u.terrain&&u.terrain.setupElevationDraw(le,M),M.draw(u,T.LINES,ft.disabled,Bt.disabled,u.colorModeForRenderPass(),Pt.disabled,Xb(he,C,le,se.getProjection()),o.id,fe.layoutVertexBuffer,fe.indexBuffer,fe.segments,null,C.zoom,null,[fe.collisionVertexBuffer,fe.collisionVertexBufferExt]))}if(!v||!O.length)return;let j=u.getOrCreateProgram("collisionCircle"),B=new i.dI;B.resize(4*P),B._trim();let U=0;for(let re of O)for(let ue=0;ue<re.circleArray.length/4;ue++){let le=4*ue,se=re.circleArray[le+0],oe=re.circleArray[le+1],he=re.circleArray[le+2],fe=re.circleArray[le+3];B.emplace(U++,se,oe,he,fe,0),B.emplace(U++,se,oe,he,fe,1),B.emplace(U++,se,oe,he,fe,2),B.emplace(U++,se,oe,he,fe,3)}(!bc||bc.length<2*P)&&(bc=function(re){let ue=2*re,le=new i.a_;le.resize(ue),le._trim();for(let se=0;se<ue;se++){let oe=6*se;le.uint16[oe+0]=4*se+0,le.uint16[oe+1]=4*se+1,le.uint16[oe+2]=4*se+2,le.uint16[oe+3]=4*se+2,le.uint16[oe+4]=4*se+3,le.uint16[oe+5]=4*se+0}return le}(P));let q=E.createIndexBuffer(bc,!0),Z=E.createVertexBuffer(B,i.dJ.members,!0);for(let re of O){let ue={u_matrix:re.transform,u_inv_matrix:re.invTransform,u_camera_to_center_distance:(ee=C).getCameraToCenterDistance(re.projection),u_viewport_size:[ee.width,ee.height]};j.draw(u,T.TRIANGLES,ft.disabled,Bt.disabled,u.colorModeForRenderPass(),Pt.disabled,ue,o.id,Z,q,i.bd.simpleSegment(0,2*re.circleOffset,re.circleArray.length,re.circleArray.length/2),null,C.zoom)}var ee;Z.destroy(),q.destroy()}let Vs=i.bz();function Xu(u){let t=u._camera.getWorldToCamera(u.worldSize,1),o=i.az([],t,u.globeMatrix);i.bi(o,o);let h=[0,0,0],m=[0,1,0,0];return i.aA(m,m,o),h[0]=m[0],h[1]=m[1],h[2]=m[2],i.au(h,h),h}function Yu({width:u,height:t,anchor:o,textOffset:h,textScale:m},_){let{horizontalAlign:v,verticalAlign:E}=i.bT(o),T=-(v-.5)*u,C=-(E-.5)*t,M=i.bU(o,h);return new i.P((T/m+M[0])*_,(C/m+M[1])*_)}function fy(u,t,o,h,m,_,v,E,T,C){let M=u.text.placedSymbolArray,O=u.text.dynamicLayoutVertexArray,P=u.icon.dynamicLayoutVertexArray,k={},j=u.getProjection(),B=pd(v,j,m),U=m.elevation,q=j.upVectorScale(v.canonical,m.center.lat,m.worldSize).metersToTile;O.clear();for(let Z=0;Z<M.length;Z++){let ee=M.get(Z),{tileAnchorX:re,tileAnchorY:ue,numGlyphs:le}=ee,se=ee.hidden||!ee.crossTileID||u.allowVerticalPlacement&&!ee.placedOrientation?null:h[ee.crossTileID];if(se){let oe=0,he=0,fe=0;if(U){let Ue=U?U.getAtTileOffset(v,re,ue):0,[Me,Ge,nt]=j.upVector(v.canonical,re,ue);oe=Ue*Me*q,he=Ue*Ge*q,fe=Ue*nt*q}let[Te,Ie,Be,Ve]=Yo(ee.projectedAnchorX+oe,ee.projectedAnchorY+he,ee.projectedAnchorZ+fe,o?B:_),We=Au(m.getCameraToCenterDistance(j),Ve),we=i.bJ(u.textSizeData,T,ee)*We/i.bO;o&&(we*=u.tilePixelRatio/E);let Oe=Yu(se,we);o?({x:Te,y:Ie,z:Be}=j.projectTilePoint(re+Oe.x,ue+Oe.y,v.canonical),[Te,Ie,Be]=Yo(Te+oe,Ie+he,Be+fe,_)):(t&&Oe._rotate(-m.angle),Te+=Oe.x,Ie+=Oe.y,Be=0);let _e=u.allowVerticalPlacement&&ee.placedOrientation===i.bI.vertical?Math.PI/2:0;for(let Ue=0;Ue<le;Ue++)i.bL(O,Te,Ie,Be,_e);C&&ee.associatedIconIndex>=0&&(k[ee.associatedIconIndex]={x:Te,y:Ie,z:Be,angle:_e})}else hl(le,O)}if(C){P.clear();let Z=u.icon.placedSymbolArray;for(let ee=0;ee<Z.length;ee++){let re=Z.get(ee),{numGlyphs:ue}=re,le=k[ee];if(re.hidden||!le)hl(ue,P);else{let{x:se,y:oe,z:he,angle:fe}=le;for(let Te=0;Te<ue;Te++)i.bL(P,se,oe,he,fe)}}u.icon.dynamicLayoutVertexBuffer.updateData(P)}u.text.dynamicLayoutVertexBuffer.updateData(O)}function wc(u,t,o,h,m,_,v={}){let E=o.paint.get("icon-translate"),T=o.paint.get("text-translate"),C=o.paint.get("icon-translate-anchor"),M=o.paint.get("text-translate-anchor"),O=o.layout.get("icon-rotation-alignment"),P=o.layout.get("text-rotation-alignment"),k=o.layout.get("icon-pitch-alignment"),j=o.layout.get("text-pitch-alignment"),B=o.layout.get("icon-keep-upright"),U=o.layout.get("text-keep-upright"),q=o.paint.get("icon-color-saturation"),Z=o.paint.get("icon-color-contrast"),ee=o.paint.get("icon-color-brightness-min"),re=o.paint.get("icon-color-brightness-max"),ue=o.layout.get("symbol-elevation-reference")==="sea",le=u.context,se=le.gl,oe=u.transform,he=O==="map",fe=P==="map",Te=k==="map",Ie=j==="map",Be=o.layout.get("symbol-sort-key").constantOr(1)!==void 0,Ve=!1,We=u.depthModeForSublayer(0,ft.ReadOnly),we=new ft(u.context.gl.LEQUAL,ft.ReadOnly,u.depthRangeFor3D),Oe=[i.aD(oe.center.lng),i.aH(oe.center.lat)],_e=o.layout.get("text-variable-anchor"),Ue=oe.projection.name==="globe",Me=[],Ge=[0,-1,0];for(let nt of h){let je=t.getTile(nt),et=je.getBucket(o);if(!et||et.projection.name==="mercator"&&Ue||et.fullyClipped)continue;let mt=et.projection.name==="globe",gt=mt?i.ah(oe.zoom):0,dt=pd(nt,et.getProjection(),oe),Et=oe.calculatePixelsToTileUnitsMatrix(je),St=_e&&et.hasTextData(),Ct=et.hasIconTextFit()&&St&&et.hasIconData(),Nt=et.getProjection().createInversionMatrix(oe,nt.canonical),Zt=(1<<je.tileID.canonical.z)*i.aj/u.transform.worldSize,Dn=Jn=>{let vn=[0,0,0];if(Jn){let Ti=u.style.directionalLight,dn=u.style.ambientLight;Ti&&dn&&(vn=pl(u.style,Ti,dn))}return vn},Kn=Jn=>{oe.depthOcclusionForSymbolsAndCircles&&(o.hasInitialOcclusionOpacityProperties||u.terrain)&&(Jn.push("DEPTH_D24"),Jn.push("DEPTH_OCCLUSION"))},Rn=()=>{let Jn=he&&o.layout.get("symbol-placement")!=="point",vn=[];Kn(vn);let Ti=Jn||Ct,dn=et.elevationType==="road"&&Te,zi=u.shadowRenderer,ii=dn&&!!zi&&zi.enabled,Wn=Dn(ii),ri=dn?we:We,wn=o.paint.get("icon-image-cross-fade");u.terrainRenderModeElevated()&&Te&&vn.push("PITCH_WITH_MAP_TERRAIN"),mt&&(vn.push("PROJECTION_GLOBE_VIEW"),Ti&&vn.push("PROJECTED_POS_ON_VIEWPORT")),wn>0&&vn.push("ICON_TRANSITION"),et.icon.zOffsetVertexBuffer&&vn.push("Z_OFFSET"),q===0&&Z===0&&ee===0&&re===1||vn.push("COLOR_ADJUSTMENT"),et.sdfIcons&&vn.push("RENDER_SDF"),ii&&vn.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),dn&&et.icon.orientationVertexBuffer&&vn.push("ELEVATED_ROADS");let Ci=et.icon.programConfigurations.get(o.id),ur=u.getOrCreateProgram("symbol",{config:Ci,defines:vn}),hi=je.imageAtlasTexture?je.imageAtlasTexture.size:[0,0],_n=et.iconSizeData,co=i.bH(_n,oe.zoom),Kr=Te||!oe.isOrthographic,Eo=Fs(dt,je.tileID.canonical,Te,he,oe,et.getProjection(),Et),es=hd(dt,je.tileID.canonical,Te,he,oe,et.getProjection(),Et),Bo=u.translatePosMatrix(es,je,E,C,!0),Jr=u.translatePosMatrix(dt,je,E,C),La=Ti?Vs:Eo,ts=he&&!Te&&!Jn,Oa=Ge;!Ue&&!oe.mercatorFromTransition||he||(Oa=Xu(oe));let fh=mt?Oa:Ge,Nm=o.getColorAdjustmentMatrix(q,Z,ee,re),Fc=qu(_n.kind,co,ts,Te,u,Jr,La,Bo,ue,!1,hi,[0,0],0,nt,gt,Oe,Nt,fh,et.getProjection(),Wn,Zt,Nm,wn,null),zm=je.imageAtlasTexture?je.imageAtlasTexture:null,ph=o.layout.get("icon-size").constantOr(0)!==1||et.iconsNeedLinear,of=et.sdfIcons||u.options.rotating||u.options.zooming||ph||Kr?se.LINEAR:se.NEAREST,sf=et.sdfIcons&&o.paint.get("icon-halo-width").constantOr(1)!==0,vs=u.terrain&&Te&&Jn?i.bi(i.bz(),Eo):Vs;if(Jn&&et.icon){let Nc=oe.elevation,Dl=Nc?Nc.getAtTileOffsetFunc(nt,oe.center.lat,oe.worldSize,et.getProjection()):null,ka=ud(dt,je.tileID.canonical,Te,he,oe,et.getProjection(),Et);dd(et,dt,u,!1,ka,es,Te,B,Dl,nt)}return{program:ur,buffers:et.icon,uniformValues:Fc,atlasTexture:zm,atlasTextureIcon:null,atlasInterpolation:of,atlasInterpolationIcon:null,isSDF:et.sdfIcons,hasHalo:sf,depthMode:ri,tile:je,renderWithShadows:ii,labelPlaneMatrixInv:vs}},kn=()=>{let Jn=fe&&o.layout.get("symbol-placement")!=="point",vn=[],Ti=Jn||_e||Ct,dn=et.elevationType==="road"&&Ie,zi=u.shadowRenderer,ii=dn&&!!zi&&zi.enabled,Wn=Dn(ii),ri=dn?we:We;u.terrainRenderModeElevated()&&Ie&&vn.push("PITCH_WITH_MAP_TERRAIN"),mt&&(vn.push("PROJECTION_GLOBE_VIEW"),Ti&&vn.push("PROJECTED_POS_ON_VIEWPORT")),et.text.zOffsetVertexBuffer&&vn.push("Z_OFFSET"),et.iconsInText&&vn.push("RENDER_TEXT_AND_SYMBOL"),vn.push("RENDER_SDF"),ii&&vn.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),dn&&et.text.orientationVertexBuffer&&vn.push("ELEVATED_ROADS"),Kn(vn);let wn=et.text.programConfigurations.get(o.id),Ci=u.getOrCreateProgram("symbol",{config:wn,defines:vn}),ur,hi=[0,0],_n=null,co=et.textSizeData;et.iconsInText&&(hi=je.imageAtlasTexture?je.imageAtlasTexture.size:[0,0],_n=je.imageAtlasTexture?je.imageAtlasTexture:null,ur=Ie||!oe.isOrthographic||u.options.rotating||u.options.zooming||co.kind==="composite"||co.kind==="camera"?se.LINEAR:se.NEAREST);let Kr=je.glyphAtlasTexture?je.glyphAtlasTexture.size:[0,0],Eo=o.layout.get("text-size-scale-range"),es=i.ay(u.scaleFactor,Eo[0],Eo[1]),Bo=i.bH(co,oe.zoom,es),Jr=Fs(dt,je.tileID.canonical,Ie,fe,oe,et.getProjection(),Et),La=hd(dt,je.tileID.canonical,Ie,fe,oe,et.getProjection(),Et),ts=u.translatePosMatrix(La,je,T,M,!0),Oa=u.translatePosMatrix(dt,je,T,M),fh=Ti?Vs:Jr,Nm=fe&&!Ie&&!Jn,Fc=Ge;!Ue&&!oe.mercatorFromTransition||fe||(Fc=Xu(oe));let zm=qu(co.kind,Bo,Nm,Ie,u,Oa,fh,ts,ue,!0,Kr,hi,0,nt,gt,Oe,Nt,mt?Fc:Ge,et.getProjection(),Wn,Zt,null,null,es),ph=je.glyphAtlasTexture?je.glyphAtlasTexture:null,of=se.LINEAR,sf=o.paint.get("text-halo-width").constantOr(1)!==0,vs=u.terrain&&Ie&&Jn?i.bi(i.bz(),Jr):Vs;if(Jn&&et.text){let Nc=oe.elevation,Dl=Nc?Nc.getAtTileOffsetFunc(nt,oe.center.lat,oe.worldSize,et.getProjection()):null,ka=ud(dt,je.tileID.canonical,Ie,fe,oe,et.getProjection(),Et);dd(et,dt,u,!0,ka,La,Ie,U,Dl,nt)}return{program:Ci,buffers:et.text,uniformValues:zm,atlasTexture:ph,atlasTextureIcon:_n,atlasInterpolation:of,atlasInterpolationIcon:ur,isSDF:!0,hasHalo:sf,depthMode:ri,tile:je,renderWithShadows:ii,labelPlaneMatrixInv:vs}},Pi=et.icon.segments.get().length,Ht=et.text.segments.get().length,Kt=Pi&&!v.onlyText?Rn():null,on=Ht&&!v.onlyIcons?kn():null,ni=o.paint.get("icon-opacity").constantOr(1),$i=o.paint.get("text-opacity").constantOr(1);if(Be&&et.canOverlap){Ve=!0;let Jn=ni&&!v.onlyText?et.icon.segments.get():[],vn=$i&&!v.onlyIcons?et.text.segments.get():[];for(let Ti of Jn)Me.push({segments:new i.bd([Ti]),sortKey:Ti.sortKey,state:Kt});for(let Ti of vn)Me.push({segments:new i.bd([Ti]),sortKey:Ti.sortKey,state:on})}else v.onlyText||Me.push({segments:ni?et.icon.segments:new i.bd([]),sortKey:0,state:Kt}),v.onlyIcons||Me.push({segments:$i?et.text.segments:new i.bd([]),sortKey:0,state:on})}Ve&&Me.sort((nt,je)=>nt.sortKey-je.sortKey);for(let nt of Me){let je=nt.state;if(je)if(u.terrain?u.terrain.setupElevationDraw(je.tile,je.program,{useDepthForOcclusion:oe.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:je.labelPlaneMatrixInv}):u.setupDepthForOcclusion(oe.depthOcclusionForSymbolsAndCircles,je.program),le.activeTexture.set(se.TEXTURE0),je.atlasTexture&&je.atlasTexture.bind(je.atlasInterpolation,se.CLAMP_TO_EDGE,!0),je.atlasTextureIcon&&(le.activeTexture.set(se.TEXTURE1),je.atlasTextureIcon&&je.atlasTextureIcon.bind(je.atlasInterpolationIcon,se.CLAMP_TO_EDGE,!0)),je.renderWithShadows&&u.shadowRenderer.setupShadows(je.tile.tileID.toUnwrapped(),je.program,"vector-tile",je.tile.tileID.overscaledZ),u.uploadCommonLightUniforms(u.context,je.program),je.hasHalo){let et=je.uniformValues;et.u_is_halo=1,Ec(je.buffers,nt.segments,o,u,je.program,je.depthMode,m,_,et,2),et.u_is_halo=0}else{if(je.isSDF){let et=je.uniformValues;je.hasHalo&&(et.u_is_halo=1,Ec(je.buffers,nt.segments,o,u,je.program,je.depthMode,m,_,et,1)),et.u_is_halo=0}Ec(je.buffers,nt.segments,o,u,je.program,je.depthMode,m,_,je.uniformValues,1)}}}function Ec(u,t,o,h,m,_,v,E,T,C){let M=[u.dynamicLayoutVertexBuffer,u.opacityVertexBuffer,u.iconTransitioningVertexBuffer,u.globeExtVertexBuffer,u.zOffsetVertexBuffer,u.orientationVertexBuffer];m.draw(h,h.context.gl.TRIANGLES,_,v,E,Pt.disabled,T,o.id,u.layoutVertexBuffer,u.indexBuffer,t,o.paint,h.transform.zoom,u.programConfigurations.get(o.id),M,C)}function Vd(u,t){let o=1<<u.canonical.z,h=(t.x*o-u.canonical.x-u.wrap*o)*i.aj,m=(t.y*o-u.canonical.y)*i.aj,_=i.dS(t.z,t.y);return i.cS(h,m,_)}function pm(u,t,o,h,m){if(!o.layout||o.layout.get("fill-elevation-reference")==="none")return;let _=u.context.gl,v=new ft(u.context.gl.LEQUAL,ft.ReadWrite,u.depthRangeFor3D),E=new ft(u.context.gl.GREATER,ft.ReadWrite,u.depthRangeFor3D),T=function(k){let j=i.cJ(k.pitch),B=.01;return k.isOrthographic&&(B=i.ai(1e-4,B,i.cN(j>=or?1:j/or))),2*B}(u.transform),C=u.transform.getFreeCameraOptions().position,M="elevatedStructuresDepthReconstruct",O=u.getOrCreateProgram(M,{defines:["DEPTH_RECONSTRUCTION"]}),P=u.getOrCreateProgram(M);for(let k of h){let j=t.getTile(k),B=j.getBucket(o);if(!B)continue;let U=B.elevatedStructures;if(!U)continue;let q=B.elevationBufferData.heightRange,Z=Vd(k.toUnwrapped(),C),ee=u.translatePosMatrix(k.projMatrix,j,o.paint.get("fill-translate"),o.paint.get("fill-translate-anchor")),re,ue,le,se;if(m==="initialize"){if(!q||q.min>=1||U.depthSegments.segments[0].primitiveLength===0)continue;re=Fd(ee,Z,T,1,0),ue=v,le=U.depthSegments,se=O}else if(m==="reset"){if(!q||q.min>=0||U.maskSegments.segments[0].primitiveLength===0)continue;re=Fd(ee,Z,0,0,1),ue=E,le=U.maskSegments,se=O}else if(m==="geometry"){if(U.depthSegments.segments[0].primitiveLength===0)continue;re=Fd(ee,Z,T,1,0),ue=v,le=U.depthSegments,se=P}se.draw(u,_.TRIANGLES,ue,Bt.disabled,en.disabled,Pt.disabled,re,o.id,U.vertexBuffer,U.indexBuffer,le,o.paint,u.transform.zoom)}}function mm(u,t,o){let{painter:h,sourceCache:m,layer:_,coords:v,colorMode:E,elevationType:T,terrainEnabled:C,pass:M}=u,O=h.context.gl,P=_.paint.get("fill-pattern"),k=_.paint.get("fill-pattern-cross-fade"),j=P.constantOr(null),B=T;T!=="road"||t&&!C||(B="none");let U=B==="road",q=u.painter.shadowRenderer,Z=U&&!!q&&q.enabled,ee=new ft(h.context.gl.LEQUAL,ft.ReadOnly,h.depthRangeFor3D),re=[0,0,0];if(Z){let se=h.style.directionalLight,oe=h.style.ambientLight;se&&oe&&(re=pl(h.style,se,oe))}let ue=P&&P.constantOr(1),le=(se,oe)=>{let he,fe,Te,Ie,Be;oe?(he=ue&&!_.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",Te=O.LINES):(he=ue?"fillPattern":"fill",Te=O.TRIANGLES);for(let Ve of v){let We=m.getTile(Ve);if(ue&&!We.patternsLoaded())continue;let we=We.getBucket(_);if(!we)continue;let Oe=t?we.elevationBufferData:we.bufferData;if(Oe.isEmpty())continue;h.prepareDrawTile();let _e=Oe.programConfigurations.get(_.id),Ue=h.isTileAffectedByFog(Ve),Me=[],Ge=[];U&&(Me.push("ELEVATED_ROADS"),Ge.push(Oe.elevatedLayoutVertexBuffer)),Z&&Me.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),ue&&(h.context.activeTexture.set(O.TEXTURE0),We.imageAtlasTexture&&We.imageAtlasTexture.bind(O.LINEAR,O.CLAMP_TO_EDGE),_e.updatePaintBuffers());let nt=!1;if(j&&We.imageAtlas){let dt=We.imageAtlas,Et=i.dN.from(j),St=Et.getPrimary().scaleSelf(i.q.devicePixelRatio).toString(),Ct=Et.getSecondary(),Nt=dt.patternPositions.get(St),Zt=Ct?dt.patternPositions.get(Ct.scaleSelf(i.q.devicePixelRatio).toString()):null;nt=!!Nt&&!!Zt,Nt&&_e.setConstantPatternPositions(Nt,Zt)}k>0&&(nt||_e.getPatternTransitionVertexBuffer("fill-pattern"))&&Me.push("FILL_PATTERN_TRANSITION");let je=h.getOrCreateProgram(he,{config:_e,overrideFog:Ue,defines:Me}),et=h.translatePosMatrix(Ve.projMatrix,We,_.paint.get("fill-translate"),_.paint.get("fill-translate-anchor"));Z&&q.setupShadows(We.tileID.toUnwrapped(),je,"vector-tile",We.tileID.overscaledZ);let mt=_.paint.get("fill-emissive-strength");if(oe){Ie=Oe.lineIndexBuffer,Be=Oe.lineSegments;let dt=h.terrain&&h.terrain.renderingToTexture?h.terrain.drapeBufferSize:[O.drawingBufferWidth,O.drawingBufferHeight];fe=he==="fillOutlinePattern"&&ue?Wb(et,mt,h,We,dt,re,k):qb(et,mt,dt,re)}else Ie=Oe.indexBuffer,Be=Oe.triangleSegments,fe=ue?ay(et,mt,h,We,re,k):vl(et,mt,re);h.uploadCommonUniforms(h.context,je,Ve.toUnwrapped());let gt=se;(T==="road"&&!C||T==="offset")&&(gt=ee),je.draw(h,Te,gt,o||h.stencilModeForClipping(Ve),E,Pt.disabled,fe,_.id,Oe.layoutVertexBuffer,Ie,Be,_.paint,h.transform.zoom,_e,Ge)}};h.renderPass===M&&le(h.depthModeForSublayer(1,h.renderPass==="opaque"?ft.ReadWrite:ft.ReadOnly),!1),B==="none"&&h.renderPass==="translucent"&&_.paint.get("fill-antialias")&&le(h.depthModeForSublayer(_.getPaintProperty("fill-outline-color")?2:0,ft.ReadOnly),!0)}function js(u,t,o,h,m,_,v,E){o.resetLayerRenderingStats(u);let T=u.context,C=T.gl,M=u.transform,O=o.paint.get("fill-extrusion-pattern"),P=o.paint.get("fill-extrusion-pattern-cross-fade"),k=O.constantOr(null),j=O.constantOr(1),B=o.paint.get("fill-extrusion-opacity"),U=u.style.enable3dLights(),q=o.paint.get(U&&!j?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),Z=[o.paint.get("fill-extrusion-ambient-occlusion-intensity"),q],ee=o.layout.get("fill-extrusion-edge-radius"),re=ee>0&&!o.paint.get("fill-extrusion-rounded-roof"),ue=re?0:ee,le=M.projection.name==="globe"?i.dV():0,se=M.projection.name==="globe",oe=se?i.ah(M.zoom):0,he=[i.aD(M.center.lng),i.aH(M.center.lat)],fe=o.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",Te=o.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(fe?null:o.lut).toArray01().slice(0,3),Ie=o.paint.get("fill-extrusion-flood-light-intensity"),Be=o.paint.get("fill-extrusion-vertical-scale"),Ve=o.paint.get("fill-extrusion-line-width").constantOr(1)!==0,We=o.paint.get("fill-extrusion-height-alignment"),we=o.paint.get("fill-extrusion-base-alignment"),Oe=ps(u,o.paint.get("fill-extrusion-cutoff-fade-range")),_e=[],Ue;se&&_e.push("PROJECTION_GLOBE_VIEW"),Z[0]>0&&_e.push("FAUX_AO"),re&&_e.push("ZERO_ROOF_RADIUS"),E&&_e.push("HAS_CENTROID"),Ie>0&&_e.push("FLOOD_LIGHT"),Oe.shouldRenderCutoff&&_e.push("RENDER_CUTOFF"),Ve&&_e.push("RENDER_WALL_MODE");let Me=u.renderPass==="shadow",Ge=u.shadowRenderer,nt=Me&&!!Ge,je=Me?Pt.disabled:Pt.backCCW;u.shadowRenderer&&(u.shadowRenderer.useNormalOffset=!0);let et=[0,0,0];if(Ge){let dt=u.style.directionalLight,Et=u.style.ambientLight;dt&&Et&&(et=pl(u.style,dt,Et)),Me||(_e.push("RENDER_SHADOWS","DEPTH_TEXTURE"),Ge.useNormalOffset&&_e.push("NORMAL_OFFSET")),Ue=_e.concat(["SHADOWS_SINGLE_CASCADE"])}let mt=nt?"fillExtrusionDepth":j?"fillExtrusionPattern":"fillExtrusion",gt=o.getLayerRenderingStats();for(let dt of h){let Et=t.getTile(dt),St=Et.getBucket(o);if(!St||St.projection.name!==M.projection.name)continue;let Ct=!1;Ge&&(Ct=Ge.getMaxCascadeForTile(dt.toUnwrapped())===0);let Nt=u.isTileAffectedByFog(dt),Zt=St.programConfigurations.get(o.id),Dn=!1;if(k&&Et.imageAtlas){let on=Et.imageAtlas,ni=i.dN.from(k),$i=ni.getPrimary().scaleSelf(i.q.devicePixelRatio).toString(),Jn=ni.getSecondary(),vn=on.patternPositions.get($i),Ti=Jn?on.patternPositions.get(Jn.scaleSelf(i.q.devicePixelRatio).toString()):null;Dn=!!vn&&!!Ti,vn&&Zt.setConstantPatternPositions(vn,Ti)}P>0&&(Dn||Zt.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&_e.push("FILL_EXTRUSION_PATTERN_TRANSITION");let Kn=u.getOrCreateProgram(mt,{config:Zt,defines:Ct?Ue:_e,overrideFog:Nt});if(u.terrain&&u.terrain.setupElevationDraw(Et,Kn,{useMeterToDem:!0}),!St.centroidVertexBuffer){let on=Kn.attributes.a_centroid_pos;on!==void 0&&C.vertexAttrib2f(on,0,0)}!Me&&Ge&&Ge.setupShadows(Et.tileID.toUnwrapped(),Kn,"vector-tile",Et.tileID.overscaledZ),j&&(u.context.activeTexture.set(C.TEXTURE0),Et.imageAtlasTexture&&Et.imageAtlasTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),Zt.updatePaintBuffers());let Rn=o.paint.get("fill-extrusion-vertical-gradient"),kn=1/St.tileToMeter,Pi;if(Me&&Ge){if(Sa(Et.tileID,St,u))continue;let on=Ge.calculateShadowPassMatrixFromTile(Et.tileID.toUnwrapped());Pi=oy(on,ue,kn,Be,We,we)}else{let on=u.translatePosMatrix(dt.expandedProjMatrix,Et,o.paint.get("fill-extrusion-translate"),o.paint.get("fill-extrusion-translate-anchor")),ni=M.projection.createInversionMatrix(M,dt.canonical);Pi=j?sy(on,u,Rn,B,Z,ue,kn,dt,Et,le,We,we,oe,he,ni,Te,Be,P):Gu(on,u,Rn,B,Z,ue,kn,dt,le,We,we,oe,he,ni,Te,Be,Ie,et)}u.uploadCommonUniforms(T,Kn,dt.toUnwrapped(),null,Oe);let Ht=St.segments;if(M.projection.name==="mercator"&&!Me&&(Ht=St.getVisibleSegments(Et.tileID,u.terrain,u.transform.getFrustum(0)),!Ht.get().length))continue;if(gt)if(Me)for(let on of Ht.get())gt.numRenderedVerticesInShadowPass+=on.primitiveLength;else for(let on of Ht.get())gt.numRenderedVerticesInTransparentPass+=on.primitiveLength;let Kt=[];(u.terrain||E)&&Kt.push(St.centroidVertexBuffer),se&&Kt.push(St.layoutVertexExtBuffer),Ve&&Kt.push(St.wallVertexBuffer),Kn.draw(u,T.gl.TRIANGLES,m,_,v,je,Pi,o.id,St.layoutVertexBuffer,St.indexBuffer,Ht,o.paint,u.transform.zoom,Zt,Kt)}u.shadowRenderer&&(u.shadowRenderer.useNormalOffset=!1)}function Us(u,t,o,h,m,_,v,E,T,C,M,O,P,k,j,B,U,q,Z){let ee=u.context,re=ee.gl,ue=u.transform,le=u.transform.zoom,se=[],oe=ps(u,o.paint.get("fill-extrusion-cutoff-fade-range"));C==="clear"?(se.push("CLEAR_SUBPASS"),Z&&(se.push("CLEAR_FROM_TEXTURE"),ee.activeTexture.set(re.TEXTURE0),Z.bind(re.LINEAR,re.CLAMP_TO_EDGE))):C==="sdf"&&se.push("SDF_SUBPASS"),U&&se.push("HAS_CENTROID"),oe.shouldRenderCutoff&&se.push("RENDER_CUTOFF");let he=o.layout.get("fill-extrusion-edge-radius"),fe=(Te,Ie,Be,Ve,We)=>{let we=Ie.programConfigurations.get(o.id),Oe=u.isTileAffectedByFog(Te),_e=u.getOrCreateProgram("fillExtrusionGroundEffect",{config:we,defines:se,overrideFog:Oe}),Ue=((Ge,nt,je,et,mt,gt,dt,Et,St,Ct,Nt)=>({u_matrix:nt,u_opacity:je,u_ao_pass:et?1:0,u_meter_to_tile:mt,u_ao:gt,u_flood_light_intensity:dt,u_flood_light_color:Et,u_attenuation:St,u_edge_radius:Ct,u_fb:0,u_fb_size:Nt,u_dynamic_offset:1}))(0,Ve,M,T,We,[O,P*We],k,j,B,le>=17?0:he*We,Z?Z.size[0]:0),Me=[];U&&Me.push(Ie.hiddenByLandmarkVertexBuffer),u.uploadCommonUniforms(ee,_e,Te.toUnwrapped(),null,oe),_e.draw(u,ee.gl.TRIANGLES,m,_,v,E,Ue,o.id,Ie.vertexBuffer,Ie.indexBuffer,Be,o.paint,le,we,Me)};for(let Te of h){let Ie=t.getTile(Te),Be=Ie.getBucket(o);if(!Be||Be.projection.name!==ue.projection.name||!Be.groundEffect||Be.groundEffect&&!Be.groundEffect.hasData())continue;let Ve=Be.groundEffect,We=1/Be.tileToMeter;{let we=u.translatePosMatrix(Te.projMatrix,Ie,o.paint.get("fill-extrusion-translate"),o.paint.get("fill-extrusion-translate-anchor")),Oe=Ve.getDefaultSegment();fe(Te,Ve,Oe,we,We)}if(q)for(let we=0;we<4;we++){let Oe=i.dT[we](Te),_e=t.getTile(Oe);if(!_e)continue;let Ue=_e.getBucket(o);if(!Ue||Ue.projection.name!==ue.projection.name||!Ue.groundEffect||Ue.groundEffect&&!Ue.groundEffect.hasData())continue;let Me=Ue.groundEffect,Ge,nt;we===0?(Ge=[-8192,0,0],nt=1):we===1?(Ge=[i.aj,0,0],nt=0):we===2?(Ge=[0,-8192,0],nt=3):(Ge=[0,i.aj,0],nt=2);let je=Me.regionSegments[nt];if(!je)continue;let et=new Float32Array(16);i.bo(et,Te.projMatrix,Ge),fe(Te,Me,je,u.translatePosMatrix(et,Ie,o.paint.get("fill-extrusion-translate"),o.paint.get("fill-extrusion-translate-anchor")),We)}}}function pt(u,t,o,h,m,_,v){h.centroidVertexArray.length===0&&h.createCentroidsBuffer();let E=_?_.findDEMTileFor(o):null;if(!(E&&E.dem||v))return;_&&E&&E.dem&&h.selfDEMTileTimestamp!==E.dem._timestamp&&(h.borderDoneWithNeighborZ=[-1,-1,-1,-1],h.selfDEMTileTimestamp=E.dem._timestamp);let T=q=>new i.P(Math.ceil((q+i.dX)*i.dY),0),C=q=>{let Z=t.getSource().minzoom,ee=ue=>{let le=t.getTileByID(ue);if(le&&le.hasData())return le.getBucket(m)},re=[0,-1,1];for(let ue of re){if(q.overscaledZ+ue<Z)continue;let le=ee(q.calculateScaledKey(q.overscaledZ+ue));if(le)return le}},M=[0,0,0],O=(q,Z)=>(M[0]=Math.min(q.min.y,Z.min.y),M[1]=Math.max(q.max.y,Z.max.y),M[2]=i.aj-Z.min.x>q.max.x?Z.min.x-i.aj:q.max.x,M),P=(q,Z)=>(M[0]=Math.min(q.min.x,Z.min.x),M[1]=Math.max(q.max.x,Z.max.x),M[2]=i.aj-Z.min.y>q.max.y?Z.min.y-i.aj:q.max.y,M),k=[(q,Z)=>O(q,Z),(q,Z)=>O(Z,q),(q,Z)=>P(q,Z),(q,Z)=>P(Z,q)],j=(q,Z,ee,re,ue,le,se)=>{if(!_)return 0;let oe=[[le?ee:q,le?q:ee,0],[le?ee:Z,le?Z:ee,0]],he=se<0?i.aj+se:se,fe=[le?he:(q+Z)/2,le?(q+Z)/2:he,0];return ee===0&&se<0||ee!==0&&se>0?_.getForTilePoints(ue,[fe],!0,re):oe.push(fe),_.getForTilePoints(o,oe,!0,E),Math.max(oe[0][2],oe[1][2],fe[2])/_.exaggeration()};for(let q=0;q<4;q++){let Z=h.borderFeatureIndices[q];if(Z.length===0)continue;let ee=i.dT[q](o),re=C(ee);if(!(re&&re instanceof i.dU))continue;let ue=_?_.findDEMTileFor(ee):null;if(!(ue&&ue.dem||v)||(_&&ue&&ue.dem&&h.borderDEMTileTimestamp[q]!==ue.dem._timestamp&&(h.borderDoneWithNeighborZ[q]=-1,h.borderDEMTileTimestamp[q]=ue.dem._timestamp),h.borderDoneWithNeighborZ[q]===re.canonical.z))continue;re.centroidVertexArray.length===0&&re.createCentroidsBuffer();let le=(q<2?1:5)-q,se=re.borderDoneWithNeighborZ[le]!==h.canonical.z,oe=re.borderFeatureIndices[le],he=0;if(h.canonical.z!==re.canonical.z){for(let fe of Z)h.showCentroid(h.featuresOnBorder[fe]);if(se)for(let fe of oe)re.showCentroid(re.featuresOnBorder[fe]);h.borderDoneWithNeighborZ[q]=re.canonical.z,re.borderDoneWithNeighborZ[le]=h.canonical.z}for(let fe of Z){let Te=h.featuresOnBorder[fe],Ie=h.centroidData[Te.centroidDataIndex],Be=Te.borders[q],Ve;for(;he<oe.length;){Ve=re.featuresOnBorder[oe[he]];let We=Ve.borders[le];if(We[1]>Be[0]+3||We[0]>Be[0]-3)break;re.showCentroid(Ve),he++}if(Ve&&he<oe.length){let We=he,we=0;for(;!(Ve.borders[le][0]>Be[1]-3)&&(we++,++he!==oe.length);)Ve=re.featuresOnBorder[oe[he]];Ve=re.featuresOnBorder[oe[We]];let Oe=!1;if(we>=1){let Me=Ve.borders[le];Math.abs(Be[0]-Me[0])<3&&Math.abs(Be[1]-Me[1])<3&&(we=1,Oe=!0,he=We+1)}else if(we===0){h.showCentroid(Te);continue}let _e=re.centroidData[Ve.centroidDataIndex];v&&Oe&&(((B=Ie).flags|(U=_e).flags)&i.dW?(B.flags|=i.dW,U.flags|=i.dW):(B.flags&=2147483647,U.flags&=2147483647));let Ue=Te.intersectsCount()>1||Ve.intersectsCount()>1;if(we>1)he=We,Ie.centroidXY=_e.centroidXY=new i.P(0,0);else if(ue&&ue.dem&&!Ue){let Me=k[q](Ie,_e),Ge=q%2?i.aj-1:0,nt=j(Me[0],Math.min(i.aj-1,Me[1]),Ge,ue,ee,q<2,Me[2]);Ie.centroidXY=_e.centroidXY=T(nt)}else Ue?Ie.centroidXY=_e.centroidXY=new i.P(0,0):(Ie.centroidXY=h.encodeBorderCentroid(Te),_e.centroidXY=re.encodeBorderCentroid(Ve));h.writeCentroidToBuffer(Ie),re.writeCentroidToBuffer(_e)}else h.showCentroid(Te)}h.borderDoneWithNeighborZ[q]=re.canonical.z,re.borderDoneWithNeighborZ[le]=h.canonical.z}var B,U;(h.needsCentroidUpdate||!h.centroidVertexBuffer&&h.centroidVertexArray.length!==0)&&h.uploadCentroid(u)}let py=[1,0,0],my=[0,1,0],Ia=[0,0,1];function Sa(u,t,o){let h=o.transform,m=o.shadowRenderer;if(!m)return!0;let _=u.toUnwrapped(),v=h.tileSize*m._cascades[o.currentShadowCascade].scale,E=t.maxHeight;if(h.elevation){let B=h.elevation.getMinMaxForTile(u);B&&(E+=B.max)}let T=[...m.shadowDirection];T[2]=-T[2];let C=m.computeSimplifiedTileShadowVolume(_,E,v,T);if(!C)return!1;let M=[py,my,Ia,T,[T[0],0,T[2]],[0,T[1],T[2]]],O=h.projection.name==="globe",P=h.scaleZoom(v),k=i.cn.fromInvProjectionMatrix(h.invProjMatrix,h.worldSize,P,!O),j=m.getCurrentCascadeFrustum();return k.intersectsPrecise(C.vertices,C.planes,M)===0||j.intersectsPrecise(C.vertices,C.planes,M)===0}function Mt(u){return[u[0]*i.dZ,u[1]*i.dZ,u[2]*i.dZ,0]}function Ku(u,t,o,h,m,_,v,E,T){let C=h.getSource(),M=o.globeSharedBuffers;if(!M)return;let O,P,k;if(t&&(O=h.getTile(t)),C instanceof i.aP?(P=C.texture,k=i.ds(0,0,o.transform)):O&&t&&(P=O.texture,k=i.ds(t.canonical.z,t.canonical.x,o.transform)),!P||!k)return;u||(k=i.cE(i.bz(),k,[1,-1,1]));let j=o.context,B=j.gl,U=m.paint.get("raster-resampling")==="nearest"?B.NEAREST:B.LINEAR,q=o.colorModeForDrapableLayerRenderPass(_),Z=v.defines;Z.push("GLOBE_POLES");let ee=new ft(B.LEQUAL,ft.ReadWrite,o.depthRangeFor3D),re=Float32Array.from(o.transform.expandedFarZProjMatrix),ue=Float32Array.from(i.bh(i.dr(new i.cp(0,0,0))));o.terrain&&o.terrain.prepareDrawTile(),j.activeTexture.set(B.TEXTURE0),P.bind(U,B.CLAMP_TO_EDGE),j.activeTexture.set(B.TEXTURE1),P.bind(U,B.CLAMP_TO_EDGE),"useMipmap"in P&&j.extTextureFilterAnisotropic&&o.transform.pitch>20&&B.texParameterf(B.TEXTURE_2D,j.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,j.extTextureFilterAnisotropicMax);let[le,se,oe,he]=t?M.getPoleBuffers(t.canonical.z,!1):M.getPoleBuffers(0,!0),fe=m.paint.get("raster-elevation"),Te;u?(Te=le,o.renderDefaultNorthPole=fe!==0):(Te=se,o.renderDefaultSouthPole=fe!==0);let Ie=Mt(v.mix),Be=((We,we,Oe,_e,Ue,Me,Ge,nt,je,et,mt,gt,dt)=>um(We,we,Oe,new Float32Array(16),new Float32Array(9),[0,0],_e,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Me,[0,0],nt,2,et,mt,gt,1,0,dt))(re,ue,k,i.ah(o.transform.zoom),0,m,0,fe,0,Ie,v.offset,v.range,_),Ve=o.getOrCreateProgram("raster",{defines:Z});o.uploadCommonUniforms(j,Ve,null),Ve.draw(o,B.TRIANGLES,ee,T,q,E,Be,m.id,Te,oe,he)}function Qb(u){let t=u._nearZ,o=u.projection.farthestPixelDistance(u),h=o-t,m=.2*u.height,_=t+m;return[t,o,(_-m-t)/h,(_-t)/h]}function e1(u,t,o,h){if(u)return t instanceof ga&&u instanceof tc?t.getTextureDescriptor(u,o,!0):{texture:u.texture,mix:Mt(h.mix),offset:h.offset,buffer:0,tileSize:1}}var gm=i.d_([{name:"a_index",type:"Int16",components:1}]);class gy{constructor(t,o,h,m){let _={width:h[0],height:h[1],data:null},v=t.gl;this.targetColorTexture=new i.T(t,_,v.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new i.T(t,_,v.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(o,m),this.lastInvalidatedAt=0}updateParticleTexture(t,o){if(this.particleTextureDimension===o.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());let h=this.context.gl,m=o.width*o.height;this.particleTexture0=new i.T(this.context,o,h.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new i.T(this.context,o,h.RGBA8,{premultiply:!1,useMipmap:!1});let _=new i.d$;_.reserve(m);for(let v=0;v<m;v++)_.emplaceBack(v);this.particleIndexBuffer=this.context.createVertexBuffer(_,gm.members,!0),this.particleSegment=i.bd.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=o.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=i.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function t1(u,t,o){if(!u)return null;let h=t.getTextureDescriptor(u,o,!0);if(!h)return null;let{texture:m,mix:_,offset:v,tileSize:E,buffer:T,format:C}=h;if(!m||!C)return null;let M=!1;return C==="uint32"&&(M=!0,_[3]=0,_=xl(i.e0,_,[0,o.paint.get("raster-particle-max-speed")]),v=cm(i.e0,v,[0,o.paint.get("raster-particle-max-speed")])),{texture:m,textureOffset:[T/(E+2*T),E/(E+2*T)],tileSize:E,scalarData:M,scale:_,offset:v,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[C]]}}function _y(u){let t=u._nearZ,o=u.projection.farthestPixelDistance(u),h=o-t,m=.2*u.height,_=t+m;return[t,o,(_-m-t)/h,(_-t)/h]}let n1=new i.am(1,0,0,1),i1=new i.am(0,1,0,1),lo=new i.am(0,0,1,1),_m=new i.am(1,0,1,1),Br=new i.am(0,1,1,1);function Hs(u,t,o,h,m,_){for(let v=0;v<o.length;v++)if(m){let C=new i.am(h.r*.8,h.g*.8,h.b*.8,1);wl(u,t,o[v],h,-1,-1,_),wl(u,t,o[v],h,-1,1,_),wl(u,t,o[v],h,1,1,_),wl(u,t,o[v],h,1,-1,_),wl(u,t,o[v],C,0,0,_)}else wl(u,t,o[v],h,0,0,_)}function wl(u,t,o,h,m,_,v){let E=u.context,T=u.transform,C=E.gl,M=T.projection.name==="globe",O=M?["PROJECTION_GLOBE_VIEW"]:[],P=i.bw(o.projMatrix);if(M&&i.ah(T.zoom)>0){let Ie=i.bg(o.canonical,T),Be=i.e1(Ie);P=i.az(new Float32Array(16),T.globeMatrix,Be),i.az(P,T.projMatrix,P)}let k=i.bz();k[12]+=2*m/(i.q.devicePixelRatio*T.width),k[13]+=2*_/(i.q.devicePixelRatio*T.height),i.az(P,k,P);let j=u.getOrCreateProgram("debug",{defines:O}),B=t.getTileByID(o.key);u.terrain&&u.terrain.setupElevationDraw(B,j);let U=ft.disabled,q=Bt.disabled,Z=u.colorModeForRenderPass(),ee="$debug";E.activeTexture.set(C.TEXTURE0),u.emptyTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),M?B._makeGlobeTileDebugBuffers(u.context,T):B._makeDebugTileBoundsBuffers(u.context,T.projection);let re=B._tileDebugBuffer||u.debugBuffer,ue=B._tileDebugIndexBuffer||u.debugIndexBuffer,le=B._tileDebugSegments||u.debugSegments;if(j.draw(u,C.LINE_STRIP,U,q,Z,Pt.disabled,Nd(P,h.toPremultipliedRenderColor(null)),ee,re,ue,le,null,null,null,[B._globeTileDebugBorderBuffer]),v){let Ie=B.latestRawTileData,Be=Math.floor((Ie&&Ie.byteLength||0)/1024),Ve=o.canonical.toString();o.overscaledZ!==o.canonical.z&&(Ve+=` => ${o.overscaledZ}`),Ve+=` ${B.state}`,Ve+=` ${Be}kb`,function(We,we){We.initDebugOverlayCanvas();let Oe=We.debugOverlayCanvas,_e=We.context.gl,Ue=We.debugOverlayCanvas.getContext("2d");Ue.clearRect(0,0,Oe.width,Oe.height),Ue.shadowColor="white",Ue.shadowBlur=2,Ue.lineWidth=1.5,Ue.strokeStyle="white",Ue.textBaseline="top",Ue.font="bold 36px Open Sans, sans-serif",Ue.fillText(we,5,5),Ue.strokeText(we,5,5),We.debugOverlayTexture.update(Oe),We.debugOverlayTexture.bind(_e.LINEAR,_e.CLAMP_TO_EDGE)}(u,Ve)}let se=t.getTile(o).tileSize,oe=512/Math.min(se,512)*(o.overscaledZ/T.zoom)*.5,he=B._tileDebugTextBuffer||u.debugBuffer,fe=B._tileDebugTextIndexBuffer||u.quadTriangleIndexBuffer,Te=B._tileDebugTextSegments||u.debugSegments;j.draw(u,C.TRIANGLES,U,q,en.alphaBlended,Pt.disabled,Nd(P,i.am.transparent.toPremultipliedRenderColor(null),oe),ee,he,fe,Te,null,null,null,[B._globeTileDebugTextBuffer])}function jd(u,t,o,h){Tc(u,0,t+o/2,u.transform.width,o,h)}function Ud(u,t,o,h){Tc(u,t-o/2,0,o,u.transform.height,h)}function Tc(u,t,o,h,m,_){let v=u.context,E=v.gl;E.enable(E.SCISSOR_TEST),E.scissor(t*i.q.devicePixelRatio,o*i.q.devicePixelRatio,h*i.q.devicePixelRatio,m*i.q.devicePixelRatio),v.clear({color:_}),E.disable(E.SCISSOR_TEST)}let yy=i.d_([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:$s}=yy;function zn(u,t,o,h){u.emplaceBack(t,o,h)}class Ju{constructor(t){this.vertexArray=new i.e2,this.indices=new i.a_,zn(this.vertexArray,-1,-1,1),zn(this.vertexArray,1,-1,1),zn(this.vertexArray,-1,1,1),zn(this.vertexArray,1,1,1),zn(this.vertexArray,-1,-1,-1),zn(this.vertexArray,1,-1,-1),zn(this.vertexArray,-1,1,-1),zn(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,$s),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=i.bd.simpleSegment(0,0,36,12)}}function Da(u,t,o,h,m,_){let v=u.context.gl,E=t.paint.get("sky-atmosphere-color"),T=t.paint.get("sky-atmosphere-halo-color"),C=t.paint.get("sky-atmosphere-sun-intensity"),M=((O,P,k,j,B)=>({u_matrix_3f:O,u_sun_direction:P,u_sun_intensity:k,u_color_tint_r:[j.r,j.g,j.b,j.a],u_color_tint_m:[B.r,B.g,B.b,B.a],u_luminance:5e-5}))(i.e4(i.dx(),h),m,C,E.toPremultipliedRenderColor(null),T.toPremultipliedRenderColor(null));v.framebufferTexture2D(v.FRAMEBUFFER,v.COLOR_ATTACHMENT0,v.TEXTURE_CUBE_MAP_POSITIVE_X+_,t.skyboxTexture,0),o.draw(u,v.TRIANGLES,ft.disabled,Bt.disabled,en.unblended,Pt.frontCW,M,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}let vy=i.d_([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class xy{constructor(t){let o=new i.e5;o.emplaceBack(-1,1,1,0,0),o.emplaceBack(1,1,1,1,0),o.emplaceBack(1,-1,1,1,1),o.emplaceBack(-1,-1,1,0,1);let h=new i.a_;h.emplaceBack(0,1,2),h.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(o,vy.members),this.indexBuffer=t.createIndexBuffer(h),this.segments=i.bd.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}let by=i.d_([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class r1{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class Ic{constructor(t){this.colorModeAlphaBlendedWriteRGB=new en([1,fl,1,fl],i.am.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new en([1,0,1,0],i.am.transparent,[!1,!1,!1,!0]),this.params=new r1,this.updateNeeded=!0,t.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),t.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(t){let o=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new xy(o);let h=this.params.sizeRange,m=this.params.intensityRange,_=function(M){let O=i.e7(30),P=[];for(let k=0;k<M;++k){let j=2*Math.PI*O(),B=Math.acos(1-2*O())-.5*Math.PI;P.push(i.cS(Math.cos(B)*Math.cos(j),Math.cos(B)*Math.sin(j),Math.sin(B)))}return P}(this.params.starsCount),v=i.e7(300),E=new i.e6,T=new i.a_,C=0;for(let M=0;M<_.length;++M){let O=i.bY([],_[M],200),P=Math.max(0,1+.01*h*(1*v()-.5)),k=Math.max(0,1+.01*m*(1*v()-.5));E.emplaceBack(O[0],O[1],O[2],-1,-1,P,k),E.emplaceBack(O[0],O[1],O[2],1,-1,P,k),E.emplaceBack(O[0],O[1],O[2],1,1,P,k),E.emplaceBack(O[0],O[1],O[2],-1,1,P,k),T.emplaceBack(C+0,C+1,C+2),T.emplaceBack(C+0,C+2,C+3),C+=4}this.starsVx=o.createVertexBuffer(E,by.members),this.starsIdx=o.createIndexBuffer(T),this.starsSegments=i.bd.simpleSegment(0,0,E.length,T.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,o){let h=t.context,m=h.gl,_=t.transform,v=new ft(m.LEQUAL,ft.ReadOnly,[0,1]),E=i.ah(_.zoom),T=t.style.getLut(o.scope),C=o.properties.get("color-use-theme")==="none",M=o.properties.get("color").toNonPremultipliedRenderColor(C?null:T).toArray01(),O=o.properties.get("high-color-use-theme")==="none",P=o.properties.get("high-color").toNonPremultipliedRenderColor(O?null:T).toArray01(),k=o.properties.get("space-color-use-theme")==="none",j=o.properties.get("space-color").toNonPremultipliedRenderColor(k?null:T).toArray01(),B=5e-4,U=i.e8(o.properties.get("horizon-blend"),0,1,B,.25),q=i.dl(t,h,_)&&U===B?_.worldSize/(2*Math.PI*1.025)-1:_.globeRadius,Z=t.frameCounter/1e3%1,ee=i.ae(_.globeCenterInViewSpace),re=Math.sqrt(Math.pow(ee,2)-Math.pow(q,2)),ue=Math.acos(re/ee),le=se=>{let oe=_.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];se&&oe.push("ALPHA_PASS");let he=t.getOrCreateProgram("globeAtmosphere",{defines:oe}),fe=((Ie,Be,Ve,We,we,Oe,_e,Ue,Me,Ge,nt,je)=>({u_frustum_tl:Ie,u_frustum_tr:Be,u_frustum_br:Ve,u_frustum_bl:We,u_horizon:we,u_transition:Oe,u_fadeout_range:_e,u_color:Ue,u_high_color:Me,u_space_color:Ge,u_temporal_offset:nt,u_horizon_angle:je}))(_.frustumCorners.TL,_.frustumCorners.TR,_.frustumCorners.BR,_.frustumCorners.BL,_.frustumCorners.horizon,E,U,M,P,j,Z,ue);t.uploadCommonUniforms(h,he);let Te=this.atmosphereBuffer;Te&&he.draw(t,m.TRIANGLES,v,Bt.disabled,se?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Pt.backCW,fe,se?"atmosphere_glow_alpha":"atmosphere_glow",Te.vertexBuffer,Te.indexBuffer,Te.segments)};le(!1),le(!0)}drawStars(t,o){let h=i.ay(o.properties.get("star-intensity"),0,1);if(h===0)return;let m=t.context,_=m.gl,v=t.transform,E=t.getOrCreateProgram("stars"),T=i.b_([]);i.c0(T,T,-v._pitch),i.b$(T,T,-v.angle),i.c0(T,T,i.al(v._center.lat)),i.e9(T,T,-i.al(v._center.lng));let C=i.c3(new Float32Array(16),T),M=i.az([],v.starsProjMatrix,C),O=i.e4([],C),P=i.ea([],O),k=[0,1,0];i.dz(k,k,P),i.bY(k,k,this.params.sizeMultiplier);let j=[1,0,0];i.dz(j,j,P),i.bY(j,j,this.params.sizeMultiplier);let B=(U=k,q=j,Z=h,{u_matrix:Float32Array.from(M),u_up:U,u_right:q,u_intensity_multiplier:Z});var U,q,Z;t.uploadCommonUniforms(m,E),this.starsVx&&this.starsIdx&&E.draw(t,_.TRIANGLES,ft.disabled,Bt.disabled,this.colorModeAlphaBlendedWriteRGB,Pt.disabled,B,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function El(u,t){let o=[...u],h=t.cameraWorldSizeForFog/t.worldSize,m=i.bx([]);return i.cE(m,m,[h,h,1]),i.az(o,m,o),i.az(o,t.worldToFogMatrix,o),o}function Ke(u,t,o,h,m){let _=o.material,v=h.context,{baseColorTexture:E,metallicRoughnessTexture:T}=_.pbrMetallicRoughness,{normalTexture:C,occlusionTexture:M,emissionTexture:O}=_;function P(j,B,U){if(j&&(u.push(B),v.activeTexture.set(v.gl.TEXTURE0+U),j.gfxTexture)){let{minFilter:q,magFilter:Z,wrapS:ee,wrapT:re}=j.sampler;j.gfxTexture.bindExtraParam(q,Z,ee,re)}}P(E,"HAS_TEXTURE_u_baseColorTexture",zr.BaseColor),P(T,"HAS_TEXTURE_u_metallicRoughnessTexture",zr.MetallicRoughness),P(C,"HAS_TEXTURE_u_normalTexture",zr.Normal),P(M,"HAS_TEXTURE_u_occlusionTexture",zr.Occlusion),P(O,"HAS_TEXTURE_u_emissionTexture",zr.Emission),m&&(m.texture||(m.texture=new i.eh(h.context,m.image,[m.image.height,m.image.height,m.image.height],v.gl.RGBA8)),v.activeTexture.set(v.gl.TEXTURE0+zr.LUT),m.texture&&m.texture.bind(v.gl.LINEAR,v.gl.CLAMP_TO_EDGE),u.push("APPLY_LUT_ON_GPU")),o.texcoordBuffer&&(u.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(o.texcoordBuffer)),o.colorBuffer&&(u.push(o.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(o.colorBuffer)),o.normalBuffer&&(u.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(o.normalBuffer)),o.pbrBuffer&&(u.push("HAS_ATTRIBUTE_a_pbr"),u.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(o.pbrBuffer)),_.alphaMode!=="OPAQUE"&&_.alphaMode!=="MASK"||u.push("UNPREMULT_TEXTURE_IN_SHADER"),_.defined||u.push("DIFFUSE_SHADED");let k=h.shadowRenderer;k&&(u.push("RENDER_SHADOWS","DEPTH_TEXTURE"),k.useNormalOffset&&u.push("NORMAL_OFFSET"))}function ht(u,t,o,h,m,_){let v=o.paint.get("model-opacity").constantOr(1),E=t.context,T=new ft(t.context.gl.LEQUAL,ft.ReadWrite,t.depthRangeFor3D),C=t.transform,M=u.mesh,O=M.material,P=O.pbrMetallicRoughness,k=t.style.fog,j;j=t.transform.projection.zAxisUnit==="pixels"?[...u.nodeModelMatrix]:i.az([],h.zScaleMatrix,u.nodeModelMatrix),i.az(j,h.negCameraPosMatrix,j);let B=i.bi([],j);i.ee(B,B);let U=o.paint.get("model-color-use-theme").constantOr("default")==="none",q=o.paint.get("model-emissive-strength").constantOr(0),Z=Zu(new Float32Array(u.worldViewProjection),new Float32Array(j),new Float32Array(B),null,t,v,P.baseColorFactor,O.emissiveFactor,P.metallicFactor,P.roughnessFactor,O,q,o),ee={defines:[]},re=[],ue=t.shadowRenderer;ue&&(ue.useNormalOffset=!1),Ke(ee.defines,re,M,t,U?null:o.lut);let le=null;if(k){let he=El(u.nodeModelMatrix,t.transform);if(le=new Float32Array(he),C.projection.name!=="globe"){let fe=M.aabb.min,Te=M.aabb.max,[Ie,Be]=k.getOpacityForBounds(he,fe[0],fe[1],Te[0],Te[1]);ee.overrideFog=Ie>=Re||Be>=Re}}let se=ps(t,o.paint.get("model-cutoff-fade-range"));se.shouldRenderCutoff&&ee.defines.push("RENDER_CUTOFF");let oe=t.getOrCreateProgram("model",ee);t.uploadCommonUniforms(E,oe,null,le,se),t.renderPass!=="shadow"&&ue&&ue.setupShadowsFromMatrix(u.nodeModelMatrix,oe),oe.draw(t,E.gl.TRIANGLES,T,m,_,M.material.doubleSided?Pt.disabled:Pt.backCCW,Z,o.id,M.vertexBuffer,M.indexBuffer,M.segments,o.paint,t.transform.zoom,void 0,re)}function Tl(u,t,o,h,m,_,v){let E;E=u.projection.name==="globe"?i.ed(o,u):[...o],i.az(E,E,t.matrix);let T=i.az([],h,E);if(t.meshes)for(let C of t.meshes){if(C.material.alphaMode!=="BLEND"){v.push({mesh:C,depth:0,modelIndex:m,worldViewProjection:T,nodeModelMatrix:E});continue}let M=i.ad([],C.centroid,T);!u.isOrthographic&&M[2]<=0||_.push({mesh:C,depth:M[2],modelIndex:m,worldViewProjection:T,nodeModelMatrix:E})}if(t.children)for(let C of t.children)Tl(u,C,o,h,m,_,v)}function Ei(u,t,o,h){let m=o.shadowRenderer;if(!m)return;let _=m.getShadowPassDepthMode(),v=m.getShadowPassColorMode(),E=m.calculateShadowPassMatrixFromMatrix(t),T=hy(E);o.getOrCreateProgram("modelDepth",{defines:o._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(o,o.context.gl.TRIANGLES,_,Bt.disabled,v,Pt.backCCW,T,h.id,u.vertexBuffer,u.indexBuffer,u.segments,h.paint,o.transform.zoom,void 0,void 0)}function Ee(u,t,o){let h=t.updateZoomBasedPaintProperties(),m=function(_,v,E){let T,C,M,O=_.terrain?_.terrain.exaggeration():0;if(_.terrain&&O>0){let P=_.terrain,k=P.findDEMTileFor(E);k&&k.dem?T=i.ei.create(P,E,k):O=0}if(O===0&&(v.terrainElevationMin=0,v.terrainElevationMax=0),O===v.validForExaggeration&&(O===0||T&&T._demTile&&T._demTile.tileID===v.validForDEMTile.id&&T._dem._timestamp===v.validForDEMTile.timestamp))return!1;for(let P in v.instancesPerModel){let k=v.instancesPerModel[P];for(let j=0;j<k.instancedDataArray.length;++j){let B=(T?O*T.getElevationAt(0|k.instancedDataArray.float32[16*j],0|k.instancedDataArray.float32[16*j+1],!0,!0):0)+k.instancesEvaluatedElevation[j];k.instancedDataArray.float32[16*j+6]=B,C=C?Math.min(v.terrainElevationMin,B):B,M=M?Math.max(v.terrainElevationMax,B):B}}return v.terrainElevationMin=C||0,v.terrainElevationMax=M||0,v.validForExaggeration=O,v.validForDEMTile=T&&T._demTile?{id:T._demTile.tileID,timestamp:T._dem._timestamp}:{id:void 0,timestamp:0},!0}(u,t,o);(h||m)&&(t.uploaded=!1,t.upload(u.context))}let Jo={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new i.cW([0,0,0],[i.aj,i.aj,0])};function Hd(u,t){let o=1<<u.canonical.z,h=t.getFreeCameraOptions().position,m=t.elevation,_=u.canonical.x/o,v=(u.canonical.x+1)/o,E=u.canonical.y/o,T=(u.canonical.y+1)/o,C=t._centerAltitude;if(m){let k=m.getMinMaxForTile(u);k&&k.max>C&&(C=k.max)}let M=i.ay(h.x,_,v)-h.x,O=i.ay(h.y,E,T)-h.y,P=i.c6(C,t.center.lat)-h.z;return t._zoomFromMercatorZ(Math.sqrt(M*M+O*O+P*P))}function $d(u,t,o,h,m,_,v){let E=u.context,T=u.renderPass==="shadow",C=u.shadowRenderer,M=T&&C?C.getShadowPassDepthMode():new ft(E.gl.LEQUAL,ft.ReadWrite,u.depthRangeFor3D),O=u.isTileAffectedByFog(_);if(o.meshes)for(let P of o.meshes){let k=["MODEL_POSITION_ON_GPU"],j=[],B,U,q;h.instancedDataArray.length>20&&k.push("INSTANCED_ARRAYS");let Z=ps(u,t.paint.get("model-cutoff-fade-range"));if(Z.shouldRenderCutoff&&k.push("RENDER_CUTOFF"),T&&C)B=u.getOrCreateProgram("modelDepth",{defines:k}),U=hy(v.shadowTileMatrix,v.shadowTileMatrix,Float32Array.from(o.matrix)),q=C.getShadowPassColorMode();else{Ke(k,j,P,u,t.paint.get("model-color-use-theme").constantOr("default")==="none"?null:t.lut),B=u.getOrCreateProgram("model",{defines:k,overrideFog:O});let re=P.material,ue=re.pbrMetallicRoughness,le=t.paint.get("model-opacity").constantOr(1),se=t.paint.get("model-emissive-strength").constantOr(0);U=Zu(_.expandedProjMatrix,Float32Array.from(o.matrix),new Float32Array(16),null,u,le,ue.baseColorFactor,re.emissiveFactor,ue.metallicFactor,ue.roughnessFactor,re,se,t,m),C&&(v.shadowUniformsInitialized?B.setShadowUniformValues(E,C.getShadowUniformValues()):(C.setupShadows(_.toUnwrapped(),B,"model-tile",_.overscaledZ),v.shadowUniformsInitialized=!0)),q=Z.shouldRenderCutoff||le<1||re.alphaMode!=="OPAQUE"?en.alphaBlended:en.unblended}u.uploadCommonUniforms(E,B,_.toUnwrapped(),null,Z);let ee=P.material.doubleSided?Pt.disabled:Pt.backCCW;if(h.instancedDataArray.length>20)j.push(h.instancedDataBuffer),B.draw(u,E.gl.TRIANGLES,M,Bt.disabled,q,ee,U,t.id,P.vertexBuffer,P.indexBuffer,P.segments,t.paint,u.transform.zoom,void 0,j,h.instancedDataArray.length);else{let re=T?"u_instance":"u_normal_matrix";for(let ue=0;ue<h.instancedDataArray.length;++ue)U[re]=new Float32Array(h.instancedDataArray.arrayBuffer,64*ue,16),B.draw(u,E.gl.TRIANGLES,M,Bt.disabled,q,ee,U,t.id,P.vertexBuffer,P.indexBuffer,P.segments,t.paint,u.transform.zoom,void 0,j)}}if(o.children)for(let P of o.children)$d(u,t,P,h,m,_,v)}let ym=[1,-1,1];function wy(u,t,o,h){if(!o.modelManager)return!0;let m=o.modelManager;if(!o.shadowRenderer)return!0;let _=o.shadowRenderer,v=t.aabb,E=!0,T=u.maxHeight;if(T===0){let M=0;for(let O in u.instancesPerModel){let P=m.getModel(O,h);P?M=Math.max(M,Math.max(Math.max(P.aabb.max[0],P.aabb.max[1]),P.aabb.max[2])):E=!1}T=u.maxScale*M*1.41+u.maxVerticalOffset,E&&(u.maxHeight=T)}v.max[2]=T,v.min[2]+=u.terrainElevationMin,v.max[2]+=u.terrainElevationMax,i.ad(v.min,v.min,t.tileMatrix),i.ad(v.max,v.max,t.tileMatrix);let C=v.intersects(_.getCurrentCascadeFrustum());return o.currentShadowCascade===0&&(u.isInsideFirstShadowMapFrustum=C===2),C===0}function Ey(u,t){let o=u.uniformValues.u_cutoff_params[0],h=u.uniformValues.u_cutoff_params[1],m=u.uniformValues.u_cutoff_params[2],_=u.uniformValues.u_cutoff_params[3];return h===o||_===m?1:i.ay(((t-o)/(h-o)-m)/(_-m),0,1)}function Sc(u,t,o,h){if(t.pitch<20)return 1;let m=t.getWorldToCameraMatrix();i.az(m,m,u);let _=i.ej(o.min[0],o.min[1],o.min[2],1),v=i.aA(i.ek(),_,m),E=v,T=v;_[1]=o.max[1],v=i.aA(i.ek(),_,m),E=v[1]<E[1]?v:E,T=v[1]>T[1]?v:T,_[0]=o.max[0],v=i.aA(i.ek(),_,m),E=v[1]<E[1]?v:E,T=v[1]>T[1]?v:T,_[1]=o.min[1],v=i.aA(i.ek(),_,m),E=v[1]<E[1]?v:E,T=v[1]>T[1]?v:T;let C=i.ay(h[0],0,1),M=100*t.pixelsPerMeter*i.ay(h[1],0,1),O=i.ay(h[2],0,1),P=i.el(i.ek(),E,T,C),k=Math.tan(.5*t.fovX),j=-P[2]*k;if(M===0)return P[1]<-Math.abs(j)?O:1;let B=(-Math.abs(j)-P[1])/M,U=(Z,ee,re)=>(1-re)*Z+re*ee,q=i.ay(U(1,O,B),O,1);return U(1,q,i.ay((t.pitch-20)/20,0,1))}class o1{}class s1{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,o,h){{let O=this._storage.get(o.id);if(O)return O.lastUsedFrameIdx=t,O.buf}let m=h.gl,_=m.getBufferParameter(m.ELEMENT_ARRAY_BUFFER,m.BUFFER_SIZE),v=new ArrayBuffer(_),E=new Int16Array(v);m.getBufferSubData(m.ELEMENT_ARRAY_BUFFER,0,new Int16Array(v));let T=new i.en;for(let O=0;O<_/2;O+=3){let P=E[O],k=E[O+1],j=E[O+2];T.emplaceBack(P,k),T.emplaceBack(k,j),T.emplaceBack(j,P)}let C=h.bindVertexArrayOES.current,M=new o1;return M.buf=new xc(h,T),M.lastUsedFrameIdx=t,this._storage.set(o.id,M),h.bindVertexArrayOES.set(C),M.buf}update(t){for(let[o,h]of this._storage)t-h.lastUsedFrameIdx>30&&(h.buf.destroy(),this._storage.delete(o))}destroy(){for(let[t,o]of this._storage)o.buf.destroy(),this._storage.delete(t)}}class Ty{constructor(t){this.occluderSize=30,this.depthOffset=-1e-4,t.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),t.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}let Gd=i.d_([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class vm{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class xm{constructor(t,o){this.revealStart=11,this.revealRange=2,t.registerParameter(this,[...o,"Reveal"],"revealStart",{min:0,max:17,step:.05}),t.registerParameter(this,[...o,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}let Iy=i.d_([{type:"Float32",name:"a_pos_2f",components:2}]);class qd{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,o){let h=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){let v=new i.eo,E=new i.a_;v.emplaceBack(-1,-1),v.emplaceBack(1,-1),v.emplaceBack(1,1),v.emplaceBack(-1,1),E.emplaceBack(0,1,2),E.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(v,Iy.members),this.vignetteIdx=t.context.createIndexBuffer(E)}let m=i.bd.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,h);let v={u_vignetteShape:(_={vignetteShape:[o.start,o.range,Math.pow(10,o.fadePower)],vignetteColor:[o.color.r,o.color.g,o.color.b,o.color.a*o.strength]}).vignetteShape,u_vignetteColor:_.vignetteColor};h.draw(t,t.context.gl.TRIANGLES,ft.disabled,Bt.disabled,en.alphaBlended,Pt.disabled,v,"vignette",this.vignetteVx,this.vignetteIdx,m)}var _}}class Qu{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,o){let h=t.getFreeCameraOptions().position,m=h.toAltitude(),_=h.toLngLat(),v=i.al(_.lng),E=i.al(_.lat),T=t.pixelsPerMeter/o,C=v*i.eq,M=i.eq*Math.log(Math.tan(Math.PI/4+E/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{let O=-this._offsetYPrev+M,P=-this._elevationPrev+m;this._accumulatedOffsetX+=(-this._offsetXPrev+C)*T,this._accumulatedOffsetY+=O*T,this._accumulatedElevation+=P*T,this._offsetXPrev=C,this._offsetYPrev=M,this._elevationPrev=m}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function Il(u,t){return[-(u[0]-Math.floor(u[0]/t)*t),-(u[1]-Math.floor(u[1]/t)*t),-(u[2]-Math.floor(u[2]/t)*t)]}function bm(u){let t=i.e7(1323123451230),o=[];for(let h=0;h<u;++h){let m=2*t()-1,_=2*t()-1,v=2*t()-1;o.push(i.cS(m,_,v))}return o}function Ca(u,t,o,h,m){let _=i.ay((m-o)/(h-o),0,1);return(1-_)*u+_*t}class Ir{constructor(t){this._movement=new Qu,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new qd,this._ppmScaleFactor=t}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,o){let h=t.transform;this._movement.update(h,this._ppmScaleFactor);let m=h.starsProjMatrix,_=i.b_([]);i.c0(_,_,i.al(90)-h._pitch),i.b$(_,_,-h.angle);let v=i.c3(new Float32Array(16),_),E=i.ep(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),T=i.ee([],E),C=i.az([],T,v),M=Date.now()/1e3;return this._accumulatedTimeFromStart+=(M-this._prevTime)*o,this._prevTime=M,{projectionMatrix:m,modelviewMatrix:C}}}class a1 extends Ir{constructor(t){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new xm(t.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){let o=t.context;if(!this.particlesVx){let h=bm(this.particlesCount),m=new i.er,_=new i.a_,v=0,E=i.e7(1323123451230);for(let T=0;T<h.length;++T){let C=h[T],M=[2*E()-1,E(),E(),E()];m.emplaceBack(C[0],C[1],C[2],-1,-1,...M),m.emplaceBack(C[0],C[1],C[2],1,-1,...M),m.emplaceBack(C[0],C[1],C[2],1,1,...M),m.emplaceBack(C[0],C[1],C[2],-1,1,...M),_.emplaceBack(v+0,v+1,v+2),_.emplaceBack(v+0,v+2,v+3),v+=4}this.particlesVx=o.createVertexBuffer(m,Gd.members),this.particlesIdx=o.createIndexBuffer(_)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;let o=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},h=t.transform.zoom;if(o.revealStart>h)return;let m=Ca(0,1,o.revealStart,o.revealStart+o.revealRange,h);if(!this.particlesVx||!this.particlesIdx)return;let _=structuredClone(this._params),v=[-_.direction.x,_.direction.y,-100];i.au(v,v);let E=structuredClone(this._vignetteParams);E.strength*=m,_.overrideStyleParameters||(_.intensity=t.style.rain.state.density,_.timeFactor=t.style.rain.state.intensity,_.color=structuredClone(t.style.rain.state.color),v=structuredClone(t.style.rain.state.direction),_.screenThinning.intensity=t.style.rain.state.centerThinning,_.dropletSizeX=t.style.rain.state.dropletSize[0],_.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],_.distortionStrength=100*t.style.rain.state.distortionStrength,E.strength=1,E.color=structuredClone(t.style.rain.state.vignetteColor));let T=this.updateOnRender(t,_.timeFactor),C=t.context,M=C.gl,O=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new i.T(C,{width:t.width,height:t.height,data:null},M.RGBA8)),_.distortionStrength>0&&(C.activeTexture.set(M.TEXTURE0),this.screenTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),M.copyTexSubImage2D(M.TEXTURE_2D,0,0,0,0,0,t.width,t.height));let P=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(C,P),C.activeTexture.set(M.TEXTURE0),this.screenTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE);let k=[_.color.r,_.color.g,_.color.b,_.color.a],j=(B,U)=>{let q=Il(this._movement.getPosition(),B),Z=_.dropletSizeX,ee=_.dropletSizeX*_.dropletSizeYScale,re=t.width/2,ue=t.height/2,le=Ca(0,_.screenThinning.start,0,1,_.screenThinning.intensity),se=Ca(.001,_.screenThinning.range,0,1,_.screenThinning.intensity),oe=Ca(0,_.screenThinning.particleOffset,0,1,_.screenThinning.intensity),he=(fe={modelview:T.modelviewMatrix,projection:T.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:q,velocityConeAperture:_.velocityConeAperture,velocity:_.velocity,boxSize:B,rainDropletSize:[Z,ee],distortionStrength:_.distortionStrength,rainDirection:v,color:k,screenSize:[O.width,O.height],thinningCenterPos:[re,ue],thinningShape:[le,se,Math.pow(10,_.screenThinning.fadePower)],thinningAffectedRatio:_.screenThinning.affectedRatio,thinningParticleOffset:oe,shapeDirectionalPower:_.shapeDirPower,shapeNormalPower:_.shapeNormalPower,mode:U?0:1},{u_modelview:Float32Array.from(fe.modelview),u_projection:Float32Array.from(fe.projection),u_time:fe.time,u_cam_pos:fe.camPos,u_texScreen:0,u_velocityConeAperture:fe.velocityConeAperture,u_velocity:fe.velocity,u_boxSize:fe.boxSize,u_rainDropletSize:fe.rainDropletSize,u_distortionStrength:fe.distortionStrength,u_rainDirection:fe.rainDirection,u_color:fe.color,u_screenSize:fe.screenSize,u_thinningCenterPos:fe.thinningCenterPos,u_thinningShape:fe.thinningShape,u_thinningAffectedRatio:fe.thinningAffectedRatio,u_thinningParticleOffset:fe.thinningParticleOffset,u_shapeDirectionalPower:fe.shapeDirectionalPower,u_shapeNormalPower:fe.shapeNormalPower,u_mode:fe.mode});var fe;let Te=Math.round(_.intensity*this.particlesCount),Ie=i.bd.simpleSegment(0,0,4*Te,2*Te);P.draw(t,M.TRIANGLES,ft.disabled,Bt.disabled,en.alphaBlended,Pt.disabled,he,"rain_particles",this.particlesVx,this.particlesIdx,Ie)};_.distortionStrength>0&&j(_.boxSize,!0),j(_.boxSize,!1),this._vignette.draw(t,E)}}let eh=i.d_([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class ui extends Ir{constructor(t){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new xm(t.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){let o=t.context;if(!this.particlesVx){let h=bm(this.particlesCount),m=new i.es,_=new i.a_,v=0,E=i.e7(1323123451230);for(let T=0;T<h.length;++T){let C=h[T],M=E(),O=E(),P=E(),k=[T/h.length,M,O,P],j=[E(),E()];m.emplaceBack(C[0],C[1],C[2],-1,-1,...k,...j),m.emplaceBack(C[0],C[1],C[2],1,-1,...k,...j),m.emplaceBack(C[0],C[1],C[2],1,1,...k,...j),m.emplaceBack(C[0],C[1],C[2],-1,1,...k,...j),_.emplaceBack(v+0,v+1,v+2),_.emplaceBack(v+0,v+2,v+3),v+=4}this.particlesVx=o.createVertexBuffer(m,eh.members),this.particlesIdx=o.createIndexBuffer(_)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;let o=structuredClone(this._params),h=[-o.direction.x,o.direction.y,-100];i.au(h,h);let m=structuredClone(this._vignetteParams),_=o.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},v=t.transform.zoom;if(_.revealStart>v)return;let E=Ca(0,1,_.revealStart,_.revealStart+_.revealRange,v);m.strength*=E,o.overrideStyleParameters||(o.intensity=t.style.snow.state.density,o.timeFactor=t.style.snow.state.intensity,o.color=structuredClone(t.style.snow.state.color),h=structuredClone(t.style.snow.state.direction),o.screenThinning.intensity=t.style.snow.state.centerThinning,o.billboardSize=2.79*t.style.snow.state.flakeSize,m.strength=1,m.color=structuredClone(t.style.snow.state.vignetteColor));let T=this.updateOnRender(t,o.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;let C=t.context,M=C.gl,O=t.transform,P=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(C,P),((k,j,B)=>{let U=Il(this._movement.getPosition(),k),q=O.width/2,Z=O.height/2,ee=Ca(0,B.screenThinning.start,0,1,B.screenThinning.intensity),re=Ca(.001,B.screenThinning.range,0,1,B.screenThinning.intensity),ue=Ca(0,B.screenThinning.particleOffset,0,1,B.screenThinning.intensity),le=(se={modelview:T.modelviewMatrix,projection:T.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:U,velocityConeAperture:B.velocityConeAperture,velocity:B.velocity,horizontalOscillationRadius:B.horizontalOscillationRadius,horizontalOscillationRate:B.horizontalOscillationRate,boxSize:k,billboardSize:1*B.billboardSize,simpleShapeParameters:[B.shapeFadeStart,B.shapeFadePower],screenSize:[O.width,O.height],thinningCenterPos:[q,Z],thinningShape:[ee,re,Math.pow(10,B.screenThinning.fadePower)],thinningAffectedRatio:B.screenThinning.affectedRatio,thinningParticleOffset:ue,color:[B.color.r,B.color.g,B.color.b,B.color.a],direction:h},{u_modelview:Float32Array.from(se.modelview),u_projection:Float32Array.from(se.projection),u_time:se.time,u_cam_pos:se.camPos,u_velocityConeAperture:se.velocityConeAperture,u_velocity:se.velocity,u_horizontalOscillationRadius:se.horizontalOscillationRadius,u_horizontalOscillationRate:se.horizontalOscillationRate,u_boxSize:se.boxSize,u_billboardSize:se.billboardSize,u_simpleShapeParameters:se.simpleShapeParameters,u_screenSize:se.screenSize,u_thinningCenterPos:se.thinningCenterPos,u_thinningShape:se.thinningShape,u_thinningAffectedRatio:se.thinningAffectedRatio,u_thinningParticleOffset:se.thinningParticleOffset,u_particleColor:se.color,u_direction:se.direction});var se;let oe=Math.round(B.intensity*this.particlesCount),he=i.bd.simpleSegment(0,0,4*oe,2*oe);this.particlesVx&&this.particlesIdx&&P.draw(t,M.TRIANGLES,ft.disabled,Bt.disabled,en.alphaBlended,Pt.disabled,le,"snow_particles",this.particlesVx,this.particlesIdx,he)})(o.boxSize,0,o),this._vignette.draw(t,m)}}let mn={symbol:function(u,t,o,h,m){if(u.renderPass!=="translucent")return;let _=Bt.disabled,v=u.colorModeForRenderPass(),E=o.layout.get("text-variable-anchor"),T=o.layout.get("text-size-scale-range"),C=i.ay(u.scaleFactor,T[0],T[1]);E&&function(P,k,j,B,U,q,Z,ee){let re=k.transform,ue=U==="map",le=q==="map";for(let se of P){let oe=B.getTile(se),he=oe.getBucket(j);if(!he||!he.text||!he.text.segments.get().length)continue;let fe=i.bH(he.textSizeData,re.zoom,ee),Te=pd(se,he.getProjection(),re),Ie=re.calculatePixelsToTileUnitsMatrix(oe),Be=Fs(Te,oe.tileID.canonical,le,ue,re,he.getProjection(),Ie),Ve=he.hasIconTextFit()&&he.hasIconData();fe&&fy(he,ue,le,Z,re,Be,se,Math.pow(2,re.zoom-oe.tileID.overscaledZ),fe,Ve)}}(h,u,o,t,o.layout.get("text-rotation-alignment"),o.layout.get("text-pitch-alignment"),m,C);let M=o.paint.get("icon-opacity").constantOr(1)!==0,O=o.paint.get("text-opacity").constantOr(1)!==0;o.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(M||O)?wc(u,t,o,h,_,v):(M&&wc(u,t,o,h,_,v,{onlyIcons:!0}),O&&wc(u,t,o,h,_,v,{onlyText:!0})),t.map.showCollisionBoxes&&(Bd(u,t,o,h,o.paint.get("text-translate"),o.paint.get("text-translate-anchor"),!0),Bd(u,t,o,h,o.paint.get("icon-translate"),o.paint.get("icon-translate-anchor"),!1))},circle:function(u,t,o,h){if(u.renderPass!=="translucent")return;let m=o.paint.get("circle-opacity"),_=o.paint.get("circle-stroke-width"),v=o.paint.get("circle-stroke-opacity"),E=o.layout.get("circle-sort-key").constantOr(1)!==void 0,T=o.paint.get("circle-emissive-strength");if(m.constantOr(1)===0&&(_.constantOr(1)===0||v.constantOr(1)===0))return;let C=u.context,M=C.gl,O=u.transform,P=!(!u.terrain||!u.terrain.enabled),k=o.layout.get("circle-elevation-reference"),j=u.depthModeForSublayer(0,ft.ReadOnly),B=new ft(u.context.gl.LEQUAL,ft.ReadOnly,u.depthRangeFor3D),U=k==="none"||P?j:B,q=Bt.disabled,Z=u.colorModeForDrapableLayerRenderPass(T),ee=O.projection.name==="globe",re=[i.aD(O.center.lng),i.aH(O.center.lat)],ue=[];for(let se=0;se<h.length;se++){let oe=h[se],he=t.getTile(oe),fe=he.getBucket(o);if(!fe||fe.projection.name!==O.projection.name)continue;let Te=fe.programConfigurations.get(o.id),Ie=fe.layoutVertexBuffer,Be=fe.globeExtVertexBuffer,Ve=fe.indexBuffer,We=i.dK(o),we=[Be],Oe=u.isTileAffectedByFog(oe);ee&&We.push("PROJECTION_GLOBE_VIEW"),We.push("DEPTH_D24"),u.terrain&&O.depthOcclusionForSymbolsAndCircles&&We.push("DEPTH_OCCLUSION"),fe.hasElevation&&(We.push("ELEVATED_ROADS"),we.push(fe.elevatedLayoutVertexBuffer));let _e=u.getOrCreateProgram("circle",{config:Te,defines:We,overrideFog:Oe}),Ue=O.projection.createInversionMatrix(O,oe.canonical),Me={programConfiguration:Te,program:_e,layoutVertexBuffer:Ie,dynamicBuffers:we,indexBuffer:Ve,uniformValues:i.dL(u,oe,he,Ue,re,o),tile:he};if(E){let Ge=fe.segments.get();for(let nt of Ge)ue.push({segments:new i.bd([nt]),sortKey:nt.sortKey,state:Me})}else ue.push({segments:fe.segments,sortKey:0,state:Me})}E&&ue.sort((se,oe)=>se.sortKey-oe.sortKey);let le={useDepthForOcclusion:O.depthOcclusionForSymbolsAndCircles};for(let se of ue){let{programConfiguration:oe,program:he,layoutVertexBuffer:fe,dynamicBuffers:Te,indexBuffer:Ie,uniformValues:Be,tile:Ve}=se.state,We=se.segments;u.terrain&&u.terrain.setupElevationDraw(Ve,he,le),u.uploadCommonUniforms(C,he,Ve.tileID.toUnwrapped()),he.draw(u,M.TRIANGLES,U,q,Z,Pt.disabled,Be,o.id,fe,Ie,We,o.paint,O.zoom,oe,Te)}},heatmap:function(u,t,o,h){if(o.paint.get("heatmap-opacity")!==0)if(u.renderPass==="offscreen"){let m=u.context,_=m.gl,v=Bt.disabled,E=new en([_.ONE,_.ONE,_.ONE,_.ONE],i.am.transparent,[!0,!0,!0,!0]);(function(k,j,B,U){let q=k.gl,Z=j.width*U,ee=j.height*U;k.activeTexture.set(q.TEXTURE1),k.viewport.set([0,0,Z,ee]);let re=B.heatmapFbo;if(!re||re&&(re.width!==Z||re.height!==ee)){re&&re.destroy();let ue=q.createTexture();q.bindTexture(q.TEXTURE_2D,ue),q.texParameteri(q.TEXTURE_2D,q.TEXTURE_WRAP_S,q.CLAMP_TO_EDGE),q.texParameteri(q.TEXTURE_2D,q.TEXTURE_WRAP_T,q.CLAMP_TO_EDGE),q.texParameteri(q.TEXTURE_2D,q.TEXTURE_MIN_FILTER,q.LINEAR),q.texParameteri(q.TEXTURE_2D,q.TEXTURE_MAG_FILTER,q.LINEAR),re=B.heatmapFbo=k.createFramebuffer(Z,ee,!0,null),function(le,se,oe,he,fe,Te){let Ie=le.gl;Ie.texImage2D(Ie.TEXTURE_2D,0,le.extRenderToTextureHalfFloat?Ie.RGBA16F:Ie.RGBA,fe,Te,0,Ie.RGBA,le.extRenderToTextureHalfFloat?Ie.HALF_FLOAT:Ie.UNSIGNED_BYTE,null),he.colorAttachment.set(oe)}(k,0,ue,re,Z,ee)}else q.bindTexture(q.TEXTURE_2D,re.colorAttachment.get()),k.bindFramebuffer.set(re.framebuffer)})(m,u,o,u.transform.projection.name==="globe"?.5:.25),m.clear({color:i.am.transparent});let T=u.transform,C=T.projection.name==="globe",M=C?["PROJECTION_GLOBE_VIEW"]:[],O=C?Pt.frontCCW:Pt.disabled,P=[i.aD(T.center.lng),i.aH(T.center.lat)];for(let k=0;k<h.length;k++){let j=h[k];if(t.hasRenderableParent(j))continue;let B=t.getTile(j),U=B.getBucket(o);if(!U||U.projection.name!==T.projection.name)continue;let q=u.isTileAffectedByFog(j),Z=U.programConfigurations.get(o.id),ee=u.getOrCreateProgram("heatmap",{config:Z,defines:M,overrideFog:q}),{zoom:re}=u.transform;u.terrain&&u.terrain.setupElevationDraw(B,ee),u.uploadCommonUniforms(m,ee,j.toUnwrapped());let ue=T.projection.createInversionMatrix(T,j.canonical);ee.draw(u,_.TRIANGLES,ft.disabled,v,E,O,ly(u,j,B,ue,P,re,o.paint.get("heatmap-intensity")),o.id,U.layoutVertexBuffer,U.indexBuffer,U.segments,o.paint,u.transform.zoom,Z,C?[U.globeExtVertexBuffer]:null)}m.viewport.set([0,0,u.width,u.height])}else u.renderPass==="translucent"&&(u.context.setColorMode(u.colorModeForRenderPass()),function(m,_){let v=m.context,E=v.gl,T=_.heatmapFbo;if(!T)return;v.activeTexture.set(E.TEXTURE0),E.bindTexture(E.TEXTURE_2D,T.colorAttachment.get()),v.activeTexture.set(E.TEXTURE1);let C=_.colorRampTexture;C||(C=_.colorRampTexture=new i.T(v,_.colorRamp,E.RGBA8)),C.bind(E.LINEAR,E.CLAMP_TO_EDGE),m.getOrCreateProgram("heatmapTexture").draw(m,E.TRIANGLES,ft.disabled,Bt.disabled,m.colorModeForRenderPass(),Pt.disabled,((M,O,P,k)=>({u_image:0,u_color_ramp:1,u_opacity:O.paint.get("heatmap-opacity")}))(0,_),_.id,m.viewportBuffer,m.quadTriangleIndexBuffer,m.viewportSegments,_.paint,m.transform.zoom)}(u,o))},line:function(u,t,o,h){if(u.renderPass!=="translucent")return;let m=o.paint.get("line-opacity"),_=o.paint.get("line-width");if(m.constantOr(1)===0||_.constantOr(1)===0)return;let v=o.paint.get("line-emissive-strength"),E=o.paint.get("line-occlusion-opacity"),T=o.layout.get("line-elevation-reference"),C=o.layout.get("line-width-unit")==="meters",M=T==="sea",O=!(!u.terrain||!u.terrain.enabled),P=u.context,k=P.gl;if(o.hasElevatedBuckets&&u.transform.projection.name==="globe")return;let j=o.layout.get("line-cross-slope"),B=j!==void 0,U=j<1,q=u.colorModeForDrapableLayerRenderPass(v),Z=u.terrain&&u.terrain.renderingToTexture,ee=Z?1:i.q.devicePixelRatio,re=o.paint.get("line-dasharray"),ue=re.constantOr(1),le=o.layout.get("line-cap"),se=re.constantOr(null),oe=le.constantOr(null),he=o.paint.get("line-pattern"),fe=he.constantOr(1),Te=o.paint.get("line-pattern-cross-fade"),Ie=he.constantOr(null),Be=o.paint.get("line-opacity").constantOr(1),Ve=!fe&&Be!==1||u.depthOcclusion&&E>0&&E<1,We=o.paint.get("line-gradient"),we=fe?"linePattern":"line",Oe=i.dM(o),_e;if(Z&&u.terrain&&u.terrain.clipOrMaskOverlapStencilType()&&(Ve=!1),E!==0&&u.depthOcclusion){let nt=o.paint._values["line-opacity"];nt&&nt.value&&nt.value.kind==="constant"?_e=nt.value:i.w(`Occlusion opacity for layer ${o.id} is supported only when line-opacity isn't data-driven.`)}_.value.kind!=="constant"&&_.value.isLineProgressConstant===!1&&Oe.push("VARIABLE_LINE_WIDTH");let Ue=(nt,je,et,mt,gt,dt)=>{for(let Et of nt){let St=t.getTile(Et);if(fe&&!St.patternsLoaded())continue;let Ct=St.getBucket(o);if(!Ct||Ct.elevationType!=="none"&&!gt||Ct.elevationType==="none"&&gt)continue;u.prepareDrawTile();let Nt=[...je],Zt=u.shadowRenderer,Dn=Ct.elevationType==="road"&&!!Zt&&Zt.enabled,Kn=[0,0,0];if(Dn){let dn=u.style.directionalLight,zi=u.style.ambientLight;dn&&zi&&(Kn=pl(u.style,dn,zi)),Nt.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}let Rn=Ct.programConfigurations.get(o.id),kn=!1;if(Ie&&St.imageAtlas){let dn=i.dN.from(Ie),zi=dn.getPrimary().scaleSelf(ee).toString(),ii=St.imageAtlas.patternPositions.get(zi),Wn=dn.getSecondary(),ri=Wn?St.imageAtlas.patternPositions.get(Wn.scaleSelf(ee).toString()):null;kn=!!ii&&!!ri,ii&&Rn.setConstantPatternPositions(ii,ri)}Te>0&&(kn||Rn.getPatternTransitionVertexBuffer("line-pattern"))&&Nt.push("LINE_PATTERN_TRANSITION");let Pi=u.isTileAffectedByFog(Et),Ht=u.getOrCreateProgram(we,{config:Rn,defines:Nt,overrideFog:Pi,overrideRtt:!gt&&void 0});if(!fe&&se&&oe&&St.lineAtlas){let dn=St.lineAtlas.getDash(se,oe);dn&&Rn.setConstantPatternPositions(dn)}Dn&&Zt.setupShadows(St.tileID.toUnwrapped(),Ht,"vector-tile",St.tileID.overscaledZ);let[Kt,on]=o.paint.get("line-trim-offset");(oe==="round"||oe==="square")&&Kt!==on&&(Kt===0&&(Kt-=1),on===1&&(on+=1));let ni=Z?Et.projMatrix:null,$i=C?1/Ct.tileToMeter/i.aw(St,1,u.transform.zoom):1,Jn=C?1/Ct.tileToMeter/i.aw(St,1,Math.floor(u.transform.zoom)):1,vn=fe?i.dO(u,St,o,ni,ee,$i,Jn,[Kt,on],Kn,Te):i.dP(u,St,o,ni,Ct.lineClipsArray.length,ee,$i,Jn,[Kt,on],Kn);if(We){let dn=Ct.gradients[o.id],zi=dn.texture;if(o.gradientVersion!==dn.version){let ii=256;if(o.stepInterpolant){let Wn=t.getSource().maxzoom,ri=Et.canonical.z===Wn?Math.ceil(1<<u.transform.maxZoom-Et.canonical.z):1;ii=i.ay(i.dQ(Ct.maxLineLength/i.aj*1024*ri),256,P.maxTextureSize)}dn.gradient=i.dR({expression:o.gradientExpression(),evaluationKey:"lineProgress",resolution:ii,image:dn.gradient||void 0,clips:Ct.lineClipsArray}),dn.texture?dn.texture.update(dn.gradient):dn.texture=new i.T(P,dn.gradient,k.RGBA8),dn.version=o.gradientVersion,zi=dn.texture}P.activeTexture.set(k.TEXTURE1),zi.bind(o.stepInterpolant?k.NEAREST:k.LINEAR,k.CLAMP_TO_EDGE)}ue&&(P.activeTexture.set(k.TEXTURE0),St.lineAtlasTexture&&St.lineAtlasTexture.bind(k.LINEAR,k.REPEAT),Rn.updatePaintBuffers()),fe&&(P.activeTexture.set(k.TEXTURE0),St.imageAtlasTexture&&St.imageAtlasTexture.bind(k.LINEAR,k.CLAMP_TO_EDGE),Rn.updatePaintBuffers()),gt&&!M&&u.terrain.setupElevationDraw(St,Ht),u.uploadCommonUniforms(P,Ht,Et.toUnwrapped());let Ti=dn=>{_e!=null&&(_e.value=Be*E),Ht.draw(u,k.TRIANGLES,et,dn,q,Pt.disabled,vn,o.id,Ct.layoutVertexBuffer,Ct.indexBuffer,Ct.segments,o.paint,u.transform.zoom,Rn,[Ct.layoutVertexBuffer2,Ct.patternVertexBuffer,Ct.zOffsetVertexBuffer]),_e!=null&&(_e.value=Be)};if(Ve&&!gt){let dn=u.stencilModeForClipping(Et).ref;dn===0&&Z&&P.clear({stencil:0});let zi={func:k.EQUAL,mask:255};vn.u_alpha_discard_threshold=.8,Ti(new Bt(zi,dn,255,k.KEEP,k.KEEP,k.INVERT)),vn.u_alpha_discard_threshold=0,Ti(new Bt(zi,dn,255,k.KEEP,k.KEEP,k.KEEP))}else vn.u_alpha_discard_threshold=Ve&&gt&&dt?.8:0,Ti(gt?mt:u.stencilModeForClipping(Et))}},Me=u.depthModeForSublayer(0,ft.ReadOnly),Ge=new ft(u.depthOcclusion?k.GREATER:k.LEQUAL,ft.ReadOnly,u.depthRangeFor3D);if(o.hasNonElevatedBuckets){let nt=!Z&&u.terrain;E!==0&&nt?i.w(`Occlusion opacity for layer ${o.id} is supported on terrain only if the layer has line-z-offset enabled.`):nt?i.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${o.id}.`):Ue(h,Oe,Me,Bt.disabled,!1,!0)}if(o.hasElevatedBuckets){T==="hd-road-markup"?O||(Me=Ge,Oe.push("ELEVATED_ROADS")):(Oe.push("ELEVATED"),Me=Ge,B&&Oe.push(U?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),M&&Oe.push("ELEVATION_REFERENCE_SEA"));let nt=Ve?u.stencilModeFor3D():Bt.disabled;u.forceTerrainMode=!0,Ue(h,Oe,Me,nt,!0,!0),Ve&&Ue(h,Oe,Me,nt,!0,!1),u.forceTerrainMode=!1}Ve&&(u.resetStencilClippingMasks(),Z&&P.clear({stencil:0})),E===0||u.depthOcclusion||Z||u.layersWithOcclusionOpacity.push(u.currentLayer)},fill:function(u,t,o,h){let m=o.paint.get("fill-color"),_=o.paint.get("fill-opacity");if(_.constantOr(1)===0)return;let v=o.paint.get("fill-emissive-strength"),E=u.colorModeForDrapableLayerRenderPass(v),T=o.paint.get("fill-pattern"),C=u.opaquePassEnabledForLayer()&&!T.constantOr(1)&&m.constantOr(i.am.transparent).a===1&&_.constantOr(0)===1?"opaque":"translucent",M="none";o.layout.get("fill-elevation-reference")!=="none"?M="road":o.paint.get("fill-z-offset").constantOr(1)!==0&&(M="offset");let O=!(!u.terrain||!u.terrain.enabled),P={painter:u,sourceCache:t,layer:o,coords:h,colorMode:E,elevationType:M,terrainEnabled:O,pass:C};if(u.renderPass!=="shadow")if(M!=="offset"){if(mm(P,!1),M==="road"){let k=!O&&u.renderPass==="translucent";k&&pm(u,t,o,h,"geometry"),mm(P,!0,Bt.disabled),k&&function(j){let{painter:B,sourceCache:U,layer:q,coords:Z,colorMode:ee}=j,re=B.context.gl,ue=j.painter.shadowRenderer,le=!!ue&&ue.enabled,se=new ft(B.context.gl.LEQUAL,ft.ReadOnly,B.depthRangeFor3D),oe=[0,0,0];if(le){let fe=B.style.directionalLight,Te=B.style.ambientLight;fe&&Te&&(oe=pl(B.style,fe,Te))}let he=fe=>{for(let Te of Z){let Ie=U.getTile(Te),Be=Ie.getBucket(q);if(!Be)continue;let Ve=Be.elevatedStructures;if(!Ve)continue;let We,we;if(fe?(We=Ve.renderableBridgeSegments,we=Ve.bridgeProgramConfigurations.get(q.id)):(We=Ve.renderableTunnelSegments,we=Ve.tunnelProgramConfigurations.get(q.id)),!We||We.segments[0].primitiveLength===0)continue;we.updatePaintBuffers(),B.prepareDrawTile();let Oe=B.isTileAffectedByFog(Te),_e=[];le&&_e.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");let Ue=B.getOrCreateProgram("elevatedStructures",{config:we,overrideFog:Oe,defines:_e}),Me=B.translatePosMatrix(Te.projMatrix,Ie,q.paint.get("fill-translate"),q.paint.get("fill-translate-anchor"));le&&ue.setupShadows(Ie.tileID.toUnwrapped(),Ue,"vector-tile",Ie.tileID.overscaledZ);let Ge=Zb(Me,oe);B.uploadCommonUniforms(B.context,Ue,Te.toUnwrapped()),Ue.draw(B,re.TRIANGLES,se,Bt.disabled,ee,Pt.backCCW,Ge,q.id,Ve.vertexBuffer,Ve.indexBuffer,We,q.paint,B.transform.zoom,we,[Ve.vertexBufferNormal])}};he(!0),he(!1)}(P)}}else mm(P,!1,u.stencilModeFor3D());else u.shadowRenderer&&M==="road"&&!O&&function(k){let{painter:j,sourceCache:B,layer:U,coords:q}=k,Z=j.context.gl,ee=k.painter.shadowRenderer;for(let re of q){let ue=B.getTile(re),le=ue.getBucket(U);if(!le)continue;let se=le.elevatedStructures;if(!se||!se.shadowCasterSegments||se.shadowCasterSegments.segments[0].primitiveLength===0)continue;j.prepareDrawTile();let oe=le.bufferData.programConfigurations.get(U.id),he=j.isTileAffectedByFog(re),fe=j.getOrCreateProgram("elevatedStructuresDepth",{config:oe,overrideFog:he}),Te=ee.calculateShadowPassMatrixFromTile(ue.tileID.toUnwrapped());j.uploadCommonUniforms(j.context,fe,re.toUnwrapped());let Ie={u_matrix:Te,u_depth_bias:.001};fe.draw(j,Z.TRIANGLES,ee.getShadowPassDepthMode(),Bt.disabled,ee.getShadowPassColorMode(),Pt.disabled,Ie,U.id,se.vertexBuffer,se.indexBuffer,se.shadowCasterSegments,U.paint,j.transform.zoom,oe)}}(P)},"fill-extrusion":function(u,t,o,h){let m=o.paint.get("fill-extrusion-opacity"),_=u.context,v=_.gl,E=u.terrain,T=E&&E.renderingToTexture;if(m===0)return;let C=u.conflationActive&&u.style.isLayerClipped(o,t.getSource()),M=u.style.order.indexOf(o.fqid);if(C&&function(O,P,k,j,B){for(let U of j){let q=P.getTile(U).getBucket(k);q&&(q.updateReplacement(U,O.replacementSource,B),q.uploadCentroid(O.context))}}(u,t,o,h,M),E||C)for(let O of h){let P=t.getTile(O).getBucket(o);P&&pt(u.context,t,O,P,o,E,C)}if(u.renderPass==="shadow"&&u.shadowRenderer){let O=u.shadowRenderer;if(E&&m<.65&&o._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof i.ab)return;let P=O.getShadowPassDepthMode(),k=O.getShadowPassColorMode();js(u,t,o,h,P,Bt.disabled,k,C)}else if(u.renderPass==="translucent"){let O=!o.paint.get("fill-extrusion-pattern").constantOr(1),P=o.paint.get("fill-extrusion-color").constantOr(i.am.white);if(!T&&P.a!==0){let k=new ft(u.context.gl.LEQUAL,ft.ReadWrite,u.depthRangeFor3D);m===1&&O?js(u,t,o,h,k,Bt.disabled,en.unblended,C):(js(u,t,o,h,k,Bt.disabled,en.disabled,C),js(u,t,o,h,k,u.stencilModeFor3D(),u.colorModeForRenderPass(),C),u.resetStencilClippingMasks())}if(u.style.enable3dLights()&&O&&(!E&&u.transform.projection.name!=="globe"||T)){let k=o.paint.get("fill-extrusion-opacity"),j=o.paint.get("fill-extrusion-ambient-occlusion-intensity"),B=o.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),U=o.paint.get("fill-extrusion-flood-light-intensity"),q=o.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",Z=o.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(q?null:o.lut).toArray01().slice(0,3),ee=j>0&&B>0,re=U>0,ue=(se,oe,he)=>(1-he)*se+he*oe,le=se=>{let oe=u.depthModeForSublayer(1,ft.ReadOnly,v.LEQUAL,!0),he=o.paint.get(se?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),fe=ue(.1,3,he),Te=u._showOverdrawInspector;if(!Te){let Ie=new Bt({func:v.ALWAYS,mask:255},255,255,v.KEEP,v.KEEP,v.REPLACE),Be=new en([v.ONE,v.ONE,v.ONE,v.ONE],i.am.transparent,[!1,!1,!1,!0],v.MIN);Us(u,t,o,h,oe,Ie,Be,Pt.disabled,se,"sdf",k,j,B,U,Z,fe,C,!1)}{let Ie=Te?Bt.disabled:new Bt({func:v.EQUAL,mask:255},255,255,v.KEEP,v.DECR,v.DECR),Be=Te?u.colorModeForRenderPass():new en([v.ONE_MINUS_DST_ALPHA,v.DST_ALPHA,v.ONE,v.ONE],i.am.transparent,[!0,!0,!0,!0]);Us(u,t,o,h,oe,Ie,Be,Pt.disabled,se,"color",k,j,B,U,Z,fe,C,!1)}};if(T){let se=(oe,he,fe)=>{let Te=u.depthModeForSublayer(1,ft.ReadOnly,v.LEQUAL,!1),Ie=o.paint.get(oe?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Be=ue(.1,3,Ie);{let Ve=new en([v.ONE,v.ONE,v.ONE,v.ONE],i.am.transparent,[!1,!1,!1,!0]);Us(u,t,o,h,Te,Bt.disabled,Ve,Pt.disabled,oe,"clear",k,j,B,U,Z,Be,C,he)}{let Ve=new Bt({func:v.ALWAYS,mask:255},255,255,v.KEEP,v.KEEP,v.REPLACE),We=new en([v.ONE,v.ONE,v.ONE,v.ONE],i.am.transparent,[!1,!1,!1,!0],v.MIN);Us(u,t,o,h,Te,Ve,We,Pt.disabled,oe,"sdf",k,j,B,U,Z,Be,C,he)}{let Ve=oe?v.ZERO:v.ONE_MINUS_DST_ALPHA,We=new Bt({func:v.EQUAL,mask:255},255,255,v.KEEP,v.DECR,v.DECR),we=new en([Ve,v.DST_ALPHA,v.ONE_MINUS_DST_ALPHA,v.ZERO],i.am.transparent,[!0,!0,!0,!0]);Us(u,t,o,h,Te,We,we,Pt.disabled,oe,"color",k,j,B,U,Z,Be,C,he)}{let Ve=new en([v.ONE,v.ONE,v.ONE,oe?v.ZERO:v.ONE],i.am.transparent,[!1,!1,!1,!0],oe?v.FUNC_ADD:v.MAX);Us(u,t,o,h,Te,Bt.disabled,Ve,Pt.disabled,oe,"clear",k,j,B,U,Z,Be,C,he,fe)}};if(ee||re){let oe;if(u.prepareDrawTile(),E){let he=E.drapeBufferSize[0],fe=E.drapeBufferSize[1];oe=E.framebufferCopyTexture,oe&&(!oe||oe.size[0]===he&&oe.size[1]===fe)||(oe&&oe.destroy(),oe=E.framebufferCopyTexture=new i.T(_,new i.r({width:he,height:fe}),v.RGBA8)),oe.bind(v.LINEAR,v.CLAMP_TO_EDGE),v.copyTexSubImage2D(v.TEXTURE_2D,0,0,0,0,0,he,fe)}ee&&se(!0,!1,oe),re&&se(!1,!0,oe)}}else ee&&le(!0),re&&le(!1),(ee||re)&&u.resetStencilClippingMasks()}}},building:function(u,t,o,h){},hillshade:function(u,t,o,h){if(u.renderPass!=="offscreen"&&u.renderPass!=="translucent"||u.style.disableElevatedTerrain)return;let m=u.context,_=u.terrain&&u.terrain.renderingToTexture,[v,E]=u.renderPass!=="translucent"||_?[{},h]:u.stencilConfigForOverlap(h);for(let T of E){let C=t.getTile(T);if(C.needsHillshadePrepare&&u.renderPass==="offscreen")Fb(u,C,o);else if(u.renderPass==="translucent"){let M=u.depthModeForSublayer(0,ft.ReadOnly),O=o.paint.get("hillshade-emissive-strength"),P=u.colorModeForDrapableLayerRenderPass(O),k=_&&u.terrain?u.terrain.stencilModeForRTTOverlap(T):v[T.overscaledZ];kb(u,T,C,o,M,k,P)}}m.viewport.set([0,0,u.width,u.height]),u.resetStencilClippingMasks()},raster:function(u,t,o,h,m,_){if(u.renderPass!=="translucent"||o.paint.get("raster-opacity")===0)return;let v=u.transform.projection.name==="globe",E=o.paint.get("raster-elevation")!==0,T=E&&v;if(u.renderElevatedRasterBackface&&!T)return;let C=u.context,M=C.gl,O=t.getSource(),P=function(le,se,oe,he){let fe=se.paint.get("raster-color"),Te=le.type==="raster-array",Ie=[],Be=se.paint.get("raster-resampling"),Ve=se.paint.get("raster-color-mix"),We=se.paint.get("raster-color-range"),we=[Ve[0],Ve[1],Ve[2],0],Oe=Ve[3],_e=Be==="nearest"?he.NEAREST:he.LINEAR;if(Te&&(Ie.push("RASTER_ARRAY"),fe||Ie.push("RASTER_COLOR"),Be==="linear"&&Ie.push("RASTER_ARRAY_LINEAR"),_e=he.NEAREST,!We&&le.rasterLayers)){let Ue=le.rasterLayers.find(({id:Me})=>Me===se.sourceLayer);Ue&&Ue.fields&&Ue.fields.range&&(We=Ue.fields.range)}if(We=We||[0,1],fe){Ie.push("RASTER_COLOR"),oe.activeTexture.set(he.TEXTURE2),se.updateColorRamp(We);let Ue=se.colorRampTexture;Ue||(Ue=se.colorRampTexture=new i.T(oe,se.colorRamp,he.RGBA8)),Ue.bind(he.LINEAR,he.CLAMP_TO_EDGE)}return{mix:we,range:We,offset:Oe,defines:Ie,resampling:_e}}(O,o,C,M);if(O instanceof i.aP&&!h.length&&!v)return;let k=o.paint.get("raster-emissive-strength"),j=u.colorModeForDrapableLayerRenderPass(k),B=u.terrain&&u.terrain.renderingToTexture,U=!u.options.moving,q=o.paint.get("raster-resampling")==="nearest"?M.NEAREST:M.LINEAR;if(O instanceof i.aP&&!h.length&&(O.onNorthPole||O.onSouthPole)){let le=E?u.stencilModeFor3D():Bt.disabled;return void Ku(!!O.onNorthPole,null,u,t,o,k,P,Pt.disabled,le)}if(!h.length)return;let[Z,ee]=O instanceof i.aP||B?[{},h]:u.stencilConfigForOverlap(h),re=ee[ee.length-1].overscaledZ;T&&P.defines.push("PROJECTION_GLOBE_VIEW"),E&&P.defines.push("RENDER_CUTOFF");let ue=(le,se,oe)=>{for(let he of le){let fe=he.toUnwrapped(),Te=t.getTile(he);if(B&&(!Te||!Te.hasData()))continue;C.activeTexture.set(M.TEXTURE0);let Ie=e1(Te,O,o,P);if(!Ie||!Ie.texture)continue;let{texture:Be,mix:Ve,offset:We,tileSize:we,buffer:Oe}=Ie,_e,Ue;B?(_e=ft.disabled,Ue=he.projMatrix):E?(_e=new ft(M.LEQUAL,ft.ReadWrite,u.depthRangeFor3D),Ue=v?Float32Array.from(u.transform.expandedFarZProjMatrix):u.transform.calculateProjMatrix(fe,U)):(_e=u.depthModeForSublayer(he.overscaledZ-re,o.paint.get("raster-opacity")===1?ft.ReadWrite:ft.ReadOnly,M.LESS),Ue=u.transform.calculateProjMatrix(fe,U));let Me=u.terrain&&B?u.terrain.stencilModeForRTTOverlap(he):Z[he.overscaledZ],Ge=_?0:o.paint.get("raster-fade-duration");Te.registerFadeDuration(Ge);let nt=t.findLoadedParent(he,0),je=yl(Te,nt,t,u.transform,Ge),et,mt;u.terrain&&u.terrain.prepareDrawTile(),C.activeTexture.set(M.TEXTURE0),Be.bind(q,M.CLAMP_TO_EDGE),C.activeTexture.set(M.TEXTURE1),nt?(nt.texture&&nt.texture.bind(q,M.CLAMP_TO_EDGE),et=Math.pow(2,nt.tileID.overscaledZ-Te.tileID.overscaledZ),mt=[Te.tileID.canonical.x*et%1,Te.tileID.canonical.y*et%1]):Be.bind(q,M.CLAMP_TO_EDGE),"useMipmap"in Be&&C.extTextureFilterAnisotropic&&u.transform.pitch>20&&M.texParameterf(M.TEXTURE_2D,C.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,C.extTextureFilterAnisotropicMax);let gt=u.transform,dt,Et=E?Qb(gt):[0,0,0,0],St,Ct,Nt,Zt,Dn,Kn=0;if(T&&O instanceof i.aP&&O.coordinates.length>3)St=Float32Array.from(i.bh(i.dr(new i.cp(0,0,0)))),Ct=Float32Array.from(gt.globeMatrix),Nt=Float32Array.from(i.dm(gt)),Zt=[i.aD(gt.center.lng),i.aH(gt.center.lat)],dt=O.elevatedGlobePerspectiveTransform,Dn=O.elevatedGlobeGridMatrix||new Float32Array(9);else if(T){let Ht=i.dn(he.canonical);Kn=i.dp(Ht.getCenter().lat),St=Float32Array.from(i.bh(i.dr(he.canonical))),Ct=Float32Array.from(gt.globeMatrix),Nt=Float32Array.from(i.dm(gt)),Zt=[i.aD(gt.center.lng),i.aH(gt.center.lat)],dt=[0,0],Dn=Float32Array.from(i.dq(he.canonical,Ht,Kn,gt.worldSize/gt._pixelsPerMercatorPixel))}else dt=O instanceof i.aP?O.perspectiveTransform:[0,0],St=new Float32Array(16),Ct=new Float32Array(9),Nt=new Float32Array(16),Zt=[0,0],Dn=new Float32Array(9);let Rn=um(Ue,St,Ct,Nt,Dn,mt||[0,0],i.ah(u.transform.zoom),Zt,Et,et||1,je,o,dt,E?o.paint.get("raster-elevation"):0,2,Ve,We,P.range,we,Oe,k),kn=u.isTileAffectedByFog(he),Pi=u.getOrCreateProgram("raster",{defines:P.defines,overrideFog:kn});if(u.uploadCommonUniforms(C,Pi,fe),O instanceof i.aP){let Ht=O.elevatedGlobeVertexBuffer,Kt=O.elevatedGlobeIndexBuffer;if(B||!v)O.boundsBuffer&&O.boundsSegments&&Pi.draw(u,M.TRIANGLES,_e,Bt.disabled,j,Pt.disabled,Rn,o.id,O.boundsBuffer,u.quadTriangleIndexBuffer,O.boundsSegments);else if(Ht&&Kt){let on=gt.zoom<=i.cL?O.elevatedGlobeSegments:O.getSegmentsForLongitude(gt.center.lng);on&&Pi.draw(u,M.TRIANGLES,_e,Bt.disabled,j,se,Rn,o.id,Ht,Kt,on)}}else if(T){_e=new ft(M.LEQUAL,ft.ReadOnly,u.depthRangeFor3D);let Ht=u.globeSharedBuffers;if(Ht){let[Kt,on,ni]=Ht.getGridBuffers(Kn,!1);Pi.draw(u,M.TRIANGLES,_e,oe||Me,u.colorModeForRenderPass(),se,Rn,o.id,Kt,on,ni)}}else{let{tileBoundsBuffer:Ht,tileBoundsIndexBuffer:Kt,tileBoundsSegments:on}=u.getTileBoundsBuffers(Te);Pi.draw(u,M.TRIANGLES,_e,Me,j,Pt.disabled,Rn,o.id,Ht,Kt,on)}}if(!(O instanceof i.aP)&&T)for(let he of le){let fe=he.canonical.y===(1<<he.canonical.z)-1;he.canonical.y===0&&Ku(!0,he,u,t,o,k,P,se,oe||Bt.disabled),fe&&Ku(!1,he,u,t,o,k,P,se===Pt.frontCW?Pt.backCW:Pt.frontCW,oe||Bt.disabled)}};T?ue(ee,u.renderElevatedRasterBackface?Pt.backCW:Pt.frontCW,u.stencilModeFor3D()):ue(ee,Pt.disabled,void 0),u.resetStencilClippingMasks()},"raster-particle":function(u,t,o,h,m,_){u.renderPass==="offscreen"&&function(v,E,T,C){if(!C.length)return;let M=v.context,O=M.gl,P=E.getSource();if(!(P instanceof ga))return;let k=Math.ceil(Math.sqrt(T.paint.get("raster-particle-count"))),j=T.particlePositionRGBAImage;if(!j||j.width!==k){let ee=function(re){let ue=re*re,le=new Uint8Array(4*ue),se=function(he){return he|=0,he=Math.imul(2747636419^he,2654435769),he=Math.imul(he^he>>>16,2654435769),((he=Math.imul(he^he>>>16,2654435769))>>>0)/4294967296},oe=1/1.1;for(let he=0;he<ue;he++){let fe=oe*(se(2*he+0)+Ea),Te=oe*(se(2*he+1)+Ea),Ie=255*fe%1,Be=255*Te%1,Ve=Ie,We=Te-Be/255,we=Be;le[4*he+0]=255*(fe-Ie/255),le[4*he+1]=255*Ve,le[4*he+2]=255*We,le[4*he+3]=255*we}return le}(k);j=T.particlePositionRGBAImage=new i.r({width:k,height:k},ee)}let B=T.particleFramebuffer;B?B.width!==k&&(B.destroy(),B=T.particleFramebuffer=M.createFramebuffer(k,k,!0,null)):B=T.particleFramebuffer=M.createFramebuffer(k,k,!0,null);let U=[];for(let ee of C){let re=E.getTile(ee);if(!(re instanceof tc))continue;let ue=t1(re,P,T);if(!ue)continue;let le=[re.tileSize,re.tileSize],se=T.tileFramebuffer;se||(se=T.tileFramebuffer=M.createFramebuffer(le[0],le[1],!0,null));let oe=re.rasterParticleState;oe||(oe=re.rasterParticleState=new gy(M,ee,le,j));let he=oe.update(T.lastInvalidatedAt);oe.particleTextureDimension!==k&&oe.updateParticleTexture(ee,j);let fe=oe.targetColorTexture;oe.targetColorTexture=oe.backgroundColorTexture,oe.backgroundColorTexture=fe;let Te=oe.particleTexture0;oe.particleTexture0=oe.particleTexture1,oe.particleTexture1=Te,U.push([ee,ue,oe,he])}if(U.length===0)return;let q=i.q.now(),Z=T.previousDrawTimestamp?.001*(q-T.previousDrawTimestamp):.0167;if(T.previousDrawTimestamp=q,T.hasColorMap()){M.activeTexture.set(O.TEXTURE0+2);let ee=T.colorRampTexture;ee||(ee=T.colorRampTexture=new i.T(M,T.colorRamp,O.RGBA8)),ee.bind(O.LINEAR,O.CLAMP_TO_EDGE)}M.bindFramebuffer.set(T.tileFramebuffer.framebuffer),function(ee,re,ue){let le=ee.context,se=le.gl,oe=re.tileFramebuffer;le.activeTexture.set(se.TEXTURE0);let he={u_texture:0,u_opacity:1.05*(Te=re.paint.get("raster-particle-fade-opacity-factor"))/(Te+.05)},fe=ee.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Te;for(let Ie of ue){let[,,Be,Ve]=Ie;oe.colorAttachment.set(Be.targetColorTexture.texture),le.viewport.set([0,0,oe.width,oe.height]),le.clear({color:i.am.transparent}),Ve&&(Be.backgroundColorTexture.bind(se.NEAREST,se.CLAMP_TO_EDGE),fe.draw(ee,se.TRIANGLES,ft.disabled,Bt.disabled,en.alphaBlended,Pt.disabled,he,re.id,ee.viewportBuffer,ee.quadTriangleIndexBuffer,ee.viewportSegments))}}(v,T,U),function(ee,re,ue,le){let se=ee.context,oe=se.gl,he=ue.tileFramebuffer,fe=ee.transform.projection.name==="globe",Te=ue.paint.get("raster-particle-max-speed");for(let Ie of le){let[Be,Ve,We]=Ie;se.activeTexture.set(oe.TEXTURE0+0),Ve.texture.bind(oe.LINEAR,oe.CLAMP_TO_EDGE),he.colorAttachment.set(We.targetColorTexture.texture);let we=ee.getOrCreateProgram("rasterParticleDraw",{defines:Ve.defines,overrideFog:!1});se.activeTexture.set(oe.TEXTURE0+1);let Oe=Ve.scalarData?[]:[0,1,2,3].map(Me=>i.dT[Me](Be));Oe.push(Be);let _e=Be.canonical.x,Ue=Be.canonical.y;for(let Me of Oe){let Ge=re.getTile(fe?Me.wrapped():Me);if(!Ge)continue;let nt=Ge.rasterParticleState;if(!nt)continue;let je=Me.canonical.x+(1<<Me.canonical.z)*(Me.wrap-Be.wrap),et=Me.canonical.y;nt.particleTexture0.bind(oe.NEAREST,oe.CLAMP_TO_EDGE);let mt=uy(1,nt.particleTexture0.size[0],[je-_e,et-Ue],0,Ve.texture.size,2,Te,Ve.textureOffset,Ve.scale,Ve.offset);we.draw(ee,oe.POINTS,ft.disabled,Bt.disabled,en.alphaBlended,Pt.disabled,mt,ue.id,nt.particleIndexBuffer,void 0,nt.particleSegment)}}}(v,E,T,U),M.bindFramebuffer.set(T.particleFramebuffer.framebuffer),function(ee,re,ue,le){let se=ee.context,oe=se.gl,he=re.paint.get("raster-particle-max-speed"),fe=le*re.paint.get("raster-particle-speed-factor")*.15,Te=function(Be){return Math.pow(Be,6)}(.01+1*re.paint.get("raster-particle-reset-rate-factor")),Ie=re.particleFramebuffer;se.viewport.set([0,0,Ie.width,Ie.height]);for(let Be of ue){let[,Ve,We]=Be;se.activeTexture.set(oe.TEXTURE0+0),Ve.texture.bind(oe.LINEAR,oe.CLAMP_TO_EDGE),se.activeTexture.set(oe.TEXTURE0+1);let we=We.particleTexture0;we.bind(oe.NEAREST,oe.CLAMP_TO_EDGE);let Oe=Ta(1,we.size[0],0,Ve.texture.size,he,fe,Te,Ve.textureOffset,Ve.scale,Ve.offset);Ie.colorAttachment.set(We.particleTexture1.texture),se.clear({color:i.am.transparent}),ee.getOrCreateProgram("rasterParticleUpdate",{defines:Ve.defines}).draw(ee,oe.TRIANGLES,ft.disabled,Bt.disabled,en.unblended,Pt.disabled,Oe,re.id,ee.viewportBuffer,ee.quadTriangleIndexBuffer,ee.viewportSegments)}}(v,T,U,Z)}(u,t,o,h),u.renderPass==="translucent"&&(function(v,E,T,C,M){let O=v.context,P=O.gl,k=E.getSource().tileSize,j=5*(1-i.af(i.cx,i.cx+1,v.transform.zoom))*k+T.paint.get("raster-particle-elevation"),B=!v.options.moving,U=v.transform.projection.name==="globe";if(!C.length)return;let[q,Z]=v.stencilConfigForOverlap(C),ee=[];U&&ee.push("PROJECTION_GLOBE_VIEW");let re=v.stencilModeFor3D();for(let ue of Z){let le=ue.toUnwrapped(),se=E.getTile(ue);if(!se.rasterParticleState)continue;let oe=se.rasterParticleState,he=100;se.registerFadeDuration(he);let fe=E.findLoadedParent(ue,0),Te=yl(se,fe,E,v.transform,he),Ie,Be;v.terrain&&v.terrain.prepareDrawTile(),O.activeTexture.set(P.TEXTURE0),oe.targetColorTexture.bind(P.LINEAR,P.CLAMP_TO_EDGE),O.activeTexture.set(P.TEXTURE1),fe&&fe.rasterParticleState?(fe.rasterParticleState.targetColorTexture.bind(P.LINEAR,P.CLAMP_TO_EDGE),Ie=Math.pow(2,fe.tileID.overscaledZ-se.tileID.overscaledZ),Be=[se.tileID.canonical.x*Ie%1,se.tileID.canonical.y*Ie%1]):oe.targetColorTexture.bind(P.LINEAR,P.CLAMP_TO_EDGE);let Ve=U?Float32Array.from(v.transform.expandedFarZProjMatrix):v.transform.calculateProjMatrix(le,B),We=v.transform,we=_y(We),Oe=i.dn(ue.canonical),_e=i.dp(Oe.getCenter().lat),Ue,Me,Ge,nt,je;U?(Ue=Float32Array.from(i.bh(i.dr(ue.canonical))),Me=Float32Array.from(We.globeMatrix),Ge=Float32Array.from(i.dm(We)),nt=[i.aD(We.center.lng),i.aH(We.center.lat)],je=Float32Array.from(i.dq(ue.canonical,Oe,_e,We.worldSize/We._pixelsPerMercatorPixel))):(Ue=new Float32Array(16),Me=new Float32Array(9),Ge=new Float32Array(16),nt=[0,0],je=new Float32Array(9));let et=bl(Ve,Ue,Me,Ge,je,Be||[0,0],i.ah(v.transform.zoom),nt,we,Ie||1,Te,j),mt=v.isTileAffectedByFog(ue),gt=v.getOrCreateProgram("rasterParticle",{defines:ee,overrideFog:mt});if(v.uploadCommonUniforms(O,gt,le),U){let dt=new ft(P.LEQUAL,ft.ReadOnly,v.depthRangeFor3D),Et=0,St=v.globeSharedBuffers;if(St){let[Ct,Nt,Zt]=St.getGridBuffers(_e,Et!==0);gt.draw(v,P.TRIANGLES,dt,re,en.alphaBlended,v.renderElevatedRasterBackface?Pt.frontCCW:Pt.backCCW,et,T.id,Ct,Nt,Zt)}}else{let dt=v.depthModeForSublayer(0,ft.ReadOnly),Et=q[ue.overscaledZ],{tileBoundsBuffer:St,tileBoundsIndexBuffer:Ct,tileBoundsSegments:Nt}=v.getTileBoundsBuffers(se);gt.draw(v,P.TRIANGLES,dt,Et,en.alphaBlended,Pt.disabled,et,T.id,St,Ct,Nt)}}v.resetStencilClippingMasks()}(u,t,o,h),u.style.map.triggerRepaint())},background:function(u,t,o,h){let m=o.paint.get("background-color"),_=o.paint.get("background-color-use-theme").constantOr("default")==="none",v=o.paint.get("background-opacity"),E=o.paint.get("background-emissive-strength"),T=o.paint.get("background-pitch-alignment")==="viewport";if(v===0)return;let C=u.context,M=C.gl,O=u.transform,P=O.tileSize,k=o.paint.get("background-pattern"),j;if(k!==void 0&&(k===null||(j=u.imageManager.getPattern(i.I.from(k.toString()),o.scope,u.style.getLut(o.scope)),!j)))return;let B=!k&&m.a===1&&v===1&&u.opaquePassEnabledForLayer()?"opaque":"translucent";if(u.renderPass!==B)return;let U=Bt.disabled,q=u.depthModeForSublayer(0,B==="opaque"?ft.ReadWrite:ft.ReadOnly),Z=u.colorModeForDrapableLayerRenderPass(E),ee=k?"backgroundPattern":"background",re,ue=h;if(ue||(re=u.getBackgroundTiles(),ue=Object.values(re).map(le=>le.tileID)),k&&(C.activeTexture.set(M.TEXTURE0),u.imageManager.bind(u.context,o.scope)),T){let le=u.getOrCreateProgram(ee,{overrideFog:!1,overrideRtt:!0}),se=new Float32Array(i.bx([])),oe=new i.aM(0,0,0,0,0),he=k?dm(se,E,v,u,0,o.scope,j,T,{tileID:oe,tileSize:P}):hm(se,E,v,m.toPremultipliedRenderColor(_?null:o.lut));le.draw(u,M.TRIANGLES,q,U,Z,Pt.disabled,he,o.id,u.viewportBuffer,u.quadTriangleIndexBuffer,u.viewportSegments)}else for(let le of ue){let se=u.isTileAffectedByFog(le),oe=u.getOrCreateProgram(ee,{overrideFog:se}),he=le.toUnwrapped(),fe=h?le.projMatrix:u.transform.calculateProjMatrix(he);u.prepareDrawTile();let Te=t?t.getTile(le):re?re[le.key]:new ol(le,P,O.zoom,u),Ie=k?dm(fe,E,v,u,0,o.scope,j,T,{tileID:le,tileSize:P}):hm(fe,E,v,m.toPremultipliedRenderColor(_?null:o.lut));u.uploadCommonUniforms(C,oe,he);let{tileBoundsBuffer:Be,tileBoundsIndexBuffer:Ve,tileBoundsSegments:We}=u.getTileBoundsBuffers(Te);oe.draw(u,M.TRIANGLES,q,U,Z,Pt.disabled,Ie,o.id,Be,Ve,We)}},sky:function(u,t,o){let h=u._atmosphere?i.ah(u.transform.zoom):1,m=o.paint.get("sky-opacity")*h;if(m===0)return;let _=u.context,v=o.paint.get("sky-type"),E=new ft(_.gl.LEQUAL,ft.ReadOnly,[0,1]),T=u.frameCounter/1e3%1;v==="atmosphere"?u.renderPass==="offscreen"?o.needsSkyboxCapture(u)&&(function(C,M,O,P){let k=C.context,j=k.gl,B=M.skyboxFbo;if(!B){B=M.skyboxFbo=k.createFramebuffer(32,32,!0,null),M.skyboxGeometry=new Ju(k),M.skyboxTexture=k.gl.createTexture(),j.bindTexture(j.TEXTURE_CUBE_MAP,M.skyboxTexture),j.texParameteri(j.TEXTURE_CUBE_MAP,j.TEXTURE_WRAP_S,j.CLAMP_TO_EDGE),j.texParameteri(j.TEXTURE_CUBE_MAP,j.TEXTURE_WRAP_T,j.CLAMP_TO_EDGE),j.texParameteri(j.TEXTURE_CUBE_MAP,j.TEXTURE_MIN_FILTER,j.LINEAR),j.texParameteri(j.TEXTURE_CUBE_MAP,j.TEXTURE_MAG_FILTER,j.LINEAR);for(let ee=0;ee<6;++ee)j.texImage2D(j.TEXTURE_CUBE_MAP_POSITIVE_X+ee,0,j.RGBA,32,32,0,j.RGBA,j.UNSIGNED_BYTE,null)}k.bindFramebuffer.set(B.framebuffer),k.viewport.set([0,0,32,32]);let U=M.getCenter(C,!0),q=C.getOrCreateProgram("skyboxCapture"),Z=new Float64Array(16);i.bx(Z),i.e3(Z,Z,.5*-Math.PI),Da(C,M,q,Z,U,0),i.bx(Z),i.e3(Z,Z,.5*Math.PI),Da(C,M,q,Z,U,1),i.bx(Z),i.cG(Z,Z,.5*-Math.PI),Da(C,M,q,Z,U,2),i.bx(Z),i.cG(Z,Z,.5*Math.PI),Da(C,M,q,Z,U,3),i.bx(Z),Da(C,M,q,Z,U,4),i.bx(Z),i.e3(Z,Z,Math.PI),Da(C,M,q,Z,U,5),k.viewport.set([0,0,C.width,C.height])}(u,o),o.markSkyboxValid(u)):u.renderPass==="sky"&&function(C,M,O,P,k){let j=C.context,B=j.gl,U=C.transform,q=C.getOrCreateProgram("skybox");j.activeTexture.set(B.TEXTURE0),B.bindTexture(B.TEXTURE_CUBE_MAP,M.skyboxTexture);let Z=((ee,re,ue,le,se)=>({u_matrix:ee,u_sun_direction:re,u_cubemap:0,u_opacity:le,u_temporal_offset:se}))(U.skyboxMatrix,M.getCenter(C,!1),0,P,k);C.uploadCommonUniforms(j,q),q.draw(C,B.TRIANGLES,O,Bt.disabled,C.colorModeForRenderPass(),Pt.backCW,Z,"skybox",M.skyboxGeometry.vertexBuffer,M.skyboxGeometry.indexBuffer,M.skyboxGeometry.segment)}(u,o,E,m,T):v==="gradient"&&u.renderPass==="sky"&&function(C,M,O,P,k){let j=C.context,B=j.gl,U=C.transform,q=C.getOrCreateProgram("skyboxGradient");M.skyboxGeometry||(M.skyboxGeometry=new Ju(j)),j.activeTexture.set(B.TEXTURE0);let Z=M.colorRampTexture;Z||(Z=M.colorRampTexture=new i.T(j,M.colorRamp,B.RGBA8)),Z.bind(B.LINEAR,B.CLAMP_TO_EDGE);let ee=((re,ue,le,se,oe)=>({u_matrix:re,u_color_ramp:0,u_center_direction:ue,u_radius:i.al(le),u_opacity:se,u_temporal_offset:oe}))(U.skyboxMatrix,M.getCenter(C,!1),M.paint.get("sky-gradient-radius"),P,k);C.uploadCommonUniforms(j,q),q.draw(C,B.TRIANGLES,O,Bt.disabled,C.colorModeForRenderPass(),Pt.backCW,ee,"skyboxGradient",M.skyboxGeometry.vertexBuffer,M.skyboxGeometry.indexBuffer,M.skyboxGeometry.segment)}(u,o,E,m,T)},custom:function(u,t,o,h){let m=u.context,_=o.implementation;if(!u.transform.projection.unsupportedLayers||!u.transform.projection.unsupportedLayers.includes("custom")||u.terrain&&(u.terrain.renderingToTexture||u.renderPass==="offscreen")&&o.isDraped(t)){if(u.renderPass==="offscreen"){let v=_.prerender;if(v){if(u.setCustomLayerDefaults(),m.setColorMode(u.colorModeForRenderPass()),u.transform.projection.name==="globe"){let E=u.transform.pointMerc;v.call(_,m.gl,u.transform.customLayerMatrix(),u.transform.getProjection(),u.transform.globeToMercatorMatrix(),i.ah(u.transform.zoom),[E.x,E.y],u.transform.pixelsPerMeterRatio)}else v.call(_,m.gl,u.transform.customLayerMatrix());m.setDirty(),u.setBaseState()}}else if(u.renderPass==="translucent"){if(u.terrain&&u.terrain.renderingToTexture){let E=_.renderToTile;if(E){let T=h[0].canonical,C={x:T.x+h[0].wrap*(_.wrapTileId?0:1<<T.z),y:T.y,z:T.z};m.setDepthMode(ft.disabled),m.setStencilMode(Bt.disabled),m.setColorMode(u.colorModeForRenderPass()),u.setCustomLayerDefaults(),E.call(_,m.gl,C),m.setDirty(),u.setBaseState()}return}u.setCustomLayerDefaults(),m.setColorMode(u.colorModeForRenderPass()),m.setStencilMode(Bt.disabled);let v=_.renderingMode==="3d"?new ft(u.context.gl.LEQUAL,ft.ReadWrite,u.depthRangeFor3D):u.depthModeForSublayer(0,ft.ReadOnly);if(m.setDepthMode(v),u.transform.projection.name==="globe"){let E=u.transform.pointMerc;_.render(m.gl,u.transform.customLayerMatrix(),u.transform.getProjection(),u.transform.globeToMercatorMatrix(),i.ah(u.transform.zoom),[E.x,E.y],u.transform.pixelsPerMeterRatio)}else _.render(m.gl,u.transform.customLayerMatrix());m.setDirty(),u.setBaseState(),m.bindFramebuffer.set(null)}}else i.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(u,t,o,h){if(u.renderPass==="opaque")return;let m=o.paint.get("model-opacity").constantOr(1);if(m===0)return;let _=o.paint.get("model-cast-shadows");if(u.renderPass==="shadow"&&(!_||u.terrain&&m<.65&&o._transitionablePaint._values["model-opacity"].value.expression instanceof i.ab))return;let v=u.shadowRenderer,E=o.paint.get("model-receive-shadows");v&&(v.useNormalOffset=!0,E||(v.enabled=!1));let T=()=>{v&&(v.useNormalOffset=!0,E||(v.enabled=!0))},C=t.getSource();if(u.renderPass==="light-beam"&&C.type!=="batched-model")return;if(C.type==="vector"||C.type==="geojson")return function(q,Z,ee,re,ue){let le=q.transform;if(le.projection.name!=="mercator")return void i.w(`Drawing 3D models for ${le.projection.name} projection is not yet implemented`);let se=le.getFreeCameraOptions().position;if(!q.modelManager)return;let oe=q.modelManager;ee.modelManager=oe;let he=q.shadowRenderer;if(!ee._unevaluatedLayout._values.hasOwnProperty("model-id"))return;let fe=ee._unevaluatedLayout._values["model-id"],Te=Object.assign({},ee.layout.get("model-id").parameters),Ie=q.style.order.indexOf(ee.fqid);for(let Be of re){let Ve=Z.getTile(Be).getBucket(ee);if(!Ve||Ve.projection.name!==le.projection.name)continue;let We=Ve.getModelUris();We&&!Ve.modelsRequested&&(oe.addModelsFromBucket(We,ue),Ve.modelsRequested=!0);let we=Hd(Be,le);Te.zoom=we;let Oe=fe.possiblyEvaluate(Te);if(Ee(q,Ve,Be),Jo.shadowUniformsInitialized=!1,Jo.useSingleShadowCascade=!!he&&he.getMaxCascadeForTile(Be.toUnwrapped())===0,q.renderPass==="shadow"&&he){if(q.currentShadowCascade===1&&Ve.isInsideFirstShadowMapFrustum)continue;let Me=le.calculatePosMatrix(Be.toUnwrapped(),le.worldSize);if(Jo.tileMatrix.set(Me),Jo.shadowTileMatrix=Float32Array.from(he.calculateShadowPassMatrixFromMatrix(Me)),Jo.aabb.min.fill(0),Jo.aabb.max[0]=Jo.aabb.max[1]=i.aj,Jo.aabb.max[2]=0,wy(Ve,Jo,q,ee.scope))continue}let _e=1<<Be.canonical.z,Ue=[((se.x-Be.wrap)*_e-Be.canonical.x)*i.aj,(se.y*_e-Be.canonical.y)*i.aj,se.z*_e*i.aj];q.conflationActive&&Object.keys(Ve.instancesPerModel).length>0&&q.style.isLayerClipped(ee,Z.getSource())&&Ve.updateReplacement(Be,q.replacementSource,Ie,ue)&&(Ve.uploaded=!1,Ve.upload(q.context));for(let Me in Ve.instancesPerModel){let Ge=Ve.instancesPerModel[Me];Ge.features.length>0&&(Me=Oe.evaluate(Ge.features[0].feature,{}));let nt=oe.getModel(Me,ue);if(nt||oe.hasURLBeenRequested(Me)||Ve.modelUris.includes(Me)||(Ve.modelUris.push(Me),Ve.modelsRequested=!1),nt&&nt.uploaded)for(let je of nt.nodes)$d(q,ee,je,Ge,Ue,Be,Jo)}}}(u,t,o,h,C.type==="vector"?o.scope:""),void T();if(!C.loaded())return;if(C.type==="batched-model")return function(q,Z,ee,re){ee.resetLayerRenderingStats(q);let ue=q.context,le=q.transform,se=q.style.fog,oe=q.shadowRenderer;if(le.projection.name!=="mercator")return void i.w(`Drawing 3D landmark models for ${le.projection.name} projection is not yet implemented`);let he=q.transform.getFreeCameraOptions().position,fe=i.bY([],[he.x,he.y,he.z],q.transform.worldSize),Te=i.eb([],fe),Ie=i.bx([]),Be=i.ec(le.center.lat,le.zoom),Ve=i.bn([],[1,1,1/Be]);i.bo(Ie,Ie,Te);let We=ee.paint.get("model-opacity").constantOr(1),we=new ft(ue.gl.LEQUAL,ft.ReadWrite,q.depthRangeFor3D),Oe=new ft(ue.gl.LEQUAL,ft.ReadOnly,q.depthRangeFor3D),_e=new i.cW([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Ue=q.renderPass==="shadow",Me=Ue&&oe?oe.getCurrentCascadeFrustum():le.getFrustum(le.scaleZoom(le.worldSize)),Ge=ee.paint.get("model-front-cutoff"),nt=Ge[2]<1,je=ps(q,ee.paint.get("model-cutoff-fade-range")),et=ee.getLayerRenderingStats();(function(mt,gt,dt,Et){let St=mt.terrain?mt.terrain.exaggeration():0,Ct=mt.transform.zoom;for(let Nt of Et){let Zt=gt.getTile(Nt).getBucket(dt);Zt&&(Zt.setFilter(dt.filter),mt.conflationActive&&Zt.updateReplacement(Nt,mt.replacementSource),Zt.evaluateTransform(mt,dt),mt.terrain&&St>0&&Zt.elevationUpdate(mt.terrain,St,Nt,dt.source),Zt.needsReEvaluation(mt,Ct,dt)&&Zt.evaluate(dt))}})(q,Z,ee,re),function(){let mt,gt,dt;nt?(mt=re.length-1,gt=-1,dt=-1):(mt=0,gt=re.length,dt=1);let Et=new Float64Array(16),St=i.ef(),Ct=new i.P(0,0);for(let Nt=mt;Nt!==gt;Nt+=dt){let Zt=re[Nt],Dn=Z.getTile(Zt).getBucket(ee);if(!Dn||!Dn.uploaded)continue;let Kn=!1;oe&&(Kn=oe.getMaxCascadeForTile(Zt.toUnwrapped())===0);let Rn=le.calculatePosMatrix(Zt.toUnwrapped(),le.worldSize),kn=Dn.modelTraits;!Ue&&nt&&(i.bi(Et,Rn),i.ad(St,fe,Et),Ct.x=St[0],Ct.y=St[1]);let Pi=[];Dn.setFilter(ee.filter);for(let Ht of Dn.getNodesInfo()){if(Ht.hiddenByReplacement||!Ht.node.meshes)continue;let Kt=Ht.node,on=0;q.terrain&&Kt.elevation&&(on=Kt.elevation*q.terrain.exaggeration());let ni=(()=>{let Ci=Ht.aabb;return _e.min=[...Ci.min],_e.max=[...Ci.max],_e.min[2]+=on,_e.max[2]+=on,i.ad(_e.min,_e.min,Rn),i.ad(_e.max,_e.max,Rn),_e})(),$i=Ht.evaluatedScale;if($i[0]<=1&&$i[1]<=1&&$i[2]<=1&&ni.intersects(Me)===0)continue;if(!Ue&&nt){let Ci=.16666666666666666;Ht.cameraCollisionOpacity=fe[0]>ni.min[0]&&fe[0]<ni.max[0]&&fe[1]>ni.min[1]&&fe[1]<ni.max[1]&&fe[2]*Be<ni.max[2]&&Kt.footprint&&i.bS(Ct,Kt.footprint)?Math.max(Ht.cameraCollisionOpacity-Ci,0):Math.min(1,Ht.cameraCollisionOpacity+Ci)}let Jn=[...Rn],vn=1/i.cU(Zt.canonical),Ti=Kt.anchor?Kt.anchor[0]:0,dn=Kt.anchor?Kt.anchor[1]:0;i.bo(Jn,Jn,[Ti*($i[0]-1)+Ht.evaluatedTranslation[0]*vn,dn*($i[1]-1)+Ht.evaluatedTranslation[1]*vn,on+Ht.evaluatedTranslation[2]]),i.ci($i,i.eg)||i.cE(Jn,Jn,$i);let zi=i.az([],Jn,Kt.matrix),ii=i.az([],le.expandedFarZProjMatrix,zi),Wn=i.az([],le.expandedFarZProjMatrix,Jn),ri=i.aA([],[Ti,dn,on,1],ii)[2];Kt.hidden=!1;let wn=We;Ue||(nt&&(wn*=Ht.cameraCollisionOpacity,wn*=Sc(Jn,le,Ht.aabb,Ge)),wn*=Ey(je,ri)),wn!==0?Pi.push({nodeInfo:Ht,depth:ri,opacity:wn,wvpForNode:ii,wvpForTile:Wn,nodeModelMatrix:zi,tileModelMatrix:Jn}):Kt.hidden=!0}Ue||Pi.sort((Ht,Kt)=>!nt||Ht.opacity===1&&Kt.opacity===1?Ht.depth<Kt.depth?-1:1:Ht.opacity===1?-1:Kt.opacity===1?1:Ht.depth>Kt.depth?-1:1);for(let Ht of Pi){let Kt=Ht.nodeInfo,on=Kt.node,ni=i.az([],Ve,Ht.tileModelMatrix);i.az(ni,Ie,ni);let $i=i.bi([],ni);i.ee($i,$i),i.cE($i,$i,ym),ni=i.az(ni,ni,on.matrix);let Jn=q.renderPass==="light-beam",vn=ee.paint.get("model-color-use-theme").constantOr("default")==="none",Ti=kn&i.em.HasMapboxMeshFeatures,dn=Ti?0:Kt.evaluatedRMEA[0][2];for(let zi=0;zi<on.meshes.length;++zi){let ii=on.meshes[zi],Wn=zi===on.lightMeshIndex,ri=Ht.wvpForNode;if(Wn){if(!Jn&&!q.terrain&&q.shadowRenderer){q.currentLayer<q.firstLightBeamLayer&&(q.firstLightBeamLayer=q.currentLayer);continue}ri=Ht.wvpForTile}else if(Jn)continue;let wn={defines:[]},Ci=[];if(!Ue&&oe&&(oe.useNormalOffset=!!ii.normalBuffer),Ke(wn.defines,Ci,ii,q,vn?null:ee.lut),Ti||wn.defines.push("DIFFUSE_SHADED"),Kn&&wn.defines.push("SHADOWS_SINGLE_CASCADE"),et&&(Ue?et.numRenderedVerticesInShadowPass+=ii.vertexArray.length:et.numRenderedVerticesInTransparentPass+=ii.vertexArray.length),Ue){Ei(ii,Ht.nodeModelMatrix,q,ee);continue}let ur=null;if(se){let es=El(Ht.nodeModelMatrix,q.transform);if(ur=new Float32Array(es),le.projection.name!=="globe"){let Bo=ii.aabb.min,Jr=ii.aabb.max,[La,ts]=se.getOpacityForBounds(es,Bo[0],Bo[1],Jr[0],Jr[1]);wn.overrideFog=La>=Re||ts>=Re}}let hi=ii.material,_n;hi.occlusionTexture&&hi.occlusionTexture.offsetScale&&(_n=hi.occlusionTexture.offsetScale,wn.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));let co=q.getOrCreateProgram("model",wn);!Ue&&oe&&oe.setupShadowsFromMatrix(Ht.tileModelMatrix,co,oe.useNormalOffset),q.uploadCommonUniforms(ue,co,null,ur);let Kr=hi.pbrMetallicRoughness;Kr.metallicFactor=.9,Kr.roughnessFactor=.5;let Eo=Zu(new Float32Array(ri),new Float32Array(ni),new Float32Array($i),new Float32Array(on.matrix),q,Ht.opacity,Kr.baseColorFactor,hi.emissiveFactor,Kr.metallicFactor,Kr.roughnessFactor,hi,dn,ee,[0,0,0],_n);!Wn&&(Kt.hasTranslucentParts||Ht.opacity<1)&&co.draw(q,ue.gl.TRIANGLES,we,Bt.disabled,en.disabled,Pt.backCCW,Eo,ee.id,ii.vertexBuffer,ii.indexBuffer,ii.segments,ee.paint,q.transform.zoom,void 0,Ci),co.draw(q,ue.gl.TRIANGLES,Wn?Oe:we,Bt.disabled,Wn||Ht.opacity<1||Kt.hasTranslucentParts?en.alphaBlended:en.unblended,Pt.backCCW,Eo,ee.id,ii.vertexBuffer,ii.indexBuffer,ii.segments,ee.paint,q.transform.zoom,void 0,Ci)}}}}()}(u,t,o,h),void T();if(C.type!=="model")return;let M=C.getModels(),O=[],P=u.transform.getFreeCameraOptions().position,k=i.bY([],[P.x,P.y,P.z],u.transform.worldSize);i.eb(k,k);let j=[],B=[],U=0;for(let q of M){let Z=o.paint.get("model-rotation").constantOr(null),ee=o.paint.get("model-scale").constantOr(null),re=o.paint.get("model-translation").constantOr(null);q.computeModelMatrix(u,Z,ee,re,!0,!0,!1);let ue=i.bx([]),le=i.ec(q.position.lat,u.transform.zoom),se=i.bn([],[1,1,1/le]);i.bo(ue,ue,k),O.push({zScaleMatrix:se,negCameraPosMatrix:ue});for(let oe of q.nodes)Tl(u.transform,oe,q.matrix,u.transform.expandedFarZProjMatrix,U,j,B);U++}if(j.sort((q,Z)=>Z.depth-q.depth),u.renderPass!=="shadow"){if(m===1)for(let q of B)ht(q,u,o,O[q.modelIndex],Bt.disabled,u.colorModeForRenderPass());else{for(let q of B)ht(q,u,o,O[q.modelIndex],Bt.disabled,en.disabled);for(let q of B)ht(q,u,o,O[q.modelIndex],u.stencilModeFor3D(),u.colorModeForRenderPass());u.resetStencilClippingMasks()}for(let q of j)ht(q,u,o,O[q.modelIndex],Bt.disabled,u.colorModeForRenderPass());T()}else{for(let q of B)Ei(q.mesh,q.nodeModelMatrix,u,o);for(let q of j)Ei(q.mesh,q.nodeModelMatrix,u,o);T()}}},wm={line:function(u,t,o){if(u.hasElevatedBuckets=!1,u.hasNonElevatedBuckets=!1,u._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||u._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(t){let h=t.getVisibleCoordinates();for(let m of h){let _=t.getTile(m).getBucket(u);if(_&&(_.elevationType!=="none"?u.hasElevatedBuckets=!0:u.hasNonElevatedBuckets=!0,u.hasElevatedBuckets&&u.hasNonElevatedBuckets))break}}}else u.hasNonElevatedBuckets=!0},model:function(u,t,o){let h=t.getSource();if(!h.loaded())return;if(h.type==="vector"||h.type==="geojson")return void(o.modelManager&&o.modelManager.upload(o,h.type==="vector"?u.scope:""));if(h.type==="batched-model"||h.type!=="model")return;let m=h.getModels();for(let _ of m)_.upload(o.context)},raster:function(u,t,o){let h=t.getSource();if(!(h instanceof ga&&h.loaded()))return;let m=u.sourceLayer||h.rasterLayerIds&&h.rasterLayerIds[0];if(!m)return;let _=u.paint.get("raster-array-band")||h.getInitialBand(m);if(_==null)return;let v=t.getIds().map(E=>t.getTileByID(E));for(let E of v)E.updateNeeded(m,_)&&h.prepareTile(E,m,_)},"raster-particle":function(u,t,o){let h=t.getSource();if(!(h instanceof ga&&h.loaded()))return;let m=u.sourceLayer||h.rasterLayerIds&&h.rasterLayerIds[0];if(!m)return;let _=u.paint.get("raster-particle-array-band")||h.getInitialBand(m);if(_==null)return;let v=t.getIds().map(E=>t.getTileByID(E));for(let E of v)E.updateNeeded(m,_)&&h.prepareTile(E,m,_)}},Gs={fill:pm},th={fill:function(u,t,o,h){if(!o.layout||o.layout.get("fill-elevation-reference")==="none")return;let m=u.context.gl,_=new ft(m.LEQUAL,ft.ReadOnly,u.depthRangeFor3D),v=new Bt({func:m.ALWAYS,mask:255},255,255,m.KEEP,m.KEEP,m.REPLACE),E=u.transform.getFreeCameraOptions().position,T=u.getOrCreateProgram("elevatedStructuresDepthReconstruct",{defines:["DEPTH_RECONSTRUCTION"]});for(let C of h){let M=t.getTile(C),O=M.getBucket(o);if(!O)continue;let P=O.elevatedStructures;if(!P||P.maskSegments.segments[0].primitiveLength===0)continue;let k=Vd(C.toUnwrapped(),E),j=u.translatePosMatrix(C.projMatrix,M,o.paint.get("fill-translate"),o.paint.get("fill-translate-anchor")),B=Fd(j,k,0,0,0);T.draw(u,m.TRIANGLES,_,v,en.disabled,Pt.disabled,B,o.id,P.vertexBuffer,P.indexBuffer,P.maskSegments,o.paint,u.transform.zoom)}}};class Dc{constructor(t,o,h,m,_,v){this.context=new Jb(t,o),this.transform=h,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=_,this._timeStamp=i.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};let E=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(let C of E)this._debugParams.enabledLayers[C]=!0;_.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),_.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),_.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),_.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),_.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),_.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(let C of E)_.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],C);this.occlusionParams=new Ty(_),this.setup(),this.numSublayers=Xr.maxUnderzooming+Xr.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new i.et,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new Rb(this),this._wireframeDebugCache=new s1,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];let T=new i.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new i.T(this.context,T,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=m,this.worldview=v}updateTerrain(t,o){let h=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(h||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Hu(this,t));let m=this._terrain;this.transform.elevation=h?m:null,m.update(t,this.transform,o),this.transform.elevation&&!m.enabled&&(this.transform.elevation=null)}_updateFog(t){let o=t.fog;if(!o||this.transform.projection.name==="globe"||o.getOpacity(this.transform.pitch)<1||o.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);let[h,m]=o.getFovAdjustedRange(this.transform._fov);if(h>m)return void(this.transform.fogCullDistSq=null);let _=h+.78*(m-h);this.transform.fogCullDistSq=_*_}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(t){t&&!this._terrain&&(this._terrain=new Hu(this,this.style)),this._forceTerrainMode=t}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,o){if(this.width=t*i.q.devicePixelRatio,this.height=o*i.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(let h of this.style.order)this.style._mergedLayers[h].resize()}setup(){let t=this.context,o=new i.ba;o.emplaceBack(0,0),o.emplaceBack(i.aj,0),o.emplaceBack(0,i.aj),o.emplaceBack(i.aj,i.aj),this.tileExtentBuffer=t.createVertexBuffer(o,i.bc.members),this.tileExtentSegments=i.bd.simpleSegment(0,0,4,2);let h=new i.ba;h.emplaceBack(0,0),h.emplaceBack(i.aj,0),h.emplaceBack(0,i.aj),h.emplaceBack(i.aj,i.aj),this.debugBuffer=t.createVertexBuffer(h,i.bc.members),this.debugSegments=i.bd.simpleSegment(0,0,4,5);let m=new i.ba;m.emplaceBack(-1,-1),m.emplaceBack(1,-1),m.emplaceBack(-1,1),m.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(m,i.bc.members),this.viewportSegments=i.bd.simpleSegment(0,0,4,2);let _=new i.aZ;_.emplaceBack(0,0,0,0),_.emplaceBack(i.aj,0,i.aj,0),_.emplaceBack(0,i.aj,0,i.aj),_.emplaceBack(i.aj,i.aj,i.aj,i.aj),this.mercatorBoundsBuffer=t.createVertexBuffer(_,i.bf.members),this.mercatorBoundsSegments=i.bd.simpleSegment(0,0,4,2);let v=new i.a_;v.emplaceBack(0,1,2),v.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(v);let E=new i.bb;for(let C of[0,1,3,2,0])E.emplaceBack(C);this.debugIndexBuffer=t.createIndexBuffer(E),this.emptyTexture=new i.T(t,new i.r({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=i.bz();let T=this.context.gl;this.stencilClearMode=new Bt({func:T.ALWAYS,mask:0},0,255,T.ZERO,T.ZERO,T.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){let t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,ft.disabled,this.stencilClearMode,en.disabled,Pt.disabled,_l(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,o,h){if(!o||this.currentStencilSource===o.id||!t.isTileClipped()||!h||h.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let E=!1;for(let T of h)if(this._tileClippingMaskIDs[T.key]===void 0){E=!0;break}if(!E)return}this.currentStencilSource=o.id;let m=this.context,_=m.gl;this.nextStencilID+h.length>256&&this.clearStencil(),m.setColorMode(en.disabled),m.setDepthMode(ft.disabled);let v=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(let E of h){let T=o.getTile(E),C=this._tileClippingMaskIDs[E.key]=this.nextStencilID++,{tileBoundsBuffer:M,tileBoundsIndexBuffer:O,tileBoundsSegments:P}=this.getTileBoundsBuffers(T);v.draw(this,_.TRIANGLES,ft.disabled,new Bt({func:_.ALWAYS,mask:0},C,255,_.KEEP,_.KEEP,_.REPLACE),en.disabled,Pt.disabled,_l(E.projMatrix),"$clipping",M,O,P)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();let t=this.nextStencilID++,o=this.context.gl;return new Bt({func:o.NOTEQUAL,mask:255},t,255,o.KEEP,o.KEEP,o.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);let o=this.context.gl;return new Bt({func:o.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,o.KEEP,o.KEEP,o.REPLACE)}stencilConfigForOverlap(t){let o=this.context.gl,h=t.sort((v,E)=>E.overscaledZ-v.overscaledZ),m=h[h.length-1].overscaledZ,_=h[0].overscaledZ-m+1;if(_>1){this.currentStencilSource=void 0,this.nextStencilID+_>256&&this.clearStencil();let v={};for(let E=0;E<_;E++)v[E+m]=new Bt({func:o.GEQUAL,mask:255},E+this.nextStencilID,255,o.KEEP,o.KEEP,o.REPLACE);return this.nextStencilID+=_,[v,h]}return[{[m]:Bt.disabled},h]}colorModeForRenderPass(){let t=this.context.gl;return this._showOverdrawInspector?new en([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new i.am(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?en.unblended:en.alphaBlended}colorModeForDrapableLayerRenderPass(t){let o=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new en([o.ONE,o.ONE_MINUS_SRC_ALPHA,o.CONSTANT_ALPHA,o.ONE_MINUS_SRC_ALPHA],new i.am(0,0,0,t===void 0?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,o,h,m=!1){if(this.depthOcclusion)return new ft(this.context.gl.GREATER,ft.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!m)return ft.disabled;let _=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new ft(h||this.context.gl.LEQUAL,o,[_,_])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){let t=this.context.gl,o=Math.ceil(this.width),h=Math.ceil(this.height),m=this.context.bindFramebuffer.get(),_=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===o&&this.depthFBO.height===h||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),o!==0&&h!==0&&(this.depthFBO=new fm(this.context,o,h,!1,"texture"),this.depthTexture=new i.T(this.context,{width:o,height:h,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(m),t.bindTexture(t.TEXTURE_2D,_),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,o,h,0,0,o,h,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((t,o)=>t+o/this._fpsHistory.length,0))}render(t,o){let h=i.q.now();this._dt=h-this._timeStamp,this._timeStamp=h,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=o;let m=this.style._mergedLayers,_=!(!this.terrain||!this.terrain.enabled),v=()=>this.style._getOrder(_).filter(we=>{let Oe=m[we];return!(Oe.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[Oe.type]}),E=v(),T=!1,C=!1;for(let we of E){let Oe=m[we];Oe.type==="circle"&&(T=!0),Oe.type==="symbol"&&(Oe.hasInitialOcclusionOpacityProperties?C=!0:T=!0)}let M=E.map(we=>m[we]),O=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(i.q.now()),this.imageManager.beginFrame();let P=0,k=!1;for(let we in O){let Oe=O[we];Oe.used&&(Oe.prepare(this.context),Oe.getSource().usedInConflation&&++P)}let j=!1;for(let we of M)we.isHidden(this.transform.zoom)||(we.type==="clip"&&(j=!0),this.prepareLayer(we));let B={},U={},q={},Z={},ee={};for(let we in O){let Oe=O[we];B[we]=Oe.getVisibleCoordinates(),U[we]=B[we].slice().reverse(),q[we]=Oe.getVisibleCoordinates(!0).reverse(),Z[we]=Oe.getShadowCasterCoordinates(),ee[we]=Oe.sortCoordinatesByDistance(B[we])}let re=we=>{let Oe=this.style.getLayerSourceCache(we);return Oe&&Oe.used?Oe.getSource():null};if(P||j||this._clippingActiveLastFrame){let we=[],Oe=[],_e=0;for(let Ue of M)this.isSourceForClippingOrConflation(Ue,re(Ue))&&(we.push(Ue),Oe.push(_e)),_e++;if(we&&(j||we.length>1)||this._clippingActiveLastFrame){j=!1;let Ue=[];for(let Me=0;Me<we.length;Me++){let Ge=we[Me],nt=Oe[Me],je=this.style.getLayerSourceCache(Ge);if(!je||!je.used||!je.getSource().usedInConflation&&Ge.type!=="clip")continue;let et=i.eu,mt=i.bQ.None,gt=[],dt=!0;if(Ge.type==="clip"){et=nt;for(let Et of Ge.layout.get("clip-layer-types"))mt|=Et==="model"?i.bQ.Model:Et==="symbol"?i.bQ.Symbol:i.bQ.FillExtrusion;for(let Et of Ge.layout.get("clip-layer-scope"))gt.push(Et);Ge.isHidden(this.transform.zoom)?dt=!1:j=!0}dt&&Ue.push({layer:Ge.fqid,cache:je,order:et,clipMask:mt,clipScope:gt})}this.replacementSource.setSources(Ue),k=!0}}this._clippingActiveLastFrame=j,k||this.replacementSource.clear(),this.conflationActive=k,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let we=0;we<M.length;we++){let Oe=M[we],_e=Oe.cutoffRange();if(this.longestCutoffRange=Math.max(_e,this.longestCutoffRange),_e>0){let Ue=re(Oe);Ue&&(this.minCutoffZoom=Math.max(Ue.minzoom,this.minCutoffZoom)),Oe.minzoom&&(this.minCutoffZoom=Math.max(Oe.minzoom,this.minCutoffZoom))}Oe.is3D(_)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=we),this._lastOcclusionLayer=we)}let ue=this.style&&this.style.fog;ue?(this._fogVisible=ue.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=ue.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(q),this.opaquePassCutoff=0,E=v(),M=E.map(we=>m[we]));let le=this._shadowRenderer;if(le){le.updateShadowParameters(this.transform,this.style.directionalLight);for(let we in O)for(let Oe of B[we]){let _e={min:0,max:0};this.terrain&&(_e=this.terrain.getMinMaxForTile(Oe)||_e),le.addShadowReceiver(Oe.toUnwrapped(),_e.min,_e.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new i.ev(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Ic(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);let se=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),oe=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(se&&!this._snow&&(this._snow=new ui(this)),!se&&this._snow&&(this._snow.destroy(),delete this._snow),oe&&!this._rain&&(this._rain=new a1(this)),!oe&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),!Rs.has(this.context.gl))return;this.renderPass="offscreen";for(let we of M){let Oe=t.getLayerSourceCache(we);if(!we.hasOffscreenPass()||we.isHidden(this.transform.zoom))continue;let _e=Oe?U[Oe.id]:void 0;(we.type==="custom"||we.type==="raster"||we.type==="raster-particle"||we.isSky()||_e&&_e.length)&&this.renderLayer(this,Oe,we,_e)}this.depthRangeFor3D=[0,1-(M.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,Z)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);let he=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),fe=(()=>{if(o.showOverdrawInspector)return i.am.black;let we=this.style.fog;if(we&&this.transform.projection.supportsFog){let Oe=this.style.getLut(we.scope);if(!he){let _e=we.properties.get("color-use-theme")==="none",Ue=we.properties.get("color").toNonPremultipliedRenderColor(_e?null:Oe).toArray01();return new i.am(...Ue)}if(he){let _e=we.properties.get("space-color-use-theme")==="none",Ue=we.properties.get("space-color").toNonPremultipliedRenderColor(_e?null:Oe).toArray01();return new i.am(...Ue)}}return i.am.transparent})();if(this.context.clear({color:fe,depth:1}),this.clearStencil(),this._showOverdrawInspector=o.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&he&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=E.length-1;this.currentLayer>=0;this.currentLayer--){let we=M[this.currentLayer],Oe=t.getLayerSourceCache(we);if(we.isSky())continue;let _e=Oe?(we.is3D(_)?ee:U)[Oe.id]:void 0;this._renderTileClippingMasks(we,Oe,_e),this.renderLayer(this,Oe,we,_e)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&he&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||i.ah(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<E.length;this.currentLayer++){let we=M[this.currentLayer],Oe=t.getLayerSourceCache(we);we.isSky()&&this.renderLayer(this,Oe,we,Oe?U[Oe.id]:void 0)}function Te(we,Oe){let _e;return Oe&&(_e=(we.type==="symbol"?q:we.is3D(_)?ee:U)[Oe.id]),_e}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<E.length;){let we=M[this.currentLayer];if(we.type==="raster"||we.type==="raster-particle"){let Oe=t.getLayerSourceCache(we);this.renderLayer(this,Oe,we,Te(we,Oe))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Ie=0;le&&(Ie=le.getShadowCastingLayerCount());let Be=!1,Ve=-1;for(let we=0;we<E.length;++we){let Oe=M[we];Oe.isHidden(this.transform.zoom)||Oe.is3D(_)&&(Ve=we)}C&&Ve===-1&&(T=!0);let We=!1;for(;this.currentLayer<E.length;){let we=M[this.currentLayer],Oe=t.getLayerSourceCache(we);if(we.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(we)){if(we.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!We&&we.is3D(_)&&!_){let _e=this.currentLayer,Ue=Me=>{for(this.currentLayer=0;this.currentLayer<M.length;this.currentLayer++){let Ge=M[this.currentLayer];if(Gs[Ge.type]){let nt=this.style.getLayerSourceCache(Ge);Gs[Ge.type](this,nt,Ge,Te(Ge,nt),Me)}}};Ue("initialize"),Ue("reset"),this.currentLayer=_e,We=!0}if(T&&!Be&&this.terrain&&!this.transform.isOrthographic&&(Be=!0,this.blitDepth()),C&&Ve!==-1&&this.currentLayer===Ve+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(we,Oe,Oe?B[Oe.id]:void 0),this.renderLayer(this,Oe,we,Te(we,Oe)),!this.terrain&&le&&Ie>0&&we.hasShadowPass()&&--Ie==0){{this.clearStencil();let _e=this.currentLayer;for(this.currentLayer=0;this.currentLayer<M.length;this.currentLayer++){let Ue=M[this.currentLayer];if(th[Ue.type]){let Me=this.style.getLayerSourceCache(Ue);th[Ue.type](this,Me,Ue,Te(Ue,Me))}}this.currentLayer=_e}if(le.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){let _e=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=_e;this.currentLayer++){let Ue=M[this.currentLayer];if(!Ue.hasLightBeamPass())continue;let Me=t.getLayerSourceCache(Ue);this.renderLayer(this,Me,Ue,Me?U[Me.id]:void 0)}this.currentLayer=_e,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){let _e=this.currentLayer;this.depthOcclusion=!0;for(let Ue of this.layersWithOcclusionOpacity){this.currentLayer=Ue;let Me=M[this.currentLayer],Ge=t.getLayerSourceCache(Me),nt=Ge?U[Ge.id]:void 0;this.terrain||this._renderTileClippingMasks(Me,Ge,Ge?B[Ge.id]:void 0),this.renderLayer(this,Ge,Me,nt)}this.depthOcclusion=!1,this.currentLayer=_e,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let we=null;M.forEach(Oe=>{let _e=t.getLayerSourceCache(Oe);_e&&!Oe.isHidden(this.transform.zoom)&&_e.getVisibleCoordinates().length&&(!we||we.getSource().maxzoom<_e.getSource().maxzoom)&&(we=_e)}),we&&this.options.showTileBoundaries&&Hs(this,we,we.getVisibleCoordinates(),i.am.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&Hs(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new i.am(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(we){let Oe=we.transform.padding;jd(we,we.transform.height-(Oe.top||0),3,n1),jd(we,Oe.bottom||0,3,i1),Ud(we,Oe.left||0,3,lo),Ud(we,we.transform.width-(Oe.right||0),3,_m);let _e=we.transform.centerPoint;(function(Ue,Me,Ge,nt){Tc(Ue,Me-1,Ge-10,2,20,nt),Tc(Ue,Me-10,Ge-1,20,2,nt)})(we,_e.x,we.transform.height-_e.y,Br)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),k||(this.conflationActive=!1)}prepareLayer(t){this.gpuTimingStart(t);let{unsupportedLayers:o}=this.transform.projection,h=!o||!o.includes(t.type);if(wm[t.type]&&(h||this.terrain&&t.type==="custom")){let m=this.style.getLayerSourceCache(t);wm[t.type](t,m,this)}this.gpuTimingEnd()}renderLayer(t,o,h,m){h.isHidden(this.transform.zoom)||(h.type==="background"||h.type==="sky"||h.type==="custom"||h.type==="model"||h.type==="raster"||h.type==="raster-particle"||m&&m.length)&&(this.id=h.id,this.gpuTimingStart(h),t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes(h.type)&&(!t.terrain||h.type!=="custom")||h.type==="clip"||mn[h.type](t,o,h,m,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;let o=this.context.extTimerQuery,h=this.context.gl,m=this.gpuTimers[t.id];m||(m=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:h.createQuery()}),m.calls++,h.beginQuery(o.TIME_ELAPSED_EXT,m.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){let t=this.context.extTimerQuery,o=this.context.gl,h=o.createQuery();this.deferredRenderGpuTimeQueries.push(h),o.beginQuery(t.TIME_ELAPSED_EXT,h)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){let t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){let t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){let o={};for(let h in t){let m=t[h],_=this.context.extTimerQuery,v=_.getQueryParameter(m.query,this.context.gl.QUERY_RESULT)/1e6;_.deleteQueryEXT(m.query),o[h]=v}return o}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;let o=this.context.gl,h=0;for(let m of t)h+=o.getQueryParameter(m,o.QUERY_RESULT)/1e6,o.deleteQuery(m);return h}translatePosMatrix(t,o,h,m,_){if(!h[0]&&!h[1])return t;let v=_?m==="map"?this.transform.angle:0:m==="viewport"?-this.transform.angle:0;if(v){let C=Math.sin(v),M=Math.cos(v);h=[h[0]*M-h[1]*C,h[0]*C+h[1]*M]}let E=[_?h[0]:i.aw(o,h[0],this.transform.zoom),_?h[1]:i.aw(o,h[1],this.transform.zoom),0],T=new Float32Array(16);return i.bo(T,t,E),T}saveTileTexture(t){let o=t.size[0],h=this._tileTextures[o];h?h.push(t):this._tileTextures[o]=[t]}getTileTexture(t){let o=this._tileTextures[t];return o&&o.length>0?o.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(t,o,h){let m=h===void 0?this.terrain&&this.terrain.renderingToTexture:h,_=[];return this.style&&this.style.enable3dLights()&&(t==="globeRaster"||t==="terrainRaster"?(_.push("LIGHTING_3D_MODE"),_.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):m||_.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||_.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(_.push("TERRAIN"),this.linearFloatFilteringSupported()&&_.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&_.push("GLOBE"),!this._fogVisible||m||o!==void 0&&!o||_.push("FOG","FOG_DITHERING"),m&&_.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&_.push("OVERDRAW_INSPECTOR"),_}getOrCreateProgram(t,o){this.cache=this.cache||{};let h=o&&o.defines||[],m=o&&o.config,_=this.currentGlobalDefines(t,o&&o.overrideFog,o&&o.overrideRtt).concat(h),v=kd.cacheKey(wd[t],t,_,m);return this.cache[v]||(this.cache[v]=new kd(this.context,t,wd[t],m,dy[t],_)),this.cache[v]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){let t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new i.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,o){if(this.style.enable3dLights()){let h=this.style.directionalLight,m=this.style.ambientLight;if(h&&m){let _=((v,E,T)=>{let C=v.properties.get("direction"),M=v.properties.get("color-use-theme")==="none",O=v.properties.get("color").toNonPremultipliedRenderColor(M?null:T.getLut(v.scope)).toArray01(),P=v.properties.get("intensity"),k=E.properties.get("color-use-theme")==="none",j=E.properties.get("color").toNonPremultipliedRenderColor(k?null:T.getLut(E.scope)).toArray01(),B=E.properties.get("intensity"),U=[C.x,C.y,C.z],q=i.dw(j,B),Z=i.dw(O,P);return{u_lighting_ambient_color:q,u_lighting_directional_dir:U,u_lighting_directional_color:Z,u_ground_radiance:Od(U,Z,q)}})(h,m,this.style);o.setLightsUniformValues(t,_)}}}uploadCommonUniforms(t,o,h,m,_){if(this.uploadCommonLightUniforms(t,o),this.terrain&&this.terrain.renderingToTexture)return;let v=this.style.fog;if(v){let E=v.getOpacity(this.transform.pitch),T=((C,M,O,P,k,j,B,U,q,Z,ee,re)=>{let ue=C.transform,le=M.properties.get("color-use-theme")==="none",se=M.properties.get("color").toNonPremultipliedRenderColor(le?null:C.style.getLut(M.scope)).toArray01();se[3]=P;let oe=C.frameCounter/1e3%1,[he,fe]=M.properties.get("vertical-range");return{u_fog_matrix:O?ue.calculateFogTileMatrix(O):re||C.identityMat,u_fog_range:M.getFovAdjustedRange(ue._fov),u_fog_color:se,u_fog_horizon_blend:M.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(he,fe),fe],u_fog_temporal_offset:oe,u_frustum_tl:k,u_frustum_tr:j,u_frustum_br:B,u_frustum_bl:U,u_globe_pos:q,u_globe_radius:Z,u_viewport:ee,u_globe_transition:i.ah(ue.zoom),u_is_globe:+(ue.projection.name==="globe")}})(this,v,h,E,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*i.q.devicePixelRatio,this.transform.height*i.q.devicePixelRatio],m);o.setFogUniformValues(t,T)}_&&o.setCutoffUniformValues(t,_.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){let t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){let t=this.context.gl,o=t.createTexture();return t.bindTexture(t.TEXTURE_2D,o),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),o}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;let t=this.style&&this.style.fog;return!!t&&t.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){let t=this._backgroundTiles,o=this._backgroundTiles={},h=this.transform.coveringTiles({tileSize:512});for(let m of h)o[m.key]=t[m.key]||new ol(m,512,this.transform.tileZoom,this,void 0,this.worldview);return o}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(t,o){return!(!t.is3D(!(!this.terrain||!this.terrain.enabled))||t.type!=="clip"&&(t.minzoom&&t.minzoom>this.transform.zoom||(this.style._clipLayerPresent||t.sourceLayer!=="building")&&(!o||o.type!=="batched-model")))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let o=this._cachedTileFogOpacities[t.key];return o||(this._cachedTileFogOpacities[t.key]=o=this.style.fog.getOpacityForTile(t)),o[0]>=Re||o[1]>=Re}setupDepthForOcclusion(t,o,h){let m=this.context,_=m.gl,v=!!h;var E;h||(h={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),m.activeTexture.set(_.TEXTURE3),t&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(_.NEAREST,_.CLAMP_TO_EDGE),h.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],h.u_depth_range_unpack=[2/((E=this.depthRangeFor3D)[1]-E[0]),-1-2*E[0]/(E[1]-E[0])],h.u_occluder_half_size=.5*this.occlusionParams.occluderSize,h.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(_.NEAREST,_.CLAMP_TO_EDGE),m.activeTexture.set(_.TEXTURE0),v||o.setTerrainUniformValues(m,h)}}function Ma(u,t){let o=!1,h=null,m=()=>{h=null,o&&(u(),h=setTimeout(m,t),o=!1)};return()=>(o=!0,h||m(),h)}class Em{constructor(t){this._hashName=t&&encodeURIComponent(t),i.aV(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Ma(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,window.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){let t=this._map;if(!t)return"";let o=Wd(t);if(this._hashName){let h=this._hashName,m=!1,_=location.hash.slice(1).split("&").map(v=>{let E=v.split("=")[0];return E===h?(m=!0,`${E}=${o}`):v}).filter(v=>v);return m||_.push(`${h}=${o}`),`#${_.join("&")}`}return`#${o}`}_getCurrentHash(){let t=location.hash.replace("#","");if(this._hashName){let o;return t.split("&").map(h=>h.split("=")).forEach(h=>{h[0]===this._hashName&&(o=h)}),(o&&o[1]||"").split("/")}return t.split("/")}_onHashChange(){let t=this._map;if(!t)return!1;let o=this._getCurrentHash();if(o.length>=3&&!o.some(h=>isNaN(Number(h)))){let h=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(o[3]||0):t.getBearing();return t.jumpTo({center:[+o[2],+o[1]],zoom:+o[0],bearing:h,pitch:+(o[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Wd(u,t){let o=u.getCenter(),h=Math.round(100*u.getZoom())/100,m=Math.ceil((h*Math.LN2+Math.log(512/360/.5))/Math.LN10),_=Math.pow(10,m),v=Math.round(o.lng*_)/_,E=Math.round(o.lat*_)/_,T=u.getBearing(),C=u.getPitch(),M=t?`/${v}/${E}/${h}`:`${h}/${E}/${v}`;return(T||C)&&(M+="/"+Math.round(10*T)/10),C&&(M+=`/${Math.round(C)}`),M}let Cc={linearity:.3,easing:i.ew(0,0,.3,1)},Tm=i.h({deceleration:2500,maxSpeed:1400},Cc),gs=i.h({deceleration:20,maxSpeed:1400},Cc),Aa=i.h({deceleration:1e3,maxSpeed:360},Cc),nh=i.h({deceleration:1e3,maxSpeed:90},Cc);class Zd{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:i.q.now(),settings:t})}_drainInertiaBuffer(){let t=this._inertiaBuffer,o=i.q.now();for(;t.length>0&&o-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;let o={zoom:0,bearing:0,pitch:0,pan:new i.P(0,0),pinchAround:void 0,around:void 0};for(let{settings:_}of this._inertiaBuffer)o.zoom+=_.zoomDelta||0,o.bearing+=_.bearingDelta||0,o.pitch+=_.pitchDelta||0,_.panDelta&&o.pan._add(_.panDelta),_.around&&(o.around=_.around),_.pinchAround&&(o.pinchAround=_.pinchAround);let h=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,m={};if(o.pan.mag()){let _=Ac(o.pan.mag(),h,i.h({},Tm,t||{}));m.offset=o.pan.mult(_.amount/o.pan.mag()),m.center=this._map.transform.center,Mc(m,_)}if(o.zoom){let _=Ac(o.zoom,h,gs);m.zoom=this._map.transform.zoom+_.amount,Mc(m,_)}if(o.bearing){let _=Ac(o.bearing,h,Aa);m.bearing=this._map.transform.bearing+i.ay(_.amount,-179,179),Mc(m,_)}if(o.pitch){let _=Ac(o.pitch,h,nh);m.pitch=this._map.transform.pitch+_.amount,Mc(m,_)}if(m.zoom||m.bearing){let _=o.pinchAround===void 0?o.around:o.pinchAround;m.around=_?this._map.unproject(_):this._map.getCenter()}return this.clear(),m.noMoveStart=!0,m}}function Mc(u,t){(!u.duration||u.duration<t.duration)&&(u.duration=t.duration,u.easing=t.easing)}function Ac(u,t,o){let{maxSpeed:h,linearity:m,deceleration:_}=o,v=i.ay(u*m/(t/1e3),-h,h),E=Math.abs(v)/(_*m);return{easing:o.easing,duration:1e3*E,amount:v*(E/2)}}class lr extends i.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,o,h,m={}){let _=la(o.getCanvasContainer(),h),v=o.unproject(_);super(t,i.h({point:_,lngLat:v,originalEvent:h},m)),this._defaultPrevented=!1,this.target=o}}class Rc extends i.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,o,h){let m=t==="touchend"?h.changedTouches:h.touches,_=ds(o.getCanvasContainer(),m),v=_.map(T=>o.unproject(T)),E=_.reduce((T,C,M,O)=>T.add(C.div(O.length)),new i.P(0,0));super(t,{points:_,point:E,lngLats:v,lngLat:o.unproject(E),originalEvent:h}),this._defaultPrevented=!1}}class Ra extends i.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,o){super("wheel",{originalEvent:o}),this._defaultPrevented=!1}}class Im{constructor(t,o){this._map=t,this._clickTolerance=o.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new Ra(this._map,t))}mousedown(t,o){return this._mousedownPos=o,this._firePreventable(new lr(t.type,this._map,t))}mouseup(t){this._map.fire(new lr(t.type,this._map,t))}preclick(t){let o=i.h({},t);o.type="preclick",this._map.fire(new lr(o.type,this._map,o))}click(t,o){this._mousedownPos&&this._mousedownPos.dist(o)>=this._clickTolerance||(this.preclick(t),this._map.fire(new lr(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new lr(t.type,this._map,t))}mouseover(t){this._map.fire(new lr(t.type,this._map,t))}mouseout(t){this._map.fire(new lr(t.type,this._map,t))}touchstart(t){return this._firePreventable(new Rc(t.type,this._map,t))}touchmove(t){this._map.fire(new Rc(t.type,this._map,t))}touchend(t){this._map.fire(new Rc(t.type,this._map,t))}touchcancel(t){this._map.fire(new Rc(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Xd{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new lr(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new lr("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new lr(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Sm{constructor(t,o){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=o.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,o){this.isEnabled()&&t.shiftKey&&t.button===0&&(Yi(),this._startPos=this._lastPos=o,this._active=!0)}mousemoveWindow(t,o){if(!this._active)return;let h=o,m=this._startPos,_=this._lastPos;if(!m||!_||_.equals(h)||!this._box&&h.dist(m)<this._clickTolerance)return;this._lastPos=h,this._box||(this._box=Se("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));let v=Math.min(m.x,h.x),E=Math.max(m.x,h.x),T=Math.min(m.y,h.y),C=Math.max(m.y,h.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${v}px,${T}px)`,this._box.style.width=E-v+"px",this._box.style.height=C-T+"px")})}mouseupWindow(t,o){if(!this._active)return;let h=this._startPos,m=o;if(h&&t.button===0){if(this.reset(),Cs(),h.x!==m.x||h.y!==m.y)return this._map.fire(new i.A("boxzoomend",{originalEvent:t})),{cameraAnimation:_=>_.fitScreenCoordinates(h,m,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),fr(),delete this._startPos,delete this._lastPos}_fireEvent(t,o){return this._map.fire(new i.A(t,{originalEvent:o}))}}function ih(u,t){let o={};for(let h=0;h<u.length;h++)o[u[h].identifier]=t[h];return o}class cr{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,o,h){(this.centroid||h.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=t.timeStamp),h.length===this.numTouches&&(this.centroid=function(m){let _=new i.P(0,0);for(let v of m)_._add(v);return _.div(m.length)}(o),this.touches=ih(h,o)))}touchmove(t,o,h){if(this.aborted||!this.centroid)return;let m=ih(h,o);for(let _ in this.touches){let v=m[_];(!v||v.dist(this.touches[_])>30)&&(this.aborted=!0)}}touchend(t,o,h){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),h.length===0){let m=!this.aborted&&this.centroid;if(this.reset(),m)return m}}}class rh{constructor(t){this.singleTap=new cr(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,o,h){this.singleTap.touchstart(t,o,h)}touchmove(t,o,h){this.singleTap.touchmove(t,o,h)}touchend(t,o,h){let m=this.singleTap.touchend(t,o,h);if(m){let _=t.timeStamp-this.lastTime<500,v=!this.lastTap||this.lastTap.dist(m)<30;if(_&&v||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=m,this.count===this.numTaps)return this.reset(),m}}}class Dm{constructor(){this._zoomIn=new rh({numTouches:1,numTaps:2}),this._zoomOut=new rh({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,o,h){this._zoomIn.touchstart(t,o,h),this._zoomOut.touchstart(t,o,h)}touchmove(t,o,h){this._zoomIn.touchmove(t,o,h),this._zoomOut.touchmove(t,o,h)}touchend(t,o,h){let m=this._zoomIn.touchend(t,o,h),_=this._zoomOut.touchend(t,o,h);return m?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:v=>v.easeTo({duration:300,zoom:v.getZoom()+1,around:v.unproject(m)},{originalEvent:t})}):_?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:v=>v.easeTo({duration:300,zoom:v.getZoom()-1,around:v.unproject(_)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}let Cm={0:1,2:2},Pa={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class oh{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,o){return!1}_move(t,o){return{}}mousedown(t,o){if(this._lastPoint)return;let h=id(t);this._correctButton(t,h)&&(this._lastPoint=o,this._eventButton=h)}mousemoveWindow(t,o){let h=this._lastPoint;if(h){if(t.preventDefault(),this._eventButton!=null&&function(m,_){let v=Cm[_];return m.buttons===void 0||(m.buttons&v)!==v}(t,this._eventButton))this.reset();else if(this._moved||!(o.dist(h)<this._clickTolerance))return this._moved=!0,this._lastPoint=o,this._move(h,o)}}mouseupWindow(t){this._lastPoint&&id(t)===this._eventButton&&(this._moved&&Cs(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Mm extends oh{mousedown(t,o){super.mousedown(t,o),this._lastPoint&&(this._active=!0)}_correctButton(t,o){return o===0&&!t.ctrlKey}_move(t,o){return{around:o,panDelta:o.sub(t)}}}class Yd extends oh{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?Pa[t.pitchRotateKey]:void 0}_correctButton(t,o){return this._pitchRotateKey?o===0&&t[this._pitchRotateKey]:o===0&&t.ctrlKey||o===2}_move(t,o){let h=.8*(o.x-t.x);if(h)return this._active=!0,{bearingDelta:h}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class Sl extends oh{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?Pa[t.pitchRotateKey]:void 0}_correctButton(t,o){return this._pitchRotateKey?o===0&&t[this._pitchRotateKey]:o===0&&t.ctrlKey||o===2}_move(t,o){let h=-.5*(o.y-t.y);if(h)return this._active=!0,{pitchDelta:h}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class Am{constructor(t,o){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=o.clickTolerance||1,this.reset(),i.aV(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new i.P(0,0)}touchstart(t,o,h){return this._calculateTransform(t,o,h)}touchmove(t,o,h){if(this._active&&!(h.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(h.length===1&&!i.ex())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,o,h)}}touchend(t,o,h){this._calculateTransform(t,o,h),this._active&&h.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,o,h){h.length>0&&(this._active=!0);let m=ih(h,o),_=new i.P(0,0),v=new i.P(0,0),E=0;for(let C in m){let M=m[C],O=this._touches[C];O&&(_._add(M),v._add(M.sub(O)),E++,m[C]=M)}if(this._touches=m,E<this._minTouches||!v.mag())return;let T=v.div(E);return this._sum._add(T),this._sum.mag()<this._clickTolerance?void 0:{around:_.div(E),panDelta:T}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=Se("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class sh{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,o,h){return{}}touchstart(t,o,h){this._firstTwoTouches||h.length<2||(this._firstTwoTouches=[h[0].identifier,h[1].identifier],this._start([o[0],o[1]]))}touchmove(t,o,h){let m=this._firstTwoTouches;if(!m)return;t.preventDefault();let[_,v]=m,E=Pc(h,o,_),T=Pc(h,o,v);if(!E||!T)return;let C=this._aroundCenter?null:E.add(T).div(2);return this._move([E,T],C,t)}touchend(t,o,h){if(!this._firstTwoTouches)return;let[m,_]=this._firstTwoTouches,v=Pc(h,o,m),E=Pc(h,o,_);v&&E||(this._active&&Cs(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Pc(u,t,o){for(let h=0;h<u.length;h++)if(u[h].identifier===o)return t[h]}function ah(u,t){return Math.log(u/t)/Math.LN2}class Rm extends sh{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,o){let h=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(ah(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:ah(this._distance,h),pinchAround:o}}}function Kd(u,t){return 180*u.angleWith(t)/Math.PI}class Sy extends sh{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,o){let h=this._vector;if(this._vector=t[0].sub(t[1]),h&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Kd(this._vector,h),pinchAround:o}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());let o=25/(Math.PI*this._minDiameter)*360,h=this._startVector;if(!h)return!1;let m=Kd(t,h);return Math.abs(m)<o}}function Jd(u){return Math.abs(u.y)>Math.abs(u.x)}class Dy extends sh{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,Jd(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,o,h){let m=this._lastPoints;if(!m)return;let _=t[0].sub(m[0]),v=t[1].sub(m[1]);return this._map._cooperativeGestures&&!i.ex()&&h.touches.length<3||(this._valid=this.gestureBeginsVertically(_,v,h.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(_.y+v.y)/2*-.5})}gestureBeginsVertically(t,o,h){if(this._valid!==void 0)return this._valid;let m=t.mag()>=2,_=o.mag()>=2;if(!m&&!_)return;if(!m||!_)return this._firstMove==null&&(this._firstMove=h),h-this._firstMove<100&&void 0;let v=t.y>0==o.y>0;return Jd(t)&&Jd(o)&&v}}let Cy={panStep:100,bearingStep:15,pitchStep:10};class My{constructor(){let t=Cy;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let o=0,h=0,m=0,_=0,v=0;switch(t.keyCode){case 61:case 107:case 171:case 187:o=1;break;case 189:case 109:case 173:o=-1;break;case 37:t.shiftKey?h=-1:(t.preventDefault(),_=-1);break;case 39:t.shiftKey?h=1:(t.preventDefault(),_=1);break;case 38:t.shiftKey?m=1:(t.preventDefault(),v=-1);break;case 40:t.shiftKey?m=-1:(t.preventDefault(),v=1);break;default:return}return this._rotationDisabled&&(h=0,m=0),{cameraAnimation:E=>{let T=E.getZoom();E.easeTo({duration:300,easeId:"keyboardHandler",easing:Ay,zoom:o?Math.round(T)+o*(t.shiftKey?2:1):T,bearing:E.getBearing()+h*this._bearingStep,pitch:E.getPitch()+m*this._pitchStep,offset:[-_*this._panStep,-v*this._panStep],center:E.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Ay(u){return u*(2-u)}let Pm=4.000244140625,Ry=1/450;class Py{constructor(t,o){this._map=t,this._el=t.getCanvasContainer(),this._handler=o,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Ry,i.aV(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||i.ex()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let o=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY,h=i.q.now(),m=h-(this._lastWheelEventTime||0);this._lastWheelEventTime=h,o!==0&&o%Pm==0?this._type="wheel":o!==0&&Math.abs(o)<4?this._type="trackpad":m>400?(this._type=null,this._lastValue=o,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(m*o)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,o+=this._lastValue)),t.shiftKey&&o&&(o/=4),this._type&&(this._lastWheelEvent=t,this._delta-=o,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);let o=la(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:o,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;let t=this._map.transform;this._type==="wheel"&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);let o=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(this._delta!==0){let C=this._type==="wheel"&&Math.abs(this._delta)>Pm?this._wheelZoomRate:this._defaultZoomRate,M=2/(1+Math.exp(-Math.abs(this._delta*C)));this._delta<0&&M!==0&&(M=1/M);let O=o(),P=Math.pow(2,O),k=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):P;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(k*M))),this._type==="wheel"&&(this._startZoom=O,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}let h=typeof this._targetZoom=="number"?this._targetZoom:o(),m=this._startZoom,_=this._easing,v,E=!1;if(this._type==="wheel"&&m&&_){let C=Math.min((i.q.now()-this._lastWheelEventTime)/200,1),M=_(C);v=i.ai(m,h,M),C<1?this._frameId||(this._frameId=!0):E=!0}else v=h,E=!0;this._active=!0,E&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let T=v-o();return T*this._lastDelta<0&&(T=0),{noInertia:!0,needsRenderFrame:!E,zoomDelta:T,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let o=i.ey;if(this._prevEase){let h=this._prevEase,m=(i.q.now()-h.start)/h.duration,_=h.easing(m+.01)-h.easing(m),v=.27/Math.sqrt(_*_+1e-4)*.01,E=Math.sqrt(.0729-v*v);o=i.ew(v,E,.25,1)}return this._prevEase={start:i.q.now(),duration:t,easing:o},o}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=Se("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class Ly{constructor(t,o){this._clickZoom=t,this._tapZoom=o}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Oy{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,o){return t.preventDefault(),{cameraAnimation:h=>{h.easeTo({duration:300,zoom:h.getZoom()+(t.shiftKey?-1:1),around:h.unproject(o)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class ky{constructor(){this._tap=new rh({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,o,h){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?h.length>0&&(this._swipePoint=o[0],this._swipeTouch=h[0].identifier):this._tap.touchstart(t,o,h))}touchmove(t,o,h){if(this._tapTime){if(this._swipePoint){if(h[0].identifier!==this._swipeTouch)return;let m=o[0],_=m.y-this._swipePoint.y;return this._swipePoint=m,t.preventDefault(),this._active=!0,{zoomDelta:_/128}}}else this._tap.touchmove(t,o,h)}touchend(t,o,h){this._tapTime?this._swipePoint&&h.length===0&&this.reset():this._tap.touchend(t,o,h)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Fy{constructor(t,o,h){this._el=t,this._mousePan=o,this._touchPan=h}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class l1{constructor(t,o,h){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=o,this._mousePitch=h}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class c1{constructor(t,o,h,m){this._el=t,this._touchZoom=o,this._touchRotate=h,this._tapDragZoom=m,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}let Qd=u=>u.zoom||u.drag||u.pitch||u.rotate;class Di extends i.A{}class Ny{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,o){let h=i.at([],o,t);this.radius=i.ae(h[2]<0?i.eA([],h,this.constants):[h[0],h[1],0])}projectRay(t){i.eA(t,t,this.constants),i.au(t,t),i.eB(t,t,this.constants);let o=i.bY([],t,this.radius);if(o[2]>0){let h=i.bY([],[0,0,1],i.bG(o,[0,0,1])),m=i.bY([],i.au([],[o[0],o[1],0]),this.radius),_=i.cV([],o,i.bY([],i.at([],i.cV([],m,h),o),2));o[0]=_[0],o[1]=_[1]}return o}}function ef(u){return u.panDelta&&u.panDelta.mag()||u.zoomDelta||u.bearingDelta||u.pitchDelta}class Lm{constructor(t,o){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Zd(t),this._bearingSnap=o.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Ny,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(o),i.aV(["handleEvent","handleWindowEvent"],this);let h=this._el;this._listeners=[[h,"touchstart",{passive:!0}],[h,"touchmove",{passive:!1}],[h,"touchend",void 0],[h,"touchcancel",void 0],[h,"mousedown",void 0],[h,"mousemove",void 0],[h,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[h,"mouseover",void 0],[h,"mouseout",void 0],[h,"dblclick",void 0],[h,"click",void 0],[h,"keydown",{capture:!1}],[h,"keyup",void 0],[h,"wheel",{passive:!1}],[h,"contextmenu",void 0],[window,"blur",void 0]];for(let[m,_,v]of this._listeners){let E=m===document?this.handleWindowEvent:this.handleEvent;m.addEventListener(_,E,v)}}destroy(){for(let[t,o,h]of this._listeners){let m=t===document?this.handleWindowEvent:this.handleEvent;t.removeEventListener(o,m,h)}}_addDefaultHandlers(t){let o=this._map,h=o.getCanvasContainer();this._add("mapEvent",new Im(o,t));let m=o.boxZoom=new Sm(o,t);this._add("boxZoom",m);let _=new Dm,v=new Oy;o.doubleClickZoom=new Ly(v,_),this._add("tapZoom",_),this._add("clickZoom",v);let E=new ky;this._add("tapDragZoom",E);let T=o.touchPitch=new Dy(o);this._add("touchPitch",T);let C=new Yd(t),M=new Sl(t);o.dragRotate=new l1(t,C,M),this._add("mouseRotate",C,["mousePitch"]),this._add("mousePitch",M,["mouseRotate"]);let O=new Mm(t),P=new Am(o,t);o.dragPan=new Fy(h,O,P),this._add("mousePan",O),this._add("touchPan",P,["touchZoom","touchRotate"]);let k=new Sy,j=new Rm;o.touchZoomRotate=new c1(h,j,k,E),this._add("touchRotate",k,["touchPan","touchZoom"]),this._add("touchZoom",j,["touchPan","touchRotate"]),this._add("blockableMapEvent",new Xd(o));let B=o.scrollZoom=new Py(o,this);this._add("scrollZoom",B,["mousePan"]);let U=o.keyboard=new My;this._add("keyboard",U);for(let q of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[q]&&o[q].enable(t[q])}_add(t,o,h){this._handlers.push({handlerName:t,handler:o,allowed:h}),this._handlersById[t]=o}stop(t){if(!this._updatingCamera){for(let{handler:o}of this._handlers)o.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(let{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Qd(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,o,h){for(let m in t)if(m!==h&&(!o||o.indexOf(m)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){let o=[];for(let h of t)this._el.contains(h.target)&&o.push(h);return o}handleEvent(t,o){this._updatingCamera=!0;let h=t.type==="renderFrame",m=h?void 0:t,_={needsRenderFrame:!1},v={},E={},T=t.touches?this._getMapTouches(t.touches):void 0,C=T?ds(this._el,T):h?void 0:la(this._el,t);for(let{handlerName:P,handler:k,allowed:j}of this._handlers){if(!k.isEnabled())continue;let B;this._blockedByActive(E,j,P)?k.reset():k[o||t.type]&&(B=k[o||t.type](t,C,T),this.mergeHandlerResult(_,v,B,P,m),B&&B.needsRenderFrame&&this._triggerRenderFrame()),(B||k.isActive())&&(E[P]=k)}let M={};for(let P in this._previousActiveHandlers)E[P]||(M[P]=m);this._previousActiveHandlers=E,(Object.keys(M).length||ef(_))&&(this._changes.push([_,v,M]),this._triggerRenderFrame()),(Object.keys(E).length||ef(_))&&this._map._stop(!0),this._updatingCamera=!1;let{cameraAnimation:O}=_;O&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],O(this._map))}mergeHandlerResult(t,o,h,m,_){if(!h)return;i.h(t,h);let v={handlerName:m,originalEvent:h.originalEvent||_};h.zoomDelta!==void 0&&(o.zoom=v),h.panDelta!==void 0&&(o.drag=v),h.pitchDelta!==void 0&&(o.pitch=v),h.bearingDelta!==void 0&&(o.rotate=v)}_applyChanges(){let t={},o={},h={};for(let[m,_,v]of this._changes)m.panDelta&&(t.panDelta=(t.panDelta||new i.P(0,0))._add(m.panDelta)),m.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+m.zoomDelta),m.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+m.bearingDelta),m.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+m.pitchDelta),m.around!==void 0&&(t.around=m.around),m.aroundCoord!==void 0&&(t.aroundCoord=m.aroundCoord),m.pinchAround!==void 0&&(t.pinchAround=m.pinchAround),m.noInertia&&(t.noInertia=m.noInertia),i.h(o,_),i.h(h,v);this._updateMapTransform(t,o,h),this._changes=[]}_updateMapTransform(t,o,h){let m=this._map,_=m.transform,v=Z=>[Z.x,Z.y,Z.z];if((Z=>{let ee=this._eventsInProgress.drag;return ee&&!this._handlersById[ee.handlerName].isActive()})()&&!ef(t)){let Z=_.zoom;_.cameraElevationReference="sea",this._originalZoom!=null&&_._orthographicProjectionAtLowPitch&&_.projection.name!=="globe"&&_.pitch===0?(_.cameraElevationReference="ground",_.zoom=this._originalZoom):(_.recenterOnTerrain(),_.cameraElevationReference="ground"),Z!==_.zoom&&this._map._update(!0)}if(_._isCameraConstrained&&m._stop(!0),!ef(t))return void this._fireEvents(o,h,!0);let{panDelta:E,zoomDelta:T,bearingDelta:C,pitchDelta:M,around:O,aroundCoord:P,pinchAround:k}=t;_._isCameraConstrained&&(T>0&&(T=0),_._isCameraConstrained=!1),k!==void 0&&(O=k),(T||(Z=>o[Z]&&!this._eventsInProgress[Z])("drag"))&&O&&(this._dragOrigin=v(_.pointCoordinate3D(O)),this._originalZoom=_.zoom,this._trackingEllipsoid.setup(_._camera.position,this._dragOrigin)),_.cameraElevationReference="sea",m._stop(!0),O=O||m.transform.centerPoint,C&&(_.bearing+=C),M&&(_.pitch+=M),_._updateCameraState();let j=[0,0,0];if(E)if(_.projection.name==="mercator"){let Z=this._trackingEllipsoid.projectRay(_.screenPointToMercatorRay(O).dir),ee=this._trackingEllipsoid.projectRay(_.screenPointToMercatorRay(O.sub(E)).dir);j[0]=ee[0]-Z[0],j[1]=ee[1]-Z[1]}else{let Z=_.pointCoordinate(O);if(_.projection.name==="globe"){E=E.rotate(-_.angle);let ee=_._pixelsPerMercatorPixel/_.worldSize;j[0]=-E.x*i.ez(i.aY(Z.y))*ee,j[1]=-E.y*i.ez(_.center.lat)*ee}else{let ee=_.pointCoordinate(O.sub(E));Z&&ee&&(j[0]=ee.x-Z.x,j[1]=ee.y-Z.y)}}let B=_.zoom,U=[0,0,0];if(T){let Z=v(P||_.pointCoordinate3D(O)),ee={dir:i.au([],i.at([],Z,_._camera.position))};if(ee.dir[2]<0){let re=_.zoomDeltaToMovement(Z,T);i.bY(U,ee.dir,re)}}let q=i.cV(j,j,U);_._translateCameraConstrained(q),T&&Math.abs(_.zoom-B)>1e-4&&_.recenterOnTerrain(),_.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(o,h,!0)}_fireEvents(t,o,h){let m=Qd(this._eventsInProgress),_=Qd(t),v={};for(let M in t){let{originalEvent:O}=t[M];this._eventsInProgress[M]||(v[`${M}start`]=O),this._eventsInProgress[M]=t[M]}!m&&_&&this._fireEvent("movestart",_.originalEvent);for(let M in v)this._fireEvent(M,v[M]);_&&this._fireEvent("move",_.originalEvent);for(let M in t){let{originalEvent:O}=t[M];this._fireEvent(M,O)}let E={},T;for(let M in this._eventsInProgress){let{handlerName:O,originalEvent:P}=this._eventsInProgress[M];this._handlersById[O].isActive()||(delete this._eventsInProgress[M],T=o[O]||P,E[`${M}end`]=T)}for(let M in E)this._fireEvent(M,E[M]);let C=Qd(this._eventsInProgress);if(h&&(m||_)&&!C){this._updatingCamera=!0;let M=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),O=P=>P!==0&&-this._bearingSnap<P&&P<this._bearingSnap;M?(O(M.bearing||this._map.getBearing())&&(M.bearing=0),this._map.easeTo(M,{originalEvent:T})):(this._map.fire(new i.A("moveend",{originalEvent:T})),O(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,o){this._map.fire(new i.A(t,o?{originalEvent:o}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{this._frameId=void 0,this.handleEvent(new Di("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}let zy="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class lh extends i.E{constructor(t,o){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=o.bearingSnap,this._respectPrefersReducedMotion=o.respectPrefersReducedMotion!==!1,i.aV(["_renderFrameCallback"],this)}getCenter(){return new i.cd(this.transform.center.lng,this.transform.center.lat)}setCenter(t,o){return this.jumpTo({center:t},o)}panBy(t,o,h){return t=i.P.convert(t).mult(-1),this.panTo(this.transform.center,i.h({offset:t},o),h)}panTo(t,o,h){return this.easeTo(i.h({center:t},o),h)}getZoom(){return this.transform.zoom}setZoom(t,o){return this.jumpTo({zoom:t},o),this}zoomTo(t,o,h){return this.easeTo(i.h({zoom:t},o),h)}zoomIn(t,o){return this.zoomTo(this.getZoom()+1,t,o),this}zoomOut(t,o){return this.zoomTo(this.getZoom()-1,t,o),this}getBearing(){return this.transform.bearing}setBearing(t,o){return this.jumpTo({bearing:t},o),this}getPadding(){return this.transform.padding}setPadding(t,o){return this.jumpTo({padding:t},o),this}rotateTo(t,o,h){return this.easeTo(i.h({bearing:t},o),h)}resetNorth(t,o){return this.rotateTo(0,i.h({duration:1e3},t),o),this}resetNorthPitch(t,o){return this.easeTo(i.h({bearing:0,pitch:0,duration:1e3},t),o),this}snapToNorth(t,o){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,o):this}getPitch(){return this.transform.pitch}setPitch(t,o){return this.jumpTo({pitch:t},o),this}cameraForBounds(t,o){t=i.aG.convert(t);let h=o&&o.bearing||0,m=o&&o.pitch||0,_=t.getNorthWest(),v=t.getSouthEast();return this._cameraForBounds(this.transform,_,v,h,m,o)}_extendPadding(t){let o={top:0,right:0,bottom:0,left:0};return t==null?i.h({},o,this.transform.padding):typeof t=="number"?{top:t,bottom:t,right:t,left:t}:i.h({},o,t)}_extendCameraOptions(t){return(t=i.h({offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=this._extendPadding(t.padding),t}_minimumAABBFrustumDistance(t,o){let h=o.max[0]-o.min[0],m=o.max[1]-o.min[1];return h/m>t.aspect?h/(2*Math.tan(.5*t.fovX)*t.aspect):m/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,o,h,m,_,v){let E=t.clone(),T=this._extendCameraOptions(v);E.bearing=m,E.pitch=_;let C=i.cd.convert(o),M=i.cd.convert(h),O=.5*(C.lat+M.lat),P=.5*(C.lng+M.lng),k=i.eC(O,P),j=i.au([],k),B=i.au([],i.bF([],j,[0,1,0])),U=i.bF([],B,j),q=[B[0],B[1],B[2],0,U[0],U[1],U[2],0,j[0],j[1],j[2],0,0,0,0,1],Z=[k,i.eC(C.lat,C.lng),i.eC(M.lat,C.lng),i.eC(M.lat,M.lng),i.eC(C.lat,M.lng),i.eC(O,C.lng),i.eC(O,M.lng),i.eC(C.lat,P),i.eC(M.lat,P)],ee=i.cW.fromPoints(Z.map(Me=>[i.bG(B,Me),i.bG(U,Me),i.bG(j,Me)])),re=i.ad([],ee.center,q);i.eD(re)===0&&i.eE(re,0,0,1),i.au(re,re),i.bY(re,re,i.aB),E.center=i.eF(re);let ue=E.getWorldToCameraMatrix(),le=i.bi(new Float64Array(16),ue);ee=i.cW.applyTransform(ee,i.az([],ue,q));let se=this._extendAABB(ee,E,T,m);if(!se)return void i.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");ee=se,i.ad(re,re,ue);let oe=.5*(ee.max[2]-ee.min[2]),he=this._minimumAABBFrustumDistance(E,ee),fe=i.bY([],[0,0,1],oe),Te=i.cV(fe,re,fe),Ie=he+(E.pitch===0?0:i.bD(re,Te)),Be=E.globeCenterInViewSpace,Ve=i.at([],re,[Be[0],Be[1],Be[2]]);i.au(Ve,Ve),i.bY(Ve,Ve,Ie);let We=i.cV([],re,Ve);i.ad(We,We,le);let we=i.eq/i.aB,Oe=i.ae(We),_e=i.c6(Math.max(Oe*we-i.eq,Number.EPSILON),0),Ue=Math.min(E.zoomFromMercatorZAdjusted(_e),T.maxZoom);return Ue>.5*(i.cL+i.cx)?(E.setProjection({name:"mercator"}),E.zoom=Ue,this._cameraForBounds(E,o,h,m,_,v)):{center:E.center,zoom:Ue,bearing:m,pitch:_}}_extendAABB(t,o,h,m){let _=.5*((h.padding.left||0)+(h.padding.right||0)),v=.5*((h.padding.top||0)+(h.padding.bottom||0)),E=v,T=_,C=_,M=v,O=o.width-(T+C),P=o.height-(E+M),k=i.at([],t.max,t.min),j=Math.min(O/k[0],P/k[1]),B=Math.min(o.scaleZoom(o.scale*j),h.maxZoom);if(isNaN(B))return null;let U=o.scale/o.zoomScale(B),q=new i.cW([t.min[0]-T*U,t.min[1]-M*U,t.min[2]],[t.max[0]+C*U,t.max[1]+E*U,t.max[2]]),Z=(typeof h.offset.x=="number"&&typeof h.offset.y=="number"?new i.P(h.offset.x,h.offset.y):i.P.convert(h.offset)).rotate(-i.al(m));return q.center[0]-=Z.x*U,q.center[1]+=Z.y*U,q}queryTerrainElevation(t,o){let h=this.transform.elevation;return h?(o=i.h({},{exaggerated:!0},o),h.getAtPoint(i.ac.fromLngLat(t),null,o.exaggerated)):null}_cameraForBounds(t,o,h,m,_,v){if(t.projection.name==="globe")return this._cameraForBoundsOnGlobe(t,o,h,m,_,v);let E=t.clone(),T=this._extendCameraOptions(v);E.bearing=m,E.pitch=_;let C=i.cd.convert(o),M=i.cd.convert(h),O=new i.cd(C.lng,M.lat),P=new i.cd(M.lng,C.lat),k=E.project(C),j=E.project(M),B=this.queryTerrainElevation(C),U=this.queryTerrainElevation(M),q=this.queryTerrainElevation(O),Z=this.queryTerrainElevation(P),ee=[[k.x,k.y,Math.min(B||0,U||0,q||0,Z||0)],[j.x,j.y,Math.max(B||0,U||0,q||0,Z||0)]],re=i.cW.fromPoints(ee),ue=E.getWorldToCameraMatrix(),le=i.bi(new Float64Array(16),ue);re=i.cW.applyTransform(re,ue);let se=this._extendAABB(re,E,T,m);if(!se)return void i.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");re=se;let oe=.5*i.at([],re.max,re.min)[2],he=this._minimumAABBFrustumDistance(E,re),fe=[0,0,1,0];i.aA(fe,fe,ue),i.eG(fe,fe);let Te=i.bY([],fe,he+oe),Ie=i.cV([],re.center,Te);i.ad(re.center,re.center,le),i.ad(Ie,Ie,le);let Be=E.unproject(new i.P(re.center[0],re.center[1])),Ve=i.eH(E.projection,Be),We=Math.pow(2,Ve),we=Math.min(E._zoomFromMercatorZ(Ie[2]*E.pixelsPerMeter*We/E.worldSize),T.maxZoom);return E.mercatorFromTransition&&we<.5*(i.cL+i.cx)?(E.setProjection({name:"globe"}),E.zoom=we,this._cameraForBounds(E,o,h,m,_,v)):{center:Be,zoom:we,bearing:m,pitch:_}}fitBounds(t,o,h){let m=this.cameraForBounds(t,o);return this._fitInternal(m,o,h)}fitScreenCoordinates(t,o,h,m,_){let v=i.P.convert(t),E=i.P.convert(o),T=new i.P(Math.min(v.x,E.x),Math.min(v.y,E.y)),C=new i.P(Math.max(v.x,E.x),Math.max(v.y,E.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(v,E))return this;let M=this.transform.pointLocation3D(T),O=this.transform.pointLocation3D(C),P=this.transform.pointLocation3D(new i.P(T.x,C.y)),k=this.transform.pointLocation3D(new i.P(C.x,T.y)),j=[Math.min(M.lng,O.lng,P.lng,k.lng),Math.min(M.lat,O.lat,P.lat,k.lat)],B=[Math.max(M.lng,O.lng,P.lng,k.lng),Math.max(M.lat,O.lat,P.lat,k.lat)],U=m&&m.pitch?m.pitch:this.getPitch(),q=this._cameraForBounds(this.transform,j,B,h,U,m);return this._fitInternal(q,m,_)}_fitInternal(t,o,h){return t?(o=i.h(t,o)).linear?this.easeTo(o,h):this.flyTo(o,h):this}jumpTo(t,o){this.stop();let h=t.preloadOnly?this.transform.clone():this.transform,m=!1,_=!1,v=!1;"zoom"in t&&h.zoom!==+t.zoom&&(m=!0,h.zoom=+t.zoom),t.center!==void 0&&(h.center=i.cd.convert(t.center)),"bearing"in t&&h.bearing!==+t.bearing&&(_=!0,h.bearing=+t.bearing),"pitch"in t&&h.pitch!==+t.pitch&&(v=!0,h.pitch=+t.pitch);let E=typeof t.padding=="number"?this._extendPadding(t.padding):t.padding;if(t.padding!=null&&!h.isPaddingEqual(E))if(t.retainPadding===!1){let T=h.clone();T.padding=E,h.setLocationAtPoint(h.center,T.centerPoint)}else h.padding=E;return t.preloadOnly?(this._preloadTiles(h),this):(this.fire(new i.A("movestart",o)).fire(new i.A("move",o)),m&&this.fire(new i.A("zoomstart",o)).fire(new i.A("zoom",o)).fire(new i.A("zoomend",o)),_&&this.fire(new i.A("rotatestart",o)).fire(new i.A("rotate",o)).fire(new i.A("rotateend",o)),v&&this.fire(new i.A("pitchstart",o)).fire(new i.A("pitch",o)).fire(new i.A("pitchend",o)),this.fire(new i.A("moveend",o)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||i.w(zy),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,o){let h=this.transform;if(!h.projection.supportsFreeCamera)return i.w(zy),this;this.stop();let m=h.zoom,_=h.pitch,v=h.bearing;h.setFreeCameraOptions(t);let E=m!==h.zoom,T=_!==h.pitch,C=v!==h.bearing;return this.fire(new i.A("movestart",o)).fire(new i.A("move",o)),E&&this.fire(new i.A("zoomstart",o)).fire(new i.A("zoom",o)).fire(new i.A("zoomend",o)),C&&this.fire(new i.A("rotatestart",o)).fire(new i.A("rotate",o)).fire(new i.A("rotateend",o)),T&&this.fire(new i.A("pitchstart",o)).fire(new i.A("pitch",o)).fire(new i.A("pitchend",o)),this.fire(new i.A("moveend",o)),this}easeTo(t,o){this._stop(!1,t.easeId),((t=i.h({offset:[0,0],duration:500,easing:i.ey},t)).animate===!1||this._prefersReducedMotion(t))&&(t.duration=0);let h=this.transform,m=this.getZoom(),_=this.getBearing(),v=this.getPitch(),E=this.getPadding(),T="zoom"in t?+t.zoom:m,C="bearing"in t?this._normalizeBearing(t.bearing,_):_,M="pitch"in t?+t.pitch:v,O=this._extendPadding(t.padding),P=i.P.convert(t.offset),k,j,B;if(h.projection.name==="globe"){let fe=i.ac.fromLngLat(h.center),Te=P.rotate(-h.angle);fe.x+=Te.x/h.worldSize,fe.y+=Te.y/h.worldSize;let Ie=fe.toLngLat(),Be=i.cd.convert(t.center||Ie);this._normalizeCenter(Be),k=h.centerPoint.add(Te),j=new i.P(fe.x,fe.y).mult(h.worldSize),B=new i.P(i.aD(Be.lng),i.aH(Be.lat)).mult(h.worldSize).sub(j)}else{k=h.centerPoint.add(P);let fe=h.pointLocation(k),Te=i.cd.convert(t.center||fe);this._normalizeCenter(Te),j=h.project(fe),B=h.project(Te).sub(j)}let U=h.zoomScale(T-m),q,Z;t.around&&(q=i.cd.convert(t.around),Z=h.locationPoint(q));let ee=this._zooming||T!==m,re=this._rotating||_!==C,ue=this._pitching||M!==v,le=!h.isPaddingEqual(O),se=t.retainPadding===!1?h.clone():h,oe=fe=>Te=>{if(ee&&(fe.zoom=i.ai(m,T,Te)),re&&(fe.bearing=i.ai(_,C,Te)),ue&&(fe.pitch=i.ai(v,M,Te)),le&&(se.interpolatePadding(E,O,Te),k=se.centerPoint.add(P)),q)fe.setLocationAtPoint(q,Z);else{let Ie=fe.zoomScale(fe.zoom-m),Be=T>m?Math.min(2,U):Math.max(.5,U),Ve=Math.pow(Be,1-Te),We=fe.unproject(j.add(B.mult(Te*Ve)).mult(Ie));fe.setLocationAtPoint(fe.renderWorldCopies?We.wrap():We,k)}return t.preloadOnly||this._fireMoveEvents(o),fe};if(t.preloadOnly){let fe=this._emulate(oe,t.duration,h);return this._preloadTiles(fe),this}let he={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=ee,this._rotating=re,this._pitching=ue,this._padding=le,this._easeId=t.easeId,this._prepareEase(o,t.noMoveStart,he),this._ease(oe(h),fe=>{h.cameraElevationReference==="sea"&&h.recenterOnTerrain(),this._afterEase(o,fe)},t),this}_prepareEase(t,o,h={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),o||h.moving||this.fire(new i.A("movestart",t)),this._zooming&&!h.zooming&&this.fire(new i.A("zoomstart",t)),this._rotating&&!h.rotating&&this.fire(new i.A("rotatestart",t)),this._pitching&&!h.pitching&&this.fire(new i.A("pitchstart",t))}_fireMoveEvents(t){this.fire(new i.A("move",t)),this._zooming&&this.fire(new i.A("zoom",t)),this._rotating&&this.fire(new i.A("rotate",t)),this._pitching&&this.fire(new i.A("pitch",t))}_afterEase(t,o){if(this._easeId&&o&&this._easeId===o)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";let h=this._zooming,m=this._rotating,_=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,h&&this.fire(new i.A("zoomend",t)),m&&this.fire(new i.A("rotateend",t)),_&&this.fire(new i.A("pitchend",t)),this.fire(new i.A("moveend",t))}flyTo(t,o){if(this._prefersReducedMotion(t)){let Me=i.aF(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Me,o)}this.stop(),t=i.h({offset:[0,0],speed:1.2,curve:1.42,easing:i.ey},t);let h=this.transform,m=this.getZoom(),_=this.getBearing(),v=this.getPitch(),E=this.getPadding(),T="zoom"in t?i.ay(+t.zoom,h.minZoom,h.maxZoom):m,C="bearing"in t?this._normalizeBearing(t.bearing,_):_,M="pitch"in t?+t.pitch:v,O=this._extendPadding(t.padding),P=h.zoomScale(T-m),k=i.P.convert(t.offset),j=h.centerPoint.add(k),B=h.pointLocation(j),U=i.cd.convert(t.center||B);this._normalizeCenter(U);let q=h.project(B),Z=h.project(U).sub(q),ee=t.curve,re=Math.max(h.width,h.height),ue=re/P,le=Z.mag();if("minZoom"in t){let Me=i.ay(Math.min(t.minZoom,m,T),h.minZoom,h.maxZoom),Ge=re/h.zoomScale(Me-m);ee=Math.sqrt(Ge/le*2)}let se=ee*ee;function oe(Me){let Ge=(ue*ue-re*re+(Me?-1:1)*se*se*le*le)/(2*(Me?ue:re)*se*le);return Math.log(Math.sqrt(Ge*Ge+1)-Ge)}function he(Me){return(Math.exp(Me)-Math.exp(-Me))/2}function fe(Me){return(Math.exp(Me)+Math.exp(-Me))/2}let Te=oe(0),Ie=function(Me){return fe(Te)/fe(Te+ee*Me)},Be=function(Me){return re*((fe(Te)*(he(Ge=Te+ee*Me)/fe(Ge))-he(Te))/se)/le;var Ge},Ve=(oe(1)-Te)/ee;if(Math.abs(le)<1e-6||!isFinite(Ve)){if(Math.abs(re-ue)<1e-6)return this.easeTo(t,o);let Me=ue<re?-1:1;Ve=Math.abs(Math.log(ue/re))/ee,Be=function(){return 0},Ie=function(Ge){return Math.exp(Me*ee*Ge)}}t.duration="duration"in t?+t.duration:1e3*Ve/("screenSpeed"in t?+t.screenSpeed/ee:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);let We=_!==C,we=M!==v,Oe=!h.isPaddingEqual(O),_e=t.retainPadding===!1?h.clone():h,Ue=Me=>Ge=>{let nt=Ge*Ve,je=1/Ie(nt);Me.zoom=Ge===1?T:m+Me.scaleZoom(je),We&&(Me.bearing=i.ai(_,C,Ge)),we&&(Me.pitch=i.ai(v,M,Ge)),Oe&&(_e.interpolatePadding(E,O,Ge),j=_e.centerPoint.add(k));let et=Ge===1?U:Me.unproject(q.add(Z.mult(Be(nt))).mult(je));return Me.setLocationAtPoint(Me.renderWorldCopies?et.wrap():et,j),Me._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(o),Me};if(t.preloadOnly){let Me=this._emulate(Ue,t.duration,h);return this._preloadTiles(Me),this}return this._zooming=!0,this._rotating=We,this._pitching=we,this._padding=Oe,this._prepareEase(o,!1),this._ease(Ue(h),()=>this._afterEase(o),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(t){}_cancelRenderFrame(t){}_stop(t,o){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){let h=this._onEaseEnd;this._onEaseEnd=void 0,h.call(this,o)}if(!t){let h=this.handlers;h&&h.stop(!1)}return this}_ease(t,o,h){h.animate===!1||h.duration===0?(t(1),o()):(this._easeStart=i.q.now(),this._easeOptions=h,this._onEaseFrame=t,this._onEaseEnd=o,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){let t=Math.min((i.q.now()-this._easeStart)/this._easeOptions.duration,1),o=this._onEaseFrame;o&&o(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,o){t=i.bX(t,-180,180);let h=Math.abs(t-o);return Math.abs(t-360-o)<h&&(t-=360),Math.abs(t+360-o)<h&&(t+=360),t}_normalizeCenter(t){let o=this.transform;if(o.maxBounds||o.projection.name!=="globe"&&!o.renderWorldCopies)return;let h=t.lng-o.center.lng;t.lng+=h>180?-360:h<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&i.q.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,o,h){let m=Math.ceil(15*o/1e3),_=[],v=t(h.clone());for(let E=0;E<=m;E++){let T=v(E/m);_.push(T.clone())}return _}_preloadTiles(t,o){}}class Om{constructor(t={}){this.options=t,i.aV(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){let o=this.options&&this.options.compact,h=t._getUIString("AttributionControl.ToggleAttribution");this._map=t,this._container=Se("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=Se("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",h);let m=Se("span","mapboxgl-ctrl-icon",this._compactButton);return m.setAttribute("aria-hidden","true"),m.setAttribute("title",h),this._innerContainer=Se("div","mapboxgl-ctrl-attrib-inner",this._container),o&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),o===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));let o=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||i.e.ACCESS_TOKEN}];if(t){let h=o.reduce((m,_,v)=>(_.value&&(m+=`${_.key}=${_.value}${v<o.length-1?"&":""}`),m),"?");t.href=`${i.e.FEEDBACK_URL}/${h}#${Wd(this._map,!0)}`,t.rel="noopener nofollow"}}_updateData(t){!t||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility"&&t.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){let m=this._map.style.stylesheet;this.styleOwner=m.owner,this.styleId=m.id}let o=this._map.style._mergedSourceCaches;for(let m in o){let _=o[m];if(_.used){let v=_.getSource();v.attribution&&t.indexOf(v.attribution)<0&&t.push(v.attribution)}}t.sort((m,_)=>m.length-_.length),t=t.filter((m,_)=>{for(let v=_+1;v<t.length;v++)if(t[v].indexOf(m)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));let h=t.join(" | ");h!==this._attribHTML&&(this._attribHTML=h,t.length?(this._innerContainer.innerHTML=h,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class tf{constructor(){i.aV(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=Se("div","mapboxgl-ctrl");let o=Se("a","mapboxgl-ctrl-logo");return o.target="_blank",o.rel="noopener nofollow",o.href="https://www.mapbox.com/",o.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),o.setAttribute("rel","noopener nofollow"),this._container.appendChild(o),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&t.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;let t=this._map.style._sourceCaches;if(Object.entries(t).length===0)return!0;for(let o in t){let h=t[o].getSource();if(h.hasOwnProperty("mapbox_logo")&&!h.mapbox_logo)return!1}return!0}_updateCompact(){let t=this._container.children;if(t.length){let o=t[0];this._map.getCanvasContainer().offsetWidth<250?o.classList.add("mapboxgl-compact"):o.classList.remove("mapboxgl-compact")}}}class ch{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){let o=++this._id;return this._queue.push({callback:t,id:o,cancelled:!1}),o}remove(t){let o=this._currentlyRunning,h=o?this._queue.concat(o):this._queue;for(let m of h)if(m.id===t)return void(m.cancelled=!0)}run(t=0){let o=this._currentlyRunning=this._queue;this._queue=[];for(let h of o)if(!h.cancelled&&(h.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class qs{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;let o=i.dk((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-o)+this._end*o}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,o,h){this._start=this.getValue(o),this._end=t,this._startTime=o,this._endTime=o+h}}let nf={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class Ni extends i.A{constructor(t,o,h,m){let{point:_,lngLat:v,originalEvent:E,target:T}=t;super(t.type,{point:_,lngLat:v,originalEvent:E,target:T}),this.preventDefault=()=>{t.preventDefault()},this.id=o,this.interaction=h,this.feature=m}}class _s{constructor(t){this.map=t,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,o){if(this.typeById.has(t))throw new Error(`Interaction id "${t}" already exists.`);let h=o.filter,m=o.type;h&&this.filters.set(t,i.b3(h)),m==="mouseover"&&(m="mouseenter"),m==="mouseout"&&(m="mouseleave");let _=this.interactionsByType.get(m)||new Map;m==="mouseenter"||m==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,o)):_.size===0&&this.map.on(m,this.handleType),_.size===0&&this.interactionsByType.set(m,_),_.set(t,o),this.typeById.set(t,m)}get(t){let o=this.typeById.get(t);if(!o)return;let h=this.interactionsByType.get(o);return h?h.get(t):void 0}remove(t){let o=this.typeById.get(t);if(!o)return;this.typeById.delete(t),this.filters.delete(t);let h=this.interactionsByType.get(o);h&&(h.delete(t),o==="mouseenter"||o==="mouseleave"?(this.delegatedInteractions.delete(t),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):h.size===0&&this.map.off(o,this.handleType))}queryTargets(t,o){let h=[];for(let[m,_]of o)_.target&&h.push({targetId:m,target:_.target,filter:this.filters.get(m)});return this.map.style.queryRenderedTargets(t,h,this.map.transform)}handleMove(t){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;let o=this.queryTargets(t.point,Array.from(this.delegatedInteractions).reverse());o.length&&(t.type="mouseenter",this.handleType(t,o));let h=new Map;for(let[m,{feature:_}]of this.prevHoveredFeatures)this.hoveredFeatures.has(m)||h.set(_.id,_);h.size&&(t.type="mouseleave",this.handleType(t,Array.from(h.values())))}handleOut(t){let o=Array.from(this.hoveredFeatures.values()).map(({feature:h})=>h);o.length&&(t.type="mouseleave",this.handleType(t,o)),this.hoveredFeatures.clear()}handleType(t,o){let h=t.type==="mouseenter";if(h&&!this.interactionsByType.has(t.type))return void i.w("mouseenter interaction required for mouseleave to work.");let m=Array.from(this.interactionsByType.get(t.type)).reverse(),_=!!o;o=o||this.queryTargets(t.point,m);let v=!1,E=new Set;for(let T of o){for(let[C,M]of m){if(!M.target)continue;let O=T.variants?T.variants[C]:null;if(O){for(let P of O){if(sd(P,T,E,C))continue;let k=new i.de(T,P),j=wu(P,T,C);_&&(k.state=this.map.getFeatureState(k));let B=h?this.prevHoveredFeatures.get(j):null,U=new Ni(t,C,M,k),q=B?B.stop:M.handler(U);if(h&&this.hoveredFeatures.set(j,{feature:T,stop:q}),q!==!1){v=!0;break}}if(v)break}}if(v)break}if(!v)for(let[T,C]of m){let{handler:M,target:O}=C;if(!O&&M(new Ni(t,T,C,null))!==!1)break}}}function uh(u,t){if(Array.isArray(u)&&Array.isArray(t)){let o=new Set(u),h=new Set(t);return o.size===h.size&&u.every(m=>h.has(m))}return i.bv(u,t)}let rf={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},By={showCompass:!0,showZoom:!0,visualizePitch:!1};class u1{constructor(t,o,h=!1){this._clickTolerance=10,this.element=o,this.mouseRotate=new Yd({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,h&&(this.mousePitch=new Sl({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),i.aV(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),o.addEventListener("mousedown",this.mousedown),o.addEventListener("touchstart",this.touchstart,{passive:!1}),o.addEventListener("touchmove",this.touchmove),o.addEventListener("touchend",this.touchend),o.addEventListener("touchcancel",this.reset)}down(t,o){this.mouseRotate.mousedown(t,o),this.mousePitch&&this.mousePitch.mousedown(t,o),Yi()}move(t,o){let h=this.map,m=this.mouseRotate.mousemoveWindow(t,o),_=m&&m.bearingDelta;if(_&&h.setBearing(h.getBearing()+_),this.mousePitch){let v=this.mousePitch.mousemoveWindow(t,o),E=v&&v.pitchDelta;E&&h.setPitch(h.getPitch()+E)}}off(){let t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){fr(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(i.h({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),la(this.element,t)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,la(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=ds(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=ds(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function Lc(u,t,o){if(u=new i.cd(u.lng,u.lat),t){let h=new i.cd(u.lng-360,u.lat),m=new i.cd(u.lng+360,u.lat),_=360*Math.ceil(Math.abs(u.lng-o.center.lng)/360),v=o.locationPoint3D(u).distSqr(t),E=t.x<0||t.y<0||t.x>o.width||t.y>o.height;o.locationPoint3D(h).distSqr(t)<v&&(E||Math.abs(h.lng-o.center.lng)<_)?u=h:o.locationPoint3D(m).distSqr(t)<v&&(E||Math.abs(m.lng-o.center.lng)<_)&&(u=m)}for(;Math.abs(u.lng-o.center.lng)>180;){let h=o.locationPoint3D(u);if(h.x>=0&&h.y>=0&&h.x<=o.width&&h.y<=o.height)break;u.lng>o.center.lng?u.lng-=360:u.lng+=360}return u}let km={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},ys={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class hh extends i.E{constructor(t,o){super(),(t instanceof HTMLElement||o)&&(t=i.h({element:t},o)),i.aV(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);let{anchor:h="center",color:m="#3FB1CE",scale:_=1,draggable:v=!1,clickTolerance:E=0,rotation:T=ys.rotation,rotationAlignment:C=ys.rotationAlignment,pitchAlignment:M=ys.pitchAlignment,occludedOpacity:O=ys.occludedOpacity,altitude:P=ys.altitude}=t||{};this._anchor=h,this._color=m,this._scale=_,this._draggable=v,this._clickTolerance=E,this._rotation=T,this._rotationAlignment=C,this._pitchAlignment=M,this._occludedOpacity=O,this._altitude=P,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),t&&t.element?(this._element=t.element,this._offset=i.P.convert(t&&t.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=i.P.convert(t&&t.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",B=>{B.preventDefault()}),this._element.addEventListener("mousedown",B=>{B.preventDefault()});let k=this._element.classList;for(let B in km)k.remove(`mapboxgl-marker-anchor-${B}`);k.add(`mapboxgl-marker-anchor-${this._anchor}`);let j=t&&t.className?t.className.trim().split(/\s+/):[];k.add(...j),this._popup=null}_createDefaultMarker(){let t=Se("div"),o=It("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},t);if(this._altitude===0){let h=It("radialGradient",{id:"shadowGradient"},It("defs",{},o));It("stop",{offset:"10%","stop-opacity":.4},h),It("stop",{offset:"100%","stop-opacity":.05},h),It("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},o)}return It("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},o),It("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},o),It("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},o),t}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){let t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=i.cd.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(t){return t===this._altitude||(this._defaultMarker&&(this._altitude===0&&t!==0||this._altitude!==0&&t===0)&&(this._element=this._createDefaultMarker()),this._altitude=t||ys.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){let m=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[m,-1*(38.1-13.5+m)],"bottom-right":[-m,-1*(38.1-13.5+m)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,t._marker=this,t._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){let o=t.code,h=t.charCode||t.keyCode;o!=="Space"&&o!=="Enter"&&h!==32&&h!==13||this.togglePopup()}_onMapClick(t){let o=t.originalEvent.target,h=this._element;this._popup&&(o===h||h.contains(o))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){let t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){let t=this._map,o=this._pos;if(!t||!o)return!1;let h=t.unproject(o,this._altitude),m=t.getFreeCameraOptions();if(!m.position)return!1;let _=m.position.toLngLat();return _.distanceTo(h)<.9*_.distanceTo(this._lngLat)}_evaluateOpacity(){let t=this._map;if(!t)return;let o=this._pos;if(!o||o.x<0||o.x>t.transform.width||o.y<0||o.y>t.transform.height)return void this._clearFadeTimer();let h=t.unproject(o,this._altitude),m;t._showingGlobe()&&i.eK(t.transform,this._lngLat)?m=0:(m=1-t._queryFogOpacity(h),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(m*=this._occludedOpacity)),this._element.style.opacity=`${m}`,this._element.style.pointerEvents=m>0?"auto":"none",this._popup&&this._popup._setOpacity(m),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){let t=this._pos;if(!t||!this._map)return;let o=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${t.x}px,${t.y}px)
            ${km[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${o.x}px,${o.y}px)
        `}_calculateXYTransform(){let t=this._pos,o=this._map,h=this.getPitchAlignment();if(!o||!t||h!=="map")return"";if(!o._showingGlobe()){let T=o.getPitch();return T?`rotateX(${T}deg)`:""}let m=i.cJ(i.eL(o.transform,this._lngLat)),_=t.sub(i.eM(o.transform)),v=Math.abs(_.x)+Math.abs(_.y);if(v===0)return"";let E=m/v;return`rotateX(${-_.y*E}deg) rotateY(${_.x*E}deg)`}_calculateZTransform(){let t=this._pos,o=this._map;if(!o||!t)return"";let h=0,m=this.getRotationAlignment();if(m==="map")if(o._showingGlobe()){let _=o.project(new i.cd(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),v=o.project(new i.cd(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(_);h=i.cJ(Math.atan2(v.y,v.x))-90}else h=-o.getBearing();else if(m==="horizon"){let _=i.af(4,6,o.getZoom()),v=i.eM(o.transform);v.y+=_*o.transform.height;let E=t.sub(v),T=i.cJ(Math.atan2(E.y,E.x));h=(T>90?T-270:T+90)*(1-_)}return h+=this._rotation,h?`rotateZ(${h}deg)`:""}_update(t){cancelAnimationFrame(this._updateFrameId);let o=this._map;o&&(o.transform.renderWorldCopies&&(this._lngLat=Lc(this._lngLat,this._pos,o.transform)),this._pos=o.project(this._lngLat,this._altitude),t===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),o._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(o._showingGlobe()||o.getTerrain()||o.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(t){return this._offset=i.P.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){let o=this._map;if(!o)return;let h=this._pointerdownPos,m=this._positionDelta;if(h&&m){if(!this._isDragging){let _=this._clickTolerance||o._clickTolerance;if(t.point.dist(h)<_)return;this._isDragging=!0}this._pos=t.point.sub(m),this._lngLat=o.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new i.A("dragstart"))),this.fire(new i.A("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;let t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new i.A("dragend")),this._state="inactive"}_addDragHandler(t){let o=this._map,h=this._pos;o&&h&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(h),this._pointerdownPos=t.point,this._state="pending",o.on("mousemove",this._onMove),o.on("touchmove",this._onMove),o.once("mouseup",this._onUp),o.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;let o=this._map;return o&&(t?(o.on("mousedown",this._addDragHandler),o.on("touchstart",this._addDragHandler)):(o.off("mousedown",this._addDragHandler),o.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||ys.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||ys.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||ys.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||ys.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}let Fm={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},dh={maxWidth:100,unit:"metric"},Oc={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},Ws={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},Qo=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function zo(u=new i.P(0,0),t="bottom"){if(typeof u=="number"){let o=Math.round(Math.sqrt(.5*Math.pow(u,2)));switch(t){case"top":return new i.P(0,u);case"top-left":return new i.P(o,o);case"top-right":return new i.P(-o,o);case"bottom":return new i.P(0,-u);case"bottom-left":return new i.P(o,-o);case"bottom-right":return new i.P(-o,-o);case"left":return new i.P(u,0);case"right":return new i.P(-u,0)}return new i.P(0,0)}return u instanceof i.P||Array.isArray(u)?i.P.convert(u):i.P.convert(u[t]||[0,0])}return{version:A,supported:st.supported,setRTLTextPlugin:i.eQ,getRTLTextPluginStatus:i.eP,Map:class extends lh{constructor(u){H.mark(N.create);let t=u;if((u=i.h({},rf,u)).minZoom!=null&&u.maxZoom!=null&&u.minZoom>u.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(u.minPitch!=null&&u.maxPitch!=null&&u.minPitch>u.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(u.minPitch!=null&&u.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(u.maxPitch!=null&&u.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(u.antialias&&i.eI(window)&&(u.antialias=!1,i.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Up(u.minZoom,u.maxZoom,u.minPitch,u.maxPitch,u.renderWorldCopies,null,null),u),this._repaint=!!u.repaint,this._interactive=u.interactive,this._minTileCacheSize=u.minTileCacheSize,this._maxTileCacheSize=u.maxTileCacheSize,this._failIfMajorPerformanceCaveat=u.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=u.preserveDrawingBuffer,this._antialias=u.antialias,this._trackResize=u.trackResize,this._bearingSnap=u.bearingSnap,this._refreshExpiredTiles=u.refreshExpiredTiles,this._fadeDuration=u.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=u.crossSourceCollisions,this._collectResourceTiming=u.collectResourceTiming,this._language=this._parseLanguage(u.language),this._worldview=u.worldview,this._renderTaskQueue=new ch,this._domRenderTaskQueue=new ch,this._controls=[],this._markers=[],this._popups=[],this._mapId=i.a$(),this._locale=i.h({},nf,u.locale),this._clickTolerance=u.clickTolerance,this._cooperativeGestures=u.cooperativeGestures,this._performanceMetricsCollection=u.performanceMetricsCollection,this._tessellationStep=u.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=u.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new qs(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=u.scaleFactor,this._requestManager=new qn(u.transformRequest,u.accessToken,u.testMode),this._silenceAuthErrors=!!u.testMode,this._contextCreateOptions=u.contextCreateOptions?Object.assign({},u.contextCreateOptions):{},typeof u.container=="string"){let o=document.getElementById(u.container);if(!o)throw new Error(`Container '${u.container.toString()}' not found.`);this._container=o}else{if(!(u.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=u.container}if(this._container.childNodes.length>0&&i.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),u.maxBounds&&this.setMaxBounds(u.maxBounds),this._spriteFormat=u.spriteFormat,i.aV(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new vm),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new Lm(this,u),this._localFontFamily=u.localFontFamily,this._localIdeographFontFamily=u.localIdeographFontFamily,(u.style||!u.testMode)&&this.setStyle(u.style||i.e.DEFAULT_STYLE,{config:u.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),u.projection&&this.setProjection(u.projection),this.indoor=new Pb(this),u.hash&&(this._hash=new Em(typeof u.hash=="string"&&u.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){t.center==null&&t.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:u.center,zoom:u.zoom,bearing:u.bearing,pitch:u.pitch});let o=u.bounds;o&&(this.resize(),this.fitBounds(o,i.h({},u.fitBoundsOptions,{duration:0})))}this.resize(),u.attributionControl&&this.addControl(new Om({customAttribution:u.customAttribution})),this._logoControl=new tf,this.addControl(this._logoControl,u.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",o=>{this._update(o.dataType==="style"),this.fire(new i.A(`${o.dataType}data`,o))}),this.on("dataloading",o=>{this.fire(new i.A(`${o.dataType}dataloading`,o))}),this._interactions=new _s(this)}_getMapId(){return this._mapId}addControl(u,t){if(t===void 0&&(t=u.getDefaultPosition?u.getDefaultPosition():"top-right"),!u||!u.onAdd)return this.fire(new i.z(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));let o=u.onAdd(this);this._controls.push(u);let h=this._controlPositions[t];return t.indexOf("bottom")!==-1?h.insertBefore(o,h.firstChild):h.appendChild(o),this}removeControl(u){if(!u||!u.onRemove)return this.fire(new i.z(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));let t=this._controls.indexOf(u);return t>-1&&this._controls.splice(t,1),u.onRemove(this),this}hasControl(u){return this._controls.indexOf(u)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(u){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));let t=!this._moving;return t&&this.fire(new i.A("movestart",u)).fire(new i.A("move",u)),this.fire(new i.A("resize",u)),t&&this.fire(new i.A("moveend",u)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(u){return this.transform.setMaxBounds(i.aG.convert(u)),this._update()}setMinZoom(u){if((u=u??-2)>=-2&&u<=this.transform.maxZoom)return this.transform.minZoom=u,this._update(),this.getZoom()<u?this.setZoom(u):this.fire(new i.A("zoomstart")).fire(new i.A("zoom")).fire(new i.A("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(u){if((u=u??22)>=this.transform.minZoom)return this.transform.maxZoom=u,this._update(),this.getZoom()>u?this.setZoom(u):this.fire(new i.A("zoomstart")).fire(new i.A("zoom")).fire(new i.A("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(u){if((u=u??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(u>=0&&u<=this.transform.maxPitch)return this.transform.minPitch=u,this._update(),this.getPitch()<u?this.setPitch(u):this.fire(new i.A("pitchstart")).fire(new i.A("pitch")).fire(new i.A("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(u){if((u=u??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(u>=this.transform.minPitch)return this.transform.maxPitch=u,this._update(),this.getPitch()>u?this.setPitch(u):this.fire(new i.A("pitchstart")).fire(new i.A("pitch")).fire(new i.A("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(u){return this._scaleFactor=u,this.painter.scaleFactor=u,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(t=>t.type==="symbol"),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(u){return this.transform.renderWorldCopies=u,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(u){return u==="auto"?navigator.language:Array.isArray(u)?u.length===0?void 0:u.map(t=>t==="auto"?navigator.language:t):u}setLanguage(u){let t=this._parseLanguage(u);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(let o of this._controls)o._setLanguage&&o._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(u){return this.style&&u!==this._worldview?(this._worldview=u,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(u){return this._lazyInitEmptyStyle(),u?typeof u=="string"&&(u={name:u}):u=null,this._useExplicitProjection=!!u,this._prioritizeAndUpdateProjection(u,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;let u=this.transform,t=u.projection.name,o;t==="globe"&&u.zoom>=i.cx?(u.setMercatorFromTransition(),o=!0):t==="mercator"&&u.zoom<i.cx&&(u.setProjection({name:"globe"}),o=!0),o&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(u,t){return this._updateProjection(u||t||{name:"mercator"})}_updateProjection(u){let t;return t=u.name==="globe"&&this.transform.zoom>=i.cx?this.transform.setMercatorFromTransition():this.transform.setProjection(u),this.style.applyProjectionUpdate(),t&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(u,t){return this.transform.locationPoint3D(i.cd.convert(u),t)}unproject(u,t){return this.transform.pointLocation3D(i.P.convert(u),t)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(u,t,o){let h=m=>{let _=[];if(Array.isArray(t)){let v=t.filter(E=>this.getLayer(E));_=v.length?this.queryRenderedFeatures(m,{layers:v}):[]}else _=this.queryRenderedFeatures(m,{target:t});return _};if(u==="mouseenter"||u==="mouseover"){let m=!1;return{listener:o,targets:t,delegates:{mousemove:v=>{let E=h(v.point);E.length?m||(m=!0,o.call(this,new lr(u,this,v.originalEvent,{features:E}))):m=!1},mouseout:()=>{m=!1}}}}if(u==="mouseleave"||u==="mouseout"){let m=!1;return{listener:o,targets:t,delegates:{mousemove:E=>{h(E.point).length?m=!0:m&&(m=!1,o.call(this,new lr(u,this,E.originalEvent)))},mouseout:E=>{m&&(m=!1,o.call(this,new lr(u,this,E.originalEvent)))}}}}{let m=_=>{let v=h(_.point);v.length&&(_.features=v,o.call(this,_),delete _.features)};return{listener:o,targets:t,delegates:{[u]:m}}}}on(u,t,o){if(typeof t=="function"||o===void 0)return super.on(u,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;let h=this._createDelegatedListener(u,t,o);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[u]=this._delegatedListeners[u]||[],this._delegatedListeners[u].push(h);for(let m in h.delegates)this.on(m,h.delegates[m]);return this}once(u,t,o){if(typeof t=="function"||o===void 0)return super.once(u,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;let h=this._createDelegatedListener(u,t,o);for(let m in h.delegates)this.once(m,h.delegates[m]);return this}off(u,t,o){if(typeof t=="function"||o===void 0)return super.off(u,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;let h=this._delegatedListeners?this._delegatedListeners[u]:void 0;return h&&(m=>{for(let _=0;_<m.length;_++){let v=m[_];if(v.listener===o&&uh(v.targets,t)){for(let E in v.delegates)this.off(E,v.delegates[E]);return m.splice(_,1),this}}})(h),this}queryRenderedFeatures(u,t){if(!this.style)return[];if(u===void 0||u instanceof i.P||Array.isArray(u)||t!==void 0||(t=u,u=void 0),u=u||[[0,0],[this.transform.width,this.transform.height]],!t){let _=this.style.queryRenderedFeatures(u,void 0,this.transform),v=this.style.queryRenderedFeatureset(u,void 0,this.transform);return _.concat(v)}let o=!0;if(t.target&&(o=this._isTargetValid(t.target),o&&!t.layers))return this.style.queryRenderedFeatureset(u,t,this.transform);let h=!0;if(t.layers&&Array.isArray(t.layers)){for(let _ of t.layers)if(!this._isValidId(_)){h=!1;break}if(h&&!t.target)return this.style.queryRenderedFeatures(u,t,this.transform)}let m=[];return h&&(m=m.concat(this.style.queryRenderedFeatures(u,t,this.transform))),o&&(m=m.concat(this.style.queryRenderedFeatureset(u,t,this.transform))),m}querySourceFeatures(u,t){return!u||typeof u=="string"&&!this._isValidId(u)?[]:this.style.querySourceFeatures(u,t)}isPointOnSurface(u){let{name:t}=this.transform.projection;return t!=="globe"&&t!=="mercator"&&i.w(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(i.P.convert(u))}addInteraction(u,t){return this._interactions.add(u,t),this}removeInteraction(u){return this._interactions.remove(u),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(u){return this._cooperativeGestures=u,this}setStyle(u,t){return t=i.h({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t),this.style&&u&&t.diff!==!1&&t.localFontFamily===this._localFontFamily&&t.localIdeographFontFamily===this._localIdeographFontFamily&&!t.config?(this.style._diffStyle(u,(o,h)=>{if(o){let m=typeof o=="string"?o:o instanceof Error?o.message:o.error;i.w(`Unable to perform style diff: ${m}. Rebuilding the style from scratch.`),this._updateStyle(u,t)}else h&&this._update(!0)},()=>this._postStyleLoadEvent()),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(u,t))}_getUIString(u){let t=this._locale[u];if(t==null)throw new Error(`Missing UI string '${u}'`);return t}_updateStyle(u,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),u){let o=i.h({},t);t&&t.config&&(o.initialConfig=t.config,delete o.config),this.style=new Tr(this,o).load(u),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Tr(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(i.w("There is no style added to the map."),!1)}_isValidId(u){return u==null?(this.fire(new i.z(new Error("IDs can't be empty."))),!1):!i.d8(u)||(this.fire(new i.z(new Error(`IDs can't contain special symbols: "${u}".`))),!1)}_isTargetValid(u){return"featuresetId"in u?this._isValidId("importId"in u?u.importId:u.featuresetId):"layerId"in u&&this._isValidId(u.layerId)}_areTargetsValid(u){if(Array.isArray(u)){for(let t of u)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(u)}addSource(u,t){return this._isValidId(u)?(this._lazyInitEmptyStyle(),this.style.addSource(u,t),this._update(!0)):this}isSourceLoaded(u){return!!this._isValidId(u)&&!!this.style&&this.style._isSourceCacheLoaded(u)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(u,t,o){this._lazyInitEmptyStyle(),this.style.addSourceType(u,t,o)}removeSource(u){return this._isValidId(u)?(this.style.removeSource(u),this._updateTerrain(),this._update(!0)):this}getSource(u){return this._isValidId(u)?this.style.getOwnSource(u):null}addImage(u,t,{pixelRatio:o=1,sdf:h=!1,stretchX:m,stretchY:_,content:v}={}){this._lazyInitEmptyStyle();let E=i.I.from(u);if(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap){let{width:T,height:C,data:M}=i.q.getImageData(t);this.style.addImage(E,{data:new i.r({width:T,height:C},M),pixelRatio:o,stretchX:m,stretchY:_,content:v,sdf:h,version:0,usvg:!1})}else if(t.width===void 0||t.height===void 0)this.fire(new i.z(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{let{width:T,height:C}=t,M=t;this.style.addImage(E,{data:new i.r({width:T,height:C},new Uint8Array(M.data)),pixelRatio:o,stretchX:m,stretchY:_,content:v,sdf:h,usvg:!1,version:0,userImage:M}),M.onAdd&&M.onAdd(this,u)}}updateImage(u,t){this._lazyInitEmptyStyle();let o=i.I.from(u),h=this.style.getImage(o);if(!h)return void this.fire(new i.z(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));let m=t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap?i.q.getImageData(t):t,{width:_,height:v,data:E}=m;if(_===void 0||v===void 0)return void this.fire(new i.z(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(_!==(h.usvg?h.icon.usvg_tree.width:h.data.width)||v!==(h.usvg?h.icon.usvg_tree.height:h.data.height))return void this.fire(new i.z(new Error(`The width and height of the updated image (${_}, ${v})
                must be that same as the previous version of the image
                (${h.data.width}, ${h.data.height})`)));let T=!(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap),C=!1;h.usvg?(h.data=new i.r({width:_,height:v},new Uint8Array(E)),h.usvg=!1,h.icon=void 0,C=!0):h.data.replace(E,T),this.style.updateImage(o,h,C)}hasImage(u){return u?!!this.style&&!!this.style.getImage(i.I.from(u)):(this.fire(new i.z(new Error("Missing required image id"))),!1)}removeImage(u){this.style.removeImage(i.I.from(u))}loadImage(u,t){i.o(this._requestManager.transformRequest(u,i.R.Image),(o,h)=>{t(o,h instanceof HTMLImageElement?i.q.getImageData(h):h)})}listImages(){return this.style.listImages().map(u=>u.name)}addModel(u,t){this._lazyInitEmptyStyle(),this.style.addModel(u,t)}hasModel(u){return u?this.style.hasModel(u):(this.fire(new i.z(new Error("Missing required model id"))),!1)}removeModel(u){this.style.removeModel(u)}listModels(){return this.style.listModels()}addLayer(u,t){return this._isValidId(u.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(u,t),this._update(!0)):this}getSlot(u){let t=this.getLayer(u);return t&&t.slot||null}setSlot(u,t){return this.style.setSlot(u,t),this.style.mergeLayers(),this._update(!0)}addImport(u,t){return this.style.addImport(u,t).catch(o=>this.fire(new i.z(new Error("Failed to add import",o)))),this}updateImport(u,t){return typeof t!="string"&&t.id!==u?(this.removeImport(u),this.addImport(t)):(this.style.updateImport(u,t),this._update(!0))}removeImport(u){return this.style.removeImport(u),this}moveImport(u,t){return this.style.moveImport(u,t),this._update(!0)}moveLayer(u,t){return this._isValidId(u)?(this.style.moveLayer(u,t),this._update(!0)):this}removeLayer(u){return this._isValidId(u)?(this.style.removeLayer(u),this._update(!0)):this}getLayer(u){if(!this._isValidId(u))return null;let t=this.style.getOwnLayer(u);return t?t.type==="custom"?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(u,t,o){return this._isValidId(u)?(this.style.setLayerZoomRange(u,t,o),this._update(!0)):this}setFilter(u,t,o={}){return this._isValidId(u)?(this.style.setFilter(u,t,o),this._update(!0)):this}getFilter(u){return this._isValidId(u)?this.style.getFilter(u):null}setPaintProperty(u,t,o,h={}){return this._isValidId(u)?(this.style.setPaintProperty(u,t,o,h),this._update(!0)):this}getPaintProperty(u,t){return this._isValidId(u)?this.style.getPaintProperty(u,t):null}setLayoutProperty(u,t,o,h={}){return this._isValidId(u)?(this.style.setLayoutProperty(u,t,o,h),this._update(!0)):this}getLayoutProperty(u,t){return this._isValidId(u)?this.style.getLayoutProperty(u,t):null}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(u){return this.style.setGlyphsUrl(u),this._update(!0)}getSchema(u){return this.style.getSchema(u)}setSchema(u,t){return this.style.setSchema(u,t),this._update(!0)}getConfig(u){return this.style.getConfig(u)}setConfig(u,t){return this.style.setConfig(u,t),this._update(!0)}getConfigProperty(u,t){return this.style.getConfigProperty(u,t)}setConfigProperty(u,t,o){return this.style.setConfigProperty(u,t,o),this._update(!0)}getFeaturesetDescriptors(u){return this.style.getFeaturesetDescriptors(u)}setLights(u){if(this._lazyInitEmptyStyle(),u&&u.length===1&&u[0].type==="flat"){let t=u[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(u),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){let u=this.style.getLights()||[];return u.length===0&&u.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),u}setLight(u,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:u}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(u){return this._lazyInitEmptyStyle(),!u&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(u),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(u){return this._lazyInitEmptyStyle(),this.style.setFog(u),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(u){return this._lazyInitEmptyStyle(),this.style.setSnow(u),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(u){return this._lazyInitEmptyStyle(),this.style.setRain(u),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(u){return this._lazyInitEmptyStyle(),this.style.setColorTheme(u),this._update(!0)}setImportColorTheme(u,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(u,t),this._update(!0)}setCamera(u){return this.style.setCamera(u),this._triggerCameraUpdate(u)}_triggerCameraUpdate(u){return this._update(this.transform.setOrthographicProjectionAtLowPitch(u["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(u){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(i.cd.convert(u),this.transform):0}setFeatureState(u,t){return u.source&&!this._isValidId(u.source)?this:(this.style.setFeatureState(u,t),this._update())}removeFeatureState(u,t){return u.source&&!this._isValidId(u.source)?this:(this.style.removeFeatureState(u,t),this._update())}getFeatureState(u){return u.source&&!this._isValidId(u.source)?null:this.style.getFeatureState(u)}_updateContainerDimensions(){if(!this._container)return;let u=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300,o,h,m,_=this._container;for(;_&&(!h||!m);){let v=window.getComputedStyle(_).transform;v&&v!=="none"&&(o=v.match(/matrix.*\((.+)\)/)[1].split(", "),o[0]&&o[0]!=="0"&&o[0]!=="1"&&(h=o[0]),o[3]&&o[3]!=="0"&&o[3]!=="1"&&(m=o[3])),_=_.parentElement}this._containerWidth=h?Math.abs(u/h):u,this._containerHeight=m?Math.abs(t/m):t}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&i.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){let u=this._container;u.classList.add("mapboxgl-map"),(this._missingCSSCanary=Se("div","mapboxgl-canary",u)).style.visibility="hidden",this._detectMissingCSS();let t=this._canvasContainer=Se("div","mapboxgl-canvas-container",u);this._canvas=Se("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);let o=this._controlContainer=Se("div","mapboxgl-control-container",u),h=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(m=>{h[m]=Se("div",`mapboxgl-ctrl-${m}`,o)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(u,t){let o=i.q.devicePixelRatio||1;this._canvas.width=o*Math.ceil(u),this._canvas.height=o*Math.ceil(t),this._canvas.style.width=`${u}px`,this._canvas.style.height=`${t}px`}_addMarker(u){this._markers.push(u)}_removeMarker(u){let t=this._markers.indexOf(u);t!==-1&&this._markers.splice(t,1)}_addPopup(u){this._popups.push(u)}_removePopup(u){let t=this._popups.indexOf(u);t!==-1&&this._popups.splice(t,1)}_setupPainter(){let u=i.h({},st.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",u);t?(Wo(t,!0),this.painter=new Dc(t,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp,this._worldview),this.on("data",o=>{o.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),i.l.testSupport(t)):this.fire(new i.z(new Error("Failed to initialize WebGL")))}_contextLost(u){u.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new i.A("webglcontextlost",{originalEvent:u}))}_contextRestored(u){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new i.A("webglcontextrestored",{originalEvent:u}))}_onMapScroll(u){if(u.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(u){return this.style?(this._styleDirty=this._styleDirty||u,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(u){return this._update(),this._renderTaskQueue.add(u)}_cancelRenderFrame(u){this._renderTaskQueue.remove(u)}_requestDomTask(u){!this.loaded()||this.loaded()&&!this.isMoving()?u():this._domRenderTaskQueue.add(u)}_render(u){let t;this.fire(new i.A("renderstart")),++this._frameId;let o=this.painter.context.extTimerQuery,h=i.q.now(),m=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=m.createQuery(),m.beginQuery(o.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(u),this._domRenderTaskQueue.run(u),this._removed)return;this._updateProjectionTransition();let _=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;let C=this.transform.zoom,M=this.transform.pitch,O=i.q.now(),P=new i.aa(C,{now:O,fadeDuration:_,pitch:M,transition:this.style.transition,worldview:this._worldview});this.style.update(P)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let v=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),v=this._updateAverageElevation(h),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):v=this._updateAverageElevation(h);let E=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,_,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),E&&(this._placementDirty=E.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:_,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new i.A("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,H.mark(N.load),this.fire(new i.A("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){let C=i.q.now()-h;m.endQuery(o.TIME_ELAPSED_EXT),setTimeout(()=>{let M=m.getQueryParameter(t,m.QUERY_RESULT)/1e6;m.deleteQuery(t),this.fire(new i.A("gpu-timing-frame",{cpuTime:C,gpuTime:M}))},50)}if(this.listens("gpu-timing-layer")){let C=this.painter.collectGpuTimers();setTimeout(()=>{let M=this.painter.queryGpuTimers(C);this.fire(new i.A("gpu-timing-layer",{layerTimes:M}))},50)}if(this.listens("gpu-timing-deferred-render")){let C=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{let M=this.painter.queryGpuTimeDeferredRender(C);this.fire(new i.A("gpu-timing-deferred-render",{gpuTime:M}))},50)}let T=this._sourcesDirty||this._styleDirty||this._placementDirty||v;if(T||this._repaint)this.triggerRepaint();else{let C=this.idle();if(C&&(v=this._updateAverageElevation(h,!0)),v)this.triggerRepaint();else if(this._triggerFrame(!1),C&&(this.fire(new i.A("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){let M=this._calculateSpeedIndex();this.fire(new i.A("speedindexcompleted",{speedIndex:M})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||T||(this._fullyLoaded=!0,H.mark(N.fullLoad),this._performanceMetricsCollection&&Po(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(u){for(let t of this._markers)u&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(let t of this._popups)!u||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(u,t=!1){let o=m=>(this.transform.averageElevation=m,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&o(0);let h=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(h||(t||u-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(u)){let m=this.transform.averageElevation,_=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(_)?_=0:this._averageElevationLastSampledAt=u;let v=Math.abs(m-_);if(v>1){if(this._isInitialLoad||h)return this._averageElevation.jumpTo(_),o(_);this._averageElevation.easeTo(_,u,300)}else if(v>1e-4)return this._averageElevation.jumpTo(_),o(_)}return!!this._averageElevation.isEasing(u)&&o(this._averageElevation.getValue(u))}_authenticate(){Zl(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,u=>{if(u&&(u.message===Pr||u.status===401)){let t=this.painter.context.gl;Wo(t,!1),this._logoControl instanceof tf&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new i.z(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),Wl(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&Bi(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){let u=this._isDragging();this.painter.updateTerrain(this.style,u)}_calculateSpeedIndex(){let u=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());let o=this.painter.context.gl,h=o.createFramebuffer();function m(_){o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,_,0);let v=new Uint8Array(o.drawingBufferWidth*o.drawingBufferHeight*4);return o.readPixels(0,0,o.drawingBufferWidth,o.drawingBufferHeight,o.RGBA,o.UNSIGNED_BYTE,v),v}return o.bindFramebuffer(o.FRAMEBUFFER,h),this._canvasPixelComparison(m(u),t.canvasCopies.map(m),t.timeStamps)}_canvasPixelComparison(u,t,o){let h=o[1]-o[0],m=u.length/4;for(let _=0;_<t.length;_++){let v=t[_],E=0;for(let T=0;T<v.length;T+=4)v[T]===u[T]&&v[T+1]===u[T+1]&&v[T+2]===u[T+2]&&v[T+3]===u[T+3]&&(E+=1);h+=(o[_+2]-o[_+1])*(1-E/m)}return h}remove(){this._hash&&this._hash.remove();for(let t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);let u=this.painter.context.gl.getExtension("WEBGL_lose_context");u&&u.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),Rs.delete(this.painter.context.gl),ai.remove(),ql.remove(),this._removed=!0,this.fire(new i.A("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(u){this._renderNextFrame=this._renderNextFrame||u,this.style&&!this._frame&&(this._frame=i.q.frame(t=>{let o=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,o&&this._render(t)}))}_preloadTiles(u){let t=this.style?this.style.getSourceCaches():[];return i.bt(t,(o,h)=>o._preloadTiles(u,h),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(u){this._trackResize&&this.resize({originalEvent:u})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(u){this._showTileBoundaries!==u&&(this._showTileBoundaries=u,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(u){this._showParseStatus!==u&&(this._showParseStatus=u,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(u){this._showTerrainWireframe!==u&&(this._showTerrainWireframe=u,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(u){this._showLayers2DWireframe!==u&&(this._showLayers2DWireframe=u,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(u){this._showLayers3DWireframe!==u&&(this._showLayers3DWireframe=u,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(u){this._speedIndexTiming!==u&&(this._speedIndexTiming=u,this._update())}get showPadding(){return!!this._showPadding}set showPadding(u){this._showPadding!==u&&(this._showPadding=u,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(u){this._showCollisionBoxes!==u&&(this._showCollisionBoxes=u,this._tp.refreshUI(),u?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(u){this._showOverdrawInspector!==u&&(this._showOverdrawInspector=u,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(u){this._repaint!==u&&(this._repaint=u,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(u){this._vertices=u,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(u){this._showTileAABBs!==u&&(this._showTileAABBs=u,this._tp.refreshUI(),u&&this._update())}_setCacheLimits(u,t){i.eJ(u,t)}get version(){return A}},NavigationControl:class{constructor(u={}){this.options=i.h({},By,u),this._container=Se("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(i.aV(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",t=>{this._map&&this._map.zoomIn({},{originalEvent:t})}),Se("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",t=>{this._map&&this._map.zoomOut({},{originalEvent:t})}),Se("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(i.aV(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",t=>{let o=this._map;o&&(this.options.visualizePitch?o.resetNorthPitch({},{originalEvent:t}):o.resetNorth({},{originalEvent:t}))}),this._compassIcon=Se("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){let u=this._map;if(!u)return;let t=u.getZoom(),o=t===u.getMaxZoom(),h=t===u.getMinZoom();this._zoomInButton.disabled=o,this._zoomOutButton.disabled=h,this._zoomInButton.setAttribute("aria-disabled",o.toString()),this._zoomOutButton.setAttribute("aria-disabled",h.toString())}_rotateCompassArrow(){let u=this._map;if(!u)return;let t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(u.transform.pitch*(Math.PI/180)),.5)}) rotateX(${u.transform.pitch}deg) rotateZ(${u.transform.angle*(180/Math.PI)}deg)`:`rotate(${u.transform.angle*(180/Math.PI)}deg)`;u._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=t)})}onAdd(u){return this._map=u,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),u.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&u.on("pitch",this._rotateCompassArrow),u.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new u1(u,this._compass,this.options.visualizePitch)),this._container}onRemove(){let u=this._map;u&&(this._container.remove(),this.options.showZoom&&u.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&u.off("pitch",this._rotateCompassArrow),u.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(u,t){let o=Se("button",u,this._container);return o.type="button",o.addEventListener("click",t),o}_setButtonTitle(u,t){if(!this._map)return;let o=this._map._getUIString(`NavigationControl.${t}`);u.setAttribute("aria-label",o),u.firstElementChild&&u.firstElementChild.setAttribute("title",o)}},GeolocateControl:class extends i.E{constructor(u={}){super();let t=navigator.geolocation;this.options=i.h({geolocation:t},Fm,u),i.aV(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Ma(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(u){return this._map=u,this._container=Se("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(u){let t=(o=!!this.options.geolocation)=>{this._supportsGeolocation=o,u(o)};this._supportsGeolocation!==void 0?u(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(o=>t(o.state!=="denied")).catch(()=>t()):t()}_isOutOfMapMaxBounds(u){let t=this._map.getMaxBounds(),o=u.coords;return!!t&&(o.longitude<t.getWest()||o.longitude>t.getEast()||o.latitude<t.getSouth()||o.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(u){if(this._map){if(this._isOutOfMapMaxBounds(u))return this._setErrorState(),this.fire(new i.A("outofmaxbounds",u)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=u,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(u),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(u),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new i.A("geolocate",u)),this._finish()}}_updateCamera(u){let t=new i.cd(u.coords.longitude,u.coords.latitude),o=u.coords.accuracy,h=this._map.getBearing(),m=i.h({bearing:h},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(o),m,{geolocateSource:!0})}_updateMarker(u){if(u){let t=new i.cd(u.coords.longitude,u.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=u.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){let u=this._map.transform,t=i.c6(1,u._center.lat)*u.worldSize,o=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${o}px`,this._circleElement.style.height=`${o}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(u){if(this._map){if(this.options.trackUserLocation)if(u.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;let t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(u.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new i.A("error",u)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(u){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=Se("button","mapboxgl-ctrl-geolocate",this._container),Se("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",u===!1){i.w("Geolocation support is not available so the GeolocateControl will be disabled.");let t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{let t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=Se("div","mapboxgl-user-location"),this._dotElement.appendChild(Se("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(Se("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new hh({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=Se("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new hh({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new i.A("trackuserlocationend")))})}}_onDeviceOrientation(u){this._userLocationDotMarker&&(u.webkitCompassHeading?this._heading=u.webkitCompassHeading:u.absolute===!0&&(this._heading=-1*u.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return i.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new i.A("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new i.A("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new i.A("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let u;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(u={maximumAge:6e5,timeout:0},this._noTimeout=!0):(u=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,u),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){let u=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(t=>{t==="granted"&&u()}).catch(console.error):u()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Om,ScaleControl:class{constructor(u={}){this.options=i.h({},dh,u),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),i.aV(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){let u=this.options.maxWidth||100,t=this._map,o=t._containerHeight/2,h=t._containerWidth/2-u/2,m=t.unproject([h,o]),_=t.unproject([h+u,o]),v=m.distanceTo(_);if(this.options.unit==="imperial"){let E=3.2808*v;E>5280?this._setScale(u,E/5280,"mile"):this._setScale(u,E,"foot")}else this.options.unit==="nautical"?this._setScale(u,v/1852,"nautical-mile"):v>=1e3?this._setScale(u,v/1e3,"kilometer"):this._setScale(u,v,"meter")}_setScale(u,t,o){this._map._requestDomTask(()=>{let h=function(_){let v=Math.pow(10,`${Math.floor(_)}`.length-1),E=_/v;return E=E>=10?10:E>=5?5:E>=3?3:E>=2?2:E>=1?1:function(T){let C=Math.pow(10,Math.ceil(-Math.log(T)/Math.LN10));return Math.round(T*C)/C}(E),v*E}(t),m=h/t;this._container.innerHTML=this._isNumberFormatSupported&&o!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:o}).format(h):`${h}&nbsp;${Oc[o]}`,this._container.style.width=u*m+"px"})}onAdd(u){return this._map=u,this._language=u.getLanguage(),this._container=Se("div","mapboxgl-ctrl mapboxgl-ctrl-scale",u.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(u){this._language=u,this._update()}setUnit(u){this.options.unit=u,this._update()}},FullscreenControl:class{constructor(u={}){this._fullscreen=!1,u&&u.container&&(u.container instanceof HTMLElement?this._container=u.container:i.w("Full screen control 'container' must be a DOM element.")),i.aV(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(u){return this._map=u,this._container||(this._container=this._map.getContainer()),this._controlContainer=Se("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",i.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){let u=this._fullscreenButton=Se("button","mapboxgl-ctrl-fullscreen",this._controlContainer);Se("span","mapboxgl-ctrl-icon",u).setAttribute("aria-hidden","true"),u.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){let u=this._getTitle();this._fullscreenButton.setAttribute("aria-label",u),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",u)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends i.E{constructor(u){super(),this.options=i.h(Object.create(Ws),u),this._altitude=this.options.altitude,i.aV(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(u&&u.className?u.className.trim().split(/\s+/):[])}addTo(u){return this._map&&this.remove(),this._map=u,this.options.closeOnClick&&u.on("preclick",this._onClose),this.options.closeOnMove&&u.on("move",this._onClose),u.on("remove",this.remove),this._update(),u._addPopup(this),this._focusFirstElement(),this._trackPointer?(u.on("mousemove",this._onMouseEvent),u.on("mouseup",this._onMouseEvent),u._canvasContainer.classList.add("mapboxgl-track-pointer")):u.on("move",this._update),this.fire(new i.A("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);let u=this._map;return u&&(u.off("move",this._update),u.off("move",this._onClose),u.off("preclick",this._onClose),u.off("click",this._onClose),u.off("remove",this.remove),u.off("mousemove",this._onMouseEvent),u.off("mouseup",this._onMouseEvent),u.off("drag",this._onMouseEvent),u._canvasContainer&&u._canvasContainer.classList.remove("mapboxgl-track-pointer"),u._removePopup(this),this._map=void 0),this.fire(new i.A("close")),this}getLngLat(){return this._lngLat}setLngLat(u){this._lngLat=i.cd.convert(u),this._pos=null,this._trackPointer=!1,this._update();let t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(u){return this._altitude=u,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();let u=this._map;return u&&(u.off("move",this._update),u.on("mousemove",this._onMouseEvent),u.on("drag",this._onMouseEvent),u._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(u){return this.setDOMContent(document.createTextNode(u))}setHTML(u){let t=document.createDocumentFragment(),o=document.createElement("body"),h;for(o.innerHTML=u;h=o.firstChild,h;)t.appendChild(h);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(u){return this.options.maxWidth=u,this._update(),this}setDOMContent(u){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=Se("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(u),this.options.closeButton){let o=this._closeButton=Se("button","mapboxgl-popup-close-button",t);o.type="button",o.setAttribute("aria-label","Close popup"),o.innerHTML='<span aria-hidden="true">&#215;</span>',o.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(u){return this._classList.add(u),this._updateClassList(),this}removeClassName(u){return this._classList.delete(u),this._updateClassList(),this}setOffset(u){return this.options.offset=u,this._update(),this}toggleClassName(u){let t;return this._classList.delete(u)?t=!1:(this._classList.add(u),t=!0),this._updateClassList(),t}_onMouseEvent(u){this._update(u.point)}_getAnchor(u){if(this.options.anchor)return this.options.anchor;let t=this._map,o=this._container,h=this._pos;if(!t||!o||!h)return"bottom";let m=o.offsetWidth,_=o.offsetHeight,v=h.x<m/2,E=h.x>t.transform.width-m/2;if(h.y+u<_)return v?"top-left":E?"top-right":"top";if(h.y>t.transform.height-_){if(v)return"bottom-left";if(E)return"bottom-right"}return v?"left":E?"right":"bottom"}_updateClassList(){let u=this._container;if(!u)return;let t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),u.className=t.join(" ")}_update(u){let t=this._map,o=this._content;if(!t||!this._lngLat&&!this._trackPointer||!o)return;let h=this._container;if(h||(h=this._container=Se("div","mapboxgl-popup",t.getContainer()),this._tip=Se("div","mapboxgl-popup-tip",h),h.appendChild(o)),this.options.maxWidth&&h.style.maxWidth!==this.options.maxWidth&&(h.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Lc(this._lngLat,this._pos,t.transform)),!this._trackPointer||u){let m=this._pos=this._trackPointer&&u instanceof i.P?u:t.project(this._lngLat,this._altitude),_=zo(this.options.offset),v=this._anchor=this._getAnchor(_.y),E=zo(this.options.offset,v),T=m.add(E).round();t._requestDomTask(()=>{this._container&&v&&(this._container.style.transform=`${km[v]} translate(${T.x}px,${T.y}px)`)})}if(!this._marker&&t._showingGlobe()){let m=i.eK(t.transform,this._lngLat)?0:1;this._setOpacity(m)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;let u=this._container.querySelector(Qo);u&&u.focus()}_onClose(){this.remove()}_setOpacity(u){this._container&&(this._container.style.opacity=`${u}`),this._content&&(this._content.style.pointerEvents=u?"auto":"none")}},Marker:hh,Style:Tr,LngLat:i.cd,LngLatBounds:i.aG,Point:i.P,MercatorCoordinate:i.ac,FreeCameraOptions:H_,Evented:i.E,config:i.e,prewarm:i.eO,clearPrewarmedResources:i.eN,get accessToken(){return i.e.ACCESS_TOKEN},set accessToken(u){i.e.ACCESS_TOKEN=u},get baseApiUrl(){return i.e.API_URL},set baseApiUrl(u){i.e.API_URL=u},get workerCount(){return i.eX.workerCount},set workerCount(u){i.eX.workerCount=u},get maxParallelImageRequests(){return i.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(u){i.e.MAX_PARALLEL_IMAGE_REQUESTS=u},clearStorage(u){i.eW(u)},get workerUrl(){return i.eV.workerUrl},set workerUrl(u){i.eV.workerUrl=u},get workerClass(){return i.eV.workerClass},set workerClass(u){i.eV.workerClass=u},get workerParams(){return i.eV.workerParams},set workerParams(u){i.eV.workerParams=u},get dracoUrl(){return i.eU()},set dracoUrl(u){i.eT(u)},get meshoptUrl(){return i.eS()},set meshoptUrl(u){i.eR(u)},setNow:i.q.setNow,restoreNow:i.q.restoreNow}});var w=d;return w})});var Rw;function zv(){return Rw}function ja(a){let c=Rw;return Rw=a,c}var lA=Symbol("NotFound");function Tf(a){return a===lA||a?.name==="\u0275NotFound"}function Hv(a,c){return Object.is(a,c)}var fo=null,Bv=!1,Pw=1,qN=null,Qr=Symbol("SIGNAL");function Nn(a){let c=fo;return fo=a,c}function $v(){return fo}var qc={version:0,lastCleanEpoch:0,dirty:!1,producers:void 0,producersTail:void 0,consumers:void 0,consumersTail:void 0,recomputing:!1,consumerAllowSignalWrites:!1,consumerIsAlwaysLive:!1,kind:"unknown",producerMustRecompute:()=>!1,producerRecomputeValue:()=>{},consumerMarkedDirty:()=>{},consumerOnSignalRead:()=>{}};function If(a){if(Bv)throw new Error("");if(fo===null)return;fo.consumerOnSignalRead(a);let c=fo.producersTail;if(c!==void 0&&c.producer===a)return;let d,g=fo.recomputing;if(g&&(d=c!==void 0?c.nextProducer:fo.producers,d!==void 0&&d.producer===a)){fo.producersTail=d,d.lastReadVersion=a.version;return}let w=a.consumersTail;if(w!==void 0&&w.consumer===fo&&(!g||ZN(w,fo)))return;let i=Cf(fo),A={producer:a,consumer:fo,nextProducer:d,prevConsumer:w,lastReadVersion:a.version,nextConsumer:void 0};fo.producersTail=A,c!==void 0?c.nextProducer=A:fo.producers=A,i&&uA(a,A)}function cA(){Pw++}function Gv(a){if(!(Cf(a)&&!a.dirty)&&!(!a.dirty&&a.lastCleanEpoch===Pw)){if(!a.producerMustRecompute(a)&&!Sf(a)){Uv(a);return}a.producerRecomputeValue(a),Uv(a)}}function Lw(a){if(a.consumers===void 0)return;let c=Bv;Bv=!0;try{for(let d=a.consumers;d!==void 0;d=d.nextConsumer){let g=d.consumer;g.dirty||WN(g)}}finally{Bv=c}}function Ow(){return fo?.consumerAllowSignalWrites!==!1}function WN(a){a.dirty=!0,Lw(a),a.consumerMarkedDirty?.(a)}function Uv(a){a.dirty=!1,a.lastCleanEpoch=Pw}function Wc(a){return a&&(a.producersTail=void 0,a.recomputing=!0),Nn(a)}function Th(a,c){if(Nn(c),!a)return;a.recomputing=!1;let d=a.producersTail,g=d!==void 0?d.nextProducer:a.producers;if(g!==void 0){if(Cf(a))do g=kw(g);while(g!==void 0);d!==void 0?d.nextProducer=void 0:a.producers=void 0}}function Sf(a){for(let c=a.producers;c!==void 0;c=c.nextProducer){let d=c.producer,g=c.lastReadVersion;if(g!==d.version||(Gv(d),g!==d.version))return!0}return!1}function Df(a){if(Cf(a)){let c=a.producers;for(;c!==void 0;)c=kw(c)}a.producers=void 0,a.producersTail=void 0,a.consumers=void 0,a.consumersTail=void 0}function uA(a,c){let d=a.consumersTail,g=Cf(a);if(d!==void 0?(c.nextConsumer=d.nextConsumer,d.nextConsumer=c):(c.nextConsumer=void 0,a.consumers=c),c.prevConsumer=d,a.consumersTail=c,!g)for(let w=a.producers;w!==void 0;w=w.nextProducer)uA(w.producer,w)}function kw(a){let c=a.producer,d=a.nextProducer,g=a.nextConsumer,w=a.prevConsumer;if(a.nextConsumer=void 0,a.prevConsumer=void 0,g!==void 0?g.prevConsumer=w:c.consumersTail=w,w!==void 0)w.nextConsumer=g;else if(c.consumers=g,!Cf(c)){let i=c.producers;for(;i!==void 0;)i=kw(i)}return d}function Cf(a){return a.consumerIsAlwaysLive||a.consumers!==void 0}function qv(a){qN?.(a)}function ZN(a,c){let d=c.producersTail;if(d!==void 0){let g=c.producers;do{if(g===a)return!0;if(g===d)break;g=g.nextProducer}while(g!==void 0)}return!1}function bg(a,c){let d=Object.create(XN);d.computation=a,c!==void 0&&(d.equal=c);let g=()=>{if(Gv(d),If(d),d.value===xg)throw d.error;return d.value};return g[Qr]=d,qv(d),g}var Vv=Symbol("UNSET"),jv=Symbol("COMPUTING"),xg=Symbol("ERRORED"),XN=Oi(Wt({},qc),{value:Vv,dirty:!0,error:null,equal:Hv,kind:"computed",producerMustRecompute(a){return a.value===Vv||a.value===jv},producerRecomputeValue(a){if(a.value===jv)throw new Error("");let c=a.value;a.value=jv;let d=Wc(a),g,w=!1;try{g=a.computation(),Nn(null),w=c!==Vv&&c!==xg&&g!==xg&&a.equal(c,g)}catch(i){g=xg,a.error=i}finally{Th(a,d)}if(w){a.value=c;return}a.value=g,a.version++}});function YN(){throw new Error}var hA=YN;function dA(a){hA(a)}function Fw(a){hA=a}var KN=null;function Nw(a,c){let d=Object.create(Wv);d.value=a,c!==void 0&&(d.equal=c);let g=()=>fA(d);return g[Qr]=d,qv(d),[g,A=>Mf(d,A),A=>zw(d,A)]}function fA(a){return If(a),a.value}function Mf(a,c){Ow()||dA(a),a.equal(a.value,c)||(a.value=c,JN(a))}function zw(a,c){Ow()||dA(a),Mf(a,c(a.value))}var Wv=Oi(Wt({},qc),{equal:Hv,value:void 0,kind:"signal"});function JN(a){a.version++,cA(),Lw(a),KN?.(a)}function Un(a){return typeof a=="function"}function Af(a){let d=a(g=>{Error.call(g),g.stack=new Error().stack});return d.prototype=Object.create(Error.prototype),d.prototype.constructor=d,d}var Zv=Af(a=>function(d){a(this),this.message=d?`${d.length} errors occurred during unsubscription:
${d.map((g,w)=>`${w+1}) ${g.toString()}`).join(`
  `)}`:"",this.name="UnsubscriptionError",this.errors=d});function wg(a,c){if(a){let d=a.indexOf(c);0<=d&&a.splice(d,1)}}var _r=class a{constructor(c){this.initialTeardown=c,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let c;if(!this.closed){this.closed=!0;let{_parentage:d}=this;if(d)if(this._parentage=null,Array.isArray(d))for(let i of d)i.remove(this);else d.remove(this);let{initialTeardown:g}=this;if(Un(g))try{g()}catch(i){c=i instanceof Zv?i.errors:[i]}let{_finalizers:w}=this;if(w){this._finalizers=null;for(let i of w)try{pA(i)}catch(A){c=c??[],A instanceof Zv?c=[...c,...A.errors]:c.push(A)}}if(c)throw new Zv(c)}}add(c){var d;if(c&&c!==this)if(this.closed)pA(c);else{if(c instanceof a){if(c.closed||c._hasParent(this))return;c._addParent(this)}(this._finalizers=(d=this._finalizers)!==null&&d!==void 0?d:[]).push(c)}}_hasParent(c){let{_parentage:d}=this;return d===c||Array.isArray(d)&&d.includes(c)}_addParent(c){let{_parentage:d}=this;this._parentage=Array.isArray(d)?(d.push(c),d):d?[d,c]:c}_removeParent(c){let{_parentage:d}=this;d===c?this._parentage=null:Array.isArray(d)&&wg(d,c)}remove(c){let{_finalizers:d}=this;d&&wg(d,c),c instanceof a&&c._removeParent(this)}};_r.EMPTY=(()=>{let a=new _r;return a.closed=!0,a})();var Bw=_r.EMPTY;function Xv(a){return a instanceof _r||a&&"closed"in a&&Un(a.remove)&&Un(a.add)&&Un(a.unsubscribe)}function pA(a){Un(a)?a():a.unsubscribe()}var Js={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1};var Rf={setTimeout(a,c,...d){let{delegate:g}=Rf;return g?.setTimeout?g.setTimeout(a,c,...d):setTimeout(a,c,...d)},clearTimeout(a){let{delegate:c}=Rf;return(c?.clearTimeout||clearTimeout)(a)},delegate:void 0};function Yv(a){Rf.setTimeout(()=>{let{onUnhandledError:c}=Js;if(c)c(a);else throw a})}function Eg(){}var mA=Vw("C",void 0,void 0);function gA(a){return Vw("E",void 0,a)}function _A(a){return Vw("N",a,void 0)}function Vw(a,c,d){return{kind:a,value:c,error:d}}var Ih=null;function Pf(a){if(Js.useDeprecatedSynchronousErrorHandling){let c=!Ih;if(c&&(Ih={errorThrown:!1,error:null}),a(),c){let{errorThrown:d,error:g}=Ih;if(Ih=null,d)throw g}}else a()}function yA(a){Js.useDeprecatedSynchronousErrorHandling&&Ih&&(Ih.errorThrown=!0,Ih.error=a)}var Sh=class extends _r{constructor(c){super(),this.isStopped=!1,c?(this.destination=c,Xv(c)&&c.add(this)):this.destination=tz}static create(c,d,g){return new Lf(c,d,g)}next(c){this.isStopped?Uw(_A(c),this):this._next(c)}error(c){this.isStopped?Uw(gA(c),this):(this.isStopped=!0,this._error(c))}complete(){this.isStopped?Uw(mA,this):(this.isStopped=!0,this._complete())}unsubscribe(){this.closed||(this.isStopped=!0,super.unsubscribe(),this.destination=null)}_next(c){this.destination.next(c)}_error(c){try{this.destination.error(c)}finally{this.unsubscribe()}}_complete(){try{this.destination.complete()}finally{this.unsubscribe()}}},QN=Function.prototype.bind;function jw(a,c){return QN.call(a,c)}var Hw=class{constructor(c){this.partialObserver=c}next(c){let{partialObserver:d}=this;if(d.next)try{d.next(c)}catch(g){Kv(g)}}error(c){let{partialObserver:d}=this;if(d.error)try{d.error(c)}catch(g){Kv(g)}else Kv(c)}complete(){let{partialObserver:c}=this;if(c.complete)try{c.complete()}catch(d){Kv(d)}}},Lf=class extends Sh{constructor(c,d,g){super();let w;if(Un(c)||!c)w={next:c??void 0,error:d??void 0,complete:g??void 0};else{let i;this&&Js.useDeprecatedNextContext?(i=Object.create(c),i.unsubscribe=()=>this.unsubscribe(),w={next:c.next&&jw(c.next,i),error:c.error&&jw(c.error,i),complete:c.complete&&jw(c.complete,i)}):w=c}this.destination=new Hw(w)}};function Kv(a){Js.useDeprecatedSynchronousErrorHandling?yA(a):Yv(a)}function ez(a){throw a}function Uw(a,c){let{onStoppedNotification:d}=Js;d&&Rf.setTimeout(()=>d(a,c))}var tz={closed:!0,next:Eg,error:ez,complete:Eg};var Of=typeof Symbol=="function"&&Symbol.observable||"@@observable";function is(a){return a}function $w(...a){return Gw(a)}function Gw(a){return a.length===0?is:a.length===1?a[0]:function(d){return a.reduce((g,w)=>w(g),d)}}var Ai=(()=>{class a{constructor(d){d&&(this._subscribe=d)}lift(d){let g=new a;return g.source=this,g.operator=d,g}subscribe(d,g,w){let i=iz(d)?d:new Lf(d,g,w);return Pf(()=>{let{operator:A,source:N}=this;i.add(A?A.call(i,N):N?this._subscribe(i):this._trySubscribe(i))}),i}_trySubscribe(d){try{return this._subscribe(d)}catch(g){d.error(g)}}forEach(d,g){return g=vA(g),new g((w,i)=>{let A=new Lf({next:N=>{try{d(N)}catch(H){i(H),A.unsubscribe()}},error:i,complete:w});this.subscribe(A)})}_subscribe(d){var g;return(g=this.source)===null||g===void 0?void 0:g.subscribe(d)}[Of](){return this}pipe(...d){return Gw(d)(this)}toPromise(d){return d=vA(d),new d((g,w)=>{let i;this.subscribe(A=>i=A,A=>w(A),()=>g(i))})}}return a.create=c=>new a(c),a})();function vA(a){var c;return(c=a??Js.Promise)!==null&&c!==void 0?c:Promise}function nz(a){return a&&Un(a.next)&&Un(a.error)&&Un(a.complete)}function iz(a){return a&&a instanceof Sh||nz(a)&&Xv(a)}function qw(a){return Un(a?.lift)}function Ii(a){return c=>{if(qw(c))return c.lift(function(d){try{return a(d,this)}catch(g){this.error(g)}});throw new TypeError("Unable to lift unknown Observable type")}}function Si(a,c,d,g,w){return new Ww(a,c,d,g,w)}var Ww=class extends Sh{constructor(c,d,g,w,i,A){super(c),this.onFinalize=i,this.shouldUnsubscribe=A,this._next=d?function(N){try{d(N)}catch(H){c.error(H)}}:super._next,this._error=w?function(N){try{w(N)}catch(H){c.error(H)}finally{this.unsubscribe()}}:super._error,this._complete=g?function(){try{g()}catch(N){c.error(N)}finally{this.unsubscribe()}}:super._complete}unsubscribe(){var c;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){let{closed:d}=this;super.unsubscribe(),!d&&((c=this.onFinalize)===null||c===void 0||c.call(this))}}};function kf(){return Ii((a,c)=>{let d=null;a._refCount++;let g=Si(c,void 0,void 0,void 0,()=>{if(!a||a._refCount<=0||0<--a._refCount){d=null;return}let w=a._connection,i=d;d=null,w&&(!i||w===i)&&w.unsubscribe(),c.unsubscribe()});a.subscribe(g),g.closed||(d=a.connect())})}var Ff=class extends Ai{constructor(c,d){super(),this.source=c,this.subjectFactory=d,this._subject=null,this._refCount=0,this._connection=null,qw(c)&&(this.lift=c.lift)}_subscribe(c){return this.getSubject().subscribe(c)}getSubject(){let c=this._subject;return(!c||c.isStopped)&&(this._subject=this.subjectFactory()),this._subject}_teardown(){this._refCount=0;let{_connection:c}=this;this._subject=this._connection=null,c?.unsubscribe()}connect(){let c=this._connection;if(!c){c=this._connection=new _r;let d=this.getSubject();c.add(this.source.subscribe(Si(d,void 0,()=>{this._teardown(),d.complete()},g=>{this._teardown(),d.error(g)},()=>this._teardown()))),c.closed&&(this._connection=null,c=_r.EMPTY)}return c}refCount(){return kf()(this)}};var xA=Af(a=>function(){a(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"});var Dr=(()=>{class a extends Ai{constructor(){super(),this.closed=!1,this.currentObservers=null,this.observers=[],this.isStopped=!1,this.hasError=!1,this.thrownError=null}lift(d){let g=new Jv(this,this);return g.operator=d,g}_throwIfClosed(){if(this.closed)throw new xA}next(d){Pf(()=>{if(this._throwIfClosed(),!this.isStopped){this.currentObservers||(this.currentObservers=Array.from(this.observers));for(let g of this.currentObservers)g.next(d)}})}error(d){Pf(()=>{if(this._throwIfClosed(),!this.isStopped){this.hasError=this.isStopped=!0,this.thrownError=d;let{observers:g}=this;for(;g.length;)g.shift().error(d)}})}complete(){Pf(()=>{if(this._throwIfClosed(),!this.isStopped){this.isStopped=!0;let{observers:d}=this;for(;d.length;)d.shift().complete()}})}unsubscribe(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null}get observed(){var d;return((d=this.observers)===null||d===void 0?void 0:d.length)>0}_trySubscribe(d){return this._throwIfClosed(),super._trySubscribe(d)}_subscribe(d){return this._throwIfClosed(),this._checkFinalizedStatuses(d),this._innerSubscribe(d)}_innerSubscribe(d){let{hasError:g,isStopped:w,observers:i}=this;return g||w?Bw:(this.currentObservers=null,i.push(d),new _r(()=>{this.currentObservers=null,wg(i,d)}))}_checkFinalizedStatuses(d){let{hasError:g,thrownError:w,isStopped:i}=this;g?d.error(w):i&&d.complete()}asObservable(){let d=new Ai;return d.source=this,d}}return a.create=(c,d)=>new Jv(c,d),a})(),Jv=class extends Dr{constructor(c,d){super(),this.destination=c,this.source=d}next(c){var d,g;(g=(d=this.destination)===null||d===void 0?void 0:d.next)===null||g===void 0||g.call(d,c)}error(c){var d,g;(g=(d=this.destination)===null||d===void 0?void 0:d.error)===null||g===void 0||g.call(d,c)}complete(){var c,d;(d=(c=this.destination)===null||c===void 0?void 0:c.complete)===null||d===void 0||d.call(c)}_subscribe(c){var d,g;return(g=(d=this.source)===null||d===void 0?void 0:d.subscribe(c))!==null&&g!==void 0?g:Bw}};var eo=class extends Dr{constructor(c){super(),this._value=c}get value(){return this.getValue()}_subscribe(c){let d=super._subscribe(c);return!d.closed&&c.next(this._value),d}getValue(){let{hasError:c,thrownError:d,_value:g}=this;if(c)throw d;return this._throwIfClosed(),g}next(c){super.next(this._value=c)}};var jo=new Ai(a=>a.complete());function bA(a){return a&&Un(a.schedule)}function wA(a){return a[a.length-1]}function EA(a){return Un(wA(a))?a.pop():void 0}function Zc(a){return bA(wA(a))?a.pop():void 0}function IA(a,c,d,g){function w(i){return i instanceof d?i:new d(function(A){A(i)})}return new(d||(d=Promise))(function(i,A){function N(be){try{ce(g.next(be))}catch(Pe){A(Pe)}}function H(be){try{ce(g.throw(be))}catch(Pe){A(Pe)}}function ce(be){be.done?i(be.value):w(be.value).then(N,H)}ce((g=g.apply(a,c||[])).next())})}function TA(a){var c=typeof Symbol=="function"&&Symbol.iterator,d=c&&a[c],g=0;if(d)return d.call(a);if(a&&typeof a.length=="number")return{next:function(){return a&&g>=a.length&&(a=void 0),{value:a&&a[g++],done:!a}}};throw new TypeError(c?"Object is not iterable.":"Symbol.iterator is not defined.")}function Dh(a){return this instanceof Dh?(this.v=a,this):new Dh(a)}function SA(a,c,d){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var g=d.apply(a,c||[]),w,i=[];return w=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),N("next"),N("throw"),N("return",A),w[Symbol.asyncIterator]=function(){return this},w;function A(Se){return function(It){return Promise.resolve(It).then(Se,Pe)}}function N(Se,It){g[Se]&&(w[Se]=function(Lt){return new Promise(function(hn,sn){i.push([Se,Lt,hn,sn])>1||H(Se,Lt)})},It&&(w[Se]=It(w[Se])))}function H(Se,It){try{ce(g[Se](It))}catch(Lt){st(i[0][3],Lt)}}function ce(Se){Se.value instanceof Dh?Promise.resolve(Se.value.v).then(be,Pe):st(i[0][2],Se)}function be(Se){H("next",Se)}function Pe(Se){H("throw",Se)}function st(Se,It){Se(It),i.shift(),i.length&&H(i[0][0],i[0][1])}}function DA(a){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var c=a[Symbol.asyncIterator],d;return c?c.call(a):(a=typeof TA=="function"?TA(a):a[Symbol.iterator](),d={},g("next"),g("throw"),g("return"),d[Symbol.asyncIterator]=function(){return this},d);function g(i){d[i]=a[i]&&function(A){return new Promise(function(N,H){A=a[i](A),w(N,H,A.done,A.value)})}}function w(i,A,N,H){Promise.resolve(H).then(function(ce){i({value:ce,done:N})},A)}}var Qv=a=>a&&typeof a.length=="number"&&typeof a!="function";function e0(a){return Un(a?.then)}function t0(a){return Un(a[Of])}function n0(a){return Symbol.asyncIterator&&Un(a?.[Symbol.asyncIterator])}function i0(a){return new TypeError(`You provided ${a!==null&&typeof a=="object"?"an invalid object":`'${a}'`} where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.`)}function rz(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var r0=rz();function o0(a){return Un(a?.[r0])}function s0(a){return SA(this,arguments,function*(){let d=a.getReader();try{for(;;){let{value:g,done:w}=yield Dh(d.read());if(w)return yield Dh(void 0);yield yield Dh(g)}}finally{d.releaseLock()}})}function a0(a){return Un(a?.getReader)}function Ur(a){if(a instanceof Ai)return a;if(a!=null){if(t0(a))return oz(a);if(Qv(a))return sz(a);if(e0(a))return az(a);if(n0(a))return CA(a);if(o0(a))return lz(a);if(a0(a))return cz(a)}throw i0(a)}function oz(a){return new Ai(c=>{let d=a[Of]();if(Un(d.subscribe))return d.subscribe(c);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function sz(a){return new Ai(c=>{for(let d=0;d<a.length&&!c.closed;d++)c.next(a[d]);c.complete()})}function az(a){return new Ai(c=>{a.then(d=>{c.closed||(c.next(d),c.complete())},d=>c.error(d)).then(null,Yv)})}function lz(a){return new Ai(c=>{for(let d of a)if(c.next(d),c.closed)return;c.complete()})}function CA(a){return new Ai(c=>{uz(a,c).catch(d=>c.error(d))})}function cz(a){return CA(s0(a))}function uz(a,c){var d,g,w,i;return IA(this,void 0,void 0,function*(){try{for(d=DA(a);g=yield d.next(),!g.done;){let A=g.value;if(c.next(A),c.closed)return}}catch(A){w={error:A}}finally{try{g&&!g.done&&(i=d.return)&&(yield i.call(d))}finally{if(w)throw w.error}}c.complete()})}function Uo(a,c,d,g=0,w=!1){let i=c.schedule(function(){d(),w?a.add(this.schedule(null,g)):this.unsubscribe()},g);if(a.add(i),!w)return i}function l0(a,c=0){return Ii((d,g)=>{d.subscribe(Si(g,w=>Uo(g,a,()=>g.next(w),c),()=>Uo(g,a,()=>g.complete(),c),w=>Uo(g,a,()=>g.error(w),c)))})}function c0(a,c=0){return Ii((d,g)=>{g.add(a.schedule(()=>d.subscribe(g),c))})}function MA(a,c){return Ur(a).pipe(c0(c),l0(c))}function AA(a,c){return Ur(a).pipe(c0(c),l0(c))}function RA(a,c){return new Ai(d=>{let g=0;return c.schedule(function(){g===a.length?d.complete():(d.next(a[g++]),d.closed||this.schedule())})})}function PA(a,c){return new Ai(d=>{let g;return Uo(d,c,()=>{g=a[r0](),Uo(d,c,()=>{let w,i;try{({value:w,done:i}=g.next())}catch(A){d.error(A);return}i?d.complete():d.next(w)},0,!0)}),()=>Un(g?.return)&&g.return()})}function u0(a,c){if(!a)throw new Error("Iterable cannot be null");return new Ai(d=>{Uo(d,c,()=>{let g=a[Symbol.asyncIterator]();Uo(d,c,()=>{g.next().then(w=>{w.done?d.complete():d.next(w.value)})},0,!0)})})}function LA(a,c){return u0(s0(a),c)}function OA(a,c){if(a!=null){if(t0(a))return MA(a,c);if(Qv(a))return RA(a,c);if(e0(a))return AA(a,c);if(n0(a))return u0(a,c);if(o0(a))return PA(a,c);if(a0(a))return LA(a,c)}throw i0(a)}function yr(a,c){return c?OA(a,c):Ur(a)}function Vn(...a){let c=Zc(a);return yr(a,c)}function Nf(a,c){let d=Un(a)?a:()=>a,g=w=>w.error(d());return new Ai(c?w=>c.schedule(g,0,w):g)}function Zw(a){return!!a&&(a instanceof Ai||Un(a.lift)&&Un(a.subscribe))}var Al=Af(a=>function(){a(this),this.name="EmptyError",this.message="no elements in sequence"});function fi(a,c){return Ii((d,g)=>{let w=0;d.subscribe(Si(g,i=>{g.next(a.call(c,i,w++))}))})}var{isArray:hz}=Array;function dz(a,c){return hz(c)?a(...c):a(c)}function kA(a){return fi(c=>dz(a,c))}var{isArray:fz}=Array,{getPrototypeOf:pz,prototype:mz,keys:gz}=Object;function FA(a){if(a.length===1){let c=a[0];if(fz(c))return{args:c,keys:null};if(_z(c)){let d=gz(c);return{args:d.map(g=>c[g]),keys:d}}}return{args:a,keys:null}}function _z(a){return a&&typeof a=="object"&&pz(a)===mz}function NA(a,c){return a.reduce((d,g,w)=>(d[g]=c[w],d),{})}function h0(...a){let c=Zc(a),d=EA(a),{args:g,keys:w}=FA(a);if(g.length===0)return yr([],c);let i=new Ai(yz(g,c,w?A=>NA(w,A):is));return d?i.pipe(kA(d)):i}function yz(a,c,d=is){return g=>{zA(c,()=>{let{length:w}=a,i=new Array(w),A=w,N=w;for(let H=0;H<w;H++)zA(c,()=>{let ce=yr(a[H],c),be=!1;ce.subscribe(Si(g,Pe=>{i[H]=Pe,be||(be=!0,N--),N||g.next(d(i.slice()))},()=>{--A||g.complete()}))},g)},g)}}function zA(a,c,d){a?Uo(d,a,c):c()}function BA(a,c,d,g,w,i,A,N){let H=[],ce=0,be=0,Pe=!1,st=()=>{Pe&&!H.length&&!ce&&c.complete()},Se=Lt=>ce<g?It(Lt):H.push(Lt),It=Lt=>{i&&c.next(Lt),ce++;let hn=!1;Ur(d(Lt,be++)).subscribe(Si(c,sn=>{w?.(sn),i?Se(sn):c.next(sn)},()=>{hn=!0},void 0,()=>{if(hn)try{for(ce--;H.length&&ce<g;){let sn=H.shift();A?Uo(c,A,()=>It(sn)):It(sn)}st()}catch(sn){c.error(sn)}}))};return a.subscribe(Si(c,Se,()=>{Pe=!0,st()})),()=>{N?.()}}function Cr(a,c,d=1/0){return Un(c)?Cr((g,w)=>fi((i,A)=>c(g,i,w,A))(Ur(a(g,w))),d):(typeof c=="number"&&(d=c),Ii((g,w)=>BA(g,w,a,d)))}function VA(a=1/0){return Cr(is,a)}function jA(){return VA(1)}function zf(...a){return jA()(yr(a,Zc(a)))}function Tg(a){return new Ai(c=>{Ur(a()).subscribe(c)})}function Io(a,c){return Ii((d,g)=>{let w=0;d.subscribe(Si(g,i=>a.call(c,i,w++)&&g.next(i)))})}function Xc(a){return Ii((c,d)=>{let g=null,w=!1,i;g=c.subscribe(Si(d,void 0,void 0,A=>{i=Ur(a(A,Xc(a)(c))),g?(g.unsubscribe(),g=null,i.subscribe(d)):w=!0})),w&&(g.unsubscribe(),g=null,i.subscribe(d))})}function UA(a,c,d,g,w){return(i,A)=>{let N=d,H=c,ce=0;i.subscribe(Si(A,be=>{let Pe=ce++;H=N?a(H,be,Pe):(N=!0,be),g&&A.next(H)},w&&(()=>{N&&A.next(H),A.complete()})))}}function Bf(a,c){return Un(c)?Cr(a,c,1):Cr(a,1)}function Yc(a){return Ii((c,d)=>{let g=!1;c.subscribe(Si(d,w=>{g=!0,d.next(w)},()=>{g||d.next(a),d.complete()}))})}function Rl(a){return a<=0?()=>jo:Ii((c,d)=>{let g=0;c.subscribe(Si(d,w=>{++g<=a&&(d.next(w),a<=g&&d.complete())}))})}function d0(a=vz){return Ii((c,d)=>{let g=!1;c.subscribe(Si(d,w=>{g=!0,d.next(w)},()=>g?d.complete():d.error(a())))})}function vz(){return new Al}function Ig(a){return Ii((c,d)=>{try{c.subscribe(d)}finally{d.add(a)}})}function Pl(a,c){let d=arguments.length>=2;return g=>g.pipe(a?Io((w,i)=>a(w,i,g)):is,Rl(1),d?Yc(c):d0(()=>new Al))}function Vf(a){return a<=0?()=>jo:Ii((c,d)=>{let g=[];c.subscribe(Si(d,w=>{g.push(w),a<g.length&&g.shift()},()=>{for(let w of g)d.next(w);d.complete()},void 0,()=>{g=null}))})}function Xw(a,c){let d=arguments.length>=2;return g=>g.pipe(a?Io((w,i)=>a(w,i,g)):is,Vf(1),d?Yc(c):d0(()=>new Al))}function Yw(a,c){return Ii(UA(a,c,arguments.length>=2,!0))}function Kw(...a){let c=Zc(a);return Ii((d,g)=>{(c?zf(a,d,c):zf(a,d)).subscribe(g)})}function bs(a,c){return Ii((d,g)=>{let w=null,i=0,A=!1,N=()=>A&&!w&&g.complete();d.subscribe(Si(g,H=>{w?.unsubscribe();let ce=0,be=i++;Ur(a(H,be)).subscribe(w=Si(g,Pe=>g.next(c?c(H,Pe,be,ce++):Pe),()=>{w=null,N()}))},()=>{A=!0,N()}))})}function f0(a){return Ii((c,d)=>{Ur(a).subscribe(Si(d,()=>d.complete(),Eg)),!d.closed&&c.subscribe(d)})}function Hr(a,c,d){let g=Un(a)||c||d?{next:a,error:c,complete:d}:a;return g?Ii((w,i)=>{var A;(A=g.subscribe)===null||A===void 0||A.call(g);let N=!0;w.subscribe(Si(i,H=>{var ce;(ce=g.next)===null||ce===void 0||ce.call(g,H),i.next(H)},()=>{var H;N=!1,(H=g.complete)===null||H===void 0||H.call(g),i.complete()},H=>{var ce;N=!1,(ce=g.error)===null||ce===void 0||ce.call(g,H),i.error(H)},()=>{var H,ce;N&&((H=g.unsubscribe)===null||H===void 0||H.call(g)),(ce=g.finalize)===null||ce===void 0||ce.call(g)}))}):is}function HA(a){let c=Nn(null);try{return a()}finally{Nn(c)}}var v0="https://angular.dev/best-practices/security#preventing-cross-site-scripting-xss",Qt=class extends Error{code;constructor(c,d){super(Uf(c,d)),this.code=c}};function xz(a){return`NG0${Math.abs(a)}`}function Uf(a,c){return`${xz(a)}${c?": "+c:""}`}var kl=globalThis;function Fi(a){for(let c in a)if(a[c]===Fi)return c;throw Error("")}function Kc(a){if(typeof a=="string")return a;if(Array.isArray(a))return`[${a.map(Kc).join(", ")}]`;if(a==null)return""+a;let c=a.overriddenName||a.name;if(c)return`${c}`;let d=a.toString();if(d==null)return""+d;let g=d.indexOf(`
`);return g>=0?d.slice(0,g):d}function x0(a,c){return a?c?`${a} ${c}`:a:c||""}var bz=Fi({__forward_ref__:Fi});function b0(a){return a.__forward_ref__=b0,a.toString=function(){return Kc(this())},a}function Ho(a){return lE(a)?a():a}function lE(a){return typeof a=="function"&&a.hasOwnProperty(bz)&&a.__forward_ref__===b0}function qA(a,c){a==null&&cE(c,a,null,"!=")}function cE(a,c,d,g){throw new Error(`ASSERTION ERROR: ${a}`+(g==null?"":` [Expected=> ${d} ${g} ${c} <=Actual]`))}function Tn(a){return{token:a.token,providedIn:a.providedIn||null,factory:a.factory,value:void 0}}function Rg(a){return wz(a,w0)}function uE(a){return Rg(a)!==null}function wz(a,c){return a.hasOwnProperty(c)&&a[c]||null}function Ez(a){let c=a?.[w0]??null;return c||null}function Qw(a){return a&&a.hasOwnProperty(m0)?a[m0]:null}var w0=Fi({\u0275prov:Fi}),m0=Fi({\u0275inj:Fi}),En=class{_desc;ngMetadataName="InjectionToken";\u0275prov;constructor(c,d){this._desc=c,this.\u0275prov=void 0,typeof d=="number"?this.__NG_ELEMENT_ID__=d:d!==void 0&&(this.\u0275prov=Tn({token:this,providedIn:d.providedIn||"root",factory:d.factory}))}get multi(){return this}toString(){return`InjectionToken ${this._desc}`}};function hE(a){return a&&!!a.\u0275providers}var dE=Fi({\u0275cmp:Fi}),fE=Fi({\u0275dir:Fi}),pE=Fi({\u0275pipe:Fi}),mE=Fi({\u0275mod:Fi}),Cg=Fi({\u0275fac:Fi}),Rh=Fi({__NG_ELEMENT_ID__:Fi}),$A=Fi({__NG_ENV_ID__:Fi});function Pg(a){return typeof a=="string"?a:a==null?"":String(a)}function g0(a){return typeof a=="function"?a.name||a.toString():typeof a=="object"&&a!=null&&typeof a.type=="function"?a.type.name||a.type.toString():Pg(a)}var gE=Fi({ngErrorCode:Fi}),WA=Fi({ngErrorMessage:Fi}),Dg=Fi({ngTokenPath:Fi});function _E(a,c){return ZA("",-200,c)}function E0(a,c){throw new Qt(-201,!1)}function Tz(a,c){a[Dg]??=[];let d=a[Dg],g;typeof c=="object"&&"multi"in c&&c?.multi===!0?(qA(c.provide,"Token with multi: true should have a provide property"),g=g0(c.provide)):g=g0(c),d[0]!==g&&a[Dg].unshift(g)}function Iz(a,c){let d=a[Dg],g=a[gE],w=a[WA]||a.message;return a.message=Dz(w,g,d,c),a}function ZA(a,c,d){let g=new Qt(c,a);return g[gE]=c,g[WA]=a,d&&(g[Dg]=d),g}function Sz(a){return a[gE]}function Dz(a,c,d=[],g=null){let w="";d&&d.length>1&&(w=` Path: ${d.join(" -> ")}.`);let i=g?` Source: ${g}.`:"";return Uf(c,`${a}${i}${w}`)}var eE;function XA(){return eE}function So(a){let c=eE;return eE=a,c}function yE(a,c,d){let g=Rg(a);if(g&&g.providedIn=="root")return g.value===void 0?g.value=g.factory():g.value;if(d&8)return null;if(c!==void 0)return c;E0(a,"Injector")}var Cz={},Ch=Cz,Mz="__NG_DI_FLAG__",tE=class{injector;constructor(c){this.injector=c}retrieve(c,d){let g=Mh(d)||0;try{return this.injector.get(c,g&8?null:Ch,g)}catch(w){if(Tf(w))return w;throw w}}};function Az(a,c=0){let d=zv();if(d===void 0)throw new Qt(-203,!1);if(d===null)return yE(a,void 0,c);{let g=Rz(c),w=d.retrieve(a,g);if(Tf(w)){if(g.optional)return null;throw w}return w}}function $n(a,c=0){return(XA()||Az)(Ho(a),c)}function At(a,c){return $n(a,Mh(c))}function Mh(a){return typeof a>"u"||typeof a=="number"?a:0|(a.optional&&8)|(a.host&&1)|(a.self&&2)|(a.skipSelf&&4)}function Rz(a){return{optional:!!(a&8),host:!!(a&1),self:!!(a&2),skipSelf:!!(a&4)}}function nE(a){let c=[];for(let d=0;d<a.length;d++){let g=Ho(a[d]);if(Array.isArray(g)){if(g.length===0)throw new Qt(900,!1);let w,i=0;for(let A=0;A<g.length;A++){let N=g[A],H=Pz(N);typeof H=="number"?H===-1?w=N.token:i|=H:w=N}c.push($n(w,i))}else c.push($n(g))}return c}function Pz(a){return a[Mz]}function Jc(a,c){let d=a.hasOwnProperty(Cg);return d?a[Cg]:null}function YA(a,c,d){if(a.length!==c.length)return!1;for(let g=0;g<a.length;g++){let w=a[g],i=c[g];if(d&&(w=d(w),i=d(i)),i!==w)return!1}return!0}function KA(a){return a.flat(Number.POSITIVE_INFINITY)}function T0(a,c){a.forEach(d=>Array.isArray(d)?T0(d,c):c(d))}function vE(a,c,d){c>=a.length?a.push(d):a.splice(c,0,d)}function Lg(a,c){return c>=a.length-1?a.pop():a.splice(c,1)[0]}function JA(a,c,d,g){let w=a.length;if(w==c)a.push(d,g);else if(w===1)a.push(g,a[0]),a[0]=d;else{for(w--,a.push(a[w-1],a[w]);w>c;){let i=w-2;a[w]=a[i],w--}a[c]=d,a[c+1]=g}}function xE(a,c,d){let g=Hf(a,c);return g>=0?a[g|1]=d:(g=~g,JA(a,g,c,d)),g}function I0(a,c){let d=Hf(a,c);if(d>=0)return a[d|1]}function Hf(a,c){return Lz(a,c,1)}function Lz(a,c,d){let g=0,w=a.length>>d;for(;w!==g;){let i=g+(w-g>>1),A=a[i<<d];if(c===A)return i<<d;A>c?w=i:g=i+1}return~(w<<d)}var Ph={},Qs=[],eu=new En(""),bE=new En("",-1),wE=new En(""),Mg=class{get(c,d=Ch){if(d===Ch){let w=ZA("",-201);throw w.name="\u0275NotFound",w}return d}};function EE(a){return a[mE]||null}function tu(a){return a[dE]||null}function TE(a){return a[fE]||null}function QA(a){return a[pE]||null}function Og(a){return{\u0275providers:a}}function eR(...a){return{\u0275providers:IE(!0,a),\u0275fromNgModule:!0}}function IE(a,...c){let d=[],g=new Set,w,i=A=>{d.push(A)};return T0(c,A=>{let N=A;_0(N,i,[],g)&&(w||=[],w.push(N))}),w!==void 0&&tR(w,i),d}function tR(a,c){for(let d=0;d<a.length;d++){let{ngModule:g,providers:w}=a[d];SE(w,i=>{c(i,g)})}}function _0(a,c,d,g){if(a=Ho(a),!a)return!1;let w=null,i=Qw(a),A=!i&&tu(a);if(!i&&!A){let H=a.ngModule;if(i=Qw(H),i)w=H;else return!1}else{if(A&&!A.standalone)return!1;w=a}let N=g.has(w);if(A){if(N)return!1;if(g.add(w),A.dependencies){let H=typeof A.dependencies=="function"?A.dependencies():A.dependencies;for(let ce of H)_0(ce,c,d,g)}}else if(i){if(i.imports!=null&&!N){g.add(w);let ce;try{T0(i.imports,be=>{_0(be,c,d,g)&&(ce||=[],ce.push(be))})}finally{}ce!==void 0&&tR(ce,c)}if(!N){let ce=Jc(w)||(()=>new w);c({provide:w,useFactory:ce,deps:Qs},w),c({provide:wE,useValue:w,multi:!0},w),c({provide:eu,useValue:()=>$n(w),multi:!0},w)}let H=i.providers;if(H!=null&&!N){let ce=a;SE(H,be=>{c(be,ce)})}}else return!1;return w!==a&&a.providers!==void 0}function SE(a,c){for(let d of a)hE(d)&&(d=d.\u0275providers),Array.isArray(d)?SE(d,c):c(d)}var Oz=Fi({provide:String,useValue:Fi});function nR(a){return a!==null&&typeof a=="object"&&Oz in a}function kz(a){return!!(a&&a.useExisting)}function Fz(a){return!!(a&&a.useFactory)}function y0(a){return typeof a=="function"}var kg=new En(""),p0={},GA={},Jw;function Fg(){return Jw===void 0&&(Jw=new Mg),Jw}var $r=class{},Ah=class extends $r{parent;source;scopes;records=new Map;_ngOnDestroyHooks=new Set;_onDestroyHooks=[];get destroyed(){return this._destroyed}_destroyed=!1;injectorDefTypes;constructor(c,d,g,w){super(),this.parent=d,this.source=g,this.scopes=w,rE(c,A=>this.processProvider(A)),this.records.set(bE,jf(void 0,this)),w.has("environment")&&this.records.set($r,jf(void 0,this));let i=this.records.get(kg);i!=null&&typeof i.value=="string"&&this.scopes.add(i.value),this.injectorDefTypes=new Set(this.get(wE,Qs,{self:!0}))}retrieve(c,d){let g=Mh(d)||0;try{return this.get(c,Ch,g)}catch(w){if(Tf(w))return w;throw w}}destroy(){Sg(this),this._destroyed=!0;let c=Nn(null);try{for(let g of this._ngOnDestroyHooks)g.ngOnDestroy();let d=this._onDestroyHooks;this._onDestroyHooks=[];for(let g of d)g()}finally{this.records.clear(),this._ngOnDestroyHooks.clear(),this.injectorDefTypes.clear(),Nn(c)}}onDestroy(c){return Sg(this),this._onDestroyHooks.push(c),()=>this.removeOnDestroy(c)}runInContext(c){Sg(this);let d=ja(this),g=So(void 0),w;try{return c()}finally{ja(d),So(g)}}get(c,d=Ch,g){if(Sg(this),c.hasOwnProperty($A))return c[$A](this);let w=Mh(g),i,A=ja(this),N=So(void 0);try{if(!(w&4)){let ce=this.records.get(c);if(ce===void 0){let be=jz(c)&&Rg(c);be&&this.injectableDefInScope(be)?ce=jf(iE(c),p0):ce=null,this.records.set(c,ce)}if(ce!=null)return this.hydrate(c,ce,w)}let H=w&2?Fg():this.parent;return d=w&8&&d===Ch?null:d,H.get(c,d)}catch(H){let ce=Sz(H);throw ce===-200||ce===-201?new Qt(ce,null):H}finally{So(N),ja(A)}}resolveInjectorInitializers(){let c=Nn(null),d=ja(this),g=So(void 0),w;try{let i=this.get(eu,Qs,{self:!0});for(let A of i)A()}finally{ja(d),So(g),Nn(c)}}toString(){let c=[],d=this.records;for(let g of d.keys())c.push(Kc(g));return`R3Injector[${c.join(", ")}]`}processProvider(c){c=Ho(c);let d=y0(c)?c:Ho(c&&c.provide),g=zz(c);if(!y0(c)&&c.multi===!0){let w=this.records.get(d);w||(w=jf(void 0,p0,!0),w.factory=()=>nE(w.multi),this.records.set(d,w)),d=c,w.multi.push(c)}this.records.set(d,g)}hydrate(c,d,g){let w=Nn(null);try{if(d.value===GA)throw _E(Kc(c));return d.value===p0&&(d.value=GA,d.value=d.factory(void 0,g)),typeof d.value=="object"&&d.value&&Vz(d.value)&&this._ngOnDestroyHooks.add(d.value),d.value}finally{Nn(w)}}injectableDefInScope(c){if(!c.providedIn)return!1;let d=Ho(c.providedIn);return typeof d=="string"?d==="any"||this.scopes.has(d):this.injectorDefTypes.has(d)}removeOnDestroy(c){let d=this._onDestroyHooks.indexOf(c);d!==-1&&this._onDestroyHooks.splice(d,1)}};function iE(a){let c=Rg(a),d=c!==null?c.factory:Jc(a);if(d!==null)return d;if(a instanceof En)throw new Qt(204,!1);if(a instanceof Function)return Nz(a);throw new Qt(204,!1)}function Nz(a){if(a.length>0)throw new Qt(204,!1);let d=Ez(a);return d!==null?()=>d.factory(a):()=>new a}function zz(a){if(nR(a))return jf(void 0,a.useValue);{let c=iR(a);return jf(c,p0)}}function iR(a,c,d){let g;if(y0(a)){let w=Ho(a);return Jc(w)||iE(w)}else if(nR(a))g=()=>Ho(a.useValue);else if(Fz(a))g=()=>a.useFactory(...nE(a.deps||[]));else if(kz(a))g=(w,i)=>$n(Ho(a.useExisting),i!==void 0&&i&8?8:void 0);else{let w=Ho(a&&(a.useClass||a.provide));if(Bz(a))g=()=>new w(...nE(a.deps));else return Jc(w)||iE(w)}return g}function Sg(a){if(a.destroyed)throw new Qt(205,!1)}function jf(a,c,d=!1){return{factory:a,value:c,multi:d?[]:void 0}}function Bz(a){return!!a.deps}function Vz(a){return a!==null&&typeof a=="object"&&typeof a.ngOnDestroy=="function"}function jz(a){return typeof a=="function"||typeof a=="object"&&a.ngMetadataName==="InjectionToken"}function rE(a,c){for(let d of a)Array.isArray(d)?rE(d,c):d&&hE(d)?rE(d.\u0275providers,c):c(d)}function Do(a,c){let d;a instanceof Ah?(Sg(a),d=a):d=new tE(a);let g,w=ja(d),i=So(void 0);try{return c()}finally{ja(w),So(i)}}function rR(){return XA()!==void 0||zv()!=null}var ta=0,xn=1,Ln=2,Mr=3,ws=4,Es=5,$f=6,Gf=7,vr=8,Lh=9,Ua=10,nr=11,qf=12,DE=13,Oh=14,os=15,nu=16,kh=17,Ha=18,Ng=19,CE=20,Ll=21,S0=22,Fl=23,ss=24,D0=25,Ar=26,oR=1,ME=6,iu=7,zg=8,Fh=9,Gr=10;function $a(a){return Array.isArray(a)&&typeof a[oR]=="object"}function na(a){return Array.isArray(a)&&a[oR]===!0}function AE(a){return(a.flags&4)!==0}function ru(a){return a.componentOffset>-1}function C0(a){return(a.flags&1)===1}function Nh(a){return!!a.template}function Wf(a){return(a[Ln]&512)!==0}function zh(a){return(a[Ln]&256)===256}var RE="svg",sR="math";function Ts(a){for(;Array.isArray(a);)a=a[ta];return a}function PE(a,c){return Ts(c[a])}function ia(a,c){return Ts(c[a.index])}function Bg(a,c){return a.data[c]}function M0(a,c){return a[c]}function LE(a,c,d,g){d>=a.data.length&&(a.data[d]=null,a.blueprint[d]=null),c[d]=g}function Is(a,c){let d=c[a];return $a(d)?d:d[ta]}function A0(a){return(a[Ln]&128)===128}function aR(a){return na(a[Mr])}function ou(a,c){return c==null?null:a[c]}function OE(a){a[kh]=0}function kE(a){a[Ln]&1024||(a[Ln]|=1024,A0(a)&&Bh(a))}function lR(a,c){for(;a>0;)c=c[Oh],a--;return c}function Vg(a){return!!(a[Ln]&9216||a[ss]?.dirty)}function R0(a){a[Ua].changeDetectionScheduler?.notify(8),a[Ln]&64&&(a[Ln]|=1024),Vg(a)&&Bh(a)}function Bh(a){a[Ua].changeDetectionScheduler?.notify(0);let c=Qc(a);for(;c!==null&&!(c[Ln]&8192||(c[Ln]|=8192,!A0(c)));)c=Qc(c)}function FE(a,c){if(zh(a))throw new Qt(911,!1);a[Ll]===null&&(a[Ll]=[]),a[Ll].push(c)}function cR(a,c){if(a[Ll]===null)return;let d=a[Ll].indexOf(c);d!==-1&&a[Ll].splice(d,1)}function Qc(a){let c=a[Mr];return na(c)?c[Mr]:c}function NE(a){return a[Gf]??=[]}function zE(a){return a.cleanup??=[]}function uR(a,c,d,g){let w=NE(c);w.push(d),a.firstCreatePass&&zE(a).push(g,w.length-1)}var Yn={lFrame:SR(null),bindingsEnabled:!0,skipHydrationRootTNode:null},jg=function(a){return a[a.Off=0]="Off",a[a.Exhaustive=1]="Exhaustive",a[a.OnlyDirtyViews=2]="OnlyDirtyViews",a}(jg||{}),Uz=0,oE=!1;function hR(){return Yn.lFrame.elementDepthCount}function dR(){Yn.lFrame.elementDepthCount++}function BE(){Yn.lFrame.elementDepthCount--}function fR(){return Yn.bindingsEnabled}function pR(){return Yn.skipHydrationRootTNode!==null}function VE(a){return Yn.skipHydrationRootTNode===a}function jE(){Yn.skipHydrationRootTNode=null}function gi(){return Yn.lFrame.lView}function as(){return Yn.lFrame.tView}function Zf(a){return Yn.lFrame.contextLView=a,a[vr]}function Xf(a){return Yn.lFrame.contextLView=null,a}function po(){let a=UE();for(;a!==null&&a.type===64;)a=a.parent;return a}function UE(){return Yn.lFrame.currentTNode}function mR(){let a=Yn.lFrame,c=a.currentTNode;return a.isParent?c:c.parent}function Yf(a,c){let d=Yn.lFrame;d.currentTNode=a,d.isParent=c}function HE(){return Yn.lFrame.isParent}function gR(){Yn.lFrame.isParent=!1}function _R(){return Yn.lFrame.contextLView}function $E(a){cE("Must never be called in production mode"),Uz=a}function GE(){return oE}function Kf(a){let c=oE;return oE=a,c}function Ug(){let a=Yn.lFrame,c=a.bindingRootIndex;return c===-1&&(c=a.bindingRootIndex=a.tView.bindingStartIndex),c}function yR(a){return Yn.lFrame.bindingIndex=a}function Jf(){return Yn.lFrame.bindingIndex++}function vR(a){let c=Yn.lFrame,d=c.bindingIndex;return c.bindingIndex=c.bindingIndex+a,d}function xR(){return Yn.lFrame.inI18n}function bR(a,c){let d=Yn.lFrame;d.bindingIndex=d.bindingRootIndex=a,P0(c)}function wR(){return Yn.lFrame.currentDirectiveIndex}function P0(a){Yn.lFrame.currentDirectiveIndex=a}function ER(a){let c=Yn.lFrame.currentDirectiveIndex;return c===-1?null:a[c]}function TR(){return Yn.lFrame.currentQueryIndex}function L0(a){Yn.lFrame.currentQueryIndex=a}function Hz(a){let c=a[xn];return c.type===2?c.declTNode:c.type===1?a[Es]:null}function qE(a,c,d){if(d&4){let w=c,i=a;for(;w=w.parent,w===null&&!(d&1);)if(w=Hz(i),w===null||(i=i[Oh],w.type&10))break;if(w===null)return!1;c=w,a=i}let g=Yn.lFrame=IR();return g.currentTNode=c,g.lView=a,!0}function O0(a){let c=IR(),d=a[xn];Yn.lFrame=c,c.currentTNode=d.firstChild,c.lView=a,c.tView=d,c.contextLView=a,c.bindingIndex=d.bindingStartIndex,c.inI18n=!1}function IR(){let a=Yn.lFrame,c=a===null?null:a.child;return c===null?SR(a):c}function SR(a){let c={currentTNode:null,isParent:!0,lView:null,tView:null,selectedIndex:-1,contextLView:null,elementDepthCount:0,currentNamespace:null,currentDirectiveIndex:-1,bindingRootIndex:-1,bindingIndex:-1,currentQueryIndex:0,parent:a,child:null,inI18n:!1};return a!==null&&(a.child=c),c}function DR(){let a=Yn.lFrame;return Yn.lFrame=a.parent,a.currentTNode=null,a.lView=null,a}var WE=DR;function k0(){let a=DR();a.isParent=!0,a.tView=null,a.selectedIndex=-1,a.contextLView=null,a.elementDepthCount=0,a.currentDirectiveIndex=-1,a.currentNamespace=null,a.bindingRootIndex=-1,a.bindingIndex=-1,a.currentQueryIndex=0}function CR(a){return(Yn.lFrame.contextLView=lR(a,Yn.lFrame.contextLView))[vr]}function su(){return Yn.lFrame.selectedIndex}function au(a){Yn.lFrame.selectedIndex=a}function F0(){let a=Yn.lFrame;return Bg(a.tView,a.selectedIndex)}function N0(){Yn.lFrame.currentNamespace=RE}function z0(){$z()}function $z(){Yn.lFrame.currentNamespace=null}function MR(){return Yn.lFrame.currentNamespace}var AR=!0;function B0(){return AR}function V0(a){AR=a}function sE(a,c=null,d=null,g){let w=ZE(a,c,d,g);return w.resolveInjectorInitializers(),w}function ZE(a,c=null,d=null,g,w=new Set){let i=[d||Qs,eR(a)];return g=g||(typeof a=="object"?void 0:Kc(a)),new Ah(i,c||Fg(),g||null,w)}var rs=class a{static THROW_IF_NOT_FOUND=Ch;static NULL=new Mg;static create(c,d){if(Array.isArray(c))return sE({name:""},d,c,"");{let g=c.name??"";return sE({name:g},c.parent,c.providers,g)}}static \u0275prov=Tn({token:a,providedIn:"any",factory:()=>$n(bE)});static __NG_ELEMENT_ID__=-1},to=new En(""),ra=(()=>{class a{static __NG_ELEMENT_ID__=Gz;static __NG_ENV_ID__=d=>d}return a})(),Ag=class extends ra{_lView;constructor(c){super(),this._lView=c}get destroyed(){return zh(this._lView)}onDestroy(c){let d=this._lView;return FE(d,c),()=>cR(d,c)}};function Gz(){return new Ag(gi())}var ea=class{_console=console;handleError(c){this._console.error("ERROR",c)}},ls=new En("",{providedIn:"root",factory:()=>{let a=At($r),c;return d=>{a.destroyed&&!c?setTimeout(()=>{throw d}):(c??=a.get(ea),c.handleError(d))}}}),RR={provide:eu,useValue:()=>void At(ea),multi:!0};function dr(a,c){let[d,g,w]=Nw(a,c?.equal),i=d,A=i[Qr];return i.set=g,i.update=w,i.asReadonly=XE.bind(i),i}function XE(){let a=this[Qr];if(a.readonlyFn===void 0){let c=()=>this();c[Qr]=a,a.readonlyFn=c}return a.readonlyFn}var Ol=class{},Hg=new En("",{providedIn:"root",factory:()=>!1});var YE=new En(""),KE=new En("");var $g=(()=>{class a{view;node;constructor(d,g){this.view=d,this.node=g}static __NG_ELEMENT_ID__=qz}return a})();function qz(){return new $g(gi(),po())}var Nl=(()=>{class a{taskId=0;pendingTasks=new Set;destroyed=!1;pendingTask=new eo(!1);get hasPendingTasks(){return this.destroyed?!1:this.pendingTask.value}get hasPendingTasksObservable(){return this.destroyed?new Ai(d=>{d.next(!1),d.complete()}):this.pendingTask}add(){!this.hasPendingTasks&&!this.destroyed&&this.pendingTask.next(!0);let d=this.taskId++;return this.pendingTasks.add(d),d}has(d){return this.pendingTasks.has(d)}remove(d){this.pendingTasks.delete(d),this.pendingTasks.size===0&&this.hasPendingTasks&&this.pendingTask.next(!1)}ngOnDestroy(){this.pendingTasks.clear(),this.hasPendingTasks&&this.pendingTask.next(!1),this.destroyed=!0,this.pendingTask.unsubscribe()}static \u0275prov=Tn({token:a,providedIn:"root",factory:()=>new a})}return a})();function Vh(...a){}var Gg=(()=>{class a{static \u0275prov=Tn({token:a,providedIn:"root",factory:()=>new aE})}return a})(),aE=class{dirtyEffectCount=0;queues=new Map;add(c){this.enqueue(c),this.schedule(c)}schedule(c){c.dirty&&this.dirtyEffectCount++}remove(c){let d=c.zone,g=this.queues.get(d);g.has(c)&&(g.delete(c),c.dirty&&this.dirtyEffectCount--)}enqueue(c){let d=c.zone;this.queues.has(d)||this.queues.set(d,new Set);let g=this.queues.get(d);g.has(c)||g.add(c)}flush(){for(;this.dirtyEffectCount>0;){let c=!1;for(let[d,g]of this.queues)d===null?c||=this.flushQueue(g):c||=d.run(()=>this.flushQueue(g));c||(this.dirtyEffectCount=0)}}flushQueue(c){let d=!1;for(let g of c)g.dirty&&(this.dirtyEffectCount--,d=!0,g.run());return d}};function px(a){return{toString:a}.toString()}function Qz(a){return typeof a=="function"}var Z0=class{previousValue;currentValue;firstChange;constructor(c,d,g){this.previousValue=c,this.currentValue=d,this.firstChange=g}isFirstChange(){return this.firstChange}};function d2(a,c,d,g){c!==null?c.applyValueToInputSignal(c,g):a[d]=g}var op=(()=>{let a=()=>f2;return a.ngInherit=!0,a})();function f2(a){return a.type.prototype.ngOnChanges&&(a.setInput=tB),eB}function eB(){let a=m2(this),c=a?.current;if(c){let d=a.previous;if(d===Ph)a.previous=c;else for(let g in c)d[g]=c[g];a.current=null,this.ngOnChanges(c)}}function tB(a,c,d,g,w){let i=this.declaredInputs[g],A=m2(a)||nB(a,{previous:Ph,current:null}),N=A.current||(A.current={}),H=A.previous,ce=H[i];N[i]=new Z0(ce&&ce.currentValue,d,H===Ph),d2(a,c,w,d)}var p2="__ngSimpleChanges__";function m2(a){return a[p2]||null}function nB(a,c){return a[p2]=c}var PR=[];var qi=function(a,c=null,d){for(let g=0;g<PR.length;g++){let w=PR[g];w(a,c,d)}};function iB(a,c,d){let{ngOnChanges:g,ngOnInit:w,ngDoCheck:i}=c.type.prototype;if(g){let A=f2(c);(d.preOrderHooks??=[]).push(a,A),(d.preOrderCheckHooks??=[]).push(a,A)}w&&(d.preOrderHooks??=[]).push(0-a,w),i&&((d.preOrderHooks??=[]).push(a,i),(d.preOrderCheckHooks??=[]).push(a,i))}function rB(a,c){for(let d=c.directiveStart,g=c.directiveEnd;d<g;d++){let i=a.data[d].type.prototype,{ngAfterContentInit:A,ngAfterContentChecked:N,ngAfterViewInit:H,ngAfterViewChecked:ce,ngOnDestroy:be}=i;A&&(a.contentHooks??=[]).push(-d,A),N&&((a.contentHooks??=[]).push(d,N),(a.contentCheckHooks??=[]).push(d,N)),H&&(a.viewHooks??=[]).push(-d,H),ce&&((a.viewHooks??=[]).push(d,ce),(a.viewCheckHooks??=[]).push(d,ce)),be!=null&&(a.destroyHooks??=[]).push(d,be)}}function H0(a,c,d){g2(a,c,3,d)}function $0(a,c,d,g){(a[Ln]&3)===d&&g2(a,c,d,g)}function JE(a,c){let d=a[Ln];(d&3)===c&&(d&=16383,d+=1,a[Ln]=d)}function g2(a,c,d,g){let w=g!==void 0?a[kh]&65535:0,i=g??-1,A=c.length-1,N=0;for(let H=w;H<A;H++)if(typeof c[H+1]=="number"){if(N=c[H],g!=null&&N>=g)break}else c[H]<0&&(a[kh]+=65536),(N<i||i==-1)&&(oB(a,d,c,H),a[kh]=(a[kh]&4294901760)+H+2),H++}function LR(a,c){qi(4,a,c);let d=Nn(null);try{c.call(a)}finally{Nn(d),qi(5,a,c)}}function oB(a,c,d,g){let w=d[g]<0,i=d[g+1],A=w?-d[g]:d[g],N=a[A];w?a[Ln]>>14<a[kh]>>16&&(a[Ln]&3)===c&&(a[Ln]+=16384,LR(N,i)):LR(N,i)}var ep=-1,Zg=class{factory;name;injectImpl;resolving=!1;canSeeViewProviders;multi;componentProviders;index;providerFactory;constructor(c,d,g,w){this.factory=c,this.name=w,this.canSeeViewProviders=d,this.injectImpl=g}};function sB(a){return(a.flags&8)!==0}function aB(a){return(a.flags&16)!==0}function lB(a,c,d){let g=0;for(;g<d.length;){let w=d[g];if(typeof w=="number"){if(w!==0)break;g++;let i=d[g++],A=d[g++],N=d[g++];a.setAttribute(c,A,N,i)}else{let i=w,A=d[++g];cB(i)?a.setProperty(c,i,A):a.setAttribute(c,i,A),g++}}return g}function _2(a){return a===3||a===4||a===6}function cB(a){return a.charCodeAt(0)===64}function mx(a,c){if(!(c===null||c.length===0))if(a===null||a.length===0)a=c.slice();else{let d=-1;for(let g=0;g<c.length;g++){let w=c[g];typeof w=="number"?d=w:d===0||(d===-1||d===2?OR(a,d,w,null,c[++g]):OR(a,d,w,null,null))}}return a}function OR(a,c,d,g,w){let i=0,A=a.length;if(c===-1)A=-1;else for(;i<a.length;){let N=a[i++];if(typeof N=="number"){if(N===c){A=-1;break}else if(N>c){A=i-1;break}}}for(;i<a.length;){let N=a[i];if(typeof N=="number")break;if(N===d){w!==null&&(a[i+1]=w);return}i++,w!==null&&i++}A!==-1&&(a.splice(A,0,c),i=A+1),a.splice(i++,0,d),w!==null&&a.splice(i++,0,w)}function y2(a){return a!==ep}function X0(a){return a&32767}function uB(a){return a>>16}function Y0(a,c){let d=uB(a),g=c;for(;d>0;)g=g[Oh],d--;return g}var sT=!0;function K0(a){let c=sT;return sT=a,c}var hB=256,v2=hB-1,x2=5,dB=0,Ga={};function fB(a,c,d){let g;typeof d=="string"?g=d.charCodeAt(0)||0:d.hasOwnProperty(Rh)&&(g=d[Rh]),g==null&&(g=d[Rh]=dB++);let w=g&v2,i=1<<w;c.data[a+(w>>x2)]|=i}function b2(a,c){let d=w2(a,c);if(d!==-1)return d;let g=c[xn];g.firstCreatePass&&(a.injectorIndex=c.length,QE(g.data,a),QE(c,null),QE(g.blueprint,null));let w=kT(a,c),i=a.injectorIndex;if(y2(w)){let A=X0(w),N=Y0(w,c),H=N[xn].data;for(let ce=0;ce<8;ce++)c[i+ce]=N[A+ce]|H[A+ce]}return c[i+8]=w,i}function QE(a,c){a.push(0,0,0,0,0,0,0,0,c)}function w2(a,c){return a.injectorIndex===-1||a.parent&&a.parent.injectorIndex===a.injectorIndex||c[a.injectorIndex+8]===null?-1:a.injectorIndex}function kT(a,c){if(a.parent&&a.parent.injectorIndex!==-1)return a.parent.injectorIndex;let d=0,g=null,w=c;for(;w!==null;){if(g=D2(w),g===null)return ep;if(d++,w=w[Oh],g.injectorIndex!==-1)return g.injectorIndex|d<<16}return ep}function pB(a,c,d){fB(a,c,d)}function mB(a,c){if(c==="class")return a.classes;if(c==="style")return a.styles;let d=a.attrs;if(d){let g=d.length,w=0;for(;w<g;){let i=d[w];if(_2(i))break;if(i===0)w=w+2;else if(typeof i=="number")for(w++;w<g&&typeof d[w]=="string";)w++;else{if(i===c)return d[w+1];w=w+2}}}return null}function E2(a,c,d){if(d&8||a!==void 0)return a;E0(c,"NodeInjector")}function T2(a,c,d,g){if(d&8&&g===void 0&&(g=null),(d&3)===0){let w=a[Lh],i=So(void 0);try{return w?w.get(c,g,d&8):yE(c,g,d&8)}finally{So(i)}}return E2(g,c,d)}function I2(a,c,d,g=0,w){if(a!==null){if(c[Ln]&2048&&!(g&2)){let A=vB(a,c,d,g,Ga);if(A!==Ga)return A}let i=S2(a,c,d,g,Ga);if(i!==Ga)return i}return T2(c,d,g,w)}function S2(a,c,d,g,w){let i=_B(d);if(typeof i=="function"){if(!qE(c,a,g))return g&1?E2(w,d,g):T2(c,d,g,w);try{let A;if(A=i(g),A==null&&!(g&8))E0(d);else return A}finally{WE()}}else if(typeof i=="number"){let A=null,N=w2(a,c),H=ep,ce=g&1?c[os][Es]:null;for((N===-1||g&4)&&(H=N===-1?kT(a,c):c[N+8],H===ep||!FR(g,!1)?N=-1:(A=c[xn],N=X0(H),c=Y0(H,c)));N!==-1;){let be=c[xn];if(kR(i,N,be.data)){let Pe=gB(N,c,d,A,g,ce);if(Pe!==Ga)return Pe}H=c[N+8],H!==ep&&FR(g,c[xn].data[N+8]===ce)&&kR(i,N,c)?(A=be,N=X0(H),c=Y0(H,c)):N=-1}}return w}function gB(a,c,d,g,w,i){let A=c[xn],N=A.data[a+8],H=g==null?ru(N)&&sT:g!=A&&(N.type&3)!==0,ce=w&1&&i===N,be=G0(N,A,d,H,ce);return be!==null?J0(c,A,be,N,w):Ga}function G0(a,c,d,g,w){let i=a.providerIndexes,A=c.data,N=i&1048575,H=a.directiveStart,ce=a.directiveEnd,be=i>>20,Pe=g?N:N+be,st=w?N+be:ce;for(let Se=Pe;Se<st;Se++){let It=A[Se];if(Se<H&&d===It||Se>=H&&It.type===d)return Se}if(w){let Se=A[H];if(Se&&Nh(Se)&&Se.type===d)return H}return null}function J0(a,c,d,g,w){let i=a[d],A=c.data;if(i instanceof Zg){let N=i;if(N.resolving){let Se=g0(A[d]);throw _E(Se)}let H=K0(N.canSeeViewProviders);N.resolving=!0;let ce=A[d].type||A[d],be,Pe=N.injectImpl?So(N.injectImpl):null,st=qE(a,g,0);try{i=a[d]=N.factory(void 0,w,A,a,g),c.firstCreatePass&&d>=g.directiveStart&&iB(d,A[d],c)}finally{Pe!==null&&So(Pe),K0(H),N.resolving=!1,WE()}}return i}function _B(a){if(typeof a=="string")return a.charCodeAt(0)||0;let c=a.hasOwnProperty(Rh)?a[Rh]:void 0;return typeof c=="number"?c>=0?c&v2:yB:c}function kR(a,c,d){let g=1<<a;return!!(d[c+(a>>x2)]&g)}function FR(a,c){return!(a&2)&&!(a&1&&c)}var Uh=class{_tNode;_lView;constructor(c,d){this._tNode=c,this._lView=d}get(c,d,g){return I2(this._tNode,this._lView,c,Mh(g),d)}};function yB(){return new Uh(po(),gi())}function gx(a){return px(()=>{let c=a.prototype.constructor,d=c[Cg]||aT(c),g=Object.prototype,w=Object.getPrototypeOf(a.prototype).constructor;for(;w&&w!==g;){let i=w[Cg]||aT(w);if(i&&i!==d)return i;w=Object.getPrototypeOf(w)}return i=>new i})}function aT(a){return lE(a)?()=>{let c=aT(Ho(a));return c&&c()}:Jc(a)}function vB(a,c,d,g,w){let i=a,A=c;for(;i!==null&&A!==null&&A[Ln]&2048&&!Wf(A);){let N=S2(i,A,d,g|2,Ga);if(N!==Ga)return N;let H=i.parent;if(!H){let ce=A[CE];if(ce){let be=ce.get(d,Ga,g);if(be!==Ga)return be}H=D2(A),A=A[Oh]}i=H}return w}function D2(a){let c=a[xn],d=c.type;return d===2?c.declTNode:d===1?a[Es]:null}function e_(a){return mB(po(),a)}function xB(){return sp(po(),gi())}function sp(a,c){return new cu(ia(a,c))}var cu=(()=>{class a{nativeElement;constructor(d){this.nativeElement=d}static __NG_ELEMENT_ID__=xB}return a})();function bB(a){return a instanceof cu?a.nativeElement:a}function wB(){return this._results[Symbol.iterator]()}var Q0=class{_emitDistinctChangesOnly;dirty=!0;_onDirty=void 0;_results=[];_changesDetected=!1;_changes=void 0;length=0;first=void 0;last=void 0;get changes(){return this._changes??=new Dr}constructor(c=!1){this._emitDistinctChangesOnly=c}get(c){return this._results[c]}map(c){return this._results.map(c)}filter(c){return this._results.filter(c)}find(c){return this._results.find(c)}reduce(c,d){return this._results.reduce(c,d)}forEach(c){this._results.forEach(c)}some(c){return this._results.some(c)}toArray(){return this._results.slice()}toString(){return this._results.toString()}reset(c,d){this.dirty=!1;let g=KA(c);(this._changesDetected=!YA(this._results,g,d))&&(this._results=g,this.length=g.length,this.last=g[this.length-1],this.first=g[0])}notifyOnChanges(){this._changes!==void 0&&(this._changesDetected||!this._emitDistinctChangesOnly)&&this._changes.next(this)}onDirty(c){this._onDirty=c}setDirty(){this.dirty=!0,this._onDirty?.()}destroy(){this._changes!==void 0&&(this._changes.complete(),this._changes.unsubscribe())}[Symbol.iterator]=wB};function C2(a){return(a.flags&128)===128}var FT=function(a){return a[a.OnPush=0]="OnPush",a[a.Default=1]="Default",a}(FT||{}),M2=new Map,EB=0;function TB(){return EB++}function IB(a){M2.set(a[Ng],a)}function lT(a){M2.delete(a[Ng])}var NR="__ngContext__";function tp(a,c){$a(c)?(a[NR]=c[Ng],IB(c)):a[NR]=c}function A2(a){return P2(a[qf])}function R2(a){return P2(a[ws])}function P2(a){for(;a!==null&&!na(a);)a=a[ws];return a}var cT;function NT(a){cT=a}function L2(){if(cT!==void 0)return cT;if(typeof document<"u")return document;throw new Qt(210,!1)}var _x=new En("",{providedIn:"root",factory:()=>SB}),SB="ng",yx=new En(""),ap=new En("",{providedIn:"platform",factory:()=>"unknown"});var vx=new En("",{providedIn:"root",factory:()=>L2().body?.querySelector("[ngCspNonce]")?.getAttribute("ngCspNonce")||null});var DB="h",CB="b";var O2="r";var k2="di";var F2=!1,N2=new En("",{providedIn:"root",factory:()=>F2});var MB=(a,c,d,g)=>{};function AB(a,c,d,g){MB(a,c,d,g)}function zT(a){return(a.flags&32)===32}var RB=()=>null;function z2(a,c,d=!1){return RB(a,c,d)}function B2(a,c){let d=a.contentQueries;if(d!==null){let g=Nn(null);try{for(let w=0;w<d.length;w+=2){let i=d[w],A=d[w+1];if(A!==-1){let N=a.data[A];L0(i),N.contentQueries(2,c[A],A)}}}finally{Nn(g)}}}function uT(a,c,d){L0(0);let g=Nn(null);try{c(a,d)}finally{Nn(g)}}function V2(a,c,d){if(AE(c)){let g=Nn(null);try{let w=c.directiveStart,i=c.directiveEnd;for(let A=w;A<i;A++){let N=a.data[A];if(N.contentQueries){let H=d[A];N.contentQueries(1,H,A)}}}finally{Nn(g)}}}var zl=function(a){return a[a.Emulated=0]="Emulated",a[a.None=2]="None",a[a.ShadowDom=3]="ShadowDom",a}(zl||{});var j0;function PB(){if(j0===void 0&&(j0=null,kl.trustedTypes))try{j0=kl.trustedTypes.createPolicy("angular#unsafe-bypass",{createHTML:a=>a,createScript:a=>a,createScriptURL:a=>a})}catch{}return j0}function zR(a){return PB()?.createScriptURL(a)||a}var ex=class{changingThisBreaksApplicationSecurity;constructor(c){this.changingThisBreaksApplicationSecurity=c}toString(){return`SafeValue must use [property]=binding: ${this.changingThisBreaksApplicationSecurity} (see ${v0})`}};function t_(a){return a instanceof ex?a.changingThisBreaksApplicationSecurity:a}function BT(a,c){let d=j2(a);if(d!=null&&d!==c){if(d==="ResourceURL"&&c==="URL")return!0;throw new Error(`Required a safe ${c}, got a ${d} (see ${v0})`)}return d===c}function j2(a){return a instanceof ex&&a.getTypeName()||null}var LB=/^(?!javascript:)(?:[a-z0-9+.-]+:|[^&:\/?#]*(?:[\/?#]|$))/i;function U2(a){return a=String(a),a.match(LB)?a:"unsafe:"+a}var xx=function(a){return a[a.NONE=0]="NONE",a[a.HTML=1]="HTML",a[a.STYLE=2]="STYLE",a[a.SCRIPT=3]="SCRIPT",a[a.URL=4]="URL",a[a.RESOURCE_URL=5]="RESOURCE_URL",a}(xx||{});function H2(a){let c=G2();return c?c.sanitize(xx.URL,a)||"":BT(a,"URL")?t_(a):U2(Pg(a))}function $2(a){let c=G2();if(c)return zR(c.sanitize(xx.RESOURCE_URL,a)||"");if(BT(a,"ResourceURL"))return zR(t_(a));throw new Qt(904,!1)}function OB(a,c){return c==="src"&&(a==="embed"||a==="frame"||a==="iframe"||a==="media"||a==="script")||c==="href"&&(a==="base"||a==="link")?$2:H2}function VT(a,c,d){return OB(c,d)(a)}function G2(){let a=gi();return a&&a[Ua].sanitizer}function q2(a){return a instanceof Function?a():a}function kB(a,c,d){let g=a.length;for(;;){let w=a.indexOf(c,d);if(w===-1)return w;if(w===0||a.charCodeAt(w-1)<=32){let i=c.length;if(w+i===g||a.charCodeAt(w+i)<=32)return w}d=w+1}}var W2="ng-template";function FB(a,c,d,g){let w=0;if(g){for(;w<c.length&&typeof c[w]=="string";w+=2)if(c[w]==="class"&&kB(c[w+1].toLowerCase(),d,0)!==-1)return!0}else if(jT(a))return!1;if(w=c.indexOf(1,w),w>-1){let i;for(;++w<c.length&&typeof(i=c[w])=="string";)if(i.toLowerCase()===d)return!0}return!1}function jT(a){return a.type===4&&a.value!==W2}function NB(a,c,d){let g=a.type===4&&!d?W2:a.value;return c===g}function zB(a,c,d){let g=4,w=a.attrs,i=w!==null?jB(w):0,A=!1;for(let N=0;N<c.length;N++){let H=c[N];if(typeof H=="number"){if(!A&&!oa(g)&&!oa(H))return!1;if(A&&oa(H))continue;A=!1,g=H|g&1;continue}if(!A)if(g&4){if(g=2|g&1,H!==""&&!NB(a,H,d)||H===""&&c.length===1){if(oa(g))return!1;A=!0}}else if(g&8){if(w===null||!FB(a,w,H,d)){if(oa(g))return!1;A=!0}}else{let ce=c[++N],be=BB(H,w,jT(a),d);if(be===-1){if(oa(g))return!1;A=!0;continue}if(ce!==""){let Pe;if(be>i?Pe="":Pe=w[be+1].toLowerCase(),g&2&&ce!==Pe){if(oa(g))return!1;A=!0}}}}return oa(g)||A}function oa(a){return(a&1)===0}function BB(a,c,d,g){if(c===null)return-1;let w=0;if(g||!d){let i=!1;for(;w<c.length;){let A=c[w];if(A===a)return w;if(A===3||A===6)i=!0;else if(A===1||A===2){let N=c[++w];for(;typeof N=="string";)N=c[++w];continue}else{if(A===4)break;if(A===0){w+=4;continue}}w+=i?1:2}return-1}else return UB(c,a)}function VB(a,c,d=!1){for(let g=0;g<c.length;g++)if(zB(a,c[g],d))return!0;return!1}function jB(a){for(let c=0;c<a.length;c++){let d=a[c];if(_2(d))return c}return a.length}function UB(a,c){let d=a.indexOf(4);if(d>-1)for(d++;d<a.length;){let g=a[d];if(typeof g=="number")return-1;if(g===c)return d;d++}return-1}function BR(a,c){return a?":not("+c.trim()+")":c}function HB(a){let c=a[0],d=1,g=2,w="",i=!1;for(;d<a.length;){let A=a[d];if(typeof A=="string")if(g&2){let N=a[++d];w+="["+A+(N.length>0?'="'+N+'"':"")+"]"}else g&8?w+="."+A:g&4&&(w+=" "+A);else w!==""&&!oa(A)&&(c+=BR(i,w),w=""),g=A,i=i||!oa(g);d++}return w!==""&&(c+=BR(i,w)),c}function $B(a){return a.map(HB).join(",")}function GB(a){let c=[],d=[],g=1,w=2;for(;g<a.length;){let i=a[g];if(typeof i=="string")w===2?i!==""&&c.push(i,a[++g]):w===8&&d.push(i);else{if(!oa(w))break;w=i}g++}return d.length&&c.push(1,...d),c}var Wa={};function qB(a,c){return a.createText(c)}function WB(a,c,d){a.setValue(c,d)}function Z2(a,c,d){return a.createElement(c,d)}function tx(a,c,d,g,w){a.insertBefore(c,d,g,w)}function X2(a,c,d){a.appendChild(c,d)}function VR(a,c,d,g,w){g!==null?tx(a,c,d,g,w):X2(a,c,d)}function Y2(a,c,d){a.removeChild(null,c,d)}function ZB(a,c,d){a.setAttribute(c,"style",d)}function XB(a,c,d){d===""?a.removeAttribute(c,"class"):a.setAttribute(c,"class",d)}function K2(a,c,d){let{mergedAttrs:g,classes:w,styles:i}=d;g!==null&&lB(a,c,g),w!==null&&XB(a,c,w),i!==null&&ZB(a,c,i)}function UT(a,c,d,g,w,i,A,N,H,ce,be){let Pe=Ar+g,st=Pe+w,Se=YB(Pe,st),It=typeof ce=="function"?ce():ce;return Se[xn]={type:a,blueprint:Se,template:d,queries:null,viewQuery:N,declTNode:c,data:Se.slice().fill(null,Pe),bindingStartIndex:Pe,expandoStartIndex:st,hostBindingOpCodes:null,firstCreatePass:!0,firstUpdatePass:!0,staticViewQueries:!1,staticContentQueries:!1,preOrderHooks:null,preOrderCheckHooks:null,contentHooks:null,contentCheckHooks:null,viewHooks:null,viewCheckHooks:null,destroyHooks:null,cleanup:null,contentQueries:null,components:null,directiveRegistry:typeof i=="function"?i():i,pipeRegistry:typeof A=="function"?A():A,firstChild:null,schemas:H,consts:It,incompleteFirstPass:!1,ssrId:be}}function YB(a,c){let d=[];for(let g=0;g<c;g++)d.push(g<a?null:Wa);return d}function KB(a){let c=a.tView;return c===null||c.incompleteFirstPass?a.tView=UT(1,null,a.template,a.decls,a.vars,a.directiveDefs,a.pipeDefs,a.viewQuery,a.schemas,a.consts,a.id):c}function HT(a,c,d,g,w,i,A,N,H,ce,be){let Pe=c.blueprint.slice();return Pe[ta]=w,Pe[Ln]=g|4|128|8|64|1024,(ce!==null||a&&a[Ln]&2048)&&(Pe[Ln]|=2048),OE(Pe),Pe[Mr]=Pe[Oh]=a,Pe[vr]=d,Pe[Ua]=A||a&&a[Ua],Pe[nr]=N||a&&a[nr],Pe[Lh]=H||a&&a[Lh]||null,Pe[Es]=i,Pe[Ng]=TB(),Pe[$f]=be,Pe[CE]=ce,Pe[os]=c.type==2?a[os]:Pe,Pe}function JB(a,c,d){let g=ia(c,a),w=KB(d),i=a[Ua].rendererFactory,A=$T(a,HT(a,w,null,J2(d),g,c,null,i.createRenderer(g,d),null,null,null));return a[c.index]=A}function J2(a){let c=16;return a.signals?c=4096:a.onPush&&(c=64),c}function Q2(a,c,d,g){if(d===0)return-1;let w=c.length;for(let i=0;i<d;i++)c.push(g),a.blueprint.push(g),a.data.push(null);return w}function $T(a,c){return a[qf]?a[DE][ws]=c:a[qf]=c,a[DE]=c,c}function ir(a=1){eP(as(),gi(),su()+a,!1)}function eP(a,c,d,g){if(!g)if((c[Ln]&3)===3){let i=a.preOrderCheckHooks;i!==null&&H0(c,i,d)}else{let i=a.preOrderHooks;i!==null&&$0(c,i,0,d)}au(d)}var bx=function(a){return a[a.None=0]="None",a[a.SignalBased=1]="SignalBased",a[a.HasDecoratorInputTransform=2]="HasDecoratorInputTransform",a}(bx||{});function hT(a,c,d,g){let w=Nn(null);try{let[i,A,N]=a.inputs[d],H=null;(A&bx.SignalBased)!==0&&(H=c[i][Qr]),H!==null&&H.transformFn!==void 0?g=H.transformFn(g):N!==null&&(g=N.call(c,g)),a.setInput!==null?a.setInput(c,H,g,d,i):d2(c,H,i,g)}finally{Nn(w)}}var qa=function(a){return a[a.Important=1]="Important",a[a.DashCase=2]="DashCase",a}(qa||{}),QB;function GT(a,c){return QB(a,c)}function Qf(a,c,d,g,w){if(g!=null){let i,A=!1;na(g)?i=g:$a(g)&&(A=!0,g=g[ta]);let N=Ts(g);a===0&&d!==null?w==null?X2(c,d,N):tx(c,d,N,w||null,!0):a===1&&d!==null?tx(c,d,N,w||null,!0):a===2?Y2(c,N,A):a===3&&c.destroyNode(N),i!=null&&h3(c,a,i,d,w)}}function e3(a,c){tP(a,c),c[ta]=null,c[Es]=null}function t3(a,c,d,g,w,i){g[ta]=w,g[Es]=c,Ex(a,g,d,1,w,i)}function tP(a,c){c[Ua].changeDetectionScheduler?.notify(9),Ex(a,c,c[nr],2,null,null)}function n3(a){let c=a[qf];if(!c)return eT(a[xn],a);for(;c;){let d=null;if($a(c))d=c[qf];else{let g=c[Gr];g&&(d=g)}if(!d){for(;c&&!c[ws]&&c!==a;)$a(c)&&eT(c[xn],c),c=c[Mr];c===null&&(c=a),$a(c)&&eT(c[xn],c),d=c&&c[ws]}c=d}}function qT(a,c){let d=a[Fh],g=d.indexOf(c);d.splice(g,1)}function wx(a,c){if(zh(c))return;let d=c[nr];d.destroyNode&&Ex(a,c,d,3,null,null),n3(c)}function eT(a,c){if(zh(c))return;let d=Nn(null);try{c[Ln]&=-129,c[Ln]|=256,c[ss]&&Df(c[ss]),r3(a,c),i3(a,c),c[xn].type===1&&c[nr].destroy();let g=c[nu];if(g!==null&&na(c[Mr])){g!==c[Mr]&&qT(g,c);let w=c[Ha];w!==null&&w.detachView(a)}lT(c)}finally{Nn(d)}}function i3(a,c){let d=a.cleanup,g=c[Gf];if(d!==null)for(let A=0;A<d.length-1;A+=2)if(typeof d[A]=="string"){let N=d[A+3];N>=0?g[N]():g[-N].unsubscribe(),A+=2}else{let N=g[d[A+1]];d[A].call(N)}g!==null&&(c[Gf]=null);let w=c[Ll];if(w!==null){c[Ll]=null;for(let A=0;A<w.length;A++){let N=w[A];N()}}let i=c[Fl];if(i!==null){c[Fl]=null;for(let A of i)A.destroy()}}function r3(a,c){let d;if(a!=null&&(d=a.destroyHooks)!=null)for(let g=0;g<d.length;g+=2){let w=c[d[g]];if(!(w instanceof Zg)){let i=d[g+1];if(Array.isArray(i))for(let A=0;A<i.length;A+=2){let N=w[i[A]],H=i[A+1];qi(4,N,H);try{H.call(N)}finally{qi(5,N,H)}}else{qi(4,w,i);try{i.call(w)}finally{qi(5,w,i)}}}}}function o3(a,c,d){return s3(a,c.parent,d)}function s3(a,c,d){let g=c;for(;g!==null&&g.type&168;)c=g,g=c.parent;if(g===null)return d[ta];if(ru(g)){let{encapsulation:w}=a.data[g.directiveStart+g.componentOffset];if(w===zl.None||w===zl.Emulated)return null}return ia(g,d)}function a3(a,c,d){return c3(a,c,d)}function l3(a,c,d){return a.type&40?ia(a,d):null}var c3=l3,jR;function WT(a,c,d,g){let w=o3(a,g,c),i=c[nr],A=g.parent||c[Es],N=a3(A,g,c);if(w!=null)if(Array.isArray(d))for(let H=0;H<d.length;H++)VR(i,w,d[H],N,!1);else VR(i,w,d,N,!1);jR!==void 0&&jR(i,g,c,d,w)}function qg(a,c){if(c!==null){let d=c.type;if(d&3)return ia(c,a);if(d&4)return dT(-1,a[c.index]);if(d&8){let g=c.child;if(g!==null)return qg(a,g);{let w=a[c.index];return na(w)?dT(-1,w):Ts(w)}}else{if(d&128)return qg(a,c.next);if(d&32)return GT(c,a)()||Ts(a[c.index]);{let g=nP(a,c);if(g!==null){if(Array.isArray(g))return g[0];let w=Qc(a[os]);return qg(w,g)}else return qg(a,c.next)}}}return null}function nP(a,c){if(c!==null){let g=a[os][Es],w=c.projection;return g.projection[w]}return null}function dT(a,c){let d=Gr+a+1;if(d<c.length){let g=c[d],w=g[xn].firstChild;if(w!==null)return qg(g,w)}return c[iu]}function ZT(a,c,d,g,w,i,A){for(;d!=null;){if(d.type===128){d=d.next;continue}let N=g[d.index],H=d.type;if(A&&c===0&&(N&&tp(Ts(N),g),d.flags|=2),!zT(d))if(H&8)ZT(a,c,d.child,g,w,i,!1),Qf(c,a,w,N,i);else if(H&32){let ce=GT(d,g),be;for(;be=ce();)Qf(c,a,w,be,i);Qf(c,a,w,N,i)}else H&16?u3(a,c,g,d,w,i):Qf(c,a,w,N,i);d=A?d.projectionNext:d.next}}function Ex(a,c,d,g,w,i){ZT(d,g,a.firstChild,c,w,i,!1)}function u3(a,c,d,g,w,i){let A=d[os],H=A[Es].projection[g.projection];if(Array.isArray(H))for(let ce=0;ce<H.length;ce++){let be=H[ce];Qf(c,a,w,be,i)}else{let ce=H,be=A[Mr];C2(g)&&(ce.flags|=128),ZT(a,c,ce,be,w,i,!0)}}function h3(a,c,d,g,w){let i=d[iu],A=Ts(d);i!==A&&Qf(c,a,g,i,w);for(let N=Gr;N<d.length;N++){let H=d[N];Ex(H[xn],H,a,c,g,i)}}function d3(a,c,d,g,w){if(c)w?a.addClass(d,g):a.removeClass(d,g);else{let i=g.indexOf("-")===-1?void 0:qa.DashCase;w==null?a.removeStyle(d,g,i):(typeof w=="string"&&w.endsWith("!important")&&(w=w.slice(0,-10),i|=qa.Important),a.setStyle(d,g,w,i))}}function iP(a,c,d,g,w){let i=su(),A=g&2;try{au(-1),A&&c.length>Ar&&eP(a,c,Ar,!1),qi(A?2:0,w,d),d(g,w)}finally{au(i),qi(A?3:1,w,d)}}function rP(a,c,d){v3(a,c,d),(d.flags&64)===64&&x3(a,c,d)}function XT(a,c,d=ia){let g=c.localNames;if(g!==null){let w=c.index+1;for(let i=0;i<g.length;i+=2){let A=g[i+1],N=A===-1?d(c,a):a[A];a[w++]=N}}}function f3(a,c,d,g){let i=g.get(N2,F2)||d===zl.ShadowDom,A=a.selectRootElement(c,i);return p3(A),A}function p3(a){m3(a)}var m3=()=>null;function g3(a){return a==="class"?"className":a==="for"?"htmlFor":a==="formaction"?"formAction":a==="innerHtml"?"innerHTML":a==="readonly"?"readOnly":a==="tabindex"?"tabIndex":a}function _3(a,c,d,g,w,i){let A=c[xn];if(YT(a,A,c,d,g)){ru(a)&&y3(c,a.index);return}a.type&3&&(d=g3(d)),oP(a,c,d,g,w,i)}function oP(a,c,d,g,w,i){if(a.type&3){let A=ia(a,c);g=i!=null?i(g,a.value||"",d):g,w.setProperty(A,d,g)}else a.type&12}function y3(a,c){let d=Is(c,a);d[Ln]&16||(d[Ln]|=64)}function v3(a,c,d){let g=d.directiveStart,w=d.directiveEnd;ru(d)&&JB(c,d,a.data[g+d.componentOffset]),a.firstCreatePass||b2(d,c);let i=d.initialInputs;for(let A=g;A<w;A++){let N=a.data[A],H=J0(c,a,A,d);if(tp(H,c),i!==null&&I3(c,A-g,H,N,d,i),Nh(N)){let ce=Is(d.index,c);ce[vr]=J0(c,a,A,d)}}}function x3(a,c,d){let g=d.directiveStart,w=d.directiveEnd,i=d.index,A=wR();try{au(i);for(let N=g;N<w;N++){let H=a.data[N],ce=c[N];P0(N),(H.hostBindings!==null||H.hostVars!==0||H.hostAttrs!==null)&&b3(H,ce)}}finally{au(-1),P0(A)}}function b3(a,c){a.hostBindings!==null&&a.hostBindings(1,c)}function w3(a,c){let d=a.directiveRegistry,g=null;if(d)for(let w=0;w<d.length;w++){let i=d[w];VB(c,i.selectors,!1)&&(g??=[],Nh(i)?g.unshift(i):g.push(i))}return g}function E3(a,c,d,g,w,i){let A=ia(a,c);T3(c[nr],A,i,a.value,d,g,w)}function T3(a,c,d,g,w,i,A){if(i==null)a.removeAttribute(c,w,d);else{let N=A==null?Pg(i):A(i,g||"",w);a.setAttribute(c,w,N,d)}}function I3(a,c,d,g,w,i){let A=i[c];if(A!==null)for(let N=0;N<A.length;N+=2){let H=A[N],ce=A[N+1];hT(g,d,H,ce)}}function sP(a,c,d,g,w){let i=Ar+d,A=c[xn],N=w(A,c,a,g,d);c[i]=N,Yf(a,!0);let H=a.type===2;return H?(K2(c[nr],N,a),(hR()===0||C0(a))&&tp(N,c),dR()):tp(N,c),B0()&&(!H||!zT(a))&&WT(A,c,N,a),a}function aP(a){let c=a;return HE()?gR():(c=c.parent,Yf(c,!1)),c}function S3(a,c){let d=a[Lh];if(!d)return;d.get(ls,null)?.(c)}function YT(a,c,d,g,w){let i=a.inputs?.[g],A=a.hostDirectiveInputs?.[g],N=!1;if(A)for(let H=0;H<A.length;H+=2){let ce=A[H],be=A[H+1],Pe=c.data[ce];hT(Pe,d[ce],be,w),N=!0}if(i)for(let H of i){let ce=d[H],be=c.data[H];hT(be,ce,g,w),N=!0}return N}function D3(a,c){let d=Is(c,a),g=d[xn];C3(g,d);let w=d[ta];w!==null&&d[$f]===null&&(d[$f]=z2(w,d[Lh])),qi(18),KT(g,d,d[vr]),qi(19,d[vr])}function C3(a,c){for(let d=c.length;d<a.blueprint.length;d++)c.push(a.blueprint[d])}function KT(a,c,d){O0(c);try{let g=a.viewQuery;g!==null&&uT(1,g,d);let w=a.template;w!==null&&iP(a,c,w,1,d),a.firstCreatePass&&(a.firstCreatePass=!1),c[Ha]?.finishViewCreation(a),a.staticContentQueries&&B2(a,c),a.staticViewQueries&&uT(2,a.viewQuery,d);let i=a.components;i!==null&&M3(c,i)}catch(g){throw a.firstCreatePass&&(a.incompleteFirstPass=!0,a.firstCreatePass=!1),g}finally{c[Ln]&=-5,k0()}}function M3(a,c){for(let d=0;d<c.length;d++)D3(a,c[d])}function JT(a,c,d,g){let w=Nn(null);try{let i=c.tView,N=a[Ln]&4096?4096:16,H=HT(a,i,d,N,null,c,null,null,g?.injector??null,g?.embeddedViewInjector??null,g?.dehydratedView??null),ce=a[c.index];H[nu]=ce;let be=a[Ha];return be!==null&&(H[Ha]=be.createEmbeddedView(i)),KT(i,H,d),H}finally{Nn(w)}}function nx(a,c){return!c||c.firstChild===null||C2(a)}var UR=!1,A3=new En("");function Xg(a,c,d,g,w=!1){for(;d!==null;){if(d.type===128){d=w?d.projectionNext:d.next;continue}let i=c[d.index];i!==null&&g.push(Ts(i)),na(i)&&lP(i,g);let A=d.type;if(A&8)Xg(a,c,d.child,g);else if(A&32){let N=GT(d,c),H;for(;H=N();)g.push(H)}else if(A&16){let N=nP(c,d);if(Array.isArray(N))g.push(...N);else{let H=Qc(c[os]);Xg(H[xn],H,N,g,!0)}}d=w?d.projectionNext:d.next}return g}function lP(a,c){for(let d=Gr;d<a.length;d++){let g=a[d],w=g[xn].firstChild;w!==null&&Xg(g[xn],g,w,c)}a[iu]!==a[ta]&&c.push(a[iu])}function cP(a){if(a[D0]!==null){for(let c of a[D0])c.impl.addSequence(c);a[D0].length=0}}var uP=[];function R3(a){return a[ss]??P3(a)}function P3(a){let c=uP.pop()??Object.create(O3);return c.lView=a,c}function L3(a){a.lView[ss]!==a&&(a.lView=null,uP.push(a))}var O3=Oi(Wt({},qc),{consumerIsAlwaysLive:!0,kind:"template",consumerMarkedDirty:a=>{Bh(a.lView)},consumerOnSignalRead(){this.lView[ss]=this}});function k3(a){let c=a[ss]??Object.create(F3);return c.lView=a,c}var F3=Oi(Wt({},qc),{consumerIsAlwaysLive:!0,kind:"template",consumerMarkedDirty:a=>{let c=Qc(a.lView);for(;c&&!hP(c[xn]);)c=Qc(c);c&&kE(c)},consumerOnSignalRead(){this.lView[ss]=this}});function hP(a){return a.type!==2}function dP(a){if(a[Fl]===null)return;let c=!0;for(;c;){let d=!1;for(let g of a[Fl])g.dirty&&(d=!0,g.zone===null||Zone.current===g.zone?g.run():g.zone.run(()=>g.run()));c=d&&!!(a[Ln]&8192)}}var N3=100;function QT(a,c=0){let g=a[Ua].rendererFactory,w=!1;w||g.begin?.();try{z3(a,c)}finally{w||g.end?.()}}function z3(a,c){let d=GE();try{Kf(!0),fT(a,c);let g=0;for(;Vg(a);){if(g===N3)throw new Qt(103,!1);g++,fT(a,1)}}finally{Kf(d)}}function fP(a,c){$E(c?jg.Exhaustive:jg.OnlyDirtyViews);try{QT(a)}finally{$E(jg.Off)}}function B3(a,c,d,g){if(zh(c))return;let w=c[Ln],i=!1,A=!1;O0(c);let N=!0,H=null,ce=null;i||(hP(a)?(ce=R3(c),H=Wc(ce)):$v()===null?(N=!1,ce=k3(c),H=Wc(ce)):c[ss]&&(Df(c[ss]),c[ss]=null));try{OE(c),yR(a.bindingStartIndex),d!==null&&iP(a,c,d,2,g);let be=(w&3)===3;if(!i)if(be){let Se=a.preOrderCheckHooks;Se!==null&&H0(c,Se,null)}else{let Se=a.preOrderHooks;Se!==null&&$0(c,Se,0,null),JE(c,0)}if(A||V3(c),dP(c),pP(c,0),a.contentQueries!==null&&B2(a,c),!i)if(be){let Se=a.contentCheckHooks;Se!==null&&H0(c,Se)}else{let Se=a.contentHooks;Se!==null&&$0(c,Se,1),JE(c,1)}U3(a,c);let Pe=a.components;Pe!==null&&gP(c,Pe,0);let st=a.viewQuery;if(st!==null&&uT(2,st,g),!i)if(be){let Se=a.viewCheckHooks;Se!==null&&H0(c,Se)}else{let Se=a.viewHooks;Se!==null&&$0(c,Se,2),JE(c,2)}if(a.firstUpdatePass===!0&&(a.firstUpdatePass=!1),c[S0]){for(let Se of c[S0])Se();c[S0]=null}i||(cP(c),c[Ln]&=-73)}catch(be){throw i||Bh(c),be}finally{ce!==null&&(Th(ce,H),N&&L3(ce)),k0()}}function pP(a,c){for(let d=A2(a);d!==null;d=R2(d))for(let g=Gr;g<d.length;g++){let w=d[g];mP(w,c)}}function V3(a){for(let c=A2(a);c!==null;c=R2(c)){if(!(c[Ln]&2))continue;let d=c[Fh];for(let g=0;g<d.length;g++){let w=d[g];kE(w)}}}function j3(a,c,d){qi(18);let g=Is(c,a);mP(g,d),qi(19,g[vr])}function mP(a,c){A0(a)&&fT(a,c)}function fT(a,c){let g=a[xn],w=a[Ln],i=a[ss],A=!!(c===0&&w&16);if(A||=!!(w&64&&c===0),A||=!!(w&1024),A||=!!(i?.dirty&&Sf(i)),A||=!1,i&&(i.dirty=!1),a[Ln]&=-9217,A)B3(g,a,g.template,a[vr]);else if(w&8192){let N=Nn(null);try{dP(a),pP(a,1);let H=g.components;H!==null&&gP(a,H,1),cP(a)}finally{Nn(N)}}}function gP(a,c,d){for(let g=0;g<c.length;g++)j3(a,c[g],d)}function U3(a,c){let d=a.hostBindingOpCodes;if(d!==null)try{for(let g=0;g<d.length;g++){let w=d[g];if(w<0)au(~w);else{let i=w,A=d[++g],N=d[++g];bR(A,i);let H=c[i];qi(24,H),N(2,H),qi(25,H)}}}finally{au(-1)}}function eI(a,c){let d=GE()?64:1088;for(a[Ua].changeDetectionScheduler?.notify(c);a;){a[Ln]|=d;let g=Qc(a);if(Wf(a)&&!g)return a;a=g}return null}function _P(a,c,d,g){return[a,!0,0,c,null,g,null,d,null,null]}function H3(a,c){let d=Gr+c;if(d<a.length)return a[d]}function tI(a,c,d,g=!0){let w=c[xn];if(G3(w,c,a,d),g){let A=dT(d,a),N=c[nr],H=N.parentNode(a[iu]);H!==null&&t3(w,a[Es],N,c,H,A)}let i=c[$f];i!==null&&i.firstChild!==null&&(i.firstChild=null)}function $3(a,c){let d=Yg(a,c);return d!==void 0&&wx(d[xn],d),d}function Yg(a,c){if(a.length<=Gr)return;let d=Gr+c,g=a[d];if(g){let w=g[nu];w!==null&&w!==a&&qT(w,g),c>0&&(a[d-1][ws]=g[ws]);let i=Lg(a,Gr+c);e3(g[xn],g);let A=i[Ha];A!==null&&A.detachView(i[xn]),g[Mr]=null,g[ws]=null,g[Ln]&=-129}return g}function G3(a,c,d,g){let w=Gr+g,i=d.length;g>0&&(d[w-1][ws]=c),g<i-Gr?(c[ws]=d[w],vE(d,Gr+g,c)):(d.push(c),c[ws]=null),c[Mr]=d;let A=c[nu];A!==null&&d!==A&&yP(A,c);let N=c[Ha];N!==null&&N.insertView(a),R0(c),c[Ln]|=128}function yP(a,c){let d=a[Fh],g=c[Mr];if($a(g))a[Ln]|=2;else{let w=g[Mr][os];c[os]!==w&&(a[Ln]|=2)}d===null?a[Fh]=[c]:d.push(c)}var lu=class{_lView;_cdRefInjectingView;_appRef=null;_attachedToViewContainer=!1;exhaustive;get rootNodes(){let c=this._lView,d=c[xn];return Xg(d,c,d.firstChild,[])}constructor(c,d){this._lView=c,this._cdRefInjectingView=d}get context(){return this._lView[vr]}set context(c){this._lView[vr]=c}get destroyed(){return zh(this._lView)}destroy(){if(this._appRef)this._appRef.detachView(this);else if(this._attachedToViewContainer){let c=this._lView[Mr];if(na(c)){let d=c[zg],g=d?d.indexOf(this):-1;g>-1&&(Yg(c,g),Lg(d,g))}this._attachedToViewContainer=!1}wx(this._lView[xn],this._lView)}onDestroy(c){FE(this._lView,c)}markForCheck(){eI(this._cdRefInjectingView||this._lView,4)}detach(){this._lView[Ln]&=-129}reattach(){R0(this._lView),this._lView[Ln]|=128}detectChanges(){this._lView[Ln]|=1024,QT(this._lView)}checkNoChanges(){return;try{this.exhaustive??=this._lView[Lh].get(A3,UR)}catch{this.exhaustive=UR}}attachToViewContainerRef(){if(this._appRef)throw new Qt(902,!1);this._attachedToViewContainer=!0}detachFromAppRef(){this._appRef=null;let c=Wf(this._lView),d=this._lView[nu];d!==null&&!c&&qT(d,this._lView),tP(this._lView[xn],this._lView)}attachToAppRef(c){if(this._attachedToViewContainer)throw new Qt(902,!1);this._appRef=c;let d=Wf(this._lView),g=this._lView[nu];g!==null&&!d&&yP(g,this._lView),R0(this._lView)}};var np=(()=>{class a{_declarationLView;_declarationTContainer;elementRef;static __NG_ELEMENT_ID__=q3;constructor(d,g,w){this._declarationLView=d,this._declarationTContainer=g,this.elementRef=w}get ssrId(){return this._declarationTContainer.tView?.ssrId||null}createEmbeddedView(d,g){return this.createEmbeddedViewImpl(d,g)}createEmbeddedViewImpl(d,g,w){let i=JT(this._declarationLView,this._declarationTContainer,d,{embeddedViewInjector:g,dehydratedView:w});return new lu(i)}}return a})();function q3(){return nI(po(),gi())}function nI(a,c){return a.type&4?new np(c,a,sp(a,c)):null}function Tx(a,c,d,g,w){let i=a.data[c];if(i===null)i=W3(a,c,d,g,w),xR()&&(i.flags|=32);else if(i.type&64){i.type=d,i.value=g,i.attrs=w;let A=mR();i.injectorIndex=A===null?-1:A.injectorIndex}return Yf(i,!0),i}function W3(a,c,d,g,w){let i=UE(),A=HE(),N=A?i:i&&i.parent,H=a.data[c]=X3(a,N,d,c,g,w);return Z3(a,H,i,A),H}function Z3(a,c,d,g){a.firstChild===null&&(a.firstChild=c),d!==null&&(g?d.child==null&&c.parent!==null&&(d.child=c):d.next===null&&(d.next=c,c.prev=d))}function X3(a,c,d,g,w,i){let A=c?c.injectorIndex:-1,N=0;return pR()&&(N|=128),{type:d,index:g,insertBeforeIndex:null,injectorIndex:A,directiveStart:-1,directiveEnd:-1,directiveStylingLast:-1,componentOffset:-1,propertyBindings:null,flags:N,providerIndexes:0,value:w,attrs:i,mergedAttrs:null,localNames:null,initialInputs:null,inputs:null,hostDirectiveInputs:null,outputs:null,hostDirectiveOutputs:null,directiveToIndex:null,tView:null,next:null,prev:null,projectionNext:null,child:null,parent:c,projection:null,styles:null,stylesWithoutHost:null,residualStyles:void 0,classes:null,classesWithoutHost:null,residualClasses:void 0,classBindings:0,styleBindings:0}}var uZ=new RegExp(`^(\\d+)*(${CB}|${DB})*(.*)`);function Y3(a){let c=a[ME]??[],g=a[Mr][nr],w=[];for(let i of c)i.data[k2]!==void 0?w.push(i):K3(i,g);a[ME]=w}function K3(a,c){let d=0,g=a.firstChild;if(g){let w=a.data[O2];for(;d<w;){let i=g.nextSibling;Y2(c,g,!1),g=i,d++}}}var J3=()=>null,Q3=()=>null;function pT(a,c){return J3(a,c)}function eV(a,c,d){return Q3(a,c,d)}var vP=class{},Ix=class{},mT=class{resolveComponentFactory(c){throw new Qt(917,!1)}},n_=class{static NULL=new mT},Hh=class{},Sx=(()=>{class a{destroyNode=null;static __NG_ELEMENT_ID__=()=>tV()}return a})();function tV(){let a=gi(),c=po(),d=Is(c.index,a);return($a(d)?d:a)[nr]}var xP=(()=>{class a{static \u0275prov=Tn({token:a,providedIn:"root",factory:()=>null})}return a})();var q0={},gT=class{injector;parentInjector;constructor(c,d){this.injector=c,this.parentInjector=d}get(c,d,g){let w=this.injector.get(c,q0,g);return w!==q0||d===q0?w:this.parentInjector.get(c,d,g)}};function ix(a,c,d){let g=d?a.styles:null,w=d?a.classes:null,i=0;if(c!==null)for(let A=0;A<c.length;A++){let N=c[A];if(typeof N=="number")i=N;else if(i==1)w=x0(w,N);else if(i==2){let H=N,ce=c[++A];g=x0(g,H+": "+ce+";")}}d?a.styles=g:a.stylesWithoutHost=g,d?a.classes=w:a.classesWithoutHost=w}function sa(a,c=0){let d=gi();if(d===null)return $n(a,c);let g=po();return I2(g,d,Ho(a),c)}function nV(a,c,d,g,w){let i=g===null?null:{"":-1},A=w(a,d);if(A!==null){let N=A,H=null,ce=null;for(let be of A)if(be.resolveHostDirectives!==null){[N,H,ce]=be.resolveHostDirectives(A);break}oV(a,c,d,N,i,H,ce)}i!==null&&g!==null&&iV(d,g,i)}function iV(a,c,d){let g=a.localNames=[];for(let w=0;w<c.length;w+=2){let i=d[c[w+1]];if(i==null)throw new Qt(-301,!1);g.push(c[w],i)}}function rV(a,c,d){c.componentOffset=d,(a.components??=[]).push(c.index)}function oV(a,c,d,g,w,i,A){let N=g.length,H=!1;for(let st=0;st<N;st++){let Se=g[st];!H&&Nh(Se)&&(H=!0,rV(a,d,st)),pB(b2(d,c),a,Se.type)}hV(d,a.data.length,N);for(let st=0;st<N;st++){let Se=g[st];Se.providersResolver&&Se.providersResolver(Se)}let ce=!1,be=!1,Pe=Q2(a,c,N,null);N>0&&(d.directiveToIndex=new Map);for(let st=0;st<N;st++){let Se=g[st];if(d.mergedAttrs=mx(d.mergedAttrs,Se.hostAttrs),aV(a,d,c,Pe,Se),uV(Pe,Se,w),A!==null&&A.has(Se)){let[Lt,hn]=A.get(Se);d.directiveToIndex.set(Se.type,[Pe,Lt+d.directiveStart,hn+d.directiveStart])}else(i===null||!i.has(Se))&&d.directiveToIndex.set(Se.type,Pe);Se.contentQueries!==null&&(d.flags|=4),(Se.hostBindings!==null||Se.hostAttrs!==null||Se.hostVars!==0)&&(d.flags|=64);let It=Se.type.prototype;!ce&&(It.ngOnChanges||It.ngOnInit||It.ngDoCheck)&&((a.preOrderHooks??=[]).push(d.index),ce=!0),!be&&(It.ngOnChanges||It.ngDoCheck)&&((a.preOrderCheckHooks??=[]).push(d.index),be=!0),Pe++}sV(a,d,i)}function sV(a,c,d){for(let g=c.directiveStart;g<c.directiveEnd;g++){let w=a.data[g];if(d===null||!d.has(w))HR(0,c,w,g),HR(1,c,w,g),GR(c,g,!1);else{let i=d.get(w);$R(0,c,i,g),$R(1,c,i,g),GR(c,g,!0)}}}function HR(a,c,d,g){let w=a===0?d.inputs:d.outputs;for(let i in w)if(w.hasOwnProperty(i)){let A;a===0?A=c.inputs??={}:A=c.outputs??={},A[i]??=[],A[i].push(g),bP(c,i)}}function $R(a,c,d,g){let w=a===0?d.inputs:d.outputs;for(let i in w)if(w.hasOwnProperty(i)){let A=w[i],N;a===0?N=c.hostDirectiveInputs??={}:N=c.hostDirectiveOutputs??={},N[A]??=[],N[A].push(g,i),bP(c,A)}}function bP(a,c){c==="class"?a.flags|=8:c==="style"&&(a.flags|=16)}function GR(a,c,d){let{attrs:g,inputs:w,hostDirectiveInputs:i}=a;if(g===null||!d&&w===null||d&&i===null||jT(a)){a.initialInputs??=[],a.initialInputs.push(null);return}let A=null,N=0;for(;N<g.length;){let H=g[N];if(H===0){N+=4;continue}else if(H===5){N+=2;continue}else if(typeof H=="number")break;if(!d&&w.hasOwnProperty(H)){let ce=w[H];for(let be of ce)if(be===c){A??=[],A.push(H,g[N+1]);break}}else if(d&&i.hasOwnProperty(H)){let ce=i[H];for(let be=0;be<ce.length;be+=2)if(ce[be]===c){A??=[],A.push(ce[be+1],g[N+1]);break}}N+=2}a.initialInputs??=[],a.initialInputs.push(A)}function aV(a,c,d,g,w){a.data[g]=w;let i=w.factory||(w.factory=Jc(w.type,!0)),A=new Zg(i,Nh(w),sa,null);a.blueprint[g]=A,d[g]=A,lV(a,c,g,Q2(a,d,w.hostVars,Wa),w)}function lV(a,c,d,g,w){let i=w.hostBindings;if(i){let A=a.hostBindingOpCodes;A===null&&(A=a.hostBindingOpCodes=[]);let N=~c.index;cV(A)!=N&&A.push(N),A.push(d,g,i)}}function cV(a){let c=a.length;for(;c>0;){let d=a[--c];if(typeof d=="number"&&d<0)return d}return 0}function uV(a,c,d){if(d){if(c.exportAs)for(let g=0;g<c.exportAs.length;g++)d[c.exportAs[g]]=a;Nh(c)&&(d[""]=a)}}function hV(a,c,d){a.flags|=1,a.directiveStart=c,a.directiveEnd=c+d,a.providerIndexes=c}function wP(a,c,d,g,w,i,A,N){let H=c[xn],ce=H.consts,be=ou(ce,A),Pe=Tx(H,a,d,g,be);return i&&nV(H,c,Pe,ou(ce,N),w),Pe.mergedAttrs=mx(Pe.mergedAttrs,Pe.attrs),Pe.attrs!==null&&ix(Pe,Pe.attrs,!1),Pe.mergedAttrs!==null&&ix(Pe,Pe.mergedAttrs,!0),H.queries!==null&&H.queries.elementStart(H,Pe),Pe}function EP(a,c){rB(a,c),AE(c)&&a.queries.elementEnd(c)}function dV(a,c,d,g,w,i){let A=c.consts,N=ou(A,w),H=Tx(c,a,d,g,N);if(H.mergedAttrs=mx(H.mergedAttrs,H.attrs),i!=null){let ce=ou(A,i);H.localNames=[];for(let be=0;be<ce.length;be+=2)H.localNames.push(ce[be],-1)}return H.attrs!==null&&ix(H,H.attrs,!1),H.mergedAttrs!==null&&ix(H,H.mergedAttrs,!0),c.queries!==null&&c.queries.elementStart(c,H),H}function TP(a,c,d){return a[c]=d}function Bl(a,c,d){if(d===Wa)return!1;let g=a[c];return Object.is(g,d)?!1:(a[c]=d,!0)}function fV(a,c,d,g){let w=Bl(a,c,d);return Bl(a,c+1,g)||w}function W0(a,c,d){return function g(w){let i=ru(a)?Is(a.index,c):c;eI(i,5);let A=c[vr],N=qR(c,A,d,w),H=g.__ngNextListenerFn__;for(;H;)N=qR(c,A,H,w)&&N,H=H.__ngNextListenerFn__;return N}}function qR(a,c,d,g){let w=Nn(null);try{return qi(6,c,d),d(g)!==!1}catch(i){return S3(a,i),!1}finally{qi(7,c,d),Nn(w)}}function IP(a,c,d,g,w,i,A,N){let H=C0(a),ce=!1,be=null;if(!g&&H&&(be=pV(c,d,i,a.index)),be!==null){let Pe=be.__ngLastListenerFn__||be;Pe.__ngNextListenerFn__=A,be.__ngLastListenerFn__=A,ce=!0}else{let Pe=ia(a,d),st=g?g(Pe):Pe;AB(d,st,i,N);let Se=w.listen(st,i,N),It=g?Lt=>g(Ts(Lt[a.index])):a.index;SP(It,c,d,i,N,Se,!1)}return ce}function pV(a,c,d,g){let w=a.cleanup;if(w!=null)for(let i=0;i<w.length-1;i+=2){let A=w[i];if(A===d&&w[i+1]===g){let N=c[Gf],H=w[i+2];return N&&N.length>H?N[H]:null}typeof A=="string"&&(i+=2)}return null}function SP(a,c,d,g,w,i,A){let N=c.firstCreatePass?zE(c):null,H=NE(d),ce=H.length;H.push(w,i),N&&N.push(g,a,ce,(ce+1)*(A?-1:1))}function WR(a,c,d,g,w,i){let A=c[d],N=c[xn],ce=N.data[d].outputs[g],Pe=A[ce].subscribe(i);SP(a.index,N,c,w,i,Pe,!0)}var _T=Symbol("BINDING");var rx=class extends n_{ngModule;constructor(c){super(),this.ngModule=c}resolveComponentFactory(c){let d=tu(c);return new ip(d,this.ngModule)}};function mV(a){return Object.keys(a).map(c=>{let[d,g,w]=a[c],i={propName:d,templateName:c,isSignal:(g&bx.SignalBased)!==0};return w&&(i.transform=w),i})}function gV(a){return Object.keys(a).map(c=>({propName:a[c],templateName:c}))}function _V(a,c,d){let g=c instanceof $r?c:c?.injector;return g&&a.getStandaloneInjector!==null&&(g=a.getStandaloneInjector(g)||g),g?new gT(d,g):d}function yV(a){let c=a.get(Hh,null);if(c===null)throw new Qt(407,!1);let d=a.get(xP,null),g=a.get(Ol,null);return{rendererFactory:c,sanitizer:d,changeDetectionScheduler:g,ngReflect:!1}}function vV(a,c){let d=(a.selectors[0][0]||"div").toLowerCase();return Z2(c,d,d==="svg"?RE:d==="math"?sR:null)}var ip=class extends Ix{componentDef;ngModule;selector;componentType;ngContentSelectors;isBoundToModule;cachedInputs=null;cachedOutputs=null;get inputs(){return this.cachedInputs??=mV(this.componentDef.inputs),this.cachedInputs}get outputs(){return this.cachedOutputs??=gV(this.componentDef.outputs),this.cachedOutputs}constructor(c,d){super(),this.componentDef=c,this.ngModule=d,this.componentType=c.type,this.selector=$B(c.selectors),this.ngContentSelectors=c.ngContentSelectors??[],this.isBoundToModule=!!d}create(c,d,g,w,i,A){qi(22);let N=Nn(null);try{let H=this.componentDef,ce=xV(g,H,A,i),be=_V(H,w||this.ngModule,c),Pe=yV(be),st=Pe.rendererFactory.createRenderer(null,H),Se=g?f3(st,g,H.encapsulation,be):vV(H,st),It=A?.some(ZR)||i?.some(sn=>typeof sn!="function"&&sn.bindings.some(ZR)),Lt=HT(null,ce,null,512|J2(H),null,null,Pe,st,be,null,z2(Se,be,!0));Lt[Ar]=Se,O0(Lt);let hn=null;try{let sn=wP(Ar,Lt,2,"#host",()=>ce.directiveRegistry,!0,0);Se&&(K2(st,Se,sn),tp(Se,Lt)),rP(ce,Lt,sn),V2(ce,sn,Lt),EP(ce,sn),d!==void 0&&wV(sn,this.ngContentSelectors,d),hn=Is(sn.index,Lt),Lt[vr]=hn[vr],KT(ce,Lt,null)}catch(sn){throw hn!==null&&lT(hn),lT(Lt),sn}finally{qi(23),k0()}return new ox(this.componentType,Lt,!!It)}finally{Nn(N)}}};function xV(a,c,d,g){let w=a?["ng-version","20.1.6"]:GB(c.selectors[0]),i=null,A=null,N=0;if(d)for(let be of d)N+=be[_T].requiredVars,be.create&&(be.targetIdx=0,(i??=[]).push(be)),be.update&&(be.targetIdx=0,(A??=[]).push(be));if(g)for(let be=0;be<g.length;be++){let Pe=g[be];if(typeof Pe!="function")for(let st of Pe.bindings){N+=st[_T].requiredVars;let Se=be+1;st.create&&(st.targetIdx=Se,(i??=[]).push(st)),st.update&&(st.targetIdx=Se,(A??=[]).push(st))}}let H=[c];if(g)for(let be of g){let Pe=typeof be=="function"?be:be.type,st=TE(Pe);H.push(st)}return UT(0,null,bV(i,A),1,N,H,null,null,null,[w],null)}function bV(a,c){return!a&&!c?null:d=>{if(d&1&&a)for(let g of a)g.create();if(d&2&&c)for(let g of c)g.update()}}function ZR(a){let c=a[_T].kind;return c==="input"||c==="twoWay"}var ox=class extends vP{_rootLView;_hasInputBindings;instance;hostView;changeDetectorRef;componentType;location;previousInputValues=null;_tNode;constructor(c,d,g){super(),this._rootLView=d,this._hasInputBindings=g,this._tNode=Bg(d[xn],Ar),this.location=sp(this._tNode,d),this.instance=Is(this._tNode.index,d)[vr],this.hostView=this.changeDetectorRef=new lu(d,void 0),this.componentType=c}setInput(c,d){this._hasInputBindings;let g=this._tNode;if(this.previousInputValues??=new Map,this.previousInputValues.has(c)&&Object.is(this.previousInputValues.get(c),d))return;let w=this._rootLView,i=YT(g,w[xn],w,c,d);this.previousInputValues.set(c,d);let A=Is(g.index,w);eI(A,1)}get injector(){return new Uh(this._tNode,this._rootLView)}destroy(){this.hostView.destroy()}onDestroy(c){this.hostView.onDestroy(c)}};function wV(a,c,d){let g=a.projection=[];for(let w=0;w<c.length;w++){let i=d[w];g.push(i!=null&&i.length?Array.from(i):null)}}var qh=(()=>{class a{static __NG_ELEMENT_ID__=EV}return a})();function EV(){let a=po();return CP(a,gi())}var TV=qh,DP=class extends TV{_lContainer;_hostTNode;_hostLView;constructor(c,d,g){super(),this._lContainer=c,this._hostTNode=d,this._hostLView=g}get element(){return sp(this._hostTNode,this._hostLView)}get injector(){return new Uh(this._hostTNode,this._hostLView)}get parentInjector(){let c=kT(this._hostTNode,this._hostLView);if(y2(c)){let d=Y0(c,this._hostLView),g=X0(c),w=d[xn].data[g+8];return new Uh(w,d)}else return new Uh(null,this._hostLView)}clear(){for(;this.length>0;)this.remove(this.length-1)}get(c){let d=XR(this._lContainer);return d!==null&&d[c]||null}get length(){return this._lContainer.length-Gr}createEmbeddedView(c,d,g){let w,i;typeof g=="number"?w=g:g!=null&&(w=g.index,i=g.injector);let A=pT(this._lContainer,c.ssrId),N=c.createEmbeddedViewImpl(d||{},i,A);return this.insertImpl(N,w,nx(this._hostTNode,A)),N}createComponent(c,d,g,w,i,A,N){let H=c&&!Qz(c),ce;if(H)ce=d;else{let hn=d||{};ce=hn.index,g=hn.injector,w=hn.projectableNodes,i=hn.environmentInjector||hn.ngModuleRef,A=hn.directives,N=hn.bindings}let be=H?c:new ip(tu(c)),Pe=g||this.parentInjector;if(!i&&be.ngModule==null){let sn=(H?Pe:this.parentInjector).get($r,null);sn&&(i=sn)}let st=tu(be.componentType??{}),Se=pT(this._lContainer,st?.id??null),It=Se?.firstChild??null,Lt=be.create(Pe,w,It,i,A,N);return this.insertImpl(Lt.hostView,ce,nx(this._hostTNode,Se)),Lt}insert(c,d){return this.insertImpl(c,d,!0)}insertImpl(c,d,g){let w=c._lView;if(aR(w)){let N=this.indexOf(c);if(N!==-1)this.detach(N);else{let H=w[Mr],ce=new DP(H,H[Es],H[Mr]);ce.detach(ce.indexOf(c))}}let i=this._adjustIndex(d),A=this._lContainer;return tI(A,w,i,g),c.attachToViewContainerRef(),vE(tT(A),i,c),c}move(c,d){return this.insert(c,d)}indexOf(c){let d=XR(this._lContainer);return d!==null?d.indexOf(c):-1}remove(c){let d=this._adjustIndex(c,-1),g=Yg(this._lContainer,d);g&&(Lg(tT(this._lContainer),d),wx(g[xn],g))}detach(c){let d=this._adjustIndex(c,-1),g=Yg(this._lContainer,d);return g&&Lg(tT(this._lContainer),d)!=null?new lu(g):null}_adjustIndex(c,d=0){return c??this.length+d}};function XR(a){return a[zg]}function tT(a){return a[zg]||(a[zg]=[])}function CP(a,c){let d,g=c[a.index];return na(g)?d=g:(d=_P(g,c,null,a),c[a.index]=d,$T(c,d)),SV(d,c,a,g),new DP(d,a,c)}function IV(a,c){let d=a[nr],g=d.createComment(""),w=ia(c,a),i=d.parentNode(w);return tx(d,i,g,d.nextSibling(w),!1),g}var SV=MV,DV=()=>!1;function CV(a,c,d){return DV(a,c,d)}function MV(a,c,d,g){if(a[iu])return;let w;d.type&8?w=Ts(g):w=IV(c,d),a[iu]=w}var yT=class a{queryList;matches=null;constructor(c){this.queryList=c}clone(){return new a(this.queryList)}setDirty(){this.queryList.setDirty()}},vT=class a{queries;constructor(c=[]){this.queries=c}createEmbeddedView(c){let d=c.queries;if(d!==null){let g=c.contentQueries!==null?c.contentQueries[0]:d.length,w=[];for(let i=0;i<g;i++){let A=d.getByIndex(i),N=this.queries[A.indexInDeclarationView];w.push(N.clone())}return new a(w)}return null}insertView(c){this.dirtyQueriesWithMatches(c)}detachView(c){this.dirtyQueriesWithMatches(c)}finishViewCreation(c){this.dirtyQueriesWithMatches(c)}dirtyQueriesWithMatches(c){for(let d=0;d<this.queries.length;d++)RP(c,d).matches!==null&&this.queries[d].setDirty()}},xT=class{flags;read;predicate;constructor(c,d,g=null){this.flags=d,this.read=g,typeof c=="string"?this.predicate=FV(c):this.predicate=c}},bT=class a{queries;constructor(c=[]){this.queries=c}elementStart(c,d){for(let g=0;g<this.queries.length;g++)this.queries[g].elementStart(c,d)}elementEnd(c){for(let d=0;d<this.queries.length;d++)this.queries[d].elementEnd(c)}embeddedTView(c){let d=null;for(let g=0;g<this.length;g++){let w=d!==null?d.length:0,i=this.getByIndex(g).embeddedTView(c,w);i&&(i.indexInDeclarationView=g,d!==null?d.push(i):d=[i])}return d!==null?new a(d):null}template(c,d){for(let g=0;g<this.queries.length;g++)this.queries[g].template(c,d)}getByIndex(c){return this.queries[c]}get length(){return this.queries.length}track(c){this.queries.push(c)}},wT=class a{metadata;matches=null;indexInDeclarationView=-1;crossesNgTemplate=!1;_declarationNodeIndex;_appliesToNextNode=!0;constructor(c,d=-1){this.metadata=c,this._declarationNodeIndex=d}elementStart(c,d){this.isApplyingToNode(d)&&this.matchTNode(c,d)}elementEnd(c){this._declarationNodeIndex===c.index&&(this._appliesToNextNode=!1)}template(c,d){this.elementStart(c,d)}embeddedTView(c,d){return this.isApplyingToNode(c)?(this.crossesNgTemplate=!0,this.addMatch(-c.index,d),new a(this.metadata)):null}isApplyingToNode(c){if(this._appliesToNextNode&&(this.metadata.flags&1)!==1){let d=this._declarationNodeIndex,g=c.parent;for(;g!==null&&g.type&8&&g.index!==d;)g=g.parent;return d===(g!==null?g.index:-1)}return this._appliesToNextNode}matchTNode(c,d){let g=this.metadata.predicate;if(Array.isArray(g))for(let w=0;w<g.length;w++){let i=g[w];this.matchTNodeWithReadOption(c,d,AV(d,i)),this.matchTNodeWithReadOption(c,d,G0(d,c,i,!1,!1))}else g===np?d.type&4&&this.matchTNodeWithReadOption(c,d,-1):this.matchTNodeWithReadOption(c,d,G0(d,c,g,!1,!1))}matchTNodeWithReadOption(c,d,g){if(g!==null){let w=this.metadata.read;if(w!==null)if(w===cu||w===qh||w===np&&d.type&4)this.addMatch(d.index,-2);else{let i=G0(d,c,w,!1,!1);i!==null&&this.addMatch(d.index,i)}else this.addMatch(d.index,g)}}addMatch(c,d){this.matches===null?this.matches=[c,d]:this.matches.push(c,d)}};function AV(a,c){let d=a.localNames;if(d!==null){for(let g=0;g<d.length;g+=2)if(d[g]===c)return d[g+1]}return null}function RV(a,c){return a.type&11?sp(a,c):a.type&4?nI(a,c):null}function PV(a,c,d,g){return d===-1?RV(c,a):d===-2?LV(a,c,g):J0(a,a[xn],d,c)}function LV(a,c,d){if(d===cu)return sp(c,a);if(d===np)return nI(c,a);if(d===qh)return CP(c,a)}function MP(a,c,d,g){let w=c[Ha].queries[g];if(w.matches===null){let i=a.data,A=d.matches,N=[];for(let H=0;A!==null&&H<A.length;H+=2){let ce=A[H];if(ce<0)N.push(null);else{let be=i[ce];N.push(PV(c,be,A[H+1],d.metadata.read))}}w.matches=N}return w.matches}function ET(a,c,d,g){let w=a.queries.getByIndex(d),i=w.matches;if(i!==null){let A=MP(a,c,w,d);for(let N=0;N<i.length;N+=2){let H=i[N];if(H>0)g.push(A[N/2]);else{let ce=i[N+1],be=c[-H];for(let Pe=Gr;Pe<be.length;Pe++){let st=be[Pe];st[nu]===st[Mr]&&ET(st[xn],st,ce,g)}if(be[Fh]!==null){let Pe=be[Fh];for(let st=0;st<Pe.length;st++){let Se=Pe[st];ET(Se[xn],Se,ce,g)}}}}}return g}function AP(a,c){return a[Ha].queries[c].queryList}function OV(a,c,d){let g=new Q0((d&4)===4);return uR(a,c,g,g.destroy),(c[Ha]??=new vT).queries.push(new yT(g))-1}function kV(a,c,d){let g=as();return g.firstCreatePass&&(NV(g,new xT(a,c,d),-1),(c&2)===2&&(g.staticViewQueries=!0)),OV(g,gi(),c)}function FV(a){return a.split(",").map(c=>c.trim())}function NV(a,c,d){a.queries===null&&(a.queries=new bT),a.queries.track(new wT(c,d))}function RP(a,c){return a.queries.getByIndex(c)}function zV(a,c){let d=a[xn],g=RP(d,c);return g.crossesNgTemplate?ET(d,a,c,[]):MP(d,a,g,c)}function PP(a,c,d){let g,w=bg(()=>{g._dirtyCounter();let i=VV(g,a);if(c&&i===void 0)throw new Qt(-951,!1);return i});return g=w[Qr],g._dirtyCounter=dr(0),g._flatValue=void 0,w}function LP(a){return PP(!0,!1,a)}function OP(a){return PP(!0,!0,a)}function BV(a,c){let d=a[Qr];d._lView=gi(),d._queryIndex=c,d._queryList=AP(d._lView,c),d._queryList.onDirty(()=>d._dirtyCounter.update(g=>g+1))}function VV(a,c){let d=a._lView,g=a._queryIndex;if(d===void 0||g===void 0||d[Ln]&4)return c?void 0:Qs;let w=AP(d,g),i=zV(d,g);return w.reset(i,bB),c?w.first:w._changesDetected||a._flatValue===void 0?a._flatValue=w.toArray():a._flatValue}var YR=new Set;function i_(a){YR.has(a)||(YR.add(a),performance?.mark?.("mark_feature_usage",{detail:{feature:a}}))}var $h=class{},Dx=class{};var sx=class extends $h{ngModuleType;_parent;_bootstrapComponents=[];_r3Injector;instance;destroyCbs=[];componentFactoryResolver=new rx(this);constructor(c,d,g,w=!0){super(),this.ngModuleType=c,this._parent=d;let i=EE(c);this._bootstrapComponents=q2(i.bootstrap),this._r3Injector=ZE(c,d,[{provide:$h,useValue:this},{provide:n_,useValue:this.componentFactoryResolver},...g],Kc(c),new Set(["environment"])),w&&this.resolveInjectorInitializers()}resolveInjectorInitializers(){this._r3Injector.resolveInjectorInitializers(),this.instance=this._r3Injector.get(this.ngModuleType)}get injector(){return this._r3Injector}destroy(){let c=this._r3Injector;!c.destroyed&&c.destroy(),this.destroyCbs.forEach(d=>d()),this.destroyCbs=null}onDestroy(c){this.destroyCbs.push(c)}},ax=class extends Dx{moduleType;constructor(c){super(),this.moduleType=c}create(c){return new sx(this.moduleType,c,[])}};var Kg=class extends $h{injector;componentFactoryResolver=new rx(this);instance=null;constructor(c){super();let d=new Ah([...c.providers,{provide:$h,useValue:this},{provide:n_,useValue:this.componentFactoryResolver}],c.parent||Fg(),c.debugName,new Set(["environment"]));this.injector=d,c.runEnvironmentInitializers&&d.resolveInjectorInitializers()}destroy(){this.injector.destroy()}onDestroy(c){this.injector.onDestroy(c)}};function r_(a,c,d=null){return new Kg({providers:a,parent:c,debugName:d,runEnvironmentInitializers:!0}).injector}var jV=(()=>{class a{_injector;cachedInjectors=new Map;constructor(d){this._injector=d}getOrCreateStandaloneInjector(d){if(!d.standalone)return null;if(!this.cachedInjectors.has(d)){let g=IE(!1,d.type),w=g.length>0?r_([g],this._injector,`Standalone[${d.type.name}]`):null;this.cachedInjectors.set(d,w)}return this.cachedInjectors.get(d)}ngOnDestroy(){try{for(let d of this.cachedInjectors.values())d!==null&&d.destroy()}finally{this.cachedInjectors.clear()}}static \u0275prov=Tn({token:a,providedIn:"environment",factory:()=>new a($n($r))})}return a})();function Ao(a){return px(()=>{let c=kP(a),d=Oi(Wt({},c),{decls:a.decls,vars:a.vars,template:a.template,consts:a.consts||null,ngContentSelectors:a.ngContentSelectors,onPush:a.changeDetection===FT.OnPush,directiveDefs:null,pipeDefs:null,dependencies:c.standalone&&a.dependencies||null,getStandaloneInjector:c.standalone?w=>w.get(jV).getOrCreateStandaloneInjector(d):null,getExternalStyles:null,signals:a.signals??!1,data:a.data||{},encapsulation:a.encapsulation||zl.Emulated,styles:a.styles||Qs,_:null,schemas:a.schemas||null,tView:null,id:""});c.standalone&&i_("NgStandalone"),FP(d);let g=a.dependencies;return d.directiveDefs=KR(g,UV),d.pipeDefs=KR(g,QA),d.id=GV(d),d})}function UV(a){return tu(a)||TE(a)}function HV(a,c){if(a==null)return Ph;let d={};for(let g in a)if(a.hasOwnProperty(g)){let w=a[g],i,A,N,H;Array.isArray(w)?(N=w[0],i=w[1],A=w[2]??i,H=w[3]||null):(i=w,A=w,N=bx.None,H=null),d[i]=[g,N,H],c[i]=A}return d}function $V(a){if(a==null)return Ph;let c={};for(let d in a)a.hasOwnProperty(d)&&(c[a[d]]=d);return c}function lp(a){return px(()=>{let c=kP(a);return FP(c),c})}function Cx(a){return{type:a.type,name:a.name,factory:null,pure:a.pure!==!1,standalone:a.standalone??!0,onDestroy:a.type.prototype.ngOnDestroy||null}}function kP(a){let c={};return{type:a.type,providersResolver:null,factory:null,hostBindings:a.hostBindings||null,hostVars:a.hostVars||0,hostAttrs:a.hostAttrs||null,contentQueries:a.contentQueries||null,declaredInputs:c,inputConfig:a.inputs||Ph,exportAs:a.exportAs||null,standalone:a.standalone??!0,signals:a.signals===!0,selectors:a.selectors||Qs,viewQuery:a.viewQuery||null,features:a.features||null,setInput:null,resolveHostDirectives:null,hostDirectives:null,inputs:HV(a.inputs,c),outputs:$V(a.outputs),debugInfo:null}}function FP(a){a.features?.forEach(c=>c(a))}function KR(a,c){return a?()=>{let d=typeof a=="function"?a():a,g=[];for(let w of d){let i=c(w);i!==null&&g.push(i)}return g}:null}function GV(a){let c=0,d=typeof a.consts=="function"?"":a.consts,g=[a.selectors,a.ngContentSelectors,a.hostVars,a.hostAttrs,d,a.vars,a.decls,a.encapsulation,a.standalone,a.signals,a.exportAs,JSON.stringify(a.inputs),JSON.stringify(a.outputs),Object.getOwnPropertyNames(a.type.prototype),!!a.contentQueries,!!a.viewQuery];for(let i of g.join("|"))c=Math.imul(31,c)+i.charCodeAt(0)<<0;return c+=2147483648,"c"+c}function qV(a,c,d,g,w,i,A,N){if(d.firstCreatePass){a.mergedAttrs=mx(a.mergedAttrs,a.attrs);let be=a.tView=UT(2,a,w,i,A,d.directiveRegistry,d.pipeRegistry,null,d.schemas,d.consts,null);d.queries!==null&&(d.queries.template(d,a),be.queries=d.queries.embeddedTView(a))}N&&(a.flags|=N),Yf(a,!1);let H=WV(d,c,a,g);B0()&&WT(d,c,H,a),tp(H,c);let ce=_P(H,c,H,a);c[g+Ar]=ce,$T(c,ce),CV(ce,a,c)}function JR(a,c,d,g,w,i,A,N,H,ce,be){let Pe=d+Ar,st;if(c.firstCreatePass){if(st=Tx(c,Pe,4,A||null,N||null),ce!=null){let Se=ou(c.consts,ce);st.localNames=[];for(let It=0;It<Se.length;It+=2)st.localNames.push(Se[It],-1)}}else st=c.data[Pe];return qV(st,a,c,d,g,w,i,H),ce!=null&&XT(a,st,be),st}var WV=ZV;function ZV(a,c,d,g){return V0(!0),c[nr].createComment("")}var iI=function(a){return a[a.CHANGE_DETECTION=0]="CHANGE_DETECTION",a[a.AFTER_NEXT_RENDER=1]="AFTER_NEXT_RENDER",a}(iI||{}),o_=new En(""),NP=!1,TT=class extends Dr{__isAsync;destroyRef=void 0;pendingTasks=void 0;constructor(c=!1){super(),this.__isAsync=c,rR()&&(this.destroyRef=At(ra,{optional:!0})??void 0,this.pendingTasks=At(Nl,{optional:!0})??void 0)}emit(c){let d=Nn(null);try{super.next(c)}finally{Nn(d)}}subscribe(c,d,g){let w=c,i=d||(()=>null),A=g;if(c&&typeof c=="object"){let H=c;w=H.next?.bind(H),i=H.error?.bind(H),A=H.complete?.bind(H)}this.__isAsync&&(i=this.wrapInTimeout(i),w&&(w=this.wrapInTimeout(w)),A&&(A=this.wrapInTimeout(A)));let N=super.subscribe({next:w,error:i,complete:A});return c instanceof _r&&c.add(N),N}wrapInTimeout(c){return d=>{let g=this.pendingTasks?.add();setTimeout(()=>{try{c(d)}finally{g!==void 0&&this.pendingTasks?.remove(g)}})}}},Mo=TT;function zP(a){let c,d;function g(){a=Vh;try{d!==void 0&&typeof cancelAnimationFrame=="function"&&cancelAnimationFrame(d),c!==void 0&&clearTimeout(c)}catch{}}return c=setTimeout(()=>{a(),g()}),typeof requestAnimationFrame=="function"&&(d=requestAnimationFrame(()=>{a(),g()})),()=>g()}function QR(a){return queueMicrotask(()=>a()),()=>{a=Vh}}var rI="isAngularZone",lx=rI+"_ID",XV=0,Rr=class a{hasPendingMacrotasks=!1;hasPendingMicrotasks=!1;isStable=!0;onUnstable=new Mo(!1);onMicrotaskEmpty=new Mo(!1);onStable=new Mo(!1);onError=new Mo(!1);constructor(c){let{enableLongStackTrace:d=!1,shouldCoalesceEventChangeDetection:g=!1,shouldCoalesceRunChangeDetection:w=!1,scheduleInRootZone:i=NP}=c;if(typeof Zone>"u")throw new Qt(908,!1);Zone.assertZonePatched();let A=this;A._nesting=0,A._outer=A._inner=Zone.current,Zone.TaskTrackingZoneSpec&&(A._inner=A._inner.fork(new Zone.TaskTrackingZoneSpec)),d&&Zone.longStackTraceZoneSpec&&(A._inner=A._inner.fork(Zone.longStackTraceZoneSpec)),A.shouldCoalesceEventChangeDetection=!w&&g,A.shouldCoalesceRunChangeDetection=w,A.callbackScheduled=!1,A.scheduleInRootZone=i,JV(A)}static isInAngularZone(){return typeof Zone<"u"&&Zone.current.get(rI)===!0}static assertInAngularZone(){if(!a.isInAngularZone())throw new Qt(909,!1)}static assertNotInAngularZone(){if(a.isInAngularZone())throw new Qt(909,!1)}run(c,d,g){return this._inner.run(c,d,g)}runTask(c,d,g,w){let i=this._inner,A=i.scheduleEventTask("NgZoneEvent: "+w,c,YV,Vh,Vh);try{return i.runTask(A,d,g)}finally{i.cancelTask(A)}}runGuarded(c,d,g){return this._inner.runGuarded(c,d,g)}runOutsideAngular(c){return this._outer.run(c)}},YV={};function oI(a){if(a._nesting==0&&!a.hasPendingMicrotasks&&!a.isStable)try{a._nesting++,a.onMicrotaskEmpty.emit(null)}finally{if(a._nesting--,!a.hasPendingMicrotasks)try{a.runOutsideAngular(()=>a.onStable.emit(null))}finally{a.isStable=!0}}}function KV(a){if(a.isCheckStableRunning||a.callbackScheduled)return;a.callbackScheduled=!0;function c(){zP(()=>{a.callbackScheduled=!1,IT(a),a.isCheckStableRunning=!0,oI(a),a.isCheckStableRunning=!1})}a.scheduleInRootZone?Zone.root.run(()=>{c()}):a._outer.run(()=>{c()}),IT(a)}function JV(a){let c=()=>{KV(a)},d=XV++;a._inner=a._inner.fork({name:"angular",properties:{[rI]:!0,[lx]:d,[lx+d]:!0},onInvokeTask:(g,w,i,A,N,H)=>{if(QV(H))return g.invokeTask(i,A,N,H);try{return e2(a),g.invokeTask(i,A,N,H)}finally{(a.shouldCoalesceEventChangeDetection&&A.type==="eventTask"||a.shouldCoalesceRunChangeDetection)&&c(),t2(a)}},onInvoke:(g,w,i,A,N,H,ce)=>{try{return e2(a),g.invoke(i,A,N,H,ce)}finally{a.shouldCoalesceRunChangeDetection&&!a.callbackScheduled&&!ej(H)&&c(),t2(a)}},onHasTask:(g,w,i,A)=>{g.hasTask(i,A),w===i&&(A.change=="microTask"?(a._hasPendingMicrotasks=A.microTask,IT(a),oI(a)):A.change=="macroTask"&&(a.hasPendingMacrotasks=A.macroTask))},onHandleError:(g,w,i,A)=>(g.handleError(i,A),a.runOutsideAngular(()=>a.onError.emit(A)),!1)})}function IT(a){a._hasPendingMicrotasks||(a.shouldCoalesceEventChangeDetection||a.shouldCoalesceRunChangeDetection)&&a.callbackScheduled===!0?a.hasPendingMicrotasks=!0:a.hasPendingMicrotasks=!1}function e2(a){a._nesting++,a.isStable&&(a.isStable=!1,a.onUnstable.emit(null))}function t2(a){a._nesting--,oI(a)}var cx=class{hasPendingMicrotasks=!1;hasPendingMacrotasks=!1;isStable=!0;onUnstable=new Mo;onMicrotaskEmpty=new Mo;onStable=new Mo;onError=new Mo;run(c,d,g){return c.apply(d,g)}runGuarded(c,d,g){return c.apply(d,g)}runOutsideAngular(c){return c()}runTask(c,d,g,w){return c.apply(d,g)}};function QV(a){return BP(a,"__ignore_ng_zone__")}function ej(a){return BP(a,"__scheduler_tick__")}function BP(a,c){return!Array.isArray(a)||a.length!==1?!1:a[0]?.data?.[c]===!0}var VP=(()=>{class a{impl=null;execute(){this.impl?.execute()}static \u0275prov=Tn({token:a,providedIn:"root",factory:()=>new a})}return a})();var sI=(()=>{class a{log(d){console.log(d)}warn(d){console.warn(d)}static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:a.\u0275fac,providedIn:"platform"})}return a})();var aI=new En("");function cp(a){return!!a&&typeof a.then=="function"}function lI(a){return!!a&&typeof a.subscribe=="function"}var jP=new En("");var cI=(()=>{class a{resolve;reject;initialized=!1;done=!1;donePromise=new Promise((d,g)=>{this.resolve=d,this.reject=g});appInits=At(jP,{optional:!0})??[];injector=At(rs);constructor(){}runInitializers(){if(this.initialized)return;let d=[];for(let w of this.appInits){let i=Do(this.injector,w);if(cp(i))d.push(i);else if(lI(i)){let A=new Promise((N,H)=>{i.subscribe({complete:N,error:H})});d.push(A)}}let g=()=>{this.done=!0,this.resolve()};Promise.all(d).then(()=>{g()}).catch(w=>{this.reject(w)}),d.length===0&&g(),this.initialized=!0}static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),Mx=new En("");function UP(){Fw(()=>{let a="";throw new Qt(600,a)})}function HP(a){return a.isBoundToModule}var tj=10;var Wh=(()=>{class a{_runningTick=!1;_destroyed=!1;_destroyListeners=[];_views=[];internalErrorHandler=At(ls);afterRenderManager=At(VP);zonelessEnabled=At(Hg);rootEffectScheduler=At(Gg);dirtyFlags=0;tracingSnapshot=null;allTestViews=new Set;autoDetectTestViews=new Set;includeAllTestViews=!1;afterTick=new Dr;get allViews(){return[...(this.includeAllTestViews?this.allTestViews:this.autoDetectTestViews).keys(),...this._views]}get destroyed(){return this._destroyed}componentTypes=[];components=[];internalPendingTask=At(Nl);get isStable(){return this.internalPendingTask.hasPendingTasksObservable.pipe(fi(d=>!d))}constructor(){At(o_,{optional:!0})}whenStable(){let d;return new Promise(g=>{d=this.isStable.subscribe({next:w=>{w&&g()}})}).finally(()=>{d.unsubscribe()})}_injector=At($r);_rendererFactory=null;get injector(){return this._injector}bootstrap(d,g){return this.bootstrapImpl(d,g)}bootstrapImpl(d,g,w=rs.NULL){return this._injector.get(Rr).run(()=>{qi(10);let A=d instanceof Ix;if(!this._injector.get(cI).done){let It="";throw new Qt(405,It)}let H;A?H=d:H=this._injector.get(n_).resolveComponentFactory(d),this.componentTypes.push(H.componentType);let ce=HP(H)?void 0:this._injector.get($h),be=g||H.selector,Pe=H.create(w,[],be,ce),st=Pe.location.nativeElement,Se=Pe.injector.get(aI,null);return Se?.registerApplication(st),Pe.onDestroy(()=>{this.detachView(Pe.hostView),Wg(this.components,Pe),Se?.unregisterApplication(st)}),this._loadComponent(Pe),qi(11,Pe),Pe})}tick(){this.zonelessEnabled||(this.dirtyFlags|=1),this._tick()}_tick(){qi(12),this.tracingSnapshot!==null?this.tracingSnapshot.run(iI.CHANGE_DETECTION,this.tickImpl):this.tickImpl()}tickImpl=()=>{if(this._runningTick)throw new Qt(101,!1);let d=Nn(null);try{this._runningTick=!0,this.synchronize()}finally{this._runningTick=!1,this.tracingSnapshot?.dispose(),this.tracingSnapshot=null,Nn(d),this.afterTick.next(),qi(13)}};synchronize(){this._rendererFactory===null&&!this._injector.destroyed&&(this._rendererFactory=this._injector.get(Hh,null,{optional:!0}));let d=0;for(;this.dirtyFlags!==0&&d++<tj;)qi(14),this.synchronizeOnce(),qi(15)}synchronizeOnce(){this.dirtyFlags&16&&(this.dirtyFlags&=-17,this.rootEffectScheduler.flush());let d=!1;if(this.dirtyFlags&7){let g=!!(this.dirtyFlags&1);this.dirtyFlags&=-8,this.dirtyFlags|=8;for(let{_lView:w}of this.allViews){if(!g&&!Vg(w))continue;let i=g&&!this.zonelessEnabled?0:1;QT(w,i),d=!0}if(this.dirtyFlags&=-5,this.syncDirtyFlagsWithViews(),this.dirtyFlags&23)return}d||(this._rendererFactory?.begin?.(),this._rendererFactory?.end?.()),this.dirtyFlags&8&&(this.dirtyFlags&=-9,this.afterRenderManager.execute()),this.syncDirtyFlagsWithViews()}syncDirtyFlagsWithViews(){if(this.allViews.some(({_lView:d})=>Vg(d))){this.dirtyFlags|=2;return}else this.dirtyFlags&=-8}attachView(d){let g=d;this._views.push(g),g.attachToAppRef(this)}detachView(d){let g=d;Wg(this._views,g),g.detachFromAppRef()}_loadComponent(d){this.attachView(d.hostView);try{this.tick()}catch(w){this.internalErrorHandler(w)}this.components.push(d),this._injector.get(Mx,[]).forEach(w=>w(d))}ngOnDestroy(){if(!this._destroyed)try{this._destroyListeners.forEach(d=>d()),this._views.slice().forEach(d=>d.destroy())}finally{this._destroyed=!0,this._views=[],this._destroyListeners=[]}}onDestroy(d){return this._destroyListeners.push(d),()=>Wg(this._destroyListeners,d)}destroy(){if(this._destroyed)throw new Qt(406,!1);let d=this._injector;d.destroy&&!d.destroyed&&d.destroy()}get viewCount(){return this._views.length}static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function Wg(a,c){let d=a.indexOf(c);d>-1&&a.splice(d,1)}function Ax(a,c,d,g){let w=gi(),i=Jf();if(Bl(w,i,c)){let A=as(),N=F0();E3(N,w,a,c,d,g)}return Ax}var ST=class{destroy(c){}updateValue(c,d){}swap(c,d){let g=Math.min(c,d),w=Math.max(c,d),i=this.detach(w);if(w-g>1){let A=this.detach(g);this.attach(g,i),this.attach(w,A)}else this.attach(g,i)}move(c,d){this.attach(d,this.detach(c))}};function nT(a,c,d,g,w){return a===d&&Object.is(c,g)?1:Object.is(w(a,c),w(d,g))?-1:0}function nj(a,c,d){let g,w,i=0,A=a.length-1,N=void 0;if(Array.isArray(c)){let H=c.length-1;for(;i<=A&&i<=H;){let ce=a.at(i),be=c[i],Pe=nT(i,ce,i,be,d);if(Pe!==0){Pe<0&&a.updateValue(i,be),i++;continue}let st=a.at(A),Se=c[H],It=nT(A,st,H,Se,d);if(It!==0){It<0&&a.updateValue(A,Se),A--,H--;continue}let Lt=d(i,ce),hn=d(A,st),sn=d(i,be);if(Object.is(sn,hn)){let Yi=d(H,Se);Object.is(Yi,Lt)?(a.swap(i,A),a.updateValue(A,Se),H--,A--):a.move(A,i),a.updateValue(i,be),i++;continue}if(g??=new ux,w??=i2(a,i,A,d),DT(a,g,i,sn))a.updateValue(i,be),i++,A++;else if(w.has(sn))g.set(Lt,a.detach(i)),A--;else{let Yi=a.create(i,c[i]);a.attach(i,Yi),i++,A++}}for(;i<=H;)n2(a,g,d,i,c[i]),i++}else if(c!=null){let H=c[Symbol.iterator](),ce=H.next();for(;!ce.done&&i<=A;){let be=a.at(i),Pe=ce.value,st=nT(i,be,i,Pe,d);if(st!==0)st<0&&a.updateValue(i,Pe),i++,ce=H.next();else{g??=new ux,w??=i2(a,i,A,d);let Se=d(i,Pe);if(DT(a,g,i,Se))a.updateValue(i,Pe),i++,A++,ce=H.next();else if(!w.has(Se))a.attach(i,a.create(i,Pe)),i++,A++,ce=H.next();else{let It=d(i,be);g.set(It,a.detach(i)),A--}}}for(;!ce.done;)n2(a,g,d,a.length,ce.value),ce=H.next()}for(;i<=A;)a.destroy(a.detach(A--));g?.forEach(H=>{a.destroy(H)})}function DT(a,c,d,g){return c!==void 0&&c.has(g)?(a.attach(d,c.get(g)),c.delete(g),!0):!1}function n2(a,c,d,g,w){if(DT(a,c,g,d(g,w)))a.updateValue(g,w);else{let i=a.create(g,w);a.attach(g,i)}}function i2(a,c,d,g){let w=new Set;for(let i=c;i<=d;i++)w.add(g(i,a.at(i)));return w}var ux=class{kvMap=new Map;_vMap=void 0;has(c){return this.kvMap.has(c)}delete(c){if(!this.has(c))return!1;let d=this.kvMap.get(c);return this._vMap!==void 0&&this._vMap.has(d)?(this.kvMap.set(c,this._vMap.get(d)),this._vMap.delete(d)):this.kvMap.delete(c),!0}get(c){return this.kvMap.get(c)}set(c,d){if(this.kvMap.has(c)){let g=this.kvMap.get(c);this._vMap===void 0&&(this._vMap=new Map);let w=this._vMap;for(;w.has(g);)g=w.get(g);w.set(g,d)}else this.kvMap.set(c,d)}forEach(c){for(let[d,g]of this.kvMap)if(c(g,d),this._vMap!==void 0){let w=this._vMap;for(;w.has(g);)g=w.get(g),c(g,d)}}};var CT=class{lContainer;$implicit;$index;constructor(c,d,g){this.lContainer=c,this.$implicit=d,this.$index=g}get $count(){return this.lContainer.length-Gr}};function uI(a){return a}var MT=class{hasEmptyBlock;trackByFn;liveCollection;constructor(c,d,g){this.hasEmptyBlock=c,this.trackByFn=d,this.liveCollection=g}};function uu(a,c,d,g,w,i,A,N,H,ce,be,Pe,st){i_("NgControlFlow");let Se=gi(),It=as(),Lt=H!==void 0,hn=gi(),sn=N?A.bind(hn[os][vr]):A,Yi=new MT(Lt,sn);hn[Ar+a]=Yi,JR(Se,It,a+1,c,d,g,w,ou(It.consts,i),256),Lt&&JR(Se,It,a+2,H,ce,be,Pe,ou(It.consts,st),512)}var AT=class extends ST{lContainer;hostLView;templateTNode;operationsCounter=void 0;needsIndexUpdate=!1;constructor(c,d,g){super(),this.lContainer=c,this.hostLView=d,this.templateTNode=g}get length(){return this.lContainer.length-Gr}at(c){return this.getLView(c)[vr].$implicit}attach(c,d){let g=d[$f];this.needsIndexUpdate||=c!==this.length,tI(this.lContainer,d,c,nx(this.templateTNode,g))}detach(c){return this.needsIndexUpdate||=c!==this.length-1,ij(this.lContainer,c)}create(c,d){let g=pT(this.lContainer,this.templateTNode.tView.ssrId),w=JT(this.hostLView,this.templateTNode,new CT(this.lContainer,d,c),{dehydratedView:g});return this.operationsCounter?.recordCreate(),w}destroy(c){wx(c[xn],c),this.operationsCounter?.recordDestroy()}updateValue(c,d){this.getLView(c)[vr].$implicit=d}reset(){this.needsIndexUpdate=!1,this.operationsCounter?.reset()}updateIndexes(){if(this.needsIndexUpdate)for(let c=0;c<this.length;c++)this.getLView(c)[vr].$index=c}getLView(c){return rj(this.lContainer,c)}};function hu(a){let c=Nn(null),d=su();try{let g=gi(),w=g[xn],i=g[d],A=d+1,N=r2(g,A);if(i.liveCollection===void 0){let ce=o2(w,A);i.liveCollection=new AT(N,g,ce)}else i.liveCollection.reset();let H=i.liveCollection;if(nj(H,a,i.trackByFn),H.updateIndexes(),i.hasEmptyBlock){let ce=Jf(),be=H.length===0;if(Bl(g,ce,be)){let Pe=d+2,st=r2(g,Pe);if(be){let Se=o2(w,Pe),It=eV(st,Se,g),Lt=JT(g,Se,void 0,{dehydratedView:It});tI(st,Lt,0,nx(Se,It))}else w.firstUpdatePass&&Y3(st),$3(st,0)}}}finally{Nn(c)}}function r2(a,c){return a[c]}function ij(a,c){return Yg(a,c)}function rj(a,c){return H3(a,c)}function o2(a,c){return Bg(a,c)}function up(a,c,d){let g=gi(),w=Jf();if(Bl(g,w,c)){let i=as(),A=F0();_3(A,g,a,c,g[nr],d)}return up}function RT(a,c,d,g,w){YT(c,a,d,w?"class":"style",g)}function qr(a,c,d,g){let w=gi(),i=w[xn],A=a+Ar,N=i.firstCreatePass?wP(A,w,2,c,w3,fR(),d,g):i.data[A];if(sP(N,w,a,c,$P),C0(N)){let H=w[xn];rP(H,w,N),V2(H,N,w)}return g!=null&&XT(w,N),qr}function mo(){let a=as(),c=po(),d=aP(c);return a.firstCreatePass&&EP(a,d),VE(d)&&jE(),BE(),d.classesWithoutHost!=null&&sB(d)&&RT(a,d,gi(),d.classesWithoutHost,!0),d.stylesWithoutHost!=null&&aB(d)&&RT(a,d,gi(),d.stylesWithoutHost,!1),mo}function Za(a,c,d,g){return qr(a,c,d,g),mo(),Za}function go(a,c,d,g){let w=gi(),i=w[xn],A=a+Ar,N=i.firstCreatePass?dV(A,i,2,c,d,g):i.data[A];return sP(N,w,a,c,$P),g!=null&&XT(w,N),go}function $o(){let a=po(),c=aP(a);return VE(c)&&jE(),BE(),$o}function Vl(a,c,d,g){return go(a,c,d,g),$o(),Vl}var $P=(a,c,d,g,w)=>(V0(!0),Z2(c[nr],g,MR()));function s_(){return gi()}function Rx(a,c,d){let g=gi(),w=Jf();if(Bl(g,w,c)){let i=as(),A=F0();oP(A,g,a,c,g[nr],d)}return Rx}var jh=void 0;function oj(a){let c=Math.floor(Math.abs(a)),d=a.toString().replace(/^[^.]*\.?/,"").length;return c===1&&d===0?1:5}var sj=["en",[["a","p"],["AM","PM"],jh],[["AM","PM"],jh,jh],[["S","M","T","W","T","F","S"],["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],["Su","Mo","Tu","We","Th","Fr","Sa"]],jh,[["J","F","M","A","M","J","J","A","S","O","N","D"],["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],["January","February","March","April","May","June","July","August","September","October","November","December"]],jh,[["B","A"],["BC","AD"],["Before Christ","Anno Domini"]],0,[6,0],["M/d/yy","MMM d, y","MMMM d, y","EEEE, MMMM d, y"],["h:mm a","h:mm:ss a","h:mm:ss a z","h:mm:ss a zzzz"],["{1}, {0}",jh,"{1} 'at' {0}",jh],[".",",",";","%","+","-","E","\xD7","\u2030","\u221E","NaN",":"],["#,##0.###","#,##0%","\xA4#,##0.00","#E0"],"USD","$","US Dollar",{},"ltr",oj],iT={};function Px(a){let c=aj(a),d=s2(c);if(d)return d;let g=c.split("-")[0];if(d=s2(g),d)return d;if(g==="en")return sj;throw new Qt(701,!1)}function s2(a){return a in iT||(iT[a]=kl.ng&&kl.ng.common&&kl.ng.common.locales&&kl.ng.common.locales[a]),iT[a]}var Zh=function(a){return a[a.LocaleId=0]="LocaleId",a[a.DayPeriodsFormat=1]="DayPeriodsFormat",a[a.DayPeriodsStandalone=2]="DayPeriodsStandalone",a[a.DaysFormat=3]="DaysFormat",a[a.DaysStandalone=4]="DaysStandalone",a[a.MonthsFormat=5]="MonthsFormat",a[a.MonthsStandalone=6]="MonthsStandalone",a[a.Eras=7]="Eras",a[a.FirstDayOfWeek=8]="FirstDayOfWeek",a[a.WeekendRange=9]="WeekendRange",a[a.DateFormat=10]="DateFormat",a[a.TimeFormat=11]="TimeFormat",a[a.DateTimeFormat=12]="DateTimeFormat",a[a.NumberSymbols=13]="NumberSymbols",a[a.NumberFormats=14]="NumberFormats",a[a.CurrencyCode=15]="CurrencyCode",a[a.CurrencySymbol=16]="CurrencySymbol",a[a.CurrencyName=17]="CurrencyName",a[a.Currencies=18]="Currencies",a[a.Directionality=19]="Directionality",a[a.PluralCase=20]="PluralCase",a[a.ExtraData=21]="ExtraData",a}(Zh||{});function aj(a){return a.toLowerCase().replace(/_/g,"-")}var a_="en-US";var lj=a_;function GP(a){typeof a=="string"&&(lj=a.toLowerCase().replace(/_/g,"-"))}function Lx(a,c,d){let g=gi(),w=as(),i=po();return cj(w,g,g[nr],i,a,c,d),Lx}function hp(a,c,d){let g=gi(),w=as(),i=po();return(i.type&3||d)&&IP(i,w,g,d,g[nr],a,c,W0(i,g,c)),hp}function cj(a,c,d,g,w,i,A){let N=!0,H=null;if((g.type&3||A)&&(H??=W0(g,c,i),IP(g,a,c,A,d,w,i,H)&&(N=!1)),N){let ce=g.outputs?.[w],be=g.hostDirectiveOutputs?.[w];if(be&&be.length)for(let Pe=0;Pe<be.length;Pe+=2){let st=be[Pe],Se=be[Pe+1];H??=W0(g,c,i),WR(g,c,st,Se,w,H)}if(ce&&ce.length)for(let Pe of ce)H??=W0(g,c,i),WR(g,c,Pe,w,w,H)}}function hI(a=1){return CR(a)}function Xh(a,c,d,g){BV(a,kV(c,d,g))}function Yh(a=1){L0(TR()+a)}function dI(a){let c=_R();return M0(c,Ar+a)}function U0(a,c){return a<<17|c<<2}function Gh(a){return a>>17&32767}function uj(a){return(a&2)==2}function hj(a,c){return a&131071|c<<17}function PT(a){return a|2}function rp(a){return(a&131068)>>2}function rT(a,c){return a&-131069|c<<2}function dj(a){return(a&1)===1}function LT(a){return a|1}function fj(a,c,d,g,w,i){let A=i?c.classBindings:c.styleBindings,N=Gh(A),H=rp(A);a[g]=d;let ce=!1,be;if(Array.isArray(d)){let Pe=d;be=Pe[1],(be===null||Hf(Pe,be)>0)&&(ce=!0)}else be=d;if(w)if(H!==0){let st=Gh(a[N+1]);a[g+1]=U0(st,N),st!==0&&(a[st+1]=rT(a[st+1],g)),a[N+1]=hj(a[N+1],g)}else a[g+1]=U0(N,0),N!==0&&(a[N+1]=rT(a[N+1],g)),N=g;else a[g+1]=U0(H,0),N===0?N=g:a[H+1]=rT(a[H+1],g),H=g;ce&&(a[g+1]=PT(a[g+1])),a2(a,be,g,!0),a2(a,be,g,!1),pj(c,be,a,g,i),A=U0(N,H),i?c.classBindings=A:c.styleBindings=A}function pj(a,c,d,g,w){let i=w?a.residualClasses:a.residualStyles;i!=null&&typeof c=="string"&&Hf(i,c)>=0&&(d[g+1]=LT(d[g+1]))}function a2(a,c,d,g){let w=a[d+1],i=c===null,A=g?Gh(w):rp(w),N=!1;for(;A!==0&&(N===!1||i);){let H=a[A],ce=a[A+1];mj(H,c)&&(N=!0,a[A+1]=g?LT(ce):PT(ce)),A=g?Gh(ce):rp(ce)}N&&(a[d+1]=g?PT(w):LT(w))}function mj(a,c){return a===null||c==null||(Array.isArray(a)?a[1]:a)===c?!0:Array.isArray(a)&&typeof c=="string"?Hf(a,c)>=0:!1}var Co={textEnd:0,key:0,keyEnd:0,value:0,valueEnd:0};function gj(a){return a.substring(Co.key,Co.keyEnd)}function _j(a){return a.substring(Co.value,Co.valueEnd)}function yj(a){return vj(a),qP(a,hx(a,0,Co.textEnd))}function qP(a,c){let d=Co.textEnd,g=Co.key=hx(a,c,d);return d===g?-1:(g=Co.keyEnd=xj(a,g,d),g=l2(a,g,d,58),g=Co.value=hx(a,g,d),g=Co.valueEnd=bj(a,g,d),l2(a,g,d,59))}function vj(a){Co.key=0,Co.keyEnd=0,Co.value=0,Co.valueEnd=0,Co.textEnd=a.length}function hx(a,c,d){for(;c<d&&a.charCodeAt(c)<=32;)c++;return c}function xj(a,c,d){let g;for(;c<d&&((g=a.charCodeAt(c))===45||g===95||(g&-33)>=65&&(g&-33)<=90||g>=48&&g<=57);)c++;return c}function l2(a,c,d,g){return c=hx(a,c,d),c<d&&c++,c}function bj(a,c,d){let g=-1,w=-1,i=-1,A=c,N=A;for(;A<d;){let H=a.charCodeAt(A++);if(H===59)return N;H===34||H===39?N=A=c2(a,H,A,d):c===A-4&&i===85&&w===82&&g===76&&H===40?N=A=c2(a,41,A,d):H>32&&(N=A),i=w,w=g,g=H&-33}return N}function c2(a,c,d,g){let w=-1,i=d;for(;i<g;){let A=a.charCodeAt(i++);if(A==c&&w!==92)return i;A==92&&w===92?w=0:w=A}throw new Error}function fI(a){Ej(ZP,wj,a,!1)}function wj(a,c){for(let d=yj(c);d>=0;d=qP(c,d))ZP(a,gj(c),_j(c))}function Ej(a,c,d,g){let w=as(),i=vR(2);w.firstUpdatePass&&Tj(w,null,i,g);let A=gi();if(d!==Wa&&Bl(A,i,d)){let N=w.data[su()];if(XP(N,g)&&!WP(w,i)){let H=g?N.classesWithoutHost:N.stylesWithoutHost;H!==null&&(d=x0(H,d||"")),RT(w,N,A,d,g)}else Aj(w,N,A,A[nr],A[i+1],A[i+1]=Mj(a,c,d),g,i)}}function WP(a,c){return c>=a.expandoStartIndex}function Tj(a,c,d,g){let w=a.data;if(w[d+1]===null){let i=w[su()],A=WP(a,d);XP(i,g)&&c===null&&!A&&(c=!1),c=Ij(w,i,c,g),fj(w,i,c,d,A,g)}}function Ij(a,c,d,g){let w=ER(a),i=g?c.residualClasses:c.residualStyles;if(w===null)(g?c.classBindings:c.styleBindings)===0&&(d=oT(null,a,c,d,g),d=Jg(d,c.attrs,g),i=null);else{let A=c.directiveStylingLast;if(A===-1||a[A]!==w)if(d=oT(w,a,c,d,g),i===null){let H=Sj(a,c,g);H!==void 0&&Array.isArray(H)&&(H=oT(null,a,c,H[1],g),H=Jg(H,c.attrs,g),Dj(a,c,g,H))}else i=Cj(a,c,g)}return i!==void 0&&(g?c.residualClasses=i:c.residualStyles=i),d}function Sj(a,c,d){let g=d?c.classBindings:c.styleBindings;if(rp(g)!==0)return a[Gh(g)]}function Dj(a,c,d,g){let w=d?c.classBindings:c.styleBindings;a[Gh(w)]=g}function Cj(a,c,d){let g,w=c.directiveEnd;for(let i=1+c.directiveStylingLast;i<w;i++){let A=a[i].hostAttrs;g=Jg(g,A,d)}return Jg(g,c.attrs,d)}function oT(a,c,d,g,w){let i=null,A=d.directiveEnd,N=d.directiveStylingLast;for(N===-1?N=d.directiveStart:N++;N<A&&(i=c[N],g=Jg(g,i.hostAttrs,w),i!==a);)N++;return a!==null&&(d.directiveStylingLast=N),g}function Jg(a,c,d){let g=d?1:2,w=-1;if(c!==null)for(let i=0;i<c.length;i++){let A=c[i];typeof A=="number"?w=A:w===g&&(Array.isArray(a)||(a=a===void 0?[]:["",a]),xE(a,A,d?!0:c[++i]))}return a===void 0?null:a}function Mj(a,c,d){if(d==null||d==="")return Qs;let g=[],w=t_(d);if(Array.isArray(w))for(let i=0;i<w.length;i++)a(g,w[i],!0);else if(typeof w=="object")for(let i in w)w.hasOwnProperty(i)&&a(g,i,w[i]);else typeof w=="string"&&c(g,w);return g}function ZP(a,c,d){xE(a,c,t_(d))}function Aj(a,c,d,g,w,i,A,N){w===Wa&&(w=Qs);let H=0,ce=0,be=0<w.length?w[0]:null,Pe=0<i.length?i[0]:null;for(;be!==null||Pe!==null;){let st=H<w.length?w[H+1]:void 0,Se=ce<i.length?i[ce+1]:void 0,It=null,Lt;be===Pe?(H+=2,ce+=2,st!==Se&&(It=Pe,Lt=Se)):Pe===null||be!==null&&be<Pe?(H+=2,It=be):(ce+=2,It=Pe,Lt=Se),It!==null&&Rj(a,c,d,g,It,Lt,A,N),be=H<w.length?w[H]:null,Pe=ce<i.length?i[ce]:null}}function Rj(a,c,d,g,w,i,A,N){if(!(c.type&3))return;let H=a.data,ce=H[N+1],be=dj(ce)?u2(H,c,d,w,rp(ce),A):void 0;if(!dx(be)){dx(i)||uj(ce)&&(i=u2(H,null,d,w,N,A));let Pe=PE(su(),d);d3(g,A,Pe,w,i)}}function u2(a,c,d,g,w,i){let A=c===null,N;for(;w>0;){let H=a[w],ce=Array.isArray(H),be=ce?H[1]:H,Pe=be===null,st=d[w+1];st===Wa&&(st=Pe?Qs:void 0);let Se=Pe?I0(st,g):be===g?st:void 0;if(ce&&!dx(Se)&&(Se=I0(H,g)),dx(Se)&&(N=Se,A))return N;let It=a[w+1];w=A?Gh(It):rp(It)}if(c!==null){let H=i?c.residualClasses:c.residualStyles;H!=null&&(N=I0(H,g))}return N}function dx(a){return a!==void 0}function XP(a,c){return(a.flags&(c?8:16))!==0}function xr(a,c=""){let d=gi(),g=as(),w=a+Ar,i=g.firstCreatePass?Tx(g,w,1,c,null):g.data[w],A=Pj(g,d,i,c,a);d[w]=A,B0()&&WT(g,d,A,i),Yf(i,!1)}var Pj=(a,c,d,g,w)=>(V0(!0),qB(c[nr],g));function Lj(a,c,d,g=""){return Bl(a,Jf(),d)?c+Pg(d)+g:Wa}function du(a){return Ss("",a),du}function Ss(a,c,d){let g=gi(),w=Lj(g,a,c,d);return w!==Wa&&Oj(g,su(),w),Ss}function Oj(a,c,d){let g=PE(c,a);WB(a[nr],g,d)}function pI(a,c,d,g){return KP(gi(),Ug(),a,c,d,g)}function mI(a,c,d,g,w){return JP(gi(),Ug(),a,c,d,g,w)}function YP(a,c){let d=a[c];return d===Wa?void 0:d}function KP(a,c,d,g,w,i){let A=c+d;return Bl(a,A,w)?TP(a,A+1,i?g.call(i,w):g(w)):YP(a,A+1)}function JP(a,c,d,g,w,i,A){let N=c+d;return fV(a,N,w,i)?TP(a,N+2,A?g.call(A,w,i):g(w,i)):YP(a,N+2)}function jl(a,c){let d=as(),g,w=a+Ar;d.firstCreatePass?(g=kj(c,d.pipeRegistry),d.data[w]=g,g.onDestroy&&(d.destroyHooks??=[]).push(w,g.onDestroy)):g=d.data[w];let i=g.factory||(g.factory=Jc(g.type,!0)),A,N=So(sa);try{let H=K0(!1),ce=i();return K0(H),LE(d,gi(),w,ce),ce}finally{So(N)}}function kj(a,c){if(c)for(let d=c.length-1;d>=0;d--){let g=c[d];if(a===g.name)return g}}function dp(a,c,d){let g=a+Ar,w=gi(),i=M0(w,g);return QP(w,g)?KP(w,Ug(),c,i.transform,d,i):i.transform(d)}function l_(a,c,d,g){let w=a+Ar,i=gi(),A=M0(i,w);return QP(i,w)?JP(i,Ug(),c,A.transform,d,g,A):A.transform(d,g)}function QP(a,c){return a[xn].data[c].pure}var fx=class{ngModuleFactory;componentFactories;constructor(c,d){this.ngModuleFactory=c,this.componentFactories=d}},gI=(()=>{class a{compileModuleSync(d){return new ax(d)}compileModuleAsync(d){return Promise.resolve(this.compileModuleSync(d))}compileModuleAndAllComponentsSync(d){let g=this.compileModuleSync(d),w=EE(d),i=q2(w.declarations).reduce((A,N)=>{let H=tu(N);return H&&A.push(new ip(H)),A},[]);return new fx(g,i)}compileModuleAndAllComponentsAsync(d){return Promise.resolve(this.compileModuleAndAllComponentsSync(d))}clearCache(){}clearCacheFor(d){}getModuleId(d){}static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();var Fj=(()=>{class a{zone=At(Rr);changeDetectionScheduler=At(Ol);applicationRef=At(Wh);applicationErrorHandler=At(ls);_onMicrotaskEmptySubscription;initialize(){this._onMicrotaskEmptySubscription||(this._onMicrotaskEmptySubscription=this.zone.onMicrotaskEmpty.subscribe({next:()=>{this.changeDetectionScheduler.runningTick||this.zone.run(()=>{try{this.applicationRef.dirtyFlags|=1,this.applicationRef._tick()}catch(d){this.applicationErrorHandler(d)}})}}))}ngOnDestroy(){this._onMicrotaskEmptySubscription?.unsubscribe()}static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),eL=new En("",{factory:()=>!1});function _I({ngZoneFactory:a,ignoreChangesOutsideZone:c,scheduleInRootZone:d}){return a??=()=>new Rr(Oi(Wt({},vI()),{scheduleInRootZone:d})),[{provide:Rr,useFactory:a},{provide:eu,multi:!0,useFactory:()=>{let g=At(Fj,{optional:!0});return()=>g.initialize()}},{provide:eu,multi:!0,useFactory:()=>{let g=At(Nj);return()=>{g.initialize()}}},c===!0?{provide:YE,useValue:!0}:[],{provide:KE,useValue:d??NP},{provide:ls,useFactory:()=>{let g=At(Rr),w=At($r),i;return A=>{g.runOutsideAngular(()=>{w.destroyed&&!i?setTimeout(()=>{throw A}):(i??=w.get(ea),i.handleError(A))})}}}]}function yI(a){let c=a?.ignoreChangesOutsideZone,d=a?.scheduleInRootZone,g=_I({ngZoneFactory:()=>{let w=vI(a);return w.scheduleInRootZone=d,w.shouldCoalesceEventChangeDetection&&i_("NgZone_CoalesceEvent"),new Rr(w)},ignoreChangesOutsideZone:c,scheduleInRootZone:d});return Og([{provide:eL,useValue:!0},{provide:Hg,useValue:!1},g])}function vI(a){return{enableLongStackTrace:!1,shouldCoalesceEventChangeDetection:a?.eventCoalescing??!1,shouldCoalesceRunChangeDetection:a?.runCoalescing??!1}}var Nj=(()=>{class a{subscription=new _r;initialized=!1;zone=At(Rr);pendingTasks=At(Nl);initialize(){if(this.initialized)return;this.initialized=!0;let d=null;!this.zone.isStable&&!this.zone.hasPendingMacrotasks&&!this.zone.hasPendingMicrotasks&&(d=this.pendingTasks.add()),this.zone.runOutsideAngular(()=>{this.subscription.add(this.zone.onStable.subscribe(()=>{Rr.assertNotInAngularZone(),queueMicrotask(()=>{d!==null&&!this.zone.hasPendingMacrotasks&&!this.zone.hasPendingMicrotasks&&(this.pendingTasks.remove(d),d=null)})}))}),this.subscription.add(this.zone.onUnstable.subscribe(()=>{Rr.assertInAngularZone(),d??=this.pendingTasks.add()}))}ngOnDestroy(){this.subscription.unsubscribe()}static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();var tL=(()=>{class a{applicationErrorHandler=At(ls);appRef=At(Wh);taskService=At(Nl);ngZone=At(Rr);zonelessEnabled=At(Hg);tracing=At(o_,{optional:!0});disableScheduling=At(YE,{optional:!0})??!1;zoneIsDefined=typeof Zone<"u"&&!!Zone.root.run;schedulerTickApplyArgs=[{data:{__scheduler_tick__:!0}}];subscriptions=new _r;angularZoneId=this.zoneIsDefined?this.ngZone._inner?.get(lx):null;scheduleInRootZone=!this.zonelessEnabled&&this.zoneIsDefined&&(At(KE,{optional:!0})??!1);cancelScheduledCallback=null;useMicrotaskScheduler=!1;runningTick=!1;pendingRenderTaskId=null;constructor(){this.subscriptions.add(this.appRef.afterTick.subscribe(()=>{this.runningTick||this.cleanup()})),this.subscriptions.add(this.ngZone.onUnstable.subscribe(()=>{this.runningTick||this.cleanup()})),this.disableScheduling||=!this.zonelessEnabled&&(this.ngZone instanceof cx||!this.zoneIsDefined)}notify(d){if(!this.zonelessEnabled&&d===5)return;let g=!1;switch(d){case 0:{this.appRef.dirtyFlags|=2;break}case 3:case 2:case 4:case 5:case 1:{this.appRef.dirtyFlags|=4;break}case 6:{this.appRef.dirtyFlags|=2,g=!0;break}case 12:{this.appRef.dirtyFlags|=16,g=!0;break}case 13:{this.appRef.dirtyFlags|=2,g=!0;break}case 11:{g=!0;break}case 9:case 8:case 7:case 10:default:this.appRef.dirtyFlags|=8}if(this.appRef.tracingSnapshot=this.tracing?.snapshot(this.appRef.tracingSnapshot)??null,!this.shouldScheduleTick(g))return;let w=this.useMicrotaskScheduler?QR:zP;this.pendingRenderTaskId=this.taskService.add(),this.scheduleInRootZone?this.cancelScheduledCallback=Zone.root.run(()=>w(()=>this.tick())):this.cancelScheduledCallback=this.ngZone.runOutsideAngular(()=>w(()=>this.tick()))}shouldScheduleTick(d){return!(this.disableScheduling&&!d||this.appRef.destroyed||this.pendingRenderTaskId!==null||this.runningTick||this.appRef._runningTick||!this.zonelessEnabled&&this.zoneIsDefined&&Zone.current.get(lx+this.angularZoneId))}tick(){if(this.runningTick||this.appRef.destroyed)return;if(this.appRef.dirtyFlags===0){this.cleanup();return}!this.zonelessEnabled&&this.appRef.dirtyFlags&7&&(this.appRef.dirtyFlags|=1);let d=this.taskService.add();try{this.ngZone.run(()=>{this.runningTick=!0,this.appRef._tick()},void 0,this.schedulerTickApplyArgs)}catch(g){this.taskService.remove(d),this.applicationErrorHandler(g)}finally{this.cleanup()}this.useMicrotaskScheduler=!0,QR(()=>{this.useMicrotaskScheduler=!1,this.taskService.remove(d)})}ngOnDestroy(){this.subscriptions.unsubscribe(),this.cleanup()}cleanup(){if(this.runningTick=!1,this.cancelScheduledCallback?.(),this.cancelScheduledCallback=null,this.pendingRenderTaskId!==null){let d=this.pendingRenderTaskId;this.pendingRenderTaskId=null,this.taskService.remove(d)}}static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function zj(){return typeof $localize<"u"&&$localize.locale||a_}var c_=new En("",{providedIn:"root",factory:()=>At(c_,{optional:!0,skipSelf:!0})||zj()});function u_(a){return HA(a)}function bI(a,c){return bg(a,c?.equal)}var xI=class{[Qr];constructor(c){this[Qr]=c}destroy(){this[Qr].destroy()}};function Ox(a,c){let d=c?.injector??At(rs),g=c?.manualCleanup!==!0?d.get(ra):null,w,i=d.get($g,null,{optional:!0}),A=d.get(Ol);return i!==null?(w=jj(i.view,A,a),g instanceof Ag&&g._lView===i.view&&(g=null)):w=Uj(a,d.get(Gg),A),w.injector=d,g!==null&&(w.onDestroyFn=g.onDestroy(()=>w.destroy())),new xI(w)}var nL=Oi(Wt({},qc),{consumerIsAlwaysLive:!0,consumerAllowSignalWrites:!0,dirty:!0,hasRun:!1,cleanupFns:void 0,zone:null,kind:"effect",onDestroyFn:Vh,run(){if(this.dirty=!1,this.hasRun&&!Sf(this))return;this.hasRun=!0;let a=g=>(this.cleanupFns??=[]).push(g),c=Wc(this),d=Kf(!1);try{this.maybeCleanup(),this.fn(a)}finally{Kf(d),Th(this,c)}},maybeCleanup(){if(!this.cleanupFns?.length)return;let a=Nn(null);try{for(;this.cleanupFns.length;)this.cleanupFns.pop()()}finally{this.cleanupFns=[],Nn(a)}}}),Bj=Oi(Wt({},nL),{consumerMarkedDirty(){this.scheduler.schedule(this),this.notifier.notify(12)},destroy(){Df(this),this.onDestroyFn(),this.maybeCleanup(),this.scheduler.remove(this)}}),Vj=Oi(Wt({},nL),{consumerMarkedDirty(){this.view[Ln]|=8192,Bh(this.view),this.notifier.notify(13)},destroy(){Df(this),this.onDestroyFn(),this.maybeCleanup(),this.view[Fl]?.delete(this)}});function jj(a,c,d){let g=Object.create(Vj);return g.view=a,g.zone=typeof Zone<"u"?Zone.current:null,g.notifier=c,g.fn=d,a[Fl]??=new Set,a[Fl].add(g),g.consumerMarkedDirty(g),g}function Uj(a,c,d){let g=Object.create(Bj);return g.fn=a,g.scheduler=c,g.notifier=d,g.zone=typeof Zone<"u"?Zone.current:null,g.scheduler.add(g),g.notifier.notify(12),g}var oL=Symbol("InputSignalNode#UNSET"),lU=Oi(Wt({},Wv),{transformFn:void 0,applyValueToInputSignal(a,c){Mf(a,c)}});function sL(a,c){let d=Object.create(lU);d.value=a,d.transformFn=c?.transform;function g(){if(If(d),d.value===oL){let w=null;throw new Qt(-950,w)}return d.value}return g[Qr]=d,g}var Fx=class{attributeName;constructor(c){this.attributeName=c}__NG_ELEMENT_ID__=()=>e_(this.attributeName);toString(){return`HostAttributeToken ${this.attributeName}`}},cU=new En("");cU.__NG_ELEMENT_ID__=a=>{let c=po();if(c===null)throw new Qt(204,!1);if(c.type&2)return c.value;if(a&8)return null;throw new Qt(204,!1)};function iL(a,c){return sL(a,c)}function uU(a){return sL(oL,a)}var zx=(iL.required=uU,iL);function rL(a,c){return LP(c)}function hU(a,c){return OP(c)}var pp=(rL.required=hU,rL);var wI=new En(""),dU=new En("");function h_(a){return!a.moduleRef}function fU(a){let c=h_(a)?a.r3Injector:a.moduleRef.injector,d=c.get(Rr);return d.run(()=>{h_(a)?a.r3Injector.resolveInjectorInitializers():a.moduleRef.resolveInjectorInitializers();let g=c.get(ls),w;if(d.runOutsideAngular(()=>{w=d.onError.subscribe({next:g})}),h_(a)){let i=()=>c.destroy(),A=a.platformInjector.get(wI);A.add(i),c.onDestroy(()=>{w.unsubscribe(),A.delete(i)})}else{let i=()=>a.moduleRef.destroy(),A=a.platformInjector.get(wI);A.add(i),a.moduleRef.onDestroy(()=>{Wg(a.allPlatformModules,a.moduleRef),w.unsubscribe(),A.delete(i)})}return mU(g,d,()=>{let i=c.get(Nl),A=i.add(),N=c.get(cI);return N.runInitializers(),N.donePromise.then(()=>{let H=c.get(c_,a_);if(GP(H||a_),!c.get(dU,!0))return h_(a)?c.get(Wh):(a.allPlatformModules.push(a.moduleRef),a.moduleRef);if(h_(a)){let be=c.get(Wh);return a.rootComponent!==void 0&&be.bootstrap(a.rootComponent),be}else return pU?.(a.moduleRef,a.allPlatformModules),a.moduleRef}).finally(()=>void i.remove(A))})})}var pU;function mU(a,c,d){try{let g=d();return cp(g)?g.catch(w=>{throw c.runOutsideAngular(()=>a(w)),w}):g}catch(g){throw c.runOutsideAngular(()=>a(g)),g}}var kx=null;function gU(a=[],c){return rs.create({name:c,providers:[{provide:kg,useValue:"platform"},{provide:wI,useValue:new Set([()=>kx=null])},...a]})}function _U(a=[]){if(kx)return kx;let c=gU(a);return kx=c,UP(),yU(c),c}function yU(a){let c=a.get(yx,null);Do(a,()=>{c?.forEach(d=>d())})}var Bx=(()=>{class a{static __NG_ELEMENT_ID__=vU}return a})();function vU(a){return xU(po(),gi(),(a&16)===16)}function xU(a,c,d){if(ru(a)&&!d){let g=Is(a.index,c);return new lu(g,g)}else if(a.type&175){let g=c[os];return new lu(g,c)}return null}function aL(a){qi(8);try{let{rootComponent:c,appProviders:d,platformProviders:g}=a,w=_U(g),i=[_I({}),{provide:Ol,useExisting:tL},RR,...d||[]],A=new Kg({providers:i,parent:w,debugName:"",runEnvironmentInitializers:!1});return fU({r3Injector:A.injector,platformInjector:w,rootComponent:c})}catch(c){return Promise.reject(c)}finally{qi(9)}}function Vx(a){return typeof a=="boolean"?a:a!=null&&a!=="false"}var uL=null;function Ul(){return uL}function EI(a){uL??=a}var d_=class{},TI=(()=>{class a{historyGo(d){throw new Error("")}static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:()=>At(hL),providedIn:"platform"})}return a})();var hL=(()=>{class a extends TI{_location;_history;_doc=At(to);constructor(){super(),this._location=window.location,this._history=window.history}getBaseHrefFromDOM(){return Ul().getBaseHref(this._doc)}onPopState(d){let g=Ul().getGlobalEventTarget(this._doc,"window");return g.addEventListener("popstate",d,!1),()=>g.removeEventListener("popstate",d)}onHashChange(d){let g=Ul().getGlobalEventTarget(this._doc,"window");return g.addEventListener("hashchange",d,!1),()=>g.removeEventListener("hashchange",d)}get href(){return this._location.href}get protocol(){return this._location.protocol}get hostname(){return this._location.hostname}get port(){return this._location.port}get pathname(){return this._location.pathname}get search(){return this._location.search}get hash(){return this._location.hash}set pathname(d){this._location.pathname=d}pushState(d,g,w){this._history.pushState(d,g,w)}replaceState(d,g,w){this._history.replaceState(d,g,w)}forward(){this._history.forward()}back(){this._history.back()}historyGo(d=0){this._history.go(d)}getState(){return this._history.state}static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:()=>new a,providedIn:"platform"})}return a})();function dL(a,c){return a?c?a.endsWith("/")?c.startsWith("/")?a+c.slice(1):a+c:c.startsWith("/")?a+c:`${a}/${c}`:a:c}function lL(a){let c=a.search(/#|\?|$/);return a[c-1]==="/"?a.slice(0,c-1)+a.slice(c):a}function fu(a){return a&&a[0]!=="?"?`?${a}`:a}var mp=(()=>{class a{historyGo(d){throw new Error("")}static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:()=>At(pL),providedIn:"root"})}return a})(),fL=new En(""),pL=(()=>{class a extends mp{_platformLocation;_baseHref;_removeListenerFns=[];constructor(d,g){super(),this._platformLocation=d,this._baseHref=g??this._platformLocation.getBaseHrefFromDOM()??At(to).location?.origin??""}ngOnDestroy(){for(;this._removeListenerFns.length;)this._removeListenerFns.pop()()}onPopState(d){this._removeListenerFns.push(this._platformLocation.onPopState(d),this._platformLocation.onHashChange(d))}getBaseHref(){return this._baseHref}prepareExternalUrl(d){return dL(this._baseHref,d)}path(d=!1){let g=this._platformLocation.pathname+fu(this._platformLocation.search),w=this._platformLocation.hash;return w&&d?`${g}${w}`:g}pushState(d,g,w,i){let A=this.prepareExternalUrl(w+fu(i));this._platformLocation.pushState(d,g,A)}replaceState(d,g,w,i){let A=this.prepareExternalUrl(w+fu(i));this._platformLocation.replaceState(d,g,A)}forward(){this._platformLocation.forward()}back(){this._platformLocation.back()}getState(){return this._platformLocation.getState()}historyGo(d=0){this._platformLocation.historyGo?.(d)}static \u0275fac=function(g){return new(g||a)($n(TI),$n(fL,8))};static \u0275prov=Tn({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),gp=(()=>{class a{_subject=new Dr;_basePath;_locationStrategy;_urlChangeListeners=[];_urlChangeSubscription=null;constructor(d){this._locationStrategy=d;let g=this._locationStrategy.getBaseHref();this._basePath=EU(lL(cL(g))),this._locationStrategy.onPopState(w=>{this._subject.next({url:this.path(!0),pop:!0,state:w.state,type:w.type})})}ngOnDestroy(){this._urlChangeSubscription?.unsubscribe(),this._urlChangeListeners=[]}path(d=!1){return this.normalize(this._locationStrategy.path(d))}getState(){return this._locationStrategy.getState()}isCurrentPathEqualTo(d,g=""){return this.path()==this.normalize(d+fu(g))}normalize(d){return a.stripTrailingSlash(wU(this._basePath,cL(d)))}prepareExternalUrl(d){return d&&d[0]!=="/"&&(d="/"+d),this._locationStrategy.prepareExternalUrl(d)}go(d,g="",w=null){this._locationStrategy.pushState(w,"",d,g),this._notifyUrlChangeListeners(this.prepareExternalUrl(d+fu(g)),w)}replaceState(d,g="",w=null){this._locationStrategy.replaceState(w,"",d,g),this._notifyUrlChangeListeners(this.prepareExternalUrl(d+fu(g)),w)}forward(){this._locationStrategy.forward()}back(){this._locationStrategy.back()}historyGo(d=0){this._locationStrategy.historyGo?.(d)}onUrlChange(d){return this._urlChangeListeners.push(d),this._urlChangeSubscription??=this.subscribe(g=>{this._notifyUrlChangeListeners(g.url,g.state)}),()=>{let g=this._urlChangeListeners.indexOf(d);this._urlChangeListeners.splice(g,1),this._urlChangeListeners.length===0&&(this._urlChangeSubscription?.unsubscribe(),this._urlChangeSubscription=null)}}_notifyUrlChangeListeners(d="",g){this._urlChangeListeners.forEach(w=>w(d,g))}subscribe(d,g,w){return this._subject.subscribe({next:d,error:g??void 0,complete:w??void 0})}static normalizeQueryParams=fu;static joinWithSlash=dL;static stripTrailingSlash=lL;static \u0275fac=function(g){return new(g||a)($n(mp))};static \u0275prov=Tn({token:a,factory:()=>bU(),providedIn:"root"})}return a})();function bU(){return new gp($n(mp))}function wU(a,c){if(!a||!c.startsWith(a))return c;let d=c.substring(a.length);return d===""||["/",";","?","#"].includes(d[0])?d:c}function cL(a){return a.replace(/\/index.html$/,"")}function EU(a){if(new RegExp("^(https?:)?//").test(a)){let[,d]=a.split(/\/\/[^\/]+/);return d}return a}var DI=function(a){return a[a.Decimal=0]="Decimal",a[a.Percent=1]="Percent",a[a.Currency=2]="Currency",a[a.Scientific=3]="Scientific",a}(DI||{});var Xa={Decimal:0,Group:1,List:2,PercentSign:3,PlusSign:4,MinusSign:5,Exponential:6,SuperscriptingExponent:7,PerMille:8,Infinity:9,NaN:10,TimeSeparator:11,CurrencyDecimal:12,CurrencyGroup:13};function _p(a,c){let d=Px(a),g=d[Zh.NumberSymbols][c];if(typeof g>"u"){if(c===Xa.CurrencyDecimal)return d[Zh.NumberSymbols][Xa.Decimal];if(c===Xa.CurrencyGroup)return d[Zh.NumberSymbols][Xa.Group]}return g}function gL(a,c){return Px(a)[Zh.NumberFormats][c]}var TU=/^(\d+)?\.((\d+)(-(\d+))?)?$/,mL=22,jx=".",f_="0",IU=";",SU=",",II="#";function DU(a,c,d,g,w,i,A=!1){let N="",H=!1;if(!isFinite(a))N=_p(d,Xa.Infinity);else{let ce=AU(a);A&&(ce=MU(ce));let be=c.minInt,Pe=c.minFrac,st=c.maxFrac;if(i){let Yi=i.match(TU);if(Yi===null)throw new Qt(2306,!1);let fr=Yi[1],_o=Yi[3],Cs=Yi[5];fr!=null&&(be=SI(fr)),_o!=null&&(Pe=SI(_o)),Cs!=null?st=SI(Cs):_o!=null&&Pe>st&&(st=Pe)}RU(ce,Pe,st);let Se=ce.digits,It=ce.integerLen,Lt=ce.exponent,hn=[];for(H=Se.every(Yi=>!Yi);It<be;It++)Se.unshift(0);for(;It<0;It++)Se.unshift(0);It>0?hn=Se.splice(It,Se.length):(hn=Se,Se=[0]);let sn=[];for(Se.length>=c.lgSize&&sn.unshift(Se.splice(-c.lgSize,Se.length).join(""));Se.length>c.gSize;)sn.unshift(Se.splice(-c.gSize,Se.length).join(""));Se.length&&sn.unshift(Se.join("")),N=sn.join(_p(d,g)),hn.length&&(N+=_p(d,w)+hn.join("")),Lt&&(N+=_p(d,Xa.Exponential)+"+"+Lt)}return a<0&&!H?N=c.negPre+N+c.negSuf:N=c.posPre+N+c.posSuf,N}function _L(a,c,d){let g=gL(c,DI.Decimal),w=CU(g,_p(c,Xa.MinusSign));return DU(a,w,c,Xa.Group,Xa.Decimal,d)}function CU(a,c="-"){let d={minInt:1,minFrac:0,maxFrac:0,posPre:"",posSuf:"",negPre:"",negSuf:"",gSize:0,lgSize:0},g=a.split(IU),w=g[0],i=g[1],A=w.indexOf(jx)!==-1?w.split(jx):[w.substring(0,w.lastIndexOf(f_)+1),w.substring(w.lastIndexOf(f_)+1)],N=A[0],H=A[1]||"";d.posPre=N.substring(0,N.indexOf(II));for(let be=0;be<H.length;be++){let Pe=H.charAt(be);Pe===f_?d.minFrac=d.maxFrac=be+1:Pe===II?d.maxFrac=be+1:d.posSuf+=Pe}let ce=N.split(SU);if(d.gSize=ce[1]?ce[1].length:0,d.lgSize=ce[2]||ce[1]?(ce[2]||ce[1]).length:0,i){let be=w.length-d.posPre.length-d.posSuf.length,Pe=i.indexOf(II);d.negPre=i.substring(0,Pe).replace(/'/g,""),d.negSuf=i.slice(Pe+be).replace(/'/g,"")}else d.negPre=c+d.posPre,d.negSuf=d.posSuf;return d}function MU(a){if(a.digits[0]===0)return a;let c=a.digits.length-a.integerLen;return a.exponent?a.exponent+=2:(c===0?a.digits.push(0,0):c===1&&a.digits.push(0),a.integerLen+=2),a}function AU(a){let c=Math.abs(a)+"",d=0,g,w,i,A,N;for((w=c.indexOf(jx))>-1&&(c=c.replace(jx,"")),(i=c.search(/e/i))>0?(w<0&&(w=i),w+=+c.slice(i+1),c=c.substring(0,i)):w<0&&(w=c.length),i=0;c.charAt(i)===f_;i++);if(i===(N=c.length))g=[0],w=1;else{for(N--;c.charAt(N)===f_;)N--;for(w-=i,g=[],A=0;i<=N;i++,A++)g[A]=Number(c.charAt(i))}return w>mL&&(g=g.splice(0,mL-1),d=w-1,w=1),{digits:g,exponent:d,integerLen:w}}function RU(a,c,d){if(c>d)throw new Qt(2307,!1);let g=a.digits,w=g.length-a.integerLen,i=Math.min(Math.max(c,w),d),A=i+a.integerLen,N=g[A];if(A>0){g.splice(Math.max(a.integerLen,A));for(let Pe=A;Pe<g.length;Pe++)g[Pe]=0}else{w=Math.max(0,w),a.integerLen=1,g.length=Math.max(1,A=i+1),g[0]=0;for(let Pe=1;Pe<A;Pe++)g[Pe]=0}if(N>=5)if(A-1<0){for(let Pe=0;Pe>A;Pe--)g.unshift(0),a.integerLen++;g.unshift(1),a.integerLen++}else g[A-1]++;for(;w<Math.max(0,i);w++)g.push(0);let H=i!==0,ce=c+a.integerLen,be=g.reduceRight(function(Pe,st,Se,It){return st=st+Pe,It[Se]=st<10?st:st-10,H&&(It[Se]===0&&Se>=ce?It.pop():H=!1),st>=10?1:0},0);be&&(g.unshift(be),a.integerLen++)}function SI(a){let c=parseInt(a);if(isNaN(c))throw new Qt(2305,!1);return c}function PU(a,c){return new Qt(2100,!1)}var CI=(()=>{class a{transform(d){return JSON.stringify(d,null,2)}static \u0275fac=function(g){return new(g||a)};static \u0275pipe=Cx({name:"json",type:a,pure:!1})}return a})();var p_=(()=>{class a{_locale;constructor(d){this._locale=d}transform(d,g,w){if(!LU(d))return null;w||=this._locale;try{let i=OU(d);return _L(i,w,g)}catch(i){throw PU(a,i.message)}}static \u0275fac=function(g){return new(g||a)(sa(c_,16))};static \u0275pipe=Cx({name:"number",type:a,pure:!0})}return a})();function LU(a){return!(a==null||a===""||a!==a)}function OU(a){if(typeof a=="string"&&!isNaN(Number(a)-parseFloat(a)))return Number(a);if(typeof a!="number")throw new Qt(2309,!1);return a}function MI(a,c){c=encodeURIComponent(c);for(let d of a.split(";")){let g=d.indexOf("="),[w,i]=g==-1?[d,""]:[d.slice(0,g),d.slice(g+1)];if(w.trim()===c)return decodeURIComponent(i)}return null}var m_=class{};var yL="browser";var Hx=new En(""),OI=(()=>{class a{_zone;_plugins;_eventNameToPlugin=new Map;constructor(d,g){this._zone=g,d.forEach(w=>{w.manager=this}),this._plugins=d.slice().reverse()}addEventListener(d,g,w,i){return this._findPluginFor(g).addEventListener(d,g,w,i)}getZone(){return this._zone}_findPluginFor(d){let g=this._eventNameToPlugin.get(d);if(g)return g;if(g=this._plugins.find(i=>i.supports(d)),!g)throw new Qt(5101,!1);return this._eventNameToPlugin.set(d,g),g}static \u0275fac=function(g){return new(g||a)($n(Hx),$n(Rr))};static \u0275prov=Tn({token:a,factory:a.\u0275fac})}return a})(),g_=class{_doc;constructor(c){this._doc=c}manager},AI="ng-app-id";function vL(a){for(let c of a)c.remove()}function xL(a,c){let d=c.createElement("style");return d.textContent=a,d}function zU(a,c,d,g){let w=a.head?.querySelectorAll(`style[${AI}="${c}"],link[${AI}="${c}"]`);if(w)for(let i of w)i.removeAttribute(AI),i instanceof HTMLLinkElement?g.set(i.href.slice(i.href.lastIndexOf("/")+1),{usage:0,elements:[i]}):i.textContent&&d.set(i.textContent,{usage:0,elements:[i]})}function PI(a,c){let d=c.createElement("link");return d.setAttribute("rel","stylesheet"),d.setAttribute("href",a),d}var kI=(()=>{class a{doc;appId;nonce;inline=new Map;external=new Map;hosts=new Set;constructor(d,g,w,i={}){this.doc=d,this.appId=g,this.nonce=w,zU(d,g,this.inline,this.external),this.hosts.add(d.head)}addStyles(d,g){for(let w of d)this.addUsage(w,this.inline,xL);g?.forEach(w=>this.addUsage(w,this.external,PI))}removeStyles(d,g){for(let w of d)this.removeUsage(w,this.inline);g?.forEach(w=>this.removeUsage(w,this.external))}addUsage(d,g,w){let i=g.get(d);i?i.usage++:g.set(d,{usage:1,elements:[...this.hosts].map(A=>this.addElement(A,w(d,this.doc)))})}removeUsage(d,g){let w=g.get(d);w&&(w.usage--,w.usage<=0&&(vL(w.elements),g.delete(d)))}ngOnDestroy(){for(let[,{elements:d}]of[...this.inline,...this.external])vL(d);this.hosts.clear()}addHost(d){this.hosts.add(d);for(let[g,{elements:w}]of this.inline)w.push(this.addElement(d,xL(g,this.doc)));for(let[g,{elements:w}]of this.external)w.push(this.addElement(d,PI(g,this.doc)))}removeHost(d){this.hosts.delete(d)}addElement(d,g){return this.nonce&&g.setAttribute("nonce",this.nonce),d.appendChild(g)}static \u0275fac=function(g){return new(g||a)($n(to),$n(_x),$n(vx,8),$n(ap))};static \u0275prov=Tn({token:a,factory:a.\u0275fac})}return a})(),RI={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/",math:"http://www.w3.org/1998/Math/MathML"},FI=/%COMP%/g;var wL="%COMP%",BU=`_nghost-${wL}`,VU=`_ngcontent-${wL}`,jU=!0,UU=new En("",{providedIn:"root",factory:()=>jU});function HU(a){return VU.replace(FI,a)}function $U(a){return BU.replace(FI,a)}function EL(a,c){return c.map(d=>d.replace(FI,a))}var NI=(()=>{class a{eventManager;sharedStylesHost;appId;removeStylesOnCompDestroy;doc;platformId;ngZone;nonce;tracingService;rendererByCompId=new Map;defaultRenderer;platformIsServer;constructor(d,g,w,i,A,N,H,ce=null,be=null){this.eventManager=d,this.sharedStylesHost=g,this.appId=w,this.removeStylesOnCompDestroy=i,this.doc=A,this.platformId=N,this.ngZone=H,this.nonce=ce,this.tracingService=be,this.platformIsServer=!1,this.defaultRenderer=new __(d,A,H,this.platformIsServer,this.tracingService)}createRenderer(d,g){if(!d||!g)return this.defaultRenderer;let w=this.getOrCreateRenderer(d,g);return w instanceof Ux?w.applyToHost(d):w instanceof y_&&w.applyStyles(),w}getOrCreateRenderer(d,g){let w=this.rendererByCompId,i=w.get(g.id);if(!i){let A=this.doc,N=this.ngZone,H=this.eventManager,ce=this.sharedStylesHost,be=this.removeStylesOnCompDestroy,Pe=this.platformIsServer,st=this.tracingService;switch(g.encapsulation){case zl.Emulated:i=new Ux(H,ce,g,this.appId,be,A,N,Pe,st);break;case zl.ShadowDom:return new LI(H,ce,d,g,A,N,this.nonce,Pe,st);default:i=new y_(H,ce,g,be,A,N,Pe,st);break}w.set(g.id,i)}return i}ngOnDestroy(){this.rendererByCompId.clear()}componentReplaced(d){this.rendererByCompId.delete(d)}static \u0275fac=function(g){return new(g||a)($n(OI),$n(kI),$n(_x),$n(UU),$n(to),$n(ap),$n(Rr),$n(vx),$n(o_,8))};static \u0275prov=Tn({token:a,factory:a.\u0275fac})}return a})(),__=class{eventManager;doc;ngZone;platformIsServer;tracingService;data=Object.create(null);throwOnSyntheticProps=!0;constructor(c,d,g,w,i){this.eventManager=c,this.doc=d,this.ngZone=g,this.platformIsServer=w,this.tracingService=i}destroy(){}destroyNode=null;createElement(c,d){return d?this.doc.createElementNS(RI[d]||d,c):this.doc.createElement(c)}createComment(c){return this.doc.createComment(c)}createText(c){return this.doc.createTextNode(c)}appendChild(c,d){(bL(c)?c.content:c).appendChild(d)}insertBefore(c,d,g){c&&(bL(c)?c.content:c).insertBefore(d,g)}removeChild(c,d){d.remove()}selectRootElement(c,d){let g=typeof c=="string"?this.doc.querySelector(c):c;if(!g)throw new Qt(-5104,!1);return d||(g.textContent=""),g}parentNode(c){return c.parentNode}nextSibling(c){return c.nextSibling}setAttribute(c,d,g,w){if(w){d=w+":"+d;let i=RI[w];i?c.setAttributeNS(i,d,g):c.setAttribute(d,g)}else c.setAttribute(d,g)}removeAttribute(c,d,g){if(g){let w=RI[g];w?c.removeAttributeNS(w,d):c.removeAttribute(`${g}:${d}`)}else c.removeAttribute(d)}addClass(c,d){c.classList.add(d)}removeClass(c,d){c.classList.remove(d)}setStyle(c,d,g,w){w&(qa.DashCase|qa.Important)?c.style.setProperty(d,g,w&qa.Important?"important":""):c.style[d]=g}removeStyle(c,d,g){g&qa.DashCase?c.style.removeProperty(d):c.style[d]=""}setProperty(c,d,g){c!=null&&(c[d]=g)}setValue(c,d){c.nodeValue=d}listen(c,d,g,w){if(typeof c=="string"&&(c=Ul().getGlobalEventTarget(this.doc,c),!c))throw new Qt(5102,!1);let i=this.decoratePreventDefault(g);return this.tracingService?.wrapEventListener&&(i=this.tracingService.wrapEventListener(c,d,i)),this.eventManager.addEventListener(c,d,i,w)}decoratePreventDefault(c){return d=>{if(d==="__ngUnwrap__")return c;c(d)===!1&&d.preventDefault()}}};function bL(a){return a.tagName==="TEMPLATE"&&a.content!==void 0}var LI=class extends __{sharedStylesHost;hostEl;shadowRoot;constructor(c,d,g,w,i,A,N,H,ce){super(c,i,A,H,ce),this.sharedStylesHost=d,this.hostEl=g,this.shadowRoot=g.attachShadow({mode:"open"}),this.sharedStylesHost.addHost(this.shadowRoot);let be=w.styles;be=EL(w.id,be);for(let st of be){let Se=document.createElement("style");N&&Se.setAttribute("nonce",N),Se.textContent=st,this.shadowRoot.appendChild(Se)}let Pe=w.getExternalStyles?.();if(Pe)for(let st of Pe){let Se=PI(st,i);N&&Se.setAttribute("nonce",N),this.shadowRoot.appendChild(Se)}}nodeOrShadowRoot(c){return c===this.hostEl?this.shadowRoot:c}appendChild(c,d){return super.appendChild(this.nodeOrShadowRoot(c),d)}insertBefore(c,d,g){return super.insertBefore(this.nodeOrShadowRoot(c),d,g)}removeChild(c,d){return super.removeChild(null,d)}parentNode(c){return this.nodeOrShadowRoot(super.parentNode(this.nodeOrShadowRoot(c)))}destroy(){this.sharedStylesHost.removeHost(this.shadowRoot)}},y_=class extends __{sharedStylesHost;removeStylesOnCompDestroy;styles;styleUrls;constructor(c,d,g,w,i,A,N,H,ce){super(c,i,A,N,H),this.sharedStylesHost=d,this.removeStylesOnCompDestroy=w;let be=g.styles;this.styles=ce?EL(ce,be):be,this.styleUrls=g.getExternalStyles?.(ce)}applyStyles(){this.sharedStylesHost.addStyles(this.styles,this.styleUrls)}destroy(){this.removeStylesOnCompDestroy&&this.sharedStylesHost.removeStyles(this.styles,this.styleUrls)}},Ux=class extends y_{contentAttr;hostAttr;constructor(c,d,g,w,i,A,N,H,ce){let be=w+"-"+g.id;super(c,d,g,i,A,N,H,ce,be),this.contentAttr=HU(be),this.hostAttr=$U(be)}applyToHost(c){this.applyStyles(),this.setAttribute(c,this.hostAttr,"")}createElement(c,d){let g=super.createElement(c,d);return super.setAttribute(g,this.contentAttr,""),g}};var $x=class a extends d_{supportsDOMEvents=!0;static makeCurrent(){EI(new a)}onAndCancel(c,d,g,w){return c.addEventListener(d,g,w),()=>{c.removeEventListener(d,g,w)}}dispatchEvent(c,d){c.dispatchEvent(d)}remove(c){c.remove()}createElement(c,d){return d=d||this.getDefaultDocument(),d.createElement(c)}createHtmlDocument(){return document.implementation.createHTMLDocument("fakeTitle")}getDefaultDocument(){return document}isElementNode(c){return c.nodeType===Node.ELEMENT_NODE}isShadowRoot(c){return c instanceof DocumentFragment}getGlobalEventTarget(c,d){return d==="window"?window:d==="document"?c:d==="body"?c.body:null}getBaseHref(c){let d=GU();return d==null?null:qU(d)}resetBaseElement(){v_=null}getUserAgent(){return window.navigator.userAgent}getCookie(c){return MI(document.cookie,c)}},v_=null;function GU(){return v_=v_||document.head.querySelector("base"),v_?v_.getAttribute("href"):null}function qU(a){return new URL(a,document.baseURI).pathname}var WU=(()=>{class a{build(){return new XMLHttpRequest}static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:a.\u0275fac})}return a})(),IL=(()=>{class a extends g_{constructor(d){super(d)}supports(d){return!0}addEventListener(d,g,w,i){return d.addEventListener(g,w,i),()=>this.removeEventListener(d,g,w,i)}removeEventListener(d,g,w,i){return d.removeEventListener(g,w,i)}static \u0275fac=function(g){return new(g||a)($n(to))};static \u0275prov=Tn({token:a,factory:a.\u0275fac})}return a})(),TL=["alt","control","meta","shift"],ZU={"\b":"Backspace","	":"Tab","\x7F":"Delete","\x1B":"Escape",Del:"Delete",Esc:"Escape",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Down:"ArrowDown",Menu:"ContextMenu",Scroll:"ScrollLock",Win:"OS"},XU={alt:a=>a.altKey,control:a=>a.ctrlKey,meta:a=>a.metaKey,shift:a=>a.shiftKey},SL=(()=>{class a extends g_{constructor(d){super(d)}supports(d){return a.parseEventName(d)!=null}addEventListener(d,g,w,i){let A=a.parseEventName(g),N=a.eventCallback(A.fullKey,w,this.manager.getZone());return this.manager.getZone().runOutsideAngular(()=>Ul().onAndCancel(d,A.domEventName,N,i))}static parseEventName(d){let g=d.toLowerCase().split("."),w=g.shift();if(g.length===0||!(w==="keydown"||w==="keyup"))return null;let i=a._normalizeKey(g.pop()),A="",N=g.indexOf("code");if(N>-1&&(g.splice(N,1),A="code."),TL.forEach(ce=>{let be=g.indexOf(ce);be>-1&&(g.splice(be,1),A+=ce+".")}),A+=i,g.length!=0||i.length===0)return null;let H={};return H.domEventName=w,H.fullKey=A,H}static matchEventFullKeyCode(d,g){let w=ZU[d.key]||d.key,i="";return g.indexOf("code.")>-1&&(w=d.code,i="code."),w==null||!w?!1:(w=w.toLowerCase(),w===" "?w="space":w==="."&&(w="dot"),TL.forEach(A=>{if(A!==w){let N=XU[A];N(d)&&(i+=A+".")}}),i+=w,i===g)}static eventCallback(d,g,w){return i=>{a.matchEventFullKeyCode(i,d)&&w.runGuarded(()=>g(i))}}static _normalizeKey(d){return d==="esc"?"escape":d}static \u0275fac=function(g){return new(g||a)($n(to))};static \u0275prov=Tn({token:a,factory:a.\u0275fac})}return a})();function zI(a,c){let d=Wt({rootComponent:a},YU(c));return aL(d)}function YU(a){return{appProviders:[...t5,...a?.providers??[]],platformProviders:e5}}function KU(){$x.makeCurrent()}function JU(){return new ea}function QU(){return NT(document),document}var e5=[{provide:ap,useValue:yL},{provide:yx,useValue:KU,multi:!0},{provide:to,useFactory:QU}];var t5=[{provide:kg,useValue:"root"},{provide:ea,useFactory:JU},{provide:Hx,useClass:IL,multi:!0,deps:[to]},{provide:Hx,useClass:SL,multi:!0,deps:[to]},NI,kI,OI,{provide:Hh,useExisting:NI},{provide:m_,useClass:WU},[]];var DL=(()=>{class a{_doc;constructor(d){this._doc=d}getTitle(){return this._doc.title}setTitle(d){this._doc.title=d||""}static \u0275fac=function(g){return new(g||a)($n(to))};static \u0275prov=Tn({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();var Gn="primary",O_=Symbol("RouteTitle"),HI=class{params;constructor(c){this.params=c||{}}has(c){return Object.prototype.hasOwnProperty.call(this.params,c)}get(c){if(this.has(c)){let d=this.params[c];return Array.isArray(d)?d[0]:d}return null}getAll(c){if(this.has(c)){let d=this.params[c];return Array.isArray(d)?d:[d]}return[]}get keys(){return Object.keys(this.params)}};function Qh(a){return new HI(a)}function kL(a,c,d){let g=d.path.split("/");if(g.length>a.length||d.pathMatch==="full"&&(c.hasChildren()||g.length<a.length))return null;let w={};for(let i=0;i<g.length;i++){let A=g[i],N=a[i];if(A[0]===":")w[A.substring(1)]=N;else if(A!==N.path)return null}return{consumed:a.slice(0,g.length),posParams:w}}function i5(a,c){if(a.length!==c.length)return!1;for(let d=0;d<a.length;++d)if(!Ya(a[d],c[d]))return!1;return!0}function Ya(a,c){let d=a?$I(a):void 0,g=c?$I(c):void 0;if(!d||!g||d.length!=g.length)return!1;let w;for(let i=0;i<d.length;i++)if(w=d[i],!FL(a[w],c[w]))return!1;return!0}function $I(a){return[...Object.keys(a),...Object.getOwnPropertySymbols(a)]}function FL(a,c){if(Array.isArray(a)&&Array.isArray(c)){if(a.length!==c.length)return!1;let d=[...a].sort(),g=[...c].sort();return d.every((w,i)=>g[i]===w)}else return a===c}function NL(a){return a.length>0?a[a.length-1]:null}function Gl(a){return Zw(a)?a:cp(a)?yr(Promise.resolve(a)):Vn(a)}var r5={exact:BL,subset:VL},zL={exact:o5,subset:s5,ignored:()=>!0};function CL(a,c,d){return r5[d.paths](a.root,c.root,d.matrixParams)&&zL[d.queryParams](a.queryParams,c.queryParams)&&!(d.fragment==="exact"&&a.fragment!==c.fragment)}function o5(a,c){return Ya(a,c)}function BL(a,c,d){if(!Kh(a.segments,c.segments)||!Wx(a.segments,c.segments,d)||a.numberOfChildren!==c.numberOfChildren)return!1;for(let g in c.children)if(!a.children[g]||!BL(a.children[g],c.children[g],d))return!1;return!0}function s5(a,c){return Object.keys(c).length<=Object.keys(a).length&&Object.keys(c).every(d=>FL(a[d],c[d]))}function VL(a,c,d){return jL(a,c,c.segments,d)}function jL(a,c,d,g){if(a.segments.length>d.length){let w=a.segments.slice(0,d.length);return!(!Kh(w,d)||c.hasChildren()||!Wx(w,d,g))}else if(a.segments.length===d.length){if(!Kh(a.segments,d)||!Wx(a.segments,d,g))return!1;for(let w in c.children)if(!a.children[w]||!VL(a.children[w],c.children[w],g))return!1;return!0}else{let w=d.slice(0,a.segments.length),i=d.slice(a.segments.length);return!Kh(a.segments,w)||!Wx(a.segments,w,g)||!a.children[Gn]?!1:jL(a.children[Gn],c,i,g)}}function Wx(a,c,d){return c.every((g,w)=>zL[d](a[w].parameters,g.parameters))}var Ja=class{root;queryParams;fragment;_queryParamMap;constructor(c=new ki([],{}),d={},g=null){this.root=c,this.queryParams=d,this.fragment=g}get queryParamMap(){return this._queryParamMap??=Qh(this.queryParams),this._queryParamMap}toString(){return c5.serialize(this)}},ki=class{segments;children;parent=null;constructor(c,d){this.segments=c,this.children=d,Object.values(d).forEach(g=>g.parent=this)}hasChildren(){return this.numberOfChildren>0}get numberOfChildren(){return Object.keys(this.children).length}toString(){return Zx(this)}},pu=class{path;parameters;_parameterMap;constructor(c,d){this.path=c,this.parameters=d}get parameterMap(){return this._parameterMap??=Qh(this.parameters),this._parameterMap}toString(){return HL(this)}};function a5(a,c){return Kh(a,c)&&a.every((d,g)=>Ya(d.parameters,c[g].parameters))}function Kh(a,c){return a.length!==c.length?!1:a.every((d,g)=>d.path===c[g].path)}function l5(a,c){let d=[];return Object.entries(a.children).forEach(([g,w])=>{g===Gn&&(d=d.concat(c(w,g)))}),Object.entries(a.children).forEach(([g,w])=>{g!==Gn&&(d=d.concat(c(w,g)))}),d}var k_=(()=>{class a{static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:()=>new ed,providedIn:"root"})}return a})(),ed=class{parse(c){let d=new qI(c);return new Ja(d.parseRootSegment(),d.parseQueryParams(),d.parseFragment())}serialize(c){let d=`/${x_(c.root,!0)}`,g=d5(c.queryParams),w=typeof c.fragment=="string"?`#${u5(c.fragment)}`:"";return`${d}${g}${w}`}},c5=new ed;function Zx(a){return a.segments.map(c=>HL(c)).join("/")}function x_(a,c){if(!a.hasChildren())return Zx(a);if(c){let d=a.children[Gn]?x_(a.children[Gn],!1):"",g=[];return Object.entries(a.children).forEach(([w,i])=>{w!==Gn&&g.push(`${w}:${x_(i,!1)}`)}),g.length>0?`${d}(${g.join("//")})`:d}else{let d=l5(a,(g,w)=>w===Gn?[x_(a.children[Gn],!1)]:[`${w}:${x_(g,!1)}`]);return Object.keys(a.children).length===1&&a.children[Gn]!=null?`${Zx(a)}/${d[0]}`:`${Zx(a)}/(${d.join("//")})`}}function UL(a){return encodeURIComponent(a).replace(/%40/g,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",")}function Gx(a){return UL(a).replace(/%3B/gi,";")}function u5(a){return encodeURI(a)}function GI(a){return UL(a).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/%26/gi,"&")}function Xx(a){return decodeURIComponent(a)}function ML(a){return Xx(a.replace(/\+/g,"%20"))}function HL(a){return`${GI(a.path)}${h5(a.parameters)}`}function h5(a){return Object.entries(a).map(([c,d])=>`;${GI(c)}=${GI(d)}`).join("")}function d5(a){let c=Object.entries(a).map(([d,g])=>Array.isArray(g)?g.map(w=>`${Gx(d)}=${Gx(w)}`).join("&"):`${Gx(d)}=${Gx(g)}`).filter(d=>d);return c.length?`?${c.join("&")}`:""}var f5=/^[^\/()?;#]+/;function BI(a){let c=a.match(f5);return c?c[0]:""}var p5=/^[^\/()?;=#]+/;function m5(a){let c=a.match(p5);return c?c[0]:""}var g5=/^[^=?&#]+/;function _5(a){let c=a.match(g5);return c?c[0]:""}var y5=/^[^&#]+/;function v5(a){let c=a.match(y5);return c?c[0]:""}var qI=class{url;remaining;constructor(c){this.url=c,this.remaining=c}parseRootSegment(){return this.consumeOptional("/"),this.remaining===""||this.peekStartsWith("?")||this.peekStartsWith("#")?new ki([],{}):new ki([],this.parseChildren())}parseQueryParams(){let c={};if(this.consumeOptional("?"))do this.parseQueryParam(c);while(this.consumeOptional("&"));return c}parseFragment(){return this.consumeOptional("#")?decodeURIComponent(this.remaining):null}parseChildren(){if(this.remaining==="")return{};this.consumeOptional("/");let c=[];for(this.peekStartsWith("(")||c.push(this.parseSegment());this.peekStartsWith("/")&&!this.peekStartsWith("//")&&!this.peekStartsWith("/(");)this.capture("/"),c.push(this.parseSegment());let d={};this.peekStartsWith("/(")&&(this.capture("/"),d=this.parseParens(!0));let g={};return this.peekStartsWith("(")&&(g=this.parseParens(!1)),(c.length>0||Object.keys(d).length>0)&&(g[Gn]=new ki(c,d)),g}parseSegment(){let c=BI(this.remaining);if(c===""&&this.peekStartsWith(";"))throw new Qt(4009,!1);return this.capture(c),new pu(Xx(c),this.parseMatrixParams())}parseMatrixParams(){let c={};for(;this.consumeOptional(";");)this.parseParam(c);return c}parseParam(c){let d=m5(this.remaining);if(!d)return;this.capture(d);let g="";if(this.consumeOptional("=")){let w=BI(this.remaining);w&&(g=w,this.capture(g))}c[Xx(d)]=Xx(g)}parseQueryParam(c){let d=_5(this.remaining);if(!d)return;this.capture(d);let g="";if(this.consumeOptional("=")){let A=v5(this.remaining);A&&(g=A,this.capture(g))}let w=ML(d),i=ML(g);if(c.hasOwnProperty(w)){let A=c[w];Array.isArray(A)||(A=[A],c[w]=A),A.push(i)}else c[w]=i}parseParens(c){let d={};for(this.capture("(");!this.consumeOptional(")")&&this.remaining.length>0;){let g=BI(this.remaining),w=this.remaining[g.length];if(w!=="/"&&w!==")"&&w!==";")throw new Qt(4010,!1);let i;g.indexOf(":")>-1?(i=g.slice(0,g.indexOf(":")),this.capture(i),this.capture(":")):c&&(i=Gn);let A=this.parseChildren();d[i]=Object.keys(A).length===1?A[Gn]:new ki([],A),this.consumeOptional("//")}return d}peekStartsWith(c){return this.remaining.startsWith(c)}consumeOptional(c){return this.peekStartsWith(c)?(this.remaining=this.remaining.substring(c.length),!0):!1}capture(c){if(!this.consumeOptional(c))throw new Qt(4011,!1)}};function $L(a){return a.segments.length>0?new ki([],{[Gn]:a}):a}function GL(a){let c={};for(let[g,w]of Object.entries(a.children)){let i=GL(w);if(g===Gn&&i.segments.length===0&&i.hasChildren())for(let[A,N]of Object.entries(i.children))c[A]=N;else(i.segments.length>0||i.hasChildren())&&(c[g]=i)}let d=new ki(a.segments,c);return x5(d)}function x5(a){if(a.numberOfChildren===1&&a.children[Gn]){let c=a.children[Gn];return new ki(a.segments.concat(c.segments),c.children)}return a}function mu(a){return a instanceof Ja}function qL(a,c,d=null,g=null){let w=WL(a);return ZL(w,c,d,g)}function WL(a){let c;function d(i){let A={};for(let H of i.children){let ce=d(H);A[H.outlet]=ce}let N=new ki(i.url,A);return i===a&&(c=N),N}let g=d(a.root),w=$L(g);return c??w}function ZL(a,c,d,g){let w=a;for(;w.parent;)w=w.parent;if(c.length===0)return VI(w,w,w,d,g);let i=b5(c);if(i.toRoot())return VI(w,w,new ki([],{}),d,g);let A=w5(i,w,a),N=A.processChildren?w_(A.segmentGroup,A.index,i.commands):YL(A.segmentGroup,A.index,i.commands);return VI(w,A.segmentGroup,N,d,g)}function Yx(a){return typeof a=="object"&&a!=null&&!a.outlets&&!a.segmentPath}function I_(a){return typeof a=="object"&&a!=null&&a.outlets}function VI(a,c,d,g,w){let i={};g&&Object.entries(g).forEach(([H,ce])=>{i[H]=Array.isArray(ce)?ce.map(be=>`${be}`):`${ce}`});let A;a===c?A=d:A=XL(a,c,d);let N=$L(GL(A));return new Ja(N,i,w)}function XL(a,c,d){let g={};return Object.entries(a.children).forEach(([w,i])=>{i===c?g[w]=d:g[w]=XL(i,c,d)}),new ki(a.segments,g)}var Kx=class{isAbsolute;numberOfDoubleDots;commands;constructor(c,d,g){if(this.isAbsolute=c,this.numberOfDoubleDots=d,this.commands=g,c&&g.length>0&&Yx(g[0]))throw new Qt(4003,!1);let w=g.find(I_);if(w&&w!==NL(g))throw new Qt(4004,!1)}toRoot(){return this.isAbsolute&&this.commands.length===1&&this.commands[0]=="/"}};function b5(a){if(typeof a[0]=="string"&&a.length===1&&a[0]==="/")return new Kx(!0,0,a);let c=0,d=!1,g=a.reduce((w,i,A)=>{if(typeof i=="object"&&i!=null){if(i.outlets){let N={};return Object.entries(i.outlets).forEach(([H,ce])=>{N[H]=typeof ce=="string"?ce.split("/"):ce}),[...w,{outlets:N}]}if(i.segmentPath)return[...w,i.segmentPath]}return typeof i!="string"?[...w,i]:A===0?(i.split("/").forEach((N,H)=>{H==0&&N==="."||(H==0&&N===""?d=!0:N===".."?c++:N!=""&&w.push(N))}),w):[...w,i]},[]);return new Kx(d,c,g)}var xp=class{segmentGroup;processChildren;index;constructor(c,d,g){this.segmentGroup=c,this.processChildren=d,this.index=g}};function w5(a,c,d){if(a.isAbsolute)return new xp(c,!0,0);if(!d)return new xp(c,!1,NaN);if(d.parent===null)return new xp(d,!0,0);let g=Yx(a.commands[0])?0:1,w=d.segments.length-1+g;return E5(d,w,a.numberOfDoubleDots)}function E5(a,c,d){let g=a,w=c,i=d;for(;i>w;){if(i-=w,g=g.parent,!g)throw new Qt(4005,!1);w=g.segments.length}return new xp(g,!1,w-i)}function T5(a){return I_(a[0])?a[0].outlets:{[Gn]:a}}function YL(a,c,d){if(a??=new ki([],{}),a.segments.length===0&&a.hasChildren())return w_(a,c,d);let g=I5(a,c,d),w=d.slice(g.commandIndex);if(g.match&&g.pathIndex<a.segments.length){let i=new ki(a.segments.slice(0,g.pathIndex),{});return i.children[Gn]=new ki(a.segments.slice(g.pathIndex),a.children),w_(i,0,w)}else return g.match&&w.length===0?new ki(a.segments,{}):g.match&&!a.hasChildren()?WI(a,c,d):g.match?w_(a,0,w):WI(a,c,d)}function w_(a,c,d){if(d.length===0)return new ki(a.segments,{});{let g=T5(d),w={};if(Object.keys(g).some(i=>i!==Gn)&&a.children[Gn]&&a.numberOfChildren===1&&a.children[Gn].segments.length===0){let i=w_(a.children[Gn],c,d);return new ki(a.segments,i.children)}return Object.entries(g).forEach(([i,A])=>{typeof A=="string"&&(A=[A]),A!==null&&(w[i]=YL(a.children[i],c,A))}),Object.entries(a.children).forEach(([i,A])=>{g[i]===void 0&&(w[i]=A)}),new ki(a.segments,w)}}function I5(a,c,d){let g=0,w=c,i={match:!1,pathIndex:0,commandIndex:0};for(;w<a.segments.length;){if(g>=d.length)return i;let A=a.segments[w],N=d[g];if(I_(N))break;let H=`${N}`,ce=g<d.length-1?d[g+1]:null;if(w>0&&H===void 0)break;if(H&&ce&&typeof ce=="object"&&ce.outlets===void 0){if(!RL(H,ce,A))return i;g+=2}else{if(!RL(H,{},A))return i;g++}w++}return{match:!0,pathIndex:w,commandIndex:g}}function WI(a,c,d){let g=a.segments.slice(0,c),w=0;for(;w<d.length;){let i=d[w];if(I_(i)){let H=S5(i.outlets);return new ki(g,H)}if(w===0&&Yx(d[0])){let H=a.segments[c];g.push(new pu(H.path,AL(d[0]))),w++;continue}let A=I_(i)?i.outlets[Gn]:`${i}`,N=w<d.length-1?d[w+1]:null;A&&N&&Yx(N)?(g.push(new pu(A,AL(N))),w+=2):(g.push(new pu(A,{})),w++)}return new ki(g,{})}function S5(a){let c={};return Object.entries(a).forEach(([d,g])=>{typeof g=="string"&&(g=[g]),g!==null&&(c[d]=WI(new ki([],{}),0,g))}),c}function AL(a){let c={};return Object.entries(a).forEach(([d,g])=>c[d]=`${g}`),c}function RL(a,c,d){return a==d.path&&Ya(c,d.parameters)}var E_="imperative",Wr=function(a){return a[a.NavigationStart=0]="NavigationStart",a[a.NavigationEnd=1]="NavigationEnd",a[a.NavigationCancel=2]="NavigationCancel",a[a.NavigationError=3]="NavigationError",a[a.RoutesRecognized=4]="RoutesRecognized",a[a.ResolveStart=5]="ResolveStart",a[a.ResolveEnd=6]="ResolveEnd",a[a.GuardsCheckStart=7]="GuardsCheckStart",a[a.GuardsCheckEnd=8]="GuardsCheckEnd",a[a.RouteConfigLoadStart=9]="RouteConfigLoadStart",a[a.RouteConfigLoadEnd=10]="RouteConfigLoadEnd",a[a.ChildActivationStart=11]="ChildActivationStart",a[a.ChildActivationEnd=12]="ChildActivationEnd",a[a.ActivationStart=13]="ActivationStart",a[a.ActivationEnd=14]="ActivationEnd",a[a.Scroll=15]="Scroll",a[a.NavigationSkipped=16]="NavigationSkipped",a}(Wr||{}),hs=class{id;url;constructor(c,d){this.id=c,this.url=d}},td=class extends hs{type=Wr.NavigationStart;navigationTrigger;restoredState;constructor(c,d,g="imperative",w=null){super(c,d),this.navigationTrigger=g,this.restoredState=w}toString(){return`NavigationStart(id: ${this.id}, url: '${this.url}')`}},Ds=class extends hs{urlAfterRedirects;type=Wr.NavigationEnd;constructor(c,d,g){super(c,d),this.urlAfterRedirects=g}toString(){return`NavigationEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}')`}},Ro=function(a){return a[a.Redirect=0]="Redirect",a[a.SupersededByNewNavigation=1]="SupersededByNewNavigation",a[a.NoDataFromResolver=2]="NoDataFromResolver",a[a.GuardRejected=3]="GuardRejected",a[a.Aborted=4]="Aborted",a}(Ro||{}),S_=function(a){return a[a.IgnoredSameUrlNavigation=0]="IgnoredSameUrlNavigation",a[a.IgnoredByUrlHandlingStrategy=1]="IgnoredByUrlHandlingStrategy",a}(S_||{}),Ka=class extends hs{reason;code;type=Wr.NavigationCancel;constructor(c,d,g,w){super(c,d),this.reason=g,this.code=w}toString(){return`NavigationCancel(id: ${this.id}, url: '${this.url}')`}},Hl=class extends hs{reason;code;type=Wr.NavigationSkipped;constructor(c,d,g,w){super(c,d),this.reason=g,this.code=w}},wp=class extends hs{error;target;type=Wr.NavigationError;constructor(c,d,g,w){super(c,d),this.error=g,this.target=w}toString(){return`NavigationError(id: ${this.id}, url: '${this.url}', error: ${this.error})`}},D_=class extends hs{urlAfterRedirects;state;type=Wr.RoutesRecognized;constructor(c,d,g,w){super(c,d),this.urlAfterRedirects=g,this.state=w}toString(){return`RoutesRecognized(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},Jx=class extends hs{urlAfterRedirects;state;type=Wr.GuardsCheckStart;constructor(c,d,g,w){super(c,d),this.urlAfterRedirects=g,this.state=w}toString(){return`GuardsCheckStart(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},Qx=class extends hs{urlAfterRedirects;state;shouldActivate;type=Wr.GuardsCheckEnd;constructor(c,d,g,w,i){super(c,d),this.urlAfterRedirects=g,this.state=w,this.shouldActivate=i}toString(){return`GuardsCheckEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state}, shouldActivate: ${this.shouldActivate})`}},eb=class extends hs{urlAfterRedirects;state;type=Wr.ResolveStart;constructor(c,d,g,w){super(c,d),this.urlAfterRedirects=g,this.state=w}toString(){return`ResolveStart(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},tb=class extends hs{urlAfterRedirects;state;type=Wr.ResolveEnd;constructor(c,d,g,w){super(c,d),this.urlAfterRedirects=g,this.state=w}toString(){return`ResolveEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},nb=class{route;type=Wr.RouteConfigLoadStart;constructor(c){this.route=c}toString(){return`RouteConfigLoadStart(path: ${this.route.path})`}},ib=class{route;type=Wr.RouteConfigLoadEnd;constructor(c){this.route=c}toString(){return`RouteConfigLoadEnd(path: ${this.route.path})`}},rb=class{snapshot;type=Wr.ChildActivationStart;constructor(c){this.snapshot=c}toString(){return`ChildActivationStart(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},ob=class{snapshot;type=Wr.ChildActivationEnd;constructor(c){this.snapshot=c}toString(){return`ChildActivationEnd(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},sb=class{snapshot;type=Wr.ActivationStart;constructor(c){this.snapshot=c}toString(){return`ActivationStart(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},ab=class{snapshot;type=Wr.ActivationEnd;constructor(c){this.snapshot=c}toString(){return`ActivationEnd(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}};var C_=class{},Ep=class{url;navigationBehaviorOptions;constructor(c,d){this.url=c,this.navigationBehaviorOptions=d}};function D5(a){return!(a instanceof C_)&&!(a instanceof Ep)}function C5(a,c){return a.providers&&!a._injector&&(a._injector=r_(a.providers,c,`Route: ${a.path}`)),a._injector??c}function aa(a){return a.outlet||Gn}function M5(a,c){let d=a.filter(g=>aa(g)===c);return d.push(...a.filter(g=>aa(g)!==c)),d}function Sp(a){if(!a)return null;if(a.routeConfig?._injector)return a.routeConfig._injector;for(let c=a.parent;c;c=c.parent){let d=c.routeConfig;if(d?._loadedInjector)return d._loadedInjector;if(d?._injector)return d._injector}return null}var lb=class{rootInjector;outlet=null;route=null;children;attachRef=null;get injector(){return Sp(this.route?.snapshot)??this.rootInjector}constructor(c){this.rootInjector=c,this.children=new Dp(this.rootInjector)}},Dp=(()=>{class a{rootInjector;contexts=new Map;constructor(d){this.rootInjector=d}onChildOutletCreated(d,g){let w=this.getOrCreateContext(d);w.outlet=g,this.contexts.set(d,w)}onChildOutletDestroyed(d){let g=this.getContext(d);g&&(g.outlet=null,g.attachRef=null)}onOutletDeactivated(){let d=this.contexts;return this.contexts=new Map,d}onOutletReAttached(d){this.contexts=d}getOrCreateContext(d){let g=this.getContext(d);return g||(g=new lb(this.rootInjector),this.contexts.set(d,g)),g}getContext(d){return this.contexts.get(d)||null}static \u0275fac=function(g){return new(g||a)($n($r))};static \u0275prov=Tn({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),cb=class{_root;constructor(c){this._root=c}get root(){return this._root.value}parent(c){let d=this.pathFromRoot(c);return d.length>1?d[d.length-2]:null}children(c){let d=ZI(c,this._root);return d?d.children.map(g=>g.value):[]}firstChild(c){let d=ZI(c,this._root);return d&&d.children.length>0?d.children[0].value:null}siblings(c){let d=XI(c,this._root);return d.length<2?[]:d[d.length-2].children.map(w=>w.value).filter(w=>w!==c)}pathFromRoot(c){return XI(c,this._root).map(d=>d.value)}};function ZI(a,c){if(a===c.value)return c;for(let d of c.children){let g=ZI(a,d);if(g)return g}return null}function XI(a,c){if(a===c.value)return[c];for(let d of c.children){let g=XI(a,d);if(g.length)return g.unshift(c),g}return[]}var us=class{value;children;constructor(c,d){this.value=c,this.children=d}toString(){return`TreeNode(${this.value})`}};function vp(a){let c={};return a&&a.children.forEach(d=>c[d.value.outlet]=d),c}var M_=class extends cb{snapshot;constructor(c,d){super(c),this.snapshot=d,iS(this,c)}toString(){return this.snapshot.toString()}};function KL(a){let c=A5(a),d=new eo([new pu("",{})]),g=new eo({}),w=new eo({}),i=new eo({}),A=new eo(""),N=new $l(d,g,i,A,w,Gn,a,c.root);return N.snapshot=c.root,new M_(new us(N,[]),c)}function A5(a){let c={},d={},g={},w="",i=new Jh([],c,g,w,d,Gn,a,null,{});return new A_("",new us(i,[]))}var $l=class{urlSubject;paramsSubject;queryParamsSubject;fragmentSubject;dataSubject;outlet;component;snapshot;_futureSnapshot;_routerState;_paramMap;_queryParamMap;title;url;params;queryParams;fragment;data;constructor(c,d,g,w,i,A,N,H){this.urlSubject=c,this.paramsSubject=d,this.queryParamsSubject=g,this.fragmentSubject=w,this.dataSubject=i,this.outlet=A,this.component=N,this._futureSnapshot=H,this.title=this.dataSubject?.pipe(fi(ce=>ce[O_]))??Vn(void 0),this.url=c,this.params=d,this.queryParams=g,this.fragment=w,this.data=i}get routeConfig(){return this._futureSnapshot.routeConfig}get root(){return this._routerState.root}get parent(){return this._routerState.parent(this)}get firstChild(){return this._routerState.firstChild(this)}get children(){return this._routerState.children(this)}get pathFromRoot(){return this._routerState.pathFromRoot(this)}get paramMap(){return this._paramMap??=this.params.pipe(fi(c=>Qh(c))),this._paramMap}get queryParamMap(){return this._queryParamMap??=this.queryParams.pipe(fi(c=>Qh(c))),this._queryParamMap}toString(){return this.snapshot?this.snapshot.toString():`Future(${this._futureSnapshot})`}};function ub(a,c,d="emptyOnly"){let g,{routeConfig:w}=a;return c!==null&&(d==="always"||w?.path===""||!c.component&&!c.routeConfig?.loadComponent)?g={params:Wt(Wt({},c.params),a.params),data:Wt(Wt({},c.data),a.data),resolve:Wt(Wt(Wt(Wt({},a.data),c.data),w?.data),a._resolvedData)}:g={params:Wt({},a.params),data:Wt({},a.data),resolve:Wt(Wt({},a.data),a._resolvedData??{})},w&&QL(w)&&(g.resolve[O_]=w.title),g}var Jh=class{url;params;queryParams;fragment;data;outlet;component;routeConfig;_resolve;_resolvedData;_routerState;_paramMap;_queryParamMap;get title(){return this.data?.[O_]}constructor(c,d,g,w,i,A,N,H,ce){this.url=c,this.params=d,this.queryParams=g,this.fragment=w,this.data=i,this.outlet=A,this.component=N,this.routeConfig=H,this._resolve=ce}get root(){return this._routerState.root}get parent(){return this._routerState.parent(this)}get firstChild(){return this._routerState.firstChild(this)}get children(){return this._routerState.children(this)}get pathFromRoot(){return this._routerState.pathFromRoot(this)}get paramMap(){return this._paramMap??=Qh(this.params),this._paramMap}get queryParamMap(){return this._queryParamMap??=Qh(this.queryParams),this._queryParamMap}toString(){let c=this.url.map(g=>g.toString()).join("/"),d=this.routeConfig?this.routeConfig.path:"";return`Route(url:'${c}', path:'${d}')`}},A_=class extends cb{url;constructor(c,d){super(d),this.url=c,iS(this,d)}toString(){return JL(this._root)}};function iS(a,c){c.value._routerState=a,c.children.forEach(d=>iS(a,d))}function JL(a){let c=a.children.length>0?` { ${a.children.map(JL).join(", ")} } `:"";return`${a.value}${c}`}function jI(a){if(a.snapshot){let c=a.snapshot,d=a._futureSnapshot;a.snapshot=d,Ya(c.queryParams,d.queryParams)||a.queryParamsSubject.next(d.queryParams),c.fragment!==d.fragment&&a.fragmentSubject.next(d.fragment),Ya(c.params,d.params)||a.paramsSubject.next(d.params),i5(c.url,d.url)||a.urlSubject.next(d.url),Ya(c.data,d.data)||a.dataSubject.next(d.data)}else a.snapshot=a._futureSnapshot,a.dataSubject.next(a._futureSnapshot.data)}function YI(a,c){let d=Ya(a.params,c.params)&&a5(a.url,c.url),g=!a.parent!=!c.parent;return d&&!g&&(!a.parent||YI(a.parent,c.parent))}function QL(a){return typeof a.title=="string"||a.title===null}var eO=new En(""),F_=(()=>{class a{activated=null;get activatedComponentRef(){return this.activated}_activatedRoute=null;name=Gn;activateEvents=new Mo;deactivateEvents=new Mo;attachEvents=new Mo;detachEvents=new Mo;routerOutletData=zx(void 0);parentContexts=At(Dp);location=At(qh);changeDetector=At(Bx);inputBinder=At(pb,{optional:!0});supportsBindingToComponentInputs=!0;ngOnChanges(d){if(d.name){let{firstChange:g,previousValue:w}=d.name;if(g)return;this.isTrackedInParentContexts(w)&&(this.deactivate(),this.parentContexts.onChildOutletDestroyed(w)),this.initializeOutletWithName()}}ngOnDestroy(){this.isTrackedInParentContexts(this.name)&&this.parentContexts.onChildOutletDestroyed(this.name),this.inputBinder?.unsubscribeFromRouteData(this)}isTrackedInParentContexts(d){return this.parentContexts.getContext(d)?.outlet===this}ngOnInit(){this.initializeOutletWithName()}initializeOutletWithName(){if(this.parentContexts.onChildOutletCreated(this.name,this),this.activated)return;let d=this.parentContexts.getContext(this.name);d?.route&&(d.attachRef?this.attach(d.attachRef,d.route):this.activateWith(d.route,d.injector))}get isActivated(){return!!this.activated}get component(){if(!this.activated)throw new Qt(4012,!1);return this.activated.instance}get activatedRoute(){if(!this.activated)throw new Qt(4012,!1);return this._activatedRoute}get activatedRouteData(){return this._activatedRoute?this._activatedRoute.snapshot.data:{}}detach(){if(!this.activated)throw new Qt(4012,!1);this.location.detach();let d=this.activated;return this.activated=null,this._activatedRoute=null,this.detachEvents.emit(d.instance),d}attach(d,g){this.activated=d,this._activatedRoute=g,this.location.insert(d.hostView),this.inputBinder?.bindActivatedRouteToOutletComponent(this),this.attachEvents.emit(d.instance)}deactivate(){if(this.activated){let d=this.component;this.activated.destroy(),this.activated=null,this._activatedRoute=null,this.deactivateEvents.emit(d)}}activateWith(d,g){if(this.isActivated)throw new Qt(4013,!1);this._activatedRoute=d;let w=this.location,A=d.snapshot.component,N=this.parentContexts.getOrCreateContext(this.name).children,H=new KI(d,N,w.injector,this.routerOutletData);this.activated=w.createComponent(A,{index:w.length,injector:H,environmentInjector:g}),this.changeDetector.markForCheck(),this.inputBinder?.bindActivatedRouteToOutletComponent(this),this.activateEvents.emit(this.activated.instance)}static \u0275fac=function(g){return new(g||a)};static \u0275dir=lp({type:a,selectors:[["router-outlet"]],inputs:{name:"name",routerOutletData:[1,"routerOutletData"]},outputs:{activateEvents:"activate",deactivateEvents:"deactivate",attachEvents:"attach",detachEvents:"detach"},exportAs:["outlet"],features:[op]})}return a})(),KI=class{route;childContexts;parent;outletData;constructor(c,d,g,w){this.route=c,this.childContexts=d,this.parent=g,this.outletData=w}get(c,d){return c===$l?this.route:c===Dp?this.childContexts:c===eO?this.outletData:this.parent.get(c,d)}},pb=new En("");var rS=(()=>{class a{static \u0275fac=function(g){return new(g||a)};static \u0275cmp=Ao({type:a,selectors:[["ng-component"]],exportAs:["emptyRouterOutlet"],decls:1,vars:0,template:function(g,w){g&1&&Za(0,"router-outlet")},dependencies:[F_],encapsulation:2})}return a})();function oS(a){let c=a.children&&a.children.map(oS),d=c?Oi(Wt({},a),{children:c}):Wt({},a);return!d.component&&!d.loadComponent&&(c||d.loadChildren)&&d.outlet&&d.outlet!==Gn&&(d.component=rS),d}function R5(a,c,d){let g=R_(a,c._root,d?d._root:void 0);return new M_(g,c)}function R_(a,c,d){if(d&&a.shouldReuseRoute(c.value,d.value.snapshot)){let g=d.value;g._futureSnapshot=c.value;let w=P5(a,c,d);return new us(g,w)}else{if(a.shouldAttach(c.value)){let i=a.retrieve(c.value);if(i!==null){let A=i.route;return A.value._futureSnapshot=c.value,A.children=c.children.map(N=>R_(a,N)),A}}let g=L5(c.value),w=c.children.map(i=>R_(a,i));return new us(g,w)}}function P5(a,c,d){return c.children.map(g=>{for(let w of d.children)if(a.shouldReuseRoute(g.value,w.value.snapshot))return R_(a,g,w);return R_(a,g)})}function L5(a){return new $l(new eo(a.url),new eo(a.params),new eo(a.queryParams),new eo(a.fragment),new eo(a.data),a.outlet,a.component,a)}var Tp=class{redirectTo;navigationBehaviorOptions;constructor(c,d){this.redirectTo=c,this.navigationBehaviorOptions=d}},tO="ngNavigationCancelingError";function hb(a,c){let{redirectTo:d,navigationBehaviorOptions:g}=mu(c)?{redirectTo:c,navigationBehaviorOptions:void 0}:c,w=nO(!1,Ro.Redirect);return w.url=d,w.navigationBehaviorOptions=g,w}function nO(a,c){let d=new Error(`NavigationCancelingError: ${a||""}`);return d[tO]=!0,d.cancellationCode=c,d}function O5(a){return iO(a)&&mu(a.url)}function iO(a){return!!a&&a[tO]}var k5=(a,c,d,g)=>fi(w=>(new JI(c,w.targetRouterState,w.currentRouterState,d,g).activate(a),w)),JI=class{routeReuseStrategy;futureState;currState;forwardEvent;inputBindingEnabled;constructor(c,d,g,w,i){this.routeReuseStrategy=c,this.futureState=d,this.currState=g,this.forwardEvent=w,this.inputBindingEnabled=i}activate(c){let d=this.futureState._root,g=this.currState?this.currState._root:null;this.deactivateChildRoutes(d,g,c),jI(this.futureState.root),this.activateChildRoutes(d,g,c)}deactivateChildRoutes(c,d,g){let w=vp(d);c.children.forEach(i=>{let A=i.value.outlet;this.deactivateRoutes(i,w[A],g),delete w[A]}),Object.values(w).forEach(i=>{this.deactivateRouteAndItsChildren(i,g)})}deactivateRoutes(c,d,g){let w=c.value,i=d?d.value:null;if(w===i)if(w.component){let A=g.getContext(w.outlet);A&&this.deactivateChildRoutes(c,d,A.children)}else this.deactivateChildRoutes(c,d,g);else i&&this.deactivateRouteAndItsChildren(d,g)}deactivateRouteAndItsChildren(c,d){c.value.component&&this.routeReuseStrategy.shouldDetach(c.value.snapshot)?this.detachAndStoreRouteSubtree(c,d):this.deactivateRouteAndOutlet(c,d)}detachAndStoreRouteSubtree(c,d){let g=d.getContext(c.value.outlet),w=g&&c.value.component?g.children:d,i=vp(c);for(let A of Object.values(i))this.deactivateRouteAndItsChildren(A,w);if(g&&g.outlet){let A=g.outlet.detach(),N=g.children.onOutletDeactivated();this.routeReuseStrategy.store(c.value.snapshot,{componentRef:A,route:c,contexts:N})}}deactivateRouteAndOutlet(c,d){let g=d.getContext(c.value.outlet),w=g&&c.value.component?g.children:d,i=vp(c);for(let A of Object.values(i))this.deactivateRouteAndItsChildren(A,w);g&&(g.outlet&&(g.outlet.deactivate(),g.children.onOutletDeactivated()),g.attachRef=null,g.route=null)}activateChildRoutes(c,d,g){let w=vp(d);c.children.forEach(i=>{this.activateRoutes(i,w[i.value.outlet],g),this.forwardEvent(new ab(i.value.snapshot))}),c.children.length&&this.forwardEvent(new ob(c.value.snapshot))}activateRoutes(c,d,g){let w=c.value,i=d?d.value:null;if(jI(w),w===i)if(w.component){let A=g.getOrCreateContext(w.outlet);this.activateChildRoutes(c,d,A.children)}else this.activateChildRoutes(c,d,g);else if(w.component){let A=g.getOrCreateContext(w.outlet);if(this.routeReuseStrategy.shouldAttach(w.snapshot)){let N=this.routeReuseStrategy.retrieve(w.snapshot);this.routeReuseStrategy.store(w.snapshot,null),A.children.onOutletReAttached(N.contexts),A.attachRef=N.componentRef,A.route=N.route.value,A.outlet&&A.outlet.attach(N.componentRef,N.route.value),jI(N.route.value),this.activateChildRoutes(c,null,A.children)}else A.attachRef=null,A.route=w,A.outlet&&A.outlet.activateWith(w,A.injector),this.activateChildRoutes(c,null,A.children)}else this.activateChildRoutes(c,null,g)}},db=class{path;route;constructor(c){this.path=c,this.route=this.path[this.path.length-1]}},bp=class{component;route;constructor(c,d){this.component=c,this.route=d}};function F5(a,c,d){let g=a._root,w=c?c._root:null;return b_(g,w,d,[g.value])}function N5(a){let c=a.routeConfig?a.routeConfig.canActivateChild:null;return!c||c.length===0?null:{node:a,guards:c}}function Cp(a,c){let d=Symbol(),g=c.get(a,d);return g===d?typeof a=="function"&&!uE(a)?a:c.get(a):g}function b_(a,c,d,g,w={canDeactivateChecks:[],canActivateChecks:[]}){let i=vp(c);return a.children.forEach(A=>{z5(A,i[A.value.outlet],d,g.concat([A.value]),w),delete i[A.value.outlet]}),Object.entries(i).forEach(([A,N])=>T_(N,d.getContext(A),w)),w}function z5(a,c,d,g,w={canDeactivateChecks:[],canActivateChecks:[]}){let i=a.value,A=c?c.value:null,N=d?d.getContext(a.value.outlet):null;if(A&&i.routeConfig===A.routeConfig){let H=B5(A,i,i.routeConfig.runGuardsAndResolvers);H?w.canActivateChecks.push(new db(g)):(i.data=A.data,i._resolvedData=A._resolvedData),i.component?b_(a,c,N?N.children:null,g,w):b_(a,c,d,g,w),H&&N&&N.outlet&&N.outlet.isActivated&&w.canDeactivateChecks.push(new bp(N.outlet.component,A))}else A&&T_(c,N,w),w.canActivateChecks.push(new db(g)),i.component?b_(a,null,N?N.children:null,g,w):b_(a,null,d,g,w);return w}function B5(a,c,d){if(typeof d=="function")return d(a,c);switch(d){case"pathParamsChange":return!Kh(a.url,c.url);case"pathParamsOrQueryParamsChange":return!Kh(a.url,c.url)||!Ya(a.queryParams,c.queryParams);case"always":return!0;case"paramsOrQueryParamsChange":return!YI(a,c)||!Ya(a.queryParams,c.queryParams);case"paramsChange":default:return!YI(a,c)}}function T_(a,c,d){let g=vp(a),w=a.value;Object.entries(g).forEach(([i,A])=>{w.component?c?T_(A,c.children.getContext(i),d):T_(A,null,d):T_(A,c,d)}),w.component?c&&c.outlet&&c.outlet.isActivated?d.canDeactivateChecks.push(new bp(c.outlet.component,w)):d.canDeactivateChecks.push(new bp(null,w)):d.canDeactivateChecks.push(new bp(null,w))}function N_(a){return typeof a=="function"}function V5(a){return typeof a=="boolean"}function j5(a){return a&&N_(a.canLoad)}function U5(a){return a&&N_(a.canActivate)}function H5(a){return a&&N_(a.canActivateChild)}function $5(a){return a&&N_(a.canDeactivate)}function G5(a){return a&&N_(a.canMatch)}function rO(a){return a instanceof Al||a?.name==="EmptyError"}var qx=Symbol("INITIAL_VALUE");function Ip(){return bs(a=>h0(a.map(c=>c.pipe(Rl(1),Kw(qx)))).pipe(fi(c=>{for(let d of c)if(d!==!0){if(d===qx)return qx;if(d===!1||q5(d))return d}return!0}),Io(c=>c!==qx),Rl(1)))}function q5(a){return mu(a)||a instanceof Tp}function W5(a,c){return Cr(d=>{let{targetSnapshot:g,currentSnapshot:w,guards:{canActivateChecks:i,canDeactivateChecks:A}}=d;return A.length===0&&i.length===0?Vn(Oi(Wt({},d),{guardsResult:!0})):Z5(A,g,w,a).pipe(Cr(N=>N&&V5(N)?X5(g,i,a,c):Vn(N)),fi(N=>Oi(Wt({},d),{guardsResult:N})))})}function Z5(a,c,d,g){return yr(a).pipe(Cr(w=>e4(w.component,w.route,d,c,g)),Pl(w=>w!==!0,!0))}function X5(a,c,d,g){return yr(c).pipe(Bf(w=>zf(K5(w.route.parent,g),Y5(w.route,g),Q5(a,w.path,d),J5(a,w.route,d))),Pl(w=>w!==!0,!0))}function Y5(a,c){return a!==null&&c&&c(new sb(a)),Vn(!0)}function K5(a,c){return a!==null&&c&&c(new rb(a)),Vn(!0)}function J5(a,c,d){let g=c.routeConfig?c.routeConfig.canActivate:null;if(!g||g.length===0)return Vn(!0);let w=g.map(i=>Tg(()=>{let A=Sp(c)??d,N=Cp(i,A),H=U5(N)?N.canActivate(c,a):Do(A,()=>N(c,a));return Gl(H).pipe(Pl())}));return Vn(w).pipe(Ip())}function Q5(a,c,d){let g=c[c.length-1],i=c.slice(0,c.length-1).reverse().map(A=>N5(A)).filter(A=>A!==null).map(A=>Tg(()=>{let N=A.guards.map(H=>{let ce=Sp(A.node)??d,be=Cp(H,ce),Pe=H5(be)?be.canActivateChild(g,a):Do(ce,()=>be(g,a));return Gl(Pe).pipe(Pl())});return Vn(N).pipe(Ip())}));return Vn(i).pipe(Ip())}function e4(a,c,d,g,w){let i=c&&c.routeConfig?c.routeConfig.canDeactivate:null;if(!i||i.length===0)return Vn(!0);let A=i.map(N=>{let H=Sp(c)??w,ce=Cp(N,H),be=$5(ce)?ce.canDeactivate(a,c,d,g):Do(H,()=>ce(a,c,d,g));return Gl(be).pipe(Pl())});return Vn(A).pipe(Ip())}function t4(a,c,d,g){let w=c.canLoad;if(w===void 0||w.length===0)return Vn(!0);let i=w.map(A=>{let N=Cp(A,a),H=j5(N)?N.canLoad(c,d):Do(a,()=>N(c,d));return Gl(H)});return Vn(i).pipe(Ip(),oO(g))}function oO(a){return $w(Hr(c=>{if(typeof c!="boolean")throw hb(a,c)}),fi(c=>c===!0))}function n4(a,c,d,g){let w=c.canMatch;if(!w||w.length===0)return Vn(!0);let i=w.map(A=>{let N=Cp(A,a),H=G5(N)?N.canMatch(c,d):Do(a,()=>N(c,d));return Gl(H)});return Vn(i).pipe(Ip(),oO(g))}var P_=class{segmentGroup;constructor(c){this.segmentGroup=c||null}},L_=class extends Error{urlTree;constructor(c){super(),this.urlTree=c}};function yp(a){return Nf(new P_(a))}function i4(a){return Nf(new Qt(4e3,!1))}function r4(a){return Nf(nO(!1,Ro.GuardRejected))}var QI=class{urlSerializer;urlTree;constructor(c,d){this.urlSerializer=c,this.urlTree=d}lineralizeSegments(c,d){let g=[],w=d.root;for(;;){if(g=g.concat(w.segments),w.numberOfChildren===0)return Vn(g);if(w.numberOfChildren>1||!w.children[Gn])return i4(`${c.redirectTo}`);w=w.children[Gn]}}applyRedirectCommands(c,d,g,w,i){return o4(d,w,i).pipe(fi(A=>{if(A instanceof Ja)throw new L_(A);let N=this.applyRedirectCreateUrlTree(A,this.urlSerializer.parse(A),c,g);if(A[0]==="/")throw new L_(N);return N}))}applyRedirectCreateUrlTree(c,d,g,w){let i=this.createSegmentGroup(c,d.root,g,w);return new Ja(i,this.createQueryParams(d.queryParams,this.urlTree.queryParams),d.fragment)}createQueryParams(c,d){let g={};return Object.entries(c).forEach(([w,i])=>{if(typeof i=="string"&&i[0]===":"){let N=i.substring(1);g[w]=d[N]}else g[w]=i}),g}createSegmentGroup(c,d,g,w){let i=this.createSegments(c,d.segments,g,w),A={};return Object.entries(d.children).forEach(([N,H])=>{A[N]=this.createSegmentGroup(c,H,g,w)}),new ki(i,A)}createSegments(c,d,g,w){return d.map(i=>i.path[0]===":"?this.findPosParam(c,i,w):this.findOrReturn(i,g))}findPosParam(c,d,g){let w=g[d.path.substring(1)];if(!w)throw new Qt(4001,!1);return w}findOrReturn(c,d){let g=0;for(let w of d){if(w.path===c.path)return d.splice(g),w;g++}return c}};function o4(a,c,d){if(typeof a=="string")return Vn(a);let g=a,{queryParams:w,fragment:i,routeConfig:A,url:N,outlet:H,params:ce,data:be,title:Pe}=c;return Gl(Do(d,()=>g({params:ce,data:be,queryParams:w,fragment:i,routeConfig:A,url:N,outlet:H,title:Pe})))}var eS={matched:!1,consumedSegments:[],remainingSegments:[],parameters:{},positionalParamSegments:{}};function s4(a,c,d,g,w){let i=sO(a,c,d);return i.matched?(g=C5(c,g),n4(g,c,d,w).pipe(fi(A=>A===!0?i:Wt({},eS)))):Vn(i)}function sO(a,c,d){if(c.path==="**")return a4(d);if(c.path==="")return c.pathMatch==="full"&&(a.hasChildren()||d.length>0)?Wt({},eS):{matched:!0,consumedSegments:[],remainingSegments:d,parameters:{},positionalParamSegments:{}};let w=(c.matcher||kL)(d,a,c);if(!w)return Wt({},eS);let i={};Object.entries(w.posParams??{}).forEach(([N,H])=>{i[N]=H.path});let A=w.consumed.length>0?Wt(Wt({},i),w.consumed[w.consumed.length-1].parameters):i;return{matched:!0,consumedSegments:w.consumed,remainingSegments:d.slice(w.consumed.length),parameters:A,positionalParamSegments:w.posParams??{}}}function a4(a){return{matched:!0,parameters:a.length>0?NL(a).parameters:{},consumedSegments:a,remainingSegments:[],positionalParamSegments:{}}}function PL(a,c,d,g){return d.length>0&&u4(a,d,g)?{segmentGroup:new ki(c,c4(g,new ki(d,a.children))),slicedSegments:[]}:d.length===0&&h4(a,d,g)?{segmentGroup:new ki(a.segments,l4(a,d,g,a.children)),slicedSegments:d}:{segmentGroup:new ki(a.segments,a.children),slicedSegments:d}}function l4(a,c,d,g){let w={};for(let i of d)if(mb(a,c,i)&&!g[aa(i)]){let A=new ki([],{});w[aa(i)]=A}return Wt(Wt({},g),w)}function c4(a,c){let d={};d[Gn]=c;for(let g of a)if(g.path===""&&aa(g)!==Gn){let w=new ki([],{});d[aa(g)]=w}return d}function u4(a,c,d){return d.some(g=>mb(a,c,g)&&aa(g)!==Gn)}function h4(a,c,d){return d.some(g=>mb(a,c,g))}function mb(a,c,d){return(a.hasChildren()||c.length>0)&&d.pathMatch==="full"?!1:d.path===""}function d4(a,c,d){return c.length===0&&!a.children[d]}var tS=class{};function f4(a,c,d,g,w,i,A="emptyOnly"){return new nS(a,c,d,g,w,A,i).recognize()}var p4=31,nS=class{injector;configLoader;rootComponentType;config;urlTree;paramsInheritanceStrategy;urlSerializer;applyRedirects;absoluteRedirectCount=0;allowRedirects=!0;constructor(c,d,g,w,i,A,N){this.injector=c,this.configLoader=d,this.rootComponentType=g,this.config=w,this.urlTree=i,this.paramsInheritanceStrategy=A,this.urlSerializer=N,this.applyRedirects=new QI(this.urlSerializer,this.urlTree)}noMatchError(c){return new Qt(4002,`'${c.segmentGroup}'`)}recognize(){let c=PL(this.urlTree.root,[],[],this.config).segmentGroup;return this.match(c).pipe(fi(({children:d,rootSnapshot:g})=>{let w=new us(g,d),i=new A_("",w),A=qL(g,[],this.urlTree.queryParams,this.urlTree.fragment);return A.queryParams=this.urlTree.queryParams,i.url=this.urlSerializer.serialize(A),{state:i,tree:A}}))}match(c){let d=new Jh([],Object.freeze({}),Object.freeze(Wt({},this.urlTree.queryParams)),this.urlTree.fragment,Object.freeze({}),Gn,this.rootComponentType,null,{});return this.processSegmentGroup(this.injector,this.config,c,Gn,d).pipe(fi(g=>({children:g,rootSnapshot:d})),Xc(g=>{if(g instanceof L_)return this.urlTree=g.urlTree,this.match(g.urlTree.root);throw g instanceof P_?this.noMatchError(g):g}))}processSegmentGroup(c,d,g,w,i){return g.segments.length===0&&g.hasChildren()?this.processChildren(c,d,g,i):this.processSegment(c,d,g,g.segments,w,!0,i).pipe(fi(A=>A instanceof us?[A]:[]))}processChildren(c,d,g,w){let i=[];for(let A of Object.keys(g.children))A==="primary"?i.unshift(A):i.push(A);return yr(i).pipe(Bf(A=>{let N=g.children[A],H=M5(d,A);return this.processSegmentGroup(c,H,N,A,w)}),Yw((A,N)=>(A.push(...N),A)),Yc(null),Xw(),Cr(A=>{if(A===null)return yp(g);let N=aO(A);return m4(N),Vn(N)}))}processSegment(c,d,g,w,i,A,N){return yr(d).pipe(Bf(H=>this.processSegmentAgainstRoute(H._injector??c,d,H,g,w,i,A,N).pipe(Xc(ce=>{if(ce instanceof P_)return Vn(null);throw ce}))),Pl(H=>!!H),Xc(H=>{if(rO(H))return d4(g,w,i)?Vn(new tS):yp(g);throw H}))}processSegmentAgainstRoute(c,d,g,w,i,A,N,H){return aa(g)!==A&&(A===Gn||!mb(w,i,g))?yp(w):g.redirectTo===void 0?this.matchSegmentAgainstRoute(c,w,g,i,A,H):this.allowRedirects&&N?this.expandSegmentAgainstRouteUsingRedirect(c,w,d,g,i,A,H):yp(w)}expandSegmentAgainstRouteUsingRedirect(c,d,g,w,i,A,N){let{matched:H,parameters:ce,consumedSegments:be,positionalParamSegments:Pe,remainingSegments:st}=sO(d,w,i);if(!H)return yp(d);typeof w.redirectTo=="string"&&w.redirectTo[0]==="/"&&(this.absoluteRedirectCount++,this.absoluteRedirectCount>p4&&(this.allowRedirects=!1));let Se=new Jh(i,ce,Object.freeze(Wt({},this.urlTree.queryParams)),this.urlTree.fragment,LL(w),aa(w),w.component??w._loadedComponent??null,w,OL(w)),It=ub(Se,N,this.paramsInheritanceStrategy);return Se.params=Object.freeze(It.params),Se.data=Object.freeze(It.data),this.applyRedirects.applyRedirectCommands(be,w.redirectTo,Pe,Se,c).pipe(bs(hn=>this.applyRedirects.lineralizeSegments(w,hn)),Cr(hn=>this.processSegment(c,g,d,hn.concat(st),A,!1,N)))}matchSegmentAgainstRoute(c,d,g,w,i,A){let N=s4(d,g,w,c,this.urlSerializer);return g.path==="**"&&(d.children={}),N.pipe(bs(H=>H.matched?(c=g._injector??c,this.getChildConfig(c,g,w).pipe(bs(({routes:ce})=>{let be=g._loadedInjector??c,{parameters:Pe,consumedSegments:st,remainingSegments:Se}=H,It=new Jh(st,Pe,Object.freeze(Wt({},this.urlTree.queryParams)),this.urlTree.fragment,LL(g),aa(g),g.component??g._loadedComponent??null,g,OL(g)),Lt=ub(It,A,this.paramsInheritanceStrategy);It.params=Object.freeze(Lt.params),It.data=Object.freeze(Lt.data);let{segmentGroup:hn,slicedSegments:sn}=PL(d,st,Se,ce);if(sn.length===0&&hn.hasChildren())return this.processChildren(be,ce,hn,It).pipe(fi(fr=>new us(It,fr)));if(ce.length===0&&sn.length===0)return Vn(new us(It,[]));let Yi=aa(g)===i;return this.processSegment(be,ce,hn,sn,Yi?Gn:i,!0,It).pipe(fi(fr=>new us(It,fr instanceof us?[fr]:[])))}))):yp(d)))}getChildConfig(c,d,g){return d.children?Vn({routes:d.children,injector:c}):d.loadChildren?d._loadedRoutes!==void 0?Vn({routes:d._loadedRoutes,injector:d._loadedInjector}):t4(c,d,g,this.urlSerializer).pipe(Cr(w=>w?this.configLoader.loadChildren(c,d).pipe(Hr(i=>{d._loadedRoutes=i.routes,d._loadedInjector=i.injector})):r4(d))):Vn({routes:[],injector:c})}};function m4(a){a.sort((c,d)=>c.value.outlet===Gn?-1:d.value.outlet===Gn?1:c.value.outlet.localeCompare(d.value.outlet))}function g4(a){let c=a.value.routeConfig;return c&&c.path===""}function aO(a){let c=[],d=new Set;for(let g of a){if(!g4(g)){c.push(g);continue}let w=c.find(i=>g.value.routeConfig===i.value.routeConfig);w!==void 0?(w.children.push(...g.children),d.add(w)):c.push(g)}for(let g of d){let w=aO(g.children);c.push(new us(g.value,w))}return c.filter(g=>!d.has(g))}function LL(a){return a.data||{}}function OL(a){return a.resolve||{}}function _4(a,c,d,g,w,i){return Cr(A=>f4(a,c,d,g,A.extractedUrl,w,i).pipe(fi(({state:N,tree:H})=>Oi(Wt({},A),{targetSnapshot:N,urlAfterRedirects:H}))))}function y4(a,c){return Cr(d=>{let{targetSnapshot:g,guards:{canActivateChecks:w}}=d;if(!w.length)return Vn(d);let i=new Set(w.map(H=>H.route)),A=new Set;for(let H of i)if(!A.has(H))for(let ce of lO(H))A.add(ce);let N=0;return yr(A).pipe(Bf(H=>i.has(H)?v4(H,g,a,c):(H.data=ub(H,H.parent,a).resolve,Vn(void 0))),Hr(()=>N++),Vf(1),Cr(H=>N===A.size?Vn(d):jo))})}function lO(a){let c=a.children.map(d=>lO(d)).flat();return[a,...c]}function v4(a,c,d,g){let w=a.routeConfig,i=a._resolve;return w?.title!==void 0&&!QL(w)&&(i[O_]=w.title),Tg(()=>(a.data=ub(a,a.parent,d).resolve,x4(i,a,c,g).pipe(fi(A=>(a._resolvedData=A,a.data=Wt(Wt({},a.data),A),null)))))}function x4(a,c,d,g){let w=$I(a);if(w.length===0)return Vn({});let i={};return yr(w).pipe(Cr(A=>b4(a[A],c,d,g).pipe(Pl(),Hr(N=>{if(N instanceof Tp)throw hb(new ed,N);i[A]=N}))),Vf(1),fi(()=>i),Xc(A=>rO(A)?jo:Nf(A)))}function b4(a,c,d,g){let w=Sp(c)??g,i=Cp(a,w),A=i.resolve?i.resolve(c,d):Do(w,()=>i(c,d));return Gl(A)}function UI(a){return bs(c=>{let d=a(c);return d?yr(d).pipe(fi(()=>c)):Vn(c)})}var sS=(()=>{class a{buildTitle(d){let g,w=d.root;for(;w!==void 0;)g=this.getResolvedTitleForRoute(w)??g,w=w.children.find(i=>i.outlet===Gn);return g}getResolvedTitleForRoute(d){return d.data[O_]}static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:()=>At(cO),providedIn:"root"})}return a})(),cO=(()=>{class a extends sS{title;constructor(d){super(),this.title=d}updateTitle(d){let g=this.buildTitle(d);g!==void 0&&this.title.setTitle(g)}static \u0275fac=function(g){return new(g||a)($n(DL))};static \u0275prov=Tn({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),Mp=new En("",{providedIn:"root",factory:()=>({})}),z_=new En(""),uO=(()=>{class a{componentLoaders=new WeakMap;childrenLoaders=new WeakMap;onLoadStartListener;onLoadEndListener;compiler=At(gI);loadComponent(d,g){if(this.componentLoaders.get(g))return this.componentLoaders.get(g);if(g._loadedComponent)return Vn(g._loadedComponent);this.onLoadStartListener&&this.onLoadStartListener(g);let w=Gl(Do(d,()=>g.loadComponent())).pipe(fi(dO),Hr(A=>{this.onLoadEndListener&&this.onLoadEndListener(g),g._loadedComponent=A}),Ig(()=>{this.componentLoaders.delete(g)})),i=new Ff(w,()=>new Dr).pipe(kf());return this.componentLoaders.set(g,i),i}loadChildren(d,g){if(this.childrenLoaders.get(g))return this.childrenLoaders.get(g);if(g._loadedRoutes)return Vn({routes:g._loadedRoutes,injector:g._loadedInjector});this.onLoadStartListener&&this.onLoadStartListener(g);let i=hO(g,this.compiler,d,this.onLoadEndListener).pipe(Ig(()=>{this.childrenLoaders.delete(g)})),A=new Ff(i,()=>new Dr).pipe(kf());return this.childrenLoaders.set(g,A),A}static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function hO(a,c,d,g){return Gl(Do(d,()=>a.loadChildren())).pipe(fi(dO),Cr(w=>w instanceof Dx||Array.isArray(w)?Vn(w):yr(c.compileModuleAsync(w))),fi(w=>{g&&g(a);let i,A,N=!1;return Array.isArray(w)?(A=w,N=!0):(i=w.create(d).injector,A=i.get(z_,[],{optional:!0,self:!0}).flat()),{routes:A.map(oS),injector:i}}))}function w4(a){return a&&typeof a=="object"&&"default"in a}function dO(a){return w4(a)?a.default:a}var gb=(()=>{class a{static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:()=>At(E4),providedIn:"root"})}return a})(),E4=(()=>{class a{shouldProcessUrl(d){return!0}extract(d){return d}merge(d,g){return d}static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),fO=new En("");var pO=new En(""),mO=(()=>{class a{currentNavigation=null;currentTransition=null;lastSuccessfulNavigation=null;events=new Dr;transitionAbortWithErrorSubject=new Dr;configLoader=At(uO);environmentInjector=At($r);destroyRef=At(ra);urlSerializer=At(k_);rootContexts=At(Dp);location=At(gp);inputBindingEnabled=At(pb,{optional:!0})!==null;titleStrategy=At(sS);options=At(Mp,{optional:!0})||{};paramsInheritanceStrategy=this.options.paramsInheritanceStrategy||"emptyOnly";urlHandlingStrategy=At(gb);createViewTransition=At(fO,{optional:!0});navigationErrorHandler=At(pO,{optional:!0});navigationId=0;get hasRequestedNavigation(){return this.navigationId!==0}transitions;afterPreactivation=()=>Vn(void 0);rootComponentType=null;destroyed=!1;constructor(){let d=w=>this.events.next(new nb(w)),g=w=>this.events.next(new ib(w));this.configLoader.onLoadEndListener=g,this.configLoader.onLoadStartListener=d,this.destroyRef.onDestroy(()=>{this.destroyed=!0})}complete(){this.transitions?.complete()}handleNavigationRequest(d){let g=++this.navigationId;this.transitions?.next(Oi(Wt({},d),{extractedUrl:this.urlHandlingStrategy.extract(d.rawUrl),targetSnapshot:null,targetRouterState:null,guards:{canActivateChecks:[],canDeactivateChecks:[]},guardsResult:null,abortController:new AbortController,id:g}))}setupNavigations(d){return this.transitions=new eo(null),this.transitions.pipe(Io(g=>g!==null),bs(g=>{let w=!1;return Vn(g).pipe(bs(i=>{if(this.navigationId>g.id)return this.cancelNavigationTransition(g,"",Ro.SupersededByNewNavigation),jo;this.currentTransition=g,this.currentNavigation={id:i.id,initialUrl:i.rawUrl,extractedUrl:i.extractedUrl,targetBrowserUrl:typeof i.extras.browserUrl=="string"?this.urlSerializer.parse(i.extras.browserUrl):i.extras.browserUrl,trigger:i.source,extras:i.extras,previousNavigation:this.lastSuccessfulNavigation?Oi(Wt({},this.lastSuccessfulNavigation),{previousNavigation:null}):null,abort:()=>i.abortController.abort()};let A=!d.navigated||this.isUpdatingInternalState()||this.isUpdatedBrowserUrl(),N=i.extras.onSameUrlNavigation??d.onSameUrlNavigation;if(!A&&N!=="reload"){let H="";return this.events.next(new Hl(i.id,this.urlSerializer.serialize(i.rawUrl),H,S_.IgnoredSameUrlNavigation)),i.resolve(!1),jo}if(this.urlHandlingStrategy.shouldProcessUrl(i.rawUrl))return Vn(i).pipe(bs(H=>(this.events.next(new td(H.id,this.urlSerializer.serialize(H.extractedUrl),H.source,H.restoredState)),H.id!==this.navigationId?jo:Promise.resolve(H))),_4(this.environmentInjector,this.configLoader,this.rootComponentType,d.config,this.urlSerializer,this.paramsInheritanceStrategy),Hr(H=>{g.targetSnapshot=H.targetSnapshot,g.urlAfterRedirects=H.urlAfterRedirects,this.currentNavigation=Oi(Wt({},this.currentNavigation),{finalUrl:H.urlAfterRedirects});let ce=new D_(H.id,this.urlSerializer.serialize(H.extractedUrl),this.urlSerializer.serialize(H.urlAfterRedirects),H.targetSnapshot);this.events.next(ce)}));if(A&&this.urlHandlingStrategy.shouldProcessUrl(i.currentRawUrl)){let{id:H,extractedUrl:ce,source:be,restoredState:Pe,extras:st}=i,Se=new td(H,this.urlSerializer.serialize(ce),be,Pe);this.events.next(Se);let It=KL(this.rootComponentType).snapshot;return this.currentTransition=g=Oi(Wt({},i),{targetSnapshot:It,urlAfterRedirects:ce,extras:Oi(Wt({},st),{skipLocationChange:!1,replaceUrl:!1})}),this.currentNavigation.finalUrl=ce,Vn(g)}else{let H="";return this.events.next(new Hl(i.id,this.urlSerializer.serialize(i.extractedUrl),H,S_.IgnoredByUrlHandlingStrategy)),i.resolve(!1),jo}}),Hr(i=>{let A=new Jx(i.id,this.urlSerializer.serialize(i.extractedUrl),this.urlSerializer.serialize(i.urlAfterRedirects),i.targetSnapshot);this.events.next(A)}),fi(i=>(this.currentTransition=g=Oi(Wt({},i),{guards:F5(i.targetSnapshot,i.currentSnapshot,this.rootContexts)}),g)),W5(this.environmentInjector,i=>this.events.next(i)),Hr(i=>{if(g.guardsResult=i.guardsResult,i.guardsResult&&typeof i.guardsResult!="boolean")throw hb(this.urlSerializer,i.guardsResult);let A=new Qx(i.id,this.urlSerializer.serialize(i.extractedUrl),this.urlSerializer.serialize(i.urlAfterRedirects),i.targetSnapshot,!!i.guardsResult);this.events.next(A)}),Io(i=>i.guardsResult?!0:(this.cancelNavigationTransition(i,"",Ro.GuardRejected),!1)),UI(i=>{if(i.guards.canActivateChecks.length!==0)return Vn(i).pipe(Hr(A=>{let N=new eb(A.id,this.urlSerializer.serialize(A.extractedUrl),this.urlSerializer.serialize(A.urlAfterRedirects),A.targetSnapshot);this.events.next(N)}),bs(A=>{let N=!1;return Vn(A).pipe(y4(this.paramsInheritanceStrategy,this.environmentInjector),Hr({next:()=>N=!0,complete:()=>{N||this.cancelNavigationTransition(A,"",Ro.NoDataFromResolver)}}))}),Hr(A=>{let N=new tb(A.id,this.urlSerializer.serialize(A.extractedUrl),this.urlSerializer.serialize(A.urlAfterRedirects),A.targetSnapshot);this.events.next(N)}))}),UI(i=>{let A=N=>{let H=[];if(N.routeConfig?.loadComponent&&!N.routeConfig._loadedComponent){let ce=Sp(N)??this.environmentInjector;H.push(this.configLoader.loadComponent(ce,N.routeConfig).pipe(Hr(be=>{N.component=be}),fi(()=>{})))}for(let ce of N.children)H.push(...A(ce));return H};return h0(A(i.targetSnapshot.root)).pipe(Yc(null),Rl(1))}),UI(()=>this.afterPreactivation()),bs(()=>{let{currentSnapshot:i,targetSnapshot:A}=g,N=this.createViewTransition?.(this.environmentInjector,i.root,A.root);return N?yr(N).pipe(fi(()=>g)):Vn(g)}),fi(i=>{let A=R5(d.routeReuseStrategy,i.targetSnapshot,i.currentRouterState);return this.currentTransition=g=Oi(Wt({},i),{targetRouterState:A}),this.currentNavigation.targetRouterState=A,g}),Hr(()=>{this.events.next(new C_)}),k5(this.rootContexts,d.routeReuseStrategy,i=>this.events.next(i),this.inputBindingEnabled),Rl(1),f0(new Ai(i=>{let A=g.abortController.signal,N=()=>i.next();return A.addEventListener("abort",N),()=>A.removeEventListener("abort",N)}).pipe(Io(()=>!w&&!g.targetRouterState),Hr(()=>{this.cancelNavigationTransition(g,g.abortController.signal.reason+"",Ro.Aborted)}))),Hr({next:i=>{w=!0,this.lastSuccessfulNavigation=this.currentNavigation,this.events.next(new Ds(i.id,this.urlSerializer.serialize(i.extractedUrl),this.urlSerializer.serialize(i.urlAfterRedirects))),this.titleStrategy?.updateTitle(i.targetRouterState.snapshot),i.resolve(!0)},complete:()=>{w=!0}}),f0(this.transitionAbortWithErrorSubject.pipe(Hr(i=>{throw i}))),Ig(()=>{w||this.cancelNavigationTransition(g,"",Ro.SupersededByNewNavigation),this.currentTransition?.id===g.id&&(this.currentNavigation=null,this.currentTransition=null)}),Xc(i=>{if(this.destroyed)return g.resolve(!1),jo;if(w=!0,iO(i))this.events.next(new Ka(g.id,this.urlSerializer.serialize(g.extractedUrl),i.message,i.cancellationCode)),O5(i)?this.events.next(new Ep(i.url,i.navigationBehaviorOptions)):g.resolve(!1);else{let A=new wp(g.id,this.urlSerializer.serialize(g.extractedUrl),i,g.targetSnapshot??void 0);try{let N=Do(this.environmentInjector,()=>this.navigationErrorHandler?.(A));if(N instanceof Tp){let{message:H,cancellationCode:ce}=hb(this.urlSerializer,N);this.events.next(new Ka(g.id,this.urlSerializer.serialize(g.extractedUrl),H,ce)),this.events.next(new Ep(N.redirectTo,N.navigationBehaviorOptions))}else throw this.events.next(A),i}catch(N){this.options.resolveNavigationPromiseOnError?g.resolve(!1):g.reject(N)}}return jo}))}))}cancelNavigationTransition(d,g,w){let i=new Ka(d.id,this.urlSerializer.serialize(d.extractedUrl),g,w);this.events.next(i),d.resolve(!1)}isUpdatingInternalState(){return this.currentTransition?.extractedUrl.toString()!==this.currentTransition?.currentUrlTree.toString()}isUpdatedBrowserUrl(){let d=this.urlHandlingStrategy.extract(this.urlSerializer.parse(this.location.path(!0))),g=this.currentNavigation?.targetBrowserUrl??this.currentNavigation?.extractedUrl;return d.toString()!==g?.toString()&&!this.currentNavigation?.extras.skipLocationChange}static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function T4(a){return a!==E_}var gO=(()=>{class a{static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:()=>At(I4),providedIn:"root"})}return a})(),fb=class{shouldDetach(c){return!1}store(c,d){}shouldAttach(c){return!1}retrieve(c){return null}shouldReuseRoute(c,d){return c.routeConfig===d.routeConfig}},I4=(()=>{class a extends fb{static \u0275fac=(()=>{let d;return function(w){return(d||(d=gx(a)))(w||a)}})();static \u0275prov=Tn({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})(),_O=(()=>{class a{urlSerializer=At(k_);options=At(Mp,{optional:!0})||{};canceledNavigationResolution=this.options.canceledNavigationResolution||"replace";location=At(gp);urlHandlingStrategy=At(gb);urlUpdateStrategy=this.options.urlUpdateStrategy||"deferred";currentUrlTree=new Ja;getCurrentUrlTree(){return this.currentUrlTree}rawUrlTree=this.currentUrlTree;getRawUrlTree(){return this.rawUrlTree}createBrowserPath({finalUrl:d,initialUrl:g,targetBrowserUrl:w}){let i=d!==void 0?this.urlHandlingStrategy.merge(d,g):g,A=w??i;return A instanceof Ja?this.urlSerializer.serialize(A):A}commitTransition({targetRouterState:d,finalUrl:g,initialUrl:w}){g&&d?(this.currentUrlTree=g,this.rawUrlTree=this.urlHandlingStrategy.merge(g,w),this.routerState=d):this.rawUrlTree=w}routerState=KL(null);getRouterState(){return this.routerState}stateMemento=this.createStateMemento();updateStateMemento(){this.stateMemento=this.createStateMemento()}createStateMemento(){return{rawUrlTree:this.rawUrlTree,currentUrlTree:this.currentUrlTree,routerState:this.routerState}}resetInternalState({finalUrl:d}){this.routerState=this.stateMemento.routerState,this.currentUrlTree=this.stateMemento.currentUrlTree,this.rawUrlTree=this.urlHandlingStrategy.merge(this.currentUrlTree,d??this.rawUrlTree)}static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:()=>At(S4),providedIn:"root"})}return a})(),S4=(()=>{class a extends _O{currentPageId=0;lastSuccessfulId=-1;restoredState(){return this.location.getState()}get browserPageId(){return this.canceledNavigationResolution!=="computed"?this.currentPageId:this.restoredState()?.\u0275routerPageId??this.currentPageId}registerNonRouterCurrentEntryChangeListener(d){return this.location.subscribe(g=>{g.type==="popstate"&&setTimeout(()=>{d(g.url,g.state,"popstate")})})}handleRouterEvent(d,g){d instanceof td?this.updateStateMemento():d instanceof Hl?this.commitTransition(g):d instanceof D_?this.urlUpdateStrategy==="eager"&&(g.extras.skipLocationChange||this.setBrowserUrl(this.createBrowserPath(g),g)):d instanceof C_?(this.commitTransition(g),this.urlUpdateStrategy==="deferred"&&!g.extras.skipLocationChange&&this.setBrowserUrl(this.createBrowserPath(g),g)):d instanceof Ka&&d.code!==Ro.SupersededByNewNavigation&&d.code!==Ro.Redirect?this.restoreHistory(g):d instanceof wp?this.restoreHistory(g,!0):d instanceof Ds&&(this.lastSuccessfulId=d.id,this.currentPageId=this.browserPageId)}setBrowserUrl(d,{extras:g,id:w}){let{replaceUrl:i,state:A}=g;if(this.location.isCurrentPathEqualTo(d)||i){let N=this.browserPageId,H=Wt(Wt({},A),this.generateNgRouterState(w,N));this.location.replaceState(d,"",H)}else{let N=Wt(Wt({},A),this.generateNgRouterState(w,this.browserPageId+1));this.location.go(d,"",N)}}restoreHistory(d,g=!1){if(this.canceledNavigationResolution==="computed"){let w=this.browserPageId,i=this.currentPageId-w;i!==0?this.location.historyGo(i):this.getCurrentUrlTree()===d.finalUrl&&i===0&&(this.resetInternalState(d),this.resetUrlToCurrentUrlTree())}else this.canceledNavigationResolution==="replace"&&(g&&this.resetInternalState(d),this.resetUrlToCurrentUrlTree())}resetUrlToCurrentUrlTree(){this.location.replaceState(this.urlSerializer.serialize(this.getRawUrlTree()),"",this.generateNgRouterState(this.lastSuccessfulId,this.currentPageId))}generateNgRouterState(d,g){return this.canceledNavigationResolution==="computed"?{navigationId:d,\u0275routerPageId:g}:{navigationId:d}}static \u0275fac=(()=>{let d;return function(w){return(d||(d=gx(a)))(w||a)}})();static \u0275prov=Tn({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function aS(a,c){a.events.pipe(Io(d=>d instanceof Ds||d instanceof Ka||d instanceof wp||d instanceof Hl),fi(d=>d instanceof Ds||d instanceof Hl?0:(d instanceof Ka?d.code===Ro.Redirect||d.code===Ro.SupersededByNewNavigation:!1)?2:1),Io(d=>d!==2),Rl(1)).subscribe(()=>{c()})}var D4={paths:"exact",fragment:"ignored",matrixParams:"ignored",queryParams:"exact"},C4={paths:"subset",fragment:"ignored",matrixParams:"ignored",queryParams:"subset"},nd=(()=>{class a{get currentUrlTree(){return this.stateManager.getCurrentUrlTree()}get rawUrlTree(){return this.stateManager.getRawUrlTree()}disposed=!1;nonRouterCurrentEntryChangeSubscription;console=At(sI);stateManager=At(_O);options=At(Mp,{optional:!0})||{};pendingTasks=At(Nl);urlUpdateStrategy=this.options.urlUpdateStrategy||"deferred";navigationTransitions=At(mO);urlSerializer=At(k_);location=At(gp);urlHandlingStrategy=At(gb);injector=At($r);_events=new Dr;get events(){return this._events}get routerState(){return this.stateManager.getRouterState()}navigated=!1;routeReuseStrategy=At(gO);onSameUrlNavigation=this.options.onSameUrlNavigation||"ignore";config=At(z_,{optional:!0})?.flat()??[];componentInputBindingEnabled=!!At(pb,{optional:!0});constructor(){this.resetConfig(this.config),this.navigationTransitions.setupNavigations(this).subscribe({error:d=>{this.console.warn(d)}}),this.subscribeToNavigationEvents()}eventsSubscription=new _r;subscribeToNavigationEvents(){let d=this.navigationTransitions.events.subscribe(g=>{try{let w=this.navigationTransitions.currentTransition,i=this.navigationTransitions.currentNavigation;if(w!==null&&i!==null){if(this.stateManager.handleRouterEvent(g,i),g instanceof Ka&&g.code!==Ro.Redirect&&g.code!==Ro.SupersededByNewNavigation)this.navigated=!0;else if(g instanceof Ds)this.navigated=!0;else if(g instanceof Ep){let A=g.navigationBehaviorOptions,N=this.urlHandlingStrategy.merge(g.url,w.currentRawUrl),H=Wt({browserUrl:w.extras.browserUrl,info:w.extras.info,skipLocationChange:w.extras.skipLocationChange,replaceUrl:w.extras.replaceUrl||this.urlUpdateStrategy==="eager"||T4(w.source)},A);this.scheduleNavigation(N,E_,null,H,{resolve:w.resolve,reject:w.reject,promise:w.promise})}}D5(g)&&this._events.next(g)}catch(w){this.navigationTransitions.transitionAbortWithErrorSubject.next(w)}});this.eventsSubscription.add(d)}resetRootComponentType(d){this.routerState.root.component=d,this.navigationTransitions.rootComponentType=d}initialNavigation(){this.setUpLocationChangeListener(),this.navigationTransitions.hasRequestedNavigation||this.navigateToSyncWithBrowser(this.location.path(!0),E_,this.stateManager.restoredState())}setUpLocationChangeListener(){this.nonRouterCurrentEntryChangeSubscription??=this.stateManager.registerNonRouterCurrentEntryChangeListener((d,g,w)=>{this.navigateToSyncWithBrowser(d,w,g)})}navigateToSyncWithBrowser(d,g,w){let i={replaceUrl:!0},A=w?.navigationId?w:null;if(w){let H=Wt({},w);delete H.navigationId,delete H.\u0275routerPageId,Object.keys(H).length!==0&&(i.state=H)}let N=this.parseUrl(d);this.scheduleNavigation(N,g,A,i).catch(H=>{this.disposed||this.injector.get(ls)(H)})}get url(){return this.serializeUrl(this.currentUrlTree)}getCurrentNavigation(){return this.navigationTransitions.currentNavigation}get lastSuccessfulNavigation(){return this.navigationTransitions.lastSuccessfulNavigation}resetConfig(d){this.config=d.map(oS),this.navigated=!1}ngOnDestroy(){this.dispose()}dispose(){this._events.unsubscribe(),this.navigationTransitions.complete(),this.nonRouterCurrentEntryChangeSubscription&&(this.nonRouterCurrentEntryChangeSubscription.unsubscribe(),this.nonRouterCurrentEntryChangeSubscription=void 0),this.disposed=!0,this.eventsSubscription.unsubscribe()}createUrlTree(d,g={}){let{relativeTo:w,queryParams:i,fragment:A,queryParamsHandling:N,preserveFragment:H}=g,ce=H?this.currentUrlTree.fragment:A,be=null;switch(N??this.options.defaultQueryParamsHandling){case"merge":be=Wt(Wt({},this.currentUrlTree.queryParams),i);break;case"preserve":be=this.currentUrlTree.queryParams;break;default:be=i||null}be!==null&&(be=this.removeEmptyProps(be));let Pe;try{let st=w?w.snapshot:this.routerState.snapshot.root;Pe=WL(st)}catch{(typeof d[0]!="string"||d[0][0]!=="/")&&(d=[]),Pe=this.currentUrlTree.root}return ZL(Pe,d,be,ce??null)}navigateByUrl(d,g={skipLocationChange:!1}){let w=mu(d)?d:this.parseUrl(d),i=this.urlHandlingStrategy.merge(w,this.rawUrlTree);return this.scheduleNavigation(i,E_,null,g)}navigate(d,g={skipLocationChange:!1}){return M4(d),this.navigateByUrl(this.createUrlTree(d,g),g)}serializeUrl(d){return this.urlSerializer.serialize(d)}parseUrl(d){try{return this.urlSerializer.parse(d)}catch{return this.urlSerializer.parse("/")}}isActive(d,g){let w;if(g===!0?w=Wt({},D4):g===!1?w=Wt({},C4):w=g,mu(d))return CL(this.currentUrlTree,d,w);let i=this.parseUrl(d);return CL(this.currentUrlTree,i,w)}removeEmptyProps(d){return Object.entries(d).reduce((g,[w,i])=>(i!=null&&(g[w]=i),g),{})}scheduleNavigation(d,g,w,i,A){if(this.disposed)return Promise.resolve(!1);let N,H,ce;A?(N=A.resolve,H=A.reject,ce=A.promise):ce=new Promise((Pe,st)=>{N=Pe,H=st});let be=this.pendingTasks.add();return aS(this,()=>{queueMicrotask(()=>this.pendingTasks.remove(be))}),this.navigationTransitions.handleNavigationRequest({source:g,restoredState:w,currentUrlTree:this.currentUrlTree,currentRawUrl:this.currentUrlTree,rawUrl:d,extras:i,resolve:N,reject:H,promise:ce,currentSnapshot:this.routerState.snapshot,currentRouterState:this.routerState}),ce.catch(Pe=>Promise.reject(Pe))}static \u0275fac=function(g){return new(g||a)};static \u0275prov=Tn({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function M4(a){for(let c=0;c<a.length;c++)if(a[c]==null)throw new Qt(4008,!1)}var _b=(()=>{class a{router;route;tabIndexAttribute;renderer;el;locationStrategy;reactiveHref=dr(null);get href(){return u_(this.reactiveHref)}set href(d){this.reactiveHref.set(d)}target;queryParams;fragment;queryParamsHandling;state;info;relativeTo;isAnchorElement;subscription;onChanges=new Dr;applicationErrorHandler=At(ls);options=At(Mp,{optional:!0});constructor(d,g,w,i,A,N){this.router=d,this.route=g,this.tabIndexAttribute=w,this.renderer=i,this.el=A,this.locationStrategy=N,this.reactiveHref.set(At(new Fx("href"),{optional:!0}));let H=A.nativeElement.tagName?.toLowerCase();this.isAnchorElement=H==="a"||H==="area"||!!(typeof customElements=="object"&&customElements.get(H)?.observedAttributes?.includes?.("href")),this.isAnchorElement?this.setTabIndexIfNotOnNativeEl("0"):this.subscribeToNavigationEventsIfNecessary()}subscribeToNavigationEventsIfNecessary(){if(this.subscription!==void 0||!this.isAnchorElement)return;let d=this.preserveFragment,g=w=>w==="merge"||w==="preserve";d||=g(this.queryParamsHandling),d||=!this.queryParamsHandling&&!g(this.options?.defaultQueryParamsHandling),d&&(this.subscription=this.router.events.subscribe(w=>{w instanceof Ds&&this.updateHref()}))}preserveFragment=!1;skipLocationChange=!1;replaceUrl=!1;setTabIndexIfNotOnNativeEl(d){this.tabIndexAttribute!=null||this.isAnchorElement||this.applyAttributeValue("tabindex",d)}ngOnChanges(d){this.isAnchorElement&&(this.updateHref(),this.subscribeToNavigationEventsIfNecessary()),this.onChanges.next(this)}routerLinkInput=null;set routerLink(d){d==null?(this.routerLinkInput=null,this.setTabIndexIfNotOnNativeEl(null)):(mu(d)?this.routerLinkInput=d:this.routerLinkInput=Array.isArray(d)?d:[d],this.setTabIndexIfNotOnNativeEl("0"))}onClick(d,g,w,i,A){let N=this.urlTree;if(N===null||this.isAnchorElement&&(d!==0||g||w||i||A||typeof this.target=="string"&&this.target!="_self"))return!0;let H={skipLocationChange:this.skipLocationChange,replaceUrl:this.replaceUrl,state:this.state,info:this.info};return this.router.navigateByUrl(N,H)?.catch(ce=>{this.applicationErrorHandler(ce)}),!this.isAnchorElement}ngOnDestroy(){this.subscription?.unsubscribe()}updateHref(){let d=this.urlTree;this.reactiveHref.set(d!==null&&this.locationStrategy?this.locationStrategy?.prepareExternalUrl(this.router.serializeUrl(d))??"":null)}applyAttributeValue(d,g){let w=this.renderer,i=this.el.nativeElement;g!==null?w.setAttribute(i,d,g):w.removeAttribute(i,d)}get urlTree(){return this.routerLinkInput===null?null:mu(this.routerLinkInput)?this.routerLinkInput:this.router.createUrlTree(this.routerLinkInput,{relativeTo:this.relativeTo!==void 0?this.relativeTo:this.route,queryParams:this.queryParams,fragment:this.fragment,queryParamsHandling:this.queryParamsHandling,preserveFragment:this.preserveFragment})}static \u0275fac=function(g){return new(g||a)(sa(nd),sa($l),e_("tabindex"),sa(Sx),sa(cu),sa(mp))};static \u0275dir=lp({type:a,selectors:[["","routerLink",""]],hostVars:2,hostBindings:function(g,w){g&1&&Lx("click",function(A){return w.onClick(A.button,A.ctrlKey,A.shiftKey,A.altKey,A.metaKey)}),g&2&&Ax("href",w.reactiveHref(),VT)("target",w.target)},inputs:{target:"target",queryParams:"queryParams",fragment:"fragment",queryParamsHandling:"queryParamsHandling",state:"state",info:"info",relativeTo:"relativeTo",preserveFragment:[2,"preserveFragment","preserveFragment",Vx],skipLocationChange:[2,"skipLocationChange","skipLocationChange",Vx],replaceUrl:[2,"replaceUrl","replaceUrl",Vx],routerLink:"routerLink"},features:[op]})}return a})();var R4=new En("");function lS(a,...c){return Og([{provide:z_,multi:!0,useValue:a},[],{provide:$l,useFactory:P4,deps:[nd]},{provide:Mx,multi:!0,useFactory:L4},c.map(d=>d.\u0275providers)])}function P4(a){return a.routerState.root}function L4(){let a=At(rs);return c=>{let d=a.get(Wh);if(c!==d.components[0])return;let g=a.get(nd),w=a.get(O4);a.get(k4)===1&&g.initialNavigation(),a.get(F4,null,{optional:!0})?.setUpPreloading(),a.get(R4,null,{optional:!0})?.init(),g.resetRootComponentType(d.componentTypes[0]),w.closed||(w.next(),w.complete(),w.unsubscribe())}}var O4=new En("",{factory:()=>new Dr}),k4=new En("",{providedIn:"root",factory:()=>1});var F4=new En("");var Rp=Aw(yb());var Ap={mapboxKey:"pk.eyJ1Ijoicm9iZXJ0b3ZpbGxhbG9uIiwiYSI6ImNtZWlzbzIxeDA1amMya29jNzZubm0xazAifQ.4pZR64Ul9Djk6fxfYx1X1Q"};var N4=["map"],z4=(a,c)=>({latitude:a,longitude:c});Rp.default.accessToken=Ap.mapboxKey;var vb=class a{divElement=pp("map");map=dr(null);zoom=dr(14);coordinates=dr({lat:40,lng:-74.5});zoomEffect=Ox(()=>{this.map()&&this.map()?.setZoom(this.zoom())});ngAfterViewInit(){return Va(this,null,function*(){if(!this.divElement()?.nativeElement)return;let c=this.divElement().nativeElement;yield new Promise(g=>setTimeout(g,80));let d=new Rp.default.Map({container:c,style:"mapbox://styles/mapbox/streets-v12",center:[this.coordinates().lng,this.coordinates().lat],zoom:this.zoom()});this.mapListeners(d)})}mapListeners(c){c.on("zoomend",d=>{let g=d.target.getZoom();this.zoom.set(g)}),c.on("moveend",d=>{let g=c.getCenter();this.coordinates.set(g)}),c.addControl(new Rp.default.FullscreenControl),c.addControl(new Rp.default.GeolocateControl),c.addControl(new Rp.default.NavigationControl),this.map.set(c)}static \u0275fac=function(d){return new(d||a)};static \u0275cmp=Ao({type:a,selectors:[["app-fullscreen-map-page"]],viewQuery:function(d,g){d&1&&Xh(g.divElement,N4,5),d&2&&Yh()},decls:17,vars:17,consts:[["map",""],["txtZoom",""],["id","controls"],[1,"text-gray-500","font-normal"],["type","range","min","1","max","19",1,"range","range-accent",3,"input","value"],[1,"text-2xl","font-bold","text-black","mb.2"],[1,"text-sm","text-gray-500","font-normal"]],template:function(d,g){if(d&1){let w=s_();Vl(0,"div",null,0),go(2,"section",2)(3,"h2"),xr(4," Zoom "),go(5,"small",3),xr(6),jl(7,"number"),$o()(),go(8,"input",4,1),hp("input",function(){Zf(w);let A=dI(9);return Xf(g.zoom.set(+A.value))}),$o(),go(10,"h2",5),xr(11,"Coordenadas "),go(12,"pre",6),xr(13),jl(14,"number"),jl(15,"number"),jl(16,"json"),$o()()()}d&2&&(ir(6),Ss("",l_(7,3,g.zoom(),"1.0-0")," "),ir(2),Rx("value",g.zoom()),ir(5),Ss("",dp(16,12,mI(14,z4,l_(14,6,g.coordinates().lat,"1.4-4"),l_(15,9,g.coordinates().lng,"1.4-4"))),`
        `))},dependencies:[p_,CI],styles:["div[_ngcontent-%COMP%]{width:100vw;height:calc(100vh - 64px)}#controls[_ngcontent-%COMP%]{background-color:#fff;padding:10px;border-radius:5px;position:fixed;bottom:25px;right:20px;z-index:9999;box-shadow:0 0 10px #0000001a;border:1px solid #e2e8f0;width:250px}"]})};var xb=Aw(yb());var no=[];for(let a=0;a<256;++a)no.push((a+256).toString(16).slice(1));function vO(a,c=0){return(no[a[c+0]]+no[a[c+1]]+no[a[c+2]]+no[a[c+3]]+"-"+no[a[c+4]]+no[a[c+5]]+"-"+no[a[c+6]]+no[a[c+7]]+"-"+no[a[c+8]]+no[a[c+9]]+"-"+no[a[c+10]]+no[a[c+11]]+no[a[c+12]]+no[a[c+13]]+no[a[c+14]]+no[a[c+15]]).toLowerCase()}var hS,B4=new Uint8Array(16);function dS(){if(!hS){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");hS=crypto.getRandomValues.bind(crypto)}return hS(B4)}var V4=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),fS={randomUUID:V4};function j4(a,c,d){if(fS.randomUUID&&!c&&!a)return fS.randomUUID();a=a||{};let g=a.random??a.rng?.()??dS();if(g.length<16)throw new Error("Random bytes length must be >= 16");if(g[6]=g[6]&15|64,g[8]=g[8]&63|128,c){if(d=d||0,d<0||d+16>c.length)throw new RangeError(`UUID byte range ${d}:${d+15} is out of buffer bounds`);for(let w=0;w<16;++w)c[d+w]=g[w];return c}return vO(g)}var gu=j4;var U4=["map"],H4=a=>({backgroundColor:a}),$4=(a,c)=>c.id;function G4(a,c){if(a&1){let d=s_();go(0,"div",7),hp("click",function(){let w=Zf(d).$implicit,i=hI();return Xf(i.flyToMarker(w.mapBoxMarker.getLngLat()))}),go(1,"label",8)(2,"span",9),xr(3),jl(4,"number"),$o(),go(5,"span",9),xr(6),jl(7,"number"),$o()(),Vl(8,"input",10),$o()}if(a&2){let d=c.$implicit;ir(3),Ss("Lat: ",dp(4,4,d.mapBoxMarker.getLngLat().lat)," ,"),ir(3),Ss("Lng: ",dp(7,6,d.mapBoxMarker.getLngLat().lng)),ir(2),fI(pI(8,H4,d.mapBoxMarker._color))}}function q4(a,c){a&1&&(go(0,"div",6)(1,"p",11),xr(2,"No hay marcadores"),$o()())}xb.default.accessToken=Ap.mapboxKey;var bb=class a{divElement=pp("map");map=dr(null);markers=dr([]);ngAfterViewInit(){return Va(this,null,function*(){if(!this.divElement()?.nativeElement)return;let c=this.divElement().nativeElement;yield new Promise(g=>setTimeout(g,80));let d=new xb.default.Map({container:c,style:"mapbox://styles/mapbox/streets-v12",center:[-71.21348118350552,-29.91999396233657],zoom:15});this.mapListeners(d)})}mapListeners(c){c.on("click",d=>this.setMarker(d)),this.map.set(c)}setMarker(c){let d="#xxxxxx".replace(/x/g,i=>(Math.random()*16|0).toString(16));if(!this.map())return;let g=new xb.default.Marker({draggable:!1,color:d,clickTolerance:.1}).setLngLat(c.lngLat).addTo(this.map());g.getElement().addEventListener("contextmenu",()=>this.deleteMarker(g));let w={id:gu(),mapBoxMarker:g};this.markers.update(i=>[w,...i])}deleteMarker(c){this.markers.set(this.markers().filter(d=>d.mapBoxMarker!==c)),c.remove()}flyToMarker(c){this.map()&&this.map()?.flyTo({center:c})}static \u0275fac=function(d){return new(d||a)};static \u0275cmp=Ao({type:a,selectors:[["app-markers-page"]],viewQuery:function(d,g){d&1&&Xh(g.divElement,U4,5),d&2&&Yh()},decls:9,vars:1,consts:[["map",""],[1,"h-[60vh]","sm:h-[calc(100vh-64px)]"],[1,"h-[40vh]","sm:fixed","sm:w-[240px]","bg-white","sm:rounded","sm:top-20","sm:left-10","p-5","sm:overflow-y-scroll"],[1,"text-xl","font-bold","text-black","mb-2"],[1,"flex","flex-col","gap-2"],[1,"form-control","flex","flex-row","justify-between"],[1,"flex","justify-center","items-center","bg-blue-100","rounded","py-5"],[1,"form-control","flex","flex-row","justify-between",3,"click"],[1,"label","cursor-pointer"],[1,"label-text","text-xs"],["type","radio","name","radio-10","checked","checked",1,"radio"],[1,"text-xs","text-secondary"]],template:function(d,g){d&1&&(Vl(0,"div",1,0),go(2,"section",2)(3,"h2",3),xr(4,"Marcadores"),$o(),go(5,"div",4),uu(6,G4,9,10,"div",5,$4,!1,q4,3,0,"div",6),$o()()),d&2&&(ir(6),hu(g.markers()))},dependencies:[p_],encapsulation:2})};var wb=Aw(yb());var W4=["map"];wb.default.accessToken=Ap.mapboxKey;var Eb=class a{divElement=pp("map");map=dr(null);zoom=dr(14);coordinates=zx.required();ngAfterViewInit(){return Va(this,null,function*(){if(!this.divElement()?.nativeElement)return;let c=this.divElement().nativeElement;yield new Promise(w=>setTimeout(w,80));let d=new wb.default.Map({container:c,style:"mapbox://styles/mapbox/streets-v12",center:[this.coordinates().lng,this.coordinates().lat],zoom:this.zoom(),interactive:!1,pitch:30}),g="#xxxxxx".replace(/x/g,w=>(Math.random()*16|0).toString(16));new wb.default.Marker({draggable:!1,color:g,clickTolerance:.1}).setLngLat(this.coordinates()).addTo(d)})}static \u0275fac=function(d){return new(d||a)};static \u0275cmp=Ao({type:a,selectors:[["app-mini-map"]],viewQuery:function(d,g){d&1&&Xh(g.divElement,W4,5),d&2&&Yh()},inputs:{coordinates:[1,"coordinates"]},decls:2,vars:0,consts:[["map",""]],template:function(d,g){d&1&&Vl(0,"div",null,0)},styles:["div[_ngcontent-%COMP%]{width:100%;height:260px}"]})};var Z4=(a,c)=>c.id;function X4(a,c){if(a&1&&(qr(0,"div",9),xr(1),mo()),a&2){let d=c.$implicit;ir(),du(d)}}function Y4(a,c){if(a&1&&(qr(0,"div",4),Za(1,"app-mini-map",5),qr(2,"div",6)(3,"h2",7),xr(4),mo(),qr(5,"p"),xr(6),mo(),qr(7,"div",8),uu(8,X4,2,1,"div",9,uI),mo()()()),a&2){let d=c.$implicit;ir(),up("coordinates",d.lngLat),ir(3),Ss(" ",d.name," "),ir(2),du(d.description),ir(2),hu(d.tags)}}var Tb=class a{houses=dr([{id:gu(),name:"Villa Serenidad",description:"Un refugio tranquilo con vistas panor\xE1micas al mar y jardines exuberantes.",price:5e5,lngLat:{lng:-.861526,lat:41.65649},tags:["Villa","Mar","Jardines"]},{id:gu(),name:"Casa del Sol",description:"Una casa luminosa y acogedora con amplias terrazas y piscina privada.",price:75e4,lngLat:{lng:-.862,lat:41.657},tags:["Casa","Sol","Terrazas"]},{id:gu(),name:"Residencia Esmeralda",description:"Elegante propiedad con acabados de lujo y un dise\xF1o arquitect\xF3nico moderno.",price:12e5,lngLat:{lng:-.863,lat:41.658},tags:["Casa","Esmeralda","Acabados"]},{id:gu(),name:"Hacienda del Lago",description:"Encantadora hacienda con acceso directo al lago y un entorno natural impresionante.",price:95e4,lngLat:{lng:-.864,lat:41.659},tags:["Casa","Lago","Hacienda"]}]);static \u0275fac=function(d){return new(d||a)};static \u0275cmp=Ao({type:a,selectors:[["app-houses-page"]],decls:8,vars:1,consts:[[1,"mx-auto","p-4"],[1,"text-3xl","font-bold","mb-2"],[1,"text-xl","text-gray-500","mb-2"],[1,"grid","grid-cols-1","sm:grid-cols-2","xl:grid-cols-3","gap-4","px-4"],[1,"card","bg-base-100","shadow-sm","rounded-t-lg","overflow-hidden"],[3,"coordinates"],[1,"card-body"],[1,"card-title"],[1,"card-actions","justify-end"],[1,"badge","badge-outline"]],template:function(d,g){d&1&&(qr(0,"section",0)(1,"h2",1),xr(2,"Casas"),mo(),qr(3,"h3",2),xr(4),mo()(),qr(5,"section",3),uu(6,Y4,10,3,"div",4,Z4),mo()),d&2&&(ir(4),Ss("",g.houses().length," casas disponibles"),ir(2),hu(g.houses()))},dependencies:[Eb],encapsulation:2})};var B_=[{path:"fullscreen",component:vb,title:"Fullscreen Map"},{path:"markers",component:bb,title:"Marcadores"},{path:"houses",component:Tb,title:"Propiedades Disponibles"},{path:"**",redirectTo:"fullscreen"}];var xO={providers:[yI({eventCoalescing:!0}),lS(B_)]};function bO(a,c){let g=!c?.manualCleanup?c?.injector?.get(ra)??At(ra):null,w=K4(c?.equal),i;c?.requireSync?i=dr({kind:0},{equal:w}):i=dr({kind:1,value:c?.initialValue},{equal:w});let A,N=a.subscribe({next:H=>i.set({kind:1,value:H}),error:H=>{i.set({kind:2,error:H}),A?.()},complete:()=>{A?.()}});if(c?.requireSync&&i().kind===0)throw new Qt(601,!1);return A=g?.onDestroy(N.unsubscribe.bind(N)),bI(()=>{let H=i();switch(H.kind){case 1:return H.value;case 2:throw H.error;case 0:throw new Qt(601,!1)}},{equal:c?.equal})}function K4(a=Object.is){return(c,d)=>c.kind===1&&d.kind===1&&a(c.value,d.value)}var J4=(a,c)=>c.path;function Q4(a,c){if(a&1&&(qr(0,"li")(1,"a",9),xr(2),mo()()),a&2){let d=c.$implicit;ir(),up("routerLink",d.path),ir(),du(d.path)}}var Ib=class a{router=At(nd);routes=B_.map(c=>({path:c.path,title:`${c.title??"Mapas en Angular"}`})).filter(c=>c.path!=="**");pageTitle=bO(this.router.events.pipe(Io(c=>c instanceof Ds),fi(c=>c.url),fi(c=>B_.find(d=>`/${d.path}`==c)?.title??"Mapas")));static \u0275fac=function(d){return new(d||a)};static \u0275cmp=Ao({type:a,selectors:[["app-navbar"]],decls:12,vars:1,consts:[[1,"navbar","bg-base-100","shadow-sm"],[1,"navbar-start"],[1,"dropdown"],["tabindex","0","role","button",1,"btn","btn-ghost","btn-circle"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-5","w-5"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M4 6h16M4 12h16M4 18h7"],["tabindex","0",1,"menu","menu-sm","dropdown-content","bg-base-100","rounded-box","z-1","mt-3","w-52","p-2","shadow"],[1,"navbar-center"],[1,"btn","btn-ghost","text-xl"],[3,"routerLink"]],template:function(d,g){d&1&&(qr(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3),N0(),qr(4,"svg",4),Za(5,"path",5),mo()(),z0(),qr(6,"ul",6),uu(7,Q4,3,2,"li",null,J4),mo()()(),qr(9,"div",7)(10,"a",8),xr(11),mo()()()),d&2&&(ir(7),hu(g.routes),ir(4),du(g.pageTitle()))},dependencies:[_b],encapsulation:2})};var Sb=class a{title="maps-app";static \u0275fac=function(d){return new(d||a)};static \u0275cmp=Ao({type:a,selectors:[["app-root"]],decls:2,vars:0,template:function(d,g){d&1&&Za(0,"app-navbar")(1,"router-outlet")},dependencies:[F_,Ib],encapsulation:2})};zI(Sb,xO).catch(a=>console.error(a));
